<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":500,"display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"万一找到了呢","hits_empty":"你说的 ${query} 我怎么找不着呢 ","hits_stats":"找到了 ${hits} 个结果，用时 ${time} 毫秒"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="dustland">
<meta property="og:type" content="website">
<meta property="og:title" content="dustland">
<meta property="og:url" content="http://deutschball.github.io/impossible/page/4/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="dustland">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="dustball">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/impossible/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/02/08/%E4%BC%A0%E8%BE%93%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/08/%E4%BC%A0%E8%BE%93%E5%B1%82/" class="post-title-link" itemprop="url">计算机网络-传输层</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-08 18:08:00" itemprop="dateCreated datePublished" datetime="2023-02-08T18:08:00+08:00">2023-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-05-05 15:57:07" itemprop="dateModified" datetime="2024-05-05T15:57:07+08:00">2024-05-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="计算机网络-传输层"><a href="#计算机网络-传输层" class="headerlink" title="计算机网络-传输层"></a>计算机网络-传输层</h1><h2 id="传输层"><a href="#传输层" class="headerlink" title="传输层"></a>传输层</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>网络层提供点到点服务,也就是主机到主机的服务</p>
<p>传输层提供端到端服务,也就是进程到进程的服务</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128103802707.png" alt="image-20221128103802707"></p>
<h4 id="端口号"><a href="#端口号" class="headerlink" title="端口号"></a>端口号</h4><table>
<thead>
<tr>
<th>层</th>
<th>寻址方式</th>
<th>寻址范围</th>
</tr>
</thead>
<tbody><tr>
<td>链路层</td>
<td>MAC地址</td>
<td></td>
</tr>
<tr>
<td>网络层</td>
<td>ip地址</td>
<td>ipv4地址32位</td>
</tr>
<tr>
<td>传输层</td>
<td>端口号</td>
<td>端口号16位</td>
</tr>
</tbody></table>
<p><strong>服务端</strong>端口号规定</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128104113012.png" alt="image-20221128104113012"></p>
<p>客户端都是临时端口,不用管到底用的哪个端口</p>
<h4 id="套接字"><a href="#套接字" class="headerlink" title="套接字"></a>套接字</h4><p>socket&#x3D;IP地址+端口号</p>
<p>一个套接字唯一标识了一个进程</p>
<p>一个TCP连接两头是两个套接字,即一个TCP连接被一对套接字决定</p>
<h4 id="差错控制"><a href="#差错控制" class="headerlink" title="差错控制"></a>差错控制</h4><p>可靠传输:不错,不丢,不乱</p>
<p>每一层的校验都只校验本层数据</p>
<table>
<thead>
<tr>
<th>层</th>
<th>差错控制的目的</th>
<th>是否可靠</th>
</tr>
</thead>
<tbody><tr>
<td>数据链路层</td>
<td>通过CRC校验,保证一个帧中没有比特差错,但不能保证丢不丢帧</td>
<td>否,只能保证不错</td>
</tr>
<tr>
<td>网络层IP协议</td>
<td>只针对网络层包的头部进行CRC校验</td>
<td>否</td>
</tr>
<tr>
<td>传输层TCP协议</td>
<td>保证做到无传输差错</td>
<td>是</td>
</tr>
</tbody></table>
<h4 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h4><table>
<thead>
<tr>
<th>传输层协议</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>TCP</td>
<td>客户端和服务端多次交互入访问页面HTTP<br />传输文件FTP<br />电子邮件POP3,SMTP</td>
</tr>
<tr>
<td>UDP</td>
<td>实时聊天通信,DNS,多播,广播<br />对等网络技术P2P<br />部分路由协议RIP<br />网络时间管理NTP<br />简单网络管理SNTP</td>
</tr>
</tbody></table>
<h3 id="UDP"><a href="#UDP" class="headerlink" title="UDP"></a>UDP</h3><h4 id="UDP首部"><a href="#UDP首部" class="headerlink" title="UDP首部"></a>UDP首部</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128105608481.png" alt="UDP首部"></p>
<p>源端口,目的端口各16位,总长度16位,校验和16位</p>
<h4 id="校验和"><a href="#校验和" class="headerlink" title="校验和"></a>校验和</h4><p>UDP的校验和&#x3D;UDP伪首部+UDP首部+数据</p>
<p>这个伪首部指，源地址、目的地址、协议类型（0x11）,一个字节的全0,一个字节的<strong>UDP数据长度</strong>，对齐填充2字节的0，整个伪首部共12个字节。</p>
<blockquote>
<p><strong>UDP伪首部是为了计算校验和而临时存在的,在计算之前由主机加上,计算之后立刻扔掉,不会参与传输</strong></p>
<p>UDP伪首部和IP首部无关,<strong>不能理解为</strong>借用的IP首部</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/v2-86bb22904619c1bd318996b26b7825c2_720w.webp" alt="UDP伪首部不是IP首部"></p>
<p>伪首部中的UDP长度就是UDP首部+UDP数据的长度,不需要考虑对齐填充,是多少就是多少</p>
</blockquote>
<p>伪首部+UDP首部+数据一起计算校验和。</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128110006207.png" alt="image-20221128110006207"></p>
<p>具体计算方法:</p>
<p><strong>16位一组相加,最高位进位回卷,和Sum取反得到CheckSum</strong></p>
<p>在计算校验和时,此时UDP首部的校验和字段先置零,伪首部中的UDP长度就是实际的UDP长度,15,不用考虑对齐填充</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128110218290.png" alt="image-20221128110218290"></p>
<h4 id="UDPの特点"><a href="#UDPの特点" class="headerlink" title="UDPの特点"></a>UDPの特点</h4><p>1.报文在发送方这里不会拆分,发送方一次交付一个完整报文.</p>
<blockquote>
<p>注意强调了发送方,因为网络层才不会管你拆不拆,大于MTU的报必须拆</p>
<p>比如如果发送方不管三七二十一发了一个巨大的上万字节的UDP报文</p>
<p>如果数据链路层使用以太网,那么每个以太网帧最大是1500字节,也就是说网络层的MTU&#x3D;1500(Maximum Transmission Unit).</p>
<p>显然一个上万字节的UDP数据报无法直接发送,因此路由器会进行报文分割,把该UDP数据报拆分成若干不大于1500字节的包,分开发送</p>
<p>最终在接收方还是需要组装的</p>
</blockquote>
<p>2.无流量控制,无差错控制,无拥塞控制</p>
<blockquote>
<p>差错控制要求发现错误时要求重传,但是UDP数据报的校验和如果发现错误,直接被路由器或者主机丢弃,不会要求重传</p>
</blockquote>
<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>分段传输:虚电路建立之后,看上去TCP协议直接发送和接收字节流,就像访问硬盘一样,但是下层实际上还是数据报实现的</p>
<p>一个图是需要切成好多段,扔给网络层以报文形式交付</p>
<h4 id="TCP协议的熟知端口号"><a href="#TCP协议的熟知端口号" class="headerlink" title="TCP协议的熟知端口号"></a>TCP协议的熟知端口号</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230203162222069.png" alt="image-20230203162222069"></p>
<p>特别注意</p>
<p>20-FTP.Data</p>
<p>21-FTP.Control</p>
<p>53-DNS</p>
<h4 id="字节流"><a href="#字节流" class="headerlink" title="字节流"></a>字节流</h4><p>啥玩意叫字节流?</p>
<p>啥玩意叫流?Stream,在计算机里就是顺序读取或者写入的字节序列.</p>
<p>包括从硬盘读取的文件,从键盘输入的字符序列,从网络获取的字符序列.都叫流</p>
<p>叫做字节流,是因为还有一个字符流</p>
<p>两者的区别是,字节流使用8位一个字节为信息单元,一个字节传输一个信息,比如一个字母</p>
<p>而字符流使用16位两个字节作为信息单元,使用unicode编码传输信息</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128111751747.png" alt="image-20221128111751747"></p>
<p>“流”是<strong>针对应用层上的应用程序而言</strong>的,在应用程序看来,他调用read函数从硬盘读取字节流和调用recv函数从套接字获取字节流没有区别.</p>
<p>反正就是得用<code>while(!read.eof())&#123;read(buf,n,file);...&#125;</code>这样不停地从缓冲区取出字节,因为一个文件的传输,是像水流一样,源源不断地抵达缓冲区的,不可以一下子全部获取</p>
<p>传输层只管给应用程序的缓冲区写入数据,不管应用程序拿着数据干了啥</p>
<p>应用程序只管从缓冲区读取数据,不管传输层从哪里搞来的数据</p>
<p>因此,传输层单蹦个地顺序传送比特位,还是单蹦个顺序传送字节,抑或是分段每次传送成千个字节即分段,应用程序不关心,全靠传输层自由发挥了</p>
<p>显然传输层应该选择分段发送,这样效率高</p>
<blockquote>
<p>为什么效率高?</p>
<p>对于网络来说头部长度固定,数据部分越长有效信息比例越高,需要发送的数据报越少,网络负载也就轻</p>
<p>对于主机来说,每个字节就发送一次,需要频繁地系统调用(显然访问网络这种外设需要系统调用),开销太大</p>
</blockquote>
<h4 id="首部格式"><a href="#首部格式" class="headerlink" title="首部格式"></a>首部格式</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128111530489.png" alt="image-20221128111530489"></p>
<h5 id="Source-Destination-port-address"><a href="#Source-Destination-port-address" class="headerlink" title="Source&#x2F;Destination port address"></a>Source&#x2F;Destination port address</h5><p>源&#x2F;目的端口地址</p>
<h5 id="sequence-number"><a href="#sequence-number" class="headerlink" title="sequence number"></a>sequence number</h5><p>字节序列号,一个TCP包可以发送若干数据字节,每一个数据字节都编一个字节序列号,</p>
<p>在首部中sequence number表明本TCP报文中<strong>第一个数据字节的编号</strong></p>
<p>本字段用于分段系统</p>
<h5 id="acknowledgment-number"><a href="#acknowledgment-number" class="headerlink" title="acknowledgment number"></a>acknowledgment number</h5><p>确认号字段,<strong>期望收到的,对方下一个报文段数据的,第一个字节的序号</strong></p>
<p>本字段用于分段系统</p>
<h5 id="HLEN"><a href="#HLEN" class="headerlink" title="HLEN"></a>HLEN</h5><p>header length首部长度,<strong>其单位是4字节</strong></p>
<p>比如HLEN&#x3D;5&#x3D;0101b,表示首部长度为5*4&#x3D;20字节</p>
<h5 id="Reserved"><a href="#Reserved" class="headerlink" title="Reserved"></a>Reserved</h5><p>保留字段,6位,目前全置零</p>
<h5 id="控制字段"><a href="#控制字段" class="headerlink" title="控制字段"></a>控制字段</h5><p>6位</p>
<p>用于TCP连接的流量控制,连接建立终止,连接失败和数据传送方式</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221128113731360.png" alt="image-20221128113731360"></p>
<p>当URG&#x3D;1时,紧急指针Urgent pointer才有效</p>
<blockquote>
<p>如何体现紧急?</p>
<p>正常情况下一个TCP报文段会拆分重组</p>
<p>整个重组利索之后才会交付给应用程序</p>
<p>而紧急数据无需等待重组,直接交给应用程序</p>
</blockquote>
<p>ACK,确认,1代表acknoledgment number字段有效</p>
<p>PSH,请求急迫,发送端不需等待窗口填满才发送</p>
<blockquote>
<p>PSH用于什么情况?</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20210317143111661.png" alt="缓冲区与PSH"></p>
<p>进程A向socket写东西,实际上就是写到发送缓冲区中,此时并没有实际往网络上发送,啥时候发送呢?得等到缓冲区满了才发,这就像是机场包车的包不满不走一样</p>
<p>而PSH位就是要强迫发送,即使车没有坐满人,也把枪夹到司机头上给我立刻发车</p>
<p>有意义吗?急着发车干啥?还真有意义</p>
<p>有的乘客不在乎自己坐车多花的开销,他急着办事.</p>
<p>正如有些服务的及时性比效率更优先</p>
<p>比如ssh服务</p>
<p>客户端这会急着想看服务端根目录下有啥,于是客户端想发送一个ls命令,如果不加psh位,好吧你等着吧,啥时候缓冲区满了才发送.实际上ssh服务是psh&#x3D;1的</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230203172915324.png" alt="image-20230203172915324"></p>
</blockquote>
<p>RST,重置连接</p>
<p>SYN,同步信号,建立连接时使用</p>
<p>FIN,结束</p>
<h5 id="window-size"><a href="#window-size" class="headerlink" title="window size"></a>window size</h5><p>窗口大小,单位字节</p>
<p>用于<strong>控制对方发送的数据量</strong></p>
<p>根据自身缓冲区剩余空间大小,决定接收窗口大小,通知对方发送窗口上限</p>
<h5 id="checksum"><a href="#checksum" class="headerlink" title="checksum"></a>checksum</h5><p>检验和</p>
<p>TCP检验和&#x3D;TCP伪首部+TCP首部+TCP数据</p>
<p>其中TCP伪首部和UDP伪首部一模一样</p>
<h5 id="urgent-pointer"><a href="#urgent-pointer" class="headerlink" title="urgent pointer"></a>urgent pointer</h5><p>紧急指针字段,</p>
<p>如果有紧急数据,则一定放在TCP数据的最开始</p>
<p>紧急指针表明紧急数据的大小,单位字节</p>
<h5 id="option"><a href="#option" class="headerlink" title="option"></a>option</h5><p>选项字段,长度可变</p>
<p>通常不用这个字段</p>
<p>TCP之规定一种选项,MSS,最大报文段长度,即TCP数据的最大长度</p>
<h4 id="序号系统"><a href="#序号系统" class="headerlink" title="序号系统"></a>序号系统</h4><p>由于TCP报文需要分段,因此需要引入一套编号机制,让分段和重组有序</p>
<p>TCP首部的sequence number,acknowledgment number两个字段和ACK,SYN两个标志位就是为序号系统服务的</p>
<p>需要牢记的是:</p>
<p><strong>编号是给每个字节的编号,不是给分段的编号!</strong></p>
<p><strong>编号是给每个字节的编号,不是给分段的编号!</strong></p>
<p><strong>编号是给每个字节的编号,不是给分段的编号!</strong></p>
<p>所有数据的第一个字节是一个$[0,2^{32})$内的随机数</p>
<p>sequence number,该TCP报文段段第一个数据字节的编号</p>
<p>acknowledgment number,希望接收的下一个报文段的第一个数据字节的编号.也表明接收方已经正确接收该编号-1之前的所有字节</p>
<p>比如这么一个问题</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230203173943002.png" alt="image-20230203173943002"></p>
<p>显然第一问是100-70&#x3D;30</p>
<p>第二问,主机B接收到的字节序列应该是$[70,99]$,因此ack number&#x3D;100,表明希望接收编号为100的字节,并且告知发送方,编号为99及之前的所有字节都已经正确接收了</p>
<h4 id="连接建立-终止"><a href="#连接建立-终止" class="headerlink" title="连接建立&amp;终止"></a>连接建立&amp;终止</h4><p>三次握手建立连接</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230203224344990.png" alt="image-20230203224344990"></p>
<p>服务端是被动打开的,而客户端是主动打开的</p>
<p>三次握手建立连接的目的是,证明通信双方的收发都正常</p>
<p>第一次握手,客户端啥也不知道,但是服务端知道客户端不哑,自己不聋</p>
<p>第二次握手,客户端知道了服务端收到了自己的消息,证明自己不哑,这次收到消息证明自己不聋.</p>
<p>此时只剩最后一步,此时服务端不知道自己是否哑巴</p>
<p>第三次握手,服务端收到客户端对第二次握手的确认,因此证明服务端不哑</p>
<p>第三次握手时,实际上客户端已经可以在TCP数据中,写上对服务端请求什么了</p>
<p>然而实际上HTTP协议中,三次握手不涉及任何有效数据传输,三次握手建立之后,客户端会另外发送GET请求</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230203225616420.png" alt="image-20230203225616420"></p>
<p>四次挥手断开连接的目的是:</p>
<p>首先客户端主动提出FIN分手,表明客户端没有要求了</p>
<p>服务端收到客户端的分手请求后,立刻回复ACK收到,但是如果服务端还有没说完的话,还可以继续说.</p>
<p>这个阶段叫做半关闭阶段,客户端只能回复收到,不会再有新的请求</p>
<p>如果服务端也说完了,没有其他话要说了,就发送FIN</p>
<p>然后客户端收到FINI之后知道服务端也没得说了,回复收到</p>
<p>到此整个连接关闭</p>
<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><blockquote>
<p>区分流量控制和拥塞控制:</p>
<p>流量控制是避免接收方来不及接收,缓冲区溢出</p>
<p>拥塞控制是避免网络拥塞</p>
</blockquote>
<p>为啥要进行流量控制?</p>
<p>接收方的缓冲区大小有限,要保证接收方来得及接收消息并腾出缓冲区</p>
<p>如果发送方发的过快,接收方处理慢,缓冲区满了,那么后来的消息就会被直接丢弃</p>
<p>如何进行流量控制?滑动窗口算法</p>
<h5 id="滑动窗口算法"><a href="#滑动窗口算法" class="headerlink" title="滑动窗口算法"></a>滑动窗口算法</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204190749379.png" alt="image-20230204190749379"><br>$$<br>发送方滑动窗口大小swnd&#x3D;min(接收方滑动窗口大小rwnd,拥塞窗口大小cwnd)<br>$$<br>其中rwnd是接收方缓冲区剩余空间大小</p>
<p>比如接收方缓冲区本身4KB,发送方发了一个1K的报文,填到接收方缓冲区中,此时接收方rwnd&#x3D;3000,接收方就得在ACK报文中报告自己的rwnd大小,让发送方心里有数,后面该法多少</p>
<p>cwnd是发送方自己维护的,发送方根据接收方的回应报文丢失情况,推测网络的拥塞程度,动态调整cwnd的大小</p>
<blockquote>
<p>TCP滑动窗口和数据链路层滑动窗口的区别:</p>
<p>TCP滑动窗口的单位是字节,而数据链路层滑动窗口的单位是帧</p>
<p>数据链路层的滑动窗口大小是固定的,而TCP滑动窗口大小根据实时情况改变</p>
</blockquote>
<p>如图所示的滑动窗口(只是一个例子,实际上一个滑动窗口有成百上千字节)中,cwnd&#x3D;20,rwnd&#x3D;9,</p>
<p>这就意味着接收方此时的缓冲区只有9个字节的空间了,发送方顶多再发送9字节</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208173522440.png" alt="image-20230208173522440"></p>
<p>此时发送方啥状态呢?目前滑动窗口中的200,201,202三个字节都已经发送,可能是一个报文同时发走的,也可能是分批发走的,但是这不重要,重要的是,目前尚未得到接收方的ACK回复.发送方现在还可以接着发送203~208这6个字节.</p>
<p>如果发完了这6个字节仍热没有收到回复,就不能发了,得等等</p>
<p>时序图</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208174029314.png" alt="image-20230208174029314"></p>
<p>首先发送方得等接收方告知自己的接收窗口大小</p>
<p>拿到这个数之后,发送方就可以在这个接收窗口大小和拥塞窗口大小中娶一个最小值,然后放心地发送这么多字节</p>
<p>这些字节不必是一个报文发走的,这要看链路层对一个数据帧的限制,比如以太网帧中的数据不能超过1500字节.因此,即使swnd&#x3D;min(cwnd,rwnd)&#x3D;2400,也得分成多个报文发送</p>
<p>接收方会对发送方的每一个报文都进行回复,回复内容包括:</p>
<p>1.期待接收的下一个字节编号</p>
<p>2.当前接收方窗口剩余大小</p>
<p>当接收方的回复报文中,swnd&#x3D;0时,发送方就得停下等接收方消化消化.</p>
<p>接收方消化一阵子之后,缓冲区有比较大的空间,能够容纳一个大帧时,才会主动发送更新报文.告知发送方,可以继续灌输了</p>
<blockquote>
<p>等待缓冲区有较大空间的目的是,防止糊涂窗口综合征</p>
</blockquote>
<p>这个更新报文的内容包括:</p>
<p>1.期待接收的下一个字节编号</p>
<p>2.当前接收方窗口剩余大小</p>
<p>为了防止这个更新报文丢包,发送方有一个坚持计时器.当发送方接到swnd&#x3D;0的回复报文就开始了.如果在到时之前收到更新报文自然最好.如果没有收到,则发送方认为更新报文在路上丢了,于是发送方发送一个1字节的探测报文,提醒接收方更新报文丢失了.</p>
<h4 id="差错控制-1"><a href="#差错控制-1" class="headerlink" title="差错控制"></a>差错控制</h4><p>TCP的差错控制有三个手段</p>
<p>1.校验和,接收方收到坏段,丢弃并要求重传,通过ACK+坏段序号 要求重传</p>
<p>2.确认</p>
<p>发送方发出的每一个数据段都需要ACK确认</p>
<p>不携带数据但是占用序号的控制段也需要确认</p>
<p><strong>ACK段不需要确认</strong>,因为ACK本身就是确认用的</p>
<p>3.重传</p>
<p>当段损坏,丢失或者超时,需要重传</p>
<p><strong>ACK段不需要重传</strong></p>
<blockquote>
<p>重传的情形:</p>
<p>1.丢失段</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208175609900.png" alt="image-20230208175609900"></p>
<p>2.3ACK快速重传</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208175633242.png" alt="image-20230208175633242"></p>
</blockquote>
<h4 id="拥塞控制"><a href="#拥塞控制" class="headerlink" title="拥塞控制"></a>拥塞控制</h4><p>拥塞控制可以理解为网络流问题</p>
<p>一条主干道的带宽是1000Mbps,其支线的带宽和是1500Mbps,如果所有支线都满载传输,则骨干路由器就得缓存支线的数据报文,满满地往主干道发.</p>
<p>如果骨干路由器缓冲区溢出,就有数据丢包了</p>
<p>拥塞控制还是滑动窗口算法,并且和流量控制兼容,体现在<br>$$<br>swnd&#x3D;min(cwnd,rwnd)<br>$$</p>
<h5 id="慢启动和拥塞避免"><a href="#慢启动和拥塞避免" class="headerlink" title="慢启动和拥塞避免"></a>慢启动和拥塞避免</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208180115427.png" alt="image-20230208180115427"></p>
<p>最初慢启动阶段,cwnd&#x3D;1,发一个报文,收到ACK,这就意味着一次发一个包,网络可以承受,于是蹬鼻子上脸,cwnd&#x3D;2,发俩报文,等俩ACK,如果又都受到了,那就更加猖狂</p>
<p>一直到慢启动阈sstresh,之后就不能指数扩大cwnd了,需要加性增大,也就是发一个包收到ACK就cwnd扩大1,一直这样直到计时器超时,说明达到网络流量上限了,</p>
<p>此时立刻回到慢启动阶段,cwnd&#x3D;1,并重新设置ssthresh阈值为超时cwnd的一半</p>
<p>之后重复上述过程</p>
<h5 id="3ACK快速恢复"><a href="#3ACK快速恢复" class="headerlink" title="3ACK快速恢复"></a>3ACK快速恢复</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208180505456.png" alt="image-20230208180505456"></p>
<p>能够收到3ACK说明网络只是轻度拥塞</p>
<p>此时直接ssthresh降为收到3ACK时cwnd的一半,然后设置cwnd&#x3D;ssthresh,然后重复加性增大阶段</p>
<h5 id="状态转移图"><a href="#状态转移图" class="headerlink" title="状态转移图"></a>状态转移图</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208180715552.png" alt="image-20230208180715552"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/02/08/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/08/%E6%95%B0%E6%8D%AE%E9%93%BE%E8%B7%AF%E5%B1%82/" class="post-title-link" itemprop="url">计算机网络-数据链路层</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-08 15:22:00" itemprop="dateCreated datePublished" datetime="2023-02-08T15:22:00+08:00">2023-02-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-02-12 18:43:43" itemprop="dateModified" datetime="2023-02-12T18:43:43+08:00">2023-02-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="计算机网络-数据链路层"><a href="#计算机网络-数据链路层" class="headerlink" title="计算机网络-数据链路层"></a>计算机网络-数据链路层</h1><h2 id="数据链路层"><a href="#数据链路层" class="headerlink" title="数据链路层"></a>数据链路层</h2><h3 id="数据链路层的任务"><a href="#数据链路层的任务" class="headerlink" title="数据链路层的任务"></a>数据链路层的任务</h3><p>数据链路层的功能:成帧,流量控制,差错控制,通信</p>
<p>成帧:多个数据帧之间如何区分?添加标志位,比如011111,如果接收方发现一个0后面连着5个1,就认为这和刚才接收到的数据不是一个帧的.</p>
<p>流量控制用于,限制发送方在等到确认之前发送的数据数量</p>
<p>差错控制指望重发,说官话就是”自动重复请求”(ARQ,Automatic Repeat Request)</p>
<h3 id="冗余编码"><a href="#冗余编码" class="headerlink" title="冗余编码"></a>冗余编码</h3><p>冗余:Redundancy</p>
<p>冗余本是多余的意思,在计算机中,冗余量和业务逻辑无关,没有冗余照样执行业务</p>
<p>但是冗余可以增强非业务性能,比如信息论上的冗余可以提高发现错误和纠正错误的能力</p>
<blockquote>
<p>考虑8个工件有一个坏件,质量和其他的不同(具体重了还是清了不知道)</p>
<p>最快多少次找到?这实际上就是尽量减少冗余,尽最大可能利用信息熵的问题</p>
<p>采用二分需要单调性,即知道这个坏件轻了还是重了,现在不知道,没法二分</p>
<p>三分?3v3v2,还是那个问题,3v3不知道哪个是标准</p>
<p>四分?(2v2)v(2v2).其中必有一组2v2都是标准件,天平平衡</p>
<p>不妨设前一个2v2平等,说明坏件一定在后面的2v2中,并且前面四个都是标准件,可以用来参考</p>
<p>后面的2v2就不用称了,每个2直接和两个标准件比较</p>
<p>必然有一组不平衡,这就意味着另一组必定平衡,从不平衡组任意拿出一个,和标准件对比</p>
<p>如果是坏件则天平不平衡,否则如果是好件,则同组另一件必定坏件</p>
</blockquote>
<h4 id="块编码"><a href="#块编码" class="headerlink" title="块编码"></a>块编码</h4><blockquote>
<p>数据字+冗余&#x3D;码字</p>
<p>什么思想呢?</p>
<p>假如原来要传输一个比特,要么是0要么是1</p>
<p>但是路上可能发生各种变故导致1变成0.但是接收方不知道发生了变故,它认为人家就是发送的0,于是错误接收了0</p>
<p>为了增加检错能力</p>
<p>添加一位冗余,比如数据字为0,码字就为00.数据字为1,码字就为11</p>
<p>这样如果有一位发生突变(认为两位同突变的概率低),会形成01或者10这种无效码字,发现错误</p>
<p>那么问题又来了,如果接到01,怎么确定它是00还是11变来的?两者都只需要突变一位就能形成01,因而只添加一位冗余无法纠错</p>
<p>于是再添加一位冗余,只有000和111合法</p>
<p>那么接到100,认为它是000突变来的,这个概率要比他是从111突变来的大.</p>
<p>于是就有了纠错能力.</p>
</blockquote>
<p>实际上的块编码,是多位为一个数据字</p>
<p>整个报文划分为弱干块,每块k位,称为数据字</p>
<p>每块中假如r个冗余位,块长度变为n&#x3D;k+r,形成这个n位的块叫做码字</p>
<p>码字有$2^n$种,但是其中实际承载数据字的只有$2^k$种</p>
<p>如果一个承载数据的码字,其中的一位或者几位发生突变,突变之后的码字:</p>
<p>如果如果不承载数据,则可以被检错</p>
<p>如果也是承载数据的码字,则无法检错</p>
<p>比如4B&#x2F;5B编码(部分)中:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208093738919.png" alt="image-20230208093738919"></p>
<p>如果0100的编码01010最后一位发生突变,编程了01011,这是0101的编码.那么错误就检查不出来了,接收方会认为发送方一开始就是发的0101</p>
<p>下面推导,检错能力和纠错能力的条件是什么</p>
<h5 id="汉明距离"><a href="#汉明距离" class="headerlink" title="汉明距离"></a>汉明距离</h5><p>假设只有一位突变</p>
<p>如果两个有效码字只有一位不同,这样不具备检错能力</p>
<p>如果任何两个有效码字至少有两位不同.这样才具备检错能力,但是不具备纠错能力</p>
<p>如果任何两个有效码字至少有三位不同.这样才具备纠错一位的能力,也可以检错两位</p>
<p>定义两个长度相同的字x,y的汉明距离是对应位不同的数量,记作$d(x,y)$<br>$$<br>d(x,y)&#x3D;x\oplus y 结果中1的数量<br>$$<br>最小汉明距离:一组字所有对中最小的汉明距离</p>
<h5 id="编码方案"><a href="#编码方案" class="headerlink" title="编码方案"></a>编码方案</h5><p>块编码方案记为$C(n,k)\ with\ d_{min}&#x3D;x$</p>
<p>其中n是码字长度,k是数据字长度.$d_{min}$是<strong>有效</strong>码字的最小汉明距离</p>
<p>当可以检错$s$个错误时,要求$d_{min}&#x3D;s+1$</p>
<p>当可以纠错$s$个错误时,要求$d_{min}&gt; 2s$,也就是$d_{min}&#x3D;2s+1$</p>
<blockquote>
<p>因此最好采用奇数长度的码字</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208100459337.png" alt="image-20230208100459337"></p>
<p>x和y两个有效码字,有相同的概率突变为同一个错误码字,因而无法纠错</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208101051053.png" alt="image-20230208101051053"></p>
<p>x突变s位之后依然落在半径为s的圈里,而任意两个圈相离,也就是说一个错误码字一定有一个概率最大的突变来源.</p>
<p>这就有了纠错能力</p>
<h4 id="线性块编码"><a href="#线性块编码" class="headerlink" title="线性块编码"></a>线性块编码</h4><p>线性块编码:任何两个有效码字的异或生成另一个有效码字.比如:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208101612648.png" alt="image-20230208101612648"></p>
<h5 id="最小汉明距离"><a href="#最小汉明距离" class="headerlink" title="最小汉明距离"></a>最小汉明距离</h5><p>线性快编码的最小汉明距离:1的个数最少的非零有效码字中的1的个数</p>
<p>还是以上图为例</p>
<table>
<thead>
<tr>
<th>非零码字</th>
<th>1的个数</th>
</tr>
</thead>
<tbody><tr>
<td>01011</td>
<td>3</td>
</tr>
<tr>
<td>10101</td>
<td>3</td>
</tr>
<tr>
<td>11110</td>
<td>4</td>
</tr>
</tbody></table>
<p>因此$d_{min}&#x3D;3$</p>
<h5 id="简单奇偶校验编码"><a href="#简单奇偶校验编码" class="headerlink" title="简单奇偶校验编码"></a>简单奇偶校验编码</h5><p>$n&#x3D;k+1,d_{min}&#x3D;2$</p>
<p>只有一位校验位</p>
<p>比如$C(5,4)$</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208102201761.png" alt="image-20230208102201761"></p>
<p>突变奇数位可以被检查出</p>
<p>突变偶数位不可以</p>
<h5 id="二维奇偶校验"><a href="#二维奇偶校验" class="headerlink" title="二维奇偶校验"></a>二维奇偶校验</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208102627543.png" alt="image-20230208102627543"></p>
<p>两维奇偶校验能检测出所有3位或3位以下的错误（因为此时至少在某一行或某一列上有一位错）、奇数位错以及很大一部分偶数位错。</p>
<h4 id="汉明编码"><a href="#汉明编码" class="headerlink" title="汉明编码"></a>汉明编码</h4><p>对于汉明编码$C(n,k),d_{min}&#x3D;3$,有如下关系:<br>$$<br>\begin{cases}<br>n&#x3D;2^m-1\<br>k&#x3D;n-m\<br>r&#x3D;m<br>\end{cases}<br>$$<br>比如$C(7,4)$中,$n&#x3D;7&#x3D;2^m-1$得到m&#x3D;3</p>
<p>$k&#x3D;n-m&#x3D;7-3&#x3D;4$即数据字位数</p>
<p>$r&#x3D;m&#x3D;3$即冗余位数</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208103155013.png" alt="image-20230208103155013"></p>
<p>如何检错?</p>
<p>比如数据字0111,计算冗余校验位:<br>$$<br>\begin{cases}<br>r_0&#x3D;a_2+a_1+a_0&#x3D;1+1+1&#x3D;1\<br>r_1&#x3D;a_3+a_2+a_1&#x3D;0+1+1&#x3D;0\<br>r_2&#x3D;a_1+a_0+a_3&#x3D;1+1+0&#x3D;0</p>
<p>\end{cases}<br>$$<br>得到码字$0111001$</p>
<p>如果码字没有错误,那么接收方计算得到的q2q1q0应该全零</p>
<p>如果码字有一位出现错误,变成$0110001$</p>
<p>在接收方(接收方认为顶多有一位发生错误):<br>$$<br>q_0&#x3D;b_2+b_1+b_0+q_0&#x3D;1+1+0+1&#x3D;1<br>$$<br>此时已经发现错误了,但是不能确认是b2,b1,b0,q0这四位中的哪一位出现的差错</p>
<p>然后又算得<br>$$<br>q_1&#x3D;b_3+b_2+b_1+q_1&#x3D;0+1+1+0&#x3D;0<br>$$<br>说明b3b2b1q1都没错误,那么只有b0,q0中有错误</p>
<p>然后又算得<br>$$<br>q_2&#x3D;b_1+b_0+b_3+q_2&#x3D;1+0+0+0&#x3D;1<br>$$<br>可以肯定是$b_0$的错误了</p>
<blockquote>
<p>如果数据字至少是7位,计算满足一位检错条件的汉明编码方案<br>$$<br>\begin{cases}<br>n&#x3D;2^m-1\<br>k&#x3D;n-m\<br>r&#x3D;m<br>\end{cases}<br>$$</p>
<p>$$<br>k&#x3D;n-m&#x3D;2^m-1-m\ge7<br>$$</p>
<p>解得</p>
<p>$m&#x3D;4,n&#x3D;15,k&#x3D;11$</p>
<p>因此满足条件的编码方案是$C(15,11)$</p>
</blockquote>
<h4 id="循环冗余编码"><a href="#循环冗余编码" class="headerlink" title="循环冗余编码"></a>循环冗余编码</h4><p>Cyclic Redundancy Check,CRC</p>
<p>$C(n,k)$</p>
<p>n位的码字,其中k位数据字,最右边加上n-k个0作为校正子的初始值,这样n位传递给生成器</p>
<p>生成器用长度n-k+1的除数去除码字</p>
<p>得到n-k位余数,填到校正子上</p>
<p>真码字(数据字:校正子)就计算完毕了,然后传输,然后被接收</p>
<p>接收方校验器用相同除数除码字</p>
<p>如果得到n-k位余数是0则无误,码字前k位就是数据字</p>
<p>否则丢弃</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208110416498.png" alt="image-20230208110416498"></p>
<p>计算过程</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208111036131.png" alt="image-20230208111036131"></p>
<h5 id="多项式"><a href="#多项式" class="headerlink" title="多项式"></a>多项式</h5><p>CRC的除数称为生成多项式,简称生成子或者生成器$g(x)$</p>
<p>码字$c(x)&#x3D;d(x):s(x)$,码字就是数据字和校正子的增广</p>
<p>差错$e(x)$</p>
<p>校验原理:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208111438640.png" alt="image-20230208111438640"></p>
<p>在发送端计算完的真码字一定满足$\frac{c(x)}{g(x)}&#x3D;0$</p>
<p>因此对接收方的码字除以$g(x)$,如果不为零,说明一定存在$\frac{e(x)}{g(x)}$这一项,也就是说分子不为零,即存在$e(x)$这一项,即存在差错</p>
<p>生成多项式的形式决定了检错能力</p>
<h5 id="单个位差错"><a href="#单个位差错" class="headerlink" title="单个位差错"></a>单个位差错</h5><p>单个位差错是指$e(x)&#x3D;x^i$的情形</p>
<p>检测单个位差错需要保证$e(x)$不能被$g(x)$整除</p>
<p>比如如果设置$g(x)&#x3D;1$,则任何多项式都被$g(x)$整除,这就查不出任何错误来</p>
<p>如果生成多项式至少有两项,并且有1这一项(也就是$x^0$这一项),那么所有单比特错误都可以检出</p>
<p><strong>也就是说,$g(x)$的作用是,出现差错时,$e(x)$无法被$g(x)$整除</strong></p>
<h5 id="两独立位差错"><a href="#两独立位差错" class="headerlink" title="两独立位差错"></a>两独立位差错</h5><p>两独立位差错指$e(x)&#x3D;x^i+x^j$的情形<br>$$<br>e(x)&#x3D;x^i+x^j&#x3D;x^i(x^{j-i}+1)&#x3D;x^i(x^t+1)<br>$$<br>如果生成多项式$g(x)$无法整除$x^t+1$则所有独立两位错误都可以检查出来</p>
<p>比如$x+1$不能检查出两个相邻位的错误</p>
<p>$x^4+1$无法检查出两个相隔4位的错误</p>
<p>$x^3+x^2+1$就可以检查所有两个独立位错误</p>
<h5 id="奇数个位差错"><a href="#奇数个位差错" class="headerlink" title="奇数个位差错"></a>奇数个位差错</h5><p>奇数个位错误指:<br>$$<br>e(x)&#x3D;x^{i1}+x^{i2}+…+x^{ik}<br>$$<br>其中k是奇数</p>
<p>只要是$g(x)$包含$x+1$因式,就可以检查出$e(x)$,证明:</p>
<p>假设检查不出来,即$g(x)|e(x)$<br>$$<br>g(x)|e(x),x+1|g(x)\rightarrow x+1|e(x)<br>$$<br>只需要证明$x+1|e(x)$不能成立</p>
<p>如果任何一个偶数项多项式都可以被$x+1$整除,那么任何奇数项多项式,就可以拆成一个偶数项多项式加一个单独的多项式.那么问题转化为单个比特错误</p>
<p>于是只需要证明任何偶数项多项式可以被$x+1$整除</p>
<p>由于任何偶数项多项式,都可以转化为若干个这种形式的和<br>$$<br>x^a(x^t+1)<br>$$</p>
<p>由于多项式系数在**模2域上,**因此上式又可以写为<br>$$<br>x^n(1-x+x^2-x^3+…)&#x3D;x^n\frac{1-(-x)^t}{1-(-x)}<br>$$<br>当t是奇数时由上式得到<br>$$<br>x^t+1&#x3D;(x+1)(x^{t-1}-x^{t-2}+x^{t-3}-…)<br>$$<br>当t不是奇数,是偶数比如$e(x)&#x3D;x^2+1$,此时t&#x3D;2是偶数</p>
<p>这就可以利用系数在模2域上的性质了</p>
<p>此时$e(x)&#x3D;x^2+1&#x3D;x^2+2x+1&#x3D;(x+1)^2$</p>
<p>推广一下,可以得到$x^t+1&#x3D;(x+1)^t$其中t是偶数,并且系数在模2域上</p>
<p>这就证明了$x+1$整除任何偶数项多项式</p>
<h5 id="突发性错误"><a href="#突发性错误" class="headerlink" title="突发性错误"></a>突发性错误</h5><p>突发恶疾指接连几个bit位都可能发生错误<br>$$<br>e(x)&#x3D;x^j+…x^i&#x3D;x^j(1+…+x^{i-j})<br>$$<br>令$e’(x)&#x3D;1+…+x^{i-j}$</p>
<p>意思时,起码两头的i,j两位是有错误的,中间的位可能有错误也可能无误,但是无所谓</p>
<p>设$L&#x3D;i-j+1$,意思是突发性错误的长度</p>
<p>这L位中,提出公因式$x^j$之后,最低次项是1,最高次项是$x^{i-j}$,这两项肯定得有</p>
<p>设$g(x)&#x3D;x^r+…+1$表示生成多项式,它至少包含$x^r+1$两项,这保证了可以检测任何单比特错误.其他比r低次的项可有可无.</p>
<p><strong>如果$g(x)$阶比$e’(x)$大</strong>,即r&gt;L-1,显然$\frac{e’(x)}{g(x)}$是有余数的,此时任何差错都可以检查出来</p>
<p><strong>如果$g(x)$和$e’(x)$同阶</strong>,即r&#x3D;L-1,</p>
<p>此时只有$e’(x)&#x3D;g(x)$只有这种情况没有余数,这个概率是多大呢?</p>
<p>要求$g(x)$和$e’(x)$的每一项系数都相同,根据概率论独立事件乘法原则,这个概率是<br>$$<br>P(g(x)&#x3D;e’(x))&#x3D;(\frac{1}{2})^{L-2}&#x3D;(\frac{1}{2})^{r-1}<br>$$</p>
<blockquote>
<p>这里L-2的原因是,$g(x),e’(x)$最高次项和常数项1都已经是相同的了,只需要考虑中间各项的情况</p>
</blockquote>
<p>因此r&#x3D;L-1时,能够检查出错误的概率是$1-(\frac{1}{2})^{r-1}$</p>
<p><strong>如果$g(x)$比$e’(x)$阶小</strong>,即L&gt;r+1时,考虑啥情况检查不出错误?</p>
<p>比如$e(x)&#x3D;x^6+x^5+x+1$,$g(x)&#x3D;x^5+1$</p>
<p>此时$\frac{e(x)}{g(x)}&#x3D;x+1$可以被整除,无法检查出错误</p>
<p>考虑对于任意一个$g(x)$,只要是其阶比$e’(x)$小,一定存在$e’(x)$,使得$g(x)|e’(x)$吗?</p>
<p>确实如此,只需要构造$e’(x)&#x3D;x^{L-1-r}g(x)+g(x)&#x3D;(x^{L-1-r}+1)g(x)$</p>
<p>这是一个临界条件,保证了阶是L-1并且存在常数项1</p>
<p>还可以往里随便加$x^kg(x),k\in(0,L-1-r)$项</p>
<p>这样满足条件的构造共有$2^{L-2-r}$种</p>
<p>而L-1阶含常数项1的多项式共有$2^{L-2}$个</p>
<p>因此构造的出现概率就是$\frac{2^{L-2-r}}{2^{L-2}}&#x3D;(\frac{1}{2})^r$,也就是检不出错误的概率</p>
<p>那么能够检查出错误的概率就是$1-(\frac{1}{2})^r$</p>
<p>总结:</p>
<p>所有$L ≤ r $的突发性差错均可被检测到。</p>
<p>所有$L &#x3D; r + 1 $的突发性差错有$1 – (1&#x2F;2)r–1      $的概率被检测到。</p>
<p>所有$L &gt; r + 1 $的突发性差错有$1 – (1&#x2F;2)r     $ 的概率被检测到。</p>
<h5 id="高性能多项式特性"><a href="#高性能多项式特性" class="headerlink" title="高性能多项式特性"></a>高性能多项式特性</h5><ol>
<li>至少有两项,要有常数项1,保证检查一位错误</li>
<li>不能整除 $x^t + 1(2 ≤ t ≤ n − 1)$,保证检查两个独立位错误</li>
<li>应当有因子 $x + 1$,保证检查所有奇数位数错误</li>
</ol>
<h4 id="校验和"><a href="#校验和" class="headerlink" title="校验和"></a>校验和</h4><p>脚丫子都知道怎么算,注意结果要取反</p>
<h3 id="数据链路层协议"><a href="#数据链路层协议" class="headerlink" title="数据链路层协议:"></a>数据链路层协议:</h3><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204191849501.png" alt="image-20230204191849501"></p>
<p>只要带上ARQ的肯定有差错控制功能</p>
<p>noiseless channel是没有噪声,不会丢包,不会重复,无损坏帧的理想信道,最简单协议和停止等待协议只是最初的一厢情愿</p>
<table>
<thead>
<tr>
<th>协议</th>
<th>特点</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>simplest</td>
<td>纯纯理想环境,<br />发送方不需要考虑丢包坏帧的情况,要说啥只说一遍,不多废话<br />接收方就洗耳恭听,也不需要回复收到</td>
<td></td>
</tr>
<tr>
<td>stop-and-wait</td>
<td>发送方发<strong>一个</strong>帧,就等着接收方回复收到<br />如果没有收到回复,那么可能是网络阻塞或者接收方死球了<br />长时间没有收到回复就认为超时了,重发该帧<br />啥时候收到回复确认,啥时候发下一帧</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Stop-and-wait ARQ</td>
<td>停等ARQ协议中,每个帧要么编号1要么编号0(原序号模2得到)<br />如果收到0号帧,则下一个期望的就是1号帧<br />如果接收方接收到的帧不是期望帧,回复自己期望的那一帧<br />已发送的帧会被保留副本,如果超时没有收到该帧的确认(或者说下一帧的期待)<br />则重发超时帧</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204193901028.png" alt="image-20230204193901028"></td>
</tr>
<tr>
<td>Go-Back-N ARQ</td>
<td>实际上是Stop-and-wait ARQ的增强版<br />Stop-and-wait ARQ协议中没发一个包都要确认一下<br />现在可以<strong>发一组</strong>包然后确认一下<br />让确认这种控制信息比重更少</td>
<td></td>
</tr>
<tr>
<td>Selective Repeat ARQ</td>
<td>Go-Back-N ARQ的增强版<br />Go-Back-N ARQ中接收方窗口为1,<br />本算法中将接收方窗口增强到和发送方窗口一样大<br />但是窗口大小更小了,为$2^{m-1}$<br />(Go-Back-N ARQ中发送方窗口是$2^m-1$)</td>
<td></td>
</tr>
</tbody></table>
<h5 id="回退N帧自动重发请求"><a href="#回退N帧自动重发请求" class="headerlink" title="回退N帧自动重发请求"></a>回退N帧自动重发请求</h5><p>Go-Back-N Automatic Repeat Request</p>
<p>在帧头部设置一个帧序号字段,假设这个字段使用m位,那么可以编号$[0,2^m)$,即帧序号是模$2^m$的</p>
<p>发送窗口:</p>
<p>发送方的发送窗口大小就设置为$S_{size}&#x3D;2^m-1$,</p>
<blockquote>
<p>为什么要设置成这个值呢?为什么不设置成$2^m$?留作后话</p>
</blockquote>
<p>比如帧序号字段占用4bit,那么发送方滑动窗口大小就是16-1&#x3D;15</p>
<p>两个指针,</p>
<p>其中$S_f$永远指向最早没有被确认的窗口</p>
<p>$S_n$指向当前发送方应该发送的窗口位置</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204195038189.png" alt="发送窗口"></p>
<p>接收窗口:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204195932727.png" alt="image-20230204195932727"></p>
<p>接收方只需要一个指针即可,只需要记录下一个期待接收的窗口</p>
<p><strong>两个窗口如何交互?</strong></p>
<p>假设发送方连续发了0到14帧,这几个帧是陆续到达的,接收方收到第n帧就会回复期待n+1帧.也可能一股脑收到了n,n+1,n+2这三帧,此时接收方直接回复一个累计确认,期望第n+3帧</p>
<p>考虑有丢包,可能接收方对0到5帧的确认都丢了,但是对第6帧的确认没丢,被发送方收到了,这时发送方Sf指针直接移动到第7帧,也就是发送方窗口右移,此时发送方就可以继续发送第15,16,17等等帧了</p>
<p>也可能发送方第0帧就在路上丢包了,第1,2,等等帧都到了,但是接收方不要,就要第一帧,于是接收方直接丢弃并保持沉默,</p>
<p>发送方发现从第0帧往后,一直长时间没有收到回应,就要从第0帧这里开始重发0到14帧</p>
<p>**发送方滑动窗口大小设为$2^m-1$**的目的</p>
<blockquote>
<p>假设m&#x3D;4,即帧的编号$\in[0,15]$</p>
<p>并且假设滑动窗口大小大于等于$2^m&#x3D;16$,不妨就设置为16</p>
<p>好,现在一个大文件成帧之后</p>
<p>0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15…</p>
<p>滑动窗口要是16就会包含[0,15],假设发送方这16帧全都发出去了,但是网络太垃圾了,没有收到任何回复,而接收方实际上全都回复了,并且接收方已经准备接收下一个0号帧了</p>
<p>此时发送方认为接收方本次[0,15]全都没有收到,于是从0开始重发,但是接收方期望的是下一个0号帧</p>
<p>但是两个帧都是编号0,接收方无法发现错误,于是就错误地接受了</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204201039834.png" alt="image-20230204201039834"></p>
</blockquote>
<h5 id="选择性重传"><a href="#选择性重传" class="headerlink" title="选择性重传"></a>选择性重传</h5><p>在回退N帧自动重发中只有发送方会累计确认</p>
<p>在选择性重传中,发送方和接收方都会累计确认</p>
<p>解决了啥问题呢?</p>
<p>发送方如果发送了$[0,14]$这些帧,接收方可能就得发送15个确认回复,回复太多这是其一</p>
<p>其二是,如果发送方已经接到了[1,14],唯独0号帧路上丢包了,在回退N帧自动重发中,发送方就得从0开始重发[0,14]</p>
<p>而实际上只需要重发一个0就足够了,但是接收方脑子太小了,只认一个数,[1,14]已经忘记了.</p>
<p>于是就改进成<strong>选择性重传算法</strong></p>
<p>接收方加上了窗口,就有了缓存的能力</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230206220446089.png" alt="image-20230206220446089"></p>
<p>关键注意1号帧在发送途中丢包,但是2号帧顺利抵达,此时接收方回复NAK1,意思是期望1.然而在发送方针对NAK1的回应到达之前,3号帧也顺利抵达了,此时接收方默默收下,但是啥回复都没有</p>
<p>然后发送方的针对NAK1的回复1号帧到了,</p>
<p>此时接收方回复的是ACK4,通知发送方,3之前已经都接收到了,可以发送4及之后的帧了,</p>
<p>发送方接收到ACK4之后会调整自己的发送窗口,然后继续发送4,5,…号帧</p>
<p>**为啥发送方和接收方的窗口都得是$2^{m-1}$**呢?</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230204204344648.png" alt="image-20230204204344648"></p>
<p>假设m&#x3D;2,那么帧编号就是$[0,3]$此时窗口大小最大为2,否则,假设是3</p>
<p>发送方发送0,1,2三帧之后,都被接收方收到,但是所有回复都丢包了</p>
<p>此时接收方已经后移了接收窗口,此时接收方窗口内的期待0号帧是下一个0号帧.</p>
<p>但是发送方超时重发了刚才的0号帧</p>
<p>于是接收方就把刚才的0号帧当成下一个0号帧错误接收了</p>
<h5 id="带捎带的N步返回NRQ"><a href="#带捎带的N步返回NRQ" class="headerlink" title="带捎带的N步返回NRQ"></a>带捎带的N步返回NRQ</h5><p>捎带:将控制报文,比如NAK,ACK等等,附带到数据报文中一起发送</p>
<h4 id="带宽利用率"><a href="#带宽利用率" class="headerlink" title="带宽利用率"></a>带宽利用率</h4><p>首先计算整个链路充满数据,能放开多少数据,也就是带宽时延积</p>
<p>然后使用的协议在传播时间内最多能有多少帧,多少bit上到信道上传输</p>
<p>做比即可</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230206221303181.png" alt="image-20230206221303181"></p>
<h3 id="多路访问"><a href="#多路访问" class="headerlink" title="多路访问"></a>多路访问</h3><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230206222507328.png" alt="image-20230206222507328"></p>
<h4 id="随机访问协议"><a href="#随机访问协议" class="headerlink" title="随机访问协议"></a>随机访问协议</h4><p>所有站点低位相同,任何站点都不能组织其他站点说话</p>
<p>有话要说就根据自己的协议说</p>
<h5 id="AlOHA"><a href="#AlOHA" class="headerlink" title="AlOHA"></a>AlOHA</h5><p>任何站点,在任何时间,想说啥就说啥</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207093146683.png" alt="image-20230207093146683"></p>
<p>只要同一时间在信道上有两个帧,就会造成冲突,发生冲突的帧都会废掉</p>
<p>ALOHA协议流程:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207093619308.png" alt="image-20230207093619308"></p>
<p>最多重发$K_{max}$次,如果一直没有收到ACK回复则放弃</p>
<p>每次发送之后等待$2\times T_{p}$,这是接收ACK的窗口期</p>
<p>如果没有收到,则等待一个随机数的时间$T_{B}&#x3D; T_{p}\times R,r\in[0,2^k)$.然后再重发</p>
<h6 id="传输和传播"><a href="#传输和传播" class="headerlink" title="传输和传播"></a>传输和传播</h6><p>传输,transmission,又可以翻译为发射,是发送方将信号全放到信道上用的时间<br>$$<br>传输时间&#x3D;\frac{帧长}{带宽}<br>$$</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207093935960.png" alt="image-20230207093935960"></p>
<p>传播,propagation,信号的一位经过信道用时<br>$$<br>传播时间&#x3D;\frac{电缆长度}{信号速度(一般是光速)}<br>$$</p>
<h6 id="冲突时间"><a href="#冲突时间" class="headerlink" title="冲突时间:"></a>冲突时间:</h6><p>假设各帧长度相同,ALOHA的冲突时间是传输时间的两倍</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207094413864.png" alt="image-20230207094413864"></p>
<p>即在$[t-T_{fr},t+T_{fr}]$这期间,不允许有第二个帧</p>
<h6 id="吞吐量"><a href="#吞吐量" class="headerlink" title="吞吐量"></a>吞吐量</h6><p>$$<br>S&#x3D;G\times e^{-2G}<br>$$</p>
<p>单位:帧</p>
<blockquote>
<p>注意这里的吞吐量单位不是bps</p>
</blockquote>
<p>当且仅当$G&#x3D;\frac{1}{2}$,$S_{max}&#x3D;0.184$</p>
<p>G是帧传输时间内系统平均产生帧的数量</p>
<p>对于$G&#x3D;\frac{1}{2}$也好立即,因为冲突时间就是两个帧传输时间,如果整个系统在一个传输时间内产生的帧数均值是$G&#x3D;\frac{1}{2}$,则冲突事件内产生的帧数均值就是1</p>
<p>如果$G&gt;\frac{1}{2}$则冲突的概率增大,一旦发生冲突,两个帧都是废物</p>
<p>而吞吐量的定义是:单位时间内<strong>成功</strong>传送的数据量.</p>
<p>两个废物帧都不是成功传送,因此导致了吞吐量降低</p>
<blockquote>
<p>推导$S&#x3D;G\times e^{-2G}$</p>
<p>假设传输时间是T,当一个帧发射之后,在T时间内,系统中又发送帧数均值是G</p>
<p>也就是说,T时间内系统又发送一帧的概率为$G$</p>
<p>首先考虑吞吐量怎么计算</p>
<p>定义吞吐量:传输时间内,能够成功传输的帧数,则有:<br>$$<br>S&#x3D;GP_0<br>$$<br>其中$P_0$为一帧发送成功的概率,也就是冲突时间内没有第二个帧的概率.</p>
<p>$G$是T时间内系统发送帧数的<strong>均值</strong></p>
<p>$P_0$是成功率</p>
<p>那么$S&#x3D;GP_0$就计算了T时间内发送成功的帧数的<strong>均值</strong></p>
<p>下面考虑$P_0$怎么算</p>
<p>计算一帧成功传输的概率,也就是发送一帧之后2T时间内没有其他帧的概率</p>
<p>假设T时间内有其他X个帧发射.显然$X\sim P(G)$泊松分布,则分布律为<br>$$<br>P(X&#x3D;k)&#x3D;\frac{G ^k}{k!}e^{-G}<br>$$</p>
<p>在2T时间即冲突时间内,不发生冲突,意味着没有其他帧发送,其概率是<br>$$<br>P(X&#x3D;0)\times P(X&#x3D;0)&#x3D;(\frac{G^0}{0!}e^{-G})^2&#x3D;e^{-2G}<br>$$</p>
<p>带入$P_0&#x3D;P(X&#x3D;0)\times P(X&#x3D;0)&#x3D;e^{-2G}$得到<br>$$<br>S&#x3D;GP_0&#x3D;Ge^{-2G}<br>$$</p>
<p>如果定义吞吐量为:传输时间内成功传输的帧数.那么算到这里就结束了</p>
<p>如果定义吞吐量为:单位时间内成功传输的帧数.那么$S&#x3D;\frac{G{e^{-2G}}}{T}$</p>
<p>如果定义吞吐量为:单位时间内成功传输的bit数.那么$S&#x3D;\frac{G{e^{-2G}}}{T}\times 帧大小$</p>
</blockquote>
<h5 id="时隙ALOHA"><a href="#时隙ALOHA" class="headerlink" title="时隙ALOHA"></a>时隙ALOHA</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207102708453.png" alt="image-20230207102708453"></p>
<p>规定只能在每个Slotn一开始发送,每个帧顶多占用一个Slot,不会影响其他Slot</p>
<p>那么冲突只会发生在一个Slot之内,并且一旦发生冲突,一定是两个帧在时间上完全重合</p>
<h6 id="吞吐量-1"><a href="#吞吐量-1" class="headerlink" title="吞吐量"></a>吞吐量</h6><p>假设每个Slot开始时,系统中传输帧的均值为G帧,则Slot时间内又发送的帧数还是满足泊松分布</p>
<p>只不过冲突时间降为一个Slot,成功发送一帧的概率变为<br>$$<br>P_0&#x3D;P(X&#x3D;0)&#x3D;e^{-G}<br>$$<br>吞吐量就是$S&#x3D;GP_0&#x3D;Ge^{-G}$</p>
<h5 id="CSMA"><a href="#CSMA" class="headerlink" title="CSMA"></a>CSMA</h5><p>Carrier Sense Multiple Access</p>
<p>载波侦听 多路访问</p>
<p>发送前首先侦听,看看有没有其他帧在发送,可以缓解冲突,但是不能解决冲突</p>
<p>因为一个站点侦听时,可能另一个站点已经传输了信号,但是由于<strong>传播</strong>延迟,没有被本站点侦听到,如图所示:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207103600938.png" alt="image-20230207103600938"></p>
<p>B站点在t1时刻传输一个信号,C在t2时刻要发送一个信号,但是t2时刻信号尚未传播到C处,因此C在t2传输一个信号,就会和B传输的信号发生冲突</p>
<h6 id="冲突时间-1"><a href="#冲突时间-1" class="headerlink" title="冲突时间"></a>冲突时间</h6><p>在B开始传输消息,到消息传播到其他站点之前,这段时间是不能有第二个消息传播的</p>
<p>因此冲突时间就等于传播时间</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207104138197.png" alt="image-20230207104138197"></p>
<h6 id="冲突缓解方法"><a href="#冲突缓解方法" class="headerlink" title="冲突缓解方法"></a>冲突缓解方法</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207104446245.png" alt="image-20230207104446245"></p>
<h5 id="CSMA-CD"><a href="#CSMA-CD" class="headerlink" title="CSMA&#x2F;CD"></a>CSMA&#x2F;CD</h5><p>Carrier Sense Multiple Access with Collision Detection,带冲突检测的载波侦听多路访问</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207105245273.png" alt="image-20230207105245273"></p>
<p>之前CSMA协议中,一个站点只会在发送前进行检查,如果信道空闲就发送</p>
<p>现在CSMA&#x2F;CD在CSMA的基础上,一个站点会在发送时同时检查,如果侦测到信道中有其他信号,立刻终止发送</p>
<p>因为起码顺着该信号的传播方向上,如果再发送信号肯定是冲突了,那就不如立刻闭嘴不发了</p>
<h6 id="冲突检测时间"><a href="#冲突检测时间" class="headerlink" title="冲突检测时间"></a>冲突检测时间</h6><p>首先考虑如图所示情况</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207110344621.png" alt="image-20230207110344621"></p>
<p>如果传输时间很短但是传播延迟很长,可能就存在双方均检测不到冲突或者只有一方能够检测到冲突的情形</p>
<p>此时冲突废帧会被错误交付</p>
<p>为了避免这种情况,就需要传输时间和传播时间有约束关系</p>
<p>直接考虑距离最远的两个站点A,B的情况即可</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207111015408.png" alt="image-20230207111015408"></p>
<p>如果B在A的信号马上就要发到时才开始发送,直到B的信号被A侦听到时,A必须仍在发送</p>
<p>也就是说<strong>最小传输时间应为最大传播时间的两倍</strong>,如下图</p>
<blockquote>
<p>因为A,B是两个距离最远的站点,因此是最大传播时间</p>
</blockquote>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207111728369.png" alt="image-20230207111728369"></p>
<blockquote>
<p>CSMA&#x2F;CD网络中，带宽10Mbps，最大传播时间为25.6us，那么最小帧长度是多少？</p>
<p>假设帧长是x,则传输时间是$T_{fr}&#x3D;\frac{x}{10M}$</p>
<p>由$T_{fr}\ge 2T_p$得到<br>$$<br>\frac{x}{10\times 10^6}\ge 25.6\times 10^{-6}\times 2<br>$$<br>即$x\ge 512bit$</p>
<p>因此帧长最小为512比特</p>
</blockquote>
<h6 id="CSMA-CD算法流程"><a href="#CSMA-CD算法流程" class="headerlink" title="CSMA&#x2F;CD算法流程"></a>CSMA&#x2F;CD算法流程</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207112317356.png" alt="image-20230207112317356"></p>
<h5 id="CSMA-CA"><a href="#CSMA-CA" class="headerlink" title="CSMA&#x2F;CA"></a>CSMA&#x2F;CA</h5><p>Carrier Sense Multiple Access with Collision Avoidance,带冲突避免的载波侦听多路访问</p>
<p>这个协议挺有意思</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207151754370.png" alt="image-20230207151754370"></p>
<p>IFS:Interframe Space,IFS 帧间间隔</p>
<blockquote>
<p>IFS用于定义一个站点的优先权,优先权高的站点,其IFS就短</p>
<p>为啥IFS短了就意味着优先权高呢?这就需要了解协议如何工作的</p>
</blockquote>
<p>Contention Window 竞争窗口</p>
<p>工作流程:</p>
<img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207151820663.png" alt="CSMA/CA" style="zoom:25%;" />



<p>1.首先检查信道是否空闲,如果不是,重新检查</p>
<p>2.如果信道空闲,等待IFS时间</p>
<p>3.等完了再检查一下信道是否空闲,如果忙,退回1.</p>
<p>4.挑一个随机数$R\in[0,2^K)$,也就是在竞争窗口中抓阄</p>
<p>5.等R个时间片,然后检查信道是否忙,如果忙,就等会不忙了再发送.如果不忙就发送</p>
<p>6.发完了设置窗口期等待ACK回复,如果收到,则通信成功,否则K++,回头从1开始,如果K&gt;15则不再尝试,通信事变</p>
<h3 id="以太网"><a href="#以太网" class="headerlink" title="以太网"></a>以太网</h3><p>低层协议的组成</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207155541312.png" alt="image-20230207155541312"></p>
<p>OSI规定的数据链路层分成两个子层,一个是LLC层,一个是MAC层.前者承上后者启下</p>
<p>以太网是MAC的一种实现方式,并且是目前最成功的实现方式</p>
<h4 id="MAC地址"><a href="#MAC地址" class="headerlink" title="MAC地址"></a>MAC地址</h4><h5 id="MAC地址规定"><a href="#MAC地址规定" class="headerlink" title="MAC地址规定"></a>MAC地址规定</h5><p>以太网地址是一个6字节数,每个网卡都有一个固定的MAC地址</p>
<p>一个计算机可能由多张网卡,因此计算机可以有多个MAC地址</p>
<p><code>ipconfig /all</code>即可查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">以太网适配器 以太网:</span><br><span class="line"></span><br><span class="line">   媒体状态  . . . . . . . . . . . . : 媒体已断开连接</span><br><span class="line">   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class="line">   描述. . . . . . . . . . . . . . . : Realtek PCIe GbE Family Controller</span><br><span class="line">   物理地址. . . . . . . . . . . . . : 84-A9-38-F4-9B-69</span><br><span class="line">...</span><br><span class="line">  </span><br><span class="line">无线局域网适配器 WLAN:</span><br><span class="line"></span><br><span class="line">   连接特定的 DNS 后缀 . . . . . . . :</span><br><span class="line">   描述. . . . . . . . . . . . . . . : Intel(R) Wi-Fi 6 AX201 160MHz</span><br><span class="line">   物理地址. . . . . . . . . . . . . : 2C-6D-C1-98-7D-03</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>以<code>2C-6D-C1-98-7D-03</code>为例子,最左边是最高位,</p>
<p>称”第一个字节”为最左边的0x2C,第二个就是0x6D</p>
<h5 id="特殊地址"><a href="#特殊地址" class="headerlink" title="特殊地址"></a>特殊地址</h5><p>如果一个MAC地址第一个字节的最低为是0,则该地址是一个单播地址,是1则为多播地址</p>
<p>特殊的,如果MAC addr&#x3D;FF:FF:FF:FF:FF:FF,则该地址是一个广播地址</p>
<p>0x2C&#x3D;00101100b,显然所有的物理网卡地址必然是一个单播地址</p>
<p>怎么观察广播地址呢?可以观察ARP协议需要在以太网中广播寻找目标IP地址的主机</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207160905292.png" alt="image-20230207160905292"></p>
<p>源地址就是本机WLAN网卡的地址2C-6D-C1-98-7D-03,目的地址12个F,显然是一个广播</p>
<p>wireshark已经自动根据本机WLAN网卡的<strong>前三个字节</strong>判断出本网卡产自Intel公司</p>
<p>再一查好家伙made in 马来西亚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207161145923.png" alt="image-20230207161145923"></p>
<p>同理华为公司也会买下前三个字节用来标志自己公司的网卡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207161443085.png" alt="image-20230207161443085"></p>
<p>如果前三个字节是公司编号</p>
<p>那么一个公司编号最多能够产$2^{24}\approx400万$张网卡</p>
<p>如果一部手机使用一个wifi网卡,光中国就有13亿人,假设有1亿人用华为手机,显然一个公司编号是不够用的</p>
<h5 id="网络序"><a href="#网络序" class="headerlink" title="网络序"></a>网络序</h5><p>字节序不变,但是每个字节内的比特位分别调转(不是取反,是前后调转)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207161313727.png" alt="image-20230207161313727"></p>
<h4 id="MAC帧格式"><a href="#MAC帧格式" class="headerlink" title="MAC帧格式"></a>MAC帧格式</h4><p>MAC帧有两种格式,</p>
<p>不常用的802.2LLC帧,这是IEEE802工作组制定的答辩</p>
<p>最常用的EthernetV2帧</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207162023980.png" alt="image-20230207162023980"></p>
<p>MAC帧&#x3D;MAC头+MAC数据+FCS</p>
<p>其中MAC头包括目的地址,源地址,MAC数据类型</p>
<p>FCS就是校验和</p>
<p>MAC数据一般是IP数据报,包括IPv4包或者IPv6数据包</p>
<h5 id="不合法的MAC帧"><a href="#不合法的MAC帧" class="headerlink" title="不合法的MAC帧"></a>不合法的MAC帧</h5><p>以下有一则为不合法MAC帧</p>
<p>数据字段的长度与长度字段的值不一致；</p>
<p>帧的长度不是整数个字节；</p>
<p>用收到的帧检验序列 FCS 查出有差错；</p>
<p><strong>数据字段的长度不在 46 ~ 1500 字节之间；</strong></p>
<p> <strong>MAC 帧长度不在64 ~ 1518 字节之间；</strong></p>
<p>对于检查出的无效 MAC 帧就简单地丢弃，以太网<strong>不负责重传丢弃的帧。</strong> </p>
<p>这里对帧长度有一个规定,[64,1518]为啥会有这两头的限制呢?</p>
<h5 id="合法帧长度"><a href="#合法帧长度" class="headerlink" title="合法帧长度"></a>合法帧长度</h5><p>[64,1518]bytes</p>
<p>由于有限以太网使用CSMA&#x2F;CD协议,因此需要保证最小传输时间大于等于两倍的最大传播时间</p>
<p>而这两个时间的关系,关乎帧长度啥事呢?</p>
<p>显然帧长越长,传输时间就越长,可以推测帧长为64bytes时达到临界值</p>
<p>根据802.3规定,以太网最长2500米,带宽10Mbps,四个中继器,最坏情况下,往返时间(也就是两倍的最长传播时间)大约是50μs.</p>
<p>那么传输速度应该大于50μs.</p>
<p>又带宽是10Mbps,在50微妙内能够发送$50\times 10^{-6}s\times 10\times 10^6bps&#x3D;500bit$</p>
<p>增加安全边际,往上取整到512bit&#x3D;64byte</p>
<p>因此规定最小帧长就是64byte</p>
<p>那么又为啥限制最长帧长为1500呢?</p>
<p>因为网络是多台计算机共享的,如果一台主机一直喋喋不休地说,其他主机就得等着,因此一句话不能说太长</p>
<p>于是人为规定为最长1518byte</p>
<p>那么在以太网上的IP包长度就跟着被限制到[48,1500]字节</p>
<p>这个1500字节也就是MTU,最大传输单元</p>
<h3 id="网络连接"><a href="#网络连接" class="headerlink" title="网络连接"></a>网络连接</h3><h4 id="数据链路层设备"><a href="#数据链路层设备" class="headerlink" title="数据链路层设备"></a>数据链路层设备</h4><p>网桥,集线器,二层交换机都是链路层设备</p>
<table>
<thead>
<tr>
<th>一层设备</th>
<th>结构</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>中继器</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207210513001.png" alt="image-20230207210513001"></td>
<td>再生信号(不是放大信号),延长通信距离</td>
</tr>
<tr>
<td>集线器</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207210909500.png" alt="image-20230207210909500"><br />所有计算机同处于一个冲突域<br />集线器从一个端口进来的包会被无脑拷贝到所有的出端口</td>
<td>只是把多个主机联通,<br />相当于多通水管<br />多端口的中继器</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>二层设备</th>
<th>结构</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>网桥</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207211056989.png" alt="image-20230207211056989" style="zoom:25%;" /><br />网桥可以检查目标地址,根据自己学习建立的转发表,决定从哪个端口转发,相对集线器聪明了不少</td>
<td>减小冲突域,网桥的一个接口是一个冲突域<br />但是所有达到接口都在同一个广播域</td>
</tr>
<tr>
<td>二层交换机</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207163904317.png" alt="image-20230207163904317" style="zoom:25%;" /></td>
<td>消除冲突域,从此不再有冲突<br />相当于带阀门的多通水管<br />但是所有接口都在同一广播域</td>
</tr>
</tbody></table>
<p>区分两个术语:广播域,冲突域</p>
<p>广播域:能够接收广播帧的所有设备的集合</p>
<p>冲突域:所有共享介质(比如电缆)都是冲突域</p>
<p>显然广播域的范围要大于等于冲突域</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207213901157.png" alt="image-20230207213901157"></p>
<p>以太网:有线局域网的一种实现,链路层使用CSMA&#x2F;CD技术</p>
<h5 id="网桥"><a href="#网桥" class="headerlink" title="网桥"></a>网桥</h5><h6 id="爱学习の网桥"><a href="#爱学习の网桥" class="headerlink" title="爱学习の网桥"></a>爱学习の网桥</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207211927143.png" alt="image-20230207211927143"></p>
<p>刚接入局域网的网桥是个傻子,啥也不知道,但是他很快就会知道</p>
<p>一开始他的MAC:Port映射表是空的</p>
<p>当A@LAN1 向 D@LAN2发送一个数据帧之后,这个帧显然必须从网桥的1号端口进入.网桥从帧中得知,源地址A在1端口对应的LAN上,于是将A:1写入映射表</p>
<p>如果D回复A收到,立刻就会把D的MAC暴露给网桥,网桥就会记录D:2</p>
<p>D不回复也没关系,反正D只要一说话立刻就会被网桥学会</p>
<h6 id="环路问题"><a href="#环路问题" class="headerlink" title="环路问题"></a>环路问题</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207212358099.png" alt="image-20230207212358099"></p>
<p>如果有两个网桥同时连接了两个LAN</p>
<p>那么一个LAN发出的帧会同时被两个网桥转发,导致另一个LAN中出现两次该帧</p>
<h6 id="生成树算法"><a href="#生成树算法" class="headerlink" title="生成树算法"></a>生成树算法</h6><p>生成树算法用于建立多个LAN的最优联通路径</p>
<p>这里的最优可能是最小跳数,最小延迟,最大带宽等等</p>
<p>假设从网桥到LAN跳数为1，从LAN到网桥跳数为0。</p>
<blockquote>
<p>为啥要这样假设呢?</p>
<p>因为网桥不会主动向一个LAN发送帧,除非该帧的目的在这个LAN中</p>
<p>而一个LAN的帧要想传送到另一个LAN,必须要经过网桥</p>
<p>也就是说,网桥转发帧需要一定的代价,应该尽量减少转发量</p>
<p>而LAN向网桥发送帧这是不可阻阻挡的,几乎没有代价</p>
<p>因此有这么一个假设</p>
</blockquote>
<p>首先将网桥和LAN进行有向图建模,并标注边权</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207212859184.png" alt="image-20230207212859184"></p>
<blockquote>
<p>为啥没有两个网桥直接连接?或者两个LAN直接连接?</p>
<p>这不废话吗</p>
<p>两个网桥连接和只用一个网桥不一样吗?</p>
<p>两个LAN连接就是一个LAN</p>
<blockquote>
<p>两个LAN连接也得使用网桥啊(</p>
</blockquote>
</blockquote>
<p>生成树算法:</p>
<p>spanning tree algorithm:</p>
<p>1.每个网桥广播ID,选择最小的ID作为根网桥</p>
<p><strong>2.找出从根网桥到其它网桥或LAN的最短路径</strong></p>
<p>3.最短路径组合生成最短的树</p>
<p>4.标记转发端口和阻塞端口</p>
<p>注意生成树算法目的是,找出从根网桥到其他网桥和LAN的最短路,</p>
<p>而不是为每个LAN找出到其他各个LAN的最短路</p>
<p>使用生成树算法之后,阻塞端口不再使用,转发端口活跃</p>
<h5 id="交换机"><a href="#交换机" class="headerlink" title="交换机"></a>交换机</h5><p>交换机相对于集线器的优点:</p>
<p>1.每个端口是一个冲突域</p>
<p>2.根据目标MAC地址查转发表,决定发往哪个端口</p>
<p>3.全双工,由于没有冲突域,不需要CSMA&#x2F;CD协议</p>
<p>4.有缓存,各个接口的带宽可以不同</p>
<h4 id="网络层设备"><a href="#网络层设备" class="headerlink" title="网络层设备"></a>网络层设备</h4><p>链路层设备关心帧的MAC地址</p>
<p>网络层设备关心包的IP地址</p>
<p>三层设备就一个三层交换机和一个路由器</p>
<p>这个三层交换机不伦不类,它既有二层交换机那个交换转发的功能,也有路由器的路由功能</p>
<p>两者本身上的区别是,三层交换机主要是硬件驱动的,但是路由器是CPU+操作系统软件驱动的.这就导致三层交换机的效率远快于路由器</p>
<p>两者功能上的区别是,三层交换机用于连接相同性质的网络,比如连接两个LAN:192.168.2.1&#x2F;24和192.168.1.1&#x2F;24</p>
<p>但是路由器主要用于不同类型的网络连接,比如因特网和局域网的连接,入户网线可能给一个互联网的公网地址,需要使用一个路由器NAT转化为一个LAN.并且实际上的路由选择,负荷分担,链路备份,和其他网络交换路由信息,都是路由器实现的</p>
<p>路由功能:当IP报文抵达路由器时,决定转发给哪一个下一跳路由器</p>
<p>这个决策是基于路由器的路由表做出的</p>
<p>路由表可以人工填写静态的,也可以让路由器自己学,就跟网桥交换机的转发表差不多</p>
<h4 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h4><p>比较特殊的路由器</p>
<p>一个LAN内的主机如果想要跨LAN访问另一个主机,只通过二层交换机是做不到的,因为二层交换机是连IP地址都不知道的傻子.网关就是一个LAN和外部网络连接的关口.LAN内的主机只要是想和外部通信,无脑往网关发包就可以了,网关负责决定这个包如何路由</p>
<h4 id="虚拟局域网"><a href="#虚拟局域网" class="headerlink" title="虚拟局域网"></a>虚拟局域网</h4><p>交换机可以隔离冲突域但是无法隔离广播域</p>
<p>划分虚拟局域网之后可以隔离冲突域和广播域</p>
<p>在一个交换机上划分了VLAN,实际上相当于虚拟出多个交换机,每个交换机都分别连接到路由器上,形成多个LAN,并且这几个LAN互不连通.这个路由器就是各个LAN的网关</p>
<h5 id="等效结构"><a href="#等效结构" class="headerlink" title="等效结构"></a>等效结构</h5><p>如图所示</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207220800643.png" alt="image-20230207220800643"></p>
<p>这实际上就相当于</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207220913692.png" alt="image-20230207220913692"></p>
<h5 id="如何实现"><a href="#如何实现" class="headerlink" title="如何实现"></a>如何实现</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207221014728.png" alt="image-20230207221014728"></p>
<p>如果一个VLAN跨越了两个交换机,那么这个VLAN中两个计算机通过交换机通信时,交换机在发往另一个交换机之前,检查A计算机所处VLAN,然后在链路层帧后面加上VLAN标志,这样另一个交换机就知道把改帧转发给哪一个目标VLAN了</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207223219150.png" alt="image-20230207223219150"></p>
<p>如图所示的拓扑中,经过实验,<a href="mailto:&#x50;&#x43;&#x39;&#64;&#49;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#x2e;&#x31;&#48;&#x2e;&#x31;">&#x50;&#x43;&#x39;&#64;&#49;&#57;&#50;&#x2e;&#49;&#x36;&#56;&#x2e;&#x31;&#48;&#x2e;&#x31;</a> ping <a href="mailto:&#80;&#x43;&#49;&#51;&#64;&#49;&#57;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#49;&#48;&#x2e;&#51;">&#80;&#x43;&#49;&#51;&#64;&#49;&#57;&#x32;&#46;&#49;&#54;&#x38;&#x2e;&#49;&#48;&#x2e;&#51;</a>时,ICMP报文会被LSW5交换机准确地从GE0&#x2F;0&#x2F;4口转发到GE0&#x2F;0&#x2F;2端口,报文中也没有体现VLAN</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207223605022.png" alt="image-20230207223605022"></p>
<p><a href="mailto:&#80;&#x43;&#x31;&#51;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#49;&#48;&#x2e;&#51;">&#80;&#x43;&#x31;&#51;&#x40;&#49;&#x39;&#x32;&#x2e;&#49;&#54;&#x38;&#x2e;&#49;&#48;&#x2e;&#51;</a> ping <a href="mailto:&#80;&#67;&#49;&#49;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x31;&#x30;&#46;&#50;">&#80;&#67;&#49;&#49;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#54;&#56;&#46;&#x31;&#x30;&#46;&#50;</a>时会经过两个路由器的Trunk端口,其报文中,以太网头和IP头之间加上了VLAN编号,占用四个字节,这个玩意叫做tag(标签)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230207223506096.png" alt="image-20230207223506096"></p>
<h5 id="交换机端口类型"><a href="#交换机端口类型" class="headerlink" title="交换机端口类型"></a>交换机端口类型</h5><p>access类型,只属于一个VLAN,用于连接计算机</p>
<p>trunk类型,主干道,可以设置允许哪些VLAN通过,用于连接交换机</p>
<p>hybrid类型,类似于trunk,但是hybrid允许通过改接口的帧不带VLAN tag,而trunk要求必须带VLAN tag(除了缺省VLAN,默认是VLAN 1,的帧不需要带tag)</p>
<p>当端口接收到不带VLAN Tag的报文后，则将报文转发到<strong>属于缺省VLAN的端口</strong>(如果设置了端口的缺省VLAN ID,默认是VLAN 1)。</p>
<p>当端口发送带有VLAN Tag的报文时，如果该报文的VLAN ID与端口缺省的VLAN ID相同，则系统将去掉报文的VLAN Tag，然后再发送该报文。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/01/30/Spring/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/30/Spring/" class="post-title-link" itemprop="url">Spring Core</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-30 16:15:00 / Modified: 16:15:28" itemprop="dateCreated datePublished" datetime="2023-01-30T16:15:00+08:00">2023-01-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Spring-Core"><a href="#Spring-Core" class="headerlink" title="Spring Core"></a>Spring Core</h1><h2 id="Spring-Ioc容器"><a href="#Spring-Ioc容器" class="headerlink" title="Spring Ioc容器"></a>Spring Ioc容器</h2><h3 id="容器配置文件"><a href="#容器配置文件" class="headerlink" title="容器配置文件"></a>容器配置文件</h3><p>maven管理的Spring项目中,spring配置文件一半放在&#x2F;src&#x2F;main&#x2F;java&#x2F;resources目录下,比如</p>
<p>&#x2F;src&#x2F;main&#x2F;java&#x2F;resources&#x2F;beans.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    一个java bean--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dustball&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;114514&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    别名--&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>配置Spring容器对象</p>
<p>总共有五种标签</p>
<table>
<thead>
<tr>
<th>标签</th>
<th>意义</th>
<th>属性</th>
<th>元素</th>
</tr>
</thead>
<tbody><tr>
<td>beans</td>
<td>bean组</td>
<td></td>
<td></td>
</tr>
<tr>
<td>bean</td>
<td>一个pojo对象</td>
<td></td>
<td></td>
</tr>
<tr>
<td>alias</td>
<td>bean的别名</td>
<td></td>
<td></td>
</tr>
<tr>
<td>description</td>
<td>描述,相当于注释</td>
<td></td>
<td></td>
</tr>
<tr>
<td>import</td>
<td>导入其他xml配置</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="为什么要控制反转"><a href="#为什么要控制反转" class="headerlink" title="为什么要控制反转?"></a>为什么要控制反转?</h3><p>参考<a target="_blank" rel="noopener" href="https://www.cnblogs.com/zwh0910/p/14609021.html">为什么要用IOC:inversion of controll反转控制（把创建对象的权利交给框架） - 周文豪 - 博客园 (cnblogs.com)</a></p>
<p>之前在学javaweb时,每次高层访问底层,比如Service访问Dao层,高层上都要持有底层对象的句柄,并且掌握合适释放底层对象</p>
<p>实际上很麻烦,也没必要</p>
<p>这就好比去饭店吃饭,客人非要管着厨师怎么做饭.而实际上只需要管好点菜就行了</p>
<p>于是考虑使用设计模式中的单例模式,而引入设计模式又会造成代码的复杂性</p>
<p>反正不就是要一个对象,并且好管理吗?让Spring框架干这个事情</p>
<p>这就是Spring容器干的事情</p>
<p>将所有beans扔进Spring容器,让他管理,对于程序来说,Spring容器在全局位置,程序员可以自由调用</p>
<p>然后用BeanFactory等等工厂,对程序员提供接口,这个BeanFactory干了个啥?意思意思:</p>
<p><img src="https://img2020.cnblogs.com/blog/2138872/202104/2138872-20210402084150177-2053605761.png" alt="img"></p>
<p>类域里面有一个静态代码块,其用意是,当BeanFactory对象创建时仅执行一次,也就是单例模式.</p>
<p>静态代码块中读取了bean.properties,根据xml文件的配置,实例化bean放到Map&lt;String,Object&gt; beans容器中</p>
<p>这个容器实际上是一个Map字典,例子中使用HashMap实现之</p>
<p>此后要使用容器中的对象时,只需要调用工厂的getBean方法,传入的对象id作为键去查beans哈希表,查到就返回对象引用</p>
<p>所谓”依赖注入”,就是指把java bean放到Spring容器中去</p>
<blockquote>
<p>害tm注入,牛逼哄哄的,害什么控制反转,纯纯吓唬人</p>
</blockquote>
<p><img src="https://www.docs4dev.com/images/spring-framework/5.1.3.RELEASE/container-magic.png" alt="container magic"></p>
<h3 id="bean在何时创建"><a href="#bean在何时创建" class="headerlink" title="bean在何时创建"></a>bean在何时创建</h3><p><img src="https://atts.w3cschool.cn/attachments/image/20201030/1604037368126454.png" alt="Spring Bean"></p>
<p>从配置文件实例化Spring容器时创建</p>
<p>也就是说</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context=<span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这玩意执行之后,beans.xml中的所有Bean都会创建,并放置在Bean缓存池中</p>
<p>这一点可以下断点观察</p>
<p>但是,如果beans.xml中,一个bean如果带上了懒加载的属性,则啥时候用这个bean时,它才不得不加载</p>
<p>比如</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> <span class="attr">lazy-init</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dustball&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;114514&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个dustball就不会跟随context的实例化而同时创建,如果从来不调用dustball,它就不会被创建</p>
<h3 id="bean属性"><a href="#bean属性" class="headerlink" title="bean属性"></a>bean属性</h3><h4 id="id-class"><a href="#id-class" class="headerlink" title="id&amp;class"></a>id&amp;class</h4><p>最基本的属性就是id和class</p>
<p>id是这个bean在容器中的键,值就是bean的对象引用</p>
<p>class是这个bean的类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dustball&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;114514&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="scope"><a href="#scope" class="headerlink" title="scope"></a>scope</h4><p>规定bean的作用域,</p>
<p>singleton,单例模式,每次getBean调用,返回同一个实例.默认的作用域.</p>
<p>如果没有懒加载属性,则该bean会随容器一起创建,随容器一起销毁</p>
<p>prototype,原型模式,每次getBean调用,都会返回一个新的实例.</p>
<p>啥时候getBean,啥时候才会创建</p>
<h4 id="init-method"><a href="#init-method" class="headerlink" title="init-method"></a>init-method</h4><p><strong>不建议使用</strong></p>
<p><strong>不建议使用</strong></p>
<p><strong>不建议使用</strong></p>
<p>初始化回调函数</p>
<p>创建bean使用无参构造函数,可以在其中进行初始化</p>
<p>也可以另外指定初始化函数,该函数必须无参数无返回值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span> <span class="attr">init-method</span>=<span class="string">&quot;init&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;destroy&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dustball&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;114514&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>指定User类的init函数为初始化函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.pojo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User ctor called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="type">int</span> id, String name, String pwd)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;User 3arg ctor called&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.pwd = pwd;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;init method called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;destroy method called&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="Spring依赖注入"><a href="#Spring依赖注入" class="headerlink" title="Spring依赖注入"></a>Spring依赖注入</h2><h3 id="基于ctor的依赖注入"><a href="#基于ctor的依赖注入" class="headerlink" title="基于ctor的依赖注入"></a>基于ctor的依赖注入</h3><p>通过自定义的有参构造函数进行实例化就是基于ctor的依赖注入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里使用键决定参数对应关系,也可以使用index下标对应ctor的参数</p>
<p>这个配置届时会调用User的三参数ctor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">User</span><span class="params">(<span class="type">int</span> id, String name, String pwd)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;User 3arg ctor called&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.id = id;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">    <span class="built_in">this</span>.pwd = pwd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="基于setter的依赖注入"><a href="#基于setter的依赖注入" class="headerlink" title="基于setter的依赖注入"></a>基于setter的依赖注入</h3><p>之前用property元素配置bean时,之所以能够成功,是因为lombok的@Data注解,自动帮我们加上了setter方法</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;deutschball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;prototype&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;deutschball&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;property name=&quot;id&quot; value=&quot;2&quot;/&gt;</code>这句要求User类要有setID方法,对其传递参数2</p>
<h3 id="注入成员对象"><a href="#注入成员对象" class="headerlink" title="注入成员对象"></a>注入成员对象</h3><p>之前的User类有三个成员变量,一个基本数据类型int,两个String类型</p>
<p>现在UserProxy{User user;String seviceID};类型包括了一个User成员对象和一个String成员变量</p>
<p>如何注入这么一个UserProxy类型的bean呢?</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader_proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0x00001&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><code>&lt;property name=&quot;user&quot; ref=&quot;vader&quot;/&gt;</code>这里的ref应为一个bean的id标识</p>
<h3 id="注入内部bean"><a href="#注入内部bean" class="headerlink" title="注入内部bean"></a>注入内部bean</h3><p>bean里面可以包含一个bean作为成员对象</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> <span class="attr">id</span>=<span class="string">&quot;proxyUser&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;3&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;puppet&quot;</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">value</span>=<span class="string">&quot;0x00001&quot;</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>其中UserProxy类长这样:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.pojo;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> &#123;</span><br><span class="line">    User user;</span><br><span class="line">    String serviceID;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="注入集合"><a href="#注入集合" class="headerlink" title="注入集合"></a>注入集合</h3><p>啥时候用到啥时候回来学</p>
<h2 id="自动装配"><a href="#自动装配" class="headerlink" title="自动装配"></a>自动装配</h2><p>自动装配是为了简化注入成员对象的情形 </p>
<p>不使用自动装配:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader_proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0x00001&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>关键在于<code>&lt;property name=&quot;user&quot; ref=&quot;vader&quot;/&gt;</code>这一句,表明了本bean引用了哪一个bean</p>
<p>使用自动装配之后可以省去这句,由Spring(具体是谁我也不知道)自动决定引用哪一个bean</p>
<p>默认情况下是不会自动装配的,需要手动设置装配哪一个bean.</p>
<p>感觉上显示写明装配哪一个bean,代码更加清晰,并且也不会多复杂.自动装配反而降低可读性</p>
<h3 id="byName"><a href="#byName" class="headerlink" title="byName"></a>byName</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader_proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byName&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;user&quot; ref=&quot;vader&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0x00001&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>UserProxy中不需要显式指定user成员引用哪一个bean,因为其bean属性中有<code>autowire=&quot;byName&quot;</code>,根据名称自动装配</p>
<p>啥叫”根据名称自动装配?”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> &#123;</span><br><span class="line">    User user;</span><br><span class="line">    String serviceID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里成员对象user,其键名就是”user”,因此Spring会根据这个”user”去找id&#x3D;”user”的bean,也就是</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span> &gt;</span></span><br></pre></td></tr></table></figure>

<p>如果找到了,则使用该bean,否则使用null值</p>
<h3 id="byType"><a href="#byType" class="headerlink" title="byType"></a>byType</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader_proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;byType&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;user&quot; ref=&quot;vader&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0x00001&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>byType,根据类型自动专配,user成员是一个User类型,beans.xml中的user类型的bean自动作为成员进行装配</p>
<p>如果有两个以上的user bean,则会报错<code>expected single matching bean but found 2: dustball,user</code></p>
<h3 id="constructor-NaN"><a href="#constructor-NaN" class="headerlink" title="constructor"></a>constructor</h3><p>构造函数参数匹配</p>
<p>比较类似于byType,</p>
<p>区别就是constructor-arg和property的区别</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;user&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;vader_proxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.UserProxy&quot;</span> <span class="attr">autowire</span>=<span class="string">&quot;constructor&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;user&quot; ref=&quot;vader&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;serviceID&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0x0001&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;serviceID&quot; value=&quot;0x00001&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>









































<h2 id="使用注解开发"><a href="#使用注解开发" class="headerlink" title="使用注解开发"></a>使用注解开发</h2><p>在beans.xml中加上注解配置和自动扫描</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;beans xmlns=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="line">       xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">       xmlns:context=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="line">       xsi:schemaLocation=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="line"><span class="string">        https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span><br><span class="line"></span><br><span class="line">    &lt;context:annotation-config/&gt;</span><br><span class="line">    &lt;context:component-scan base-<span class="keyword">package</span>=<span class="string">&quot;top.dustball.pojo&quot;</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;/beans&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意此时自动扫描主机范围是<code>top.dustball.pojo</code>这个包下,可以扩大范围</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Component"><a href="#Component" class="headerlink" title="@Component"></a>@Component</h3><p>作用于类上</p>
<p>自动给类创建一个pojo</p>
<p>比如top.dustball.pojo.User类这样写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component(&quot;dustball&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>@Component(&quot;dustball&quot;)</code>将会自动创建一个bean,其id就是dustball</p>
<p>在测试类中就可以通过<code>context.getBean(&quot;dustball&quot;)</code>调用之</p>
<p>Component注解只能创建对象,但是无法设置对象的属性值,可以通过@Value注解设置属性值</p>
<p>如果只写<code>@Component</code>,不显示指定id,则默认bean使用类名的首字母小写作为id,即User类对应user bean</p>
<h4 id="衍生注解"><a href="#衍生注解" class="headerlink" title="衍生注解"></a>衍生注解</h4><table>
<thead>
<tr>
<th>衍生注解</th>
<th>作用于</th>
</tr>
</thead>
<tbody><tr>
<td>@Respository</td>
<td>UserDao</td>
</tr>
<tr>
<td>@Service</td>
<td>UserService</td>
</tr>
<tr>
<td>@Controller</td>
<td>UserController</td>
</tr>
</tbody></table>
<p>需要注意的是,beans.xml中指定要扫描的位置,</p>
<p>原来的位置是pojo包下的所有Dao层的类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball.pojo&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>现在要拓展范围,扫描所有Dao,Service,Controller层的类</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Value"><a href="#Value" class="headerlink" title="@Value"></a>@Value</h3><p>作用于属性或者setter上,配合@Component使用,初始化bean的各个属性</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.*;</span><br><span class="line"><span class="keyword">import</span> lombok.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">//@NoArgsConstructor</span></span><br><span class="line"><span class="comment">//@AllArgsConstructor</span></span><br><span class="line"><span class="comment">//@Data</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Component(&quot;dustball&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="meta">@Value(&quot;dustball&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;sjh&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String pwd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时Spring容器中自动创建的id&#x3D;dustball的bean,三个属性均已初始化</p>
<h3 id="Autowired"><a href="#Autowired" class="headerlink" title="@Autowired"></a>@Autowired</h3><p>作用于成员对象或者其setter方法上</p>
<p>自动装配成员对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.ToString;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Repository;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    User user;<span class="comment">//此处由Spring容器自动寻找user类型的bean,找到则自动装配</span></span><br><span class="line">    <span class="meta">@Value(&quot;0x10000&quot;)</span></span><br><span class="line">    String serviceID;<span class="comment">//此处默认初始化为0x10000</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上是<strong>byType</strong>实现的</p>
<p>因此beans.xml中应该有一个id为user的bean,或者User类上带有Component注解或者其衍生注解</p>
<p>Autowired和Required的关系:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Autowired &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">required</span><span class="params">()</span> <span class="keyword">default</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认情况下required&#x3D;true,这意味着user这个成员对象必须被一个bean装配,如果SpringIoc容器中找不到合适的bean则报错</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">No qualifying bean of <span class="built_in">type</span> <span class="string">&#x27;top.dustball.pojo.User&#x27;</span> available</span><br></pre></td></tr></table></figure>

<p>如果required&#x3D;false,则该成员对象可以为null,SpringIoc容器中找不到合适的bean就直接摆烂不找了,赋值为null</p>
<h3 id="Qualifier"><a href="#Qualifier" class="headerlink" title="@Qualifier"></a>@Qualifier</h3><p>配合@Autowired一起使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = true)</span></span><br><span class="line">            <span class="meta">@Qualifier(value = &quot;dustball&quot;)</span></span><br><span class="line">    User user;</span><br><span class="line">    <span class="meta">@Value(&quot;0x10000&quot;)</span></span><br><span class="line">    String serviceID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本来只用@Autowired相当于byType自动装配bean,现在希望装配一个指定id的bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Qualifier(value = &quot;dustball&quot;)</span></span><br></pre></td></tr></table></figure>

<p>这就限定了必须使用id&#x3D;dustball的这个bean</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dustball&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.pojo.User&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">value</span>=<span class="string">&quot;11&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;vader&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="Scope"><a href="#Scope" class="headerlink" title="@Scope"></a>@Scope</h3><p>作用于类上,配合@Component以及其衍生注解一起使用</p>
<p>用于指定该bean的作用域,要么是singleton要么是prototype</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Scope(&quot;singleton&quot;)</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br></pre></td></tr></table></figure>





<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserProxy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired(required = true)</span></span><br><span class="line">            <span class="meta">@Qualifier(value = &quot;dustball&quot;)</span></span><br><span class="line">    User user;</span><br><span class="line">    <span class="meta">@Value(&quot;0x10000&quot;)</span></span><br><span class="line">    String serviceID;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="xml给👴爬"><a href="#xml给👴爬" class="headerlink" title="xml给👴爬"></a>xml给👴爬</h2><p>之前不管是纯xml配置还是使用注解简化的xml配置,都离不开xml</p>
<blockquote>
<p>即使是注解开发,也需要一个这种的xml文件:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>实际上注解贡献的bean和xml中注册的bean地位是完全相同的</p>
</blockquote>
<p>“基于java的配置”,就是指,使用一个java类作为bean的注册来源,而不再使用任何xml文件</p>
<p>比如top.dustball.pojo.UserConfig这个类,作为bean的来源,可以这样写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Scope;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean(initMethod = &quot;init&quot;)</span></span><br><span class="line">    <span class="meta">@Scope(&quot;singleton&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">deutschball</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">100</span>,<span class="string">&quot;deutschball&quot;</span>,<span class="string">&quot;sjh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserProxy <span class="title function_">deutschproxy</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">UserProxy</span>(deutschball(),<span class="string">&quot;0x1000&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@Configuration注解作用于类上,表明本类作为bean的注册来源</p>
<p>被@Bean注解修饰的成员函数将会生成一个id为函数名的bean</p>
<p>可以结合@Scope修饰该bean的作用域</p>
<p>如果有成员对象依赖,可以使用其他函数的返回值,只要将对应函数修饰为单例模式,就可以保证每次返回同一个对象</p>
<p>需要注意的是,基于java类的配置,<strong>会与直接在User,UserProxy类上写的@Component注解打架</strong>,并且有可能创建两个bean</p>
<p>因此要么 使用java类的配置,要么使用xml+注解,不要混用</p>
<table>
<thead>
<tr>
<th>基于java类的配置</th>
<th>基于xml文件的配置</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>方法名</td>
<td>bean id</td>
<td></td>
</tr>
<tr>
<td>方法返回值</td>
<td>bean class</td>
<td></td>
</tr>
<tr>
<td>@Bean修饰方法</td>
<td>注册一个bean</td>
<td></td>
</tr>
</tbody></table>
<p>还要注意的是,实例化容器时有变动</p>
<p>从xml构建容器要这样写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>从java类构建容器要这样写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ApplicationContext context=<span class="keyword">new</span> <span class="title class_">AnnotationConfigApplicationContext</span>(UserConfig.class);</span><br></pre></td></tr></table></figure>



<h2 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h2><p>为啥要学代理模式呢?</p>
<p>因为Spring AOP由动态代理实现,学动态代理是为了知道其原理</p>
<p>为啥要先学静态代理呢?因为动态代理和静态代理的目的相同</p>
<p><strong>在不改变已有代码的基础上,增加新功能</strong></p>
<p>至于为啥不能改变原有代码,<del>是主人的变态任务罢了</del></p>
<p>比如第三方jar包提供的类或者函数,要增强其功能,就可以通过代理模式实现</p>
<p>十五斤,三十块,满意了吧?</p>
<h3 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h3><p>静态代理通过组合实现</p>
<p>也就是被代理对象作为代理类的成员对象.</p>
<p>类图表示为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">classDiagram </span><br><span class="line">    class NotePad&#123;</span><br><span class="line">    	+void print();</span><br><span class="line">    	+void insert(row,col,text)</span><br><span class="line">    	+void delete(row,col,length)</span><br><span class="line">    &#125;</span><br><span class="line">    class RealNotePad&#123;</span><br><span class="line">    	-filename:string</span><br><span class="line">    	+void print();</span><br><span class="line">    	+void insert(int index,string text)</span><br><span class="line">    	+void delete(int begin,int end)</span><br><span class="line">        +void open(string filename)</span><br><span class="line">    &#125;</span><br><span class="line">    class ProxyNotePad&#123;</span><br><span class="line">    	-realnotepad:RealNotePad</span><br><span class="line">    	-filename:string</span><br><span class="line">    	-buffer:string</span><br><span class="line">    	+void print();</span><br><span class="line">    	+void insert(row,col,text)</span><br><span class="line">    	+void delete(row,col,length)</span><br><span class="line">    &#125;</span><br><span class="line">	NotePad&lt;|..RealNotePad</span><br><span class="line">	NotePad&lt;|..ProxyNotePad</span><br><span class="line">	class Main&#123;</span><br><span class="line">		void main();</span><br><span class="line">	&#125;</span><br><span class="line">	ProxyNotePad&lt;..Main</span><br><span class="line">	RealNotePad &lt;..ProxyNotePad</span><br><span class="line">	ProxyNotePad o..RealNotePad</span><br></pre></td></tr></table></figure>



<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>动态体现在:没有实际存在的代理类,在运行时用反射创建临时代理类,实例化代理对象之后返回这个代理对象,交由被代理的接口管理句柄</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">                target.getClass().getClassLoader(),</span><br><span class="line">                target.getClass().getInterfaces(),</span><br><span class="line">                <span class="built_in">this</span></span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(method.getName()+<span class="string">&quot; method called&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> method.invoke(target,args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用代理:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UserDaoImpl userDao=<span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line"><span class="type">ProxyInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyInvocationHandler</span>(userDao);</span><br><span class="line">UserDao proxy=(UserDao)handler.getProxy();</span><br><span class="line">proxy.delete(<span class="number">10</span>);</span><br></pre></td></tr></table></figure>

<p>1.<code>UserDaoImpl userDao=new UserDaoImpl();</code></p>
<p>实例化了一个普通的UserDao实现类对象userDao,这跟之前没有用代理的情形没有区别</p>
<p>2.<code>ProxyInvocationHandler handler = new ProxyInvocationHandler(userDao);</code></p>
<p>userDao作为被代理对象,其引用传递给handler.target保管,便于handler成员方法调用</p>
<p>ProxyInvocationHandler类中实现了两个方法,getProxy和invoke,(忽略lombok自动实现的方法),</p>
<p>其中InvocationHandler接口实际上只要求必须实现invoke方法</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span><br></pre></td></tr></table></figure>

<p>其中proxy是被代理的对象,method是proxy对象要被增强的方法,args是本来应该传递给该方法的参数</p>
</blockquote>
<p>getProxy纯粹是我们为了省事才写到ProxyInvocationHandler类中的方法</p>
<p>到此为止只调用过ProxyInvocationHandler的全参数构造函数(lombok注解@AllArgsConstructor),也就是说,只做了target引用赋值这么一件事</p>
<p>大的要来了</p>
<p>3.<code>UserDao proxy=(UserDao)handler.getProxy();</code></p>
<p>获取了一个代理对象,怎么说获取就获取了?为什么从handler那里获取?关键在于handler.getProxy函数</p>
<p>这个函数干了啥?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">            target.getClass().getClassLoader(),</span><br><span class="line">            target.getClass().getInterfaces(),</span><br><span class="line">            <span class="built_in">this</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>java.lang.reflect.Proxy</code>这个类用于动态生成代理类，只需传入目标接口、目标接口的类加载器以及InvocationHandler便可为目标接口生成代理类及代理对象。具体函数干了啥,需要反射的知识,现在不会</p>
<p>三个参数,</p>
<p>第一个是被代理类的类加载器,也就是<code>target.getClass().getClassLoader()</code>,也就是UserDaoImpl类的类加载器,</p>
<blockquote>
<p>然而视频教程里这里写的是<code>this.getClass().getClassLoader()</code>,也就是ProxyInvocationHandler类的类加载器</p>
<p>弹幕的说法是,这两个类都是我们自己写的自定义类,所以类加载器是一个</p>
<p>打印观察发现确实如此</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">UserDaoImpl userDao=<span class="keyword">new</span> <span class="title class_">UserDaoImpl</span>();</span><br><span class="line">System.out.println(userDao.getClass().getClassLoader());</span><br><span class="line"></span><br><span class="line"><span class="type">ProxyInvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProxyInvocationHandler</span>(userDao);</span><br><span class="line">System.out.println(handler.getClass().getClassLoader());</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jdk.internal.loader.ClassLoaders<span class="variable">$AppClassLoader</span>@78308db1</span><br><span class="line">jdk.internal.loader.ClassLoaders<span class="variable">$AppClassLoader</span>@78308db1</span><br></pre></td></tr></table></figure>

<p>都是使用应用类加载器(实际上一共就三个类加载器)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/20200426185027299.png" alt="在这里插入图片描述"></p>
<p>也就是说,这三个参数传递给<code>Proxy.newProxyInstance</code>之后,该函数并不知道要代理哪一个对象,只知道需要代理哪些接口,增强方法在this.invoke,那么代理对象执行的业务,是如何作用到原对象上的呢?</p>
<p>通过invoke函数作用到原对象userDao上</p>
</blockquote>
<p>第二个是需要代理的接口,因为被代理类可以implements多个接口,因此这里可以有选择地代理其接口</p>
<p>第三个是本对象(一个实现InvocationHanler接口的对象,目的是绑定本对象的invoke函数,增强代理接口的功能)</p>
<p>三个参数传入<code>Proxy.newProxyInstance</code>之后,返回一个代理对象,交给左值<code>UserDao proxy</code>保管</p>
<p>这个代理对象具有哪些函数呢?这个由第二个参数决定,传入的接口中有啥函数,这个代理对象就有啥函数</p>
<p>并且代理对象每次调用这些函数,(不管哪一个)都会首先调用invoke方法,可以在invoke函数中增强函数功能</p>
<p>4.<code>proxy.delete(10);</code></p>
<p>代理对象调用接口中的delete函数,然而是否真的能够调用到UserDaoImpl.delete()函数,得看ProxyInvocationHandler.invoke函数的脸色</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">    System.out.println(method.getName()+<span class="string">&quot; method called&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> method.invoke(target,args);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>invoke拦截proxy.delete这次调用,然后打印<code>delete method called</code></p>
<p>然后才会将调用转发给<code>target.delete(args)</code></p>
<p>具体底层怎么实现,学了反射再说</p>
<h2 id="Spring-AOP"><a href="#Spring-AOP" class="headerlink" title="Spring AOP"></a>Spring AOP</h2><p>之前学了动态代理,并不是让我们直接用动态代理写代码,SpringAOP已经帮我们实现了,我们只需要调用其接口</p>
<h3 id="官方の废话"><a href="#官方の废话" class="headerlink" title="官方の废话"></a>官方の废话</h3><table>
<thead>
<tr>
<th>概念</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td>横切关注点</td>
<td>跨越应用程序多个模块的方法或者功能,与业务逻辑无关但是需要关注,比如日志,安全,缓存,事务</td>
</tr>
<tr>
<td>切面</td>
<td>横切关注点被模块化的特殊对象,切面是一个类</td>
</tr>
<tr>
<td>通知</td>
<td>切面要完成的工作,通知是切面类的一个方法</td>
</tr>
<tr>
<td>目标</td>
<td>被通知的对象(目标对象)</td>
</tr>
<tr>
<td>代理</td>
<td>代理对象</td>
</tr>
<tr>
<td>切入点</td>
<td>可以被通知的函数,每个成员函数都可以作为切入点</td>
</tr>
<tr>
<td>连接点</td>
<td>实际被通知的函数,只有感兴趣的切入点才会被作为连接点</td>
</tr>
</tbody></table>
<h3 id="AOP-过滤器-钩子"><a href="#AOP-过滤器-钩子" class="headerlink" title="AOP&#x2F;过滤器&#x2F;钩子"></a>AOP&#x2F;过滤器&#x2F;钩子</h3><p>比较类似的几个东西</p>
<p>AOP用于拦截函数调用</p>
<p>过滤器用于拦截用户请求</p>
<p>钩子是回调性质的,用钩子也可以改变程序控制流</p>
<p>AOP和钩子的区别在于,钩子必须给每个函数分别设置,但是AOP可以直接给多个函数上钩子</p>
<h3 id="Spring-AOP-1"><a href="#Spring-AOP-1" class="headerlink" title="Spring AOP"></a>Spring AOP</h3><p>Spring AOP是AOP的实现</p>
<p>Spring AOP可以劫持一个方法,在方法执行之前&#x2F;之后,或者抛出异常时添加额外功能</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230129091802544.png" alt="image-20230129091802544"></p>
<p>当代理对象执行一个业务,比如add时:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">代理对象.add()&#123;</span><br><span class="line">	验证参数();</span><br><span class="line">	前置日志();</span><br><span class="line">	目标对象.add();</span><br><span class="line">	后置日志();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样看来目标对象的所有业务逻辑都被劫持了,并且在代理对象中加上了相同的前置和后置业务</p>
<p>能否有选择的劫持,不同的函数调用劫持后不同对待呢?</p>
<blockquote>
<p>如果是我们自己实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.dao;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ProxyInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line"> <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">()</span>&#123;</span><br><span class="line">     <span class="keyword">return</span> Proxy.newProxyInstance(</span><br><span class="line">             <span class="built_in">this</span>.getClass().getClassLoader(),</span><br><span class="line">             target.getClass().getInterfaces(),</span><br><span class="line">             <span class="built_in">this</span></span><br><span class="line">     );</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">     <span class="keyword">if</span>(method.getName().equals(<span class="string">&quot;add&quot;</span>))&#123;</span><br><span class="line">         System.out.println(<span class="string">&quot;add hijacked&quot;</span>);</span><br><span class="line">         <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//劫持add方法不予执行</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span>(method.getName().equals(<span class="string">&quot;select&quot;</span>))&#123;</span><br><span class="line">         <span class="keyword">return</span> method.invoke(target,args);<span class="comment">//直接放行</span></span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">else</span>&#123;</span><br><span class="line">         System.out.println(method.getName()+<span class="string">&quot; method called&quot;</span>);<span class="comment">//其他方法打印前置日志后放行</span></span><br><span class="line">         <span class="keyword">return</span> method.invoke(target,args);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代理对象的所有方法调用都会首先被劫持到invoke方法,invoke方法决定下一步如何</p>
</blockquote>
<p>在SpringAOP中,不需要自己写动态代理的逻辑,只需要写好配置文件</p>
<h3 id="方法1-XML配置"><a href="#方法1-XML配置" class="headerlink" title="方法1:XML配置"></a>方法1:XML配置</h3><p>首先在Service层有一个UserServiceImpl下面用SpringAOP代理之</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.service.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UserService</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;UserService add calleda&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">select</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">delete</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在log包下有一个日志类LogBefore实现了MethodBeforeAdvice接口,这个类将会被作为切面,其before函数将会作为通知作用于UserServiceImpl的成员函数调用之前</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBefore</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;log before &quot;</span>+method.getName()+<span class="string">&quot; is called&quot;</span>);</span><br><span class="line">        method.invoke(target,args);<span class="comment">//此处存在错误,留作伏笔</span></span><br><span class="line">		</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面就是xml文件的配置了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.service.User.UserServiceImpl&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;logBefore&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.log.LogBefore&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;logAfter&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.log.LogAfter&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        定义切入点--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;cutBefore&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;cutAfterAdd&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.service.User.UserServiceImpl.add())&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        切入点和哪个切面通知挂钩--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;logBefore&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cutBefore&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;logAfter&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cutAfterAdd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>首先注册三个bean,其中userService是目标对象</p>
<p>另外两个bean都是日志类,作为切面</p>
<p>然后是aop配置,其中expression表达式是关键,它决定本切入点作用于被代理对象的哪一个函数</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;cutBefore&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这句话干了个什么事呢?给UserServieImpl类的任何函数都带上cutBefore切入点</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">execution(</span><br><span class="line">	modifiers-pattern</span><br><span class="line">	ret-type-pattern </span><br><span class="line">	declaring-type-pattern</span><br><span class="line">	name-pattern(param-pattern)</span><br><span class="line">	throws-pattern</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>returning type pattern,name pattern, and parameters pattern是必须的.</p>
<p>ret-type-pattern:可以为*表示任何返回值,全路径的类名等.</p>
<p>name-pattern:指定方法名, <em>代表所有</em></p>
<p>set代表以set开头的所有方法.</p>
<p>parameters pattern:指定方法参数(声明的类型),</p>
<p>(..)代表所有参数,(<code>*</code>)代表一个参数</p>
<p>(<code>*</code>,String)代表第一个参数为任何值,第二个为String类型.</p>
</blockquote>
<p>到现在位置是只定义了切入点,并没有往里切入东西,此时调用userService对象,看不出被代理的作用</p>
<p>下面给切入点插入通知就体现代理的作用了</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;logBefore&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cutBefore&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>给cutBefore切入点加上logBefore通知</p>
<p>测试类这样写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> top.dustball.service.User.UserService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) context.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        userService.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行结果:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">log</span> before add is called</span><br><span class="line">UserService add called</span><br><span class="line">UserService add called</span><br><span class="line"><span class="built_in">log</span> after add is called with <span class="built_in">return</span> value = null</span><br></pre></td></tr></table></figure>

<p>表明userService已经被代理了</p>
<p>然而奇怪的是,我们并没有显式调用代理对象,而是从容器context中拿出目标对象userService直接使用</p>
<p>程序逻辑却没有根据userService.add本来的样子走,而是执行了logBefore.before切面通知之后,然后才执行userService.add</p>
<p><strong>也就是说,在Test类看来,他不知道userService.add到底怎么实现的,他也看不到存在AOP,他只管调用就可以了</strong></p>
<p>奇怪的是,测试类中只调用了一次userService.add,结果中却打印了两次<code>UserService add called</code></p>
<p>这是因为在LogBefore.before切面通知函数中,我们画蛇添足了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBefore</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;log before &quot;</span>+method.getName()+<span class="string">&quot; is called&quot;</span>);</span><br><span class="line">        method.invoke(target,args);<span class="comment">//画蛇添足</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>method.invoke(target,args);</code>这句会在before函数执行完毕之后,被自动执行,不需要我们手动调用 </p>
<p>手动调用了就会再执行一次,去掉即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.MethodBeforeAdvice;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LogBefore</span> <span class="keyword">implements</span> <span class="title class_">MethodBeforeAdvice</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">before</span><span class="params">(Method method, Object[] args, Object target)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;log before &quot;</span>+method.getName()+<span class="string">&quot; is called&quot;</span>);</span><br><span class="line"><span class="comment">//        method.invoke(target,args);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="遗留问题"><a href="#遗留问题" class="headerlink" title="遗留问题"></a>遗留问题</h4><p>既然Test中调用的仍然是userService这个bean,那么把他作为UserServiceImpl可以不</p>
<p>也就是说</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserServiceImpl</span> <span class="variable">userServiceimp</span> <span class="operator">=</span> (UserServiceImpl) context.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line"><span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) context.getBean(<span class="string">&quot;userService&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这两种写法哪个对?</p>
<p>结果证明<code>UserService userService = (UserService) context.getBean(&quot;userService&quot;);</code>这个是对的</p>
<p>一定要注意左值是UserService接口类型,不是UserServiceImpl类型</p>
<p>那么为啥userService这个bean一开始是一个UserServiceImpl的对象,后来就不是了?</p>
<p>如果不加aop:config这一段,两种写法是都可以的</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        定义切入点--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;cutBefore&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;cutAfterAdd&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.service.User.UserServiceImpl.add())&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--        切入点和哪个切面通知挂钩--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;logBefore&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cutBefore&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;logAfter&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;cutAfterAdd&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加上aop:config之前,<code>userService.getClass()=&quot;class top.dustball.service.User.UserServiceImpl&quot;</code></p>
<p>加上aop:config之后,<code>userService.getClass()=&quot;class jdk.proxy2.$Proxy7&quot;</code>,已经是代理对象了</p>
<p>至于到底发生了什么让userService被狸猫换太子,现在不想管</p>
<h3 id="方法2-使用自定义类实现AOP"><a href="#方法2-使用自定义类实现AOP" class="headerlink" title="方法2:使用自定义类实现AOP"></a>方法2:使用自定义类实现AOP</h3><p>基本都使用方法1,啥时候用到这个法再来学吧</p>
<h3 id="方法3-使用注解开发"><a href="#方法3-使用注解开发" class="headerlink" title="方法3:使用注解开发"></a>方法3:使用注解开发</h3><p>首先要有一个切面类</p>
<p>@Aspect注解作用到的类就作为切面类,</p>
<p>其方法中被@Before或者@After或者@Around注解的,成为通知</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.AOP;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.Signature;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.After;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Around;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Aspect;</span><br><span class="line"><span class="keyword">import</span> org.aspectj.lang.annotation.Before;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AnnotationPointCut</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//before和after注解的方法,在执行之后,控制流会自动执行目标对象的函数,不需要手动执行,因此没有参数</span></span><br><span class="line"><span class="comment">//    @Before(&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;)</span></span><br><span class="line"><span class="comment">//    public void before()&#123;</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;log before method is called&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    @After(&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;)</span></span><br><span class="line"><span class="comment">//    public void after()&#123;</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;log after method is called&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">    <span class="meta">@Around(&quot;execution(* top.dustball.service.User.UserServiceImpl.* (..))&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">around</span><span class="params">(ProceedingJoinPoint proceedingJoinPoint)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before&quot;</span>);</span><br><span class="line">        <span class="type">Signature</span> <span class="variable">signature</span> <span class="operator">=</span> proceedingJoinPoint.getSignature();<span class="comment">//获取函数签名</span></span><br><span class="line">        System.out.println(signature);</span><br><span class="line">        proceedingJoinPoint.proceed();<span class="comment">//真正调用目标对象的add方法</span></span><br><span class="line">        System.out.println(<span class="string">&quot;after&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>然后将该切面类注册到Spring容器中</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/aop/spring-aop.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;top.dustball&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;annotationPointCut&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.AOP.AnnotationPointCut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>实现的功能和方法1相同</p>
<p>测试类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> top.dustball.service.User.UserService;</span><br><span class="line"><span class="keyword">import</span> top.dustball.service.User.UserServiceImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;beans.xml&quot;</span>);</span><br><span class="line">        <span class="type">UserService</span> <span class="variable">userService</span> <span class="operator">=</span> (UserService) context.getBean(<span class="string">&quot;userService&quot;</span>);</span><br><span class="line">        userService.add();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">before</span><br><span class="line">void top.dustball.service.User.UserService.add()</span><br><span class="line">UserService add called</span><br><span class="line">after</span><br></pre></td></tr></table></figure>



<h2 id="Spring-MyBatis"><a href="#Spring-MyBatis" class="headerlink" title="Spring+MyBatis"></a>Spring+MyBatis</h2><h3 id="maven依赖"><a href="#maven依赖" class="headerlink" title="maven依赖"></a>maven依赖</h3><p>一定要注意spring的各个组件版本号一致</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.19<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-jdbc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.mybatis.spring.boot/mybatis-spring-boot-starter --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/com.mysql/mysql-connector-j --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.32<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-webmvc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.slf4j/slf4j-api --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="回顾javaweb中使用mybatis"><a href="#回顾javaweb中使用mybatis" class="headerlink" title="回顾javaweb中使用mybatis"></a>回顾javaweb中使用mybatis</h3><p>之前javaweb中如何使用mybatis的?</p>
<h4 id="mybatis-config-xml配置"><a href="#mybatis-config-xml配置" class="headerlink" title="mybatis-config.xml配置"></a>mybatis-config.xml配置</h4><p>在resources目录下有一个mybatis-config.xml文件,其作用主要是配置数据源和映射mapper映射关系</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    top.dustball.pojo下面的类在本文件中均可以只是用非全限制类名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;top.dustball.pojo&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">typeAliases</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!--    environments目录下面可以配置多个environment环境,在environments标签的default属性中设置使用哪一个即可--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;POOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!--    注册映射关系--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;top/dustball/mapper/UserMapper/UserMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="top-dustball-mapper-UserMapper包"><a href="#top-dustball-mapper-UserMapper包" class="headerlink" title="top.dustball.mapper.UserMapper包"></a>top.dustball.mapper.UserMapper包</h4><p>一个UserMapper接口,一个UserMapper.xml映射配置文件</p>
<p>其中UserMapper.xml必须绑定UserMapper接口,</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;https://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;top.dustball.mapper.UserMapper.UserMapper&quot;</span>&gt;</span>  <span class="comment">&lt;!--绑定接口--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--    在UserMapper接口中使用注解开发--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>然后可以在UserMapper.xml中写CRUD标签,比如<code>&lt;select&gt;</code></p>
<p>也可以在UserMapper接口中直接使用注解开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.mapper.UserMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.annotations.Select;</span><br><span class="line"><span class="keyword">import</span> top.dustball.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"><span class="comment">//    使用注解之后,就不需要在UserMapper.xml中写&lt;select&gt;这种增删改查的标签了</span></span><br><span class="line">    <span class="meta">@Select(&quot;SELECT * FROM user WHERE id= #&#123;userID&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="type">int</span> userID)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="top-dustball-utils下创建MyBatisUtil工具类"><a href="#top-dustball-utils下创建MyBatisUtil工具类" class="headerlink" title="top.dustball.utils下创建MyBatisUtil工具类"></a>top.dustball.utils下创建MyBatisUtil工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBatisUtil</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;<span class="comment">//类变量,只会被静态代码块初始化一次</span></span><br><span class="line">    <span class="keyword">static</span> &#123;<span class="comment">//静态代码块,只会在类加载时执行一次</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">resource</span> <span class="operator">=</span> <span class="string">&quot;mybatis-config.xml&quot;</span>;<span class="comment">//配置文件位置</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Resources.getResourceAsStream(resource);<span class="comment">//xml文件转化为文件输入流</span></span><br><span class="line">            sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(inputStream);<span class="comment">//根据文件创建sqlSessionFactory工厂</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SqlSession <span class="title function_">getSqlSession</span><span class="params">()</span>&#123;<span class="comment">//获取一个数据库会话连接</span></span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory.openSession();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>此后就可以在测试类中MyBatisUtil.getSqlSession了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.io.InputStreamResource;</span><br><span class="line"><span class="keyword">import</span> top.dustball.mapper.UserMapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> top.dustball.pojo.User;</span><br><span class="line"><span class="keyword">import</span> top.dustball.utils.MyBatisUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> MyBatisUtil.getSqlSession();</span><br><span class="line">        <span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);<span class="comment">//获取UserMapper.class的映射器</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> mapper.getUser(<span class="number">2</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Spring中使用mybatis"><a href="#Spring中使用mybatis" class="headerlink" title="Spring中使用mybatis"></a>Spring中使用mybatis</h3><h4 id="配置spring-dao-xml"><a href="#配置spring-dao-xml" class="headerlink" title="配置spring-dao.xml"></a>配置spring-dao.xml</h4><p>(mybatis-config.xml可以保留也可以直接扬了,spring完全可以覆盖mybatis的配置,这里选择保留)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span> <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/util https://www.springframework.org/schema/util/spring-util.xsd&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">&lt;!--    注册数据源,使用第三方类DriverManagerDataSource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;datasource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注册工厂类,此处可以导入mybatis-config.xml--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--也可以直接在本sqlSessionFactory中配置,不使用mybatis-config.xml--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--教程的做法是,mybatis-config.xml只保留typeAilas作用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;datasource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        可以在此处注册映射器,也可以在mybatis-config.xml中注册映射器,由于mybatis-config.xml已经注册过,这里不再重复--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;mapperLocations&quot; value=&quot;top/dustball/mapper/UserMapper/UserMapper.xml&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;typeAliases&quot; value=&quot;top.dustball.pojo&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    创建数据库会话实例,本bean的作用与之前的MyBatisUtil.getSqlSession相同--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        本bean只可以只用构造函数注入,因其不含setter方法--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>  <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    实例化映射器,关于user表的业务可以直接从userMapper上进行操作,相当于sqlSession.getMapper(UserMapper.class)--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.mapper.UserMapper.UserMapperImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>一是注意sqlSession的类型是SqlSessionTemplate,不再是SelSession(实际上是相同的作用)</p>
<p>二是注意最后创建的映射器实例,是UserMapperImpl类的实例,(显然UserMapper接口不能实例化)</p>
<p>这是区别于javaweb中使用mybatis的地方,之前只需要UserMapper接口和UserMapper.xml即可</p>
<p>现在还需要加一个UserMapperImpl,因为Spring bean是实例,只有类才可以实例化</p>
<p>总结一下就是</p>
<p>实例化数据源</p>
<p>实例化工厂</p>
<p>实例化会话</p>
<p>实例化映射器</p>
<h4 id="top-dustball-mapper-UserMapper包下再创建UserMapperImpl类"><a href="#top-dustball-mapper-UserMapper包下再创建UserMapperImpl类" class="headerlink" title="top.dustball.mapper.UserMapper包下再创建UserMapperImpl类"></a>top.dustball.mapper.UserMapper包下再创建UserMapperImpl类</h4><p>现在UserMapper包下有三个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\sprint-01\Demo2\src\main\java\top\dustball\mapper\UserMapper&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\86135\Desktop\sprint-01\Demo2\src\main\java\top\dustball\mapper\UserMapper</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a---           2023/1/30    11:22            352 UserMapper.java</span><br><span class="line">-a---           2023/1/30    10:47            316 UserMapper.xml</span><br><span class="line">-a---           2023/1/30    11:24            668 UserMapperImpl.java</span><br></pre></td></tr></table></figure>

<p>其中UserMapperImpl是新增的实现类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.mapper.UserMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line"><span class="keyword">import</span> top.dustball.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMapperImpl</span> <span class="keyword">implements</span> <span class="title class_">UserMapper</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> SqlSessionTemplate sqlSession;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSqlSession</span><span class="params">(SqlSessionTemplate sqlSession)</span> &#123;</span><br><span class="line"><span class="comment">//设置setter方法,方便注入</span></span><br><span class="line">        <span class="built_in">this</span>.sqlSession = sqlSession;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="type">int</span> userID)</span> &#123;</span><br><span class="line"><span class="comment">//        System.out.println(&quot;getUser called&quot;);</span></span><br><span class="line">        <span class="type">UserMapper</span> <span class="variable">mapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">        <span class="keyword">return</span> mapper.getUser(userID);<span class="comment">//实际上还是调用了UserMapper接口中被@Select注解的getUser方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原本获取mapper映射器是用户(程序员)的任务,需要在测试类中完成</p>
<p>现在mapper直接被封装到UserMapperImpl中</p>
<p>程序员只需要在测试类中调用userMapper.getUser(2);</p>
<h4 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.support.ClassPathXmlApplicationContext;</span><br><span class="line"><span class="keyword">import</span> top.dustball.mapper.UserMapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> top.dustball.pojo.User;</span><br><span class="line"><span class="keyword">import</span> top.dustball.utils.MyBatisUtil;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestUser</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//创建SpringIoc容器</span></span><br><span class="line">        <span class="type">ClassPathXmlApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-dao.xml&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//获取userMapper映射器bean</span></span><br><span class="line">        <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> (UserMapper) context.getBean(<span class="string">&quot;userMapper&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//执行dao业务</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.getUser(<span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="spring-mybatis简化用法"><a href="#spring-mybatis简化用法" class="headerlink" title="spring+mybatis简化用法"></a>spring+mybatis简化用法</h3><p>之前在UserMapperImpl中我们需要维护一个成员对象sqlSession,如果让UserMapperImpl继承SqlSessionDaoSupport类,则不再需要</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.mapper.UserMapper;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.SqlSessionTemplate;</span><br><span class="line"><span class="keyword">import</span> org.mybatis.spring.support.SqlSessionDaoSupport;</span><br><span class="line"><span class="keyword">import</span> top.dustball.pojo.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserMapperImpl</span> <span class="keyword">extends</span> <span class="title class_">SqlSessionDaoSupport</span> <span class="keyword">implements</span> <span class="title class_">UserMapper</span>&#123;</span><br><span class="line"><span class="comment">//    private SqlSessionTemplate sqlSession;</span></span><br><span class="line"><span class="comment">//    public void setSqlSession(SqlSessionTemplate sqlSession) &#123;</span></span><br><span class="line"><span class="comment">////设置setter方法,方便注入</span></span><br><span class="line"><span class="comment">//        this.sqlSession = sqlSession;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="type">int</span> userID)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getSqlSession().getMapper(UserMapper.class).getUser(userID);</span><br><span class="line">        <span class="comment">//实际上还是调用了UserMapper接口中被@Select注解的getUser方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这个类已经帮我们实现了getSqlSession方法</p>
<p>需要注意的是,在spring-dao.xml中稍有变化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">   之前:</span><br><span class="line">&lt;bean id=<span class="string">&quot;userMapper&quot;</span> class=<span class="string">&quot;top.dustball.mapper.UserMapper.UserMapperImpl&quot;</span>&gt;</span><br><span class="line">       &lt;property name=<span class="string">&quot;sqlSession&quot;</span> ref=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br><span class="line"></span><br><span class="line">   之后:</span><br><span class="line">   &lt;bean id=<span class="string">&quot;userMapper&quot;</span> class=<span class="string">&quot;top.dustball.mapper.UserMapper.UserMapperImpl&quot;</span>&gt;</span><br><span class="line">       &lt;property name=<span class="string">&quot;sqlSessionTemplate&quot;</span> ref=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span><br><span class="line">   &lt;/bean&gt;</span><br></pre></td></tr></table></figure>

<p>之前我们手动维护的成员对象叫做sqlSession,而之后继承自SqlSessionDaoSupport的是sqlSessionTemplate对象,实际上两个作用相同,就是property中的键名要改一下而已</p>
<h3 id="使用事务"><a href="#使用事务" class="headerlink" title="使用事务"></a>使用事务</h3><h4 id="AOP实现事务织入"><a href="#AOP实现事务织入" class="headerlink" title="AOP实现事务织入"></a>AOP实现事务织入</h4><p>只需要在spring-dao.xml中增加配置,不需要修改任何源代码</p>
<p>spring-dao.xml这样写:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:context</span>=<span class="string">&quot;http://www.springframework.org/schema/context&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:aop</span>=<span class="string">&quot;http://www.springframework.org/schema/aop&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:util</span>=<span class="string">&quot;http://www.springframework.org/schema/util&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:tx</span>=<span class="string">&quot;http://www.springframework.org/schema/tx&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/beans/spring-beans.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/context</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/context/spring-context.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/aop</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/aop/spring-aop.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/util</span></span></span><br><span class="line"><span class="string"><span class="tag">        https://www.springframework.org/schema/util/spring-util.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/tx</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/tx/spring-tx.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    注册数据源,使用第三方类DriverManagerDataSource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;datasource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/mybatis&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sjh123456&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--注册工厂类,此处可以导入mybatis-config.xml--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--也可以直接在本sqlSessionFactory中配置,不使用mybatis-config.xml--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--教程的做法是,mybatis-config.xml只保留typeAilas作用--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSessionFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;datasource&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;configLocation&quot;</span> <span class="attr">value</span>=<span class="string">&quot;classpath:mybatis-config.xml&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        可以在此处注册映射器,也可以在mybatis-config.xml中注册映射器,由于mybatis-config.xml已经注册过,这里不再重复--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;mapperLocations&quot; value=&quot;top/dustball/mapper/UserMapper/UserMapper.xml&quot;/&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        &lt;property name=&quot;typeAliases&quot; value=&quot;top.dustball.pojo&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    创建数据库会话实例,本bean的作用与之前的MyBatisUtil.getSqlSession相同--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;sqlSession&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        本bean只可以只用构造函数注入,因其不含setter方法--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>  <span class="attr">ref</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    实例化映射器,关于user表的业务可以直接从userMapper上进行操作,相当于sqlSession.getMapper(UserMapper.class)--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;userMapper&quot;</span> <span class="attr">class</span>=<span class="string">&quot;top.dustball.mapper.UserMapper.UserMapperImpl&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionTemplate&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;sqlSession&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">ref</span>=<span class="string">&quot;datasource&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--    tx是事务标签--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        给哪些方法上事务--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        配置事务的传播特性--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        一般设计数据库的业务都需要事务,查询除外,因此可以简单粗暴全上事务--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;add*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;delete*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;update*&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;select&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--        mapper下面的所有类的所有方法都作为切点--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* top.dustball.mapper.*.*.* (..) )&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--txAdivce作为通知应用于pointcut切点--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>增加了一个transactionManager,一个txAdvice,一个aop</p>
<p>其中事务管理器可以有多种,JDBC,Druid等等</p>
<p>关键在于<code>&lt;tx:advice&gt;</code>标签,即事务通知,该标签用于说明给哪些方法上事务,只是针对方法名,此时还不会针对类名</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;add*&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里propagation属性用于设置事务的传播属性,一般都是用REQUIRED,其他的有需要再查</p>
<blockquote>
<p>事务的七种传播特性</p>
<p><strong>默认值是required</strong></p>
<p><strong>默认值是required</strong></p>
<p><strong>默认值是required</strong></p>
<table>
<thead>
<tr>
<th>传播特性</th>
<th>意义</th>
</tr>
</thead>
<tbody><tr>
<td><code>required </code></td>
<td>如果存在当前事务，那么加入该事务，<br />如果不存在事务，就创建一个事务。这是<code>propagation</code>的默认值</td>
</tr>
<tr>
<td><code>supports </code></td>
<td>如果当前已经存在事务，那么加入该事务，<br />否则创建一个所谓的空事务。</td>
</tr>
<tr>
<td><code>mandatory </code></td>
<td>当前必须存在一个事务，否则抛出异常</td>
</tr>
<tr>
<td><code>requires-new </code></td>
<td>如果当前存在事务，先把当前事务相关内容封装到一个实体，<br />然后重新创建一个新事务，并接受这个实体作为参数，用于事务恢复。</td>
</tr>
<tr>
<td><code>not-supported </code></td>
<td>如果当前存在事务，挂起当前事务，然后新的方法在没有事务的环境中执行。<br />没有spring事务的环境下，sql的提交完全依赖于<code>defaultAutoCommit</code>属性值</td>
</tr>
<tr>
<td><code>never </code></td>
<td>如果当前存在事务，则抛出异常。<br />否则在无事务的环境上执行代码</td>
</tr>
<tr>
<td><code>nested</code></td>
<td>如果当前存在事务，则使用<code>savepoint</code>技术将当前事务状态进行保存，&lt;br &#x2F;然后底层公用一个链接，<br />当nested内部出现错误的时候，自行回滚到<code>save point</code>的状态。<br />只要外部捕获到了异常，就可以继续进行外部事务的提交，而不会受到内嵌事务的干扰。<br />但是，如果外部事物抛出了异常，整个大事务都会回滚。</td>
</tr>
</tbody></table>
</blockquote>
<p>最后aop:config标签的作用是,将tx:advice通知作用与mapper包下的所有类的所有方法</p>
<p>之后所有的Dao层操作都是事务操作.</p>
<p>此前和此后在测试类中调用没有区别.</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/01/27/Crack%20jar/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/27/Crack%20jar/" class="post-title-link" itemprop="url">jar包是什么</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-27 08:55:00 / Modified: 09:42:55" itemprop="dateCreated datePublished" datetime="2023-01-27T08:55:00+08:00">2023-01-27</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Crack-jar"><a href="#Crack-jar" class="headerlink" title="Crack jar"></a>Crack jar</h1><h2 id="jar包是啥"><a href="#jar包是啥" class="headerlink" title="jar包是啥"></a>jar包是啥</h2><p>jar(java archieve file),java归档文件</p>
<h2 id="与zip比较"><a href="#与zip比较" class="headerlink" title="与zip比较"></a>与zip比较</h2><p>其内容和zip文件非常相似,甚至可以直接使用360压缩这种软件解压</p>
<p>唯一的区别就是,jar中有一个META-INF目录,这里面有一个MANIFEST.MF文件,该文件可能长这样</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Implementation-Title: challenge</span><br><span class="line">Implementation-Version: 0.0.1-SNAPSHOT</span><br><span class="line">Built-By: shiyu</span><br><span class="line">Implementation-Vendor-Id: io.tricking</span><br><span class="line">Spring-Boot-Version: 2.1.0.RELEASE</span><br><span class="line">Main-Class: org.springframework.boot.loader.JarLauncher</span><br><span class="line">Start-Class: io.tricking.challenge.ChallengeApplication</span><br><span class="line">Spring-Boot-Classes: BOOT-INF/classes/</span><br><span class="line">Spring-Boot-Lib: BOOT-INF/lib/</span><br><span class="line">Created-By: Apache Maven 3.5.3</span><br><span class="line">Build-Jdk: 1.8.0_102</span><br><span class="line">Implementation-URL: https://projects.spring.io/spring-boot/#/spring-bo</span><br><span class="line"> ot-starter-parent/challenge</span><br></pre></td></tr></table></figure>

<p>其中最关键的是Main-Class信息,即jar包的入口点</p>
<p>有些jar包可以通过<code>java -jar a.jar</code>这种命令被执行,此时Main-Class就指定从哪个类的Main函数开始执行</p>
<p>可以理解为,这个META-INF&#x2F;MANIFEST.MF就是一个清单,表明该jar包的概要信息.</p>
<p>jar包其他文件主就是class字节码文件等</p>
<h2 id="打包目的"><a href="#打包目的" class="headerlink" title="打包目的"></a>打包目的</h2><p>打jar包的目的,实际上和c&#x2F;c++中制作.lib静态库或者.dll动态库一样,就一个文件,方便别人拷贝使用</p>
<p>模块化,标准化</p>
<p>只要写好文档,告诉别人如何调用jar包中的类和函数即可</p>
<p>maven管理的第三方库,都是使用jar包的形式提供的</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230126155922111.png" alt="image-20230126155922111"></p>
<h2 id="jar-vs-war"><a href="#jar-vs-war" class="headerlink" title="jar vs war"></a>jar vs war</h2><p>war包是Sun公司提出的web应用程序格式</p>
<p>两者相同点,都是一个压缩包</p>
<p>不同点,目录结构有区别</p>
<p>凡是能打war包的东西,必然能够打jar包</p>
<h2 id="如何打包"><a href="#如何打包" class="headerlink" title="如何打包"></a>如何打包</h2><h3 id="源代码"><a href="#源代码" class="headerlink" title="源代码"></a>源代码</h3><p>源代码结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# tree src -f</span><br><span class="line">src</span><br><span class="line">└── src/top</span><br><span class="line">    └── src/top/dustball</span><br><span class="line">        ├── src/top/dustball/Dao</span><br><span class="line">        │   └── src/top/dustball/Dao/User.java</span><br><span class="line">        └── src/top/dustball/Main.java</span><br><span class="line"></span><br><span class="line">3 directories, 2 files</span><br></pre></td></tr></table></figure>



<p>其中User.java是一个pojo</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball.Dao;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    String username;</span><br><span class="line">    String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">(String username,String password)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.username=username;</span><br><span class="line">        <span class="built_in">this</span>.password=password;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[&quot;</span>+username+<span class="string">&quot;,&quot;</span>+password+<span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Main.java是程序入口,依赖User类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"><span class="keyword">import</span> top.dustball.Dao.User;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;vader&quot;</span>, <span class="string">&quot;sjh&quot;</span>);</span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h3 id="javac编译"><a href="#javac编译" class="headerlink" title="javac编译"></a>javac编译</h3><p>打入jar包的都是class字节码文件,没有java源文件,因此首先需要javac编译</p>
<p>可以使用<code>javac &lt;sourcefile&gt; -d out</code>将所有字节码文件打包到out目录下</p>
<p>这里sourcefile没有找到一个一劳永逸的方法</p>
<p>每个javac命令最多只能编译一个目录下的所有java文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">top.dustball/</span><br><span class="line">	Dao/</span><br><span class="line">		User.java</span><br><span class="line">	Main.java</span><br></pre></td></tr></table></figure>

<p>这里Dao&#x2F;User.java和Main.java在不同的目录下,并且Main.java中依赖User.java,因此需要写一个很长的编译命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# javac src/top/dustball/Dao/*.java src/top/dustball/*.java -d out</span><br></pre></td></tr></table></figure>

<p>更好的方法是将所有需要编译的源代码文件写到一份清单中,然后让javac根据清单工作,比如在根目录下写一个JavaList.txt</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">src/top/dustball/Dao/User.java</span><br><span class="line">src/top/dustball/Main.java</span><br></pre></td></tr></table></figure>

<p>此时在此处执行javac,就是javac的当前工作目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# javac @JavaList.txt -d out</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# <span class="built_in">ls</span></span><br><span class="line">bin  JavaList.txt  lib  out  README.md  src</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# tree -f out</span><br><span class="line">out</span><br><span class="line">└── out/top</span><br><span class="line">    └── out/top/dustball</span><br><span class="line">        ├── out/top/dustball/Dao</span><br><span class="line">        │   └── out/top/dustball/Dao/User.class</span><br><span class="line">        └── out/top/dustball/Main.class</span><br><span class="line"></span><br><span class="line">3 directories, 2 files</span><br></pre></td></tr></table></figure>

<p>此时在根目录下已经生成了out目录,保留了包结构和所有class文件,下一步就是打jar包了</p>
<h3 id="jar打包"><a href="#jar打包" class="headerlink" title="jar打包"></a>jar打包</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# jar -cvf Main.jar out/top/dustball/Main.class out/top/dustball/Dao/User.class</span><br><span class="line">added manifest</span><br><span class="line">adding: out/top/dustball/Main.class(<span class="keyword">in</span> = 523) (out= 341)(deflated 34%)</span><br><span class="line">adding: out/top/dustball/Dao/User.class(<span class="keyword">in</span> = 897) (out= 485)(deflated 45%)</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# <span class="built_in">ls</span> *.jar</span><br><span class="line">Main.jar</span><br></pre></td></tr></table></figure>

<p>此时在jar工作目录,也就是跟目录下,生成了Main.jar其中都有啥呢?</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# jar -tf Main.jar</span><br><span class="line">META-INF/</span><br><span class="line">META-INF/MANIFEST.MF</span><br><span class="line">out/top/dustball/Main.class</span><br><span class="line">out/top/dustball/Dao/User.class</span><br></pre></td></tr></table></figure>

<p>两个class都已经打包进入了Main.jar</p>
<p>关键在这个<code>META-INF/MANIFEST.MF</code></p>
<p>提取Main.jar之后,该文件长这样</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Created-By: 11.0.17 (Debian)</span><br></pre></td></tr></table></figure>

<p>唯一的有效信息是jdk版本11.0.17,Debian操作系统</p>
<p>没有Main-Class入口点信息,显然直接java -jar是不可以执行的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# java -jar Main.jar</span><br><span class="line">no main manifest attribute, <span class="keyword">in</span> Main.jar</span><br></pre></td></tr></table></figure>

<p>没有主属性清单</p>
<p>怎么改呢?</p>
<p><strong>写到这里发现一个重大错误,包名不统一了</strong></p>
<p>啥意思呢?</p>
<p>之前javac,jar的工作目录都是根目录,而包在src路径之下,是根目录的子目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# jar -tf Main.jar</span><br><span class="line">META-INF/</span><br><span class="line">META-INF/MANIFEST.MF</span><br><span class="line">out/top/dustball/Main.class</span><br><span class="line">out/top/dustball/Dao/User.class</span><br></pre></td></tr></table></figure>

<p>此处out路径被当作了包的最外层,</p>
<p>可能是jar打包认为out也是包路径,但是class自己认为out不是包路径,此后就出错了</p>
<p>而实际上应该让包从top开始,如下:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# jar -tf Main.jar</span><br><span class="line">META-INF/</span><br><span class="line">META-INF/MANIFEST.MF</span><br><span class="line">top/dustball/Main.class</span><br><span class="line">top/dustball/Dao/User.class</span><br></pre></td></tr></table></figure>

<p>按照这样修改之后,在<code>META-INF/MANIFEST.MF</code>中这样写:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: <span class="number">1.0</span></span><br><span class="line">Created-By: <span class="number">11.0</span><span class="number">.17</span> (Debian)</span><br><span class="line">Main-Class: top.dustball.Main</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这就指定好了入口类</p>
<p>然后重新打包,这一次需要-m指定<code>META-INF/MANIFEST.MF</code>文件,作为jar包清单</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire]</span><br><span class="line">└─# jar -cvfm Main.jar META-INF/MANIFEST.MF top/dustball/Main.class top/dustball/Dao</span><br><span class="line">added manifest</span><br><span class="line">adding: top/dustball/Main.class(<span class="keyword">in</span> = 523) (out= 341)(deflated 34%)</span><br><span class="line">adding: top/dustball/Dao/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/Dao/User.class(<span class="keyword">in</span> = 897) (out= 485)(deflated 45%)</span><br></pre></td></tr></table></figure>



<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire]</span><br><span class="line">└─# java -jar Main.jar</span><br><span class="line">[vader,sjh]</span><br></pre></td></tr></table></figure>



<h3 id="更灵活的打包方式"><a href="#更灵活的打包方式" class="headerlink" title="更灵活的打包方式"></a>更灵活的打包方式</h3><p>javac编译时,使用清单列出需要编译的源文件是一个好办法</p>
<p>jar打包时有没有更方便的方法呢?</p>
<p>刚才我们有两个打jar包的方式,其一是直接指定所有class文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -cvf Main.jar out/top/dustball/Main.class out/top/dustball/Dao/User.class</span><br></pre></td></tr></table></figure>

<p>此时Manifest文件是自动生成的,不包含入口点等信息</p>
<p>需要编写Manifest文件之后重新打包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -cvfm Main.jar META-INF/MANIFEST.MF top/dustball/Main.class top/dustball/Dao</span><br></pre></td></tr></table></figure>

<p>奇怪的是,当时Dao&#x2F;User.class没有敲上,敲到Dao就停了,也成功打包了</p>
<p>现在把修改后的META-INF&#x2F;MANIFEST.MF整体拷贝到out目录下,现在的out目录:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# tree -f</span><br><span class="line">.</span><br><span class="line">├── ./META-INF</span><br><span class="line">│   └── ./META-INF/MANIFEST.MF</span><br><span class="line">└── ./top</span><br><span class="line">    └── ./top/dustball</span><br><span class="line">        ├── ./top/dustball/Dao</span><br><span class="line">        │   └── ./top/dustball/Dao/User.class</span><br><span class="line">        └── ./top/dustball/Main.class</span><br><span class="line"></span><br><span class="line">4 directories, 3 files</span><br></pre></td></tr></table></figure>

<p>在此处指定META-INF&#x2F;MANIFEST.MF并打包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# jar -cvfm Main.jar META-INF/MANIFEST.MF *</span><br><span class="line">added manifest</span><br><span class="line">ignoring entry META-INF/</span><br><span class="line">ignoring entry META-INF/MANIFEST.MF</span><br><span class="line">adding: top/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/Dao/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/Dao/User.class(<span class="keyword">in</span> = 897) (out= 485)(deflated 45%)</span><br><span class="line">adding: top/dustball/Main.class(<span class="keyword">in</span> = 523) (out= 341)(deflated 34%)</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# <span class="built_in">ls</span></span><br><span class="line">Main.jar  META-INF  top</span><br></pre></td></tr></table></figure>

<p>执行jar包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# java -jar Main.jar</span><br><span class="line">[vader,sjh]</span><br></pre></td></tr></table></figure>



<h3 id="更更灵活的打包方式"><a href="#更更灵活的打包方式" class="headerlink" title="更更灵活的打包方式"></a>更更灵活的打包方式</h3><p>在打包的时候不指定入口点而在执行的时候指定入口点</p>
<p>out目录状态:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# tree -f</span><br><span class="line">.</span><br><span class="line">└── ./top</span><br><span class="line">    └── ./top/dustball</span><br><span class="line">        ├── ./top/dustball/Dao</span><br><span class="line">        │   └── ./top/dustball/Dao/User.class</span><br><span class="line">        └── ./top/dustball/Main.class</span><br><span class="line"></span><br><span class="line">3 directories, 2 files</span><br></pre></td></tr></table></figure>

<p>直接再次处打jar包</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# jar -cvf Main.jar *</span><br><span class="line">added manifest</span><br><span class="line">adding: top/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/Dao/(<span class="keyword">in</span> = 0) (out= 0)(stored 0%)</span><br><span class="line">adding: top/dustball/Dao/User.class(<span class="keyword">in</span> = 897) (out= 485)(deflated 45%)</span><br><span class="line">adding: top/dustball/Main.class(<span class="keyword">in</span> = 523) (out= 341)(deflated 34%)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行时指定入口点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# java -<span class="built_in">cp</span> Main.jar top.dustball.Main</span><br><span class="line">[vader,sjh]</span><br></pre></td></tr></table></figure>





<h2 id="依赖jar包"><a href="#依赖jar包" class="headerlink" title="依赖jar包"></a>依赖jar包</h2><p>现在jar包中有一个top.dustball.User类,在Test类中调用之</p>
<p>在Test路径下有一个Main.jar这个包,还有测试类Test</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/Test]</span><br><span class="line">└─# <span class="built_in">ls</span></span><br><span class="line">Main.jar  Test.java</span><br></pre></td></tr></table></figure>

<p>其中Test.java试图调用User类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> top.dustball.Dao.User;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;vader&quot;</span>, <span class="string">&quot;sjh&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        System.out.println(user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译链接要加上-cp选项,指定依赖项</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--class-path &lt;path&gt;, -classpath &lt;path&gt;, -cp &lt;path&gt;</span><br><span class="line">       Specify where to find user class files and annotation processors</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\empire\Test&gt; javac Test.java -<span class="built_in">cp</span> Main.jar</span><br></pre></td></tr></table></figure>

<p>由于Test.java有一个包Test,因此需要退到上级目录执行</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\empire\Test&gt; <span class="built_in">cd</span> ..</span><br><span class="line">PS C:\Users\86135\Desktop\empire&gt; java Test/Test</span><br><span class="line">[vader,sjh]</span><br></pre></td></tr></table></figure>











<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><h3 id="jar命令"><a href="#jar命令" class="headerlink" title="jar命令"></a>jar命令</h3><p>jar命令是jdk的工具,该exe文件在jdk&#x2F;bin目录下,需要将该bin目录添加到系统环境变量path,也就是配置jdk环境变量</p>
<h4 id="jar-tf"><a href="#jar-tf" class="headerlink" title="jar -tf"></a>jar -tf</h4><p>列表列出jar包结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar -tf a.jar</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# jar -tf Main.jar</span><br><span class="line">META-INF/</span><br><span class="line">META-INF/MANIFEST.MF</span><br><span class="line">out/top/dustball/Main.class</span><br><span class="line">out/top/dustball/Dao/User.class</span><br></pre></td></tr></table></figure>

<h4 id="jar-xf"><a href="#jar-xf" class="headerlink" title="jar -xf"></a>jar -xf</h4><p>提取jar包文件,效果等同于解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\javacon&gt; jar -xf challange.jar</span><br><span class="line">PS C:\Users\86135\Desktop\javacon&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\86135\Desktop\javacon</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">d----           2018/11/6    13:34                BOOT-INF</span><br><span class="line">d----           2018/11/6    13:34                META-INF</span><br><span class="line">d----           2018/11/6    13:34                org</span><br><span class="line">-a---           2023/1/26    15:21       18134425 challange.jar</span><br></pre></td></tr></table></figure>





<h3 id="javac命令"><a href="#javac命令" class="headerlink" title="javac命令"></a>javac命令</h3><p>javac java编译器,用于将源代码java文件编译为class字节码文件</p>
<p>javac可以类比为gcc或者g++</p>
<h4 id="javac-d"><a href="#javac-d" class="headerlink" title="javac -d"></a>javac -d</h4><p>指定class文件输出位置,保留包结构</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# tree src -f</span><br><span class="line">src</span><br><span class="line">└── src/top</span><br><span class="line">    └── src/top/dustball</span><br><span class="line">        ├── src/top/dustball/Dao</span><br><span class="line">        │   └── src/top/dustball/Dao/User.java</span><br><span class="line">        └── src/top/dustball/Main.java</span><br><span class="line"></span><br><span class="line">3 directories, 2 files</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# javac src/top/dustball/Dao/*.java src/top/dustball/*.java -d out</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# <span class="built_in">ls</span></span><br><span class="line">bin  lib  out  README.md  src</span><br><span class="line"></span><br><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree]</span><br><span class="line">└─# tree out -f</span><br><span class="line">out</span><br><span class="line">└── out/top</span><br><span class="line">    └── out/top/dustball</span><br><span class="line">        ├── out/top/dustball/Dao</span><br><span class="line">        │   └── out/top/dustball/Dao/User.class</span><br><span class="line">        └── out/top/dustball/Main.class</span><br><span class="line"></span><br><span class="line">3 directories, 2 files</span><br></pre></td></tr></table></figure>





<h4 id="javac-cp"><a href="#javac-cp" class="headerlink" title="javac -cp"></a>javac -cp</h4><p>链接外部依赖</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\empire\Test&gt; javac Test.java -<span class="built_in">cp</span> Main.jar</span><br></pre></td></tr></table></figure>

<h3 id="java命令"><a href="#java命令" class="headerlink" title="java命令"></a>java命令</h3><h4 id="java-jar"><a href="#java-jar" class="headerlink" title="java -jar"></a>java -jar</h4><p>执行自带入口点的jar包</p>
<h4 id="java-cp"><a href="#java-cp" class="headerlink" title="java -cp"></a>java -cp</h4><p>运行时指定jar包入口点</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿Executor)-[/mnt/c/Users/86135/Desktop/empire/empiree/out]</span><br><span class="line">└─# java -<span class="built_in">cp</span> Main.jar top.dustball.Main</span><br><span class="line">[vader,sjh]</span><br></pre></td></tr></table></figure>
























      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/01/04/Class%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/04/Class%E5%AD%97%E8%8A%82%E7%A0%81%E6%96%87%E4%BB%B6/" class="post-title-link" itemprop="url">class字节码文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-04 22:55:00" itemprop="dateCreated datePublished" datetime="2023-01-04T22:55:00+08:00">2023-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-27 17:35:38" itemprop="dateModified" datetime="2023-01-27T17:35:38+08:00">2023-01-27</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Class字节码文件"><a href="#Class字节码文件" class="headerlink" title="Class字节码文件"></a>Class字节码文件</h1><p>javac编译.java源文件之后生成的 class字节码文件</p>
<p>class文件其中都包含了什么?</p>
<p>java是如何编译链接的?</p>
<p>jar包和class的关系?</p>
<p>class文件能否理解为c语言编译生成的可重定位目标模块.o?</p>
<p>每个interface,每个类,都会编译生成一个class文件.即使两个类写到同一个java文件里了,编译后也会生成两个class文件</p>
<p>Point.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dustball;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.Math;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Measurable</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getDistance</span><span class="params">(Point p)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Point</span> <span class="keyword">implements</span> <span class="title class_">Measurable</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">protected</span> <span class="type">double</span> __x;</span><br><span class="line">  <span class="keyword">protected</span> <span class="type">double</span> __y;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">Point</span><span class="params">(<span class="type">double</span> _x, <span class="type">double</span> _y)</span> &#123;</span><br><span class="line">    __x = _x;</span><br><span class="line">    __y = _y;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;(&quot;</span> + Double.toString(__x) + <span class="string">&quot;,&quot;</span> + Double.toString(__y) + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="type">double</span> <span class="title function_">getDistance</span><span class="params">(Point p)</span> &#123;</span><br><span class="line">    <span class="type">double</span> <span class="variable">dist</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    dist = (__x - p.__x) * (__x - p.__x) + (__y - p.__y) * (__y - p.__y);</span><br><span class="line">    <span class="keyword">return</span> Math.sqrt(dist);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    Point A=<span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">2</span>,<span class="number">5</span>);</span><br><span class="line">    System.out.println(A.toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaggedPoint</span> <span class="keyword">extends</span> <span class="title class_">Point</span> &#123;</span><br><span class="line"></span><br><span class="line">  String __t;</span><br><span class="line"></span><br><span class="line">  TaggedPoint(String _t, <span class="type">double</span> _x, <span class="type">double</span> _y) &#123;</span><br><span class="line">    <span class="built_in">super</span>(_x, _y);</span><br><span class="line">    __t = _t;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Line</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Point __A;</span><br><span class="line">  <span class="keyword">public</span> Point __B;</span><br><span class="line"></span><br><span class="line">  Line(Point _A, Point _B) &#123;</span><br><span class="line">    __A = _A;</span><br><span class="line">    __B = _B;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里面有一个接口Measurable,一个Point类及其子类TaggedPoint,一个final类Line</p>
<p>编译后生成了四个文件</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\java\cmd\target\classes\com\dustball&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\86135\Desktop\java\cmd\target\classes\com\dustball</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line">----                 -------------         ------ ----</span><br><span class="line">-a---          2022/12/30    20:02            467 Line.class</span><br><span class="line">-a---          2022/12/30    20:02            191 Measurable.class</span><br><span class="line">-a---          2022/12/30    20:02           1004 Point.class</span><br><span class="line">-a---          2022/12/30    20:02            456 TaggedPoint.class</span><br><span class="line"></span><br><span class="line">PS C:\Users\86135\Desktop\java\cmd\target\classes\com\dustball&gt; 010editor *.class</span><br></pre></td></tr></table></figure>

<p>直接<code>010editor *.class</code>全部打开观察</p>
<h2 id="class文件结构"><a href="#class文件结构" class="headerlink" title="class文件结构"></a>class文件结构</h2><p>整个class文件大体上线性地排列者以下几部分</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230194129578.png" alt="image-20221230194129578"></p>
<h3 id="magic"><a href="#magic" class="headerlink" title="magic"></a>magic</h3><p>文件魔术0xCAFEBABE</p>
<h3 id="minor-version-major-version"><a href="#minor-version-major-version" class="headerlink" title="minor_version&#x2F;major_version"></a>minor_version&#x2F;major_version</h3><p>副&#x2F;主 版本号</p>
<p>描述本class文件可以被java几执行</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230173614375.png" alt="image-20221230173614375"></p>
<p>但是这个52是怎么来的?主版本号何曾到过52?</p>
<p>这是因为java的最初版本号是45,不是从0开始的</p>
<p>52是jdk1.8?然而我也不知道怎么换算的,可以从010editor模板代码中看出这一点</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">ClassFileOnComment</span><span class="params">(ClassFile &amp;obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(obj.major_version)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">45</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;JDK 1.0 or JDK 1.1&quot;</span>; </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">46</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.2&quot;</span>; </span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">47</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.3&quot;</span>; </span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">48</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.4&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">49</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.5&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">50</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.6&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">51</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.7&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">52</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.8&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">53</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK 1.9&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">     <span class="keyword">return</span> <span class="string">&quot;JDK ?.?&quot;</span>;</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="constant-pool-count"><a href="#constant-pool-count" class="headerlink" title="constant_pool_count"></a>constant_pool_count</h3><p>常量池容量计数值,该值决定了紧接着的constant_pool[]数组的元素个数</p>
<h3 id="constant-pool-常量池"><a href="#constant-pool-常量池" class="headerlink" title="constant_pool[]常量池"></a>constant_pool[]常量池</h3><p>可以理解为可重定位目标模块中的符号表.symtab</p>
<p>这个数组的0下标位置是空出来不使用的,从1下标开始使用</p>
<p>0下标可以作为”空引用”,也就是说其他元素引用0号元素意味着引用个寂寞</p>
<p>奇怪的是,这个数组的每个元素可以不一样大</p>
<p>正常c语言的结构体数组,每个元素都是相同大小的结构体,即使有些域用不到也得空着占位</p>
<p>而对于constant_pool:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230175137853.png"></p>
<p>每个元素最开始必然有一个tag成员,表明该元素是何种类型,也就确定了其占地大小,</p>
<p>常量池中主要存放两大类常量:字面量Literal和符号引用Symbolic References</p>
<h3 id="access-flags"><a href="#access-flags" class="headerlink" title="access_flags"></a>access_flags</h3><p>访问标志</p>
<p>两个字节表示的访问标志,用于描述本类的信息,多个属性按位或</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230195212243.png" alt="image-20221230195212243"></p>
<table>
<thead>
<tr>
<th>类型</th>
<th>类名</th>
<th>继承</th>
<th>access_flag</th>
</tr>
</thead>
<tbody><tr>
<td>interface</td>
<td>Measurable</td>
<td>Object</td>
<td>0x0600(抽象|接口)</td>
</tr>
<tr>
<td>public class</td>
<td>Point</td>
<td>Object</td>
<td>0x0021(公共|子类)</td>
</tr>
<tr>
<td>class</td>
<td>TaggedPoint</td>
<td>Point</td>
<td>0x0020(子类)</td>
</tr>
<tr>
<td>final class</td>
<td>Line</td>
<td>Object</td>
<td>0x0030(final|子类)</td>
</tr>
</tbody></table>
<h3 id="索引集合"><a href="#索引集合" class="headerlink" title="索引集合"></a>索引集合</h3><p>紧跟在访问标志之后,是</p>
<p>本类索引,</p>
<p>父类索引,</p>
<p>接口索引集合</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230202234391.png" alt="image-20221230202234391"></p>
<p>只有接口是一个集合,是因为java中只允许单继承,父类只能有一个,但是接口可以实现多个</p>
<p>索引值是一个下标,比如this_class&#x3D;1,意思是去常量池中找1号常量</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230202532520.png" alt="image-20221230202532520"></p>
<p>tag&#x3D;1表示utf8_info,即一个字符串</p>
<p>正好就是本类类名</p>
<p>又如super_class&#x3D;3,意思是去常量池找3号常量</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230202946050.png" alt="image-20221230202946050"></p>
<p>也是一个tag&#x3D;1,utf8字符串,正好是Object类名</p>
<p>this_class和super_class之后是interfaces_count,一个整数表示本类实现了几个接口,有一个算一个都要列在后面的interfaces索引数组中</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230203155953.png" alt="image-20221230203155953"></p>
<p>Point类只实现了一个Measurable接口他的索引号是5</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230203241579.png" alt="image-20221230203241579"></p>
<h3 id="字段表集合"><a href="#字段表集合" class="headerlink" title="字段表集合"></a>字段表集合</h3><p>用于描述接口或者类中声明的变量</p>
<p>首先是一个整数fields_count描述类有几个字段</p>
<p>紧跟着就是对每个字段的描述</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230205132151.png" alt="image-20221230205132151"></p>
<p>这些描述包括:</p>
<p>access_flags,访问标志,包括static,public,final,volatile等等</p>
<p>name_index,符号名自己在常量池中的下标,也就是<code>__x</code>的下标</p>
<p>descriptor_index,类型名在常量池中的下标,也就是double的下标</p>
<p>attributes_count</p>
<h4 id="access-flags-1"><a href="#access-flags-1" class="headerlink" title="access_flags"></a>access_flags</h4><p>每一种属性占用一位,该位为0表示没有这种属性,为1表示有</p>
<p>共有16位,只用到9位</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230205606249.png" alt="image-20221230205606249"></p>
<p>对于<code>double __x;</code>,其属性是0x0004(protected)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230210219778.png" alt="image-20221230210219778"></p>
<h4 id="name-index"><a href="#name-index" class="headerlink" title="name_index"></a>name_index</h4><p>字段的简单名称</p>
<p>“简单名称”意思是没有加上类名前缀,</p>
<p><code>__x</code>的完整名称应该是<code>com/dustball/Point.__x</code></p>
<p>但是当前文件就是在描述Point类,显然没有必要再给其成员存放完整名称了</p>
<h4 id="descriptor-index"><a href="#descriptor-index" class="headerlink" title="descriptor_index"></a>descriptor_index</h4><p>描述符在符号表中的下标</p>
<p>描述符就是double,int等等的类型</p>
<p>只需要一个字符D就可以表明double类型</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230211059690.png" alt="image-20221230211059690"></p>
<h4 id="额外属性"><a href="#额外属性" class="headerlink" title="额外属性"></a>额外属性</h4><p>额外属性可能有多个,因此首先一个attributes_count整数,表明有多少个额外属性</p>
<p>有多少个就在后面列明多少个</p>
<p>这里<code>__x</code>没有额外属性</p>
<h3 id="方法表集合"><a href="#方法表集合" class="headerlink" title="方法表集合"></a>方法表集合</h3><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230211542677.png" alt="image-20221230211542677"></p>
<p>方法表和字段表的结构比较相似</p>
<p>首先还是访问修饰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230211704703.png" alt="image-20221230211704703"></p>
<p>然后是简单名称引用和描述符引用</p>
<p>这两个合起来就正这样</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230212018387.png" alt="image-20221230212018387"></p>
<p><code>&lt;init&gt;(DD)V</code>这里<code>&lt;init&gt;</code>是构造函数名,<code>(DD)</code>表明两个double类型的参数,V表明无返回值</p>
<p><code>main([Ljava/lang/String;)V</code>,这里<code>main</code>是主函数名<code>([Ljava/lang/String;)</code>注意这里中括号没有对齐,只有左中括号表明参数是一个数组类型</p>
<p>然后是attributes_count属性个数和attributes属性表</p>
<p>字段,方法都可以有属性表</p>
<p>方法编译成的opcode就放在其属性表中</p>
<h3 id="属性表"><a href="#属性表" class="headerlink" title="属性表"></a>属性表</h3><h4 id="Code属性"><a href="#Code属性" class="headerlink" title="Code属性"></a>Code属性</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230212736701.png" alt="image-20221230212736701"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230212754406.png" alt="image-20221230212754406"></p>
<h5 id="attribute-name-index-Code"><a href="#attribute-name-index-Code" class="headerlink" title="attribute_name_index&#x3D;Code"></a>attribute_name_index&#x3D;Code</h5><p>表明这是Code属性</p>
<h5 id="attribute-length"><a href="#attribute-length" class="headerlink" title="attribute_length"></a>attribute_length</h5><p>本属性的长度</p>
<h5 id="max-stack"><a href="#max-stack" class="headerlink" title="max_stack"></a>max_stack</h5><p>操作数栈深度最大值</p>
<h5 id="max-locals"><a href="#max-locals" class="headerlink" title="max_locals"></a>max_locals</h5><p>局部变量最大存储空间(单位:槽)</p>
<p>32位及以下数据用一个槽</p>
<p>64位及以上用两个槽</p>
<p>槽可以复用,函数中用完死了的变量给后面的新局部变量腾空</p>
<p>max_stack和max_locals两者共同决定了函数栈帧的大小</p>
<h5 id="code-length"><a href="#code-length" class="headerlink" title="code_length"></a>code_length</h5><p>指令长度</p>
<h5 id="code"><a href="#code" class="headerlink" title="code"></a>code</h5><p>指令码,可以类比作x86机器码</p>
<p>只不过这个指令是给JVM看的,x86机器码是给x86机器看的</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221230213315763.png" alt="image-20221230213315763"></p>
<p>用javap 反编译也可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public com.dustball.Point(double, double);</span><br><span class="line">  descriptor: (DD)V</span><br><span class="line">  flags: (0x0001) ACC_PUBLIC</span><br><span class="line">  Code:</span><br><span class="line">    stack=3, locals=5, args_size=3</span><br><span class="line">       0: aload_0</span><br><span class="line">       1: invokespecial #13                 // Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span><br><span class="line">       4: aload_0</span><br><span class="line">       5: dload_1</span><br><span class="line">       6: putfield      #16                 // Field __x:D</span><br><span class="line">       9: aload_0</span><br><span class="line">      10: dload_3</span><br><span class="line">      11: putfield      #18                 // Field __y:D</span><br><span class="line">      14: return</span><br><span class="line">    LineNumberTable:</span><br><span class="line">      line 14: 0</span><br><span class="line">      line 15: 4</span><br><span class="line">      line 16: 9</span><br><span class="line">      line 17: 14</span><br><span class="line">    LocalVariableTable:</span><br><span class="line">      Start  Length  Slot  Name   Signature</span><br><span class="line">          0      15     0  this   Lcom/dustball/Point;</span><br><span class="line">          0      15     1    _x   D</span><br><span class="line">          0      15     3    _y   D</span><br><span class="line">  MethodParameters:</span><br><span class="line">    Name                           Flags</span><br><span class="line">    _x</span><br><span class="line">    _y</span><br></pre></td></tr></table></figure>

<p>至于java自己造的给虚拟机看的那些指令,现在不想研究</p>
<p>关于jvm多重要多重要,感觉都是大量java码农吹出来的.不如看先看明白CSAPP</p>
<h2 id="java编译链接"><a href="#java编译链接" class="headerlink" title="java编译链接"></a>java编译链接</h2><p>同一包下有两个文件,存在依赖关系</p>
<p>App.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"><span class="keyword">import</span> top.dustball.Point;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> </span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">( String[] args )</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        Point p=<span class="keyword">new</span> <span class="title class_">Point</span>(<span class="number">2</span>,<span class="number">5</span>);</span><br><span class="line">        System.out.println(p.toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Point.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Point</span> &#123;</span><br><span class="line">    <span class="type">double</span> x;</span><br><span class="line">    <span class="type">double</span> y;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Point</span><span class="params">(<span class="type">double</span> x,<span class="type">double</span> y)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.x=x;</span><br><span class="line">        <span class="built_in">this</span>.y=y;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+x+<span class="string">&quot;,&quot;</span>+y+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中App.java中,Main函数引用Point构造函数和toString函数</p>
<p>如果只编译App.java会报告找不到符号出错误</p>
<p>需要同时编译App.java和Point.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac App.java Point.java </span><br></pre></td></tr></table></figure>

<p>在同一目录下生成Point.class和App.class文件</p>
<p>如果要用java执行App.class文件,需要推到包路径下<code>java top/dustball/App</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java\top\dustball&gt; javac App.java Point.java </span><br><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java\top\dustball&gt; java App</span><br><span class="line">错误: 找不到或无法加载主类 App</span><br><span class="line">原因: java.lang.NoClassDefFoundError: top/dustball/App (wrong name: App)</span><br><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java\top\dustball&gt; <span class="built_in">cd</span> ../../</span><br><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java&gt; java top/dustball/App</span><br><span class="line">(2.0,5.0)</span><br></pre></td></tr></table></figure>

<p>这两个class文件都有用,如果把Point.class搬走,只执行App.class会报告链接错误</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java&gt; java top/dustball/App</span><br><span class="line">(2.0,5.0)</span><br><span class="line">PS C:\Users\86135\Desktop\vsJava\empire\src\main\java&gt; java top/dustball/App       </span><br><span class="line">错误: 加载主类 top.dustball.App 时出现 LinkageError</span><br><span class="line">        java.lang.ClassFormatError: Incompatible magic value 1347093252 <span class="keyword">in</span> class file top/dustball/App</span><br></pre></td></tr></table></figure>

<p>这个Point.class的位置在导入类的时候就决定了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> top.dustball;</span><br><span class="line"><span class="keyword">import</span> top.dustball.Point;</span><br></pre></td></tr></table></figure>

<p>也就是说必须得和App同一路径下</p>
<h2 id="jar包"><a href="#jar包" class="headerlink" title="jar包"></a>jar包</h2><p>java archieve</p>
<p>文件魔数是504B0304,和zip压缩包是相同的</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230104214655752.png" alt="image-20230104214655752"></p>
<p>解压缩或者jar -xf 命令均可以拆jar包</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">PS</span> C:\Users\<span class="number">86135</span>\Desktop\jar&gt; jar <span class="literal">-xf</span> junit<span class="literal">-4</span>.<span class="number">13.2</span>.jar</span><br><span class="line"><span class="built_in">PS</span> C:\Users\<span class="number">86135</span>\Desktop\jar&gt; <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line">    Directory: C:\Users\<span class="number">86135</span>\Desktop\jar</span><br><span class="line"></span><br><span class="line">Mode                 LastWriteTime         Length Name</span><br><span class="line"><span class="literal">----</span>                 <span class="literal">-------------</span>         <span class="literal">------</span> <span class="literal">----</span></span><br><span class="line">d<span class="literal">----</span>           <span class="number">2021</span>/<span class="number">2</span>/<span class="number">13</span>    <span class="number">17</span>:<span class="number">31</span>                junit</span><br><span class="line">d<span class="literal">----</span>           <span class="number">2021</span>/<span class="number">2</span>/<span class="number">13</span>    <span class="number">17</span>:<span class="number">31</span>                META<span class="literal">-INF</span></span><br><span class="line">d<span class="literal">----</span>           <span class="number">2021</span>/<span class="number">2</span>/<span class="number">13</span>    <span class="number">17</span>:<span class="number">31</span>                org</span><br><span class="line"><span class="literal">-a---</span>            <span class="number">2023</span>/<span class="number">1</span>/<span class="number">3</span>    <span class="number">21</span>:<span class="number">30</span>         <span class="number">384581</span> junit<span class="literal">-4</span>.<span class="number">13.2</span>.jar</span><br><span class="line"><span class="literal">-a---</span>           <span class="number">2021</span>/<span class="number">2</span>/<span class="number">13</span>    <span class="number">17</span>:<span class="number">31</span>          <span class="number">11376</span> LICENSE<span class="literal">-junit</span>.txt</span><br></pre></td></tr></table></figure>

<p>解出来&#x2F;org&#x2F;junit和&#x2F;junit两个目录下面都是class文件</p>
<p>因此实际上jar包可以理解为静态库,里面的class文件可以理解为可重定位目标模块</p>
<p>麻了麻了怎么用jar包,jar包如何自己运行,用到时候再看吧,全是答辩</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/01/04/%E6%95%B0%E4%BD%8DDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/04/%E6%95%B0%E4%BD%8DDP/" class="post-title-link" itemprop="url">动态规划-数位DP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-04 21:30:00 / Modified: 21:24:01" itemprop="dateCreated datePublished" datetime="2023-01-04T21:30:00+08:00">2023-01-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="数位DP"><a href="#数位DP" class="headerlink" title="数位DP"></a>数位DP</h1><h2 id="P2602-数字计数"><a href="#P2602-数字计数" class="headerlink" title="P2602 数字计数"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2602">P2602 数字计数</a></h2><p>给定正整数a,b,求$[a,b]$所有的整数中,0到9每个数码各自总共出现多少次</p>
<p>由前缀和的思想,设$sum[n]$表示$[0,n]$中0到9各个数码各自出现了多少次</p>
<p>那么$sum[b]-sum[a-1]$就是所求值</p>
<p>问题转化为如何求$sum[n]$即$[0,n]$中0到9各个数码各自出现了多少次</p>
<p>设计状态$dp[i]$表示”当范围涵盖了完整的i位时,前i位中每个数字出现的次数.”</p>
<blockquote>
<p>啥意思呢?</p>
<p>比如对于$[1000,1999]$显然能够找出i&#x3D;1的完整区间,比如$[1000,1009]$等等</p>
<p>显然也能够找出i&#x3D;2的完整区间,比如$[1900,1999]$等等</p>
<p>显然也能够找出i&#x3D;3的完整区间,比如$[1000,1999]$,只有这一个</p>
<p>找不出i&#x3D;4的完整区间了</p>
<p>如果对于[10,2000000],这就可以找到i&#x3D;4的完整区间,也就是**低四位能够遍历[0,9999]**这个范围的区间,比如</p>
<p>$[10000,19999]$</p>
</blockquote>
<blockquote>
<p>这样设计dp有一个隐患就是,忽略了前导0的区别.比如给定区间[0,999],显然最大可以找到i&#x3D;3的区间[0,999]</p>
<p>但是正常情况下,0不能作为前导,也就是说不能有012或001或000或020这种数字,可以有210或100这种数字</p>
<p>最后再考虑去除前导零的情况,现在先不考虑</p>
</blockquote>
<p>状态转移方程为:<br>$$<br>dp[i]&#x3D;10\times dp[i-1]+10^{i-1}<br>$$<br>如何考虑这个方程呢?排列组合问题</p>
<p>第i位假设放了一个X(先不管到底放了啥),考虑他对低i-1位的影响,</p>
<p>X有0,1,2,…,9十种可能,于是之前计算得到的dp[i-1]就得乘以10,</p>
<p>也就是说,1在低i-1上出现过$10\times dp[i-1]$次</p>
<p>okk,现在看低i-1位给第i位造成的影响,第i位假如放一个1,低i-1位随便放有$10^{i-1}$种放法</p>
<p>因此1就在第i位上出现过$10^{i-1}$次</p>
<blockquote>
<p>举个实际例子,以[0,999]为例,前导零的情况也计算在内</p>
<p>$dp[1]&#x3D;1$,边界条件,意思是区间为[0,9]的时候,一个数字显然只出现一次</p>
<p>$dp[2]&#x3D;10\times dp[1]+10^{1}&#x3D;20$</p>
<p>假设个位上放一个X,十位有十种可能,0X,1X,2X,3X,…,9X,也就是说,十位对个位计数的贡献就是$10\times dp[1]$</p>
<p>假设十位上放一个X,个位有十种可能,X0,X1,X2,X3,…,X9.也就是说,个位对十位计数的贡献就是$10^{1}$</p>
<blockquote>
<p>笑死,只有两位,要不你影响我,要不我影响你,怎么贡献方式还不一样?</p>
<p>再多一位就可以体现了</p>
</blockquote>
<p>$dp[3]&#x3D;10\times dp[2]+10^{2}&#x3D;300$</p>
<p>这时候发现貌似不容易计算百位对于前两位的贡献了,如何解释$10\times dp[2]$怎么来的呢?</p>
<p>可以这样想:</p>
<p>原来在计算$dp[2]$时,这样只有一个[0,99]区间,而考虑了百位之后,就有</p>
<p>$[0,99],[100,199],[200,299],…,[900,999]$这10个区间了,每个区间内数字的出现个数都是$dp[2]$现在有十个相同区间,因此当有三位的时候,从前两位计算得到的数字出现个数就是$10\times dp[2]$</p>
<p>假设百位上放一个X,前两位稍微一动就是一个新数,X就得多记录一次</p>
<p>比如X23,X24,X25,这样百位上的X就记了3次.那么前两位一共有多少种可能的排列呢?$10^2$那么X在第三位上出现的次数就是$10^2$</p>
</blockquote>
<p>然后考虑如何去除前导0</p>
<p>去除前导零,也就是给0的计数中去掉0出现在最高位的情况</p>
<p>去除前导0,<strong>只会对0的计数有影响,对其他数字没有影响</strong>,因为</p>
<p>012345去除前导0不是说把012345给去掉,而是保留12345,12345这五个数字各自统计一次,0此时不应计数</p>
<p>要去除i&#x3D;6上的前导零计数,也就是去除</p>
<p>0XXXXX这种情况对0计数的贡献,显然有$10^5$种</p>
<p>去除i&#x3D;5上的前导零计数,也就是去除</p>
<p>0XXXX这种情况对0计数的贡献,显然有$10^4$种</p>
<p>也就是去除第i位上的前导0影响,就是去除$10^{i-1}$次0的计数</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">15</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> dp[maxn];</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> pow_10[maxn];</span><br><span class="line"></span><br><span class="line"><span class="function">vector&lt;<span class="type">long</span> <span class="type">long</span>&gt; <span class="title">solve</span><span class="params">(<span class="type">long</span> <span class="type">long</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> temp=n;</span><br><span class="line">    <span class="type">int</span> length=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> top[maxn];</span><br><span class="line">    <span class="function">vector&lt;<span class="type">long</span> <span class="type">long</span>&gt; <span class="title">result</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">    <span class="keyword">while</span>(n)&#123;</span><br><span class="line">        top[++length]=n%<span class="number">10</span>;</span><br><span class="line">        n/=<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=length;i&gt;=<span class="number">1</span>;--i)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;++j)&#123;</span><br><span class="line">            result[j]+=dp[i<span class="number">-1</span>]*top[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;top[i];++j)&#123;</span><br><span class="line">            result[j]+=pow_10[i<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        temp-=pow_10[i<span class="number">-1</span>]*top[i];</span><br><span class="line">        result[top[i]]+=temp<span class="number">+1</span>;</span><br><span class="line">        result[<span class="number">0</span>]-=pow_10[i<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> l,r;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;l&gt;&gt;r;</span><br><span class="line">    pow_10[<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;maxn;++i)&#123;</span><br><span class="line">        dp[i]=dp[i<span class="number">-1</span>]*<span class="number">10</span>+pow_10[i<span class="number">-1</span>];</span><br><span class="line">        pow_10[i]=<span class="number">10</span>*pow_10[i<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    vector&lt;<span class="type">long</span> <span class="type">long</span>&gt;left=<span class="built_in">solve</span>(l<span class="number">-1</span>);</span><br><span class="line">    vector&lt;<span class="type">long</span> <span class="type">long</span>&gt;right=<span class="built_in">solve</span>(r);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=<span class="number">9</span>;++i)&#123;</span><br><span class="line">        cout&lt;&lt;right[i]-left[i]&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中比较抽象的是后面这个循环,他里面都干了什么呢?</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;++j)result[j]+=dp[i<span class="number">-1</span>]*top[i];</span><br></pre></td></tr></table></figure>

<p>计算当前位i随便安排时,对前i位中,数位统计的贡献</p>
<p>使用$top[i]$因为第i位上只有$[0,top[i]-1]$共$top[i]$种情况</p>
<blockquote>
<p>为什么不是$[0,top[i]]$共$top[i]+1$种情况?假如对于$[0,6524]$</p>
<p>当前i&#x3D;4,top[4]&#x3D;6,可以找到区间[0,999],[1000,1999]</p>
<p>[2000,2999],[3000,3999],[4000,4999],[5000,5999]</p>
<p>共6个&#x3D;top[4]</p>
<p>没有包括[6000,6999],因为最大到6524,即top[i]作为最高位时前i位找不出完整的区间来</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">auto</span> j=<span class="number">0</span>;j&lt;top[i];++j)result[j]+=<span class="built_in">pow</span>(<span class="number">10</span>,i<span class="number">-1</span>); </span><br></pre></td></tr></table></figure>

<p>计算前i位随便安排时,对第i位数位统计的贡献</p>
<p>由于最高位上只可能出现$[0,top[i]-1]$,再高top[i]没有完全区间,再高$top[i]+1$不可能出现,因此不能统计对$[top[i],9]$这些数字的贡献</p>
<blockquote>
<p>比如当n&#x3D;6524</p>
<p>i&#x3D;6,也就是说存在1XXX,2XXX,3XXX,4XXX,5XXX这些完整区间(XXX表示[0,999])</p>
<p>6XXX没有完全区间,只有[6000,6524]</p>
<p>更不存在7XXX了</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">       </span><br><span class="line">temp-=<span class="built_in">pow</span>(<span class="number">10</span>,i<span class="number">-1</span>)*top[i];<span class="comment">//去掉最高位</span></span><br><span class="line">result[top[i]]+=temp<span class="number">+1</span>;<span class="comment">//之前统计贡献时,i位的最高数字总是不满区间,现在单独处理</span></span><br></pre></td></tr></table></figure>

<p>啥意思呢?还是n&#x3D;6524举例子</p>
<p>temp&#x3D;n&#x3D;6524</p>
<p>然后temp&#x3D;6524-6000&#x3D;524</p>
<p>这524就是对top[4]&#x3D;6统计次数的贡献,也就是6在i&#x3D;4位上出现了524+1&#x3D;525次</p>
<p>加一的原因是,524表示[0,524]共525种情况</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">result[<span class="number">0</span>]-=<span class="built_in">pow</span>(<span class="number">10</span>,i<span class="number">-1</span>);<span class="comment">//去除前导零</span></span><br></pre></td></tr></table></figure>

<p>前导零有多种情况,比如0524,0024,0004,0000</p>
<p>这里每次只会处理一种情况,i&#x3D;4时只会消除0999,0998,…,0000这种前导0.</p>
<h2 id="P8764-二进位问题"><a href="#P8764-二进位问题" class="headerlink" title="P8764 二进位问题"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P8764">P8764 二进位问题</a></h2><p>$[1,n]$这些整数中,二进制表示有k个1的有多少个</p>
<p>如果问题变成:m个二进制位,其中有k个1的有多少个数</p>
<p>显然是$C_m^k$</p>
<p>假设n表示成二进制形式之后,最高位是$bit[len]&#x3D;1$,最低位是$bit[1]$</p>
<p>显然前$len-1$位所有状态都包含在内了,因此首先有$C_{len-1}^k$,也就是最高位位0时,低$len-1$位任意安排</p>
<p>下面考虑最高位为1的情况,</p>
<p>从次高位$bit[len-1]$往低位bit[1]方向看</p>
<p>如果$bit[i]$为0则跳过,否则加上$C_{i-1}^{k-t}$</p>
<p>其中t表示$[i+1,len]$这些位上的1个数</p>
<p>比如$n&#x3D;101000,len&#x3D;6$</p>
<table>
<thead>
<tr>
<th>i</th>
<th>bit[i]</th>
<th>操作</th>
</tr>
</thead>
<tbody><tr>
<td>5</td>
<td>0</td>
<td>跳过</td>
</tr>
<tr>
<td>4</td>
<td>1</td>
<td>$+C_{4-1}^{k-1}$</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>为啥加上这个数呢?第4位上有一个1,这表明存在</p>
<p>$[100000b,100111b]$,低三位存在完整区间,从这个完整区间中统计有$k-1$个1的数,是因为之前已经有一个1了,需要在剩下的位中找出k-1个1即可</p>
<p>现在的主要问题是如何快速求解$C_m^k$</p>
<p>$C_m^0&#x3D;1$</p>
<p>$C_m^k&#x3D;C_{m-1}^{k-1}+C_{m-1}^k$</p>
<p>用$c[m][k]$数组预处理即可</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="comment">//c[m][k]</span></span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxm=<span class="number">100</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxk=<span class="number">100</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> c[maxm][maxk];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// c[1][0]=c[1][1]=1;</span></span><br><span class="line">    c[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;maxm;i++)&#123;</span><br><span class="line">        c[i][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;i;++j)&#123;</span><br><span class="line">            c[i][j]=c[i<span class="number">-1</span>][j<span class="number">-1</span>]+c[i<span class="number">-1</span>][j];</span><br><span class="line">        &#125;</span><br><span class="line">        c[i][i]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;<span class="number">20</span>;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=i;j++)&#123;</span><br><span class="line">            cout&lt;&lt;c[i][j]&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cout&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> n;</span><br><span class="line"><span class="type">int</span> k;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> bit[maxm];</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> len;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;k;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> temp=n;</span><br><span class="line">    <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">        bit[++len]=temp&amp;<span class="number">1</span>;</span><br><span class="line">        temp&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> result=<span class="number">0</span>;</span><br><span class="line">    result+=c[len<span class="number">-1</span>][k];</span><br><span class="line">    <span class="type">int</span> t=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=len<span class="number">-1</span>;i&gt;=<span class="number">1</span>;--i)&#123;</span><br><span class="line">        <span class="keyword">if</span>(bit[i]==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(k-t&lt;<span class="number">0</span>)<span class="keyword">break</span>;</span><br><span class="line">        result+=c[i<span class="number">-1</span>][k-t];</span><br><span class="line">        ++t;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;result&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h2 id="P2657-windy数"><a href="#P2657-windy数" class="headerlink" title="P2657 windy数"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2657">P2657 windy数</a></h2><p>定义windy数:相邻两个十进制位必须至少差2,比如135,2597等等</p>
<p>给定区间[l,r]求这之间的windy数有多少</p>
<p>问题转化为[1,n]中的windy数有多少</p>
<p>设计状态:<br>$$<br>dp[i][j]表示i个10进制位,最高位第i位上是j的windy数的个数<br>$$<br>边界条件显然是只有一位的时候,$dp[1][j]&#x3D;1$</p>
<p>转移方程:<br>$$<br>dp[i][j]&#x3D;\sum_{|k-j|\ge2}dp[i-1][k]<br>$$</p>
<p>下面考虑[1,n]中有多少windy数</p>
<p>首先划分成十进位</p>
<p>dec[len],dec[len-1],…,dec[1],最高位是dec[len]</p>
<p>那么显然有低len-1位的完整区间,全算上</p>
<p>第len位上,从1到dec[len]-1这些<code>dp[len][i]</code>也是都有的</p>
<p>只剩下len位上放dec[len]的情况了,这是最贴近上边界的情况,如何考虑?</p>
<p>i从len-1往1遍历</p>
<p>对于当前位i,尝试放置$0\le j&lt;dec[i]$,因为第i位最高可以为dec[i],比他小的数都存在</p>
<p>然后判断j是否合法,依据就是j和dec[i+1]距离是否大于等于2,</p>
<p>如果是,则加上$dp[i][j]$</p>
<p>这样第i位就统计完毕,尝试往更低位统计,第i位最终放置的是dec[i]</p>
<p>如果dec[i+1]和dec[i]相差小于2,就不能继续往低位统计了</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cmath&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">20</span>;</span><br><span class="line"><span class="type">long</span> <span class="type">long</span> dp[maxn][<span class="number">10</span>];</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;++j)&#123;</span><br><span class="line">        dp[<span class="number">1</span>][j]=<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;maxn;i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;<span class="number">10</span>;++j)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;<span class="number">10</span>;k++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">abs</span>(j-k)&gt;=<span class="number">2</span>)&#123;</span><br><span class="line">                    dp[i][j]+=dp[i<span class="number">-1</span>][k];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">long</span> <span class="type">long</span> <span class="title">solve</span><span class="params">(<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(n==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> result=<span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> temp=n;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> dec[maxn];</span><br><span class="line">    <span class="built_in">memset</span>(dec,<span class="number">0</span>,<span class="built_in">sizeof</span>(dec));</span><br><span class="line">    <span class="type">int</span> len=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(temp)&#123;</span><br><span class="line">        dec[++len]=temp%<span class="number">10</span>;</span><br><span class="line">        temp/=<span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cout&lt;&lt;&quot;actived&quot;&lt;&lt;endl;</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=len<span class="number">-1</span>;++i)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=<span class="number">9</span>;++j)&#123;</span><br><span class="line">            result+=dp[i][j];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;dec[len];++j)&#123;</span><br><span class="line">        result+=dp[len][j];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=len<span class="number">-1</span>;i&gt;=<span class="number">1</span>;--i)&#123;</span><br><span class="line">        <span class="comment">// cout&lt;&lt;&quot;in loop&quot;&lt;&lt;endl;</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>;j&lt;=dec[i]<span class="number">-1</span>;++j)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">abs</span>(j-dec[i<span class="number">+1</span>])&gt;=<span class="number">2</span>)&#123;</span><br><span class="line">                result+=dp[i][j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">abs</span>(dec[i]-dec[i<span class="number">+1</span>])&lt;<span class="number">2</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> l,r;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;l&gt;&gt;r;</span><br><span class="line">    <span class="built_in">init</span>();</span><br><span class="line">    <span class="comment">// cout&lt;&lt;solve(r+1)&lt;&lt;endl&lt;&lt;solve(l)&lt;&lt;endl;</span></span><br><span class="line">    cout&lt;&lt;<span class="built_in">solve</span>(r)-<span class="built_in">solve</span>(l<span class="number">-1</span>)&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="P4999-烦人的数学作业"><a href="#P4999-烦人的数学作业" class="headerlink" title="P4999 烦人的数学作业"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4999">P4999 烦人的数学作业</a></h2><p>给定区间[l,r],求每个数各个十进制位的数字和</p>
<p>比如[123,125],就有1+2+3+1+2+4+1+2+5</p>
<p>首先问题转化为[1,n]区间上拆分数字和<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1836">P1836 数页码</a></p>
<p>然后问题还可以转化为P2602求每个数字出现的次数</p>
<p>最终累计i×i的出现次数即可</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/01/04/MVC%E6%A1%86%E6%9E%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/04/MVC%E6%A1%86%E6%9E%B6/" class="post-title-link" itemprop="url">后端MVC框架</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-01-04 21:11:00" itemprop="dateCreated datePublished" datetime="2023-01-04T21:11:00+08:00">2023-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-09-14 00:02:57" itemprop="dateModified" datetime="2024-09-14T00:02:57+08:00">2024-09-14</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="后端MVC框架"><a href="#后端MVC框架" class="headerlink" title="后端MVC框架"></a>后端MVC框架</h1><p>参考<a target="_blank" rel="noopener" href="https://gitee.com/subside_hh/SMBMS">SMBMS: 跟着狂神做超市订单管理系统 (gitee.com)</a></p>
<h2 id="MVC框架的使用时机"><a href="#MVC框架的使用时机" class="headerlink" title="MVC框架的使用时机"></a>MVC框架的使用时机</h2><p>当需求分析结束后,数据库也已经建立完毕了.建立了四张数据表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> use smbms;</span><br><span class="line">Database changed</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">show</span> tables;</span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> Tables_in_smbms <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="operator">|</span> smbms_bill      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> smbms_provider  <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> smbms_role      <span class="operator">|</span></span><br><span class="line"><span class="operator">|</span> smbms_user      <span class="operator">|</span></span><br><span class="line"><span class="operator">+</span><span class="comment">-----------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>



<p>下面的任务就是写后端逻辑代码了,此时使用MVC框架建立项目</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/project1.png" alt="project1"></p>
<h2 id="MVC框架是什么"><a href="#MVC框架是什么" class="headerlink" title="MVC框架是什么"></a>MVC框架是什么</h2><p>整个后端在MVC框架中分了三层,DAO,Service,Controller</p>
<p>**DAO层:**data access object,数据访问层.每一个DAO类一定对应一个数据表,DAO类的函数,只做原子操作,CRUD</p>
<p>一个函数只实现一个功能,比如给定一个账单号,查库删除该账单</p>
<p>或者给定一个用户名和新密码,修改其密码.</p>
<p>可以理解为,DAO类的函数,一般只执行一条sql语句,一般只影响一行</p>
<p>**Service层:**服务层.对Dao层的包装,一个Service层函数可能调用一个或者多个Dao层函数.返回pojo对象.</p>
<p>比如service上一个login(userCode,userPassword),首先会用userCode去查smbms_user表,然后用获取到的表项实例化一个user pojo,然后user.getPassword和userPassword进行对比,相同则返回user对象,否则返回null指针</p>
<p>**Controller层:**控制层,由Servlet实现,直接接收来自前端的get或者post请求,提取参数,决定使用哪种服务</p>
<table>
<thead>
<tr>
<th>层</th>
<th>输入</th>
<th>输出</th>
<th>任务</th>
</tr>
</thead>
<tbody><tr>
<td>Controller</td>
<td>request with parameters</td>
<td>respond</td>
<td>提取参数,决定服务</td>
</tr>
<tr>
<td>Service</td>
<td>raw parameters</td>
<td>pojo or else</td>
<td>执行事务,组合业务</td>
</tr>
<tr>
<td>DAO</td>
<td>connection,raw parameters</td>
<td>pojo or else</td>
<td>执行原子操作,CRUD</td>
</tr>
</tbody></table>
<p>画个图表示一下</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230104191129638.png" alt="image-20230104191129638"></p>
<h2 id="MVC框架如何作用"><a href="#MVC框架如何作用" class="headerlink" title="MVC框架如何作用"></a>MVC框架如何作用</h2><p>以登录逻辑为例,分析从前端请求到获得响应的整个过程</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230104184242886.png" alt="image-20230104184242886"></p>
<h3 id="1-前端发起HTTP请求"><a href="#1-前端发起HTTP请求" class="headerlink" title="1.前端发起HTTP请求"></a>1.前端发起HTTP请求</h3><p>请求服务端你的login.do资源,携带两个get参数</p>
<p>目标DNS:localhost,会被本地hosts文件映射到IP:127.0.0.1</p>
<p>目标端口:8080</p>
<h3 id="2-该请求到达了服务端"><a href="#2-该请求到达了服务端" class="headerlink" title="2.该请求到达了服务端"></a>2.该请求到达了服务端</h3><p>经过TCP&#x2F;IP协议栈,将HTTP报文交给位于应用层的web服务器(tomcat)</p>
<h3 id="3-服务器首先查询web-xml"><a href="#3-服务器首先查询web-xml" class="headerlink" title="3.服务器首先查询web.xml"></a>3.服务器首先查询web.xml</h3><p>找到login.do这路径应该映射给控制层的LoginServlet</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.threepure.servlet.user.LoginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/login.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>至于tomcat具体怎么将HTTP请求报文交给LoginServlet的,目前不清楚,留作后话</p>
<p>可能手写一个玩具tomcat服务器就知道了,但不是现在</p>
</blockquote>
<p>于是将该get请求交给<code>LoginServlet.doGet(req,resp)</code></p>
<h3 id="4-调用控制层LoginServlet-doGet函数"><a href="#4-调用控制层LoginServlet-doGet函数" class="headerlink" title="4.调用控制层LoginServlet.doGet函数"></a>4.调用控制层LoginServlet.doGet函数</h3><p>首先提取参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">userCode</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;userCode&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">userPassword</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;userPassword&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>然后调用服务层,查询用户名密码是否正确</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UserServiceImpl</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userService.login(userCode, userPassword);</span><br></pre></td></tr></table></figure>

<p>这里user是一个pojo类型,其属性和user数据表的属性一一对应,一个user对象对应一条user表的记录</p>
<p>然后根据user是否为空,决定是否登陆成功</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user!=<span class="literal">null</span>)&#123;<span class="comment">//user非空说明存在该用户且用户名密码正确</span></span><br><span class="line">    req.getSession().setAttribute(Constants.USER_SESSION, user);<span class="comment">//设置session</span></span><br><span class="line">    resp.sendRedirect(<span class="string">&quot;jsp/frame.jsp&quot;</span>);<span class="comment">//跳转登录之后的界面</span></span><br><span class="line">&#125;<span class="keyword">else</span> &#123;<span class="comment">//要么不存在用户名,要么密码错误,反正登不上</span></span><br><span class="line">    req.setAttribute(<span class="string">&quot;error&quot;</span>, <span class="string">&quot;用户名或者密码错误&quot;</span>);</span><br><span class="line">    req.getRequestDispatcher(<span class="string">&quot;login.jsp&quot;</span>).forward(req, resp);<span class="comment">//重新登录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果有两个,</p>
<p>一个是设置session,保存用户登录状态,也就是设置了访问权限,此后过滤器会根据是否有session决定能否访问网站资源</p>
<p>一个是返回resp,设置页面重定向.实际上是返回了重定向的HTTP respond报文</p>
<h3 id="5-调用服务层userService-login-userCode-userPassword-函数"><a href="#5-调用服务层userService-login-userCode-userPassword-函数" class="headerlink" title="5.调用服务层userService.login(userCode, userPassword)函数"></a>5.调用服务层<code>userService.login(userCode, userPassword)</code>函数</h3><p>首先提升作用域,建立两个局部变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>connection的建立和销毁都由本login函数决定,也就是资源的创建和销毁是Service服务层决定的</p>
<p>然后调用Dao层函数,根据<code>userDao.getLoginUser(connection, userCode)</code>查询是否存在用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    connection = DruidDao.getConnection();</span><br><span class="line">    user = userDao.getLoginUser(connection, userCode);</span><br><span class="line">&#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">    throwables.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    DruidDao.closeResource(<span class="literal">null</span>, <span class="literal">null</span>, connection);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>查完了立刻在finally中释放资源</p>
<p>如果存在该用户,Dao层会返回一个user pojo,和数据库中该用户的记录对应.</p>
<p>然后要判断用户密码是否正确,如果正确返回该pojo,控制层会使用该pojo执行其他业务.</p>
<p>如果密码错误或者user不存在,均会返回null,控制层发现该返回值为null就知道了用户名密码错误</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!user.getUserPassword().equals(password)) &#123;</span><br><span class="line">        user = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> user;</span><br></pre></td></tr></table></figure>



<h3 id="6-调用DAO层userDao-getLoginUser-connection-userCode-函数"><a href="#6-调用DAO层userDao-getLoginUser-connection-userCode-函数" class="headerlink" title="6.调用DAO层userDao.getLoginUser(connection, userCode)函数"></a>6.调用DAO层<code>userDao.getLoginUser(connection, userCode)</code>函数</h3><p>首先提升作用域,创建局部变量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">PreparedStatement</span> <span class="variable">pstm</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>然后调用DAO公共底层DruidDao.execute函数,查库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">       <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">           <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from smbms_user where userCode=?&quot;</span>;</span><br><span class="line">           Object[] params = &#123;userCode&#125;;</span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               rs = DruidDao.execute(connection, pstm, rs, sql, params);<span class="comment">//rs可能有多条</span></span><br><span class="line">               <span class="keyword">if</span> (rs.next()) &#123;<span class="comment">//最终user是rs的最后一条记录</span></span><br><span class="line">                   user = <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">                   user.setId(rs.getInt(<span class="string">&quot;id&quot;</span>));<span class="comment">//使用rs记录实例化一个pojo</span></span><br><span class="line">                   user.setUserCode(rs.getString(<span class="string">&quot;userCode&quot;</span>));</span><br><span class="line">                   user.setUserName(rs.getString(<span class="string">&quot;userName&quot;</span>));</span><br><span class="line">                   user.setUserPassword(rs.getString(<span class="string">&quot;userPassword&quot;</span>));</span><br><span class="line">                   user.setGender(rs.getInt(<span class="string">&quot;gender&quot;</span>));</span><br><span class="line">                   user.setBirthday(rs.getDate(<span class="string">&quot;birthday&quot;</span>));</span><br><span class="line">                   user.setPhone(rs.getString(<span class="string">&quot;phone&quot;</span>));</span><br><span class="line">                   user.setAddress(rs.getString(<span class="string">&quot;address&quot;</span>));</span><br><span class="line">                   user.setUserRole(rs.getInt(<span class="string">&quot;userRole&quot;</span>));</span><br><span class="line">                   user.setCreatedBy(rs.getInt(<span class="string">&quot;createdBy&quot;</span>));</span><br><span class="line">                   user.setCreationDate(rs.getTimestamp(<span class="string">&quot;creationDate&quot;</span>));</span><br><span class="line">                   user.setModifyBy(rs.getInt(<span class="string">&quot;modifyBy&quot;</span>));</span><br><span class="line">                   user.setModifyDate(rs.getTimestamp(<span class="string">&quot;modifyDate&quot;</span>));</span><br><span class="line">               &#125;</span><br><span class="line">               DruidDao.closeResource(rs, pstm, connection);<span class="comment">//释放资源</span></span><br><span class="line">           &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">               throwables.printStackTrace();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"><span class="keyword">return</span> user;</span><br></pre></td></tr></table></figure>



<h3 id="7-调用DAO层公共函数Druid-execute"><a href="#7-调用DAO层公共函数Druid-execute" class="headerlink" title="7.调用DAO层公共函数Druid.execute"></a>7.调用DAO层公共函数Druid.execute</h3><p>CRUD根据读写性质分成两种,只读的查,和读写的增删改</p>
<p>并且只有查询要返回记录,其他的操作只需要返回几行受到影响即可</p>
<p>因此execute有两个重载,一个负责只读的查,一个负责读写的增删改</p>
<p>这里使用sql预编译,目的是提高速度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:编写查询公共方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ResultSet <span class="title function_">execute</span><span class="params">(Connection connection, PreparedStatement preparedStatement, ResultSet resultSet, String sql, Object[] params)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">        <span class="comment">//setObject()占位符是从1开始，而数组是从0开始；</span></span><br><span class="line">        preparedStatement.setObject(i + <span class="number">1</span>, params[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;DruidDao&gt;&gt;查&gt;&gt;SQL :&quot;</span> + preparedStatement.toString());</span><br><span class="line">    resultSet = preparedStatement.executeQuery();</span><br><span class="line">    <span class="keyword">return</span> resultSet;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>:编写增删改公共方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">execute</span><span class="params">(Connection connection, PreparedStatement preparedStatement, String sql, Object[] params)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    preparedStatement = connection.prepareStatement(sql);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; params.length; i++) &#123;</span><br><span class="line">        <span class="comment">//setObject()占位符是从1开始，而数组是从0开始；</span></span><br><span class="line">        preparedStatement.setObject(i + <span class="number">1</span>, params[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;DruidDao&gt;&gt;增删改&gt;&gt;SQL :&quot;</span> + preparedStatement.toString());</span><br><span class="line">    <span class="keyword">return</span> preparedStatement.executeUpdate();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="MVC框架的建立过程"><a href="#MVC框架的建立过程" class="headerlink" title="MVC框架的建立过程"></a>MVC框架的建立过程</h2><p>参考<a target="_blank" rel="noopener" href="https://gitee.com/subside_hh/SMBMS">SMBMS: 跟着狂神做超市订单管理系统 (gitee.com)</a></p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>0.搭建服务器环境,使用tomcat服务器部署javaweb项目</p>
<p>1.建立pojo目录,在该目录下,给每个数据表建立一个一一对一个的pojo类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">smbms/src/main/java/top/dustball/pojo/</span><br><span class="line">	User.java</span><br><span class="line">	Provider.java</span><br><span class="line">	Bill.java</span><br><span class="line">	Role.java</span><br></pre></td></tr></table></figure>

<p>2.建立Dao层公共底层类,实现execute函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbms/src/main/java/top/dustball/dao/</span><br><span class="line">	DaoBase.java</span><br></pre></td></tr></table></figure>

<p>3.引入资源,包括前端的jsp页面,js,css文件.数据库连接设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smbms/src/main/java/resources/</span><br><span class="line">	db.properties</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">smbms/src/main/webapp/</span><br><span class="line">	jsp/</span><br><span class="line">		...</span><br><span class="line">	js/</span><br><span class="line">		...</span><br><span class="line">	css/</span><br><span class="line">		...</span><br><span class="line">	images/</span><br><span class="line">		...</span><br><span class="line">	login.jsp</span><br><span class="line">	error.jsp</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>

<p>其中smbms&#x2F;src&#x2F;main&#x2F;webapp&#x2F;这下面的jsp,js,css,images等都是前端的工作.</p>
<p>前端和后端的接口是jsp和web.xml共同决定的,请求路径以及get或者post的参数名称</p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">login.jsp</span><br><span class="line">&lt;form class=<span class="string">&quot;loginForm&quot;</span> action=<span class="string">&quot;$&#123;pageContext.request.contextPath &#125;/login.do&quot;</span>  name=<span class="string">&quot;actionForm&quot;</span> id=<span class="string">&quot;actionForm&quot;</span>  method=<span class="string">&quot;post&quot;</span> &gt;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">web.xml</span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.threepure.servlet.user.LoginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/login.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>至于前端的页面长什么样,后端不用管,后端只关心控制层接收到的get参数叫什么,是叫”username”,还是”UserName”还是”userCode”.</p>
<p>前端需要知道一个get请求应该发往哪一个Servlet</p>
<p>只有这两个是前后端开发者需要协商的</p>
<p>4.建立字符过滤器,设置前后端都使用utf-8编码</p>
<h3 id="自顶向下还是自底向上"><a href="#自顶向下还是自底向上" class="headerlink" title="自顶向下还是自底向上"></a>自顶向下还是自底向上</h3><p>目前感觉两种方法均可</p>
<p>两头都很具体,顶上是前端写好的请求,参数名都已知,交给哪一个Servlet也是确定的</p>
<p>底下有几个数据表,都长什么样也是确定的</p>
<p>中间的service层很多情况下只是对Dao层的一个薄封装,以service层的UserServiceImpl.login函数为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> User <span class="title function_">login</span><span class="params">(String userCode, String password)</span> &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = DruidDao.getConnection();</span><br><span class="line">        user = userDao.getLoginUser(connection, userCode);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">        throwables.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        DruidDao.closeResource(<span class="literal">null</span>, <span class="literal">null</span>, connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//进行密码匹配</span></span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!user.getUserPassword().equals(password)) &#123;</span><br><span class="line">            user = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上这么一长段的核心功能就是</p>
<p>接收一个userCode一个password,返回一个user pojo.就是多加了一个密码判断</p>
<p>UserServiceImpl.updataPwd更明显,直接调用了Dao层,除此之外啥也没干</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">updatePwd</span><span class="params">(<span class="type">int</span> id, String pwd)</span> &#123;</span><br><span class="line">    <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">flag</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connection = DruidDao.getConnection();</span><br><span class="line">        <span class="keyword">if</span> (userDao.updatePwd(connection, id, pwd) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException throwables) &#123;</span><br><span class="line">        throwables.printStackTrace();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        DruidDao.closeResource(<span class="literal">null</span>, <span class="literal">null</span>, connection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>还是采用自顶向下吧,根据前端存在的需求,决定后端写哪些服务</p>
<p>比如对于用户表,不存在修改用户名的需求,因为有新建用户就够了.</p>
<p>如果自底向上写的话,不知道需要对用户表的哪些字段进行什么操作.</p>
<p>如果自顶向下写的话,首先知道的就是需求,然后根据需求决定下层要提供什么服务,然后再实现该服务,不需要的服务不写</p>
<h3 id="建立Controller层"><a href="#建立Controller层" class="headerlink" title="建立Controller层"></a>建立Controller层</h3><p>前端和后端商量好的,前端可能会产生哪些请求,每个请求发给哪个servlet</p>
<p>再细分一下,感觉</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">这是前端写的</span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/login.do<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">这是后端写的</span><br><span class="line">	<span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>LoginServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.threepure.servlet.user.LoginServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>现在就面临一个问题</p>
<p>用户的行为可能有很多,比如登录,注销,修改密码,订单管理,供应商管理等等</p>
<p>这么多行为,应该用几个servlet实现?</p>
<p>针对用户的行为,有三个Servlet,LoginServlet,LogoutServlet,UserServlet</p>
<p>为啥要这样划分?</p>
<p>首先考虑权限问题,前端是无法过滤请求的,权限控制只能是后端的权限过滤器来做</p>
<p>权限过滤器根据session是否设置决定能否请求资源,对任何<code>/jsp/*的</code>请求生效</p>
<p>用户的行为中,只有登录界面是在设置session前可以访问的,因此webapp下面的login.jsp不会被权限过滤,任何情况均可访问</p>
<p>因此登录行为自己建立一个LoginServlet</p>
<p>登录和注销,两个行为都会更改session状态,因此各自一个Servlet处理业务</p>
<p>其他的用户行为都需要登录权限,因此在jsp目录下,收到权限过滤器保护,这些行为都有session状态,都发往一个UserServlet</p>
<p>通过一个method参数,决定该UserServlet调用何种服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;method&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;savepwd&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.updatePwd(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;pwdmodify&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.pwdmodify(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;query&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userQuery(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;add&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.add(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;getrolelist&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getRoleList(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;ucexist&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userCodeExist(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;view&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserById(req, resp, <span class="string">&quot;userview.jsp&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;modify&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.getUserById(req, resp, <span class="string">&quot;usermodify.jsp&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;modifyexe&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.userModify(req, resp);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;deluser&quot;</span>.equals(method) &amp;&amp; method != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.deleteUser(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上是控制耦合,这个method参数就是控制开关</p>
<p>Bill和Provider各自只有一个Servlet,也在doGet方法上采用控制耦合</p>
<p>总的来说,尽量少建立Servlet,可以使用控制耦合,大体上还是一个数据表对应一个Servlet,所有发生在该表上的行为,用一个Servlet处理,通过method参数的不同区分Service层的服务</p>
<h3 id="建立Service层"><a href="#建立Service层" class="headerlink" title="建立Service层"></a>建立Service层</h3><p>Controller层建立完毕之后,Service实际上已经固定了</p>
<p>User.getUserById给定一个用户名,查库建立一个user pojo,从控制层到服务层到数据访问层逐层往下扔就是了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Controller层User.getUserById</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">getUserById</span><span class="params">(HttpServletRequest req, HttpServletResponse resp, String url)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//获取传入的id</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">uid</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;uid&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.isNullOrEmpty(uid)) &#123;</span><br><span class="line">            <span class="type">UserServiceImpl</span> <span class="variable">userService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserServiceImpl</span>();</span><br><span class="line">            <span class="type">User</span> <span class="variable">userById</span> <span class="operator">=</span> userService.getUserById(uid);<span class="comment">//往下扔</span></span><br><span class="line">            req.setAttribute(<span class="string">&quot;user&quot;</span>, userById);</span><br><span class="line">            req.getRequestDispatcher(url).forward(req, resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h3 id="建立DAO层"><a href="#建立DAO层" class="headerlink" title="建立DAO层"></a>建立DAO层</h3><p><strong>每一个数据表都会对应一个pojo类,一个Dao层类</strong></p>
<p><strong>每一个数据表都会对应一个pojo类,一个Dao层类</strong></p>
<p><strong>每一个数据表都会对应一个pojo类,一个Dao层类</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Dao/</span><br><span class="line">	│  DaoBase.java</span><br><span class="line">	│</span><br><span class="line">	├─bill</span><br><span class="line">	│      BillDao.java</span><br><span class="line">	│      BillDaoImpl.java</span><br><span class="line">	│</span><br><span class="line">	├─provider</span><br><span class="line">	│      ProviderDao.java</span><br><span class="line">	│      ProviderDaoImpl.java</span><br><span class="line">	│</span><br><span class="line">	├─role</span><br><span class="line">	│      RoleDao.java</span><br><span class="line">	│      RoleDaoImpl.java</span><br><span class="line">	│</span><br><span class="line">	└─user</span><br><span class="line">	        UserDao.java</span><br><span class="line">	        UserDaoImpl.java</span><br></pre></td></tr></table></figure>

<p>比如用户表user,对应一个pojo User,然后在Dao&#x2F;user&#x2F;下面有一个UserDao接口和一个UserDaoImpl实现</p>
<p>这个UserDao接口干了啥呢?</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230104200556894.png" alt="image-20230104200556894"></p>
<p><strong>每一个函数,都对应于一种user表中的原子操作(一条sql语句)</strong></p>
<p><strong>每一个函数,都对应于一种user表中的原子操作(一条sql语句)</strong></p>
<p><strong>每一个函数,都对应于一种user表中的原子操作(一条sql语句)</strong></p>
<table>
<thead>
<tr>
<th>UserDao函数</th>
<th>user表原子操作</th>
</tr>
</thead>
<tbody><tr>
<td><code>getLoginUser( connection, userCode)</code></td>
<td><code>select * from smbms_user where userCode=?</code></td>
</tr>
<tr>
<td><code>updatePwd(connection,  id, password)</code></td>
<td><code>update smbms_user set userPassword = ? where id = ?</code></td>
</tr>
<tr>
<td><code>add(Connection connection, User user)</code></td>
<td><code>insert into smbms_user (userCode,userName,userPassword,&quot; +         &quot;userRole,gender,birthday,phone,address,creationDate,createdBy) &quot; +         &quot;values(?,?,?,?,?,?,?,?,?,?)</code></td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody></table>
<p>“中途优化是万恶之源”</p>
<p>等整个网站正常运行起来之后,再考虑如何优化,到那时候再考虑使用什么Druid连接池</p>
<p>最初就用最普通的mysql就可以了</p>
<p>Service层:</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/12/23/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92-%E5%8C%BA%E9%97%B4DP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/23/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92-%E5%8C%BA%E9%97%B4DP/" class="post-title-link" itemprop="url">动态规划-区间DP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-23 21:30:00" itemprop="dateCreated datePublished" datetime="2022-12-23T21:30:00+08:00">2022-12-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-01-04 21:11:32" itemprop="dateModified" datetime="2023-01-04T21:11:32+08:00">2023-01-04</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="动态规划-区间DP"><a href="#动态规划-区间DP" class="headerlink" title="动态规划-区间DP"></a>动态规划-区间DP</h1><p>模板题一般长这样:</p>
<p>给一个区间[1,n]</p>
<p>给定一种操作:合并子区间,两个相邻子区间[i,j],[j+1,k]合并,得到一定的收益或者付出一些代价.这个收益或者代价必然是和两个子区间相关的函数,比如sum[i,j]+sum[j+1,k]</p>
<p>求将整个区间合并为一个数,获得的最大收益或者付出的最小代价</p>
<h2 id="P1880-合并环状石子"><a href="#P1880-合并环状石子" class="headerlink" title="P1880 合并环状石子"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1880">P1880 合并环状石子</a></h2><p>一圈石子有n组,其中第i组有a[i]个,合并两组石子的代价是两组石子个数和,求将所有石子合并成一组需要的最大代价和最小代价</p>
<blockquote>
<p>本题需要先把环拆成线,其弱化版也就是无环版本<a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1775">P1775 石子合并（弱化版</a></p>
</blockquote>
<p>首先需要把这个圈解开,比较好的方法是将[1,n]展开成线性,然后复制一遍接到后面,就是</p>
<table>
<thead>
<tr>
<th>总下标</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>…</th>
<th>n-1</th>
<th>n</th>
<th>n+1</th>
<th>n+2</th>
<th>n+3</th>
<th>…</th>
<th>2n-1</th>
<th>2n</th>
</tr>
</thead>
<tbody><tr>
<td>原下标</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>…</td>
<td>n-1</td>
<td>n</td>
<td>1</td>
<td>2</td>
<td>3</td>
<td>…</td>
<td>n-1</td>
<td>n</td>
</tr>
<tr>
<td>石子个数</td>
<td>a[1]</td>
<td>a[2]</td>
<td>a[3]</td>
<td>..</td>
<td>a[n-1]</td>
<td>a[n]</td>
<td>a[1]</td>
<td>a[2]</td>
<td>a[3]</td>
<td>…</td>
<td>a[n-1]</td>
<td>a[n]</td>
</tr>
</tbody></table>
<h3 id="设计状态"><a href="#设计状态" class="headerlink" title="设计状态"></a>设计状态</h3><p>$$<br>max_dp[i][j]&#x3D;将[i,j]区间合并成一组的最大代价\<br>min_dp[i][j]&#x3D;将[i,j]区间合并 成一组的最小代价<br>$$</p>
<p>显然边界条件是:<br>$$<br>\forall _{1\le i\le 2n}max_dp[i][i]&#x3D;0\<br>\forall _{1\le i\le 2n}min_dp[i][i]&#x3D;0\<br>$$<br>意思是将一组石子和自己合并(合并个寂寞),其代价为0,因为不需要合并</p>
<p>$$<br>max_dp[i][j]&#x3D;\max_{i\leq k&lt;j}(max_dp[i][k]+max_dp[k+1][j])+\sum_{i\leq l\leq j}a[l]\<br>min_dp[i][j]&#x3D;\max_{i\leq k&lt;j}(min_dp[i][k]+min_dp[k+1][j])+\sum_{i\leq l\leq j}a[l]<br>$$</p>
<p>其中$\sum_{i\leq l\leq j}a[l]$也就是从i到j的石子总个数,可以维护前缀和降低复杂度<br>$$<br>\sum_{i\leq l\leq j}a[l]&#x3D;prefix[j]-prefix[i-1]<br>$$</p>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF=<span class="number">1e9</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">210</span>;</span><br><span class="line"><span class="type">int</span> value[maxn];</span><br><span class="line"><span class="type">int</span> max_dp[maxn][maxn];<span class="comment">//max_dp[i][j]为合并闭区间[i,j]所需要的最大代价</span></span><br><span class="line"><span class="type">int</span> min_dp[maxn][maxn];</span><br><span class="line"><span class="type">int</span> prefix[maxn];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span> v;</span><br><span class="line">    prefix[<span class="number">0</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        cin&gt;&gt;v;</span><br><span class="line">        value[i]=value[i+n]=v;</span><br><span class="line">        prefix[i]=prefix[i<span class="number">-1</span>]+value[i];</span><br><span class="line">        max_dp[i][i]=max_dp[i+n][i+n]=<span class="number">0</span>;<span class="comment">//初始化边界条件,只有一堆时不需要合并,因此无代价</span></span><br><span class="line">        min_dp[i][i]=min_dp[i+n][i+n]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>+n;i&lt;=n*<span class="number">2</span>;i++)&#123;</span><br><span class="line">        prefix[i]=prefix[i<span class="number">-1</span>]+value[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> delta=<span class="number">1</span>;delta&lt;n;delta++)&#123;<span class="comment">//delta,步长,确定区间左端点i之后,右端点j=i+delta,显然delta初始值应该是1</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> i=<span class="number">1</span>;i+delta&lt;=<span class="number">2</span>*n;i++)&#123;</span><br><span class="line">            <span class="keyword">auto</span> j=i+delta;</span><br><span class="line">            <span class="keyword">auto</span> temp_max=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">auto</span> temp_min=INF;<span class="comment">//临时变量,用于计算最值</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> k=i;k&lt;j;++k)&#123;</span><br><span class="line">                temp_max=<span class="built_in">max</span>(temp_max,max_dp[i][k]+max_dp[k<span class="number">+1</span>][j]+prefix[j]-prefix[i<span class="number">-1</span>]);<span class="comment">//状态转移</span></span><br><span class="line">                temp_min=<span class="built_in">min</span>(temp_min,min_dp[i][k]+min_dp[k<span class="number">+1</span>][j]+prefix[j]-prefix[i<span class="number">-1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">            max_dp[i][j]=temp_max;</span><br><span class="line">            min_dp[i][j]=temp_min;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> max_value=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> min_value=<span class="number">1e9</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        max_value=<span class="built_in">max</span>(max_value,max_dp[i][i+n<span class="number">-1</span>]);</span><br><span class="line">        min_value=<span class="built_in">min</span>(min_value,min_dp[i][i+n<span class="number">-1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;min_value&lt;&lt;endl&lt;&lt;max_value&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="P1063-合并能量珠子"><a href="#P1063-合并能量珠子" class="headerlink" title="P1063 合并能量珠子"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1063">P1063 合并能量珠子</a></h2><p>每个珠子有两头,记作(l,r),相邻两个珠子的相向两头数值相同,比如<br>$$<br>(a,b)(b,c)(c,d)(d,a)<br>$$<br>合并两个相邻珠子$(a,b)(b,c)$得到的能量是$a\times b\times c$,合并之后形成新珠子$(a,c)$</p>
<p>将整个项链合并,求得到的最大能量值</p>
<p>还是将整个环拆成[1,n]然后拷贝一份接到后面</p>
<p>$dp[i][j]$表示合并区间[i,j]能够得到的最大能量,其中i表示第i个珠子,j表示第j个珠子</p>
<p>边界条件仍然是$dp[i][i]&#x3D;0$,只有一个珠子不需要合并</p>
<p>状态转移:<br>$$<br>dp[i][j]&#x3D;\max_{i\le k&lt; j}(dp[i][k]+dp[k+1][j]+node[k].l\times node[k].r\times node[k+1].r)<br>$$</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">210</span>;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Bead</span>&#123;</span><br><span class="line">    <span class="type">int</span> __energy;<span class="comment">//合并成当前珠子时能够获得的最大能量</span></span><br><span class="line">    <span class="type">int</span> __l;<span class="comment">//左标记</span></span><br><span class="line">    <span class="type">int</span> __r;<span class="comment">//右标记</span></span><br><span class="line">    <span class="built_in">Bead</span>(<span class="type">int</span> _l=<span class="number">0</span>,<span class="type">int</span> _r=<span class="number">0</span>,<span class="type">int</span> _e=<span class="number">0</span>):__l(_l),__r(_r),__energy(_e)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">l</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">r</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __r;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setL</span><span class="params">(<span class="type">int</span> _l)</span></span>&#123;</span><br><span class="line">        __l=_l;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setR</span><span class="params">(<span class="type">int</span> _r)</span></span>&#123;</span><br><span class="line">        __r=_r;</span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setEnergy</span><span class="params">(<span class="type">int</span> _e)</span></span>&#123;</span><br><span class="line">        __energy=_e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">energy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __energy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">toString</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+<span class="built_in">to_string</span>(__l)+<span class="string">&quot;,&quot;</span>+<span class="built_in">to_string</span>(__r)+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">friend</span> ostream &amp;<span class="keyword">operator</span>&lt;&lt;(ostream &amp;os,<span class="type">const</span> Bead &amp;bead)&#123;</span><br><span class="line">        os&lt;&lt;bead.<span class="built_in">toString</span>();</span><br><span class="line">        <span class="keyword">return</span> os;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;bead[maxn][maxn];</span><br><span class="line"><span class="type">int</span> dp[maxn][maxn];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="type">int</span> l;</span><br><span class="line">    <span class="type">int</span> r;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        cin&gt;&gt;l;</span><br><span class="line">        bead[i][i].<span class="built_in">setL</span>(l);</span><br><span class="line">        bead[i+n][i+n].<span class="built_in">setL</span>(l);</span><br><span class="line">        bead[i+n<span class="number">-1</span>][i+n<span class="number">-1</span>].<span class="built_in">setR</span>(l);</span><br><span class="line">        bead[i<span class="number">-1</span>][i<span class="number">-1</span>].<span class="built_in">setR</span>(l);</span><br><span class="line">    &#125;</span><br><span class="line">    bead[<span class="number">2</span>*n][<span class="number">2</span>*n].<span class="built_in">setR</span>(bead[<span class="number">0</span>][<span class="number">0</span>].<span class="built_in">r</span>());</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> delta=<span class="number">1</span>;delta&lt;n;++delta)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> i=<span class="number">1</span>;i+delta&lt;=<span class="number">2</span>*n;++i)&#123;</span><br><span class="line">            <span class="keyword">auto</span> j=i+delta;</span><br><span class="line">            <span class="type">int</span> max_energy=<span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> temp_energy=<span class="number">0</span>;</span><br><span class="line">            <span class="type">int</span> max_k=<span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> k=i;k&lt;j;++k)&#123;</span><br><span class="line">                </span><br><span class="line">                temp_energy=<span class="built_in">max</span>(max_energy,bead[i][k].<span class="built_in">energy</span>()+bead[k<span class="number">+1</span>][j].<span class="built_in">energy</span>()+bead[i][k].<span class="built_in">l</span>() * bead[i][k].<span class="built_in">r</span>() * bead[k<span class="number">+1</span>][j].<span class="built_in">r</span>());</span><br><span class="line">                <span class="keyword">if</span>(temp_energy&gt;max_energy)&#123;</span><br><span class="line">                    max_energy=temp_energy;</span><br><span class="line">                    max_k=k;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            bead[i][j].<span class="built_in">setEnergy</span>(max_energy);</span><br><span class="line">            bead[i][j].<span class="built_in">setL</span>(bead[i][max_k].<span class="built_in">l</span>());</span><br><span class="line">            bead[i][j].<span class="built_in">setR</span>(bead[max_k<span class="number">+1</span>][j].<span class="built_in">r</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> result=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;i++)&#123;</span><br><span class="line">        <span class="type">int</span> j=i+n<span class="number">-1</span>;</span><br><span class="line">        result=<span class="built_in">max</span>(result,bead[i][j].<span class="built_in">energy</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;result&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h2 id="P1005-矩阵取数"><a href="#P1005-矩阵取数" class="headerlink" title="P1005 矩阵取数"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1005">P1005 矩阵取数</a></h2><p>对于一个给定的 $n \times m$ 的矩阵，矩阵中的每个元素 $a_{i,j}$ 均为非负整数。游戏规则如下：</p>
<ol>
<li>每次取数时须从每行各取走一个元素，共 $n$ 个。经过 $m$ 次后取完矩阵内所有元素；</li>
<li>每次取走的各个元素只能是该元素所在行的行首或行尾；</li>
<li>每次取数都有一个得分值，为每行取数的得分之和，每行取数的得分 &#x3D; 被取走的元素值 $\times 2^i$，其中 $i$ 表示第 $i$ 次取数（从 $1$ 开始编号）；</li>
<li>游戏结束总得分为 $m$ 次取数得分之和。</li>
</ol>
<p>对于任意矩阵，可以求出取数后的最大得分。</p>
<p>由于第i次取数的权重为$2^i$,显然应尽量保留大数放到最后取</p>
<p>并且取第一行和第二行的数没有影响</p>
<p>因此实际上可以先解决一行内的取数问题,问题转化为:</p>
<p>m个数,第i个数是a[i],每次取数只能从头或者尾取数,第j次取数x的得分是$2^j\times x$,求m次取数最高得分</p>
<p>如果没有只能头尾取数的限制,显然直接m个数排序后按照从小到达的顺序取数,现在有一个只能从头或者尾取数的限制</p>
<p>暴力搜索的算法容易想到dfs(deque,level)表示当前双端队列deque,当前要取第level个数</p>
<p>但是m最大为80,这就意味着dfs的时间复杂度是$O(2^{80})$显然超时</p>
<p>显然要使用更吊的方法</p>
<p>设计状态:<br>$$<br>dp[i][j]\leftarrow要在闭区间[i,j]中取数,全部取完后最终能够得到的最大值<br>$$</p>
<p>状态转移:<br>$$<br>dp[i][j]&#x3D;max(dp[i][j-1]+a[j][j]\times 2^k,dp[i+1][j]+a[i][i]\times 2^k)<br>$$<br>其中k是第k次取数,k&#x3D;n-i-j+2</p>
<p><code>dp[1][n]</code>是第1次取数</p>
<p>屑题害得考尼玛的高精度,有个🔨意思啊,没活可以咬打火机</p>
<h2 id="P4767-邮局"><a href="#P4767-邮局" class="headerlink" title="P4767 邮局"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P4767">P4767 邮局</a></h2><p>v个村庄,p个邮局</p>
<p>第i个村庄在a[i]位置</p>
<p>邮局都要建在村庄里,要求所有村庄到最近邮局的距离和最小</p>
<p>求这个最小距离和是多少</p>
<p>设计状态:<br>$$<br>dp[i][j]表示前i个村庄放了j个邮局,最小距离和<br>$$</p>
<p>状态转移<br>$$<br>dp[i][j]&#x3D;\min_{1\le k\le i}(dp[k][j-1]+w(k+1,i))<br>$$<br>其中$w(l,r)$表示,在第l个和第r个(包括两头)村庄之间放一个邮局时,这一段上的村庄的最短距离和</p>
<p>这个玩意儿怎么求呢?</p>
<p>设$[l,r]$区间上的村庄坐标为$x[l],x[l+1],x[l+2],…,x[r-1],x[r]$</p>
<p>假设放这个邮局的坐标为$x$,则问题相当于<br>$$<br>w(l,r)&#x3D;min(|x-x[l]|+|x-x[l+1]|+|x-x[l+2]|+…+|x-x[r-1]|+|x-x[r]|)<br>$$<br>令$f(x)&#x3D;|x-x[l]|+|x-x[l+1]|+|x-x[l+2]|+…+|x-x[r-1]|+|x-x[r]|$</p>
<p>也就是求该函数在$[l,r]$上的最小值点</p>
<p>怎么求呢?画图观察一下,</p>
<p>如果有奇数项,比如$y&#x3D;|x-x_1|+|x-x_2|+|x-x_3|$,这个函数必然有一个尖儿,也就是我们需要的最小值,并且这个极小值点等于 $中位数(x_1,x_2,x_3)$</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221223163332854.png" alt="image-20221223163332854"></p>
<p>如果有偶数项,比如$y&#x3D;|x-x_1|+|x-x_2|+|x-x_3|+|x-x_4|$,就没有这个尖儿,但是有一个水平的最低谷,这个最低谷介于两个中位数之间</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221223163546294.png" alt="image-20221223163546294"></p>
<p>这就有$w(l,r)$的求解方法了:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">w</span>(l,r):</span><br><span class="line">	mid=向下取整((l+r)/<span class="number">2</span>)</span><br><span class="line">	dist_sum=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> all k among [l,r]:</span><br><span class="line">		dist_sum+=<span class="built_in">abs</span>(x[k]-x[mid])</span><br><span class="line">		</span><br><span class="line">	<span class="keyword">return</span> dist_sum;</span><br></pre></td></tr></table></figure>

<p>每次调用$w(l,r)$,时间复杂度都是$T(r-l+1)&#x3D;O(n)$</p>
<p>可以预处理所有的$w(l,r)$</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">for(int l=1;l&lt;=n;++l)&#123;</span><br><span class="line">	for(int r=l;r&lt;=n;++r)&#123;</span><br><span class="line">		W[l][r]=w(l,r);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>外面又套了$O(n^2)$的循环</p>
<p>总复杂度是$O(n^3)$,然而n最大是3000,显然$O(n^3)$会超时</p>
<p>如果能给他降为$O(n^2)$就可以了</p>
<p>这个$w[l,r]$的求法可以继续优化</p>
<p>假设已经知道了$w[l,r-1]$,现在要求$w[l,r]$<br>$$<br>w[l,r]&#x3D;w[l,r-1]+x[r]-x[mid(l,r)]\<br>mid(l,r)&#x3D;\lfloor\frac{l+r}{2}\rfloor<br>$$<br>这条结论看上去很诡异,太简洁了,并且好像中位数的变动只会影响到新加入的第r个村庄,前面的[l,r-1]村庄到邮局的最近距离和仍然是使用的原来的中位数,我自己推导的式子中是有中位数的变化的</p>
<blockquote>
<p>如果$r-l+1$是一个奇数,那么最右边再加一个,下标中位数不变,相当于邮局位置不用改动,那么[l,r]所有的村庄到这个邮局的距离和不变,$w[l,r+1]&#x3D;w[l,r]+|x[r+1]-x[mid]|$</p>
<p>如果$r-l+1$是一个偶数,那么最右边再加一个,下标中位数得往右移动一个,新mid&#x3D;老mid+1,那么</p>
<p>$w[l,r+1]&#x3D;w[l,r]+|x[新mid]-x[老mid]|\times (l-r+1)+|x[r+1]-x[新mid]|$</p>
<p>再考虑$r-l+1$是奇数的情况,如果保持下标中位数不变,实际上对于[l,r+1]时,这个中位数是左中位数</p>
<p>完全可以+1使用右中位数</p>
<p>因此两种情况统一了,即<br>$$<br>w[l,r+1]&#x3D;w[l,r]+(x[mid+1]-x[mid])\times (r-l+1)+x[r+1]-x[mid+1]<br>$$</p>
</blockquote>
<p>然而仔细一想确实可以忽略中位数的变化.怎么想呢?</p>
<p>$$<br>\begin{aligned}<br>w[l,r-1]&amp;&#x3D;\sum_{l\le k\le r-1}|x[k]-x[mid(l,r-1)]|\<br>w[l,r]&amp;&#x3D;\sum_{l\le k\le r}|x[k]-x[mid(l,r)]|\<br>\end{aligned}<br>$$<br>如果[l,r-1]之间有偶数个村庄,那么选取邮局建立在左中位数村庄或者右中位数村庄,甚至两者直接的地方(虽然只允许建立在村庄里),[l,r-1]所有的村庄到这个邮局的距离和都是最短的,这在图上对应水平谷底那一段</p>
<p>不妨让邮局建立在右中位数村庄,也就是$\lfloor\frac{l+r-1}{2}\rfloor+1$</p>
<p>那么[l,r]有奇数个村庄,其中位数唯一,也就是$\lfloor \frac{l+r}{2}\rfloor$</p>
<p>由于[l,r-1]之间有偶数个村庄,因此可以设$r-1-l+1&#x3D;r-l&#x3D;2k$带入上两式<br>$$<br>\begin{aligned}<br>\lfloor\frac{l+r-1}{2}\rfloor+1&amp;&#x3D;\lfloor k+l-\frac{1}{2}\rfloor+1&#x3D;k+l-1+1&#x3D;k+l\<br>\lfloor \frac{l+r}{2}\rfloor&amp;&#x3D;\lfloor k+l\rfloor&#x3D;k+l<br>\end{aligned}<br>$$<br>这就证明了[l,r]的中位数恰好是[l,r-1]的右中位数,因此两种情况可以选择同一个中位数,因此新加入r村庄的时候w[l,r]直接加上w[l,r-1],无需进行中位数的校正</p>
<p>如果[l,r-1]之间有奇数个村庄,那么只需要让[l,r]选取左中位数和[l,r-1]的中位数是一个点,同理可证</p>
<p>证毕</p>
<p>实际上证完了看这个结论很容易想,但是之前思维就太僵化了,以后记住这个结论吧</p>
<p>加上w计算的优化,加上四边形不懂事的优化</p>
<p>okk,现在dp的时间复杂度成功降到了$O(n^2)$</p>
<p>优化后的w,其计算的时间复杂度也是$O(n^2)$</p>
<p>总时间复杂度就是$O(n^2)$</p>
<p>应该可以通过了吧</p>
<p><del>不想写了,开摆,明天写了题解然后再看看四边形不懂事优化</del></p>
<p>阳了四天,摆了四天…</p>
<p>首先是不加四边形不等式优化的代码</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> v, p;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF = <span class="number">1e9</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxv = <span class="number">3010</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxp = <span class="number">310</span>;</span><br><span class="line"><span class="type">int</span> x[maxv];</span><br><span class="line"><span class="type">int</span> w[maxv][maxv];</span><br><span class="line"><span class="type">int</span> dp[maxv][maxp];</span><br><span class="line"><span class="comment">// int s[maxv][maxp];</span></span><br><span class="line"><span class="type">int</span> s[maxv];</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// cin.tie(0);</span></span><br><span class="line">    cin &gt;&gt; v &gt;&gt; p;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt;= v; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        cin &gt;&gt; x[i];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sort</span>(x + <span class="number">1</span>, x + v + <span class="number">1</span>);<span class="comment">//使村庄的坐标升序排列</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化w数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> l = <span class="number">1</span>; l &lt;= v; ++l)</span><br><span class="line">    &#123;</span><br><span class="line">        w[l][l] = <span class="number">0</span>; <span class="comment">// 从l号村庄上建立邮局,到该村庄的最短邮局距离就是0</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> r = l + <span class="number">1</span>; r &lt;= v; ++r)</span><br><span class="line">        &#123;</span><br><span class="line">            w[l][r] = w[l][r - <span class="number">1</span>] + x[r] - x[(l + r) &gt;&gt; <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化dp数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt;= v; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        s[i]=i;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt;= p; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            dp[i][j] = INF;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> j = <span class="number">1</span>; j &lt;= p; ++j)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> i = <span class="number">1</span>; i &lt;= v; ++i)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> temp_min = INF;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">auto</span> k = s[i<span class="number">-1</span>]; k &lt; i; ++k)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>(temp_min&gt;dp[k][j - <span class="number">1</span>] + w[k + <span class="number">1</span>][i])&#123;</span><br><span class="line">                    temp_min=dp[k][j - <span class="number">1</span>] + w[k + <span class="number">1</span>][i];</span><br><span class="line">                    s[i]=k;<span class="comment">//四边形不等式优化</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// temp_min = min(temp_min, dp[k][j - 1] + w[k + 1][i]);</span></span><br><span class="line">            &#125;</span><br><span class="line">            dp[i][j] = temp_min;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// i,j遍历顺序反了,导致计算dp[i][j]时,dp[k][j-1]可能还没有经过计算</span></span><br><span class="line">    <span class="comment">//  for(auto i=1;i&lt;=v;++i)&#123;</span></span><br><span class="line">    <span class="comment">//      for(auto j=1;j&lt;=p;++j)&#123;</span></span><br><span class="line">    <span class="comment">//          int temp_min=INF;</span></span><br><span class="line">    <span class="comment">//          for(auto k=1;k&lt;i;++k)&#123;</span></span><br><span class="line">    <span class="comment">//              temp_min=min(temp_min,dp[k][j-1]+w[k+1][i]);</span></span><br><span class="line">    <span class="comment">//          &#125;</span></span><br><span class="line">    <span class="comment">//          dp[i][j]=temp_min;</span></span><br><span class="line">    <span class="comment">//      &#125;</span></span><br><span class="line">    <span class="comment">//  &#125;</span></span><br><span class="line">    cout &lt;&lt; dp[v][p];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="动态规划-四边形不等式优化"><a href="#动态规划-四边形不等式优化" class="headerlink" title="动态规划-四边形不等式优化"></a>动态规划-四边形不等式优化</h2><p>证明及其他详细资料见<a target="_blank" rel="noopener" href="https://github.com/luoyongjun999/code">luoyongjun999&#x2F;code: code (github.com)</a></p>
<p>区间dp的状态转移,一般长这样(以P1775石子合并为例):</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> delta=<span class="number">1</span>;delta&lt;=n;++delta)&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> i=<span class="number">1</span>;i+delta&lt;=n;++i)&#123;</span><br><span class="line">        <span class="keyword">auto</span> j=i+delta;</span><br><span class="line">        <span class="type">int</span> temp_min=INF;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> k=i;k&lt;j;++k)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dp[i][k]+dp[k<span class="number">+1</span>][j]&lt;temp_min)&#123;</span><br><span class="line">                temp_min=dp[i][k]+dp[k<span class="number">+1</span>][j];</span><br><span class="line">                s[i][j]=k;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        dp[i][j]=temp_min+prefix[j]-prefix[i<span class="number">-1</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三层循环,复杂度$O(n^3)$</p>
<p>使用四边形不等式优化(能够证明成立的前提下),可以将最里圈k的遍历范围从$[i,j)$,缩减到$[s[i][j-1],s[i+1][j]$,这个范围结合上i和j的范围能够证明,三层循环的时间复杂度实际上是$O(n^2)$</p>
<blockquote>
<p>这里$s[i][j]$的实际意义是,当$dp[i][j]&#x3D;\min_{i\leq k&lt;j}(dp[i][k]+dp[k+1][j])+\sum_{i\leq k\leq j}a[k]$在k处取得最小值时,此时的k就作为$s[i][j]$</p>
<p>边界条件是$s[i][i]&#x3D;i$</p>
</blockquote>
<p>用法见P1775</p>
<h2 id="P1775-石子合并（弱化版"><a href="#P1775-石子合并（弱化版" class="headerlink" title="P1775 石子合并（弱化版)"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1775">P1775 石子合并（弱化版)</a></h2><p>一排N堆石头第i堆石头有a[i]个,合并两堆石头的得分是两堆石头的数量和</p>
<p>求最后合并只剩一堆时取得的最小得分,其中$N\le 300,a[i]\leq 1000$</p>
<p>P1880那个题是环状的,这个是线性的</p>
<p>设计状态:<br>$$<br>dp[i][j]表示合并[i,j]所有的石子,获得的最小得分<br>$$<br>边界条件:<br>$$<br>dp[i][i]&#x3D;0,即合并一堆时合并个寂寞<br>$$<br>状态转移:<br>$$<br>dp[i][j]&#x3D;\min_{i\leq k&lt;j}(dp[i][k]+dp[k+1][j])+\sum_{i\leq k\leq j}a[k]<br>$$<br>前缀和优化:<br>$$<br>\sum_{i\leq k\leq j}a[k]&#x3D;prefix[j]-prefix[i-1]\<br>dp[i][j]&#x3D;\min_{i\leq k&lt;j}(dp[i][k]+dp[k+1][j])+prefix[j]-prefix[i-1]<br>$$<br>四边形不等式优化:</p>
<blockquote>
<p>实际上需要证明$dp[i][j]$,但是可以证明只要是$w[i][j]$满足四边形不等式,$dp[i][j]$也自动满足四边形不等式,</p>
<p>因此首先证明$w[i][j]&#x3D;\sum_{i\leq k\leq j}a[k]&#x3D;prefix[j]-prefix[i-1]$满足应用四边形不等式的条件,即证:</p>
<p>1.定义:对于任意$i&lt;i+1\leq j&lt;j+1$,都有<br>$$<br>w[i][j]+w[i+1][j+1]\leq w[i][j+1]+w[i+1][j]<br>$$<br>2.单调性:对于任意$i\le i’\le j\le j’$,都有<br>$$<br>w[i][j’]\ge w[i’][j]<br>$$<br>证明如下:</p>
<p>对于定义:<br>$$<br>w[i][j]+w[i+1][j+1]&#x3D;prefix[j]-prefix[i-1]+prefix[j+1]-prefix[i]<br>$$</p>
<p>$$<br> w[i][j+1]+w[i+1][j]&#x3D;prefix[j+1]-prefix[i-1]+prefix[j]-prefix[i]<br>$$</p>
<p>左&#x3D;右,定义成立</p>
<p>对于单调性:<br>$$<br>w[i][j’]-w[i’][j]&#x3D;prefix[j’]-prefix[i-1]-prefix[j]+prefix[i’-1]\<br>&#x3D;(prefix[j’]-prefix[j])+(prefix[i’-1]-preifx[i-1])<br>$$<br>由于$i\le i’\le j\le j’$,并且前缀函数$prefix[i]$单调不减,因此上式非负,即<br>$$<br>w[i][j’]\ge w[i’][j]<br>$$<br>证毕</p>
<p>下面就可以使用四边形不等式的性质定理优化了</p>
</blockquote>
<p>$$<br>dp[i][j]&#x3D;\min_{s[i-1][j]\leq k&lt;s[i][j+1]}(dp[i][k]+dp[k+1][j])+prefix[j]-prefix[i-1]<br>$$<br>这里$s[i][j]$的实际意义是,当$dp[i][j]&#x3D;\min_{i\leq k&lt;j}(dp[i][k]+dp[k+1][j])+\sum_{i\leq k\leq j}a[k]$在k处取得最小值时,此时的k就作为$s[i][j]$</p>
<p>边界条件是$s[i][i]&#x3D;i$</p>
<p>$s[i][j]$的计算并不是头铁地从i到j遍历k先求$s[i][j]$,而是跟随dp一起求</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">310</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> INF=<span class="number">1e9</span>;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">int</span> a[maxn];</span><br><span class="line"><span class="type">int</span> dp[maxn][maxn];</span><br><span class="line"><span class="type">int</span> s[maxn][maxn];</span><br><span class="line"><span class="type">int</span> prefix[maxn];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i)&#123;</span><br><span class="line">        cin&gt;&gt;a[i];</span><br><span class="line">        s[i][i]=i;</span><br><span class="line">        dp[i][i]=<span class="number">0</span>;</span><br><span class="line">        prefix[i]=prefix[i<span class="number">-1</span>]+a[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> delta=<span class="number">1</span>;delta&lt;=n;++delta)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> i=<span class="number">1</span>;i+delta&lt;=n;++i)&#123;</span><br><span class="line">            <span class="keyword">auto</span> j=i+delta;</span><br><span class="line">            <span class="type">int</span> temp_min=INF;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> k=i;k&lt;j;++k)&#123;</span><br><span class="line">                <span class="keyword">if</span>(dp[i][k]+dp[k<span class="number">+1</span>][j]&lt;temp_min)&#123;</span><br><span class="line">                    temp_min=dp[i][k]+dp[k<span class="number">+1</span>][j];</span><br><span class="line">                    s[i][j]=k;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            dp[i][j]=temp_min+prefix[j]-prefix[i<span class="number">-1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;dp[<span class="number">1</span>][n]&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>至于四边形不等式的正确性,现在还没有完全转阴,啥时候脑子不浑了再看吧…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/12/22/%E7%8A%B6%E5%8E%8BDP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/22/%E7%8A%B6%E5%8E%8BDP/" class="post-title-link" itemprop="url">动态规划-状压DP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-22 23:48:00" itemprop="dateCreated datePublished" datetime="2022-12-22T23:48:00+08:00">2022-12-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-01 09:38:00" itemprop="dateModified" datetime="2023-06-01T09:38:00+08:00">2023-06-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="动态规划-状压DP"><a href="#动态规划-状压DP" class="headerlink" title="动态规划-状压DP"></a>动态规划-状压DP</h1><p>状态压缩DP,也就是把局面状态压缩到一个整数中,用整数的运算表示状态转移</p>
<p>模板题一般是,往棋盘上放同一种棋子,并且不能让他们掐架,问题有两种:</p>
<p>一共要放k个,求放法有几种?</p>
<p>最多放多少个?</p>
<p><code>g++ -std=c++11 -O2</code></p>
<h2 id="P1896-八王八"><a href="#P1896-八王八" class="headerlink" title="P1896 八王八"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1896">P1896 八王八</a></h2><p>一个$N\times N$的国象棋盘上放$k$个王八,要求这k个王八不能掐架.求有多少种放王八的方法</p>
<p>其中$1\leq N\leq 9,0\leq k\leq N\times N$</p>
<p>类似于八皇后问题,但是王八的攻击范围只有周围八格,更近</p>
<h3 id="状态压缩"><a href="#状态压缩" class="headerlink" title="状态压缩"></a>状态压缩</h3><p>棋盘的每个格子,要么有王八,要么没王八,因此 可以用1表示有,0表示无的状态</p>
<p>那么整个棋盘可以看成有N行,每行有N个格子</p>
<p>比如一个$4\times 4$,没有王的棋盘就可以是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0 0 0 0</span><br><span class="line">0 0 0 0</span><br><span class="line">0 0 0 0</span><br><span class="line">0 0 0 0</span><br></pre></td></tr></table></figure>

<p>可以将一行压缩为一个整数,最左侧是最低位比如</p>
<p>1 0 0 1 0 1 0 -&gt;0101001b&#x3D;41</p>
<p>如果想让一行中的王八不掐架,那么不能有任何两个1相邻.这一点怎么判断呢?</p>
<p>假设current_state&#x3D;41表示当前行状态</p>
<p>那么<code>(current_state&amp;((current_state&gt;&gt;1)|current_state&lt;&lt;1))</code>就可以判断有没有王八掐架</p>
<p>为啥呢?</p>
<p>比如状态41显然是合法的</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>整数</th>
<th>二进制</th>
</tr>
</thead>
<tbody><tr>
<td>current_state</td>
<td>41</td>
<td>0101001</td>
</tr>
<tr>
<td>current_state&lt;&lt;1</td>
<td></td>
<td>1010010</td>
</tr>
<tr>
<td>current_state&gt;&gt;1</td>
<td></td>
<td>0010100</td>
</tr>
<tr>
<td>(current_state&lt;&lt;1)|(current_state&gt;&gt;1)</td>
<td></td>
<td>1010110</td>
</tr>
<tr>
<td>current_state</td>
<td></td>
<td>0101001</td>
</tr>
<tr>
<td>(current_state&amp;((current_state&gt;&gt;1)|(current_state&lt;&lt;1))</td>
<td></td>
<td>0000000</td>
</tr>
</tbody></table>
<p>如何让相邻两行的王八不掐架呢?</p>
<p><code>(current_state&amp;((previous_state)|(previous_state&lt;&lt;1)|(previous_state&gt;&gt;1)))</code></p>
<p>道理类似于不让一行中的王八掐架,上一行的一个王八,那么本行中该王八的左下,正下,右下都不能有王八</p>
<h3 id="状态转移"><a href="#状态转移" class="headerlink" title="状态转移"></a>状态转移</h3><p>设计状态:</p>
<p><code>dp[currnet_row][cnt_king_used][current_state]</code>表示:</p>
<p>已经安排了<code>[1,current_row]</code>的王八,</p>
<p>已经安排了<code>cnt_king_used</code>个王八,</p>
<p>当前行,也就是第<code>current_row</code>的状态是<code>current_state</code></p>
<p>状态转移方程:<br>$$<br>\begin{aligned}<br>&amp;dp[current_row][cnt_king_used][current_state]&#x3D;\<br>&amp;\sum_{previous_state}dp[previous_row][cnt_kings_used-cnt_kings_of[current_row]\ ][previous_state]<br>\end{aligned}<br>$$<br>初始状态:</p>
<p>前0行(不存在这一行),放了0个王八,状态显然是0,此时的摆放方法<code>dp[0][0][0]=0</code></p>
<h3 id="完整程序"><a href="#完整程序" class="headerlink" title="完整程序"></a>完整程序</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> <span class="type">long</span> dp[<span class="number">10</span>][<span class="number">100</span>][<span class="number">2000</span>];<span class="comment">//dp[i][j][k]前i行中已经摆了j个王,其中第i行的状态是k.的数量</span></span><br><span class="line"><span class="type">int</span> n,k;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt;legal_states;</span><br><span class="line"><span class="type">int</span> cnt_kings_in_state[<span class="number">2000</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLegalState</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;k)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>((k&amp;((k&lt;&lt;<span class="number">1</span>)|(k&gt;&gt;<span class="number">1</span>)))==<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isInvasion</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;a,<span class="type">const</span> <span class="type">int</span> &amp;b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (a&amp;((b&lt;&lt;<span class="number">1</span>)|(b&gt;&gt;<span class="number">1</span>)|b));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;k;</span><br><span class="line">    <span class="type">int</span> current_state;</span><br><span class="line">    <span class="type">int</span> cnt_state;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;(<span class="number">1</span>&lt;&lt;n);i++)&#123;</span><br><span class="line">        current_state=i;</span><br><span class="line">        cnt_state=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(current_state)&#123;</span><br><span class="line">            cnt_state+=current_state&amp;<span class="number">1</span>;</span><br><span class="line">            current_state&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt_kings_in_state[i]=cnt_state;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isLegalState</span>(i))&#123;</span><br><span class="line">            legal_states.<span class="built_in">push_back</span>(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> current_row=<span class="number">1</span>;current_row&lt;=n;current_row++)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">auto</span> previous_row=current_row<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> current_state:legal_states)&#123;<span class="comment">//当前行合法状态</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> previous_state:legal_states)&#123;<span class="comment">//上一行的合法状态</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">isInvasion</span>(current_state,previous_state)==<span class="literal">false</span>)&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span>(</span><br><span class="line">                        <span class="type">int</span> cnt_tot_kings=cnt_kings_in_state[current_state];</span><br><span class="line">                        cnt_tot_kings&lt;=k;</span><br><span class="line">                        ++cnt_tot_kings</span><br><span class="line">                    )&#123;</span><br><span class="line">                        </span><br><span class="line">                        dp[current_row][cnt_tot_kings][current_state]+=</span><br><span class="line">                            dp[previous_row][cnt_tot_kings-cnt_kings_in_state[current_state]][previous_state];</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> result=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> current_state:legal_states)&#123;</span><br><span class="line">        result+=dp[n][k][current_state];</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;result&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h2 id="P1219-八皇后"><a href="#P1219-八皇后" class="headerlink" title="P1219 八皇后"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1219">P1219 八皇后</a></h2><p>$N\times N$的棋盘上要放N的皇后,要求N个皇后不能掐架,求多少种放皇后的方法</p>
<p>$6\leq N\leq 13$</p>
<h3 id="状态压缩-1"><a href="#状态压缩-1" class="headerlink" title="状态压缩"></a>状态压缩</h3><p>N行,每行N位,每位0表示没有皇后,1表示有皇后</p>
<p>一个int有32位,足够表示一行</p>
<p>每行的最左侧格子是int的最低位</p>
<h3 id="状态转移-1"><a href="#状态转移-1" class="headerlink" title="状态转移"></a>状态转移</h3><p>设计状态</p>
<p>$dfs(col_state,diagonal_state,rdiagonal_state,row)$</p>
<p>表示当前要放第row行的皇后,</p>
<p>之前所有的皇后控制的所有列存放在<code>col_state</code>中,</p>
<p>之前所有皇后控制的左上到右下的斜线<strong>在本行的影响</strong>存放在<code>diagonal_state</code>中</p>
<p>之前所有皇后控制的右上到左下的斜线在本行的影响存放在<code>人diagonal_state</code>中</p>
<p>显然$dfs(col_state,diagonal_state,rdiagonal_state,row)$的任务就是,结合前三个参数,在本行找一个安全位置放一个皇后,然后进入下一层dfs</p>
<p>啥意思呢?8</p>
<p>假如现在要放第四行,前三行的皇后如图所示</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222114520664.png" alt="image-20221222114520664"></p>
<p>这三个皇后控制的列对第四行的影响如图</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222114303317.png" alt="image-20221222114303317"></p>
<p>那么此时第四行的2,4,6列就不允许放皇后,</p>
<p>此时<code>col_state=00101010b</code>,(最左侧格子在最低位)表示第2,4,6列不允许使用</p>
<p>前三个皇后在左上到右下的斜线上,对第四行产生的影响如图</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222114701433.png" alt="image-20221222114701433"></p>
<p>即此时<code>diagonal_state=01110000</code>(最左侧格子在最低位),表示第5,6,7列不允许使用</p>
<p><code>rdiagonal_state</code>同理</p>
<p>下面考虑这三个表示占用状态的参数如何维护</p>
<p>显然col_state最容易维护,只要第i列上有过皇后,col_state的相应二进制位就置1</p>
<p>对于diagonal_state,假设本行的皇后放在第i列,那么他会影响下一行的i+1列,因此从当前行的dfs进入下一行的dfs时,只需要把diagonal_state加上本行的皇后列位置,然后右移1位传递给下层dfs</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222150322875.png" alt="image-20221222150322875"></p>
<p>综上,对于当前行的dfs,放置皇后时需要考虑的因素如图:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222150632385.png" alt="image-20221222150632385"></p>
<p>状态转移方程采用”推”的方式,从row层推进到row+1层<br>$$<br>\begin{aligned}<br>&amp;dfs(col_state,diagonal_state,rdiagonal_state,row)\ \Rightarrow<br>&amp;dfs(col_state|current_state,(diagonal_state|current_state)&gt;&gt;1,(rdiagonal_state|current_state)&lt;&lt;1,row+1)<br>\end{aligned}<br>$$</p>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">20</span>;</span><br><span class="line"><span class="type">int</span> log_2[<span class="number">10000</span>];</span><br><span class="line"><span class="type">int</span> cnt_success=<span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> limit_state;</span><br><span class="line"><span class="type">int</span> col[maxn];<span class="comment">//第i行放在第col[i]列上</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">lowbit</span><span class="params">(<span class="type">int</span> &amp;x)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x&amp;(-x);<span class="comment">//-x为取补,~x为按位取反</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">print</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=n;++i)&#123;</span><br><span class="line">        cout&lt;&lt;col[i]<span class="number">+1</span>&lt;&lt;<span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dfs</span><span class="params">(<span class="type">int</span> column_state,<span class="type">int</span> diagonal_state,<span class="type">int</span> rdiagonal_state,<span class="type">int</span> row)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(row&gt;n)&#123;</span><br><span class="line">        ++cnt_success;</span><br><span class="line">        <span class="keyword">if</span>(cnt_success&lt;=<span class="number">3</span>)&#123;<span class="comment">//打印前三个排列</span></span><br><span class="line">            <span class="built_in">print</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> capture_state=(column_state|diagonal_state|rdiagonal_state)&amp;limit_state;</span><br><span class="line">    <span class="type">int</span> available_state=(~capture_state)&amp;limit_state;<span class="comment">//~按位取反,</span></span><br><span class="line">    <span class="type">int</span> position_state;</span><br><span class="line">    <span class="type">int</span> position;</span><br><span class="line">    <span class="keyword">while</span>(available_state)&#123;</span><br><span class="line">        position_state=<span class="built_in">lowbit</span>(available_state);<span class="comment">//lowbit每次先尝试最低位,保证了得到结果的顺序是按照字典序的</span></span><br><span class="line">        position=log_2[position_state];</span><br><span class="line">        col[row]=position;</span><br><span class="line">        <span class="built_in">dfs</span>(column_state|position_state,(diagonal_state|position_state)&gt;&gt;<span class="number">1</span>,(rdiagonal_state|position_state)&lt;&lt;<span class="number">1</span>,row<span class="number">+1</span>);</span><br><span class="line">        available_state-=position_state;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n;</span><br><span class="line">    limit_state=(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>;<span class="comment">//规定yi&#x27;man</span></span><br><span class="line">    log_2[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">2</span>;i&lt;<span class="number">10000</span>;i++)&#123;<span class="comment">//初始化log_2对数函数</span></span><br><span class="line">        log_2[i]=log_2[i/<span class="number">2</span>]<span class="number">+1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">dfs</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    cout&lt;&lt;cnt_success&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



















<h2 id="P1879-八将军"><a href="#P1879-八将军" class="headerlink" title="P1879 八将军"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P1879">P1879 八将军</a></h2><p>$M\times N$个格子的矩形地面</p>
<p>然后输入$M\times N$个数表明这个地面是否肥沃,1肥沃,0贫瘠</p>
<p>其中$1\leq M,N\leq 12$</p>
<p>肥沃的土地可以种草,贫瘠的不行</p>
<p>任何两个草地不能有相邻边,可以有相邻顶角</p>
<p>求有多少种安排方法</p>
<p>问题可以向八王八靠拢,如果种草地可以视为占了一个中国象棋的将军,前后左右四个格子内不允许有第二个将军.贫瘠的格子不允许放棋</p>
<p>如果八王八问题中也有一些棋盘不允许放置棋子则和本题就很相似了</p>
<h3 id="状态压缩-2"><a href="#状态压缩-2" class="headerlink" title="状态压缩"></a>状态压缩</h3><p>一行最多有12个格子,每个格子要么种草,要么不中,一个二进制位两种状态表示一个格子即可,那么一行只需要12个二进制位,显然一个int有32位足够表示一行的状态</p>
<p>贫瘠的格子如何建模?贫瘠的格子不允许种草就行了呗</p>
<h3 id="状态转移-2"><a href="#状态转移-2" class="headerlink" title="状态转移"></a>状态转移</h3><p>类比八国王问题,设计dp状态<br>$$<br>dp[current_row][current_state]<br>$$<br>表示:</p>
<p>已经安排了[1,current_row]行,</p>
<p>其中第current_row行的状态是current_stata,</p>
<p>满足上述两个条件的不同安排数目是<code>dp[current_row][current_state]</code></p>
<p>状态转移方程是<br>$$<br>dp[current_row][current_state]&#x3D;\<br>\sum_{previous_state}dp[previous_row][previous_state]<br>$$<br>这里要求<code>previous_state</code>和<code>current_state</code>两个状态不能相互冲突,也就是上一行的种草格子,下一行这个格子不允许种草</p>
<h3 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">int</span> m,n;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">14</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> mod=<span class="number">1e9</span>;</span><br><span class="line"><span class="type">int</span> row_base_state[maxn];<span class="comment">//输入一行土地贫瘠状态之后压缩成一个整数,row_base_state[i]表示第i行的地皮是贫瘠还是肥沃</span></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; row_legal_state[maxn];<span class="comment">//ro_legal_state[i]表示第i行的所有合法状态集合(同行内没有相邻草地并且考虑贫瘠土地)</span></span><br><span class="line"><span class="type">int</span> row_limit_state;<span class="comment">//行状态上限</span></span><br><span class="line"><span class="type">int</span> dp[maxn][<span class="number">1000000</span>];<span class="comment">//dp[current_row][current_state],第1到current_row行都已经安排,其中第current_row行的状态是current_state</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;m&gt;&gt;n;<span class="comment">//m行,每行有n列</span></span><br><span class="line">    row_limit_state=(<span class="number">1</span>&lt;&lt;n)<span class="number">-1</span>;<span class="comment">//行状态上限</span></span><br><span class="line">    <span class="type">int</span> single_state;<span class="comment">//用于承载一个格子的状态</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>;i&lt;=m;i++)&#123;<span class="comment">//获取输入压缩到row_base_state</span></span><br><span class="line">        <span class="type">int</span> row_state=<span class="number">0</span>;<span class="comment">//用于压缩一行的状态</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">1</span>;j&lt;=n;j++)&#123;</span><br><span class="line">            cin&gt;&gt;single_state;</span><br><span class="line">            <span class="comment">//最先输入的格子权位最高,也就是说最左侧的格子在状态的最高二进制位</span></span><br><span class="line">            row_state=row_state*<span class="number">2</span>+single_state;<span class="comment">//行状态=刚才的行状态左移一位加上新格子的状态</span></span><br><span class="line">        &#125;</span><br><span class="line">        row_base_state[i]=row_state;<span class="comment">//计算得出了第i行的压缩状态</span></span><br><span class="line">        <span class="keyword">for</span>(row_state=<span class="number">0</span>;row_state&lt;=row_limit_state;++row_state)&#123;<span class="comment">//计算第i行的所有合法种草状态,第i行的每种合法种草状态都放到row_legal_state[i]中</span></span><br><span class="line">            <span class="keyword">if</span>((row_state&amp;((row_state&lt;&lt;<span class="number">1</span>)|(row_state&gt;&gt;<span class="number">1</span>)))==<span class="number">0</span> &amp;&amp; ((row_state&amp;((~row_base_state[i])&amp;row_limit_state))==<span class="number">0</span>))&#123;</span><br><span class="line">                row_legal_state[i].<span class="built_in">push_back</span>(row_state);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;<span class="comment">//设置dp初始条件,啥也不种的状态只有一种</span></span><br><span class="line">    row_legal_state[<span class="number">0</span>].<span class="built_in">push_back</span>(<span class="number">0</span>);<span class="comment">//第0行没有任何合法状态</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> current_row=<span class="number">1</span>;current_row&lt;=m;++current_row)&#123;<span class="comment">//</span></span><br><span class="line">        <span class="keyword">auto</span> previous_row=current_row<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> current_row_state:row_legal_state[current_row])&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> previous_row_state:row_legal_state[previous_row])&#123;</span><br><span class="line">                <span class="keyword">if</span>((current_row_state&amp;previous_row_state)==<span class="number">0</span>)&#123;<span class="comment">//两行不能冲突</span></span><br><span class="line">                    dp[current_row][current_row_state]+=dp[previous_row][previous_row_state];<span class="comment">//状态转移</span></span><br><span class="line">                    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="type">int</span> result=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;=row_limit_state;i++)&#123;</span><br><span class="line">        result=(result+dp[m][i])%mod;<span class="comment">//第m行的所有状态都要考虑在内</span></span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;result&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="P2704-八炮兵"><a href="#P2704-八炮兵" class="headerlink" title="P2704 八炮兵"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2704">P2704 八炮兵</a></h2><p>给一个P和H表示的地形地图</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/1881.png" alt="img"></p>
<p>其中只有P(Plain,平原)格子可以放炮兵,H山地不行</p>
<h3 id="状态压缩-3"><a href="#状态压缩-3" class="headerlink" title="状态压缩"></a>状态压缩</h3><p>一个炮兵的打炮范围是横竖的两格相当于中象里将军腿再长一点</p>
<p>实际上和P1879棒子地很相似了,P1879种草的方格相当于放了有一个中象的将军,这个题的格子相当于放了一个壮一点的将军</p>
<p>原来一个将军顶多影响跟前的四个格子,现在一个炮可以影响8个格子,</p>
<p>不妨把跟前这四个格子叫做”一级影响”,稍微远一点的四个格子叫做”二级影响”,如下图示意</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221222194252888.png" alt="image-20221222194252888"></p>
<p><strong>可见一个将军和一个炮的区别就是,将军只有一级影响,炮还有二级影响</strong></p>
<p>P1879这个题中要安排一行时,只需要考虑上一行给这一行造成的一级影响.</p>
<p>本题中除了一级影响,还要考虑二级影响,因此本题可以看作P1879的推广,</p>
<h3 id="状态转移-3"><a href="#状态转移-3" class="headerlink" title="状态转移"></a>状态转移</h3><p>原来的状态<code>dp[current_row][current_state]</code>表示1到<code>current_row</code>行已经安排完毕,其中<code>current_state</code>是第<code>current_row</code>行的状态,也就是对<code>current_row+1</code>行的”一级影响”</p>
<p>因此拓展到有二级影响的情况,应该这样设置状态<code>dp[current_row][current_state][previous_state]</code>,意思是</p>
<p>当前已经安排好了1到<code>current_row</code>行,</p>
<p>第<code>current_row</code>行的状态是<code>current_state</code>,</p>
<p>第<code>previous_row=current_row-1</code>行的状态是<code>previous_state</code></p>
<p><code>dp[current_row][current_state][previous_state]</code>等于在前述三个条件下得到的最大炮兵数量<br>$$<br>当前状态的最大炮兵数&#x3D;max(枚举与当前行不冲突的上一行状态的最大炮兵数+当前行状态贡献的炮兵数)<br>$$</p>
<p>状态转移方程就是:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dp[current_row][current_state][previous_state]=<span class="built_in">max</span>(</span><br><span class="line">	dp[previous_row][previous_state][preprevious_state]+cnt_of_cannons_in_state[current_state];</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="完整代码-2"><a href="#完整代码-2" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">110</span>;<span class="comment">//最大行数</span></span><br><span class="line"><span class="type">int</span> n,m;<span class="comment">//n行,m列</span></span><br><span class="line"><span class="type">int</span> row_limit_state;<span class="comment">//一行的最大状态</span></span><br><span class="line"><span class="type">int</span> row_base_state[maxn];<span class="comment">//一行中的地形状态,row_base_state[i]为第i行的地形状态</span></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; row_legal_states[maxn];<span class="comment">//只看一行时,该行的所有合法摆放炮兵的状态集合,row_legal_states[i]为第i行所有可以摆放的状态</span></span><br><span class="line"><span class="type">int</span> cnt_max_cannons;<span class="comment">//记录最大炮兵数量</span></span><br><span class="line"><span class="type">int</span> dp[maxn][<span class="number">1025</span>][<span class="number">1025</span>];</span><br><span class="line"><span class="type">int</span> cnt_cannons_in_state[<span class="number">1025</span>];<span class="comment">//cnt_cannons_in_state[state]表示当一行的炮兵状态为state时,放了几个炮兵</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m;<span class="comment">//n行m列</span></span><br><span class="line">    <span class="comment">// if(n)</span></span><br><span class="line">    <span class="type">int</span> single_state;<span class="comment">//输入char类型的地形转换成0或者1表示的地形</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> terrain;<span class="comment">//存放地形输入</span></span><br><span class="line"></span><br><span class="line">    row_limit_state=(<span class="number">1</span>&lt;&lt;m)<span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> row_state=<span class="number">0</span>;row_state&lt;=row_limit_state;++row_state)&#123;<span class="comment">//预处理cnt_cannons_in_state数组</span></span><br><span class="line">        <span class="type">int</span> row_temp_state=row_state;</span><br><span class="line">        <span class="type">int</span> cnt_cannons=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(row_temp_state)&#123;</span><br><span class="line">            cnt_cannons+=row_temp_state&amp;<span class="number">1</span>;<span class="comment">//不停右移直到降为0,只关心最低为有没有1</span></span><br><span class="line">            row_temp_state&gt;&gt;=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cnt_cannons_in_state[row_state]=cnt_cannons;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> row=<span class="number">1</span>;row&lt;=n;row++)&#123;</span><br><span class="line">        <span class="type">int</span> row_state=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> col=<span class="number">1</span>;col&lt;=m;++col)&#123;</span><br><span class="line">            cin&gt;&gt;terrain;</span><br><span class="line">            <span class="keyword">if</span>(terrain==<span class="string">&#x27;P&#x27;</span>)&#123;</span><br><span class="line">                single_state=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                single_state=<span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            row_state=row_state*<span class="number">2</span>+single_state;</span><br><span class="line">        &#125;</span><br><span class="line">        row_base_state[row]=row_state;<span class="comment">//保存地形状态</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//立刻计算基于当前行的地形状态,可以得出的所有合法的炮兵摆放状态</span></span><br><span class="line">        <span class="keyword">for</span>(row_state=<span class="number">0</span>;row_state&lt;=row_limit_state;row_state++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(</span><br><span class="line">                (row_state&amp;(((row_state&lt;&lt;<span class="number">1</span>)|(row_state&lt;&lt;<span class="number">2</span>)|(row_state&gt;&gt;<span class="number">1</span>)|(row_state&gt;&gt;<span class="number">2</span>) )&amp;row_limit_state)   )==<span class="number">0</span><span class="comment">//这个炮兵的摆放状态不能自相冲突</span></span><br><span class="line">                &amp;&amp;</span><br><span class="line">                (row_state&amp;((~row_base_state[row])&amp;row_limit_state))==<span class="number">0</span><span class="comment">//这个炮兵的摆放状态要满足地形要求</span></span><br><span class="line">            )&#123;</span><br><span class="line">                row_legal_states[row].<span class="built_in">push_back</span>(row_state);</span><br><span class="line">                <span class="comment">// cout&lt;&lt;row_state&lt;&lt;endl;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    dp[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">    row_legal_states[<span class="number">0</span>].<span class="built_in">push_back</span>(<span class="number">0</span>);<span class="comment">//一定要这个初始化,第二行会查第0行的合法状态</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> current_state:row_legal_states[<span class="number">1</span>])&#123;<span class="comment">//第一行需要特殊处理,因为第一行往前看两行不存在第-1行,不能作为数组下标</span></span><br><span class="line">        dp[<span class="number">1</span>][current_state][<span class="number">0</span>]=cnt_cannons_in_state[current_state];</span><br><span class="line">        cnt_max_cannons=<span class="built_in">max</span>(cnt_max_cannons,dp[<span class="number">1</span>][current_state][<span class="number">0</span>]);<span class="comment">//一定不要忘记统计只有一行时的最大炮兵数量,测试点11专门卡这个</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> current_row=<span class="number">2</span>;current_row&lt;=n;++current_row)&#123;<span class="comment">//第二行往前看两行正好是第0行,下标访问正常</span></span><br><span class="line">        <span class="keyword">auto</span> previous_row=current_row<span class="number">-1</span>;<span class="comment">//上一行行号</span></span><br><span class="line">        <span class="keyword">auto</span> preprevious_row=previous_row<span class="number">-1</span>;<span class="comment">//上两行行号</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">auto</span> current_state:row_legal_states[current_row])&#123;<span class="comment">//枚举当前行合法状态</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">auto</span> previous_state:row_legal_states[previous_row])&#123;<span class="comment">//枚举上一行合法状态</span></span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">auto</span> preprevious_state:row_legal_states[preprevious_row])&#123;<span class="comment">//枚举上两行合法状态</span></span><br><span class="line">                    <span class="keyword">if</span>(</span><br><span class="line">                        (previous_state &amp; preprevious_state)==<span class="number">0</span><span class="comment">//前两行的炮兵不能打架</span></span><br><span class="line">                        &amp;&amp;</span><br><span class="line">                        (current_state&amp;(previous_state|preprevious_state))==<span class="number">0</span><span class="comment">//本行和前两行的炮兵不能打架</span></span><br><span class="line">                    )&#123;</span><br><span class="line">                        dp[current_row][current_state][previous_state]=<span class="built_in">max</span>(<span class="comment">//状态转移方程</span></span><br><span class="line">                            dp[current_row][current_state][previous_state],</span><br><span class="line">                            dp[previous_row][previous_state][preprevious_state]+cnt_cannons_in_state[current_state]</span><br><span class="line">                        );</span><br><span class="line">                        cnt_max_cannons=<span class="built_in">max</span>(cnt_max_cannons,dp[current_row][current_state][previous_state]);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// for(auto current_state:row_legal_states[n])&#123;</span></span><br><span class="line">    <span class="comment">//     cnt_max_cannons=max(cnt_max_cannons,dp[n])</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    cout&lt;&lt;cnt_max_cannons&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="P2051-八中象炮"><a href="#P2051-八中象炮" class="headerlink" title="P2051 八中象炮"></a><a target="_blank" rel="noopener" href="https://www.luogu.com.cn/problem/P2051">P2051 八中象炮</a></h2><p>在一个$n\times m$的棋盘上,任意放中象的炮,要求任意两个炮不能相互攻击,随便放炮,问最多有多少种放法</p>
<p>啥时候能炮打炮?一条水平或者竖直线上有仨个以上的炮就要打炮了</p>
<p>因此就问题转化为,$n\times m$个方格,每行每列可以有0或者1或者2个石头,求有多少种摆放方法</p>
<h3 id="状态压缩-4"><a href="#状态压缩-4" class="headerlink" title="状态压缩"></a>状态压缩</h3><p>我最初的想法是,每行,每列都记录已经放过几个石头,然后直接深搜</p>
<p>dfs(x,y)是当前要在第x行第y列放石头,首先判断能否放石头,如果能则尝试放上石头然后下一步深搜.</p>
<p>不管能不能放石头,都要有一个直接下一步深搜</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> maxn=<span class="number">110</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">int</span> mod=<span class="number">9999973</span>;</span><br><span class="line"><span class="type">int</span> n,m;</span><br><span class="line"><span class="type">int</span> cnt_on_col[maxn];</span><br><span class="line"><span class="type">int</span> cnt_on_row[maxn];</span><br><span class="line"><span class="type">int</span> cnt_result=<span class="number">0</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">DFS</span><span class="params">(<span class="type">int</span> y,<span class="type">int</span> x)</span></span>&#123;<span class="comment">//第y行,第x列</span></span><br><span class="line">    <span class="keyword">if</span>(y&lt;=n&amp;&amp;x&gt;m)&#123;</span><br><span class="line">        <span class="built_in">DFS</span>(y<span class="number">+1</span>,<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(y&gt;n)&#123;</span><br><span class="line">        cnt_result=(cnt_result<span class="number">+1</span>)%mod;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(cnt_on_col[x]&lt;<span class="number">2</span>&amp;&amp;cnt_on_row[y]&lt;<span class="number">2</span>)&#123;</span><br><span class="line">        ++cnt_on_col[x];</span><br><span class="line">        ++cnt_on_row[y];</span><br><span class="line">        <span class="built_in">DFS</span>(y,x<span class="number">+1</span>);</span><br><span class="line">        --cnt_on_col[x];</span><br><span class="line">        --cnt_on_row[y];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">DFS</span>(y,x<span class="number">+1</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cin&gt;&gt;n&gt;&gt;m;</span><br><span class="line">    <span class="built_in">DFS</span>(<span class="number">1</span>,<span class="number">1</span>);</span><br><span class="line">    cout&lt;&lt;cnt_result&lt;&lt;endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果就三个测试点过了,其他全都TLE</p>
<p>狗屁状压,<code>dp[i][j][k]</code>表示前i行中的列,有一个炮的列有j个,有两个炮的列有k个</p>
<p>完事</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/12/21/C++11%E7%89%B9%E6%80%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/21/C++11%E7%89%B9%E6%80%A7/" class="post-title-link" itemprop="url">C++11特性</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-21 22:48:00 / Modified: 22:48:58" itemprop="dateCreated datePublished" datetime="2022-12-21T22:48:00+08:00">2022-12-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="C-11特性"><a href="#C-11特性" class="headerlink" title="C++11特性"></a>C++11特性</h1><p>迈向现代的第一步</p>
<p>2011年的C++标准,叫c++11</p>
<p>使用gcc编译时,加入编译选项-std&#x3D;c++11即可使用c++11特性</p>
<h2 id="类型推导"><a href="#类型推导" class="headerlink" title="类型推导"></a>类型推导</h2><p>auto&amp;decltype</p>
<h3 id="auto"><a href="#auto" class="headerlink" title="auto"></a>auto</h3><p><code>auto 左值=右值;</code></p>
<p>通过右值的类型推断auto代表的左值类型,必须得有右值才能用auto定义左值</p>
<p>一般用于循环时作为迭代器,比如在解释器遍历符号表时</p>
<p>在lexer.hpp中有这么一个内置符号表</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lexer.hpp</span></span><br><span class="line"><span class="type">static</span> std::vector&lt;Token&gt; build_in_token_table = &#123;</span><br><span class="line">    &#123;CONST_ID, <span class="string">&quot;PI&quot;</span>, <span class="number">3.1415926</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">    &#123;CONST_ID, <span class="string">&quot;E&quot;</span>, <span class="number">2.71828</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">	...</span><br><span class="line">    &#123;DRAW, <span class="string">&quot;DRAW&quot;</span>, <span class="number">0.0</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在lexer.cpp中有一个queryTokenTable函数,根据参数字符串查找内置符号表,如果找到相应符号返回<strong>其引用</strong></p>
<p>传统的方法是定义一个循环变量i,遍历整个符号表</p>
<p>如果使用auto则更加方便,foreach循环</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//lexer.cpp</span></span><br><span class="line"><span class="type">static</span> Token* <span class="title function_">queryTokenTable</span><span class="params">(<span class="built_in">std</span>::<span class="built_in">string</span> &amp;lexme)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp;build_in_table_token:build_in_token_table)&#123;<span class="comment">//此处一定是auto &amp;,是个引用类型,否则会拷贝构造新对象</span></span><br><span class="line">        <span class="keyword">if</span>(build_in_table_token.getLexme()==lexme)&#123;</span><br><span class="line">            <span class="keyword">return</span> &amp;build_in_table_token;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里使用的是auto &amp;,而不是auto,之前我认为auto既然是自动的,应该可以推导出引用类型.</p>
<p>然而实际上不会,auto会忽略引用类型还有cv属性,因此这里需要手工加上引用类型</p>
<h3 id="decltype"><a href="#decltype" class="headerlink" title="decltype"></a>decltype</h3><p>decltype关键字是用于定义同类型变量,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> a=<span class="number">1</span>;</span><br><span class="line">decltype(a) b=<span class="number">2</span>;</span><br><span class="line">decltype(a+b) c=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>decltype和auto不同的是,decltype完全拷贝其操作数的类型,包括引用和cv属性</p>
<p>对于<code>decltype(expression)</code>,这里expression如果是函数调用,则decltype与函数返回值类型相同</p>
<h2 id="右值引用"><a href="#右值引用" class="headerlink" title="右值引用"></a>右值引用</h2><h3 id="右值引用-1"><a href="#右值引用-1" class="headerlink" title="右值引用"></a>右值引用</h3><p>通常getter方法是这样定义的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">x</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __x;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">y</span><span class="params">()</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其返回值是一个右值,当调用语句结束后,返回值立刻死亡</p>
<p>实际上大多数调用约定(这里是cdecl),函数的返回值放到rax寄存器中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int x=point.x();</span><br></pre></td></tr></table></figure>

<p>该行源代码的最后的指令可能是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">call point.x()</span><br><span class="line">mov [rbp+x],rax</span><br></pre></td></tr></table></figure>

<p>意味着需要在调用者栈帧中给左值int a开4字节空间,然后将函数返回值(存在于rax寄存器)付给他</p>
<p>之后rax的任务就完成了,可以立刻用于其他计算,这就意味着函数返回值这个将亡值不复存在了</p>
<p>显然栈中是找不到这个返回值的,他只会临时存在于寄存器中</p>
<p>右值引用的作用是,在调用者栈帧中给返回值开辟一块空间,将该返回值放到这块空间中,此后在调用者中就可以引用”右值”了,实际上是引用的返回值在调用者栈帧中的拷贝,这一点可以通过反编译观察</p>
<p>比如如下程序</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>&#123;</span><br><span class="line">    <span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">int</span> _x=<span class="number">0</span>,<span class="type">int</span> _y=<span class="number">0</span>):__x(_x),__y(_y)&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">x</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> __x;&#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">y</span><span class="params">()</span></span>&#123;<span class="keyword">return</span> __y;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">Point <span class="title">A</span><span class="params">(<span class="number">2</span>,<span class="number">5</span>)</span></span>;</span><br><span class="line">    <span class="type">int</span> &amp;&amp;x=A.<span class="built_in">x</span>();<span class="comment">//注意此处的x是右值引用</span></span><br><span class="line">    <span class="type">int</span> y=A.<span class="built_in">y</span>();<span class="comment">//注意此处的y是普通变量</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;x);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,&amp;y);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ -std=c++11 main.cpp -O0 -o main </span><br></pre></td></tr></table></figure>

<p>然后用ida64反编译观察之</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">lea     eax, [ebp+A]	</span><br><span class="line">mov     ecx, eax	;this指针</span><br><span class="line">call    __ZN5Point1xEv  ; Point::x(void)</span><br><span class="line">mov     [ebp+var_10], eax	;返回值首先拷贝给var_10</span><br><span class="line">lea     eax, [ebp+var_10]	</span><br><span class="line">mov     [ebp+x], eax		;然后拷贝给x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lea     eax, [ebp+A]</span><br><span class="line">mov     ecx, eax	;this</span><br><span class="line">call    __ZN5Point1yEv  ; Point::y(void)</span><br><span class="line">mov     [ebp+y], eax	;返回值直接拷贝给y</span><br></pre></td></tr></table></figure>

<p>有一个明显区别,</p>
<p><code>int &amp;&amp;x=A.x();</code>这里貌似在调用者栈帧中产生了两个局部变量,<code>var_10</code>和<code>x</code></p>
<p>但是<code>int y=A.y();</code>只产生了一个局部变量<code>y</code></p>
<p>显然x和y两个变量是地位相等,门当户对的</p>
<p>这个<code>var_10</code>就是右值的拷贝,其存在的目的就是代理右值,使其可以进行取地址运算,实际上取得地址是<code>var_10</code>的地址</p>
<p>问题又来了,这样看,使用右值引用的时候多产生了一个局部变量,并且需要四条指令,而不使用右值引用只需要两条指令.那用了个寂寞啊,越用越慢是吧.</p>
<p>这是因为这里的调用情况是很简单的,有些复杂情况,var_10会发挥重要作用,详见<a target="_blank" rel="noopener" href="https://blog.csdn.net/caojianfa969/article/details/118927852">右值引用</a></p>
<h3 id="完美转发"><a href="#完美转发" class="headerlink" title="完美转发"></a>完美转发</h3><p>没看明白</p>
<h3 id="返回值优化"><a href="#返回值优化" class="headerlink" title="返回值优化"></a>返回值优化</h3><p>类似于传参时是直接传递引用还是调用拷贝构造函数给形参赋值</p>
<p>返回时也面临相似的局面,比如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">int</span> _x = <span class="number">0</span>, <span class="type">int</span> _y = <span class="number">0</span>) : __x(_x), __y(_y)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;constructor called&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">const</span> Point &amp;point)</span><br><span class="line">    &#123;</span><br><span class="line">        __x = point.__x;</span><br><span class="line">        __y = point.__y;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;copy constructor called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">static</span> Point <span class="title">Origin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;generating origin point...&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="function">Point <span class="title">origin</span><span class="params">(<span class="number">1</span>,<span class="number">1</span>)</span></span>;</span><br><span class="line">        cout&lt;&lt;hex&lt;&lt;&amp;origin&lt;&lt;endl;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;origin point generated!&quot;</span>&lt;&lt;endl;</span><br><span class="line">        <span class="keyword">return</span> origin;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">x</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">y</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Point O=Point::<span class="built_in">Origin</span>();</span><br><span class="line">    cout&lt;&lt;&amp;O&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主函数里定义了一个Point O,按照之前的认识,<code>Point O=Point::Origin();</code>这句话应该是这样执行的:</p>
<p>首先调用<code>Point::Origin()</code>,这个函数中会调用构造函数</p>
<p>接着<code>Point O=返回值</code>这里要对O调用拷贝构造函数</p>
<p>总共有两次调用构造函数,然而实际上只调用了一次</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\cpp&gt; g++ -std=c++11 main.cpp  -O0 -o main </span><br><span class="line">PS C:\Users\86135\Desktop\cpp&gt; ./main</span><br><span class="line">generating origin point...</span><br><span class="line">constructor called</span><br><span class="line">0x60fe88</span><br><span class="line">origin point generated!</span><br><span class="line">0x60fe88</span><br></pre></td></tr></table></figure>

<p>从两次地址的打印来看,两个对象实际上是一个对象,因此Origin函数可以认为返回的是这个对象的指针,从反汇编看确实如此</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">main中:</span><br><span class="line">lea     eax, [ebp+var_10]</span><br><span class="line">mov     [esp], eax      ; this</span><br><span class="line">call    __ZN5Point6OriginEv ; Point::Origin(void)</span><br><span class="line">lea     eax, [ebp+var_10]</span><br><span class="line">mov     ecx, eax</span><br><span class="line">Point::Origin中:</span><br><span class="line">mov     dword ptr [esp+4], 1 ; int</span><br><span class="line">mov     dword ptr [esp], 1 ; this</span><br><span class="line">mov     ecx, [ebp+this]</span><br><span class="line">call    __ZN5PointC1Eii ; Point::Point(int,int)</span><br></pre></td></tr></table></figure>

























<h2 id="列表初始化"><a href="#列表初始化" class="headerlink" title="列表初始化"></a>列表初始化</h2><p>在写词法分析器的时候有这么一个符号类</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Token</span></span><br><span class="line">&#123;</span><br><span class="line">    TokenType type;</span><br><span class="line">    std::string lexme;</span><br><span class="line">    <span class="type">double</span> value;</span><br><span class="line">    Func func;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Token</span>(TokenType t = ERRORTOKEN, std::string l = <span class="string">&quot;&quot;</span>, <span class="type">double</span> v = <span class="number">0.0</span>, Func f = <span class="literal">NULL</span>) : <span class="built_in">type</span>(t),</span><br><span class="line">                                                                                         <span class="built_in">lexme</span>(l),</span><br><span class="line">                                                                                         <span class="built_in">value</span>(v),</span><br><span class="line">                                                                                         <span class="built_in">func</span>(f)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">///...其他成员函数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<p>现在需要建立一个内建符号表,如果使用老式的写法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;Token&gt; built_in_token_table=&#123;</span><br><span class="line">	<span class="built_in">Token</span>(CONST_ID,<span class="string">&quot;PI&quot;</span>,<span class="number">3.1415926</span>,<span class="literal">NULL</span>),</span><br><span class="line">	<span class="built_in">Token</span>(CONST_ID,<span class="string">&quot;E&quot;</span>,<span class="number">2.71828</span>,<span class="literal">NULL</span>),</span><br><span class="line">	...</span><br><span class="line">	<span class="built_in">Token</span>(DRAW,<span class="string">&quot;DRAW&quot;</span>,<span class="number">0.0</span>,<span class="literal">NULL</span>)</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>每个条目都要显式调用构造函数<code>Token(...)</code></p>
<p>而如果使用初始化列表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Token&gt; build_in_token_table = &#123;</span><br><span class="line">    &#123;CONST_ID, <span class="string">&quot;PI&quot;</span>, <span class="number">3.1415926</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">    &#123;CONST_ID, <span class="string">&quot;E&quot;</span>, <span class="number">2.71828</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">	...</span><br><span class="line">    &#123;DRAW, <span class="string">&quot;DRAW&quot;</span>, <span class="number">0.0</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这样效果和上面一模一样,也会调用构造函数,但是不用写<code>Token(...)</code>,实际上也是调用相应参数个数的构造函数</p>
<h2 id="Lambda表达式"><a href="#Lambda表达式" class="headerlink" title="Lambda表达式"></a>Lambda表达式</h2><p>在实验室电脑上,开学乎上</p>
<h2 id="智能指针"><a href="#智能指针" class="headerlink" title="智能指针"></a>智能指针</h2><p>之前C++和C的堆内存管理责任全在程序员,new了不delete会内存泄漏,new了delete两次会造成二次释放漏洞.</p>
<p>而有些对象到底啥时候释放,可能人也把握不准,比如这次编译原理实验中,词法分析器的getToken函数总是返回一个Token*指针,函数内部会在堆上开一块内存放对象</p>
<p>然而parser在使用完了这个Token之后没有立刻释放,因为我也不知道啥时候一个Token才会真正使用完,比如一个T类型的Token,它作为变量可能会存在一段时间,提前析构了后来就会访问非法内存</p>
<p>于是Token几乎都存在内存泄漏,而我也不知道咋处理</p>
<p>智能指针就解决了这个困扰</p>
<p>智能指针实际上是对普通指针的包装,但是他会对对象有一个引用计数</p>
<p>每当有一个智能指针指向同一块内存的时候,引用计数就会加一,当一个智能指针消亡或者不再指向该内存的时候,引用计数减一,最后一个不再指向该内存的智能指针会发现引用计数从1到0,于是它会自动析构这个对象</p>
<p>显然就不用人操心在啥时候释放对象了</p>
<p>到底咋用呢?写一个链表类意思意思</p>
<p>关键词:<code>make_shared,shared_ptr</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">LinkedNode</span>&#123;</span><br><span class="line">    <span class="type">int</span> __key;</span><br><span class="line">    shared_ptr&lt;LinkedNode&gt; __next;</span><br><span class="line">    <span class="built_in">LinkedNode</span>(<span class="type">int</span> _key=<span class="number">0</span>,shared_ptr&lt;LinkedNode&gt; _next=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">        __key=_key;</span><br><span class="line">        __next=_next;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;LinkedNode ctor called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">LinkedNode</span>()&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;LinkedNode dtor called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">shared_ptr&lt;LinkedNode&gt; <span class="title">getNext</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getKey</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setNext</span><span class="params">(shared_ptr&lt;LinkedNode&gt; _next)</span></span>&#123;</span><br><span class="line">        __next=_next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setKey</span><span class="params">(<span class="type">int</span> _key)</span></span>&#123;</span><br><span class="line">        __key=_key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">toString</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">to_string</span>(__key);</span><br><span class="line">    &#125;</span><br><span class="line">    LinkedNode <span class="keyword">operator</span>=(<span class="type">const</span> LinkedNode &amp;)=<span class="keyword">delete</span>;</span><br><span class="line">    <span class="built_in">LinkedNode</span>(<span class="type">const</span> LinkedNode&amp;)=<span class="keyword">delete</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LinkedList</span>&#123;</span><br><span class="line">    shared_ptr&lt;LinkedNode&gt; head;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">LinkedList</span>()&#123;</span><br><span class="line">        head=<span class="built_in">make_shared</span>&lt;LinkedNode&gt;(<span class="number">0</span>,<span class="literal">nullptr</span>);<span class="comment">//注意创建节点不再直接调用构造函数</span></span><br><span class="line">        <span class="comment">//使用make_shared&lt;类名&gt;(参数)创建对象,返回值用shared_ptr&lt;类名&gt;类型承载</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">pushHead</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;key)</span></span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> node=<span class="built_in">make_shared</span>&lt;LinkedNode&gt;(key,head-&gt;<span class="built_in">getNext</span>());</span><br><span class="line">        head-&gt;<span class="built_in">setNext</span>(node);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">popHead</span><span class="params">()</span></span>&#123;</span><br><span class="line">        head-&gt;<span class="built_in">setNext</span>(head-&gt;<span class="built_in">getNext</span>()-&gt;<span class="built_in">getNext</span>());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">empty</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>==head-&gt;<span class="built_in">getNext</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> p=head-&gt;<span class="built_in">getNext</span>();</span><br><span class="line">        string buffer;</span><br><span class="line">        <span class="keyword">while</span>(p!=<span class="literal">nullptr</span>)&#123;</span><br><span class="line">            buffer+=p-&gt;<span class="built_in">toString</span>()+<span class="string">&quot;  &quot;</span>;</span><br><span class="line">            p=p-&gt;<span class="built_in">getNext</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buffer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    LinkedList list;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)&#123;</span><br><span class="line">        list.<span class="built_in">pushHead</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    cout&lt;&lt;list.<span class="built_in">toString</span>()&lt;&lt;endl;</span><br><span class="line">    list.<span class="built_in">popHead</span>();</span><br><span class="line">    cout&lt;&lt;list.<span class="built_in">toString</span>()&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\cpp&gt; g++ -std=c++11 main.cpp -O0 -o main</span><br><span class="line">PS C:\Users\86135\Desktop\cpp&gt; ./main</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">LinkedNode ctor called</span><br><span class="line">9  8  7  6  5  4  3  2  1  0</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">8  7  6  5  4  3  2  1  0</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br><span class="line">LinkedNode dtor called</span><br></pre></td></tr></table></figure>

<p>没有任何手动delete的地方,但是dtor依然被调用了</p>
<p><code>shared_ptr&lt;LinkedNode&gt;</code>和<code>LinkedNode *</code>,在用法上一模一样,都是使用箭头调用成员函数</p>
<p>但是<code>shared_ptr&lt;LinkedNode&gt;</code>实际上封装了一个<code>LinkedNode *</code>,前者还有其他功能</p>
<p>比如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> node=<span class="built_in">make_shared</span>&lt;LinkedNode&gt;(<span class="number">0</span>,<span class="literal">nullptr</span>);</span><br><span class="line">cout&lt;&lt;hex&lt;&lt;node&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;node.<span class="built_in">get</span>()&lt;&lt;endl;<span class="comment">//get返回裸指针LinkedNode*</span></span><br></pre></td></tr></table></figure>

<p>node可以使用点号调用shared_ptr类的成员函数,使用箭头符号调用的是其托管对象类的成员函数</p>
<h2 id="继承构造函数"><a href="#继承构造函数" class="headerlink" title="继承构造函数"></a>继承构造函数</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iomanip&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">int</span> _x , <span class="type">int</span> _y ) :</span><br><span class="line">        __x(_x), __y(_y)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;constructor called&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">x</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">y</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __y;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">toString</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(&quot;</span>+<span class="built_in">to_string</span>(__x)+<span class="string">&quot;,&quot;</span>+<span class="built_in">to_string</span>(__y)+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TaggedPoint</span>:<span class="keyword">public</span> Point&#123;</span><br><span class="line">    string __tag;</span><br><span class="line">    <span class="keyword">using</span> Point::Point;<span class="comment">//继承父类所有构造函数</span></span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TaggedPoint</span>(<span class="type">int</span> _x,<span class="type">int</span> _y,string _tag):<span class="built_in">TaggedPoint</span>(_x,_y)&#123;<span class="comment">//委托构造函数,也是c++11特性</span></span><br><span class="line">        __tag=_tag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function">string <span class="title">toString</span><span class="params">()</span><span class="type">const</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> __tag+Point::<span class="built_in">toString</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">TaggedPoint <span class="title">A</span><span class="params">(<span class="number">1</span>,<span class="number">2</span>)</span></span>;<span class="comment">//TaggedPoint本没有两个int的构造函数,但是其父类有</span></span><br><span class="line">    cout&lt;&lt;A.<span class="built_in">toString</span>()&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="nullptr"><a href="#nullptr" class="headerlink" title="nullptr"></a>nullptr</h2><p>之前表示空指针都使用NULL,而实际上这是个int 0</p>
<p>c++11之后表示空指针的常量是nullptr</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">void</span> *ptr)</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;ptr func called&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(<span class="type">int</span> value)</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;value func called&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">func</span>(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="built_in">func</span>(<span class="literal">NULL</span>);<span class="comment">//二义性警告,两个重载函数都是次完美匹配,</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\cpp&gt; g++ -std=c++11 main.cpp  -O0 -o main </span><br><span class="line">main.cpp: In <span class="keyword">function</span> <span class="string">&#x27;int main()&#x27;</span>:</span><br><span class="line">main.cpp:57:14: warning: passing NULL to non-pointer argument 1 of <span class="string">&#x27;void func(int)&#x27;</span> [-Wconversion-null]</span><br><span class="line">     func(NULL);</span><br><span class="line">              ^</span><br><span class="line">PS C:\Users\86135\Desktop\cpp&gt; ./main</span><br><span class="line">ptr func called</span><br><span class="line">value func called</span><br></pre></td></tr></table></figure>



<h2 id="final关键字"><a href="#final关键字" class="headerlink" title="final关键字"></a>final关键字</h2><p>final修饰的类不允许被继承,不允许虚函数重载</p>
<h2 id="override关键字"><a href="#override关键字" class="headerlink" title="override关键字"></a>override关键字</h2><p>override关键字修饰子类成员函数,保证是在重写父类同名函数,否则报错</p>
<h2 id="default构造函数"><a href="#default构造函数" class="headerlink" title="default构造函数"></a>default构造函数</h2><p>在之前的c++中,如果一个类没有显式写构造函数,那么编译器会自动加上一个无参的隐式构造函数,这个构造函数几乎啥也不干(在汇编层面上会哦用子类虚表覆盖父类虚表,算是干了点东西,但是源代码层面无法体现)</p>
<p>假如显示定义了一个带参数的构造函数,则编译器不会再隐式添加无参构造函数,这时候就不能无参构造了</p>
<p>比如这样就会报编译错:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&#123;</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">int</span> _x,<span class="type">int</span> _y):__x(_x),__y(_y)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;ctor called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Point A;<span class="comment">//尝试调用缺省或者无参构造函数失败</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解决方法是另写一个无参的构造函数</p>
<p>在c++11中的解决方法是<code>Point()=default;</code></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span>&#123;</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">    <span class="built_in">Point</span>()=<span class="keyword">default</span>;<span class="comment">//解决方法</span></span><br><span class="line">    <span class="built_in">Point</span>(<span class="type">int</span> _x,<span class="type">int</span> _y):__x(_x),__y(_y)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;ctor called&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    Point A;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个构造函数不允许有函数体,其作用就相当于缺省构造函数</p>
<h2 id="delete关键字"><a href="#delete关键字" class="headerlink" title="delete关键字"></a>delete关键字</h2><p>之前在一个C++类中,即使啥函数没写,编译器也会自动生成至少俩函数</p>
<p><code>operator=</code>和<code>copy ctor</code></p>
<p>然而我就不想让他生成这俩函数,禁止对象拷贝</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">in <span class="keyword">class</span> <span class="title class_">LinkedNode</span>:</span><br><span class="line">LinkedNode <span class="keyword">operator</span>=(<span class="type">const</span> LinkedNode &amp;)=<span class="keyword">delete</span>;</span><br><span class="line"><span class="built_in">LinkedNode</span>(<span class="type">const</span> LinkedNode&amp;)=<span class="keyword">delete</span>;</span><br></pre></td></tr></table></figure>

<p>此时主函数中想用一个节点拷贝另一个节点,编译报错</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221221205948052.png" alt="image-20221221205948052"></p>
<p>实际应用比如在basic_ostream中,delete用来禁用对char8_t*类型的流输出运算</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cpp_char8_t <span class="comment">// These deleted overloads are specified in P1423.</span></span></span><br><span class="line"><span class="comment">// don&#x27;t insert a UTF-8 NTBS</span></span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Traits</span>&gt;</span><br><span class="line">basic_ostream&lt;<span class="type">char</span>, _Traits&gt;&amp; <span class="keyword">operator</span>&lt;&lt;(basic_ostream&lt;<span class="type">char</span>, _Traits&gt;&amp;, <span class="type">const</span> <span class="type">char8_t</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">_Traits</span>&gt;</span><br><span class="line">basic_ostream&lt;<span class="type">wchar_t</span>, _Traits&gt;&amp; <span class="keyword">operator</span>&lt;&lt;(basic_ostream&lt;<span class="type">wchar_t</span>, _Traits&gt;&amp;, <span class="type">const</span> <span class="type">char8_t</span>*) = <span class="keyword">delete</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="explicit关键字"><a href="#explicit关键字" class="headerlink" title="explicit关键字"></a>explicit关键字</h2><p>explicit修饰的构造函数,不允许参数隐式类型转换</p>
<h2 id="constexpr关键字"><a href="#constexpr关键字" class="headerlink" title="constexpr关键字"></a>constexpr关键字</h2><p>const和constexpr的区别</p>
<p>之前使用的const名为”常量”实际上是”常变量”</p>
<p>const修饰的变量和未经其修饰的变量只有源代码层面的级别,想要修改const变量会被编译器安全检查阻止.然而一旦通过了编译,到了汇编层面,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int a=10</span><br><span class="line">const int b=10</span><br></pre></td></tr></table></figure>

<p>两者的底层存储没有任何区别</p>
<p>反汇编根本看不出const属性,顶多可以发现对b只有read操作,没有任何write操作</p>
<p>constexpr是真的常量</p>
<p>在编译阶段,编译器把所有能够计算得出的constexpr替换成字面量,constexpr修饰的函数会用其返回值字面量替换函数调用</p>
<p>实在计算不出来的,比如需要链接其他模块函数才能算出来的,编译器就会忽略constexpr修饰,视为普通变量或者函数</p>
<h2 id="enum-class"><a href="#enum-class" class="headerlink" title="enum class"></a>enum class</h2><p>之前的c++中,枚举类型实际上就是给int类型起了个别名</p>
<p>比如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Color</span>&#123;</span><br><span class="line">    WHITE,BLACK,RED</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Direction</span>&#123;</span><br><span class="line">    SOUTH,NORTH,EAST,WEST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;WHITE&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;SOUTH&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">if</span>(WHITE==SOUTH)&#123;</span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;yes&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编译链接时会警告不同类的枚举相比较</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\cpp&gt; g++ -std=c++11 main.cpp -O0 -o main</span><br><span class="line">main.cpp: In <span class="keyword">function</span> <span class="string">&#x27;int main()&#x27;</span>:</span><br><span class="line">main.cpp:14:15: warning: comparison between <span class="string">&#x27;enum Color&#x27;</span> and <span class="string">&#x27;enum Direction&#x27;</span> [-Wenum-compare]</span><br><span class="line">     <span class="keyword">if</span>(WHITE==SOUTH)&#123;</span><br><span class="line">               ^</span><br><span class="line">PS C:\Users\86135\Desktop\cpp&gt; ./main</span><br><span class="line">0  0</span><br><span class="line"><span class="built_in">yes</span></span><br></pre></td></tr></table></figure>

<p>也就是说不同的枚举没有严格的类型区别</p>
<p>c++11就修正了这一点</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Color</span>&#123;</span><br><span class="line">    WHITE,BLACK,RED</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Direction</span>&#123;</span><br><span class="line">    SOUTH,NORTH,EAST,WEST</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;Color::WHITE&lt;&lt;<span class="string">&quot;  &quot;</span>&lt;&lt;Direction::SOUTH&lt;&lt;endl;<span class="comment">//不允许打印!&lt;&lt;没有重载Color::WHITE类型</span></span><br><span class="line">    <span class="keyword">if</span>(Color::WHITE==Direction::SOUTH)&#123;<span class="comment">//不允许比较!没有重载==运算符</span></span><br><span class="line">        cout&lt;&lt;<span class="string">&quot;yes&quot;</span>&lt;&lt;endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="非受限联合体"><a href="#非受限联合体" class="headerlink" title="非受限联合体"></a>非受限联合体</h2><p>感觉用处不是很大,了解一下POD类型吧</p>
<h3 id="POD类型"><a href="#POD类型" class="headerlink" title="POD类型"></a>POD类型</h3><p>Plain Old Data,平凡的老的数据</p>
<p>C的所有数据类型,包括基本数据类型和任何结构体,都是POD,</p>
<p>可以这样理解POD:其内存布局是很规则的,两个同类的POD之间可以直接用memcpy拷贝数据.啥意思呢?</p>
<p>比如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span>&#123;</span><br><span class="line">	<span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">&#125;Point;</span><br><span class="line">Point A;</span><br><span class="line">Point B;</span><br><span class="line">A.__x=<span class="number">10</span>;</span><br><span class="line">A.__y=<span class="number">20</span>;</span><br><span class="line"><span class="built_in">memcpy</span>(B,A,<span class="built_in">sizeof</span>(B));</span><br><span class="line"><span class="comment">//此后B.__x=10,B.__y=20</span></span><br></pre></td></tr></table></figure>

<p>B和A是同类型的POD,那么A直接拷贝给B,A的第一个字节给B的第一个字节,A的第二个字节给B的第二个字节…显然组装起来的B,其前四个字节就是<code>__x</code>,后四个字节就是__y&#96;,毋庸置疑的</p>
<p>c++11中可以使用<code>std::is_trivial&lt;T&gt;::value</code>来检查一个类型是否是POD</p>
<p>比如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">STRUCTPOINT</span>&#123;</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">    <span class="built_in">STRUCTPOINT</span>()=<span class="keyword">default</span>;<span class="comment">//有缺省构造函数仍然是POD</span></span><br><span class="line">&#125;Point;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">MyPoint</span>&#123;</span><br><span class="line">    <span class="type">int</span> __x;</span><br><span class="line">    <span class="type">int</span> __y;</span><br><span class="line">    <span class="built_in">MyPoint</span>(<span class="type">int</span> _x,<span class="type">int</span> _y):__x(_x),__y(_y)&#123;&#125;<span class="comment">//有非缺省构造函数,不是POD</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout&lt;&lt;is_trivial&lt;Point&gt;::value&lt;&lt;endl;</span><br><span class="line">    cout&lt;&lt;is_trivial&lt;MyPoint&gt;::value&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\<span class="number">86135</span>\Desktop\cpp&gt; g++ -std=c+<span class="number">+11</span> main.cpp -O0 -o main</span><br><span class="line">PS C:\Users\<span class="number">86135</span>\Desktop\cpp&gt; ./main</span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>如果一个类有非缺省构造函数,或者有虚函数,虚基类,或者成员变量有不同的访问修饰或者第一个成员不是自己的,或者有父类并且父类本类都有成员变量,他就是非POD</p>
<p>这一点好理解</p>
<p>有虚函数的类,其基地址开始的4个字节是虚表指针,不是其成员,使用memcpy也会拷贝虚表指针</p>
<h2 id="assertion"><a href="#assertion" class="headerlink" title="assertion"></a>assertion</h2><p>编译阶段的断言</p>
<p><code>static_assert(bool,string_literal)</code>如果前面的bool表达式为真,则通过编译</p>
<p>否则报告后面的字符串字面量,然后终止编译</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="literal">true</span>,<span class="string">&quot;字符串字面量&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样可以通过编译,啥也不会发生</p>
<p>如果这样写就不让通过:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20221221214450658.png" alt="image-20221221214450658"></p>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/impossible/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/impossible/">1</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/impossible/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/11/">11</a><a class="extend next" rel="next" href="/impossible/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
