<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Cascadia Code:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"deutschball.github.io","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"万一找到了呢","hits_empty":"你说的 ${query} 我怎么找不着呢 ","hits_stats":"找到了 ${hits} 个结果，用时 ${time} 毫秒"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":-1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="xctf攻防世界-reverse-新手村   image-20220507171516740  002logmein main函数 12345678910111213141516171819202122232425262728293031323334353637main proc nearvar_90&#x3D; qword ptr -90h;很奇怪的是,申请了好多变量,有四字的也有双字的还有">
<meta property="og:type" content="article">
<meta property="og:title" content="xctf攻防世界-reverse-新手村">
<meta property="og:url" content="http://deutschball.github.io/2022/05/07/xctf-reverse-%E6%96%B0%E6%89%8B12%E9%A2%98/index.html">
<meta property="og:site_name" content="dustland">
<meta property="og:description" content="xctf攻防世界-reverse-新手村   image-20220507171516740  002logmein main函数 12345678910111213141516171819202122232425262728293031323334353637main proc nearvar_90&#x3D; qword ptr -90h;很奇怪的是,申请了好多变量,有四字的也有双字的还有">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2022-05-07T09:16:00.000Z">
<meta property="article:modified_time" content="2022-06-03T08:27:03.010Z">
<meta property="article:author" content="dustball">
<meta property="article:tag" content="xctf攻防世界">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://deutschball.github.io/2022/05/07/xctf-reverse-%E6%96%B0%E6%89%8B12%E9%A2%98/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>xctf攻防世界-reverse-新手村 | dustland</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">dustland</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">dustball in dustland</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

      
    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/deutschball" class="github-corner" title="Follow me on GayHub" aria-label="Follow me on GayHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://deutschball.github.io/2022/05/07/xctf-reverse-%E6%96%B0%E6%89%8B12%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
      <meta itemprop="name" content="dustball">
      <meta itemprop="description" content="dustland">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="dustland">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          xctf攻防世界-reverse-新手村
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-07 17:16:00" itemprop="dateCreated datePublished" datetime="2022-05-07T17:16:00+08:00">2022-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-06-03 16:27:03" itemprop="dateModified" datetime="2022-06-03T16:27:03+08:00">2022-06-03</time>
              </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="xctf攻防世界-reverse-新手村">xctf攻防世界-reverse-新手村</h1>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507171516740.png"
alt="image-20220507171516740" />
<figcaption aria-hidden="true">image-20220507171516740</figcaption>
</figure>
<h2 id="logmein">002logmein</h2>
<h3 id="main函数">main函数</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">var_90= qword ptr -90h;很奇怪的是,申请了好多变量,有四字的也有双字的还有字节的</span><br><span class="line">var_88= qword ptr -88h</span><br><span class="line">var_80= qword ptr -80h</span><br><span class="line">var_74= dword ptr -74h</span><br><span class="line">var_70= qword ptr -70h</span><br><span class="line">var_64= dword ptr -64h</span><br><span class="line">var_60= dword ptr -60h</span><br><span class="line">var_5C= dword ptr -5Ch</span><br><span class="line">var_57= byte ptr -57h</span><br><span class="line">var_56= byte ptr -56h</span><br><span class="line">var_55= byte ptr -55h</span><br><span class="line">var_54= dword ptr -54h</span><br><span class="line">s= byte ptr -50h</span><br><span class="line">var_2C= dword ptr -2Ch</span><br><span class="line">var_28= qword ptr -28h</span><br><span class="line">var_20= byte ptr -20h</span><br><span class="line">var_4= dword ptr -4</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">;开端:</span><br><span class="line">push    rbp</span><br><span class="line">mov     rbp, rsp</span><br><span class="line">sub     rsp, 90h</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mov     rdi, offset format ; &quot;Welcome to the RC3 secure password gues&quot;...</span><br><span class="line">mov     [rbp+var_4], 0</span><br><span class="line"></span><br><span class="line">;一系列蜜汁操作</span><br><span class="line">mov     rax, ds:qword_4008B0					;0x5E54525F4C41223A;</span><br><span class="line">mov     qword ptr [rbp+var_20], rax</span><br><span class="line">mov     rax, ds:qword_4008B8					;0x342F362B3F2E2A4C;</span><br><span class="line">mov     qword ptr [rbp+var_20+8], rax</span><br><span class="line">mov     cx, ds:word_4008C0						;0x36;</span><br><span class="line">mov     word ptr [rbp+var_20+10h], cx</span><br></pre></td></tr></table></figure>
<p>分析一下这里将数据传来传去干了啥</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506112847647.png"
alt="image-20220506112847647" />
<figcaption aria-hidden="true">image-20220506112847647</figcaption>
</figure>
<p><code>var_20</code>占据了栈上<code>rbp-20到rbp-9</code>共24字节空间</p>
<p><code>0x5E54525F4C41223A</code>放在栈上<code>var_20</code>,占用四字8字节,</p>
<p><code>0x342F362B3F2E2A4C</code>放在栈上<code>var_20+8</code>,恰好顺着刚才的<code>var_20</code>存放八个字节</p>
<p><code>0x36</code>放在栈上<code>var_20+10h</code>即<code>var_20+16</code>也是顺着放的</p>
<p>到此为止,<code>var_20</code>一共使用了<code>0~16</code>共17字节,十六进制的表示为:<code>0x36342F362B3F2E2A4C5E54525F4C41223A</code></p>
<p>表示成ascii码为:<code>64/6+?.*L^TR_LA":</code>,下面的字符啥也没写即为<code>'\0'</code>结束符号,一定要考虑清楚小端模式</p>
<p>由此可见<code>var_20</code>应当是开在栈上的一个字符数组,大小是<code>24bytes</code>,实际使用<code>17bytes</code></p>
<p>然后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov     rax, qword ptr ds:byte_4008D0			 ;<span class="number">0x65626D61726168</span>;</span><br><span class="line">mov     [rbp+var_28], rax</span><br></pre></td></tr></table></figure>
<p><code>0x65626D61726168</code>一个四字放在栈中<code>var_28</code>上,<code>var_28</code>恰好也是8字节四字长度,表示成8个ascii字符为<code>ebmarah</code>刚好7个字符</p>
<p>然后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     [rbp+var_2C], 7</span><br></pre></td></tr></table></figure>
<p><code>var_2C</code>是个双字但是却只放了一个7,可能会与<code>var_28</code>长度7有染</p>
<p>接着下面的反汇编应该调整一下指令顺序,调用<code>_printf</code>或者<code>_scanf</code>函数返回后立刻处理eax中的返回值,看起来比较直观,并且不影响程序逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">;打印第一句废话</span><br><span class="line">mov     rdi, offset format ; &quot;Welcome to the RC3 secure password gues&quot;...</span><br><span class="line">mov     ...</span><br><span class="line">call    _printf				;printf函数返回值是实际打印字符数</span><br><span class="line">mov     [rbp+var_5C], eax	</span><br><span class="line">mov     al, 0</span><br><span class="line"></span><br><span class="line">;打印第二句废话</span><br><span class="line">mov     rdi, offset aToContinueYouM ; &quot;To continue, you must enter the correct&quot;...</span><br><span class="line">call    _printf</span><br><span class="line">mov     [rbp+var_60], eax</span><br><span class="line">mov     al, 0</span><br><span class="line"></span><br><span class="line">;打印第三句废话</span><br><span class="line">mov     rdi, offset aEnterYourGuess ; &quot;Enter your guess: &quot;</span><br><span class="line">call    _printf</span><br><span class="line">mov     [rbp+var_64], eax</span><br><span class="line">mov     al, 0</span><br><span class="line"></span><br><span class="line">;调用scanf获取输入</span><br><span class="line">mov     rdi, offset a32s ; &quot;%32s&quot;</span><br><span class="line">lea     rsi, [rbp+s]    ; s作为scanf的缓冲区,获取输入</span><br><span class="line">call    ___isoc99_scanf		;scanf返回值是实际获取到的输入字符数</span><br><span class="line">mov     [rbp+var_74], eax	;输入字符数-&gt;eax</span><br><span class="line"></span><br><span class="line">;获取输入长度</span><br><span class="line">lea     rdi, [rbp+var_20]	;&amp;var_20-&gt;rdi</span><br><span class="line">lea     rsi, [rbp+s]	    ;&amp;s-&gt;rsi</span><br><span class="line">mov     [rbp+var_70], rdi	;&amp;var_20-&gt;rdi-&gt;var_70</span><br><span class="line">mov     rdi, rsi        	;&amp;s-&gt;rdi </span><br><span class="line">call    _strlen				;strlen(s)-&gt;rax</span><br><span class="line">mov     [rbp+var_80], rax	;strlen(s)-&gt;rax-&gt;var_80</span><br><span class="line"></span><br><span class="line">;获取存好的字符串长度</span><br><span class="line">mov     rdi, [rbp+var_70] 	;&amp;var_20-&gt;var_70-&gt;rdi	 </span><br><span class="line">call    _strlen				;strlen(&amp;var_20)-&gt;rax</span><br><span class="line">mov     rsi, [rbp+var_80]	;strlen(s)-&gt;var_80-&gt;rsi</span><br><span class="line"></span><br><span class="line">;比较两个长度是否相同</span><br><span class="line">cmp     rsi, rax			;比较s和var_20的长度(17)是否一致,即判断是否输入了17个字符</span><br><span class="line">jnb     loc_400700			;如果不一致则跳转报告失败,否则继续检查</span><br></pre></td></tr></table></figure>
<p>下面即将进入循环,现在我们已知的是输入要17个字符</p>
<h4 id="循环体分析">循环体分析</h4>
<p><code>sub_4007c0</code>函数报告失败,不妨给他起名<code>failure</code></p>
<p><code>sub_4007F0</code>函数报告成功,不妨给他起名<code>success</code></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506120601387.png"
alt="image-20220506120601387" />
<figcaption aria-hidden="true">image-20220506120601387</figcaption>
</figure>
<p>进入循环之前有一个<code>var_54=0</code>很自然可以想到的一种循环结构:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">	...</span><br><span class="line">	++i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里<code>var_54</code>是循环变量i吗?</p>
<p>再看最下方的<code>loc_40079E</code>,其中对<code>var_54</code>进行了++,然后跳转<code>loc_400707</code>即循环开头,那么<code>var_54</code>基本上可以确定为循环变量i了</p>
<p>将反汇编翻译为伪代码</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506124657651.png"
alt="image-20220506124657651" />
<figcaption aria-hidden="true">image-20220506124657651</figcaption>
</figure>
<p>解密算法已经很明显了,把<code>var_20</code>和<code>var_28</code>都看成字符数组然后<code>decrypt[i]=var_20[i]^var_28[i%7]</code>即可</p>
<h3 id="解密算法">解密算法</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">string var_20 = <span class="string">&quot;64/6+?.*L^TR_LA\&quot;:&quot;</span>;</span><br><span class="line">string var_28 = <span class="string">&quot;ebmarah&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="built_in">reverse</span>(var_<span class="number">20.</span><span class="built_in">begin</span>(), var_<span class="number">20.</span><span class="built_in">end</span>());<span class="comment">//反转一下是因为string字符串最左面的字符是低位,而小端模式下最右边是低位</span></span><br><span class="line">	<span class="built_in">reverse</span>(var_<span class="number">28.</span><span class="built_in">begin</span>(), var_<span class="number">28.</span><span class="built_in">end</span>());</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; var_<span class="number">20.</span><span class="built_in">size</span>(); ++i) &#123;</span><br><span class="line">		<span class="type">int</span> temp = (<span class="type">int</span>)var_20[i] ^ (<span class="type">int</span>)var_28[i % <span class="number">7</span>];</span><br><span class="line">		cout &lt;&lt; (<span class="type">char</span>)temp;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RC3-2016-XORISGUD</span><br></pre></td></tr></table></figure>
<h2 id="insanity">003insanity</h2>
<h3 id="信息收集">信息收集</h3>
<p>每次运行都根开盲盒似的,等待大约5秒之后给出一个结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span><br><span class="line">└─$ ./insanity</span><br><span class="line">Reticulating splines, please <span class="built_in">wait</span>..</span><br><span class="line"></span><br><span class="line">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span><br><span class="line">└─$ ./insanity</span><br><span class="line">Reticulating splines, please <span class="built_in">wait</span>..</span><br><span class="line">Your ability to hack is about as good as my ability to have free will.</span><br><span class="line"></span><br><span class="line">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span><br><span class="line">└─$ ./insanity</span><br><span class="line">Reticulating splines, please <span class="built_in">wait</span>..</span><br><span class="line"><span class="comment">#define YOU &quot;massive failure&quot;</span></span><br><span class="line"></span><br><span class="line">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span><br><span class="line">└─$ ./insanity</span><br><span class="line">Reticulating splines, please <span class="built_in">wait</span>..</span><br><span class="line">I<span class="string">&#x27;ve got a good feeling about this one..... wait no. Maybe next time.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span></span><br><span class="line"><span class="string">└─$ ./insanity</span></span><br><span class="line"><span class="string">Reticulating splines, please wait..</span></span><br><span class="line"><span class="string">#define YOU &quot;massive failure&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span></span><br><span class="line"><span class="string">└─$ ./insanity</span></span><br><span class="line"><span class="string">Reticulating splines, please wait..</span></span><br><span class="line"><span class="string">Your ability to hack is about as good as my ability to have free will.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span></span><br><span class="line"><span class="string">└─$ ./insanity</span></span><br><span class="line"><span class="string">Reticulating splines, please wait..</span></span><br><span class="line"><span class="string">rm -rf / : Permission denied</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">┌──(kali㉿Executor)-[/mnt/c/Users/86135/Desktop/xctf12/insanity]</span></span><br><span class="line"><span class="string">└─$ ./insanity</span></span><br><span class="line"><span class="string">Reticulating splines, please wait..</span></span><br><span class="line"><span class="string">Your ability to hack is about as good as my ability to have free will.</span></span><br></pre></td></tr></table></figure>
<h3 id="静态分析">静态分析</h3>
<p>一张图截完,题啃腚不难</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507122441995.png"
alt="image-20220507122441995" />
<figcaption aria-hidden="true">image-20220507122441995</figcaption>
</figure>
<p>实际上点进s或者任意一个存好的字符串到rodata区看一下就找到答案了</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507171407247.png"
alt="image-20220507171407247" />
<figcaption aria-hidden="true">image-20220507171407247</figcaption>
</figure>
<p>下面分析一下程序逻辑</p>
<p>猜测是这样的:假设rodata区有n条语句组成一个数组,生成一个随机数然后对n取模,取该值对应下标的语句打印</p>
<p><code>main</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">; int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">public main</span><br><span class="line">main proc near</span><br><span class="line"></span><br><span class="line">argc= dword ptr  8</span><br><span class="line">argv= dword ptr  0Ch</span><br><span class="line">envp= dword ptr  10h</span><br><span class="line"></span><br><span class="line">; __unwind &#123;</span><br><span class="line">push    ebp</span><br><span class="line">mov     ebp, esp</span><br><span class="line">and     esp, 0FFFFFFF0h													</span><br><span class="line">sub     esp, 10h</span><br><span class="line">mov     dword ptr [esp], offset s ; &quot;Reticulating splines, please wait..&quot;		;废话压栈</span><br><span class="line">call    _puts																;打印废话</span><br><span class="line">mov     dword ptr [esp], 5 ; seconds										;5秒压栈</span><br><span class="line">call    _sleep																;休眠5秒</span><br><span class="line"></span><br><span class="line">;生成随机数种子</span><br><span class="line">mov     dword ptr [esp], 0 ; timer											;time(0)</span><br><span class="line">call    _time</span><br><span class="line">mov     [esp], eax      ; seed												;time(0)的返回值作为参数</span><br><span class="line">call    _srand																;srand(time(0))</span><br><span class="line"></span><br><span class="line">;获得一个随机数</span><br><span class="line">call    _rand																;rand()-&gt;eax</span><br><span class="line">mov     ecx, eax															;rand()-&gt;eax-&gt;ecx</span><br><span class="line"></span><br><span class="line">;下面这一系列操作好迷啊</span><br><span class="line">mov     edx, 0CCCCCCCDh														;3435973837这个魔数是啥呢</span><br><span class="line">mul     edx																	;eax*edx-&gt;edx:eax</span><br><span class="line">shr     edx, 3																;edx/8</span><br><span class="line">lea     eax, [edx+edx*4]													;5edx-&gt;eax</span><br><span class="line">add     eax, eax															;10edx-&gt;eax</span><br><span class="line">sub     ecx, eax															;10edx</span><br><span class="line">;分析了一阵子屁用没有</span><br><span class="line"></span><br><span class="line">;取对应字符串并打印</span><br><span class="line">mov     eax, strs[ecx*4]													;ecx是下标,相邻亮指针偏移4字节</span><br><span class="line">mov     [esp], eax      ; s													</span><br><span class="line">call    _puts																</span><br><span class="line">xor     eax, eax															</span><br><span class="line">leave</span><br><span class="line">retn</span><br><span class="line">; &#125; // starts at 80483F0</span><br><span class="line">main endp</span><br></pre></td></tr></table></figure>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507162916682.png"
alt="image-20220507162916682" />
<figcaption aria-hidden="true">image-20220507162916682</figcaption>
</figure>
<p>全篇没有看出一个取模来,难道是我老眼昏花了?</p>
<h3 id="取模时的编译优化">取模时的编译优化</h3>
<p>这里应该就是取模,但是其实现好迷啊</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">call    _rand																;rand()-&gt;eax假设为16</span><br><span class="line">mov     ecx, eax															;rand()=16-&gt;eax-&gt;ecx</span><br><span class="line"></span><br><span class="line">;下面这一系列操作好迷啊</span><br><span class="line">mov     edx, 0CCCCCCCDh														;3435973837这个魔数是啥呢</span><br><span class="line">mul     edx																	;eax*edx-&gt;edx:eax=Ch:CCCCCCD0h</span><br><span class="line">shr     edx, 3																;edx/8=C/8=1</span><br><span class="line">lea     eax, [edx+edx*4]													;		5-&gt;eax</span><br><span class="line">add     eax, eax															;		10-&gt;eax</span><br><span class="line">sub     ecx, eax															;	16-10=6			</span><br></pre></td></tr></table></figure>
<p><a
target="_blank" rel="noopener" href="https://blog.csdn.net/Wang_1997/article/details/104775975">(5条消息)
逆向-取模运算_嘻嘻兮的博客-CSDN博客_取模的逆运算</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507170255414.png"
alt="image-20220507170255414" />
<figcaption aria-hidden="true">image-20220507170255414</figcaption>
</figure>
<h2 id="re1">006re1</h2>
<h3 id="信息收集-1">信息收集</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\xctf12\re1&gt; ./re1   </span><br><span class="line">欢迎来到DUTCTF呦</span><br><span class="line">这是一道很可爱很简单的逆向题呦</span><br><span class="line">输入flag吧:123456</span><br><span class="line">flag不太对呦，再试试呗，加油呦</span><br><span class="line">请按任意键继续. . . </span><br></pre></td></tr></table></figure>
<p>输入flag之后必然会flag不对,然后程序阻塞,并且提示"请按任意键继续..."</p>
<p>这个题的图视图竟然可以用一个截屏截下来,必然简单</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507101716875.png"
alt="image-20220507101716875" />
<figcaption aria-hidden="true">image-20220507101716875</figcaption>
</figure>
<h3 id="逆向分析">逆向分析</h3>
<h4 id="开端">开端</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;开端</span><br><span class="line">.text:00401000                 push    ebp</span><br><span class="line">.text:00401001                 mov     ebp, esp</span><br><span class="line">.text:00401003                 sub     esp, 44h</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="防止栈缓冲区溢出">防止栈缓冲区溢出</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00401006                 mov     eax, ___security_cookie</span><br><span class="line">.text:0040100B                 xor     eax, ebp</span><br><span class="line">.text:0040100D                 mov     [ebp+var_4], eax</span><br></pre></td></tr></table></figure>
<h4
id="装填flag指令顺序有改动但是不影响逻辑">装填flag,指令顺序有改动但是不影响逻辑</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:00401018                 xor     eax, eax					;eax归零</span><br><span class="line">.text:00401010                 movdqu  xmm0, ds:xmmword_413E34	;3074656D30633165577B465443545544h</span><br><span class="line">															;即 0tem0c1eW&#123;FTCTUD</span><br><span class="line">.text:0040101F                 movdqu  [ebp+var_44], xmm0			;0tem0c1eW&#123;FTCTUD-&gt;var_44	</span><br><span class="line">.text:00401024                 mov     [ebp+var_2C], eax			;eax=0-&gt;var_2C	</span><br><span class="line">.text:00401027                 movq    xmm0, ds:qword_413E44		;7D465443545544h即 &#125;FTCTUD</span><br><span class="line">.text:0040102F                 movq    [ebp+var_34], xmm0			;&#125;FTCTUD -&gt;var_34</span><br><span class="line">.text:00401034                 mov     [ebp+var_28], ax				;0-&gt;var_28</span><br></pre></td></tr></table></figure>
<h4 id="打印废话">打印废话</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:0040101A                 push    offset aDutctf  ; &quot;欢迎来到DUTCTF呦\n&quot;	;废话压栈作为参数</span><br><span class="line">.text:00401038                 call    _printf						;打印第一句废话</span><br><span class="line">.text:0040103D                 push    offset asc_413E60 ; &quot;这是一道很可爱很简单的逆向题呦\n&quot;</span><br><span class="line">.text:00401042                 call    _printf</span><br><span class="line">.text:00401047                 push    offset aFlag    ; &quot;输入flag吧:&quot;</span><br><span class="line">.text:0040104C                 call    _printf</span><br></pre></td></tr></table></figure>
<h4 id="获取输入输入存储到var_24">获取输入,输入存储到var_24</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00401051                 lea     eax, [ebp+var_24]</span><br><span class="line">.text:00401054                 push    eax</span><br><span class="line">.text:00401055                 push    offset Format   ; &quot;%s&quot;</span><br><span class="line">.text:0040105A                 call    _scanf</span><br></pre></td></tr></table></figure>
<h4 id="加载输入和flag">加载输入和flag</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:0040105F                 add     esp, 14h</span><br><span class="line">.text:00401062                 lea     eax, [ebp+var_24]		;输入字符串的地址</span><br><span class="line">.text:00401065                 lea     ecx, [ebp+var_44]		;flag的地址</span><br></pre></td></tr></table></figure>
<h4
id="循环比较输入和flag每次比较两个字节">循环比较输入和flag,每次比较两个字节</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:00401068 loc_401068:                             ; CODE XREF: _main+82↓j</span><br><span class="line">.text:00401068                 mov     dl, [ecx]			;flag[0]值放在dl</span><br><span class="line">.text:0040106A                 cmp     dl, [eax]			;比较flag[0]和输入值的大小</span><br><span class="line">.text:0040106C                 jnz     short loc_401088		;如果不为零即输入和flag不相等则跳转,大概率跳转到寄</span><br><span class="line">.text:0040106E                 test    dl, dl				;dl中存放的是flag[i]如果为0说明遍历完毕,循环跳出</span><br><span class="line">.text:00401070                 jz      short loc_401084		;如果遍历完毕则跳转loc_401084</span><br><span class="line">.text:00401072                 mov     dl, [ecx+1]			</span><br><span class="line">.text:00401075                 cmp     dl, [eax+1]</span><br><span class="line">.text:00401078                 jnz     short loc_401088</span><br><span class="line">.text:0040107A                 add     ecx, 2</span><br><span class="line">.text:0040107D                 add     eax, 2</span><br><span class="line">.text:00401080                 test    dl, dl</span><br><span class="line">.text:00401082                 jnz     short loc_401068</span><br></pre></td></tr></table></figure>
<h4
id="两种情况置eax为0或1然后合并判断">两种情况,置eax为0或1然后合并判断</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00401084 loc_401084:                             ; CODE XREF: _main+70↑j</span><br><span class="line">.text:00401084                 xor     eax, eax				;eax归零</span><br><span class="line">.text:00401086                 jmp     short loc_40108D		 ;跳转loc_401108D</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00401088 loc_401088:                             ; CODE XREF: _main+6C↑j</span><br><span class="line">.text:00401088                                         ; _main+78↑j</span><br><span class="line">.text:00401088                 sbb     eax, eax			;带借位减法,eax=-1=0xFFFFFFFF</span><br><span class="line">.text:0040108A                 or      eax, 1			;eax=1&amp;0xFFFFFFF=1</span><br></pre></td></tr></table></figure>
<h4 id="合并.根据刚才的eax判断">合并.根据刚才的eax判断</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:0040108D loc_40108D:                             ; CODE XREF: _main+86↑j</span><br><span class="line">.text:0040108D                 test    eax, eax					;判断eax是否为0</span><br><span class="line">.text:0040108F                 jnz     short loc_401098			 ;如果eax!=0则跳转loc_401098</span><br><span class="line">.text:00401091                 push    offset unk_413E90;flag get ;否则eax=0表示成功,&quot;flag get&quot;的地址压栈准备打印</span><br><span class="line">.text:00401096                 jmp     short loc_40109D			 ;跳转loc_40109D</span><br><span class="line">.text:00401098 loc_401098:                             ; CODE XREF: _main+8F↑j</span><br><span class="line">.text:00401098                 push    offset aFlag_0  ; &quot;flag不太对呦&quot;		;&quot;flag不太对呦&quot;地址压栈,准备打印</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="尾声">尾声</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:0040109D loc_40109D:                             ; CODE XREF: _main+96↑j</span><br><span class="line">.text:0040109D                 call    _printf				;打印刚才压入栈中的缓冲区</span><br><span class="line">.text:004010A2                 add     esp, 4				;退栈4</span><br><span class="line">.text:004010A5                 push    offset Command  ; &quot;pause&quot;  ;&quot;pause&quot;串的地址压栈,准备为system函数传参</span><br><span class="line">.text:004010AA                 call    _system					;程序阻塞暂停</span><br><span class="line"></span><br><span class="line">;以下部分可能是在检查栈缓冲区溢出?</span><br><span class="line">.text:004010AF                 mov     ecx, [ebp+var_4]			</span><br><span class="line">.text:004010B2                 add     esp, 4</span><br><span class="line">.text:004010B5                 xor     ecx, ebp        ; StackCookie</span><br><span class="line">.text:004010B7                 xor     eax, eax</span><br><span class="line">.text:004010B9                 call    @__security_check_cookie@4 ; __security_check_cookie(x)</span><br><span class="line">.text:004010BE                 mov     esp, ebp</span><br><span class="line">.text:004010C0                 pop     ebp</span><br><span class="line">.text:004010C1                 retn</span><br><span class="line">.text:004010C1 _main           endp</span><br></pre></td></tr></table></figure>
<h3 id="security_cookie">___security_cookie</h3>
<p><a
target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/c-runtime-library/reference/security-init-cookie?view=msvc-170">参考微软官方文档</a></p>
<blockquote>
<p>全局安全 Cookie 用于在使用 <a
target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/build/reference/gs-buffer-security-check?view=msvc-170">/GS（缓冲区安全检查）</a>编译的代码中和使用异常处理的代码中提供缓冲区溢出保护。
进入受到溢出保护的函数时，Cookie
被置于堆栈之上；退出时，会将堆栈上的值与全局 Cookie 进行比较。
它们之间存在任何差异则表示已经发生缓冲区溢出，并导致该程序的立即终止。</p>
<p>通常， <strong><code>__security_init_cookie</code></strong>
在初始化时由 CRT 调用。 如果你跳过 CRT 初始化（例如，如果使用 <a
target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/build/reference/entry-entry-point-symbol?view=msvc-170"><code>/ENTRY</code></a>
指定入口点），则必须自己调用
<strong><code>__security_init_cookie</code></strong> 。 如果
<strong><code>__security_init_cookie</code></strong> 不调用，全局安全
cookie 将设置为默认值，并且会危及缓冲区溢出保护。 由于攻击者可利用此默认
Cookie 值使缓冲区溢出检查无效，我们建议，在定义自己的入口点时，始终调用
<strong><code>__security_init_cookie</code></strong>。</p>
<p>在进入任何受到溢出保护的函数前，必须调用
<strong><code>__security_init_cookie</code></strong>，否则将检测到虚假的缓冲区溢出。
有关详细信息，请参阅 <a
target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/cpp/error-messages/tool-errors/c-runtime-error-r6035?view=msvc-170">C
运行时错误 R6035</a>。</p>
</blockquote>
<h2 id="game">007game</h2>
<h3 id="信息收集-2">信息收集</h3>
<p>一个32位exe程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">                     |------------／ --------△--------|</span><br><span class="line">                     |-----------------------●--------|</span><br><span class="line">                     |------------／ --------◇--------|</span><br><span class="line">                     |-----------------------■--------|</span><br><span class="line">|--------------------|------------／ --------☆--------|</span><br><span class="line">|                    |------------／ --------▽--------|</span><br><span class="line">|                    |------------／ -----(￣▽￣)／---|</span><br><span class="line">|                    |--------------------(*°▽°)=3--|</span><br><span class="line">二                                                     |</span><br><span class="line">|           by 0x61                                    |</span><br><span class="line">|                                                      |</span><br><span class="line">|------------------------------------------------------|</span><br><span class="line">input n,n(1-8)</span><br><span class="line">1.△ 2.○ 3.◇ 4.□ 5.☆ 6.▽ 7.(￣▽￣)／ 8.(;°Д°) 0.restart</span><br><span class="line">n=</span><br></pre></td></tr></table></figure>
<p>一个开灯和关灯的游戏,大意是:</p>
<p>有八栈灯编号为1到8,每次可以选择一盏灯改变其开关状态,并且其左右的灯也会改变开关状态,认为8号灯和1号灯也是相邻的</p>
<p>初始时八盏灯都是灭的</p>
<p>当八盏灯都亮起来的时候,就给flag</p>
<h3 id="算法解决">算法解决</h3>
<p>首先考虑这个问题是否有解?</p>
<p>方便取模运算,将灯号从0编到7</p>
<table>
<thead>
<tr>
<th>灯号</th>
<th>0</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
</tr>
</thead>
<tbody>
<tr>
<td>初始</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>第一次</td>
<td>1</td>
<td>==1==</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>第二次</td>
<td>1</td>
<td>0</td>
<td>==0==</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>第三次</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>==1==</td>
<td>1</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>第四次</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>==0==</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>第五次</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>==1==</td>
</tr>
</tbody>
</table>
<p>经过五次变化之后,我们可以得到一栈两着的灯,并且其他暗着的灯我们可以视为一直暗着</p>
<p>==因此同时改变三栈灯的状态是可以推出等价于只改变一盏灯的状态==</p>
<p>从1号灯开始的变化导致了7号灯变化</p>
<p>同理可知从2号灯开始的变化导致0号灯变化</p>
<p>...</p>
<p>从i号灯开始的变化导致(i+6)%8的灯变化,其路径为<code>i%8,(i+1)%8,(i+3)%8,(i+4)%8,(i+6)%8</code>共五次变化</p>
<p>则8盏灯全部由暗变亮需要40次变化</p>
<p>可以编写解密脚本打印出这40个数字然后粘贴进game.exe解密</p>
<p>解密脚本</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">change</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;i)</span> &#123;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; i % <span class="number">8</span> + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;<span class="comment">//实际上还得是从1开始编号</span></span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; (i + <span class="number">1</span>) % <span class="number">8</span> + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; (i + <span class="number">3</span>) % <span class="number">8</span> + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; (i + <span class="number">4</span>) % <span class="number">8</span> + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">	<span class="built_in">cout</span> &lt;&lt; (i + <span class="number">6</span>) % <span class="number">8</span> + <span class="number">1</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; ++i) &#123;</span><br><span class="line">		change(i);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>结果粘贴进<code>game.exe</code>之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">done!!! the flag is zsctf&#123;T9is_tOpic_1s_v5ry_int7resting_b6t_others_are_n0t&#125;</span><br></pre></td></tr></table></figure>
<h3 id="静态分析-1">静态分析</h3>
<h4 id="尝试1">尝试1</h4>
<p>假设我们不会玩这个游戏,但是可以猜测,这⑧盏灯是可以都点亮的,诚如是,则程序交出flag,退出</p>
<p>那么在反汇编图视图中应当有一些没有后继的叶子块,即成功的分支</p>
<p>满足条件的块只有一个,如图所示红色块</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506234409960.png"
alt="image-20220506234409960" />
<figcaption aria-hidden="true">image-20220506234409960</figcaption>
</figure>
<p>但是这个块实际上干了和栈有关一些事,具体啥事也不想管了,总之这样猜测是错的</p>
<p>刚才用算法方法点亮了所有的灯,程序也给出了flag但是程序依然在执行</p>
<h4 id="尝试2">尝试2</h4>
<p>每次输入改变灯状态之后会有一个对所有灯的状态检查,要么是在循环开始,要么是在循环尾部</p>
<p>这八盏灯的状态可能是在放在一个字节里的八位,通过按位操作改变状态</p>
<p>或者每个灯一个单元,放在一个数组里</p>
<p>观察反汇编的图视图,发现有这么八块基本相同的结构,大概率就是逐次判断灯的状态</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507075557175.png"
alt="image-20220507075557175" />
<figcaption aria-hidden="true">image-20220507075557175</figcaption>
</figure>
<p>观察其中的一块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mov     eax, 1					;1-&gt;eax</span><br><span class="line">shl     eax, 0					</span><br><span class="line">movzx   ecx, byte_532E28[eax]	  ;byte_532E28[1]-&gt;ecx</span><br><span class="line">cmp     ecx, 1					;cmp byte_532E28[1],1</span><br><span class="line">jnz     short loc_45F671		 ;不为0则表明灯灭,跳转从头再来</span><br></pre></td></tr></table></figure>
<p>那么如果八块均不跳转jnz,那么紧接着就应该给出flag了</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507080122539.png"
alt="image-20220507080122539" />
<figcaption aria-hidden="true">image-20220507080122539</figcaption>
</figure>
<p>结果该函数开头给出了好长一坨字符数组,然后给了这么一个循环,明显是有加密算法的</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507081140177.png"
alt="image-20220507081140177" />
<figcaption aria-hidden="true">image-20220507081140177</figcaption>
</figure>
<p>蓝色块用作打印,和加密算法无关,暂时不关心</p>
<p>结尾<code>loc_45EB61</code>将var_94++,显然是作为循环变量的,</p>
<p>开头<code>loc_45EB70</code>将<code>var_94</code>和<code>0x38h=56</code>进行比较,应该是判断循环结束条件,循环56次</p>
<p><code>loc_45EB70</code>之前有一个<code>mov [ebp+var_94],0</code>显然是循环变量var_94一开始是下标0</p>
<p>那么不妨给<code>var_94</code>重命名i</p>
<p>循环体:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mov     eax, [ebp+i]</span><br><span class="line">movsx   ecx, [ebp+eax+var_44]			;var_44[i]-&gt;ecx</span><br><span class="line">mov     edx, [ebp+i]					</span><br><span class="line">movsx   eax, [ebp+edx+var_88]			;var_88[i]-&gt;eax</span><br><span class="line">xor     eax, ecx						;var_44[i]^var_88[i]-&gt;eax</span><br><span class="line">mov     ecx, [ebp+i]					</span><br><span class="line">mov     [ebp+ecx+var_88], al			;var_44[i]^var_88[i]-&gt;var_88[i]</span><br><span class="line">mov     eax, [ebp+i]</span><br><span class="line">movsx   ecx, [ebp+eax+var_88]			;var_88[i]-&gt;ecx</span><br><span class="line">xor     ecx, 13h						;var_88[i]^13h-&gt;ecx</span><br><span class="line">mov     edx, [ebp+i]					</span><br><span class="line">mov     [ebp+edx+var_88], cl			;var_88[i]^13h-&gt;var_88[i]</span><br><span class="line">jmp     short loc_45EB61				</span><br></pre></td></tr></table></figure>
<p>这么一长段干了一件事 <span class="math display">\[
var\_88[i]=var\_88[i]\oplus var\_44[i]\oplus 0x13
\]</span>
<code>var_88</code>在内存中占用-88到-50刚好0x38大小,与循环变量i的范围相同</p>
<p>同理<code>var_44</code>应当占用<code>-44</code>到<code>-C</code></p>
<p>在栈视图下编好数组</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507083640431.png"
alt="image-20220507083640431" />
<figcaption aria-hidden="true">image-20220507083640431</figcaption>
</figure>
<p>回到反汇编视图</p>
<p>接下来考虑怎样把mov进入var_44数组的值提取出来放到一个数组里</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507084508649.png"
alt="image-20220507084508649" />
<figcaption aria-hidden="true">image-20220507084508649</figcaption>
</figure>
<p>如果高亮<code>.text:0045E975</code>到<code>.text:0045EA55</code>之后右键convert
to C/C++ array(DWORD)</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507084855688.png"
alt="image-20220507084855688" />
<figcaption aria-hidden="true">image-20220507084855688</figcaption>
</figure>
<p>得到的数组是这样的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[+] Dump <span class="number">0x45E975</span> - <span class="number">0x45EA55</span> (<span class="number">224</span> bytes) :</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> data[<span class="number">56</span>] = &#123;</span><br><span class="line">    <span class="number">0x12BC45C6</span>, <span class="number">0x40BD45C6</span>, <span class="number">0x62BE45C6</span>, <span class="number">0x05BF45C6</span>, <span class="number">0x02C045C6</span>, <span class="number">0x04C145C6</span>, <span class="number">0x06C245C6</span>, <span class="number">0x03C345C6</span>, </span><br><span class="line">    <span class="number">0x06C445C6</span>, <span class="number">0x30C545C6</span>, <span class="number">0x31C645C6</span>, <span class="number">0x41C745C6</span>, <span class="number">0x20C845C6</span>, <span class="number">0x0CC945C6</span>, <span class="number">0x30CA45C6</span>, <span class="number">0x41CB45C6</span>, </span><br><span class="line">    <span class="number">0x1FCC45C6</span>, <span class="number">0x4ECD45C6</span>, <span class="number">0x3ECE45C6</span>, <span class="number">0x20CF45C6</span>, <span class="number">0x31D045C6</span>, <span class="number">0x20D145C6</span>, <span class="number">0x01D245C6</span>, <span class="number">0x39D345C6</span>, </span><br><span class="line">    <span class="number">0x60D445C6</span>, <span class="number">0x03D545C6</span>, <span class="number">0x15D645C6</span>, <span class="number">0x09D745C6</span>, <span class="number">0x04D845C6</span>, <span class="number">0x3ED945C6</span>, <span class="number">0x03DA45C6</span>, <span class="number">0x05DB45C6</span>, </span><br><span class="line">    <span class="number">0x04DC45C6</span>, <span class="number">0x01DD45C6</span>, <span class="number">0x02DE45C6</span>, <span class="number">0x03DF45C6</span>, <span class="number">0x2CE045C6</span>, <span class="number">0x41E145C6</span>, <span class="number">0x4EE245C6</span>, <span class="number">0x20E345C6</span>, </span><br><span class="line">    <span class="number">0x10E445C6</span>, <span class="number">0x61E545C6</span>, <span class="number">0x36E645C6</span>, <span class="number">0x10E745C6</span>, <span class="number">0x2CE845C6</span>, <span class="number">0x34E945C6</span>, <span class="number">0x20EA45C6</span>, <span class="number">0x40EB45C6</span>, </span><br><span class="line">    <span class="number">0x59EC45C6</span>, <span class="number">0x2DED45C6</span>, <span class="number">0x20EE45C6</span>, <span class="number">0x41EF45C6</span>, <span class="number">0x0FF045C6</span>, <span class="number">0x22F145C6</span>, <span class="number">0x12F245C6</span>, <span class="number">0x10F345C6</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>实际上存储的是指令不是我们要的数值</p>
<p>但是可以发现,每个数据的高两个16进制位是我们要的数值</p>
<p>比如<code>0x12BC45C6</code>高两位那么将每个16进制数按位与<code>0xFF000000</code>即可只保留高两位,或者直接右移24位即可转化为低两位</p>
<p>但是对于<code>var_88</code>这个数组,它头几个元素赋值的指令占了7字节,可以手动抄到数组里</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220507090007954.png"
alt="image-20220507090007954" />
<figcaption aria-hidden="true">image-20220507090007954</figcaption>
</figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> var_88_2[<span class="number">56</span>] = &#123;</span><br><span class="line">	<span class="number">0x7b000000</span>, <span class="number">0x20000000</span>, <span class="number">0x12000000</span>, <span class="number">0x62000000</span>, <span class="number">0x77000000</span>, <span class="number">0x6C000000</span>, <span class="number">0x41000000</span>, <span class="number">0x29000000</span>,</span><br><span class="line">    <span class="number">0x7C8045C6</span>, <span class="number">0x508145C6</span>, <span class="number">0x7D8245C6</span>, <span class="number">0x268345C6</span>, <span class="number">0x7C8445C6</span>, <span class="number">0x6F8545C6</span>, <span class="number">0x4A8645C6</span>, <span class="number">0x318745C6</span>, </span><br><span class="line">    <span class="number">0x538845C6</span>, <span class="number">0x6C8945C6</span>, <span class="number">0x5E8A45C6</span>, <span class="number">0x6C8B45C6</span>, <span class="number">0x548C45C6</span>, <span class="number">0x068D45C6</span>, <span class="number">0x608E45C6</span>, <span class="number">0x538F45C6</span>, </span><br><span class="line">    <span class="number">0x2C9045C6</span>, <span class="number">0x799145C6</span>, <span class="number">0x689245C6</span>, <span class="number">0x6E9345C6</span>, <span class="number">0x209445C6</span>, <span class="number">0x5F9545C6</span>, <span class="number">0x759645C6</span>, <span class="number">0x659745C6</span>, </span><br><span class="line">    <span class="number">0x639845C6</span>, <span class="number">0x7B9945C6</span>, <span class="number">0x7F9A45C6</span>, <span class="number">0x779B45C6</span>, <span class="number">0x609C45C6</span>, <span class="number">0x309D45C6</span>, <span class="number">0x6B9E45C6</span>, <span class="number">0x479F45C6</span>, </span><br><span class="line">    <span class="number">0x5CA045C6</span>, <span class="number">0x1DA145C6</span>, <span class="number">0x51A245C6</span>, <span class="number">0x6BA345C6</span>, <span class="number">0x5AA445C6</span>, <span class="number">0x55A545C6</span>, <span class="number">0x40A645C6</span>, <span class="number">0x0CA745C6</span>, </span><br><span class="line">    <span class="number">0x2BA845C6</span>, <span class="number">0x4CA945C6</span>, <span class="number">0x56AA45C6</span>, <span class="number">0x0DAB45C6</span>, <span class="number">0x72AC45C6</span>, <span class="number">0x01AD45C6</span>, <span class="number">0x75AE45C6</span>, <span class="number">0x7EAF45C6</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="解密脚本">解密脚本</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> var_44[<span class="number">56</span>] = &#123;</span><br><span class="line">	<span class="number">0x12BC45C6</span>, <span class="number">0x40BD45C6</span>, <span class="number">0x62BE45C6</span>, <span class="number">0x05BF45C6</span>, <span class="number">0x02C045C6</span>, <span class="number">0x04C145C6</span>, <span class="number">0x06C245C6</span>, <span class="number">0x03C345C6</span>,</span><br><span class="line">	<span class="number">0x06C445C6</span>, <span class="number">0x30C545C6</span>, <span class="number">0x31C645C6</span>, <span class="number">0x41C745C6</span>, <span class="number">0x20C845C6</span>, <span class="number">0x0CC945C6</span>, <span class="number">0x30CA45C6</span>, <span class="number">0x41CB45C6</span>,</span><br><span class="line">	<span class="number">0x1FCC45C6</span>, <span class="number">0x4ECD45C6</span>, <span class="number">0x3ECE45C6</span>, <span class="number">0x20CF45C6</span>, <span class="number">0x31D045C6</span>, <span class="number">0x20D145C6</span>, <span class="number">0x01D245C6</span>, <span class="number">0x39D345C6</span>,</span><br><span class="line">	<span class="number">0x60D445C6</span>, <span class="number">0x03D545C6</span>, <span class="number">0x15D645C6</span>, <span class="number">0x09D745C6</span>, <span class="number">0x04D845C6</span>, <span class="number">0x3ED945C6</span>, <span class="number">0x03DA45C6</span>, <span class="number">0x05DB45C6</span>,</span><br><span class="line">	<span class="number">0x04DC45C6</span>, <span class="number">0x01DD45C6</span>, <span class="number">0x02DE45C6</span>, <span class="number">0x03DF45C6</span>, <span class="number">0x2CE045C6</span>, <span class="number">0x41E145C6</span>, <span class="number">0x4EE245C6</span>, <span class="number">0x20E345C6</span>,</span><br><span class="line">	<span class="number">0x10E445C6</span>, <span class="number">0x61E545C6</span>, <span class="number">0x36E645C6</span>, <span class="number">0x10E745C6</span>, <span class="number">0x2CE845C6</span>, <span class="number">0x34E945C6</span>, <span class="number">0x20EA45C6</span>, <span class="number">0x40EB45C6</span>,</span><br><span class="line">	<span class="number">0x59EC45C6</span>, <span class="number">0x2DED45C6</span>, <span class="number">0x20EE45C6</span>, <span class="number">0x41EF45C6</span>, <span class="number">0x0FF045C6</span>, <span class="number">0x22F145C6</span>, <span class="number">0x12F245C6</span>, <span class="number">0x10F345C6</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> var_88[<span class="number">56</span>] = &#123;</span><br><span class="line">	<span class="number">0x7b000000</span>, <span class="number">0x20000000</span>, <span class="number">0x12000000</span>, <span class="number">0x62000000</span>, <span class="number">0x77000000</span>, <span class="number">0x6C000000</span>, <span class="number">0x41000000</span>, <span class="number">0x29000000</span>,<span class="comment">//手动补的</span></span><br><span class="line">	<span class="number">0x7C8045C6</span>, <span class="number">0x508145C6</span>, <span class="number">0x7D8245C6</span>, <span class="number">0x268345C6</span>, <span class="number">0x7C8445C6</span>, <span class="number">0x6F8545C6</span>, <span class="number">0x4A8645C6</span>, <span class="number">0x318745C6</span>,</span><br><span class="line">	<span class="number">0x538845C6</span>, <span class="number">0x6C8945C6</span>, <span class="number">0x5E8A45C6</span>, <span class="number">0x6C8B45C6</span>, <span class="number">0x548C45C6</span>, <span class="number">0x068D45C6</span>, <span class="number">0x608E45C6</span>, <span class="number">0x538F45C6</span>,</span><br><span class="line">	<span class="number">0x2C9045C6</span>, <span class="number">0x799145C6</span>, <span class="number">0x689245C6</span>, <span class="number">0x6E9345C6</span>, <span class="number">0x209445C6</span>, <span class="number">0x5F9545C6</span>, <span class="number">0x759645C6</span>, <span class="number">0x659745C6</span>,</span><br><span class="line">	<span class="number">0x639845C6</span>, <span class="number">0x7B9945C6</span>, <span class="number">0x7F9A45C6</span>, <span class="number">0x779B45C6</span>, <span class="number">0x609C45C6</span>, <span class="number">0x309D45C6</span>, <span class="number">0x6B9E45C6</span>, <span class="number">0x479F45C6</span>,</span><br><span class="line">	<span class="number">0x5CA045C6</span>, <span class="number">0x1DA145C6</span>, <span class="number">0x51A245C6</span>, <span class="number">0x6BA345C6</span>, <span class="number">0x5AA445C6</span>, <span class="number">0x55A545C6</span>, <span class="number">0x40A645C6</span>, <span class="number">0x0CA745C6</span>,</span><br><span class="line">	<span class="number">0x2BA845C6</span>, <span class="number">0x4CA945C6</span>, <span class="number">0x56AA45C6</span>, <span class="number">0x0DAB45C6</span>, <span class="number">0x72AC45C6</span>, <span class="number">0x01AD45C6</span>, <span class="number">0x75AE45C6</span>, <span class="number">0x7EAF45C6</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">vector</span>&lt;<span class="type">char</span>&gt; <span class="title function_">preprocesser</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">int</span> arr[], <span class="type">int</span> length)</span> &#123;</span><br><span class="line">	<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt; <span class="title function_">v</span><span class="params">(length)</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; length; ++i) &#123;</span><br><span class="line">		v[i] = arr[i] &gt;&gt; <span class="number">24</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt; result = preprocesser(var_44, <span class="number">56</span>);</span><br><span class="line">	<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt; key = preprocesser(var_88, <span class="number">56</span>);</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">56</span>; ++i) &#123;</span><br><span class="line">		result[i] = result[i] ^ key[i] ^ <span class="number">0x13</span>;</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; (<span class="type">char</span>)result[i];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zsctf&#123;T9is_tOpic_1s_v5ry_int7resting_b6t_others_are_n0t&#125;</span><br></pre></td></tr></table></figure>
<h2 id="hellocctf">008Helloc,CTF</h2>
<h3 id="没见过的指令">没见过的指令</h3>
<p>在分析之前,补几个指令</p>
<p>关于CSAPP上没有见过的指令</p>
<p>1.rep/repne</p>
<p>2.movsd/movsw/movsb</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rep movsd               ; 没有见过的指令</span><br><span class="line">movsw</span><br><span class="line">movsb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>查阅<a
target="_blank" rel="noopener" href="https://stackoverflow.com/questions/27804852/assembly-rep-movs-mechanism">x86
- Assembly: REP MOVS mechanism - Stack Overflow</a></p>
<p>According to <a
target="_blank" rel="noopener" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff561504(v=vs.85).aspx">MSDN</a>,
"The instruction can be prefixed by REP to repeat the operation the
number of times specified by the ecx register."</p>
<p>rep的操作数是一个指令,rep的作用是将该指令重复若干次,以ecx中的数字为重复次数,(每次ecx中的数字-1直到归零)</p>
<p>repne 当ecx!=0且ZF!=0,重复执行后边的指令,每执行一次ecx的值减1</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506171358295.png"
alt="image-20220506171358295" />
<figcaption aria-hidden="true">image-20220506171358295</figcaption>
</figure>
</blockquote>
<p>3.stosd/stosw/stosb</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rep stosd</span><br><span class="line">stosw</span><br><span class="line">stosb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>STOSB、STOSW 和 STOSD 指令分别将 AL/AX/EAX 的内容存入由 EDI
中偏移量指向的内存位置。</p>
<p>EDI 根据方向标志位的状态递增或递减。</p>
</blockquote>
<p>4.scasd/scasw/scasb</p>
<blockquote>
<p>SCASB、SCASW 和 SCASD 指令分别将 AL/AX/EAX 中的值与 EDI
寻址的一个字节 / 字 / 双字进行比较。</p>
<p>这些指令可用于在字符串或数组中寻找一个数值。</p>
<p>结合 REPE（或 REPZ）前缀，当 ECX &gt; 0 且 AL/AX/EAX
的值等于内存中每个连续的值时，不断扫描字符串或数组。</p>
</blockquote>
<h3 id="收集信息">收集信息</h3>
<p>输入比较短的字符串会报告wrong!然后让重新输入,输入很长的字符串报告wrong!之后程序退出</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506163947900.png"
alt="image-20220506163947900" />
<figcaption aria-hidden="true">image-20220506163947900</figcaption>
</figure>
<p>ida打开之后</p>
<p>main函数开端部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">mov     esi, offset a437261636b4d65 ; &quot;437261636b4d654a757374466f7246756e&quot;</span><br><span class="line">lea     edi, [esp+70h+var_24]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>这里有一串16进制编码,其他不管先解一下,<code>CrackMeJustForFun</code>"撬我只是为了娱乐",看上去是有一定语言意义的,作为flag交上去试试就对了</p>
<h3 id="反汇编分析">反汇编分析</h3>
<p>下面分析一下程序都干了啥</p>
<h4 id="开端-1">开端</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">;开端</span><br><span class="line">sub     esp, 60h</span><br><span class="line">mov     ecx, 8			</span><br><span class="line">push    ebx;寄存器值保存</span><br><span class="line">push    ebp</span><br><span class="line">push    esi</span><br><span class="line">push    edi</span><br><span class="line"></span><br><span class="line">mov     esi, offset a437261636b4d65 ; esi存放flag的地址</span><br><span class="line">lea     edi, [esp+70h+var_24] ; &amp;var_24-&gt;edi</span><br><span class="line">rep movsd               ;ecx事先放好了8,这里重复执行movsd八次</span><br><span class="line">movsw</span><br><span class="line">movsb</span><br></pre></td></tr></table></figure>
<p>这里</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rep movsd  </span><br><span class="line">movsw</span><br><span class="line">movsb</span><br></pre></td></tr></table></figure>
<blockquote>
<p>三句话,让我蒙蔽了18分钟,我真是一个计组学的一塌糊涂的虚蛋</p>
<p>参考博客<a
target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33443333/article/details/113010189">标志寄存器df_标志寄存器_shikaao14的博客-CSDN博客</a></p>
<p><img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506171615659.png" /></p>
<p>这里干了一个字符串拷贝的事情,<code>offset a437261636b4d65</code>这个位置的字符串作为源,<code>esp+70h+var_24</code>这个位置的缓冲区作为目的进行拷贝.</p>
<p>为什么用到了三条指令?</p>
<p>源串:<code>437261636b4d654a757374466f7246756e</code>共占用了35字节
<span class="math display">\[
35\div 4=8··\ ·3
\]</span>
首先<code>rep movsd</code>重复8次,每次拷贝4字节,一共拷贝了32字节,剩下了3个字节,拆成一个字用movsw然后最后一个字节用movsb</p>
</blockquote>
<p>上述部分做的就是拷贝.data上的字符串到栈上<code>var_24</code>开始的35个字节</p>
<p>下面进入循环体</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506181931623.png"
alt="image-20220506181931623" />
<figcaption aria-hidden="true">image-20220506181931623</figcaption>
</figure>
<h4 id="外循环外侧蓝线">外循环(外侧蓝线)</h4>
<p>这个循环体的结构很容易猜想,收集信息时我们知道如果输入字符数比较少则程序会一直重复运行,不存在循环变量,终止条件之类.因此循环体完全可以按照单独一次执行进行饭分析</p>
<h5 id="loc_40101a"><code>loc_40101A</code></h5>
<p>这是循环体的起始部分</p>
<p>一些参数及其函数调用距离太远不直观,这里调整了一些语句位置,但是不改变程序逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">loc_40101A:</span><br><span class="line">mov     ecx, 8				;rep的帮凶</span><br><span class="line">xor     eax, eax			;eax归零</span><br><span class="line">lea     edi, [esp+70h+var_48] ; edi指向了&amp;var_48</span><br><span class="line">rep stosd					;STOSB、STOSW 和 STOSD 指令分别将 AL/AX/EAX 的内容存入由 EDI 中偏移量指向的内存位置。</span><br><span class="line">stosw</span><br><span class="line">stosb</span><br><span class="line">;eax被xor指令清零了,那么这里三条指令的作用是让var_48开始的35字节的栈空间置0</span><br><span class="line"></span><br><span class="line">;打印第一句废话</span><br><span class="line">push    offset aPleaseInputYou ; &quot;please input your serial:&quot;</span><br><span class="line">call    _printf</span><br><span class="line"></span><br><span class="line">;准备获取用户输入</span><br><span class="line">lea     eax, [esp+74h+var_5C]	;eax指向&amp;var_5C</span><br><span class="line">push    eax             ;&amp;var_5C压栈作为scanf的缓冲区</span><br><span class="line">push    offset aS       ; &quot;%s&quot;压栈作为第一个参数</span><br><span class="line">call    _scanf</span><br><span class="line"></span><br><span class="line">;检查是否给了太多字符</span><br><span class="line">lea     edi, [esp+7Ch+var_5C] ; &amp;var_5C-&gt;edi</span><br><span class="line">or      ecx, 0FFFFFFFFh ; ecx置全1</span><br><span class="line">xor     eax, eax		;eax归零,如果eax为0则ZF置零,eax存放scanf返回值,即实际输入字符数</span><br><span class="line">add     esp, 0Ch		;退栈12字节,不会修改ZF位</span><br><span class="line">repne scasb				;ecx中全是1,相当于无限大,只要scanf有输入则repne成立;从var_5C指向的缓冲区中寻找0(eax中放的是0),每次ecx-1</span><br><span class="line">not     ecx             ;ecx取反</span><br><span class="line">dec     ecx             ;ecx-1</span><br><span class="line">cmp     ecx, 11h        ;检查ecx和11h=17的大小</span><br><span class="line"></span><br><span class="line">ja      loc_40110D		;跳转则寄</span><br><span class="line"></span><br><span class="line">xor     ebx, ebx		;ebx寄存器归零,在loc_40101A的结尾干了这么一件事,不明觉厉,实际上是为后来的内圈循环初始化循环变量</span><br></pre></td></tr></table></figure>
<blockquote>
<p>检查输入字符数是怎样实现的?</p>
<p>1.第25行的<code>scasb</code>从edi指向的缓冲区检查,是否存在eax中的字符,因此之前(第21行)就安置好了edi<code>lea     edi, [esp+7Ch+var_5C]</code></p>
<p>2.22行ecx置全1,需要减<code>2^8</code>次才能归零,因此该条件对第25行的repne指令没有限制作用</p>
<p>3.23行eax中是scanf的返回值,根据其值置ZF位(假设scanf获取到了输入,则eax不为0,则ZF为0),然后eax归零</p>
<p>4.24行退栈啥作用不知道,推测一开始预先多开了一些栈空间,可能是防止栈缓冲区溢出</p>
<p>5.25行repne成立的条件是<code>ecx!=0,ZF!=1</code>显然当scanf有获取到输入时是成立的,重复执行scasb,即在edi指向的<code>&amp;var_5C</code>中寻找eax中存放的值<code>0</code>,即寻找<code>var_5C</code>的结束字符,每次ecx-1</p>
<p>6.26行ecx取反,然后第27行ecx-1,啥作用呢?</p>
<blockquote>
<p>假设输入了ABC就三个字符,scanf返回后eax存3,<code>var_5C=&#123;'A','B','C',0,0,...,0&#125;</code>,</p>
<p>此时repne条件成立,在第四次检查时检查到0,目前的值为0xFFFFFFFB</p>
<p>然后ecx取反得到0b0100=4</p>
<p>然后ecx-1=3即输入字符数</p>
</blockquote>
<p>即这两步执行完后ecx存放输入字符数</p>
<p>7.28行ecx和11h进行比较,如果ecx中的值大则跳转loc_40110D,即判断输入字符是否超过了11h=17个,</p>
<p>而我们一开始收集到的信息也是字符数很多时直接程序退出</p>
<p>8.loc_40110D作用是报告失败</p>
</blockquote>
<p><code>loc_40101A</code>的作用就是获取输入并检查输入长度是否超过17字节,超过则寄,没超过则进一步检查</p>
<h5 id="loc_40105f内侧绿线"><code>loc_40105F</code>(内侧绿线)</h5>
<blockquote>
<p>在研究该部分之前,先要弄明白<code>sprintf</code>函数</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506184650282.png"
alt="image-20220506184650282" />
<figcaption aria-hidden="true">image-20220506184650282</figcaption>
</figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, ...)</span></span><br></pre></td></tr></table></figure>
<p>返回值是实际str接收到的字符数,将源缓冲区从基地址到'\0'以某种格式输出到str目的缓冲区</p>
</blockquote>
<p>内圈循环</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">loc_40105F:</span><br><span class="line">mov     al, [esp+ebx+70h+var_5C]	;在进入循环体之前,loc_40101A最的最后,ebx置零,这里又和var_5C结合使用,可以大胆推测这是一个基址变址寻址,基址是esp+70h+var_5c即&amp;var_5C,变址即偏移量ebx,以后都记作i</span><br><span class="line">test    al, al					</span><br><span class="line">jz      short loc_4010B0			;如果var_5c[i]为0即i遍历到var_5c字符串的末尾则跳转loc_4010B0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;如果jz条件跳转未实现则var_5C[i]!=0即不是字符串末尾</span><br><span class="line">;以下将var_5C处的字符串转化成16进制格式的字符串然后放到var_48位置</span><br><span class="line"></span><br><span class="line">;将var_5c[i]转化成16进制字符串,放到buffer</span><br><span class="line">movsx   ecx, al						;var_5c[i]-&gt;ecx	;字节拓展双字</span><br><span class="line">push    ecx							;var_5c[i]-&gt;ecx-&gt;压栈作为参数</span><br><span class="line">lea     edx, [esp+74h+Buffer]		 ;&amp;Buffer-&gt;edx,			;Buffer是栈上两个字节</span><br><span class="line">push    offset Format   ; &quot;%x&quot;		  ;%x压栈作为参数</span><br><span class="line">push    edx             ; Buffer	  ;&amp;Buffer-&gt;edx-&gt;压栈作为参数</span><br><span class="line">call    _sprintf					;sprintf(&amp;Buffer,&quot;%x&quot;,&amp;var_5c[i]),返回值(写入字符总数)放eax</span><br><span class="line">							;这里sprintf函数把var_5c[i]以十六进制字符格式转换成字符串放到Buffer</span><br><span class="line">							;(Buffer两个字节,一个ascii码的16进制字符串也是两个字节)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lea     edi, [esp+7Ch+Buffer]		 ;&amp;Buffer-&gt;edi</span><br><span class="line">or      ecx, 0FFFFFFFFh				;ecx置全1</span><br><span class="line">xor     eax, eax					;根据eax置ZF,然后eax置零</span><br><span class="line">add     esp, 0Ch</span><br><span class="line">repne scasb							;寻找buffer的结束位置</span><br><span class="line">not     ecx							;ecx存放buffer的结束字符下标</span><br><span class="line">sub     edi, ecx					;edi-ecx之后edi回退到Buffer起始位置</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;下面加载var_48并确定其末尾位置</span><br><span class="line">lea     edx, [esp+70h+var_48]		 ;&amp;var_48-&gt;edx,		;var_48是栈上一个32字节的缓冲区</span><br><span class="line">mov     ebp, ecx					;ebp暂时保存之前的ecx</span><br><span class="line">or      ecx, 0FFFFFFFFh</span><br><span class="line"></span><br><span class="line">mov     esi, edi					;edi存放Buffer基地址,放到esi</span><br><span class="line">mov     edi, edx					;edx存放var_48基地址,放到edi		</span><br><span class="line"></span><br><span class="line">repne scasb							;寻找edi中var_48串的结束字符位置</span><br><span class="line">dec     edi							;减1后edi指向var_48的最后一个字符</span><br><span class="line"></span><br><span class="line">;这里看似是蜜汁操作,啥也没干,但是我感觉是因为没有用编译优化,编译器在将Buffer向var_48拷贝的时候,没有考虑Buffer的长度,而是假设Buffer是一个不知长度的字符串,先以最大效率双字拷贝,然后最后剩下的不足双字的1或者2或者3个字节使用字节拷贝</span><br><span class="line">;这蜜汁操作想了一下午才想明白</span><br><span class="line">mov     ecx, ebp					;ebp把之前暂时保存的值还给ecx</span><br><span class="line">shr     ecx, 2						;ecx之前存放buffer结束字符下标,现在/4必然是0</span><br><span class="line">rep movsd							;按双字拷贝,但是Buffer长度/4=0,因此实际上这三句话啥也没干</span><br><span class="line"></span><br><span class="line">mov     ecx, ebp					;ebp把之前暂时保存的值还给ecx</span><br><span class="line">and     ecx, 3						;ecx保留低2位(模4余数)</span><br><span class="line">rep movsb							;Buffer按字节拷贝到var_48</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inc     ebx							;++i;</span><br><span class="line">cmp     ebx, 11h					;判断i是否遍历完了var_5C</span><br><span class="line">jl      short loc_40105F			;如果i&lt;17则跳到本部分开头重新内圈循环,如果i&gt;=17则意味着遍历完毕,跳出内圈循环</span><br></pre></td></tr></table></figure>
<p>内圈循环做的就是将var_5c存放的串换成16进制格式,输出到var_48位置的串,以Buffer作为转换过渡</p>
<p><code>var_5c[i]--sprintf--&gt;Buffer--strcat--&gt;var_48</code></p>
<h5 id="loc_4040b0"><code>loc_4040B0</code></h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">loc_4010B0:	</span><br><span class="line">lea     esi, [esp+70h+var_24]		;var_24事先放好了flag的16进制表示					&amp;var_24-&gt;esi</span><br><span class="line">lea     eax, [esp+70h+var_48]		;var_48是刚才内圈循环时将输入转换成16进制串的表示	 &amp;var_28-&gt;eax</span><br></pre></td></tr></table></figure>
<p>两个16进制数都放好了,可想而知下面要对两个数比较判断是否相同了,显然直接调用strcmp这种函数太过于明显,可能会采用逐个字节比较的方式</p>
<p>但是这样也比较容易发现,</p>
<p>当比较完了<code>*var_24</code>和<code>*var_48</code>即<code>var_24[0]</code>和<code>var_48[0]</code>之后,如果要继续比较<code>var_24[1]</code>和<code>var_48[1]</code>,需要移动一下指针,即</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">inc esi;</span><br><span class="line">inc eax;</span><br></pre></td></tr></table></figure>
<p>这类的指令</p>
<h5 id="loc_4010b8"><code>loc_4010B8</code></h5>
<p>按照刚才的猜想,这里应该有一个循环,实际上也是这样的</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506205727285.png"
alt="image-20220506205727285" />
<figcaption aria-hidden="true">image-20220506205727285</figcaption>
</figure>
<p>我们很容易就在<code>.text:004010D2</code>找到了移动指针的语句,只不过是一次性移动两位,因为前面比较了两位</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:004010B8 loc_4010B8:                             ; CODE XREF: _main+DA↓j</span><br><span class="line">.text:004010B8                 mov     dl, [eax]			;解引用</span><br><span class="line">.text:004010BA                 mov     bl, [esi]</span><br><span class="line">.text:004010BC                 mov     cl, dl</span><br><span class="line">.text:004010BE                 cmp     dl, bl</span><br><span class="line">.text:004010C0                 jnz     short loc_4010E0		;这个跳转通向 寄 ,如果不让他跳则dl和bl要相同,即两个串对应字符相同</span><br><span class="line">.text:004010C2                 test    cl, cl				;如果cl是0说明指针已经移动到空了,应当跳出循环</span><br><span class="line">.text:004010C4                 jz      short loc_4010DC		;跳出循环,通向 成功</span><br><span class="line">.text:004010C6                 mov     dl, [eax+1]			;一次性比较两个字符</span><br><span class="line">.text:004010C9                 mov     bl, [esi+1]			</span><br><span class="line">.text:004010CC                 mov     cl, dl</span><br><span class="line">.text:004010CE                 cmp     dl, bl</span><br><span class="line">.text:004010D0                 jnz     short loc_4010E0		;跳转就寄</span><br><span class="line">.text:004010D2                 add     eax, 2					;移动指针</span><br><span class="line">.text:004010D5                 add     esi, 2</span><br><span class="line">.text:004010D8                 test    cl, cl</span><br><span class="line">.text:004010DA                 jnz     short loc_4010B8		;本次两个字符都相同,继续循环判断下两个字符是否相同</span><br></pre></td></tr></table></figure>
<h5 id="尾声-1">尾声</h5>
<p>从刚才的循环出来就能够决定命运了,刚才的循环有两种跳转,一是<code>loc_4010DC</code>,另一个是<code>loc_4010E0</code></p>
<p>其中<code>loc_4010DC</code>将eax置零</p>
<p><code>loc_4010E0</code>将eax置-1</p>
<p>然后两路殊途同归到<code>loc_4010E5</code></p>
<p>而<code>loc_4010E5</code>是一个法官,只有eax值为0才让打印成功</p>
<p>如果eax值不为0则跳转<code>loc_4010FB</code>寄</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506205845976.png"
alt="image-20220506205845976" />
<figcaption aria-hidden="true">image-20220506205845976</figcaption>
</figure>
<h2 id="opensource">009opensource</h2>
<p>给出的是一段c程序</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">4</span>) &#123;<span class="comment">//要求argc=4,argv[0]是自带的程序位置,剩下即要输入3个参数</span></span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;what?\n&quot;</span>);</span><br><span class="line">    	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> first = atoi(argv[<span class="number">1</span>]);<span class="comment">//第一个参数转化成字符串</span></span><br><span class="line">    <span class="keyword">if</span> (first != <span class="number">0xcafe</span>) &#123;<span class="comment">//要求first=51966</span></span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;you are wrong, sorry.\n&quot;</span>);</span><br><span class="line">    	<span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> second = atoi(argv[<span class="number">2</span>]);<span class="comment">//second为第二个参数转化成字符串</span></span><br><span class="line">    <span class="keyword">if</span> (second % <span class="number">5</span> == <span class="number">3</span> || second % <span class="number">17</span> != <span class="number">8</span>) &#123;<span class="comment">//要求second 模5不余三,模17余8</span></span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;ha, you won&#x27;t get it!\n&quot;</span>);</span><br><span class="line">    	<span class="built_in">exit</span>(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;h4cky0u&quot;</span>, argv[<span class="number">3</span>])) &#123;<span class="comment">//要求argv[3]=&quot;h4cky0u&quot;,长度为7</span></span><br><span class="line">    	<span class="built_in">printf</span>(<span class="string">&quot;so close, dude!\n&quot;</span>);</span><br><span class="line">    	<span class="built_in">exit</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Brr wrrr grr\n&quot;</span>);</span><br><span class="line">	<span class="comment">//second%17=8,strlen(argv[3])=7</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> hash = first * <span class="number">31337</span> + (second % <span class="number">17</span>) * <span class="number">11</span> + <span class="built_in">strlen</span>(argv[<span class="number">3</span>]) - <span class="number">1615810207</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Get your key: &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%x\n&quot;</span>, hash);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>三个参数可以为:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">51966</span> <span class="number">25</span>  h4cky0u</span><br></pre></td></tr></table></figure>
<p>编译之后运行一下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PS C:\Users\86135\Desktop\xctf12\opensource&gt; ./opensource 51966 25  h4cky0u</span><br><span class="line">Brr wrrr grr</span><br><span class="line">Get your key: c0ffee</span><br></pre></td></tr></table></figure>
<h2 id="no-strings-attached">010no-strings-attached</h2>
<p>尽量不依赖工具,比如ida-F5的伪代码,那么应该在以什么为基础进行分析呢?</p>
<p>objdump和ida的反汇编视图起码是可以的,没有必要和0和1组成的二进制码打交道,直接看反汇编即可</p>
<p>ida反汇编的图视图也是可以接受的,毕竟有了反汇编之后我们也可以轻松画出跳转关系和调用关系图,不妨让ida代劳了</p>
<p>ida-F5伪代码可以吗?</p>
<p>如果我能够轻松地将反汇编翻译成伪代码或者代码,那何乐而不为?但是我没这本事.</p>
<p>如果每个题上来就看伪代码对于从反汇编到伪代码的翻译是没有帮助的.</p>
<p>因此我觉得逆向分析应当基于反汇编和图视图,尽量少<del>沉迷美色</del>看伪代码</p>
<p>对于<code>no-strings-attached</code>这个ctf逆向题,前置知识:</p>
<p><code>x86</code>汇编语言(如果不看伪代码的话)</p>
<p>==宽字符==</p>
<p>置换加密算法</p>
<p>ida的使用</p>
<h3 id="main函数-1"><code>main</code>函数</h3>
<p>main函数下调用了四个函数</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504202713613.png"
alt="image-20220504202713613" />
<figcaption aria-hidden="true">image-20220504202713613</figcaption>
</figure>
<p><code>_setlocale</code>是使用者的区域设定,比如时间,语言之类的,没有卵用</p>
<p><code>banner,prompt_authentication</code>都是打印一些语句作为提示,也没有锤子用</p>
<p><code>authenticate</code>关键在这里</p>
<h3 id="authenticate函数"><code>authenticate</code>函数</h3>
<p>粗略浏览该函数,发现有一个<code>call decrypt</code></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504202933305.png"
alt="image-20220504202933305" />
<figcaption aria-hidden="true">image-20220504202933305</figcaption>
</figure>
<p>单就从<code>decrypt</code>,这种"解密"名字的函数就应该是关键函数,<code>authenticate</code>的其他部分先不管,直接看<code>decrypt</code>,</p>
<p>another(rename之后的名字)和s分别作为第二个和第一个参数传递给了<code>decrypt</code>函数</p>
<h3 id="decrypt函数"><code>decrypt</code>函数</h3>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504203108886.png"
alt="image-20220504203108886" />
<figcaption aria-hidden="true">image-20220504203108886</figcaption>
</figure>
<p>框框相连,转转不已,也不知道套了多少层循环了</p>
<p>首先按照CSAPP第三章的方法,将汇编翻译成带goto的c伪代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">decrypt</span><span class="params">(<span class="type">char</span> *s,<span class="type">char</span> *another)</span>&#123;</span><br><span class="line">    <span class="type">int</span> slength=<span class="built_in">strlen</span>(s);</span><br><span class="line">    <span class="type">int</span> anotherlength=<span class="built_in">strlen</span>(another);</span><br><span class="line">    <span class="type">char</span> *dest=(<span class="type">int</span> *)<span class="built_in">malloc</span>(slength+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest,s);</span><br><span class="line">    <span class="keyword">goto</span> loc_80486F7;</span><br><span class="line">    loc_80486AF:</span><br><span class="line">        <span class="type">int</span> var_18=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">goto</span> loc_80486E7;</span><br><span class="line"></span><br><span class="line">    loc_80486B8:</span><br><span class="line">        dest[var_1C]=dest[var_1C]-another[var_18];</span><br><span class="line">        ++var_1C;</span><br><span class="line">        ++var_18;</span><br><span class="line"></span><br><span class="line">    loc_80486E7:<span class="comment">//这一块的分析是比较繁琐的</span></span><br><span class="line">        <span class="keyword">if</span>(var_18&lt;anotherlength&amp;&amp;var_1C&lt;slength)&#123;</span><br><span class="line">            <span class="keyword">goto</span> loc_80486B8;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    loc_80486F7:</span><br><span class="line">        <span class="keyword">if</span>(var_1C&gt;=slength)&#123;</span><br><span class="line">            <span class="keyword">return</span> dest;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">goto</span> loc_80486AF;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>loc_80486E7的分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.text:080486B8 loc_80486B8:                            ; CODE XREF: decrypt+9D↓j</span><br><span class="line">.text:080486B8                 mov     eax, [ebp+var_1C] </span><br><span class="line">.text:080486BB                 shl     eax, 2          </span><br><span class="line">.text:080486BE                 add     eax, [ebp+dest]      ;dest+4*var_1C-&gt;eax</span><br><span class="line">.text:080486C1                 mov     edx, [ebp+var_1C]    </span><br><span class="line">.text:080486C4                 shl     edx, 2</span><br><span class="line">.text:080486C7                 add     edx, [ebp+dest]      ;dest+4*var_1C-&gt;edx</span><br><span class="line">.text:080486CA                 mov     ecx, [edx]           ;[dest+4*var_1C]-&gt;ecx</span><br><span class="line">.text:080486CC                 mov     edx, [ebp+var_18]</span><br><span class="line">.text:080486CF                 shl     edx, 2</span><br><span class="line">.text:080486D2                 add     edx, [ebp+another]   ;another+4*var_18-&gt;edx</span><br><span class="line">.text:080486D5                 mov     edx, [edx]           ;[another+4*var_18]-&gt;edx</span><br><span class="line">.text:080486D7                 mov     ebx, ecx             ;[dest+4*var_1C]-&gt;ebx</span><br><span class="line">.text:080486D9                 sub     ebx, edx             ;[dest+4*var_1C]-[another+4*var_18]-&gt;ebx</span><br><span class="line">.text:080486DB                 mov     edx, ebx             ;[dest+4*var_1C]-[another+4*var_18]-&gt;ebx-&gt;dex</span><br><span class="line">.text:080486DD                 mov     [eax], edx           ;[dest+4*var_1C]=[dest+4*var_1C]-[another+4*var_18]</span><br><span class="line">.text:080486DF                 add     [ebp+var_1C], 1      ;++var_1C</span><br><span class="line">.text:080486E3                 add     [ebp+var_18], 1      ;++var_18</span><br></pre></td></tr></table></figure>
<p>这么一长段用源代码表示就干了稀松的事情</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">loc_80486B8:</span><br><span class="line">    dest[var_1C]=dest[var_1C]-another[var_18];</span><br><span class="line">    ++var_1C;</span><br><span class="line">    ++var_18;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>然后翻译成不带goto的c代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">decrypt</span><span class="params">(<span class="type">char</span> *s,<span class="type">char</span> *another)</span>&#123;</span><br><span class="line">    <span class="type">char</span> *dest=(<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(s)+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest,s);</span><br><span class="line">    <span class="type">int</span> var_18=<span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> var_1C=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var_1C&lt;<span class="built_in">strlen</span>(s))&#123;</span><br><span class="line">        var_18=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(var_18&lt;<span class="built_in">strlen</span>(another)&amp;&amp;var_1C&lt;<span class="built_in">strlen</span>(s))&#123;</span><br><span class="line">            dest[var_1C]=dest[var_1C]-another[var_18];</span><br><span class="line">            ++var_1C;</span><br><span class="line">            ++var_18;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里两层while循环到底干了一个什么事呢?再进一步精简一下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">decrypt</span><span class="params">(<span class="type">char</span> *s,<span class="type">char</span> *key)</span>&#123;</span><br><span class="line">    <span class="type">char</span> *dest=(<span class="type">char</span> *)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(s)+<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(dest,s);</span><br><span class="line">    <span class="type">int</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;<span class="built_in">strlen</span>(s);++i)&#123;</span><br><span class="line">        index=i%<span class="built_in">strlen</span>(key);<span class="comment">//计算s[i]应该减去的key数组中的哪一个元素</span></span><br><span class="line">        dest[i]-=another[index];<span class="comment">//位移密码</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dest;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就是一个位移密码解密,s是需要解密的字符串,算法是用s
的每一个字符去减key的相应位置的字符,如果key不够长则key循环使用</p>
<h3 id="回到authenticate函数">回到<code>authenticate</code>函数</h3>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504201120562.png"
alt="image-20220504201120562" />
<figcaption aria-hidden="true">image-20220504201120562</figcaption>
</figure>
<p>这个函数还怪长的,不看F5伪代码,应当如何解读呢?</p>
<p>首先,在分析完decrypt函数之后,我们大体上可以知道,<strong>密文和密钥都是在<code>.rodata</code>只读区存好的,然后通过decrypt解密算法得到加密前的明文,下面要做的应该是获取键盘输入,然后将刚才的明文和键盘输入进行对比</strong></p>
<p>至于为什么不直接存储明文然后和获取的键盘输入进行对比?这就好比给一个孩子一艘拼装好的乐高千年隼和一盒子千年隼零件的关系</p>
<p>考察孩子对加密算法的掌握,以及对加密算法汇编形式的掌握呗</p>
<p>然后,基于上述分析,可以推测authenticate函数要做的,大体可以分为四或者五个部分</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">0.开端(任何函数都有,通常是压栈保存调用者函数的帧指针rbp,申请函数栈,rbp作为当前函数帧指针)</span><br><span class="line">1.解密</span><br><span class="line">2.输入</span><br><span class="line">3.处理输入(可以算是输入的一部分)</span><br><span class="line">4.字符串对比</span><br><span class="line">5.尾声(任何函数都有,通常是释放函数栈和退栈还原rbp为调用者函数的帧指针)</span><br></pre></td></tr></table></figure>
<p>顺序不一定,但是也就是这几件事了,想不出来还能干什么</p>
<p>实际分析</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">;0.开端</span><br><span class="line">.text:08048708                 push    ebp</span><br><span class="line">.text:08048709                 mov     ebp, esp</span><br><span class="line">.text:0804870B                 sub     esp, 8028h</span><br><span class="line"></span><br><span class="line">;1.解密获得字符串</span><br><span class="line">.text:08048711                 mov     dword ptr [esp+4], offset another ; another表示密钥,其地址压栈作为第二个参数</span><br><span class="line">.text:08048719                 mov     dword ptr [esp], offset s ; s     ; s表示需要解密的字符串,地址压栈作为参数</span><br><span class="line">.text:08048720                 call    decrypt                           ; 调用decrypt,他需要两个参数</span><br><span class="line">.text:08048725                 mov     [ebp+s2], eax                     ; decrypt返回值-&gt;eax-&gt;s2</span><br><span class="line"></span><br><span class="line">;2.键盘获得输入字符串</span><br><span class="line">.text:08048728                 mov     eax, ds:stdin@@GLIBC_2_0          ;标准键盘输入</span><br><span class="line">.text:0804872D                 mov     [esp+8], eax    ; stream          ;stdin-&gt;eax-&gt;[esp+8]作为第三个参数</span><br><span class="line">.text:08048731                 mov     dword ptr [esp+4], 2000h ; n      ;2000h-&gt;[esp+4]作为第二个参数</span><br><span class="line">.text:08048739                 lea     eax, [ebp+ws]                     ;ws-&gt;eax</span><br><span class="line">.text:0804873F                 mov     [esp], eax      ; ws              ;ws-&gt;eax-&gt;[esp]作为第一个参数</span><br><span class="line">.text:08048742                 call    _fgetws                           ;fgetws函数共需要三个参数,都已经妥善安置入栈</span><br><span class="line"></span><br><span class="line">;3.处理键盘输入</span><br><span class="line">.text:08048747                 test    eax, eax                          ;判断是否读取到至少一个字符</span><br><span class="line">;3.1如果没有获取到输入</span><br><span class="line">.text:08048749                 jz      short loc_804879C                 ;啥也没读到,跳转loc_804879C尾声</span><br><span class="line">;3.2如果获取到了输入</span><br><span class="line">.text:0804874B                 lea     eax, [ebp+ws]                     ;&amp;ws-&gt;eax</span><br><span class="line">.text:08048751                 mov     [esp], eax      ; s               ;&amp;ws-&gt;eax-&gt;[esp]压栈作为参数</span><br><span class="line">.text:08048754                 call    _wcslen                           ;&amp;ws作为参数压栈,传递给_wcslen</span><br><span class="line">.text:08048759                 sub     eax, 1                            ;strlen(ws)-1-&gt;eax</span><br><span class="line">.text:0804875C                 mov     [ebp+eax*4+ws], 0                 ;ws[strlen(ws)-1]=&#x27;\0&#x27;</span><br><span class="line"></span><br><span class="line">; 4.上述两个字符串比较</span><br><span class="line">.text:08048767                 mov     eax, [ebp+s2]                     ;decrypt返回值-&gt;s2-&gt;eax</span><br><span class="line">.text:0804876A                 mov     [esp+4], eax    ; s2              ;decrypt返回值压栈,作为第二个参数</span><br><span class="line">.text:0804876E                 lea     eax, [ebp+ws]                     ;&amp;ws-&gt;eax</span><br><span class="line">.text:08048774                 mov     [esp], eax      ; s1              ;&amp;ws-&gt;eax-&gt;[esp],作为第一个参数</span><br><span class="line">.text:08048777                 call    _wcscmp                           ;类似strcmp,输入字符串和解密后字符串比较</span><br><span class="line">.text:0804877C                 test    eax, eax                          ;判断strcmp是否返回0</span><br><span class="line">; 4.1如果不为0则两个字符串不相等</span><br><span class="line">.text:0804877E                 jnz     short loc_804878F                 ;如果不为0则跳转loc_804878F</span><br><span class="line">; 4.2否哦则即0表明两个字符串相等</span><br><span class="line">.text:08048780                 mov     eax, offset unk_8048B44           ;&amp;&quot;success welcome back&quot;-&gt;eax</span><br><span class="line">.text:08048785                 mov     [esp], eax                        ;&quot;success&quot;-&gt;[esp],作为参数</span><br><span class="line">.text:08048788                 call    _wprintf                          ;打印</span><br><span class="line">.text:0804878D                 jmp     short loc_804879C                 ;跳转尾声</span><br><span class="line">; 4.1续</span><br><span class="line">.text:0804878F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0804878F</span><br><span class="line">.text:0804878F loc_804878F:                            ; CODE XREF: authenticate+76↑j</span><br><span class="line">.text:0804878F                 mov     eax, offset unk_8048BA4           ;&amp;&quot;Access denied&quot;-&gt;eax</span><br><span class="line">.text:08048794                 mov     [esp], eax                        ;eax-&gt;[esp]作为参数</span><br><span class="line">.text:08048797                 call    _wprintf                          ;打印</span><br><span class="line">.text:0804879C</span><br><span class="line"></span><br><span class="line">;尾声</span><br><span class="line">.text:0804879C loc_804879C:                            ; CODE XREF: authenticate+41↑j</span><br><span class="line">.text:0804879C                                         ; authenticate+85↑j</span><br><span class="line">.text:0804879C                 mov     eax, [ebp+s2]</span><br><span class="line">.text:0804879F                 mov     [esp], eax      ; ptr</span><br><span class="line">.text:080487A2                 call    _free</span><br><span class="line">.text:080487A7                 leave</span><br><span class="line">.text:080487A8                 retn</span><br><span class="line">.text:080487A8 ; &#125; // starts at 8048708</span><br><span class="line">.text:080487A8 authenticate    endp</span><br></pre></td></tr></table></figure>
<p>分析到此算是了解了authenticate的逻辑,但是有几点是我想继续研究的</p>
<h4 id="offset指令">1.<code>offset</code>指令?</h4>
<p><code>.text:08048711                 mov     dword ptr [esp+4], offset another ;</code>这里offset的作用是什么?</p>
<p>能问出这种问题来属实是我计组学的太虚了</p>
<p>首先参考了博客<a
target="_blank" rel="noopener" href="https://www.cnblogs.com/x54256/p/8097963.html">汇编语言——转移指令（offset，jmp，jcxz）
- 想54256 - 博客园 (cnblogs.com)</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504204638327.png"
alt="image-20220504204638327" />
<figcaption aria-hidden="true">image-20220504204638327</figcaption>
</figure>
<p>又产生新问题,如果说<code>mov si,offset s</code>是将s的地址放到si寄存器中,那么为什么不用类似<code>lea si,[s]</code>的指令加载有效地址?</p>
<p>然后查阅了这篇博客<a
target="_blank" rel="noopener" href="https://blog.csdn.net/baoli1008/article/details/46691497">汇编语言LEA和OFFSET区别_Baoli1008的博客-CSDN博客_lea与offset的区别</a></p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504204837123.png"
alt="image-20220504204837123" />
<figcaption aria-hidden="true">image-20220504204837123</figcaption>
</figure>
<p>数据定义伪指令:</p>
<figure>
<img
src="https://img-blog.csdnimg.cn/20191220121930628.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly94aW9uZzUzNS5ibG9nLmNzZG4ubmV0,size_16,color_FFFFFF,t_70"
alt="数据定义伪指令" />
<figcaption aria-hidden="true">数据定义伪指令</figcaption>
</figure>
<h4
id="fgetwsfgets函数的区别">2.<code>fgetws,fgets</code>函数的区别?</h4>
<p>参考<a
target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-CN/cpp/c-runtime-library/reference/fgets-fgetws?view=msvc-170">fgets、fgetws
| Microsoft Docs</a></p>
<p>相同点:</p>
<p>两个函数都有三个参数,从左向右分别为:数据存储位置,要读取的最大字符数,FILE结构体指针.</p>
<p>返回值都是实际读取到的字符数</p>
<p>不同点:</p>
<p><strong><code>fgetws</code></strong> 是
<strong><code>fgets</code></strong> 的宽字符版本。</p>
<h4 id="宽字符">宽字符?</h4>
<p>啥是宽字符?用多个<a
target="_blank" rel="noopener" href="https://baike.baidu.com/item/字节/1096318">字节</a>来代表的字符称之为宽字符。</p>
<p>unicode是宽字符之一,但是已经实际上成为了宽字符的具体实现方法,windows上的c语言宽字符就是unicode,用两个字节表示一个字符</p>
<p>ASCII码表用一共字节表示一个字符,一个字节的值有<code>2^8=256</code>种即ASCII码最多有256个,对于键盘上出现的所有字符已经足够了</p>
<p>但是对于汉字,法语,日语等等各种语言,ASCII能表示的字符数真的太逊了,</p>
<p>而unicode码两个字节表示一个字符,两个字节的值有<code>2^16&gt;60000</code>,</p>
<p>而相对比较复杂的汉字,大约就3000常用汉字,因此unicode是有能力表示地球上的各种字符的</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504210716190.png"
alt="image-20220504210716190" />
<figcaption aria-hidden="true">image-20220504210716190</figcaption>
</figure>
<p>12345ABCDE一共10个字符,结尾还有一个'\0'字符,因此<code>char cstr</code>是11字节,<code>wchar_t wcstr</code>是22个字节</p>
<p>取<code>wchar_t</code>类型的数组长度的函数不是<code>strlen</code>,是<code>wcslen</code>,有多少个有意义的字符(不包括结尾'\0')wcslen函数就返回多少</p>
<p>宽字符类型的字符串字面量前需要有L修饰,不写会报错</p>
<p><code>[错误] cannot initialize array of 'wchar_t' 从 a string literal with type array of 'char'</code></p>
<p>unicode部分码表:</p>
<table>
<thead>
<tr>
<th>类型</th>
<th style="text-align: left;">编码(十进制)</th>
<th>编码(十六进制)</th>
</tr>
</thead>
<tbody>
<tr>
<td>小写字母(a~z)</td>
<td style="text-align: left;">97~122</td>
<td>61~7a</td>
</tr>
<tr>
<td>大写字母(A~Z)</td>
<td style="text-align: left;">65~90</td>
<td>41~5a</td>
</tr>
<tr>
<td>左右花括号{}</td>
<td style="text-align: left;">{123,125}</td>
<td>{7b,7d}</td>
</tr>
<tr>
<td>阿拉伯数字</td>
<td style="text-align: left;">48~57</td>
<td>30~39</td>
</tr>
</tbody>
</table>
<h4
id="事先存在的密文和密钥放在哪里access-denied等字样又放在那里">3.事先存在的密文和密钥放在哪里?<code>"Access denied"</code>等字样又放在那里?</h4>
<p>在authenticate函数里面双击s观察s的存储</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.rodata:08048AA8 ; const wchar_t s</span><br><span class="line">.rodata:08048AA8 s               db 3Ah                  ; DATA XREF: authenticate+11↑o</span><br><span class="line">.rodata:08048AA9                 db  14h</span><br><span class="line">.rodata:08048AAA                 db    0		;蜜汁0</span><br><span class="line">.rodata:08048AAB                 db    0		;蜜汁0</span><br><span class="line">.rodata:08048AAC                 dd 1436h</span><br><span class="line">.rodata:08048AB0                 db  37h ; 7</span><br><span class="line">.rodata:08048AB1                 db  14h</span><br><span class="line">.rodata:08048AB2                 db    0		;蜜汁0</span><br><span class="line">.rodata:08048AB3                 db    0</span><br><span class="line">.rodata:08048AB4                 db  3Bh ; ;</span><br><span class="line">.rodata:08048AB5                 db  14h</span><br><span class="line">.rodata:08048AB6                 db    0</span><br><span class="line">.rodata:08048AB7                 db    0</span><br><span class="line">.rodata:08048AB8                 db  80h</span><br><span class="line">.rodata:08048AB9                 db  14h</span><br><span class="line">.rodata:08048ABA                 db    0</span><br><span class="line">.rodata:08048ABB                 db    0</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>.rodata</code>是常量区,在程序运行之前,在编译时就能确定</p>
<p>s是宽字符数组,每个元素都是<code>wchar_t</code>类型,占两个字节,小端存储的话就可以写为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x1434 0000 0x1436 0000 0x1437....</span><br></pre></td></tr></table></figure>
<p>奇怪的是为什么其中会有很多0?为什么字符不能够紧凑存放?</p>
<p>能问出这种问题来属实是我c基础太差了</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504235300627.png"
alt="image-20220504235300627" />
<figcaption aria-hidden="true">image-20220504235300627</figcaption>
</figure>
<p><code>sizeof('a')</code>和<code>sizeof(char)</code>的结果竟然不一样</p>
<p>查阅资料,<code>a</code>是<strong>字符常量</strong>,却以int四字节存储</p>
<p>因此对rodata段的s应该这样断句:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">.rodata:08048AA8 s               db 3Ah                  ; DATA XREF: authenticate+11↑o</span><br><span class="line">.rodata:08048AA9                 db  14h</span><br><span class="line">.rodata:08048AAA                 db    0</span><br><span class="line">.rodata:08048AAB                 db    0</span><br><span class="line"></span><br><span class="line">.rodata:08048AAC                 db 36h</span><br><span class="line">.rodata:08048AAD                 db  14h</span><br><span class="line">.rodata:08048AAE                 db    0</span><br><span class="line">.rodata:08048AAF                 db    0</span><br><span class="line"></span><br><span class="line">.rodata:08048AB0                 db  37h ; 7</span><br><span class="line">.rodata:08048AB1                 db  14h</span><br><span class="line">.rodata:08048AB2                 db    0</span><br><span class="line">.rodata:08048AB3                 db    0</span><br><span class="line"></span><br><span class="line">.rodata:08048AB4                 db  3Bh ; ;</span><br><span class="line">.rodata:08048AB5                 db  14h</span><br><span class="line">.rodata:08048AB6                 db    0</span><br><span class="line">.rodata:08048AB7                 db    0</span><br><span class="line"></span><br><span class="line">.rodata:08048AB8                 db  80h</span><br><span class="line">.rodata:08048AB9                 db  14h</span><br><span class="line">.rodata:08048ABA                 db    0</span><br><span class="line">.rodata:08048ABB                 db    0</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>在IDA View视图上选中s的元素然后convert to array(DWORD)</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220504235955441.png"
alt="image-20220504235955441" />
<figcaption aria-hidden="true">image-20220504235955441</figcaption>
</figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[+] Dump <span class="number">0x8048AA8</span> - <span class="number">0x8048B43</span> (<span class="number">155</span> bytes) :</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> s[<span class="number">39</span>] = &#123;</span><br><span class="line">    <span class="number">0x0000143A</span>, <span class="number">0x00001436</span>, <span class="number">0x00001437</span>, <span class="number">0x0000143B</span>, <span class="number">0x00001480</span>, <span class="number">0x0000147A</span>, <span class="number">0x00001471</span>, <span class="number">0x00001478</span>, </span><br><span class="line">    <span class="number">0x00001463</span>, <span class="number">0x00001466</span>, <span class="number">0x00001473</span>, <span class="number">0x00001467</span>, <span class="number">0x00001462</span>, <span class="number">0x00001465</span>, <span class="number">0x00001473</span>, <span class="number">0x00001460</span>, </span><br><span class="line">    <span class="number">0x0000146B</span>, <span class="number">0x00001471</span>, <span class="number">0x00001478</span>, <span class="number">0x0000146A</span>, <span class="number">0x00001473</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x00001478</span>, </span><br><span class="line">    <span class="number">0x0000146E</span>, <span class="number">0x00001470</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x0000146E</span>, <span class="number">0x0000147B</span>, </span><br><span class="line">    <span class="number">0x00001476</span>, <span class="number">0x00001478</span>, <span class="number">0x0000146A</span>, <span class="number">0x00001473</span>, <span class="number">0x0000147B</span>, <span class="number">0x00001480</span>, <span class="number">0x00000000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>就得到了s数组</p>
<p>同样的道理another字符数组也位于.rodata区</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[+] Dump <span class="number">0x8048A90</span> - <span class="number">0x8048AA7</span> (<span class="number">23</span> bytes) :</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> another[<span class="number">6</span>] = &#123;</span><br><span class="line">    <span class="number">0x00001401</span>, <span class="number">0x00001402</span>, <span class="number">0x00001403</span>, <span class="number">0x00001404</span>, <span class="number">0x00001405</span>, <span class="number">0x00000000</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>同样的道理,"Success..."等字样也位于.rodata区</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220505000407437.png"
alt="image-20220505000407437" />
<figcaption aria-hidden="true">image-20220505000407437</figcaption>
</figure>
<h3 id="解密">解密</h3>
<p>用c程序解密</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> s[<span class="number">39</span>] = &#123;</span><br><span class="line">	<span class="number">0x0000143A</span>, <span class="number">0x00001436</span>, <span class="number">0x00001437</span>, <span class="number">0x0000143B</span>, <span class="number">0x00001480</span>, <span class="number">0x0000147A</span>, <span class="number">0x00001471</span>, <span class="number">0x00001478</span>,</span><br><span class="line">	<span class="number">0x00001463</span>, <span class="number">0x00001466</span>, <span class="number">0x00001473</span>, <span class="number">0x00001467</span>, <span class="number">0x00001462</span>, <span class="number">0x00001465</span>, <span class="number">0x00001473</span>, <span class="number">0x00001460</span>,</span><br><span class="line">	<span class="number">0x0000146B</span>, <span class="number">0x00001471</span>, <span class="number">0x00001478</span>, <span class="number">0x0000146A</span>, <span class="number">0x00001473</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x00001478</span>,</span><br><span class="line">	<span class="number">0x0000146E</span>, <span class="number">0x00001470</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x00001470</span>, <span class="number">0x00001464</span>, <span class="number">0x0000146E</span>, <span class="number">0x0000147B</span>,</span><br><span class="line">	<span class="number">0x00001476</span>, <span class="number">0x00001478</span>, <span class="number">0x0000146A</span>, <span class="number">0x00001473</span>, <span class="number">0x0000147B</span>, <span class="number">0x00001480</span>, <span class="number">0x00000000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> another[<span class="number">6</span>] = &#123;</span><br><span class="line">	<span class="number">0x00001401</span>, <span class="number">0x00001402</span>, <span class="number">0x00001403</span>, <span class="number">0x00001404</span>, <span class="number">0x00001405</span>, <span class="number">0x00000000</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">wchar_t</span> ans[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">38</span>; i++) &#123;</span><br><span class="line">		index = i % <span class="number">5</span>;</span><br><span class="line">		s[i] -= another[index];</span><br><span class="line">		swprintf(&amp;ans[i], <span class="string">L&quot;%s&quot;</span>, &amp;s[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%ls&quot;</span>, ans);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">9447&#123;you_are_an_international_mystery&#125;</span><br></pre></td></tr></table></figure>
<h2 id="csaw2013reversing2">011csaw2013reversing2</h2>
<h3 id="信息收集-3">信息收集</h3>
<p>运行程序之后直接弹窗,推测是一个win32API-messageBox</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506092936536.png"
alt="image-20220506092936536" />
<figcaption aria-hidden="true">image-20220506092936536</figcaption>
</figure>
<p>上面都是写的乱码,下面三个选择框都导致程序结束</p>
<h3 id="静态分析-2">静态分析</h3>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/critical.png"
alt="critical" />
<figcaption aria-hidden="true">critical</figcaption>
</figure>
<p>正常运行时执行左侧逻辑,但是左侧逻辑就是用win32API-messageBox显示了一些乱码,没有卵用</p>
<p>因此应该审查调试运行时的逻辑,应该只要是调试运行就可以执行<code>sub_4001000</code>但是没有打印输出,估计调试器可以观察出某些变量的值,</p>
<p>但是我目前只会用gdb调试器,但是这个题给出的文件明显编译时没有-g选项,没有调试信息</p>
<p>还是从静态分析入手,分析解密函数<code>sub_401000</code></p>
<h3 id="解密函数sub_401000">解密函数<code>sub_401000</code></h3>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506095147714.png"
alt="image-20220506095147714" />
<figcaption aria-hidden="true">image-20220506095147714</figcaption>
</figure>
<p>解密算法就是把s字符数组四个字符按照小端规则看成一个双字去和双字类型的<code>key=0xDDCCAABB</code>按位异或,然后再将双字拆成四个ascii字符即得到flag</p>
<p>堆上的缓冲区s拷贝的是<code>unk_409B10</code>,将其转化为c双字数组</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506095859599.png"
alt="image-20220506095859599" />
<figcaption aria-hidden="true">image-20220506095859599</figcaption>
</figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> unk_409B10[<span class="number">9</span>] = &#123;</span><br><span class="line">    <span class="number">0xBCA0CCBB</span>, <span class="number">0xB8BED1DC</span>, <span class="number">0xAEBECFCD</span>, <span class="number">0x82ABC4D2</span>, <span class="number">0xB393D9D2</span>, <span class="number">0xA993DED4</span>, <span class="number">0x82B8CBD3</span>, <span class="number">0xB9BECBD3</span>, </span><br><span class="line">    <span class="number">0x00CCD79A</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>解密程序:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">IntAndChar4</span> &#123;</span></span><br><span class="line">protected:</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> inInt;<span class="comment">//inInt和inChar[4]共用四个字节</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> inChar[<span class="number">4</span>];</span><br><span class="line">public:</span><br><span class="line">	<span class="type">void</span> <span class="title function_">setInt</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;i)</span> &#123;</span><br><span class="line">		inInt = i;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">int</span> <span class="title function_">getInt</span><span class="params">()</span><span class="type">const</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> inInt;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">string</span> <span class="title function_">getString</span><span class="params">()</span><span class="type">const</span> &#123;</span><br><span class="line">		<span class="built_in">string</span> s;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; ++i) &#123;</span><br><span class="line">			s += inChar[i];</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line">	&#125;</span><br><span class="line">	friend ostream &amp;operator&lt;&lt;(ostream &amp;os, <span class="type">const</span> IntAndChar4 &amp;iac4) &#123;</span><br><span class="line">		os &lt;&lt; iac4.getString();</span><br><span class="line">		<span class="keyword">return</span> os;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; iac4[<span class="number">9</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> key = <span class="number">0xDDCCAABB</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> encrypted[<span class="number">9</span>] = &#123;</span><br><span class="line">	<span class="number">0xBCA0CCBB</span>, <span class="number">0xB8BED1DC</span>, <span class="number">0xAEBECFCD</span>, <span class="number">0x82ABC4D2</span>, <span class="number">0xB393D9D2</span>, <span class="number">0xA993DED4</span>, <span class="number">0x82B8CBD3</span>, <span class="number">0xB9BECBD3</span>,</span><br><span class="line">	<span class="number">0x00CCD79A</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">decrypt</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">9</span>; ++i) &#123;</span><br><span class="line">		iac4[i].setInt(key ^ encrypted[i]);</span><br><span class="line">		<span class="built_in">cout</span> &lt;&lt; iac4[i];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">	decrypt();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;reversing_is_not_that_hard!&#125;</span><br></pre></td></tr></table></figure>
<h2 id="maze">012maze</h2>
<p>尽量不看源代码,用CSAPP第三章的方法,将汇编语言首先转化为带goto和label的伪代码,然后转为不带goto和label的伪代码</p>
<p>这个题的名字<code>maze</code>很有意思,迷宫,既体现在反汇编翻译成伪代码时分支众多,又体现在最后使用走迷宫的方法获得flag</p>
<h3 id="main">main</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004006B0 ; int __fastcall main(int, char **, char **)</span><br><span class="line">;注意调用方式,所有局部变量的地址都基于栈顶指针rsp计算,不基于帧指针计算</span><br><span class="line">.text:00000000004006B0 main            proc near               ; DATA XREF: start+1D↑o</span><br><span class="line">.text:00000000004006B0</span><br><span class="line">.text:00000000004006B0 var_28          = dword ptr -28h</span><br><span class="line">.text:00000000004006B0 var_24          = dword ptr -24h</span><br><span class="line">.text:00000000004006B0</span><br><span class="line">.text:00000000004006B0 ; __unwind &#123;</span><br><span class="line"></span><br><span class="line">;开端,参数压栈,保存寄存器</span><br><span class="line">.text:00000000004006B0                 push    rbp</span><br><span class="line">.text:00000000004006B1                 push    r15</span><br><span class="line">.text:00000000004006B3                 push    r14</span><br><span class="line">.text:00000000004006B5                 push    rbx</span><br><span class="line">.text:00000000004006B6                 push    rax</span><br><span class="line"></span><br><span class="line">;栈上开了两个局部变量,var_24和var_28</span><br><span class="line">.text:00000000004006B7                 mov     [rsp+28h+var_24], 0</span><br><span class="line">.text:00000000004006BF                 mov     [rsp+28h+var_28], 0</span><br><span class="line"></span><br><span class="line">;提醒用户输入</span><br><span class="line">.text:00000000004006C6                 mov     edi, offset s   ; &quot;Input flag:&quot;</span><br><span class="line">.text:00000000004006CB                 call    _puts</span><br><span class="line"></span><br><span class="line">;获取用户输入</span><br><span class="line">.text:00000000004006D0                 mov     edi, offset format ; &quot;%s&quot;</span><br><span class="line">.text:00000000004006D5                 mov     esi, offset s1;s1作为第一个参数传递给_scanf,作为缓冲区承载输入</span><br><span class="line">.text:00000000004006DA                 xor     eax, eax</span><br><span class="line">.text:00000000004006DC                 call    _scanf</span><br><span class="line"></span><br><span class="line">;获取输入字符串的长度并与18h=24字节进行比较</span><br><span class="line">.text:00000000004006E1                 mov     edi, offset s1  ; s</span><br><span class="line">.text:00000000004006E6                 call    _strlen</span><br><span class="line">.text:00000000004006EB                 mov     rbx, rax</span><br><span class="line">.text:00000000004006EE                 cmp     rbx, 18h</span><br><span class="line"></span><br><span class="line">;如果长度不够则跳转loc_400822报告失败</span><br><span class="line">.text:00000000004006F2                 jnz     loc_400822</span><br><span class="line"></span><br><span class="line">;否则即输入长度为18h=24字节,验证前五个字符和最后一个字符是否是nctf&#123;balabala&#125;这种结构</span><br><span class="line">.text:00000000004006F8                 mov     edi, offset s1  ; s1</span><br><span class="line">.text:00000000004006FD                 mov     esi, offset s2  ; &quot;nctf&#123;&quot;</span><br><span class="line">.text:0000000000400702                 mov     edx, 5          ; n</span><br><span class="line">.text:0000000000400707                 call    _strncmp</span><br><span class="line">.text:000000000040070C                 test    eax, eax</span><br><span class="line">.text:000000000040070E                 jnz     loc_400822</span><br><span class="line">.text:0000000000400714                 movzx   eax, ds:byte_6010BF[rbx]</span><br><span class="line">.text:000000000040071B                 cmp     eax, 7Dh ; &#x27;&#125;&#x27;</span><br><span class="line">.text:000000000040071E                 jnz     loc_400822</span><br><span class="line"></span><br><span class="line">;设定循环变量初始值</span><br><span class="line">.text:0000000000400724                 mov     edi, offset s1  ; s</span><br><span class="line">.text:0000000000400729                 call    _strlen</span><br><span class="line">.text:000000000040072E                 dec     rax			;strlen(s1)-1-&gt;rax指向s1的最后一个非0字符的下标</span><br><span class="line">.text:0000000000400731                 mov     ebx, 5		;从5开始是由于0到4这前五个字符已经判断过是nctf&#123;了,ebx将会作为循环变量i</span><br><span class="line">.text:0000000000400736                 cmp     rax, 5		;判断strlen(s1)-1和5的大小,即判断s1串除了nctf&#123;&#125;之外有无其他字符</span><br><span class="line">.text:000000000040073A                 jbe     loc_4007EE</span><br><span class="line"></span><br><span class="line">;其他循环体变量初始化</span><br><span class="line">.text:0000000000400740                 lea     r14, [rsp+28h+var_28];r14=&amp;var_28,一定要分清r14里面放的是var_28的地址</span><br><span class="line">.text:0000000000400744                 lea     r15, [rsp+28h+var_24];r25=&amp;var_24</span><br><span class="line">.text:0000000000400749                 nop     dword ptr [rax+00000000h];nop指令什么也不干</span><br><span class="line">.text:0000000000400750</span><br><span class="line"></span><br><span class="line">;下面进入循环体</span><br><span class="line">;始终注意:</span><br><span class="line">;r14=&amp;var_28</span><br><span class="line">;r15=&amp;var_24</span><br><span class="line">;rbx中放的是循环变量i</span><br><span class="line">;s1是输入的字符串</span><br><span class="line">;后来会用到的asc_601060是data区的一个全局字符数组,&#x27;  *******   *  **** * ****  * ***  *#  *** *** ***     *********&#x27;</span><br><span class="line">;rbx作为循环变量,用来遍历s1字符数组,s1[rbx]相当于s1[i]</span><br><span class="line">;后面专门摘出循环体进行分析</span><br><span class="line">.text:0000000000400750 loc_400750:                             ; CODE XREF: main+133↓j</span><br><span class="line">.text:0000000000400750                 movsx   eax, ds:s1[rbx]</span><br><span class="line">.text:0000000000400757                 xor     ebp, ebp</span><br><span class="line">.text:0000000000400759                 cmp     eax, 4Eh ; &#x27;N&#x27;</span><br><span class="line">.text:000000000040075C                 jg      short loc_400780</span><br><span class="line">.text:000000000040075E                 movzx   eax, al</span><br><span class="line">.text:0000000000400761                 cmp     eax, 2Eh ; &#x27;.&#x27;</span><br><span class="line">.text:0000000000400764                 jz      short loc_4007A0</span><br><span class="line">.text:0000000000400766                 cmp     eax, 30h ; &#x27;0&#x27;</span><br><span class="line">.text:0000000000400769                 jnz     short loc_4007BB</span><br><span class="line">.text:000000000040076B                 mov     rdi, r14</span><br><span class="line">.text:000000000040076E                 call    sub_400680;小函数,作用是修改</span><br><span class="line">.text:0000000000400773                 jmp     short loc_4007B8</span><br><span class="line">.text:0000000000400773 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400775                 align 20h</span><br><span class="line">.text:0000000000400780</span><br><span class="line">.text:0000000000400780 loc_400780:                             ; CODE XREF: main+AC↑j</span><br><span class="line">.text:0000000000400780                 movzx   eax, al</span><br><span class="line">.text:0000000000400783                 cmp     eax, 4Fh ; &#x27;O&#x27;</span><br><span class="line">.text:0000000000400786                 jz      short loc_4007B0</span><br><span class="line">.text:0000000000400788                 cmp     eax, 6Fh ; &#x27;o&#x27;</span><br><span class="line">.text:000000000040078B                 jnz     short loc_4007BB</span><br><span class="line">.text:000000000040078D                 mov     rdi, r15</span><br><span class="line">.text:0000000000400790                 call    sub_400660</span><br><span class="line">.text:0000000000400795                 jmp     short loc_4007B8</span><br><span class="line">.text:0000000000400795 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400797                 align 20h</span><br><span class="line">.text:00000000004007A0</span><br><span class="line">.text:00000000004007A0 loc_4007A0:                             ; CODE XREF: main+B4↑j</span><br><span class="line">.text:00000000004007A0                 mov     rdi, r14</span><br><span class="line">.text:00000000004007A3                 call    sub_400670</span><br><span class="line">.text:00000000004007A8                 jmp     short loc_4007B8</span><br><span class="line">.text:00000000004007A8 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004007AA                 align 10h</span><br><span class="line">.text:00000000004007B0</span><br><span class="line">.text:00000000004007B0 loc_4007B0:                             ; CODE XREF: main+D6↑j</span><br><span class="line">.text:00000000004007B0                 mov     rdi, r15</span><br><span class="line">.text:00000000004007B3                 call    sub_400650</span><br><span class="line">.text:00000000004007B8</span><br><span class="line">.text:00000000004007B8 loc_4007B8:                             ; CODE XREF: main+C3↑j</span><br><span class="line">.text:00000000004007B8                                         ; main+E5↑j ...</span><br><span class="line">.text:00000000004007B8                 mov     bpl, al</span><br><span class="line">.text:00000000004007BB</span><br><span class="line">.text:00000000004007BB loc_4007BB:                             ; CODE XREF: main+B9↑j</span><br><span class="line">.text:00000000004007BB                                         ; main+DB↑j</span><br><span class="line">.text:00000000004007BB                 mov     esi, [rsp+28h+var_24]</span><br><span class="line">.text:00000000004007BF                 mov     edx, [rsp+28h+var_28]</span><br><span class="line">.text:00000000004007C2                 mov     edi, offset asc_601060 ; &quot;  *******   *  **** * ****  * ***  *#  &quot;...</span><br><span class="line">.text:00000000004007C7                 call    sub_400690</span><br><span class="line">.text:00000000004007CC                 test    al, al</span><br><span class="line">.text:00000000004007CE                 jz      short loc_400822;此处也可能出循环,当al即sub_400690返回值为0则跳出循环</span><br><span class="line">.text:00000000004007D0                 inc     rbx</span><br><span class="line">.text:00000000004007D3                 mov     edi, offset s1  ; s</span><br><span class="line">.text:00000000004007D8                 call    _strlen</span><br><span class="line">.text:00000000004007DD                 dec     rax</span><br><span class="line">.text:00000000004007E0                 cmp     rbx, rax;判断rbx是否遍历完了s1字符串</span><br><span class="line">.text:00000000004007E3                 jb      loc_400750</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;出了循环体,下面判断bpl是否为0</span><br><span class="line">.text:00000000004007E9                 test    bpl, bpl</span><br><span class="line">.text:00000000004007EC                 jz      short loc_40080B</span><br><span class="line"></span><br><span class="line">;检查出循环时,var_24+8*var_28是否等于23h=35字节,如果是则报告成功</span><br><span class="line">.text:00000000004007EE</span><br><span class="line">.text:00000000004007EE loc_4007EE:                             ; CODE XREF: main+8A↑j</span><br><span class="line">.text:00000000004007EE                 movsxd  rax, [rsp+28h+var_24]</span><br><span class="line">.text:00000000004007F3                 movsxd  rcx, [rsp+28h+var_28]</span><br><span class="line">.text:00000000004007F7                 movzx   eax, byte ptr asc_601060[rax+rcx*8] ; &quot;  *******   *  **** * ****  * ***  *#  &quot;...</span><br><span class="line">.text:00000000004007FF                 cmp     eax, 23h ; &#x27;#&#x27;</span><br><span class="line">.text:0000000000400802                 jnz     short loc_40080B</span><br><span class="line"></span><br><span class="line">;置成功</span><br><span class="line">.text:0000000000400804                 mov     edi, offset aCongratulation ; &quot;Congratulations!&quot;</span><br><span class="line">.text:0000000000400809                 jmp     short loc_400810</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">;置失败</span><br><span class="line">.text:000000000040080B ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040080B</span><br><span class="line">.text:000000000040080B loc_40080B:                             ; CODE XREF: main+13C↑j</span><br><span class="line">.text:000000000040080B                                         ; main+152↑j</span><br><span class="line">.text:000000000040080B                 mov     edi, offset aWrongFlag ; &quot;Wrong flag!&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">.text:0000000000400810</span><br><span class="line">.text:0000000000400810 loc_400810:                             ; CODE XREF: main+159↑j</span><br><span class="line">.text:0000000000400810                 call    _puts;打印刚才存放在edi中的字符串地址指向的字符串,可能是失败或成功</span><br><span class="line"></span><br><span class="line">;函数尾声</span><br><span class="line">.text:0000000000400815                 xor     eax, eax</span><br><span class="line">.text:0000000000400817                 add     rsp, 8</span><br><span class="line">.text:000000000040081B                 pop     rbx</span><br><span class="line">.text:000000000040081C                 pop     r14</span><br><span class="line">.text:000000000040081E                 pop     r15</span><br><span class="line">.text:0000000000400820                 pop     rbp</span><br><span class="line">.text:0000000000400821                 retn</span><br><span class="line"></span><br><span class="line">;置失败</span><br><span class="line">.text:0000000000400822 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400822</span><br><span class="line">.text:0000000000400822 loc_400822:                             ; CODE XREF: main+42↑j</span><br><span class="line">.text:0000000000400822                                         ; main+5E↑j ...</span><br><span class="line">.text:0000000000400822                 mov     edi, offset aWrongFlag ; &quot;Wrong flag!&quot;</span><br><span class="line">.text:0000000000400827                 call    _puts</span><br><span class="line">.text:000000000040082C                 mov     edi, 0FFFFFFFFh ; status</span><br><span class="line">.text:0000000000400831                 call    _exit</span><br><span class="line">.text:0000000000400831 ; &#125; // starts at 4006B0</span><br><span class="line">.text:0000000000400831 main            endp</span><br><span class="line">.text:0000000000400831</span><br><span class="line">.text:0000000000400831 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400836                 align 20h</span><br></pre></td></tr></table></figure>
<h3 id="循环体分析-1">循环体分析</h3>
<p>循环体是本题关键</p>
<p>对于循环体,摘出来翻译成伪代码</p>
<p>其中一些sub_400680,sub_400670,sub_400660,sub_400650都是小函数,其作用是对var_24或var_28进行加一或者减一操作,然后根据他俩的值置bpl的值是否为0</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506084842338.png"
alt="image-20220506084842338" />
<figcaption aria-hidden="true">image-20220506084842338</figcaption>
</figure>
<p>如果想要得到congratulations的结果,必须满足:</p>
<p>1.循环体每执行一遍,最后的时候都要满足<code>asc_601060[var_24+var_28*8]==' '||asc_601060[var_24+var_28*8]=='#'</code></p>
<p>2.出循环的时候<code>asc_601060[var_24+8*var_28]='#'</code>即<code>var_24+8*var_28=36</code>,并且bpl不能为0</p>
<h3 id="问题转化">问题转化</h3>
<p>而<code>asc_601060="  *******   *  **** * ****  * ***  *#  *** *** ***     *********"</code></p>
<p>其中空格字符的下标为<code>0, 1, 9, 10, 11, 13, 14, 19, 21, 26, 27, 29, 33, 34, 36, 37, 38, 42, 46, 50, 51, 52, 53, 54</code></p>
<p>如果要满足1的话,<code>var_24+var_28*8=0, 1, 9, 10, 11, 13, 14, 19, 21, 26, 27, 29, 33, 34, 36, 37, 38, 42, 46, 50, 51, 52, 53, 54</code></p>
<p>要满足2的话,最终结果<code>var_24+var_28*8=36</code>,bpl是一个循环中附带计算的值,现在不方便讨论其取值,</p>
<p>但是可以确定的是,如果出循环的时候<code>var_24或者var_28</code>有小于0或者大于8,则bpl一定为0,</p>
<p>那么可以<strong>粗略</strong>的认为<code>var_24,var_28</code>取值都在<code>[0,8]</code>之间(说粗略是因为有可能var_24,var_28在循环中可以越界但是后来又退进了[0,8])</p>
<h3 id="转化成一维状态转移">转化成一维状态转移</h3>
<p>将上述两点分析转化成一个深度优先搜索或者说动态规划的问题</p>
<p>把<code>var_24,var_28</code>的值表示为<code>(var_24,var_28)</code>的数对<code>(x,y)</code>,比如<code>(1,2)</code>就表示<code>var_24=1,var_28=2</code>,</p>
<p>一个数对与一个整数
建立映射关系<code>(var_24,var_28)-&gt;var_24+8*var_28</code></p>
<p>初始时状态为<code>(0,0)-&gt;0</code></p>
<p>结束时状态为<code>(x,y)-&gt;36</code></p>
<p>中间的合法状态映射成的整数值有<code>0, 1, 9, 10, 11, 13, 14, 19, 21, 26, 27, 29, 33, 34, 36, 37, 38, 42, 46, 50, 51, 52, 53, 54</code></p>
<p>状态转移有四种情况: <span class="math display">\[
(x,y)\rightarrow\begin{cases}
(x-1,y)\\
(x+1,y)\\
(x,y-1)\\
(x,y+1)\\
\end{cases}
\]</span></p>
<p>下面就找一条路径,使得这个映射值从0转移到36,中途的任何数对的映射值都应当落在合法值域中</p>
<p>可以写一深度优先搜索实现该问题</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line">vector&lt;<span class="type">int</span>&gt; legal = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">19</span>, <span class="number">21</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">29</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">42</span>, <span class="number">46</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">isLegal</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;n)</span> </span>&#123;<span class="comment">//判断一个映射值是否输入legal合法映射值</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> i : legal) &#123;</span><br><span class="line">		<span class="keyword">if</span> (i == n)</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> visited[<span class="number">10</span>][<span class="number">10</span>];<span class="comment">//记忆化搜索</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Path</span> &#123;<span class="comment">//记录中途经过状态的结构体</span></span><br><span class="line">	<span class="type">int</span> x;</span><br><span class="line">	<span class="type">int</span> y;</span><br><span class="line">	<span class="keyword">friend</span> ostream &amp;<span class="keyword">operator</span>&lt;&lt;(ostream &amp;os, <span class="type">const</span> Path &amp;p) &#123;</span><br><span class="line">		os &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; p.x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; p.y &lt;&lt; <span class="string">&quot;)=&quot;</span> &lt;&lt; p.x + p.y * <span class="number">8</span>;</span><br><span class="line">		<span class="keyword">return</span> os;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setCoordinate</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;x, <span class="type">const</span> <span class="type">int</span> &amp;y)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">		<span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; path[<span class="number">20</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> directors[<span class="number">20</span>];<span class="comment">//移动方向</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">DFS</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;x, <span class="type">const</span> <span class="type">int</span> &amp;y, <span class="type">int</span> depth)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (x &lt; <span class="number">0</span> || x &gt; <span class="number">8</span> || y &lt; <span class="number">0</span> || y &gt; <span class="number">8</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//粗略条件剪枝</span></span><br><span class="line">	<span class="keyword">if</span> (visited[x][y])</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//记忆化搜索剪枝</span></span><br><span class="line">	visited[x][y] = <span class="literal">true</span>;<span class="comment">//设置访问过</span></span><br><span class="line">	<span class="type">int</span> sum = x + <span class="number">8</span> * y;<span class="comment">//计算映射值</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">isLegal</span>(sum) == <span class="literal">false</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;<span class="comment">//不合法,剪枝</span></span><br><span class="line">	path[depth].<span class="built_in">setCoordinate</span>(x, y);<span class="comment">//合法,记录路径</span></span><br><span class="line">	<span class="keyword">if</span> (sum == <span class="number">36</span>) &#123;<span class="comment">//判断映射值是否已经为终点值36</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//向其他状态转移</span></span><br><span class="line">	directors[depth + <span class="number">1</span>] = <span class="string">&#x27;o&#x27;</span>;<span class="comment">//方向数组,记录转义方向</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">DFS</span>(x + <span class="number">1</span>, y, depth + <span class="number">1</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	directors[depth + <span class="number">1</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">DFS</span>(x, y + <span class="number">1</span>, depth + <span class="number">1</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	directors[depth + <span class="number">1</span>] = <span class="string">&#x27;O&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">DFS</span>(x - <span class="number">1</span>, y, depth + <span class="number">1</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">	directors[depth + <span class="number">1</span>] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">DFS</span>(x, y - <span class="number">1</span>, depth + <span class="number">1</span>))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">DFS</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;<span class="comment">//从x=0,y=0,深度depth=0开始</span></span><br><span class="line">	<span class="comment">//如果成功da则打印方向数组</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; <span class="number">20</span>; ++i) &#123;</span><br><span class="line">			cout &lt;&lt; directors[i];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行结果:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">o0oo00O000oooo..OO</span><br></pre></td></tr></table></figure>
<p>刚好18个字符,加上头尾的nctf{}之后</p>
<p><code>nctf&#123;o0oo00O000oooo..OO&#125;</code>刚好24个字符,满足所有限制条件,因此得到了flag</p>
<h3 id="转化为二维迷宫">转化为二维迷宫</h3>
<p>做完了看了别人的writeup才恍然大悟</p>
<p>考虑为什么<code>var_24+var_28*8</code>这里有一个*8?</p>
<p>如果将<code>asc_601060="  *******   *  **** * ****  * ***  *#  *** *** ***     *********"</code>以8字节为单位换行则得到:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  ******</span><br><span class="line">*   *  *</span><br><span class="line">*** * **</span><br><span class="line">**  * **</span><br><span class="line">*  *#  *</span><br><span class="line">** *** *</span><br><span class="line">**     *</span><br><span class="line">********</span><br></pre></td></tr></table></figure>
<p>星号,空格,井号的宽度不一样因此这里看上去对不齐</p>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506091352319.png"
alt="image-20220506091352319" />
<figcaption aria-hidden="true">image-20220506091352319</figcaption>
</figure>
<figure>
<img
src="https://raw.githubusercontent.com/DeutschBall/test/master/image-20220506091523194.png"
alt="image-20220506091523194" />
<figcaption aria-hidden="true">image-20220506091523194</figcaption>
</figure>
<p>右下右右下下左下下下右右右右上上左左</p>
<p>翻译成oO0.四个字符就是<code>o0oo00O000oooo..OO</code></p>
<p>同样可以得到flag</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/xctf%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C/" rel="tag"># xctf攻防世界</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/28/%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A/" rel="prev" title="调用约定">
      <i class="fa fa-chevron-left"></i> 调用约定
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/05/07/datastruct/" rel="next" title="数据结构在汇编语言下的表现">
      数据结构在汇编语言下的表现 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#xctf%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-reverse-%E6%96%B0%E6%89%8B%E6%9D%91"><span class="nav-number">1.</span> <span class="nav-text">xctf攻防世界-reverse-新手村</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#logmein"><span class="nav-number">1.1.</span> <span class="nav-text">002logmein</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main%E5%87%BD%E6%95%B0"><span class="nav-number">1.1.1.</span> <span class="nav-text">main函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BD%93%E5%88%86%E6%9E%90"><span class="nav-number">1.1.1.1.</span> <span class="nav-text">循环体分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E7%AE%97%E6%B3%95"><span class="nav-number">1.1.2.</span> <span class="nav-text">解密算法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#insanity"><span class="nav-number">1.2.</span> <span class="nav-text">003insanity</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="nav-number">1.2.1.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90"><span class="nav-number">1.2.2.</span> <span class="nav-text">静态分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E6%A8%A1%E6%97%B6%E7%9A%84%E7%BC%96%E8%AF%91%E4%BC%98%E5%8C%96"><span class="nav-number">1.2.3.</span> <span class="nav-text">取模时的编译优化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#re1"><span class="nav-number">1.3.</span> <span class="nav-text">006re1</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="nav-number">1.3.1.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%86%E5%90%91%E5%88%86%E6%9E%90"><span class="nav-number">1.3.2.</span> <span class="nav-text">逆向分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E7%AB%AF"><span class="nav-number">1.3.2.1.</span> <span class="nav-text">开端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%98%B2%E6%AD%A2%E6%A0%88%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="nav-number">1.3.2.2.</span> <span class="nav-text">防止栈缓冲区溢出</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A3%85%E5%A1%ABflag%E6%8C%87%E4%BB%A4%E9%A1%BA%E5%BA%8F%E6%9C%89%E6%94%B9%E5%8A%A8%E4%BD%86%E6%98%AF%E4%B8%8D%E5%BD%B1%E5%93%8D%E9%80%BB%E8%BE%91"><span class="nav-number">1.3.2.3.</span> <span class="nav-text">装填flag,指令顺序有改动但是不影响逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%93%E5%8D%B0%E5%BA%9F%E8%AF%9D"><span class="nav-number">1.3.2.4.</span> <span class="nav-text">打印废话</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BE%93%E5%85%A5%E8%BE%93%E5%85%A5%E5%AD%98%E5%82%A8%E5%88%B0var_24"><span class="nav-number">1.3.2.5.</span> <span class="nav-text">获取输入,输入存储到var_24</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E8%BE%93%E5%85%A5%E5%92%8Cflag"><span class="nav-number">1.3.2.6.</span> <span class="nav-text">加载输入和flag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E6%AF%94%E8%BE%83%E8%BE%93%E5%85%A5%E5%92%8Cflag%E6%AF%8F%E6%AC%A1%E6%AF%94%E8%BE%83%E4%B8%A4%E4%B8%AA%E5%AD%97%E8%8A%82"><span class="nav-number">1.3.2.7.</span> <span class="nav-text">循环比较输入和flag,每次比较两个字节</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%A4%E7%A7%8D%E6%83%85%E5%86%B5%E7%BD%AEeax%E4%B8%BA0%E6%88%961%E7%84%B6%E5%90%8E%E5%90%88%E5%B9%B6%E5%88%A4%E6%96%AD"><span class="nav-number">1.3.2.8.</span> <span class="nav-text">两种情况,置eax为0或1然后合并判断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%88%E5%B9%B6.%E6%A0%B9%E6%8D%AE%E5%88%9A%E6%89%8D%E7%9A%84eax%E5%88%A4%E6%96%AD"><span class="nav-number">1.3.2.9.</span> <span class="nav-text">合并.根据刚才的eax判断</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%BE%E5%A3%B0"><span class="nav-number">1.3.2.10.</span> <span class="nav-text">尾声</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#security_cookie"><span class="nav-number">1.3.3.</span> <span class="nav-text">___security_cookie</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#game"><span class="nav-number">1.4.</span> <span class="nav-text">007game</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="nav-number">1.4.1.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%97%E6%B3%95%E8%A7%A3%E5%86%B3"><span class="nav-number">1.4.2.</span> <span class="nav-text">算法解决</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-1"><span class="nav-number">1.4.3.</span> <span class="nav-text">静态分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%9D%E8%AF%951"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">尝试1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%9D%E8%AF%952"><span class="nav-number">1.4.3.2.</span> <span class="nav-text">尝试2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E8%84%9A%E6%9C%AC"><span class="nav-number">1.4.4.</span> <span class="nav-text">解密脚本</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hellocctf"><span class="nav-number">1.5.</span> <span class="nav-text">008Helloc,CTF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B2%A1%E8%A7%81%E8%BF%87%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="nav-number">1.5.1.</span> <span class="nav-text">没见过的指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B6%E9%9B%86%E4%BF%A1%E6%81%AF"><span class="nav-number">1.5.2.</span> <span class="nav-text">收集信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E6%B1%87%E7%BC%96%E5%88%86%E6%9E%90"><span class="nav-number">1.5.3.</span> <span class="nav-text">反汇编分析</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%80%E7%AB%AF-1"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">开端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%A4%96%E5%BE%AA%E7%8E%AF%E5%A4%96%E4%BE%A7%E8%93%9D%E7%BA%BF"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">外循环(外侧蓝线)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#loc_40101a"><span class="nav-number">1.5.3.2.1.</span> <span class="nav-text">loc_40101A</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#loc_40105f%E5%86%85%E4%BE%A7%E7%BB%BF%E7%BA%BF"><span class="nav-number">1.5.3.2.2.</span> <span class="nav-text">loc_40105F(内侧绿线)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#loc_4040b0"><span class="nav-number">1.5.3.2.3.</span> <span class="nav-text">loc_4040B0</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#loc_4010b8"><span class="nav-number">1.5.3.2.4.</span> <span class="nav-text">loc_4010B8</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%B0%BE%E5%A3%B0-1"><span class="nav-number">1.5.3.2.5.</span> <span class="nav-text">尾声</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#opensource"><span class="nav-number">1.6.</span> <span class="nav-text">009opensource</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#no-strings-attached"><span class="nav-number">1.7.</span> <span class="nav-text">010no-strings-attached</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main%E5%87%BD%E6%95%B0-1"><span class="nav-number">1.7.1.</span> <span class="nav-text">main函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#authenticate%E5%87%BD%E6%95%B0"><span class="nav-number">1.7.2.</span> <span class="nav-text">authenticate函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#decrypt%E5%87%BD%E6%95%B0"><span class="nav-number">1.7.3.</span> <span class="nav-text">decrypt函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9B%9E%E5%88%B0authenticate%E5%87%BD%E6%95%B0"><span class="nav-number">1.7.4.</span> <span class="nav-text">回到authenticate函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#offset%E6%8C%87%E4%BB%A4"><span class="nav-number">1.7.4.1.</span> <span class="nav-text">1.offset指令?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fgetwsfgets%E5%87%BD%E6%95%B0%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="nav-number">1.7.4.2.</span> <span class="nav-text">2.fgetws,fgets函数的区别?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%BD%E5%AD%97%E7%AC%A6"><span class="nav-number">1.7.4.3.</span> <span class="nav-text">宽字符?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8B%E5%85%88%E5%AD%98%E5%9C%A8%E7%9A%84%E5%AF%86%E6%96%87%E5%92%8C%E5%AF%86%E9%92%A5%E6%94%BE%E5%9C%A8%E5%93%AA%E9%87%8Caccess-denied%E7%AD%89%E5%AD%97%E6%A0%B7%E5%8F%88%E6%94%BE%E5%9C%A8%E9%82%A3%E9%87%8C"><span class="nav-number">1.7.4.4.</span> <span class="nav-text">3.事先存在的密文和密钥放在哪里?&quot;Access denied&quot;等字样又放在那里?</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86"><span class="nav-number">1.7.5.</span> <span class="nav-text">解密</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#csaw2013reversing2"><span class="nav-number">1.8.</span> <span class="nav-text">011csaw2013reversing2</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-3"><span class="nav-number">1.8.1.</span> <span class="nav-text">信息收集</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90-2"><span class="nav-number">1.8.2.</span> <span class="nav-text">静态分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0sub_401000"><span class="nav-number">1.8.3.</span> <span class="nav-text">解密函数sub_401000</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#maze"><span class="nav-number">1.9.</span> <span class="nav-text">012maze</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main"><span class="nav-number">1.9.1.</span> <span class="nav-text">main</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BD%93%E5%88%86%E6%9E%90-1"><span class="nav-number">1.9.2.</span> <span class="nav-text">循环体分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%BD%AC%E5%8C%96"><span class="nav-number">1.9.3.</span> <span class="nav-text">问题转化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E5%8C%96%E6%88%90%E4%B8%80%E7%BB%B4%E7%8A%B6%E6%80%81%E8%BD%AC%E7%A7%BB"><span class="nav-number">1.9.4.</span> <span class="nav-text">转化成一维状态转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BD%AC%E5%8C%96%E4%B8%BA%E4%BA%8C%E7%BB%B4%E8%BF%B7%E5%AE%AB"><span class="nav-number">1.9.5.</span> <span class="nav-text">转化为二维迷宫</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="dustball"
      src="https://raw.githubusercontent.com/DeutschBall/picbed/main/dustball.png">
  <p class="site-author-name" itemprop="name">dustball</p>
  <div class="site-description" itemprop="description">dustland</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dustball</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="//cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@4/dist/instantsearch.production.min.js"></script>
<script src="/js/algolia-search.js"></script>












<script data-pjax>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'dark',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


    <div id="pjax">
  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

    </div>
</body>
</html>
